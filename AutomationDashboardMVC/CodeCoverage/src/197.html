<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Pre-Payment\ConcreateModels\MOHListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Web;
using System.Globalization;
using System.Text;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.CONTMOHBL;
using Aurigo.AMP3.CONTMOHDTO;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.AMP3.WORKORDBL;
using Aurigo.AMP3.WORKORDDTO;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.WebUI.UltraWebGrid;
using Aurigo.AMP3.CONTMOHDAC;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.AMP3.ContractManagementMOHUI
{
    [ListModelContext(Name = &quot;CONTMOH&quot;, Table = &quot;CONTMOHList&quot;)]
    public class MOHListModel : ListModel, IWorkflowEnabledList
    {
        public override int GetProjectIdFromInstanceId()
        {
            return Aurigo.AMP3.ContractManager.BusinessLayer.BL.Instance.GetProjectIdOfContract(ContractID);
        }

        public override string QueryStringName
        {
            get { return &quot;MOHID&quot;; }
        }

        public override string ModuleId
        {
            get { return &quot;CONTMOH&quot;; }
        }

        public override string[] DataSourceFilters
        {
            get { return new[] { &quot;ContractID&quot;, &quot;WOID&quot; }; }
        }

        public int ContractID
        {
            get { return Request[MOHConstants.QRY_CONTRACTID].ToInt32_2(); }
        }

        public override bool HasMultiApprove
        {
            get { return false; }
        }

        public override string ParentIDKey
        {
            get { return &quot;ContractID&quot;; }
        }

        #region IWorkflowEnabledList Members

        public string FormName
        {
            get { return &quot;XMOHFRM&quot;; }
        }

        public int ParentModuleId
        {
            get { return 0; }
        }

        public string ListPrimaryKey
        {
            get { return &quot;MOHID&quot;; }
        }

        public int PID
        {
            get { return 0; }
        }

        #endregion

        public override void SetUIDetails()
        {
            //Status Image Column
            //SetImageForRowValue(&quot;Status&quot;, &quot;Draft&quot;, &quot;0&quot;, &quot;IcnDraft.gif&quot;);
            //SetImageForRowValue(&quot;Status&quot;, &quot;Approve&quot;, &quot;1&quot;, &quot;IcnApprove.gif&quot;);
            //SetImageForRowValue(&quot;Status&quot;, &quot;CloseOut&quot;, &quot;2&quot;, &quot;IcnCloseOut.gif&quot;);

            //Column Properties
            ModifyColumnProperties(&quot;Pre-PaymentID&quot;, false, 3, null, &quot;100&quot;, false, &quot;Pre-Payment ID&quot;);
            ModifyColumnProperties(&quot;Contractor&quot;, false, 1, null, &quot;100&quot;, false);
            ModifyColumnProperties(&quot;MOHType&quot;, false, 4, null, &quot;100&quot;, false, &quot;Pre-Payment Type&quot;);
            ModifyColumnProperties(&quot;MOHDate&quot;, false, 5, AMP3ApplicationSettings.Instance.FORMAT_DATE, &quot;80&quot;, false, &quot;Pre-Payment Date&quot;);
            //ModifyColumnProperties(&quot;Remaining Amount&quot;, false, 9, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, &quot;100&quot;, false);
            ModifyColumnProperties(&quot;Approved On&quot;, false, 6, AMP3ApplicationSettings.Instance.FORMAT_DATE, &quot;100&quot;, false);
            ModifyColumnProperties(&quot;Status&quot;, false, 7, null, &quot;75&quot;, false);
            ModifyColumnProperties(&quot;Mode&quot;, false, 10, null, &quot;75&quot;, false);
            ModifyColumnProperties(&quot;WF_Status&quot;, false, null, null, &quot;75&quot;, false);


            //Hidden Columns
            //ModifyColumnProperties(&quot;Status&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;MOHID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ContractID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Comments&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Multi&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;WOID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;PrePaymentType&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;CreatedDate&quot;, true, null, null, null, false);

            //Buttons displayed
            //displayCloseOut = true;
            EnableGridDblClick = true;

            //Check for the ProjectID
            if (Request != null &amp;&amp; Request.QueryString[&quot;Context&quot;].Equals(this.ModuleId, StringComparison.CurrentCultureIgnoreCase))
            {
                ModifyColumnProperties(&quot;Pre-Payment Amount&quot;, false, 8, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, &quot;100&quot;, false,
                                       &quot;Pre-Payment Amount in &quot; +
                                       LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT,
                                                                             Request[&quot;ContractID&quot;]));
                ModifyColumnProperties(&quot;RemainingAmount&quot;, false, 9, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, &quot;100&quot;, false,
                                       &quot;Remaining Amount in &quot; +
                                       LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT,
                                                                             Request[&quot;ContractID&quot;]));
                ModifyColumnProperties(&quot;WorkOrderNo&quot;, string.IsNullOrEmpty(Request[&quot;WOID&quot;]), 2, null, &quot;100&quot;, false,
                                       &quot;Work Order No&quot;);
                if (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]))
                    header = GlobalizationUtility.SetResource(&quot;Work Order Pre-Payment List&quot;, false);
                else
                    header = GlobalizationUtility.SetResource(&quot;Pre-Payment List&quot;, false);
                if (String.IsNullOrEmpty(Request.QueryString[Constants.QRY_PROJECTID]))
                {
                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;, true);
                }
                if (String.IsNullOrEmpty(Request.QueryString[MOHConstants.QRY_CONTRACTID]))
                {
                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?Context=CONTMGT&amp;&quot; + Constants.QRY_PROJECTID + &quot;=&quot; +
                                     Request.QueryString[Constants.QRY_PROJECTID], true);
                }

                //Check for Locked Status of Contract
                try
                {
                    bool IsLocked = (BL.Instance.GetLockStatus(Request[&quot;ContractID&quot;].ToInt32_2()));
                    EnableNew =
                        EnableEdit =
                        displayView =
                        EnableDelete =
                        //displayApprove =
                        displayApplyFilter =
                        //displayUnApprove = 
                        IsLocked;
                    if (IsLocked)
                        EnableNew =
                            EnableEdit =
                            EnableDelete =
                            //displayApprove =
                            //displayUnApprove = 
                            !(MOHManager.Instance.IsFinalRABExists(
                                String.IsNullOrEmpty(Request[MOHConstants.QRY_CONTRACTID])
                                    ? 0
                                    : Convert.ToInt32(Request[MOHConstants.QRY_CONTRACTID]),
                                String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? 0 : Convert.ToInt32(Request[&quot;WOID&quot;])));

                    //Close Out is disabled for NCC Phase II
                    displayCloseOut = false;
                    if (!String.IsNullOrEmpty(Request[&quot;WOID&quot;]))
                    {
                        int WOID = WOManager.Instance.GetLatestWorkOrderID(Request[&quot;WOID&quot;].ToInt32_2());
                        WorkOrderDTO WODTO = WOManager.Instance.GetWorkOrderDetails(WOID);
                        if (WODTO.Status == WOConstants.STAGE_CLOSED)
                        {
                            EnableNew =
                                EnableEdit =
                                EnableDelete =
                                //displayApprove =
                                displayApplyFilter =
                                //displayUnApprove = 
                                false;
                        }
                    }
                }
                catch
                {
                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?Context=CONTMGT&amp;&quot; + Constants.QRY_PROJECTID + &quot;=&quot; +
                                     Request.QueryString[Constants.QRY_PROJECTID] + &quot;&quot;, true);
                }
            }
            instanceIDColumn = &quot;MOHID&quot;;
            createDateColumn = &quot;CreatedDate&quot;;
        }

        public override string NewURL
        {
            get
            {
                return (HttpContext.Current.Handler as System.Web.UI.Page).ResolveUrl(string.Format(&quot;~/Modules/CONTMOH/NewMOH.aspx?&quot; + Constants.QRY_PROJECTID + &quot;=&quot; +
                              Request.QueryString[Constants.QRY_PROJECTID] + &quot;&amp;&quot; + MOHConstants.QRY_CONTRACTID + &quot;=&quot; +
                              Request.QueryString[MOHConstants.QRY_CONTRACTID] +
                              &quot;&amp;ParentContext=CONTMGT&quot; +
                              (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;] : string.Empty) +
                              &quot;&amp;MOHID=0&quot; + &quot;&amp;Type=N&quot; +
                              &quot;&quot;));
            }
        }

        public override void HandleNew()
        {
            Response.Redirect(NewURL, true);
        }

        public override void HandleEdit()
        {
            string selID = GetSelectedItemFromGrid();

            if (String.IsNullOrEmpty(selID))
                throw new Exception(&quot;Please Select a pre-payment record.&quot;);

            int MOHID = selID.ToInt32_2();

            var row = MWGrid.GetSelectedRow(mwGrid);
            //if (row.Cells.FromKey(&quot;Status&quot;).Value.ToString().Equals(&quot;Approved&quot;))
            //    throw new Exception(&quot;The pre-payment you are trying to Edit has been approved and cannot be edited.&quot;);
            if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Closed&quot;))
                throw new Exception(&quot;The pre-payment you are trying to Edit has been closed out and cannot be edited.&quot;);

            if (!MOHValidate(MOHID, ContractID))
                throw new Exception(&quot;Pre-Payment cannot be edited as it is closed by another user.&quot;);
            else
            {
                if (!string.IsNullOrEmpty(Request[&quot;WONo&quot;]))
                    Response.Redirect(
                        string.Format(CultureInfo.InvariantCulture,
                                      &quot;~/Modules/CONTMOH/NewMOH.aspx?Type=E&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&amp;WOID={3}&amp;WONo={4}&quot;,
                                      Request.QueryString[Constants.QRY_PROJECTID],
                                      Request.QueryString[MOHConstants.QRY_CONTRACTID], MOHID,
                                      Request.QueryString[&quot;WOID&quot;], Request.QueryString[&quot;WONo&quot;]), true);
                else
                    Response.Redirect(
                        string.Format(CultureInfo.InvariantCulture,
                                      &quot;~/Modules/CONTMOH/NewMOH.aspx?Type=E&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}{3}&quot;,
                                      Request.QueryString[Constants.QRY_PROJECTID],
                                      Request.QueryString[MOHConstants.QRY_CONTRACTID], MOHID,
                                      (!string.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                           ? &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]
                                           : string.Empty)), true);
            }
        }

        public override void HandleView()
        {
            string selID = GetSelectedItemFromGrid();

            if (String.IsNullOrEmpty(selID))
                throw new Exception(&quot;Please Select a pre-payment record.&quot;);

            int MOHID = selID.ToInt32_2();

            if (!MOHValidate(MOHID, ContractID))
                throw new Exception(&quot;The pre-payment you are trying to view has been deleted by another user.&quot;);
            else
            {
                if (!string.IsNullOrEmpty(Request[&quot;WONo&quot;]))
                    Response.Redirect(
                        string.Format(CultureInfo.InvariantCulture,
                                      &quot;~/Modules/CONTMOH/ViewMOH.aspx?PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&amp;WOID={3}&amp;WONo={4}&amp;ParentContext=CONTMGT&amp;Mode=View&quot;,
                                      Request.QueryString[Constants.QRY_PROJECTID],
                                      Request.QueryString[MOHConstants.QRY_CONTRACTID], MOHID,
                                      Request.QueryString[&quot;WOID&quot;], Request[&quot;WONo&quot;]), true);
                else
                    Response.Redirect(
                        string.Format(CultureInfo.InvariantCulture,
                                      &quot;~/Modules/CONTMOH/ViewMOH.aspx?PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&amp;WOID={3}&amp;ParentContext=CONTMGT&amp;Mode=View&quot;,
                                      Request.QueryString[Constants.QRY_PROJECTID],
                                      Request.QueryString[MOHConstants.QRY_CONTRACTID], MOHID,
                                      Request.QueryString[&quot;WOID&quot;]), true);
            }
        }

        public override int HandleDelete()
        {
            string selID = GetSelectedItemFromGrid();
            selID = FilterIdsToDeleteBasedOnWFDefinitions(FormName, PID.ToString2(), Request.QueryString[&quot;ContractID&quot;], selID);

            if (String.IsNullOrEmpty(selID))
                throw new Exception(&quot;Please Select a pre-payment record.&quot;);

            int MOHID = selID.ToInt32_2();
            int returnValue;
            try
            {
                var row = MWGrid.GetSelectedRow(mwGrid);
                if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Approved&quot;))
                    throw new Exception(
                        &quot;The pre-payment you are trying to Delete has been approved and cannot be deleted.&quot;);
                returnValue = MOHManager.Instance.DeleteMOH(MOHID);
                if (returnValue == 1)
                    throw new Exception(&quot;Cannot delete the chosen pre-payment. It is already a part of one or more &quot; +
                                        PayEstimatesName + &quot;.&quot;);
                else
                    ForceDeleteWorkflowsForThisForm(selID, FormName);
            }
            catch (Exception ex)
            {
                throw ex;
            }
            return returnValue;
        }

        public override bool PerformServerValidation(string key)
        {
            var selectedRow = MWGrid.GetSelectedRow(mwGrid);
            if (selectedRow != null)
            {
                int mohID = 0;
                if (Int32.TryParse(MWGrid.GetCellValue(selectedRow, QueryStringName).ToString2(), out mohID) &amp;&amp; mohID &gt; 0)
                {
                    #region Call SP which will run all the necessary validations at DB level

                    string validateWFResult = MOHManager.Instance.ValidateMOHForWorkFlow(mohID, key);
                    if (!String.IsNullOrEmpty(validateWFResult))
                        throw new Exception(validateWFResult.Replace(&quot;{_MOH}&quot;, &quot;Pre-Payment&quot;).Replace(&quot;{_PayEstimate}&quot;,
                                                                                                      String.Concat(
                                                                                                          LocalizationManager
                                                                                                              .GetString
                                                                                                              (KeyConstants
                                                                                                                   .
                                                                                                                   LOC_PAY_ESTIMATE),
                                                                                                          &quot;(s)&quot;)));

                    #endregion

                    if (key.Equals(&quot;Approve&quot;))
                    {
                        DateTime ApprovedOn, PrepaymentDate;
                        if (!String.IsNullOrEmpty(MWGrid.GetCellValue(selectedRow, &quot;Approved On&quot;).ToString2()) &amp;&amp;
                            !String.IsNullOrEmpty(MWGrid.GetCellValue(selectedRow, &quot;MOHDate&quot;).ToString2()))
                        {
                            PrepaymentDate = MWGrid.GetCellValue(selectedRow, &quot;MOHDate&quot;).ToDateTime_MWCulture();
                            ApprovedOn = MWGrid.GetCellValue(selectedRow, &quot;Approved On&quot;).ToDateTime_MWCulture();
                            if (DateTime.Compare(ApprovedOn, PrepaymentDate) &lt; 0)
                                throw new Exception(&quot;Approved On date cannot be earlier than pre-payment date.&quot;);
                            if (DateTime.Compare(ApprovedOn, DateTime.UtcNow) &gt; 0)
                                throw new Exception(&quot;Approved On date cannot be greater than the current date.&quot;);
                        }
                    }
                }
            }

            return true;
        }

        public override MenuHandlerStatus HandleApprove()
        {
            string selID = GetSelectedItemFromGrid();
            string result = &quot;&quot;;
            if (String.IsNullOrEmpty(selID))
                return MenuHandlerStatus.GetErrorObject(&quot;Please Select a pre-payment record.&quot;);

            int MOHID = selID.ToInt32_2();
            var row = MWGrid.GetSelectedRow(mwGrid);
            if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Approved&quot;))
                return MenuHandlerStatus.GetErrorObject(&quot;The selected pre-payment is already approved.&quot;);

            if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Closed&quot;))
                return MenuHandlerStatus.GetErrorObject(&quot;The pre-payment you are trying to approve has been closed.&quot;);

            if (!MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Draft&quot;))
                return MenuHandlerStatus.GetErrorObject(&quot;Only draft pre-payments can be approved.&quot;);


            if (!MOHValidate(MOHID, ContractID))
                return MenuHandlerStatus.GetErrorObject(&quot;The pre-payment you are trying to approve has been deleted by another user.&quot;);
            else
            {
                try
                {
                    DateTime ApprovedOn, PrepaymentDate;
                    if (!String.IsNullOrEmpty(MWGrid.GetCellValue(row, &quot;Approved On&quot;).ToString2()) &amp;&amp;
                        !String.IsNullOrEmpty(MWGrid.GetCellValue(row, &quot;MOHDate&quot;).ToString2()))
                    {
                        PrepaymentDate = MWGrid.GetCellValue(row, &quot;MOHDate&quot;).ToDateTime_MWCulture();
                        ApprovedOn = MWGrid.GetCellValue(row, &quot;Approved On&quot;).ToDateTime_MWCulture();
                        if (DateTime.Compare(ApprovedOn, PrepaymentDate) &lt; 0)
                            return MenuHandlerStatus.GetErrorObject(&quot;Approved On date cannot be earlier than pre-payment Date.&quot;);
                        if (DateTime.Compare(ApprovedOn, DateTime.UtcNow) &gt; 0)
                            return MenuHandlerStatus.GetErrorObject(&quot;Approved On date cannot be greater than the current date.&quot;);
                    }
                    else
                    {
                        ApprovedOn = String.IsNullOrEmpty(ApproveDate) ? DateTime.UtcNow : Convert.ToDateTime(ApproveDate);
                    }
                    HandleWorkflowValidation(selID, ApprovedOn, &quot;Approve&quot;);
                    MOHManager.Instance.ApproveMOH(selID, UserDetail.GetCurrentUserDetail().UID, ApprovedOn, false);

                    //switch (OUTPUT)
                    //{
                    //    case 0:
                    //    case 1:
                    //        isMenuClickHandled = true;
                    //        break;
                    //    case 3:
                    //        isMenuClickHandled = false;
                    //        break;
                    //    case 2:
                    //        throw new Exception(&quot;One or more &quot; + ItemNameAbbr + &quot;&#39;s recovery quantity or amount exceeds the remaining quantity. Request denied.&quot;);
                    //}
                    return MenuHandlerStatus.GetSuccessObject(result);
                }
                catch (Exception ex)
                {
                    return MenuHandlerStatus.GetErrorObject(ex);
                }
            }
            return MenuHandlerStatus.GetErrorObject(result);
        }

        public void HandleWorkflowValidation(string selID, DateTime ApprovedOn, string status)
        {
            int OUTPUT;
            if (status == &quot;Approve&quot;)
                OUTPUT = MOHManager.Instance.ValidateApproveMOH(selID, UserDetail.GetCurrentUserDetail().UID, ApprovedOn,
                                                                false);
            else
                OUTPUT = MOHManager.Instance.ValidateApproveMOH(selID, UserDetail.GetCurrentUserDetail().UID, ApprovedOn,
                                                                true);
            switch (OUTPUT)
            {
                case 0:
                case 1:
                    isMenuClickHandled = true;
                    break;
                case 3:
                    isMenuClickHandled = false;
                    break;
                case 2:
                    if (status == &quot;Approve&quot;)
                        throw new Exception(&quot;One or more &quot; + ItemNameAbbr +
                                            &quot;&#39;s recovery quantity or amount exceeds the remaining quantity. Request denied.&quot;);
                    else
                        throw new Exception(&quot;One or more &quot; + ItemNameAbbr + &quot;\\&#39;s have been recovered. Request denied.&quot;);
                case 4:
                    //If the Undo Approve is denied due to the recovery of Contract Pre Payment in any RAB,
                    //then the message shown is modified according to that(BRIX-16961)
                    throw new Exception(&quot;The Contract pre-payment have been recovered in one or more&quot;
                                        + PayEstimatesName + &quot;. Request denied.&quot;);
                case 5:
                    //If the Undo Approve is denied because of the association of the moh with one or more RABs and
                    //if no amount has been recovered.
                    throw new Exception(&quot;The pre-payment is associated with one or more &quot; + PayEstimatesName +
                                        &quot;. Request denied.&quot;);
            }
        }

        public override MenuHandlerStatus HandleUnApprove()
        {
            string selID = GetSelectedItemFromGrid();

            if (String.IsNullOrEmpty(selID))
                return MenuHandlerStatus.GetErrorObject(&quot;Please Select a pre-payment record.&quot;);

            int MOHID = selID.ToInt32_2();
            var row = MWGrid.GetSelectedRow(mwGrid);
            if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Closed&quot;))
                return MenuHandlerStatus.GetErrorObject(&quot;The pre-payment you are trying to UnApprove has been closed.&quot;);
            else if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Draft&quot;))
                return MenuHandlerStatus.GetErrorObject(&quot;The pre-payment you are trying to UnApprove is a Draft.&quot;);

            try
            {
                HandleWorkflowValidation(selID, DateTime.UtcNow, &quot;UnApprove&quot;);
                MOHManager.Instance.ApproveMOH(selID, UserDetail.GetCurrentUserDetail().UID, DateTime.UtcNow, true);
                //switch (OUTPUT)
                //{
                //    case 0:
                //    case 1:
                //        isMenuClickHandled = true;
                //        break;
                //    case 3:
                //        isMenuClickHandled = false;
                //        break;
                //    case 2:
                //        throw new Exception(&quot;One or more &quot; + ItemNameAbbr + &quot;\\&#39;s have been recovered. Request denied.&quot;);
                //    case 4:
                //        //If the Undo Approve is denied due to the recovery of Contract Pre Payment in any RAB,
                //        //then the message shown is modified according to that(BRIX-16961)
                //        throw new Exception(&quot;The Contract &quot; + moh + &quot; have been recovered in one or more&quot;
                //                                                            + PayEstimatesName + &quot;. Request denied.&quot;);
                //    case 5:
                //        //If the Undo Approve is denied because of the association of the moh with one or more RABs and
                //        //if no amount has been recovered.
                //        throw new Exception(&quot;The &quot; + moh + &quot; is associated with one or more &quot; + PayEstimatesName + &quot;. Request denied.&quot;);
                //}
            }
            catch (Exception ex)
            {
                return MenuHandlerStatus.GetErrorObject(ex);
            }
            return MenuHandlerStatus.GetSuccessObject(String.Empty);
        }

        public override string HandleMenuItem(string eventString)
        {
            if (eventString.Equals(&quot;Close Out&quot;))
            {
                string selID = GetSelectedItemFromGrid();

                if (String.IsNullOrEmpty(selID))
                    throw new Exception(&quot;Please Select a pre-payment record.&quot;);

                int MOHID = selID.ToInt32_2();

                DataSet ds = MOHManager.Instance.GetMOH(MOHID, Request[MOHConstants.QRY_CONTRACTID].ToInt32_2());

                if (ds.Tables[0].Rows.Count &lt;= 0)
                    throw new Exception(&quot;The pre-payment you are trying to Close Out has been deleted by another user.&quot;);
                else if (ds.Tables[0].Rows[0][&quot;PrePaymentType&quot;].ToBoolean2())
                    throw new Exception(&quot;The Contract pre-payments cannot be Closed.&quot;);
                else
                {
                    var sb = new StringBuilder();
                    sb.AppendFormat(CultureInfo.CurrentCulture, &quot;&lt;MOH&gt;\n&quot;);
                    sb.AppendFormat(CultureInfo.CurrentCulture, &quot;&lt;ID value=\&quot;{0}\&quot; /&gt;\n&quot;, MOHID);
                    sb.AppendFormat(CultureInfo.CurrentCulture, &quot;&lt;/MOH&gt;\n&quot;);

                    try
                    {
                        MOHManager.Instance.BalanceMOH(sb.ToString());
                        isMenuClickHandled = true;
                    }
                    catch (Exception ex)
                    {
                        throw ex;
                    }
                }
            }
            else if (eventString.Equals(&quot;Undo Approve&quot;) || eventString.ToLower2().Equals(&quot;unapprove&quot;))
            {
                string selID = GetSelectedItemFromGrid();

                if (String.IsNullOrEmpty(selID))
                    throw new Exception(&quot;Please Select a pre-payment record.&quot;);

                int MOHID = selID.ToInt32_2();
                var row = MWGrid.GetSelectedRow(mwGrid);
                if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Closed&quot;))
                    throw new Exception(&quot;The pre-payment you are trying to UnApprove has been closed.&quot;);
                else if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Draft&quot;))
                    throw new Exception(&quot;The pre-payment you are trying to UnApprove is a Draft.&quot;);


                try
                {
                    int OUTPUT = MOHManager.Instance.ApproveMOH(selID, UserDetail.GetCurrentUserDetail().UID,
                                                                DateTime.UtcNow, true);
                    switch (OUTPUT)
                    {
                        case 0:
                        case 1:
                            isMenuClickHandled = true;
                            break;
                        case 3:
                            isMenuClickHandled = false;
                            break;
                        case 2:
                            throw new Exception(&quot;One or more &quot; + ItemNameAbbr +
                                                &quot;&#39;s have been recovered. Request denied.&quot;);
                        case 4:
                            //If the Undo Approve is denied due to the recovery of Contract Pre Payment in any RAB,
                            //then the message shown is modified according to that(BRIX-16961)
                            throw new Exception(&quot;The Contract pre-payment has been recovered in one or more &quot;
                                                + PayEstimatesName + &quot;. Request denied.&quot;);
                        case 5:
                            //If the Undo Approve is denied because of the association of the moh with one or more RABs and
                            //if no amount has been recovered.
                            throw new Exception(&quot;The pre-payment is associated with one or more &quot; + PayEstimatesName +
                                                &quot;. Request denied.&quot;);
                    }
                }
                catch (Exception ex)
                {
                    throw ex;
                }
            }
            else
            {
                return base.HandleMenuItem(eventString);
            }
            return String.Empty;
        }

        public override BrixFilter[] GetApplyFilterLabels()
        {
            var filters = new BrixFilter[4];
            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Pre-payment ID&quot;;
            filters[0].Name = &quot;Pre-PaymentID&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Pre-payment Type&quot;;
            filters[1].Name = &quot;MOHType&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].Title = filters[2].Name = &quot;Contractor&quot;;

            filters[2].FilterType = BrixFilter.Type.Text;

            filters[3] = new BrixFilter();
            filters[3].Title = &quot;Status&quot;;
            filters[3].Name = &quot;Status&quot;;
            filters[3].FilterType = BrixFilter.Type.Combo;
            filters[3].Values = new Dictionary&lt;string, string&gt;();
            filters[3].Values[&quot;Draft&quot;] = &quot;Draft&quot;;
            filters[3].Values[&quot;Approved&quot;] = &quot;Approved&quot;;
            filters[3].Values[&quot;Partially Recovered&quot;] = &quot;Partially Recovered&quot;;
            filters[3].Values[&quot;Fully Recovered&quot;] = &quot;Fully Recovered&quot;;
            filters[3].DataSource = new DataTable();

            //filters[4] = new BrixFilter();
            //filters[4].Title = LocalizationManager.GetString(KeyConstants.LOC_MATERIAL_ON_HAND) + &quot; Type&quot;;
            //filters[4].Name = &quot;PrePaymentType&quot;;
            //filters[4].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        //public override void HandleGridRowInitialization(object sender, UltraGridRow row)
        //{
        //    String ApprovedOn = row.Cells.FromKey(&quot;Approved On&quot;).Value.ToString2();
        //    row.Cells.FromKey(&quot;Approved On&quot;).Column.EditorControlID = DateEditorControlID;
        //    if (String.IsNullOrEmpty(ApprovedOn))
        //    {
        //        row.Cells.FromKey(&quot;Approved On&quot;).AllowEditing = AllowEditing.Yes;
        //        row.Cells.FromKey(&quot;Approved On&quot;).Style.BackColor = Color.Yellow;
        //    }
        //}

        //public override void SetGridColumnProperties(UltraWebGrid grid)
        //{
        //    grid.Columns.FromKey(&quot;Approved On&quot;).EditorControlID = DateEditorControlID;
        //    grid.Columns.FromKey(&quot;Approved On&quot;).Type = ColumnType.Custom;
        //}

        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int CurrentPage,
                                        out int count)
        {
            //sortOrder = string.IsNullOrEmpty(sortOrder) ? DefaultSortColumn + &quot; DESC&quot; : sortOrder;
            sortOrder = DefaultSortColumn + &quot; DESC&quot;;

            if (!string.IsNullOrEmpty(sortOrder) &amp;&amp; sortOrder.Contains(&quot;img_&quot;))
                sortOrder = sortOrder.Replace(&quot;img_&quot;, string.Empty);

            count = 0;


            DataSet dsReturn = null;
            var attribs = (ListModelContextAttribute[])
                          GetType().GetCustomAttributes(typeof(ListModelContextAttribute), true);

            if (attribs.Length &gt; 0)
            {
                var dicDataSourceFilter = new Dictionary&lt;string, string&gt;();
                if (DataSourceFilters != null)
                {
                    foreach (string key in DataSourceFilters)
                    {
                        dicDataSourceFilter.Add(key, string.IsNullOrEmpty(Request[key]) ? &quot;0&quot; : Request[key]);
                    }
                }

                dsReturn = CoreDatabaseHelper.GetODSData(attribs[0].Table, pageSize, sortOrder, filter, filter.Trim().StartsWith(&quot;&lt;&quot;),
                                                        ref CurrentPage, out count, dicDataSourceFilter, null, null,
                                                        null, false, FormName,ListPrimaryKey, null, (Request[Constants.QRY_PROJECTID] ?? &quot;0&quot;).ToInt32_2(),
                                                        filterOrSortHasPendingOnUser: FilterOrSortHasPendingOnUser);
            }

            return dsReturn;
        }

        public override string GetEditPageURL(string pID, string parentID, string instanceID, string context)
        {
            DataTable dt = MOHComponent.Instance.GetWOIDForItems(instanceID);
            if (dt.Rows.Count &gt; 0)
            {
                if (dt.Rows[0][0].ToString2() == &quot;0&quot;)
                    return (HttpContext.Current.Handler as System.Web.UI.Page).ResolveUrl(string.Format(&quot;~/Modules/CONTMOH/NewMOH.aspx?Type=E&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&quot;, pID, parentID,
                                instanceID));
                else
                    return (HttpContext.Current.Handler as System.Web.UI.Page).ResolveUrl(string.Format(&quot;~/Modules/CONTMOH/NewMOH.aspx?Type=E&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&amp;WOID={3}&quot;, pID, parentID,
                                instanceID, dt.Rows[0][0].ToString2()));
            }
            else
                return (HttpContext.Current.Handler as System.Web.UI.Page).ResolveUrl(string.Format(&quot;~/Modules/CONTMOH/NewMOH.aspx?Type=E&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&quot;, pID, parentID,
                                instanceID));

        }

        public override string GetViewPageURL(string pID, string parentID, string instanceID, string context)
        {
            DataTable dt = MOHComponent.Instance.GetWOIDForItems(instanceID);
            if (dt.Rows.Count &gt; 0)
            {
                if (dt.Rows[0][0].ToString2() == &quot;0&quot;)
                    return (HttpContext.Current.Handler as System.Web.UI.Page).ResolveUrl(string.Format(&quot;~/Modules/CONTMOH/NewMOH.aspx?Type=V&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&quot;, pID, parentID,
                                instanceID));
                else
                    return (HttpContext.Current.Handler as System.Web.UI.Page).ResolveUrl(string.Format(&quot;~/Modules/CONTMOH/NewMOH.aspx?Type=V&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&amp;WOID={3}&quot;, pID, parentID,
                                instanceID, dt.Rows[0][0].ToString2()));
            }
            else
                return (HttpContext.Current.Handler as System.Web.UI.Page).ResolveUrl(string.Format(&quot;~/Modules/CONTMOH/NewMOH.aspx?Type=V&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;MOHID={2}&quot;, pID, parentID,
                                instanceID));

        }

        #region Utility Functions

        internal static bool MOHValidate(int MOHID, int contractID)
        {
            DataSet ds = MOHManager.Instance.GetMOH(MOHID, contractID);

            if (ds.Tables[0].Rows.Count &lt;= 0)
                return false;
            else
                return true;
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,29,10,1],[30,13,30,109,1],[31,9,31,10,1],[35,17,35,18,1],[35,19,35,34,1],[35,35,35,36,1],[40,17,40,18,1],[40,19,40,36,1],[40,37,40,38,1],[45,17,45,18,1],[45,19,45,57,1],[45,58,45,59,1],[50,17,50,18,1],[50,19,50,75,1],[50,76,50,77,1],[55,17,55,18,0],[55,19,55,32,0],[55,33,55,34,0],[60,17,60,18,0],[60,19,60,39,0],[60,40,60,41,0],[67,17,67,18,1],[67,19,67,36,1],[67,37,67,38,1],[72,17,72,18,0],[72,19,72,28,0],[72,29,72,30,0],[77,17,77,18,1],[77,19,77,34,1],[77,35,77,36,1],[82,17,82,18,1],[82,19,82,28,1],[82,29,82,30,1],[88,9,88,10,1],[95,13,95,101,1],[96,13,96,80,1],[97,13,97,97,1],[98,13,98,136,1],[100,13,100,121,1],[101,13,101,75,1],[102,13,102,74,1],[103,13,103,81,1],[108,13,108,76,1],[109,13,109,77,1],[110,13,110,81,1],[111,13,111,79,1],[112,13,112,76,1],[113,13,113,75,1],[114,13,114,85,1],[115,13,115,82,1],[119,13,119,39,1],[122,13,122,132,1],[123,13,123,14,1],[124,17,127,102,1],[128,17,131,102,1],[132,17,133,57,1],[134,17,134,60,1],[135,21,135,101,0],[137,21,137,90,1],[138,17,138,88,1],[139,17,139,18,0],[140,21,140,91,0],[141,17,141,18,0],[142,17,142,92,1],[143,17,143,18,0],[144,21,145,90,0],[146,17,146,18,0],[150,17,150,18,1],[151,21,151,100,1],[152,21,159,34,1],[160,21,160,34,1],[161,25,170,112,1],[173,21,173,45,1],[174,21,174,64,1],[175,21,175,22,0],[176,25,176,105,0],[177,25,177,91,0],[178,25,178,70,0],[179,25,179,26,0],[180,29,186,39,0],[187,25,187,26,0],[188,21,188,22,0],[189,17,189,18,1],[190,17,190,22,0],[191,17,191,18,0],[192,21,193,95,0],[194,17,194,18,0],[195,13,195,14,1],[196,13,196,40,1],[197,13,197,46,1],[198,9,198,10,1],[203,13,203,14,1],[204,17,210,36,1],[211,13,211,14,1],[215,9,215,10,0],[216,13,216,45,0],[217,9,217,10,0],[220,9,220,10,1],[221,13,221,54,1],[223,13,223,45,1],[224,17,224,76,0],[226,13,226,43,1],[228,13,228,53,1],[231,13,231,69,1],[232,17,232,121,0],[234,13,234,49,1],[235,17,235,102,0],[237,13,237,14,1],[238,17,238,60,1],[239,21,244,104,0],[246,21,253,68,1],[254,13,254,14,0],[255,9,255,10,0],[258,9,258,10,1],[259,13,259,54,1],[261,13,261,45,1],[262,17,262,76,0],[264,13,264,43,1],[266,13,266,49,1],[267,17,267,113,0],[269,13,269,14,1],[270,17,270,60,1],[271,21,276,92,0],[278,21,283,75,1],[284,13,284,14,0],[285,9,285,10,0],[288,9,288,10,1],[289,13,289,54,1],[290,13,290,128,1],[292,13,292,45,1],[293,17,293,76,0],[295,13,295,43,1],[298,13,298,14,1],[299,17,299,57,1],[300,17,300,75,1],[301,21,302,110,0],[303,17,303,68,1],[304,17,304,38,1],[305,21,306,65,0],[308,21,308,70,1],[309,13,309,14,1],[310,13,310,33,0],[311,13,311,14,0],[312,17,312,26,0],[314,13,314,32,1],[315,9,315,10,1],[318,9,318,10,0],[319,13,319,61,0],[320,13,320,37,0],[321,13,321,14,0],[322,17,322,31,0],[323,17,323,123,0],[324,17,324,18,0],[327,21,327,102,0],[328,21,328,65,0],[329,25,336,116,0],[340,21,340,47,0],[341,21,341,22,0],[343,25,344,108,0],[345,25,345,26,0],[346,29,346,113,0],[347,29,347,113,0],[348,29,348,82,0],[349,33,349,114,0],[350,29,350,83,0],[351,33,351,114,0],[352,25,352,26,0],[353,21,353,22,0],[354,17,354,18,0],[355,13,355,14,0],[357,13,357,25,0],[358,9,358,10,0],[361,9,361,10,0],[362,13,362,54,0],[363,13,363,32,0],[364,13,364,45,0],[365,17,365,96,0],[367,13,367,43,0],[368,13,368,53,0],[369,13,369,71,0],[370,17,370,106,0],[372,13,372,69,0],[373,17,373,119,0],[375,13,375,69,0],[376,17,376,101,0],[379,13,379,49,0],[380,17,380,136,0],[382,13,382,14,0],[384,17,384,18,0],[386,21,387,96,0],[388,21,388,22,0],[389,25,389,101,0],[390,25,390,101,0],[391,25,391,78,0],[392,29,392,130,0],[393,25,393,79,0],[394,29,394,130,0],[395,21,395,22,0],[397,21,397,22,0],[398,25,398,124,0],[399,21,399,22,0],[400,21,400,76,0],[401,21,401,117,0],[415,21,415,71,0],[417,17,417,37,0],[418,17,418,18,0],[419,21,419,65,0],[423,9,423,10,0],[426,9,426,10,0],[428,13,428,37,0],[429,17,430,72,0],[432,17,433,71,0],[434,13,434,28,0],[438,21,438,47,0],[439,21,439,27,0],[441,21,441,48,0],[442,21,442,27,0],[444,21,444,45,0],[445,25,446,127,0],[448,25,448,122,0],[452,21,453,83,0],[457,21,458,62,0],[460,9,460,10,0],[463,9,463,10,0],[464,13,464,54,0],[466,13,466,45,0],[467,17,467,96,0],[469,13,469,43,0],[470,13,470,53,0],[471,13,471,69,0],[472,17,472,121,0],[473,18,473,73,0],[474,17,474,116,0],[477,13,477,14,0],[478,17,478,79,0],[479,17,479,117,0],[501,13,501,14,0],[502,13,502,33,0],[503,13,503,14,0],[504,17,504,61,0],[506,13,506,69,0],[507,9,507,10,0],[510,9,510,10,1],[511,13,511,49,1],[512,13,512,14,0],[513,17,513,58,0],[515,17,515,49,0],[516,21,516,80,0],[518,17,518,47,0],[520,17,520,114,0],[522,17,522,50,0],[523,21,523,122,0],[524,22,524,78,0],[525,21,525,88,0],[527,17,527,18,0],[528,21,528,50,0],[529,21,529,76,0],[530,21,530,98,0],[531,21,531,77,0],[534,21,534,22,0],[535,25,535,71,0],[536,25,536,51,0],[537,21,537,22,0],[538,21,538,41,0],[539,21,539,22,0],[540,25,540,34,0],[542,17,542,18,0],[543,13,543,14,0],[544,18,544,103,1],[545,13,545,14,0],[546,17,546,58,0],[548,17,548,49,0],[549,21,549,80,0],[551,17,551,47,0],[552,17,552,57,0],[553,17,553,73,0],[554,21,554,105,0],[555,22,555,77,0],[556,21,556,100,0],[560,17,560,18,0],[561,21,562,88,0],[563,21,563,36,0],[567,29,567,55,0],[568,29,568,35,0],[570,29,570,56,0],[571,29,571,35,0],[573,29,574,92,0],[578,29,579,91,0],[583,29,584,70,0],[586,17,586,18,0],[587,17,587,37,0],[588,17,588,18,0],[589,21,589,30,0],[591,13,591,14,0],[593,13,593,14,1],[594,17,594,57,1],[596,13,596,33,0],[597,9,597,10,1],[600,9,600,10,1],[601,13,601,45,1],[602,13,602,43,1],[603,13,603,49,1],[604,13,604,47,1],[605,13,605,58,1],[607,13,607,43,1],[608,13,608,51,1],[609,13,609,41,1],[610,13,610,58,1],[612,13,612,43,1],[613,13,613,63,1],[615,13,615,58,1],[617,13,617,43,1],[618,13,618,41,1],[619,13,619,40,1],[620,13,620,59,1],[621,13,621,66,1],[622,13,622,50,1],[623,13,623,56,1],[624,13,624,78,1],[625,13,625,70,1],[626,13,626,53,1],[633,13,633,28,1],[634,9,634,10,1],[655,9,655,10,1],[657,13,657,53,1],[659,13,659,80,1],[660,17,660,69,0],[662,13,662,23,1],[665,13,665,37,1],[666,13,667,98,1],[669,13,669,36,1],[670,13,670,14,1],[671,17,671,76,1],[672,17,672,47,1],[673,17,673,18,1],[674,21,674,28,1],[674,30,674,40,1],[674,41,674,43,1],[674,44,674,61,1],[675,21,675,22,1],[676,25,676,111,1],[677,21,677,22,1],[678,17,678,18,1],[680,17,683,117,1],[684,13,684,14,1],[686,13,686,29,1],[687,9,687,10,1],[690,9,690,10,1],[691,13,691,78,1],[692,13,692,35,1],[693,13,693,14,1],[694,17,694,54,1],[695,21,696,46,1],[698,21,699,73,0],[702,17,703,46,0],[705,9,705,10,1],[708,9,708,10,0],[709,13,709,78,0],[710,13,710,35,0],[711,13,711,14,0],[712,17,712,54,0],[713,21,714,46,0],[716,21,717,73,0],[720,17,721,46,0],[723,9,723,10,0],[728,9,728,10,1],[729,13,729,72,1],[731,13,731,46,1],[732,17,732,30,0],[734,17,734,29,1],[735,9,735,10,1]]);
    </script>
  </body>
</html>