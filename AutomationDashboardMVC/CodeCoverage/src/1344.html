<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Common\BrixNewChecklist.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.Web.UI;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.BusinessLayer.DTO;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;

namespace Aurigo.AMP3.Core.UI
{
    public partial class BrixNewChecklist : BrixPageBase
    {
        private ChecklistPicker checklistPicker;
        private GenericPickerControl genericPicker;
        private List&lt;string&gt; strPermList;

        /// &lt;summary&gt;
        /// Gets the Project Mode : I-Integration, L-Live
        /// &lt;/summary&gt;
        private string ProjectMode
        {
            get
            {
                return (CacheManager.Instance.IsIntegrated(Request.QueryString[Constants.QRY_PROJECTID].ToInt32_2())
                    ? &quot;I&quot;
                    : &quot;L&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Gets the Integration Cutoff Date
        /// &lt;/summary&gt;
        private DateTime IntegrationCutoffDate
        {
            get { return (DateTime)Session[Constants.APP_IntegrationCutoffDate]; }
        }

        /// &lt;summary&gt;
        /// Gets the Default Record Date
        /// &lt;/summary&gt;
        private DateTime DefaultRecordDate
        {
            get { return (DateTime)Session[Constants.APP_DefaultRecordDate]; }
        }

        protected override void OnPreInit(EventArgs e)
        {
            int projectID = 0;
            projectID = (String.IsNullOrEmpty(Request[&quot;PID&quot;])) ? 0 : Request[&quot;PID&quot;].ToInt32_2();

            ModuleId = (projectID == 0 &amp;&amp;
                        Request[&quot;Context&quot;].ToString2() == Constants.MODID_LANDMGT)
                ? Constants.MODID_LANDMGT
                : (projectID &gt; 0 &amp;&amp;
                   Request[&quot;Context&quot;].ToString2() == Constants.MODID_LANDMGT)
                    ? &quot;PROJECT&quot;
                    : Request[&quot;Context&quot;];

            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            checklistPicker = (ucChecklistPicker);
            checklistPicker.BackClicked += btnCancelFromControl_Click;
            checklistPicker.SelectedIndexChanged += ChecklistPicker_SelectedIndexChanged;

            genericPicker = (ucUserPicker);
            genericPicker.BackClicked += GenericControlBack_Click;
            genericPicker.ItemSelected += GenericControlSelectedItem_Click;
            genericPicker.DefaultSortColumn = &quot;Name&quot;;
            genericPicker.DisplayFilter = true;
            genericPicker.IsFilterXml = true;
            genericPicker.Filters = GetCheckListFilters();
            genericPicker.DefaultColumnVisibility = false;

            if (!Page.IsPostBack)
            {
                genericPicker.TableOrViewName = &quot;CHKLISTStages&quot;;
                genericPicker.StateMgmtContext = &quot;CHKLISTStages&quot;;

                //Modifying columns properties of stages picker.
                ModifyGenericPickerColumns(genericPicker.StateMgmtContext);
            }

            base.OnInit(e);
        }

        private BrixFilter[] GetCheckListFilters()
        {
            var filters = new BrixFilter[2];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;CheckList Name :&quot;;
            filters[0].Name = &quot;Name&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;CheckList Description :&quot;;
            filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            UIHelper.DisableRoleSelection(Page);

            lblError.Text = String.Empty;

            // Setting the properties
            ModuleID = Request[&quot;Context&quot;];
            Mode = Request[&quot;Mode&quot;];
            PID = Request[&quot;PID&quot;].ToInt32_2();
            ChecklistID = String.IsNullOrEmpty(Request[&quot;ChecklistID&quot;]) ? 0 : Request[&quot;ChecklistID&quot;].ToInt32_2();
            EnterpriseLM = String.IsNullOrEmpty(Request[&quot;ENTPRSE_LM&quot;])
                ? String.Empty
                : Request[&quot;ENTPRSE_LM&quot;].ToString2();
            LMID = String.IsNullOrEmpty(Request[&quot;LMID&quot;]) ? 0 : Request[&quot;LMID&quot;].ToInt32_2();

            AssignInstanceID(ModuleID);

            if (!Page.IsPostBack)
            {
                SetPageHeader();

                SetDates();

                LoadUsers();

                if (Mode == &quot;N&quot;)
                {
                    BindStages();
                }
                else if (Mode == &quot;E&quot;)
                {
                    LoadChecklistDetails(ModuleID, InstanceID, ChecklistID);
                }
            }


            if (ViewState[&quot;StageOrActivity&quot;] != null)
            {
                var datasourceFilter = new Dictionary&lt;string, string&gt;();
                switch (ViewState[&quot;StageOrActivity&quot;].ToString2())
                {
                    case &quot;Stage&quot;:
                        datasourceFilter.Add(&quot;ChecklistID&quot;, &quot;0&quot;);
                        break;
                    case &quot;Activity&quot;:
                        datasourceFilter.Add(&quot;StageID&quot;, &quot;0&quot;);
                        break;
                }
                datasourceFilter.Add(&quot;ModuleID&quot;, &quot;LIBRARY&quot;);
                genericPicker.DataSourceFilter = datasourceFilter;

                genericPicker.TableOrViewName = (ViewState[&quot;StageOrActivity&quot;].ToString2() == &quot;Stage&quot;)
                    ? &quot;CHKLISTStages&quot;
                    : (ViewState[&quot;StageOrActivity&quot;].ToString2() == &quot;Checklist&quot;)
                        ? &quot;CHKLISTCheckList&quot;
                        : &quot;CHKLISTActivities&quot;;
                genericPicker.StateMgmtContext = (ViewState[&quot;StageOrActivity&quot;].ToString2() == &quot;Stage&quot;)
                    ? &quot;CHKLISTStages&quot;
                    : (ViewState[&quot;StageOrActivity&quot;].ToString2() == &quot;Checklist&quot;)
                        ? &quot;CHKLISTCheckList&quot;
                        : &quot;CHKLISTActivities&quot;;

                //Modifying columns properties.
                ModifyGenericPickerColumns(genericPicker.StateMgmtContext);
            }

            if (!Page.IsPostBack)
            {
                ViewState[&quot;PageTitleValue&quot;] = &quot;&quot;;
                if (Request[&quot;Mode&quot;] == &quot;N&quot;)
                    PageTitle = &quot;New Checklist&quot;;
                else
                    PageTitle = &quot;Edit Checklist&quot;;
            }
            else
            {
                if (string.IsNullOrEmpty(ViewState[&quot;PageTitleValue&quot;].ToString2()))
                {
                    if (Request[&quot;Mode&quot;] == &quot;N&quot;)
                        PageTitle = &quot;New Checklist&quot;;
                    else
                        PageTitle = &quot;Edit Checklist&quot;;
                }
                else
                {
                    PageTitle = ViewState[&quot;PageTitleValue&quot;].ToString2();
                }
            }
        }

        #region &quot;Button Clicks&quot;

        protected void ChecklistPicker_SelectedIndexChanged(object sender, ClickEventArgs e)
        {
            SetPageHeader();
            int checklistID = checklistPicker.GetChecklistID();

            // Checklist details from the library
            DataSet dsChecklistDetails = ChecklistManager.Instance.GetChecklist(&quot;LIBRARY&quot;, 0, checklistID);

            // Checklist details from the library
            DataRow drChecklistDetails = dsChecklistDetails.Tables[0].Rows[0];
            txtName.Text = drChecklistDetails[COL_CHECKLISTNAME].ToString2();
            txtDescription.Text = drChecklistDetails[COL_CHECKLISTDESCRIPTION].ToString2();

            // Details from the current grid if they exists
            DataTable dtStagesAndActivities = GetDataTable();
            GetStagesAndActivitiesRecords(dtStagesAndActivities, &quot;N&quot;);


            int tempStageID = -1;
            int tempActivityID = -1;
            int stageID = 0;
            foreach (DataRow row in dtStagesAndActivities.Rows)
            {
                if (tempStageID &gt;= row[COL_STAGEID].ToInt32_2())
                    tempStageID = row[COL_STAGEID].ToInt32_2() - 1;
            }

            foreach (DataRow row in dtStagesAndActivities.Rows)
            {
                if (tempActivityID &gt;= row[COL_ACTIVITYID].ToInt32_2())
                    tempActivityID = row[COL_ACTIVITYID].ToInt32_2() - 1;
            }

            DataRow[] drTemp = null;
            string query = String.Empty;

            foreach (DataRow dr in dsChecklistDetails.Tables[1].Rows)
            {
                if (dtStagesAndActivities.Rows.Count &gt; 0)
                {
                    query = &quot;StageName=&#39;&quot; + dr[COL_STAGENAME].ToString2().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
                    drTemp = dtStagesAndActivities.Select(query);

                    if (drTemp.Length &gt; 0)
                        stageID = drTemp[0][COL_STAGEID].ToInt32_2();

                    query = &quot;StageName=&#39;&quot; + dr[COL_STAGENAME].ToString2().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39; AND ActivityName=&#39;&quot; +
                            dr[COL_ACTIVITYNAME].ToString2().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;

                    drTemp = dtStagesAndActivities.Select(query);
                }

                if (drTemp == null || drTemp.Length == 0)
                {
                    DataRow drNewRow = dtStagesAndActivities.NewRow();

                    drNewRow[COL_STAGEID] = (stageID == 0) ? tempStageID : stageID;
                    drNewRow[COL_STAGENAME] = dr[COL_STAGENAME];
                    drNewRow[COL_ACTIVITYID] = tempActivityID;
                    drNewRow[COL_ACTIVITYNAME] = dr[COL_ACTIVITYNAME];
                    drNewRow[COL_ATTACHMENTS] = dr[COL_ATTACHMENTS];
                    drNewRow[COL_ATTACHMENTID] = Guid.NewGuid().ToString2();
                    drNewRow[COL_STARTDATE] =
                        wdcStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                            CultureInfo.CurrentCulture);
                    drNewRow[COL_ENDDATE] =
                        wdcStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                            CultureInfo.CurrentCulture);
                    drNewRow[COL_ESCALTION] = false;
                    drNewRow[COL_COMPLETED] = false;
                    drNewRow[COL_NOTES] = dr[COL_NOTES].ToString2();

                    dtStagesAndActivities.Rows.Add(drNewRow);
                    dtStagesAndActivities.AcceptChanges();
                    //dtStagesAndActivities.Copy().ToUtc().AcceptChanges();


                    tempStageID = (stageID == 0) ? (tempStageID - 1) : tempStageID;
                    tempActivityID = tempActivityID - 1;
                    stageID = 0;
                }
            }

            if (uwgStagesandActivities.Rows.Count &gt; 0)
                uwgStagesandActivities.Columns.FromKey(COL_STAGENAME).IsGroupByColumn = false;

            uwgStagesandActivities.DataSource = dtStagesAndActivities;
            uwgStagesandActivities.DataBind();

            FormatGrid();

            // Add the stages that came from the library checklist to the dropdown
            ListItem liStage = null;
            foreach (DataRow drStage in dtStagesAndActivities.Rows)
            {
                liStage = ddlStage.Items.FindByText(drStage[COL_STAGENAME].ToString2());

                if (liStage == null)
                {
                    ddlStage.Items.Add(new ListItem(drStage[COL_STAGENAME].ToString2(), drStage[COL_STAGEID].ToString2()));
                }
                liStage = null;
            }
        }

        // The user controls back handler
        protected void btnCancelFromControl_Click(object sender, EventArgs e)
        {
            SetPageHeader();

            ShowDiv(ChecklistEnums.ChecklistCreation);
        }

        protected void btnLibraryChecklist_Click(object sender, EventArgs e)
        {
            ShowDiv(ChecklistEnums.ChecklistPicker);
            PageTitle = &quot;Select Checklist&quot;;
            ViewState[&quot;StageOrActivity&quot;] = &quot;Checklist&quot;;
            ViewState[&quot;PageTitleValue&quot;] = &quot;Select Checklist&quot;;

            genericPicker.StateMgmtContext = &quot;CHKLISTCheckList&quot;;

            //Modifying columns properties of ckeck list picker.
            ModifyGenericPickerColumns(genericPicker.StateMgmtContext);
            var datasourceFilter = new Dictionary&lt;string, string&gt;();
            datasourceFilter.Add(&quot;ModuleID&quot;, &quot;LIBRARY&quot;);
            genericPicker.DataSourceFilter = datasourceFilter;


            genericPicker.ModifyColumnProperties(&quot;StartDate&quot;, true, null, null, null, false);
            genericPicker.ModifyColumnProperties(&quot;EndDate&quot;, true, null, null, null, false);
            genericPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
            genericPicker.ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
            genericPicker.ModifyColumnProperties(&quot;ChecklistID&quot;, true, null, null, null, false);
            genericPicker.ModifyColumnProperties(&quot;StageID&quot;, true, null, null, null, false);
            genericPicker.ModifyColumnProperties(&quot;Description&quot;, false, null, null, null, false);
            genericPicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);


            genericPicker.ChangeTableOrViewAndBind(&quot;CHKLISTCheckList&quot;);
        }

        // Temporary save of stages and activities on the page
        protected void btnStageActivitySave_Click(object sender, EventArgs e)
        {
            if (uwgStagesandActivities.Rows.Count &gt; 0)
                uwgStagesandActivities.Columns.FromKey(COL_STAGENAME).IsGroupByColumn = false;

            if (CheckDuplicate(uwgStagesandActivities, ((rbnStage.Checked)) ? &quot;StageName&quot; : &quot;ActivityName&quot;))
            {
                lblError.Text = (rbnStage.Checked) ? &quot;Duplicate stage name.&quot; : &quot;Duplicate activity name.&quot;;
                uwgStagesandActivities.Columns.FromKey(COL_STAGENAME).IsGroupByColumn = true;
                return;
            }

            DataTable dtStagesAndActivities = GetDataTable();

            GetStagesAndActivitiesRecords(dtStagesAndActivities, &quot;N&quot;);

            int tempStageID = -1;
            int tempActivityID = -1;
            if (hdnMode.Value == &quot;Add&quot;)
            {
                //Only the date component need to be checked and not the time.
                if (rbnActivity.Checked &amp;&amp;
                    (wdcSAStartDate.Value.ToDateTime_MWCulture().Date &gt; wdcSAEndDate.Value.ToDateTime_MWCulture().Date))
                {
                    lblError.Text = &quot;Start Date cannot be more than the end date.&quot;;
                    FormatGrid();
                    divStageAndActivity.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                    return;
                }

                //The activity dates should be within the Ckecklist date ranges and also only the date component 
                //need to be checked and not the time.(BRIX-16630)
                if (rbnActivity.Checked &amp;&amp;
                    (wdcSAStartDate.Value.ToDateTime_MWCulture().Date &lt; wdcStartDate.Value.ToDateTime_MWCulture().Date
                     || wdcSAEndDate.Value.ToDateTime_MWCulture().Date &gt; wdcEndDate.Value.ToDateTime_MWCulture().Date))
                {
                    lblError.Text = &quot;Activity dates should fall within the Checklist dates.&quot;;
                    FormatGrid();
                    return;
                }

                DataRow dr = dtStagesAndActivities.NewRow();

                foreach (DataRow row in dtStagesAndActivities.Rows)
                {
                    if (tempStageID &gt;= row[COL_STAGEID].ToInt32_2())
                        tempStageID = row[COL_STAGEID].ToInt32_2() - 1;
                }

                foreach (DataRow row in dtStagesAndActivities.Rows)
                {
                    if (tempActivityID &gt;= row[COL_ACTIVITYID].ToInt32_2())
                        tempActivityID = row[COL_ACTIVITYID].ToInt32_2() - 1;
                }

                dr[COL_STAGEID] = (rbnStage.Checked) ? tempStageID : ddlStage.SelectedValue.ToInt32_2();
                dr[COL_STAGENAME] = (rbnStage.Checked) ? txtDivName.Text : ddlStage.SelectedItem.Text;
                dr[COL_ACTIVITYID] = tempActivityID.ToString2();
                dr[COL_ACTIVITYNAME] = (rbnStage.Checked) ? &quot;Default Activity&quot; : txtDivName.Text;
                dr[COL_ATTACHMENTS] = &quot;Attachments&quot;;
                dr[COL_ATTACHMENTID] = Guid.NewGuid().ToString2();
                dr[COL_STARTDATE] = (rbnStage.Checked)
                    ? wdcStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                        CultureInfo.CurrentCulture)
                    : wdcSAStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                        CultureInfo.CurrentCulture);
                dr[COL_ENDDATE] = (rbnStage.Checked)
                    ? wdcStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                        CultureInfo.CurrentCulture)
                    : wdcSAEndDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                        CultureInfo.CurrentCulture);
                dr[COL_ESCALTION] = (rbnStage.Checked) ? false : chkEscalation.Checked;
                dr[COL_COMPLETED] = (rbnStage.Checked) ? false : chkCompleted.Checked;
                dr[COL_NOTES] = (rbnStage.Checked) ? String.Empty : txtNotes.Text;
                dr[COL_OWNERID] = (rbnStage.Checked) ? 0 : ddlActivityOwner.SelectedValue.ToInt32_2();
                dr[COL_OWNERNAME] = (rbnStage.Checked) ? string.Empty : ddlActivityOwner.SelectedItem.Text;

                dtStagesAndActivities.Rows.Add(dr);

                if (rbnStage.Checked)
                {
                    ddlStage.Items.Add(new ListItem(txtDivName.Text, tempStageID.ToString2()));
                    ddlStage.DataBind();
                }
            }
            else if (hdnMode.Value == &quot;Edit&quot; &amp;&amp; hdnStageorActivity.Value == &quot;Stage&quot;)
            {
                DataRow[] drStages =
                    dtStagesAndActivities.Select(&quot; StageName =&#39;&quot; + hdnStage.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;);

                for (int i = 0; i &lt; drStages.Length; i++)
                    drStages[i][COL_STAGENAME] = txtDivName.Text;

                dtStagesAndActivities.AcceptChanges();

                ListItem li = ddlStage.Items.FindByText(hdnStage.Value);

                li.Text = txtDivName.Text;
            }
            else if (hdnMode.Value == &quot;Edit&quot; &amp;&amp; hdnStageorActivity.Value == &quot;Activity&quot;)
            {
                //Only the date component need to be checked and not the time.
                if (wdcSAStartDate.Value.ToDateTime_MWCulture() &gt; wdcSAEndDate.Value.ToDateTime_MWCulture())
                {
                    lblError.Text = &quot;Start Date cannot be more than the end date.&quot;;
                    FormatGrid();
                    divStageAndActivity.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                    return;
                }

                //The activity dates should be within the Ckecklist date ranges and also only the date component 
                //need to be checked and not the time.(BRIX-16630)
                if (wdcSAStartDate.Value.ToDateTime_MWCulture() &lt; wdcStartDate.Value.ToDateTime_MWCulture()
                    || wdcSAEndDate.Value.ToDateTime_MWCulture() &gt; wdcEndDate.Value.ToDateTime_MWCulture())
                {
                    lblError.Text = &quot;Activity dates should fall within the Checklist dates.&quot;;
                    FormatGrid();
                    return;
                }

                DataRow[] drActivities =
                    dtStagesAndActivities.Select(&quot; StageName =&#39;&quot; + hdnStage.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot; +
                                                 &quot; AND ActivityID=&quot; + hdnActivity.Value);

                drActivities[0][COL_ACTIVITYNAME] = txtDivName.Text;
                drActivities[0][COL_STARTDATE] =
                    wdcSAStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                        CultureInfo.CurrentCulture);
                drActivities[0][COL_ENDDATE] =
                    wdcSAEndDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                        CultureInfo.CurrentCulture);
                drActivities[0][COL_COMPLETED] = chkCompleted.Checked;
                drActivities[0][COL_ESCALTION] = chkEscalation.Checked;
                drActivities[0][COL_NOTES] = txtNotes.Text;
                drActivities[0][COL_OWNERID] = ddlActivityOwner.SelectedValue.ToInt32_2();
                drActivities[0][COL_OWNERNAME] = ddlActivityOwner.SelectedItem.Text;
                dtStagesAndActivities.AcceptChanges();
            }

            uwgStagesandActivities.DataSource = dtStagesAndActivities;
            uwgStagesandActivities.DataBind();

            divStageAndActivity.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);

            FormatGrid();
        }

        protected void btnDelete_Click(object sender, EventArgs e)
        {
            if (uwgStagesandActivities.Rows.Count &gt; 0)
                uwgStagesandActivities.Columns.FromKey(COL_STAGENAME).IsGroupByColumn = false;

            DataTable dtStagesAndActivities = GetDataTable();

            GetStagesAndActivitiesRecords(dtStagesAndActivities, &quot;N&quot;);

            string queryDelete = String.Empty;

            switch (hdnMode.Value)
            {
                case &quot;S&quot;:
                    queryDelete = &quot; StageName = &#39;&quot; + hdnStage.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
                    break;
                case &quot;A&quot;:
                    DataRow[] drStageCount =
                        dtStagesAndActivities.Select(&quot; StageName = &#39;&quot; + hdnStage.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;);

                    if (drStageCount.Length == 1)
                    {
                        lblError.Text = &quot;Stage must have at least one activity.&quot;;
                        uwgStagesandActivities.Columns.FromKey(COL_STAGENAME).IsGroupByColumn = true;
                        return;
                    }
                    queryDelete = &quot;StageName = &#39;&quot; + hdnStage.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot; +
                                  &quot; AND ActivityID = &quot; + hdnActivity.Value;
                    break;
            }

            DataRow[] dr = dtStagesAndActivities.Select(queryDelete);

            foreach (DataRow row in dr)
            {
                if (hdnMode.Value == &quot;S&quot;)
                    ddlStage.Items.Remove(ddlStage.Items.FindByText(row[COL_STAGENAME].ToString()));
                dtStagesAndActivities.Rows.Remove(row);
            }

            if (dtStagesAndActivities.Rows.Count == 0)
                dtStagesAndActivities = null;

            uwgStagesandActivities.DataSource = dtStagesAndActivities;
            uwgStagesandActivities.DataBind();

            FormatGrid();
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            string url = &quot;~/Common/BrixChecklist.aspx?Context={0}&amp;PID={1}&quot;.Format2(ModuleID, PID.ToString2()) +
                         ModuleSpecificQueryString(ModuleID) +
                         (String.IsNullOrEmpty(Request[&quot;IsReadOnly&quot;])
                             ? String.Empty
                             : &quot;&amp;IsReadOnly=&quot; + Request[&quot;IsReadOnly&quot;]);
            Response.Redirect(
                url +
                (url.ToLower().Contains(&quot;contractid&quot;) || String.IsNullOrEmpty(Request.QueryString[&quot;ContractID&quot;])
                    ? String.Empty
                    : &quot;&amp;ContractID=&quot; + Request.QueryString[&quot;ContractID&quot;]), true);
        }

        // It saves the entire checklist details(including stages and activities) to database
        protected void btnSave_Click(object sender, EventArgs e)
        {
            // Validation
            if (wdcStartDate.Value.ToDateTime_MWCulture() &gt; wdcEndDate.Value.ToDateTime_MWCulture())
            {
                lblError.Text = &quot;Start date cannot be more than End date.&quot;;
                return;
            }

            var checklistDTO = new ChecklistDTO();

            DataTable dtStagesAndActivities = GetDataTable();
            GetStagesAndActivitiesRecords(dtStagesAndActivities, &quot;Y&quot;);

            //The date range validation is done for each and every activity in the Checklist and
            //if any of the activity falls outside the Ckecklist date, the error message is shown.
            //Also only the date component need to be checked.(BRIX-16630)
            foreach (DataRow dr in dtStagesAndActivities.Select())
            {
                if ((dr[COL_STARTDATE].ToDateTime_MWCulture().Date &lt; wdcStartDate.Value.ToDateTime_MWCulture().Date
                     || dr[COL_ENDDATE].ToDateTime_MWCulture().Date &gt; wdcEndDate.Value.ToDateTime_MWCulture().Date))
                {
                    lblError.Text = &quot;Activity dates should fall within the Checklist dates.&quot;;
                    return;
                }
            }

            DataSet dsStagesAndActivities = new BrixDataSet();
            dsStagesAndActivities.Tables.Add(dtStagesAndActivities.Copy().ToUtc(COL_STARTDATE, COL_ENDDATE).ToDateTimeString_ForDatabaseOpenXml(new List&lt;String&gt;(){ COL_STARTDATE, COL_ENDDATE}));

            checklistDTO.ChecklistID = ChecklistID;
            checklistDTO.ChecklistName = txtName.Text;
            checklistDTO.ChecklistDescription = txtDescription.Text;
            checklistDTO.ChecklistStartDate = wdcStartDate.Value.ToMWUtcDateTime();
            checklistDTO.ChecklistEndDate = wdcEndDate.Value.ToMWUtcDateTime();
            checklistDTO.ModuleID = ModuleID;
            checklistDTO.ParentInstanceID = InstanceID;
            checklistDTO.ChecklistXML = dsStagesAndActivities.GetXml();
            checklistDTO.Mode = Mode;
            checklistDTO.ActivitiesList = hdnActivitiesList.Value;
            checklistDTO.CompletedBy = UserDetail.GetCurrentUserDetail().FirstName + &quot; &quot; +
                                       UserDetail.GetCurrentUserDetail().MiddleName + &quot; &quot; +
                                       UserDetail.GetCurrentUserDetail().LastName;

            int result;
            result = ChecklistManager.Instance.SaveChecklist(checklistDTO);
            string url = &quot;~/Common/BrixChecklist.aspx?Context={0}&amp;PID={1}&quot;.Format2(ModuleID, PID.ToString2()) +
                         ModuleSpecificQueryString(ModuleID) +
                         (String.IsNullOrEmpty(Request[&quot;IsReadOnly&quot;])
                             ? String.Empty
                             : &quot;&amp;IsReadOnly=&quot; + Request[&quot;IsReadOnly&quot;]);
            Response.Redirect(
                url +
                (url.ToLower().Contains(&quot;contractid&quot;) || String.IsNullOrEmpty(Request[&quot;ContractID&quot;])
                    ? String.Empty
                    : &quot;&amp;ContractID=&quot; + Request[&quot;ContractID&quot;]), true);
        }

        protected void btnPicker_Click(object sender, EventArgs e)
        {
            if (rbnStage.Checked)
            {
                ShowDiv(ChecklistEnums.StagePicker);
                ViewState[&quot;StageOrActivity&quot;] = &quot;Stage&quot;;

                trNotes.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                trEscalation.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                trCompleted.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                trEndDate.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                trStartDate.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                trStage.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                trDescription.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                trOwner.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);


                genericPicker.StateMgmtContext = &quot;CHKLISTStages&quot;;

                //Modifying columns properties of stages picker.
                ModifyGenericPickerColumns(genericPicker.StateMgmtContext);
                var datasourceFilter = new Dictionary&lt;string, string&gt;();
                datasourceFilter.Add(&quot;ModuleID&quot;, &quot;LIBRARY&quot;);
                datasourceFilter.Add(&quot;ChecklistID&quot;, &quot;0&quot;);
                genericPicker.DataSourceFilter = datasourceFilter;

                genericPicker.ModifyColumnProperties(&quot;StageID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ChecklistID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;Description&quot;, false, null, null, null, false);


                genericPicker.ChangeTableOrViewAndBind(&quot;CHKLISTStages&quot;);
                PageTitle = &quot;Select Stages&quot;;
                ViewState[&quot;PageTitleValue&quot;] = &quot;Select Stages&quot;;
            }
            else if (rbnActivity.Checked)
            {
                ShowDiv(ChecklistEnums.ActivityPicker);
                ViewState[&quot;StageOrActivity&quot;] = &quot;Activity&quot;;

                genericPicker.StateMgmtContext = &quot;CHKLISTActivities&quot;;

                //Modifying columns properties of activities picker.
                ModifyGenericPickerColumns(genericPicker.StateMgmtContext);
                var datasourceFilter = new Dictionary&lt;string, string&gt;();
                datasourceFilter.Add(&quot;ModuleID&quot;, &quot;LIBRARY&quot;);
                datasourceFilter.Add(&quot;StageID&quot;, &quot;0&quot;);
                genericPicker.DataSourceFilter = datasourceFilter;

                genericPicker.ModifyColumnProperties(&quot;ActivityID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;StartDate&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;EndDate&quot;, true, null, null, null, false);

                genericPicker.ModifyColumnProperties(&quot;Completed&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;AttachmentID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;StageID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;RequiresEscalation&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ChecklistID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;CompletedBy&quot;, true, null, null, null, false);

                genericPicker.ChangeTableOrViewAndBind(&quot;CHKLISTActivities&quot;);

                trNotes.Style.Add(HtmlTextWriterStyle.Display, &quot;table-row&quot;);
                trEscalation.Style.Add(HtmlTextWriterStyle.Display, &quot;table-row&quot;);
                trCompleted.Style.Add(HtmlTextWriterStyle.Display, &quot;table-row&quot;);
                trEndDate.Style.Add(HtmlTextWriterStyle.Display, &quot;table-row&quot;);
                trStartDate.Style.Add(HtmlTextWriterStyle.Display, &quot;table-row&quot;);
                trStage.Style.Add(HtmlTextWriterStyle.Display, &quot;table-row&quot;);
                trDescription.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                trOwner.Style.Add(HtmlTextWriterStyle.Display, &quot;table-row&quot;);

                PageTitle = &quot;Select Activities&quot;;
                ViewState[&quot;PageTitleValue&quot;] = &quot;Select Activities&quot;;
            }
        }

        protected void GenericControlBack_Click(object sender, EventArgs e)
        {
            ViewState[&quot;PageTitleValue&quot;] = &quot;&quot;;
            ShowStageOrActivity();
            SetPageHeader();
            ShowDiv(ChecklistEnums.ChecklistCreation);
        }

        protected void GenericControlSelectedItem_Click(object sender, ItemSelectedEventArgs e)
        {
            ShowStageOrActivity();

            DataTable dtSelectedRows = e.SelectedItems;

            if (genericPicker.StateMgmtContext == &quot;CHKLISTCheckList&quot;)
            {
                SetPageHeader();
                int checklistID = dtSelectedRows.Rows[0][&quot;CheckListID&quot;].ToString2().ToInt32_2();

                // Checklist details from the library
                DataSet dsChecklistDetails = ChecklistManager.Instance.GetChecklist(&quot;LIBRARY&quot;, 0, checklistID);

                // Checklist details from the library
                DataRow drChecklistDetails = dsChecklistDetails.Tables[0].Rows[0];
                txtName.Text = drChecklistDetails[COL_CHECKLISTNAME].ToString2();
                txtDescription.Text = drChecklistDetails[COL_CHECKLISTDESCRIPTION].ToString2();

                // Details from the current grid if they exists
                DataTable dtStagesAndActivities = GetDataTable();
                GetStagesAndActivitiesRecords(dtStagesAndActivities, &quot;N&quot;);


                int tempStageID = -1;
                int tempActivityID = -1;
                int stageID = 0;
                foreach (DataRow row in dtStagesAndActivities.Rows)
                {
                    if (tempStageID &gt;= row[COL_STAGEID].ToInt32_2())
                        tempStageID = row[COL_STAGEID].ToInt32_2() - 1;
                }

                foreach (DataRow row in dtStagesAndActivities.Rows)
                {
                    if (tempActivityID &gt;= row[COL_ACTIVITYID].ToInt32_2())
                        tempActivityID = row[COL_ACTIVITYID].ToInt32_2() - 1;
                }

                DataRow[] drTemp = null;
                string query = String.Empty;

                foreach (DataRow dr in dsChecklistDetails.Tables[1].Rows)
                {
                    if (dtStagesAndActivities.Rows.Count &gt; 0)
                    {
                        query = &quot;StageName=&#39;&quot; + dr[COL_STAGENAME].ToString2().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
                        drTemp = dtStagesAndActivities.Select(query);

                        if (drTemp.Length &gt; 0)
                            stageID = drTemp[0][COL_STAGEID].ToInt32_2();

                        query = &quot;StageName=&#39;&quot; + dr[COL_STAGENAME].ToString2().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) +
                                &quot;&#39; AND ActivityName=&#39;&quot; + dr[COL_ACTIVITYNAME].ToString2().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;

                        drTemp = dtStagesAndActivities.Select(query);
                    }

                    if (drTemp == null || drTemp.Length == 0)
                    {
                        DataRow drNewRow = dtStagesAndActivities.NewRow();

                        drNewRow[COL_STAGEID] = (stageID == 0) ? tempStageID : stageID;
                        drNewRow[COL_STAGENAME] = dr[COL_STAGENAME];
                        drNewRow[COL_ACTIVITYID] = tempActivityID;
                        drNewRow[COL_ACTIVITYNAME] = dr[COL_ACTIVITYNAME];
                        drNewRow[COL_ATTACHMENTS] = dr[COL_ATTACHMENTS];
                        drNewRow[COL_ATTACHMENTID] = Guid.NewGuid().ToString2();
                        drNewRow[COL_STARTDATE] =
                            wdcStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                                CultureInfo.CurrentCulture);
                        drNewRow[COL_ENDDATE] =
                            wdcStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                                CultureInfo.CurrentCulture);
                        drNewRow[COL_ESCALTION] = false;
                        drNewRow[COL_COMPLETED] = false;
                        drNewRow[COL_NOTES] = dr[COL_NOTES].ToString2();

                        dtStagesAndActivities.Rows.Add(drNewRow);
                        dtStagesAndActivities.AcceptChanges();
                   
                        tempStageID = (stageID == 0) ? (tempStageID - 1) : tempStageID;
                        tempActivityID = tempActivityID - 1;
                        stageID = 0;
                    }
                }

                if (uwgStagesandActivities.Rows.Count &gt; 0)
                    uwgStagesandActivities.Columns.FromKey(COL_STAGENAME).IsGroupByColumn = false;

                if (CHKPRJLComponents.Contains(&quot;OwnerNameDefault&quot;))
                {
                    string UserName = UserDetail.GetCurrentUserDetail().UserName;

                    foreach (DataRow d in dtStagesAndActivities.Rows)
                    {
                        d[&quot;OwnerName&quot;] = UserName;
                    }
                }

                //If the checklist coming from the library doesn&#39;t have any stages, the columns headers of the 
                //dtStagesAndActivities table need not be added to uwgStagesandActivities grid.
                uwgStagesandActivities.DataSource = dtStagesAndActivities.Rows.Count &gt; 0
                    ? dtStagesAndActivities
                    : null;
                uwgStagesandActivities.DataBind();

                FormatGrid();

                // Add the stages that came from the library checklist to the dropdown
                ListItem liStage = null;
                foreach (DataRow drStage in dtStagesAndActivities.Rows)
                {
                    liStage = ddlStage.Items.FindByText(drStage[COL_STAGENAME].ToString2());

                    if (liStage == null)
                    {
                        ddlStage.Items.Add(new ListItem(drStage[COL_STAGENAME].ToString2(),
                            drStage[COL_STAGEID].ToString2()));
                    }
                    liStage = null;
                }
            }
            else if (rbnStage.Checked)
            {
                SetPageHeader();
                txtDivName.Text = dtSelectedRows.Rows[0][&quot;Name&quot;].ToString2();
                //We are not showing or using the description. 
                //Need to think if description is reqd.
                //txtDivDescription.Text = dtSelectedRows.Rows[0][&quot;Description&quot;].ToString2();
            }
            else if (rbnActivity.Checked)
            {
                SetPageHeader();
                txtDivName.Text = dtSelectedRows.Rows[0][&quot;Name&quot;].ToString2();
                txtNotes.Text = dtSelectedRows.Rows[0][&quot;Notes&quot;].ToString2();
            }

            ShowDiv(ChecklistEnums.ChecklistCreation);
        }

        private void ShowStageOrActivity()
        {
            if (ViewState[&quot;StageOrActivity&quot;] != null)
            {
                if (ViewState[&quot;StageOrActivity&quot;].ToString2() == &quot;Stage&quot;)
                {
                    divStageAndActivity.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                }
                else if (ViewState[&quot;StageOrActivity&quot;].ToString2() == &quot;Activity&quot;)
                {
                    divStageAndActivity.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                }

                ViewState.Remove(&quot;StageOrActivity&quot;);
            }
        }

        // This method will modify the column properties of the generic picker.
        private void ModifyGenericPickerColumns(string stateManagementContext)
        {
            //For check list picker
            if (stateManagementContext == &quot;CHKLISTCheckList&quot;)
            {
                genericPicker.ModifyColumnProperties(&quot;StartDate&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;EndDate&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ChecklistID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;StageID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;Description&quot;, false, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;Name&quot;, false, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
            }
            //For stages picker
            else if (stateManagementContext == &quot;CHKLISTStages&quot;)
            {
                genericPicker.ModifyColumnProperties(&quot;StageID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ChecklistID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;Description&quot;, false, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;Name&quot;, false, null, null, null, false);
            }
            //For activities picker
            else if (stateManagementContext == &quot;CHKLISTActivities&quot;)
            {
                genericPicker.ModifyColumnProperties(&quot;ActivityID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;StartDate&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;EndDate&quot;, true, null, null, null, false);

                genericPicker.ModifyColumnProperties(&quot;Completed&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;AttachmentID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;StageID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;RequiresEscalation&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;ChecklistID&quot;, true, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;Notes&quot;, false, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;Name&quot;, false, null, null, null, false);
                genericPicker.ModifyColumnProperties(&quot;CompletedBy&quot;, true, null, null, null, false);
            }
        }

        #endregion

        #region &quot;Functions&quot;

        private void SetPageHeader()
        {
            PageTitle = (Mode == &quot;N&quot;) ? &quot;New Checklist&quot; : &quot;Edit Checklist&quot;;
            ViewState[&quot;PageTitleValue&quot;] = &quot;&quot;;
        }

        private void BindStages()
        {
            ddlStage.Items.Insert(0, new ListItem(&quot;Select One&quot;, &quot;0&quot;));
        }

        private void SetDates()
        {
            if (ProjectMode == &quot;I&quot;)
            {
                wdcStartDate.MaxDate = IntegrationCutoffDate.ToMWDateTime().AddDays(-1);
                wdcStartDate.Value = DefaultRecordDate.ToMWDateTime();
            }
            else if (ProjectMode == &quot;L&quot;)
            {
                wdcStartDate.MaxDate = DateTime.MaxValue;
                wdcStartDate.Value = MWDateTimeHelper.MWToday;
            }

            wdcEndDate.Value =
                wdcSAStartDate.Value =
                    wdcSAEndDate.Value = wdcStartDate.Value;
        }

        private DataTable GetDataTable()
        {
            DataTable dtTemp = new BrixDataTable();

            dtTemp.Columns.Add(COL_STAGEID, Type.GetType(TYPE_INT));
            dtTemp.Columns.Add(COL_STAGENAME, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_ACTIVITYID, Type.GetType(TYPE_INT));
            dtTemp.Columns.Add(COL_ACTIVITYNAME, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_ATTACHMENTS, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_ATTACHMENTID, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_STARTDATE, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_ENDDATE, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_ESCALTION, Type.GetType(TYPE_BOOL));
            dtTemp.Columns.Add(COL_COMPLETED, Type.GetType(TYPE_BOOL));
            dtTemp.Columns.Add(COL_NOTES, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_OWNERID, Type.GetType(TYPE_INT));
            dtTemp.Columns.Add(COL_OWNERNAME, Type.GetType(TYPE_STRING));

            return dtTemp;
        }

        private void GetStagesAndActivitiesRecords(DataTable dt, string saveToDatabase)
        {
            DataRow row;
            if (uwgStagesandActivities.Rows.Count &gt; 0)
            {
                UltraGridRowsEnumerator enParentRow = uwgStagesandActivities.Bands[0].GetRowsEnumerator();

                while (enParentRow.MoveNext())
                {
                    CellsCollection cells = enParentRow.Current.Cells;

                    row = dt.NewRow();
                    row[COL_STAGEID] = cells.FromKey(COL_STAGEID).Value.ToString2().ToInt32_2();
                    row[COL_STAGENAME] = cells.FromKey(COL_STAGENAME).Value;
                    row[COL_ACTIVITYID] = (cells.FromKey(COL_ACTIVITYID).Value != null)
                        ? cells.FromKey(COL_ACTIVITYID).Value.ToString2().ToInt32_2()
                        : 0;
                    row[COL_ACTIVITYNAME] = (cells.FromKey(COL_ACTIVITYNAME).Value != null)
                        ? cells.FromKey(COL_ACTIVITYNAME).Text
                        : String.Empty;
                    row[COL_NOTES] = (cells.FromKey(COL_NOTES).Value != null)
                        ? cells.FromKey(COL_NOTES).Text
                        : String.Empty;
                    row[COL_COMPLETED] = (cells.FromKey(COL_COMPLETED).Value != null)
                        ? cells.FromKey(COL_COMPLETED).Text.ToBoolean2()
                        : false;
                    row[COL_ATTACHMENTS] = COL_ATTACHMENTS;
                    row[COL_ATTACHMENTID] = (cells.FromKey(COL_ATTACHMENTID).Value != null)
                        ? cells.FromKey(COL_ATTACHMENTID).Text
                        : String.Empty;

                    if (cells.FromKey(COL_STARTDATE).Column.DataType == &quot;System.DateTime&quot;)
                        row[COL_STARTDATE] = (saveToDatabase == &quot;Y&quot;)
                            ? (cells.FromKey(COL_STARTDATE).Value).ToString_MWCulture()
                            : (cells.FromKey(COL_STARTDATE).Value).ToDateTime_MWCulture().ToString(
                                AMP3ApplicationSettings.Instance.FORMAT_DATETIME, CultureInfo.CurrentCulture);
                    else
                        row[COL_STARTDATE] = (cells.FromKey(COL_STARTDATE).Value != null)
                            ? ((saveToDatabase == &quot;Y&quot;)
                                ? Convert.ToDateTime(cells.FromKey(COL_STARTDATE).Text,
                                    DateFormatCulture.GetDateFormatCulture()).ToString()                                   
                                : cells.FromKey(COL_STARTDATE).Text)
                            : wdcStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                                CultureInfo.CurrentCulture);

                    if (cells.FromKey(COL_ENDDATE).Column.DataType == &quot;System.DateTime&quot;)
                        row[COL_ENDDATE] = (saveToDatabase == &quot;Y&quot;)
                            ? (cells.FromKey(COL_ENDDATE).Value).ToDateTime_MWCulture().ToString2()
                            : (cells.FromKey(COL_ENDDATE).Value).ToDateTime_MWCulture().ToString(
                                AMP3ApplicationSettings.Instance.FORMAT_DATETIME, CultureInfo.CurrentCulture);
                    else
                        row[COL_ENDDATE] = (cells.FromKey(COL_ENDDATE).Value != null)
                            ? ((saveToDatabase == &quot;Y&quot;)
                                ? Convert.ToDateTime(cells.FromKey(COL_ENDDATE).Text,
                                    DateFormatCulture.GetDateFormatCulture()).ToString()                                    
                                : cells.FromKey(COL_ENDDATE).Text)
                            : wdcStartDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATETIME,
                                CultureInfo.CurrentCulture);
                    row[COL_ESCALTION] = (cells.FromKey(COL_ESCALTION).Value != null)
                        ? cells.FromKey(COL_ESCALTION).Text.ToBoolean2()
                        : false;

                    row[COL_OWNERID] = (cells.FromKey(COL_OWNERID).Value != null)
                        ? cells.FromKey(COL_OWNERID).Text
                        : &quot;0&quot;;

                    row[COL_OWNERNAME] = (cells.FromKey(COL_OWNERNAME).Value != null)
                        ? cells.FromKey(COL_OWNERNAME).Text
                        : string.Empty;

                    dt.Rows.Add(row);
                }
            }
        }

        private bool CheckDuplicate(UltraWebGrid uwg, string flag)
        {
            bool duplicate = false;
            string query = String.Empty;
            DataRow[] dr = null;

            if (flag == &quot;StageName&quot;)
            {
                query = COL_STAGENAME + &quot;=&#39;&quot; + txtDivName.Text.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
            }
            else
            {
                query = COL_STAGEID + &quot;=&quot; + ddlStage.SelectedItem.Value + &quot; AND &quot; +
                        COL_ACTIVITYNAME + &quot;=&#39;&quot; + txtDivName.Text.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
            }

            if (uwgStagesandActivities.Rows.Count &gt; 0)
            {
                DataTable dtTemp = GetDataTable();

                GetStagesAndActivitiesRecords(dtTemp, &quot;N&quot;);

                dr = dtTemp.Select(query);

                if (hdnMode.Value == &quot;Add&quot; &amp;&amp; dr.Length &gt; 0)
                {
                    duplicate = true;
                }
                if (hdnMode.Value == &quot;Edit&quot; &amp;&amp; dr.Length &gt; 1)
                {
                    duplicate = true;
                }
            }

            return duplicate;
        }

        private void FormatGrid()
        {
            if (uwgStagesandActivities.Rows.Count &gt; 0)
            {
                uwgStagesandActivities.DisplayLayout.AllowSortingDefault = AllowSorting.No;
                ColumnsCollection cols = uwgStagesandActivities.Columns;

                cols.FromKey(COL_ACTIVITYID).Hidden =
                    cols.FromKey(COL_ATTACHMENTID).Hidden =
                        cols.FromKey(COL_STAGEID).Hidden =
                            cols.FromKey(COL_ATTACHMENTS).Hidden = true;

                cols.FromKey(COL_ACTIVITYNAME).Width = Unit.Pixel(150);
                cols.FromKey(COL_NOTES).Width = Unit.Pixel(130);
                cols.FromKey(COL_ESCALTION).Width = Unit.Pixel(150);
                cols.FromKey(COL_STARTDATE).Width =
                    cols.FromKey(COL_ENDDATE).Width = Unit.Pixel(60);
                cols.FromKey(COL_COMPLETED).Width = Unit.Pixel(100);

                cols.FromKey(COL_ESCALTION).Header.Caption = &quot;Requires Escalation&quot;;
                cols.FromKey(COL_ACTIVITYNAME).Header.Caption = &quot;Activity Name&quot;;
                cols.FromKey(COL_STARTDATE).Header.Caption = &quot;Start Date&quot;;
                cols.FromKey(COL_ENDDATE).Header.Caption = &quot;End Date&quot;;

                cols.FromKey(COL_OWNERNAME).Header.Caption = &quot;Owner&quot;;
                cols.FromKey(COL_OWNERID).Hidden = true;

                if (cols.Exists(COL_COMPLETEDBY))
                {
                    cols.FromKey(COL_COMPLETEDBY).Width = Unit.Pixel(60);
                    cols.FromKey(COL_COMPLETEDBY).Header.Caption = &quot;Completed By&quot;;
                    cols.FromKey(COL_COMPLETEDBY).HTMLEncodeContent = true;
                }

                cols.FromKey(COL_COMPLETED).AllowUpdate = (strPermList.Contains(&quot;Checklist Complete&quot;))
                    ? AllowUpdate.Yes
                    : AllowUpdate.No;
                cols.FromKey(COL_ESCALTION).AllowUpdate =
                    cols.FromKey(COL_NOTES).AllowUpdate = AllowUpdate.Yes;

                cols.FromKey(COL_STARTDATE).Format =
                    cols.FromKey(COL_ENDDATE).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;

                cols.FromKey(COL_STAGENAME).IsGroupByColumn = true;

                cols.FromKey(COL_ACTIVITYNAME).HTMLEncodeContent = true;                
                cols.FromKey(COL_OWNERNAME).HTMLEncodeContent = true;
                cols.FromKey(COL_NOTES).HTMLEncodeContent = true;
                cols.FromKey(COL_STAGENAME).HTMLEncodeContent = true;
            }
        }

        public override int GetProjectIdFromInstanceId()
        {
            if (Request[&quot;Context&quot;] == Constants.MODID_LANDMGT
                || Request[&quot;Context&quot;] == Constants.MODID_PROJECT
                || Request[&quot;Context&quot;] == Constants.MODID_PLANING 
                || Request[&quot;Context&quot;] == Constants.MODID_ESTMATE)
                return base.GetProjectIdFromInstanceId();
            else // for  CONTMGT and Estimate
            {
                string moduleId = Request.QueryString[&quot;context&quot;];

                int itemId = -1;
                if (!string.IsNullOrEmpty(Request[&quot;ItemID&quot;]))
                {
                    int.TryParse(Request[&quot;ItemID&quot;], out itemId);
                }

                int parentId = -1;
                if (!string.IsNullOrEmpty(Request[&quot;ParentId&quot;]))
                {
                    int.TryParse(Request[&quot;ParentId&quot;], out parentId);
                }

                return ChecklistManager.Instance.GetProjectIDOfItem(moduleId, parentId, itemId);
            }
        }

        private void AssignInstanceID(string moduleID)
        {
            ChecklistModel checklistModel = ChecklistModel.GetInstance(Request, Response);
            InstanceID = checklistModel.GetInstanceID();
            //AssignInstanceID() has been removed as GetInstanceID() is doing the same function.
        }

        private void LoadChecklistDetails(string moduleID, int parentInstanceID, int checklistID)
        {
            DataSet dsChecklistDetails = ChecklistManager.Instance.GetChecklist(moduleID, parentInstanceID, checklistID);

            // Loading the stages and activities
            uwgStagesandActivities.DataSource = dsChecklistDetails.Tables[1].ToMWDateTime();
            uwgStagesandActivities.DataBind();

            FormatGrid();

            // Loading the checklist details
            DataRow dr = dsChecklistDetails.Tables[0].Rows[0];
            txtName.Text = dr[COL_CHECKLISTNAME].ToString2();
            txtDescription.Text = dr[COL_CHECKLISTDESCRIPTION].ToString2();
            wdcStartDate.Value = dr[COL_CHECKLISTSTARTDATE].ToMWDateTime();
            wdcEndDate.Value = dr[COL_CHECKLISTENDDATE].ToMWDateTime();

            // Loading the stages associated with the checklist
            ddlStage.DataSource = dsChecklistDetails.Tables[2];
            ddlStage.DataTextField = COL_STAGENAME;
            ddlStage.DataValueField = COL_STAGEID;
            ddlStage.DataBind();

            // Adds a entry called &quot;Select One&quot; to the dropdown
            BindStages();
        }

        private string ModuleSpecificQueryString(string moduleID)
        {
            string queryString = String.Empty;
            switch (moduleID)
            {
                case Constants.MODID_ESTMATE:
                case Constants.MODID_CONTMGT:
                case &quot;WORKORD&quot;:
                    queryString = &quot;&amp;ParentID=&quot; + InstanceID.ToString2();
                    break;
                case Constants.MODID_LANDMGT:
                    queryString = &quot;&amp;ParentID=&quot; + InstanceID.ToString2();
                    queryString += (EnterpriseLM.Length &gt; 0) ? (&quot;&amp;ENTPRSE_LM=&quot; + EnterpriseLM) : String.Empty;
                    queryString += &quot;&amp;tab=PD_TabDetails&quot;;
                    queryString += (LMID &gt; 0) ? &quot;&amp;LMID=&quot; + LMID.ToString2() : String.Empty;
                    break;
            }

            return queryString;
        }

        private void ShowDiv(ChecklistEnums divToDisplay)
        {
            divChecklistCreation.Visible = (ChecklistEnums.ChecklistCreation == divToDisplay);
            //divChecklistPicker.Visible = (ChecklistEnums.ChecklistPicker == divToDisplay);
            divGenericPicker.Visible = (ChecklistEnums.ChecklistPicker == divToDisplay) ||
                                       (ChecklistEnums.ActivityPicker == divToDisplay) ||
                                       (ChecklistEnums.StagePicker == divToDisplay);

            if (divGenericPicker.Visible)
                MainToolBar.Visible = false;
            else
                MainToolBar.Visible = true;
        }

        private void LoadUsers()
        {
            Dictionary&lt;int, string&gt; users =
                ProjectBL.ProjectManager.Instance.GetProjectUserDetails(
                    Request.QueryString[Constants.QRY_PROJECTID].ToInt32_2());
            ddlActivityOwner.DataSource = users;
            ddlActivityOwner.DataTextField = &quot;Value&quot;;
            ddlActivityOwner.DataValueField = &quot;Key&quot;;
            ddlActivityOwner.DataBind();
        }

        #endregion

        #region &quot;Permission Check&quot;

        public override bool CheckAccess()
        {
            if (Request[&quot;PID&quot;] != null &amp;&amp; Request[&quot;PID&quot;].ToString2().ToInt32_2() &gt; 0 &amp;&amp;
                Request[&quot;Context&quot;] == Constants.MODID_LANDMGT)
            {
                strPermList = ModuleManager.Instance.GetPermissionByUserOrRole(&quot;CHKLANL&quot;,
                    UserDetail.GetCurrentUserDetail().UID,
                    UserDetail.GetCurrentUserDetail().RID, PID);
                //strPermList = ModuleManager.Instance.GetPermissionByRole(Constants.MODID_LANDMGT,
                //                                                         UserDetail.GetCurrentUserDetail().RID);
            }
            else
            {
                string strModID = string.Empty;
                if (null != Request[&quot;Context&quot;])
                    strModID = Request[&quot;Context&quot;];
                else
                    strModID = string.Empty;

                if (strModID == &quot;PROJECT&quot;)
                    strModID = &quot;CHKPRJL&quot;;
                else if (strModID == &quot;CONTMGT&quot;)
                    strModID = &quot;CHKCONL&quot;;
                else if (strModID == &quot;ESTMATE&quot;)
                    strModID = &quot;CHKESTL&quot;;
                else
                    strModID = string.Empty;

                strPermList = ModuleManager.Instance.GetPermissionByUserOrRole(strModID,
                    UserDetail.GetCurrentUserDetail().UID,
                    UserDetail.GetCurrentUserDetail().RID, PID);

                if (string.IsNullOrEmpty(strModID))
                    strPermList = (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS];
            }

            if (!strPermList.Contains(AMP3.Common.Constants.MODFEAT_VISIBILITY))
                return false;

           return Request[&quot;Mode&quot;].ToString2() == &quot;N&quot;? strPermList.Contains(&quot;Checklist Create&quot;)
                       : strPermList.Contains(&quot;Checklist Edit&quot;);
        }

        #endregion

        #region &quot;Grid Formatting&quot;

        protected void uwgStagesandActivities_InitializeGroupByRow(object sender, RowEventArgs e)
        {
            e.Row.Expanded = true;

            try
            {
                if (((GroupByRow)e.Row).Column.ToString2().Equals(&quot;StageName&quot;))
                {
                    ((GroupByRow)e.Row).Text = ((GroupByRow)e.Row).Value + &quot;( &quot;
                                               + e.Row.Rows.Count.ToString2() + &quot; (Activity/Activities))&quot;;
                }
            }
            catch
            {
                (e.Row).ShowExpand = false;
            }
        }

        protected void uwgStagesandActivities_InitializeRow(object sender, RowEventArgs e)
        {
            e.Row.Cells.FromKey(&quot;Notes&quot;).Style.BackColor = Color.Yellow;
        }

        #endregion

        #region &quot;Properties&quot;

        private string ModuleID { get; set; }
        private int PID { get; set; }
        private string Mode { get; set; }
        private int InstanceID { get; set; }
        private int ChecklistID { get; set; }
        private string EnterpriseLM { get; set; }
        private int LMID { get; set; }

        List&lt;string&gt; _CHKPRJLComponents = null;

        private List&lt;string&gt; CHKPRJLComponents
        {
            get
            {
                if (_CHKPRJLComponents == null)
                    _CHKPRJLComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CHKPRJL);
                return _CHKPRJLComponents;
            }
        }

        #endregion

        #region &quot;Constants&quot;

        private const string COL_LINKINGID = &quot;LinkingID&quot;;
        private const string COL_CHECKLISTID = &quot;ChecklistID&quot;;
        private const string COL_CHECKLISTNAME = &quot;ChecklistName&quot;;
        private const string COL_CHECKLISTDESCRIPTION = &quot;ChecklistDescription&quot;;
        private const string COL_CHECKLISTSTARTDATE = &quot;ChecklistStartDate&quot;;
        private const string COL_CHECKLISTENDDATE = &quot;ChecklistEndDate&quot;;

        private const string COL_STAGEID = &quot;StageID&quot;;
        private const string COL_STAGENAME = &quot;StageName&quot;;
        private const string COL_ACTIVITYID = &quot;ActivityID&quot;;
        private const string COL_ACTIVITYNAME = &quot;ActivityName&quot;;
        private const string COL_NOTES = &quot;Notes&quot;;
        private const string COL_ATTACHMENTS = &quot;Attachments&quot;;
        private const string COL_ATTACHMENTID = &quot;AttachmentID&quot;;
        private const string COL_COMPLETED = &quot;Completed&quot;;
        private const string COL_ESCALTION = &quot;Escalation&quot;;
        private const string COL_STARTDATE = &quot;StartDate&quot;;
        private const string COL_ENDDATE = &quot;EndDate&quot;;
        private const string COL_COMPLETEDBY = &quot;CompletedBy&quot;;
        private const string COL_OWNERID = &quot;OwnerID&quot;;
        private const string COL_OWNERNAME = &quot;OwnerName&quot;;

        private const string TYPE_INT = &quot;System.Int32&quot;;
        private const string TYPE_STRING = &quot;System.String&quot;;
        private const string TYPE_BOOL = &quot;System.Boolean&quot;;
        private const string TYPE_DATE = &quot;System.DateTime&quot;;

        int TRADefaultOwnerNameModuleComponentsFlag = 0;

        #endregion

        #region &quot;Enum&quot;

        private enum ChecklistEnums
        {
            ChecklistCreation = 1,
            ChecklistPicker = 2,
            StagePicker = 3,
            ActivityPicker = 4
        }

        #endregion

        #region &quot;ToolBar Menu&quot;

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();

            AddSaveButton(menus);
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));

            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            if (HasSaveButton)
            {
                Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                if (null != lnkSave)
                {
                    lnkSave.Click += btnSave_Click;
                    lnkSave.OnClientClick = &quot;return ValidateSave();&quot;;
                }
            }

            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += btnCancel_Click;

            if (Request[&quot;PID&quot;] != null &amp;&amp; Request[&quot;PID&quot;].ToString2().ToInt32_2() &gt; 0 &amp;&amp;
                Request[&quot;Context&quot;] == Constants.MODID_LANDMGT)
            {
                //strPermList = ModuleManager.Instance.GetPermissionByRole(Constants.MODID_LANDMGT,
                //                                                         UserDetail.GetCurrentUserDetail().RID);
                strPermList = ModuleManager.Instance.GetPermissionByUserOrRole(&quot;CHKLANL&quot;,
                    UserDetail.GetCurrentUserDetail().UID,
                    UserDetail.GetCurrentUserDetail().RID, PID);
            }
            else
            {
                string strModID = string.Empty;
                if (null != Request[&quot;Context&quot;])
                    strModID = Request[&quot;Context&quot;];
                else
                    strModID = string.Empty;

                if (strModID == &quot;PROJECT&quot;)
                    strModID = &quot;CHKPRJL&quot;;
                else if (strModID == &quot;CONTMGT&quot;)
                    strModID = &quot;CHKCONL&quot;;
                else if (strModID == &quot;ESTMATE&quot;)
                    strModID = &quot;CHKESTL&quot;;
                else
                    strModID = string.Empty;

                strPermList = ModuleManager.Instance.GetPermissionByUserOrRole(strModID,
                    UserDetail.GetCurrentUserDetail().UID,
                    UserDetail.GetCurrentUserDetail().RID, PID);
                if (string.IsNullOrEmpty(strModID))
                    strPermList = (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS];
            }

            if (HasSaveButton)
            {
                Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                if (null != lnkSave)
                {
                    lnkSave.Enabled = (Request[&quot;Mode&quot;].ToString2() == &quot;N&quot;)
                        ? strPermList.Contains(&quot;Checklist Create&quot;)
                        : strPermList.Contains(&quot;Checklist Edit&quot;);
                }
            }

            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Enabled = (Request[&quot;Mode&quot;].ToString2() == &quot;N&quot;)
                ? strPermList.Contains(&quot;Checklist Create&quot;)
                : strPermList.Contains(&quot;Checklist Edit&quot;);
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,13,33,14,0],[34,17,36,28,0],[37,13,37,14,0],[45,17,45,18,0],[45,19,45,81,0],[45,82,45,83,0],[53,17,53,18,0],[53,19,53,77,0],[53,78,53,79,0],[57,9,57,10,0],[58,13,58,31,0],[59,13,59,97,0],[61,13,67,42,0],[69,13,69,31,0],[70,9,70,10,0],[73,9,73,10,0],[74,13,74,51,0],[75,13,75,71,0],[76,13,76,90,0],[78,13,78,44,0],[79,13,79,67,0],[80,13,80,76,0],[81,13,81,54,0],[82,13,82,48,0],[83,13,83,46,0],[84,13,84,59,0],[85,13,85,59,0],[87,13,87,34,0],[88,13,88,14,0],[89,17,89,65,0],[90,17,90,66,0],[93,17,93,76,0],[94,13,94,14,0],[96,13,96,28,0],[97,9,97,10,0],[100,9,100,10,0],[101,13,101,45,0],[103,13,103,43,0],[104,13,104,51,0],[105,13,105,38,0],[106,13,106,58,0],[108,13,108,43,0],[109,13,109,58,0],[110,13,110,45,0],[111,13,111,58,0],[113,13,113,28,0],[114,9,114,10,0],[117,9,117,10,0],[118,13,118,49,0],[120,13,120,42,0],[123,13,123,43,0],[124,13,124,36,0],[125,13,125,46,0],[126,13,126,113,0],[127,13,129,53,0],[130,13,130,92,0],[132,13,132,40,0],[134,13,134,34,0],[135,13,135,14,0],[136,17,136,33,0],[138,17,138,28,0],[140,17,140,29,0],[142,17,142,33,0],[143,17,143,18,0],[144,21,144,34,0],[145,17,145,18,0],[146,22,146,38,0],[147,17,147,18,0],[148,21,148,77,0],[149,17,149,18,0],[150,13,150,14,0],[153,13,153,54,0],[154,13,154,14,0],[155,17,155,73,0],[156,17,156,66,0],[159,25,159,66,0],[160,25,160,31,0],[162,25,162,62,0],[163,25,163,31,0],[165,17,165,61,0],[166,17,166,67,0],[168,17,172,47,0],[173,17,177,47,0],[180,17,180,76,0],[181,13,181,14,0],[183,13,183,34,0],[184,13,184,14,0],[185,17,185,50,0],[186,17,186,44,0],[187,21,187,49,0],[189,21,189,50,0],[190,13,190,14,0],[192,13,192,14,0],[193,17,193,83,0],[194,17,194,18,0],[195,21,195,48,0],[196,25,196,53,0],[198,25,198,54,0],[199,17,199,18,0],[201,17,201,18,0],[202,21,202,73,0],[203,17,203,18,0],[204,13,204,14,0],[205,9,205,10,0],[210,9,210,10,0],[211,13,211,29,0],[212,13,212,64,0],[215,13,215,108,0],[218,13,218,79,0],[219,13,219,78,0],[220,13,220,92,0],[223,13,223,62,0],[224,13,224,71,0],[227,13,227,34,0],[228,13,228,37,0],[229,13,229,29,0],[230,13,230,20,0],[230,22,230,33,0],[230,34,230,36,0],[230,37,230,63,0],[231,13,231,14,0],[232,17,232,65,0],[233,21,233,68,0],[234,13,234,14,0],[236,13,236,20,0],[236,22,236,33,0],[236,34,236,36,0],[236,37,236,63,0],[237,13,237,14,0],[238,17,238,71,0],[239,21,239,74,0],[240,13,240,14,0],[242,13,242,37,0],[243,13,243,41,0],[245,13,245,20,0],[245,22,245,32,0],[245,33,245,35,0],[245,36,245,69,0],[246,13,246,14,0],[247,17,247,58,0],[248,17,248,18,0],[249,21,249,100,0],[250,21,250,66,0],[252,21,252,43,0],[253,25,253,70,0],[255,21,256,87,0],[258,21,258,66,0],[259,17,259,18,0],[261,17,261,58,0],[262,17,262,18,0],[263,21,263,71,0],[265,21,265,84,0],[266,21,266,65,0],[267,21,267,63,0],[268,21,268,71,0],[269,21,269,69,0],[270,21,270,77,0],[271,21,273,57,0],[274,21,276,57,0],[277,21,277,53,0],[278,21,278,53,0],[279,21,279,69,0],[281,21,281,62,0],[282,21,282,59,0],[286,21,286,84,0],[287,21,287,57,0],[288,21,288,33,0],[289,17,289,18,0],[290,13,290,14,0],[292,13,292,55,0],[293,17,293,95,0],[295,13,295,71,0],[296,13,296,47,0],[298,13,298,26,0],[301,13,301,37,0],[302,13,302,20,0],[302,22,302,37,0],[302,38,302,40,0],[302,41,302,67,0],[303,13,303,14,0],[304,17,304,89,0],[306,17,306,37,0],[307,17,307,18,0],[308,21,308,124,0],[309,17,309,18,0],[310,17,310,32,0],[311,13,311,14,0],[312,9,312,10,0],[316,9,316,10,0],[317,13,317,29,0],[319,13,319,55,0],[320,9,320,10,0],[323,9,323,10,0],[324,13,324,53,0],[325,13,325,44,0],[326,13,326,56,0],[327,13,327,62,0],[329,13,329,65,0],[332,13,332,72,0],[333,13,333,69,0],[334,13,334,57,0],[335,13,335,63,0],[338,13,338,94,0],[339,13,339,92,0],[340,13,340,101,0],[341,13,341,93,0],[342,13,342,96,0],[343,13,343,92,0],[344,13,344,97,0],[345,13,345,91,0],[348,13,348,72,0],[349,9,349,10,0],[353,9,353,10,0],[354,13,354,55,0],[355,17,355,95,0],[357,13,357,109,0],[358,13,358,14,0],[359,17,359,107,0],[360,17,360,94,0],[361,17,361,24,0],[364,13,364,62,0],[366,13,366,71,0],[368,13,368,34,0],[369,13,369,37,0],[370,13,370,40,0],[371,13,371,14,0],[373,17,374,121,0],[375,17,375,18,0],[376,21,376,84,0],[377,21,377,34,0],[378,21,378,89,0],[379,21,379,28,0],[384,17,386,120,0],[387,17,387,18,0],[388,21,388,94,0],[389,21,389,34,0],[390,21,390,28,0],[393,17,393,61,0],[395,17,395,24,0],[395,26,395,37,0],[395,38,395,40,0],[395,41,395,67,0],[396,17,396,18,0],[397,21,397,69,0],[398,25,398,72,0],[399,17,399,18,0],[401,17,401,24,0],[401,26,401,37,0],[401,38,401,40,0],[401,41,401,67,0],[402,17,402,18,0],[403,21,403,75,0],[404,25,404,78,0],[405,17,405,18,0],[407,17,407,105,0],[408,17,408,103,0],[409,17,409,65,0],[410,17,410,98,0],[411,17,411,53,0],[412,17,412,67,0],[413,17,417,53,0],[418,17,422,53,0],[423,17,423,88,0],[424,17,424,87,0],[425,17,425,83,0],[426,17,426,103,0],[427,17,427,108,0],[429,17,429,52,0],[431,17,431,38,0],[432,17,432,18,0],[433,21,433,96,0],[434,21,434,41,0],[435,17,435,18,0],[436,13,436,14,0],[437,18,437,85,0],[438,13,438,14,0],[439,17,440,109,0],[442,22,442,31,0],[442,33,442,52,0],[442,54,442,57,0],[443,21,443,66,0],[445,17,445,55,0],[447,17,447,73,0],[449,17,449,43,0],[450,13,450,14,0],[451,18,451,88,0],[452,13,452,14,0],[454,17,454,109,0],[455,17,455,18,0],[456,21,456,84,0],[457,21,457,34,0],[458,21,458,89,0],[459,21,459,28,0],[464,17,465,108,0],[466,17,466,18,0],[467,21,467,94,0],[468,21,468,34,0],[469,21,469,28,0],[472,17,474,90,0],[476,17,476,69,0],[477,17,479,53,0],[480,17,482,53,0],[483,17,483,71,0],[484,17,484,72,0],[485,17,485,60,0],[486,17,486,91,0],[487,17,487,85,0],[488,17,488,55,0],[489,13,489,14,0],[491,13,491,71,0],[492,13,492,47,0],[494,13,494,80,0],[496,13,496,26,0],[497,9,497,10,0],[500,9,500,10,0],[501,13,501,55,0],[502,17,502,95,0],[504,13,504,62,0],[506,13,506,71,0],[508,13,508,47,0],[510,13,510,35,0],[513,21,513,94,0],[514,21,514,27,0],[516,21,517,114,0],[519,21,519,50,0],[520,21,520,22,0],[521,25,521,82,0],[522,25,522,102,0],[523,25,523,32,0],[525,21,526,76,0],[527,21,527,27,0],[530,13,530,70,0],[532,13,532,20,0],[532,22,532,33,0],[532,34,532,36,0],[532,37,532,39,0],[533,13,533,14,0],[534,17,534,42,0],[535,21,535,101,0],[536,17,536,56,0],[537,13,537,14,0],[539,13,539,55,0],[540,17,540,46,0],[542,13,542,71,0],[543,13,543,47,0],[545,13,545,26,0],[546,9,546,10,0],[549,9,549,10,0],[550,13,554,72,0],[555,13,559,82,0],[560,9,560,10,0],[564,9,564,10,0],[566,13,566,101,0],[567,13,567,14,0],[568,17,568,76,0],[569,17,569,24,0],[572,13,572,51,0],[574,13,574,62,0],[575,13,575,71,0],[580,13,580,20,0],[580,22,580,32,0],[580,33,580,35,0],[580,36,580,66,0],[581,13,581,14,0],[582,17,583,117,0],[584,17,584,18,0],[585,21,585,94,0],[586,21,586,28,0],[588,13,588,14,0],[590,13,590,63,0],[591,13,591,195,0],[593,13,593,52,0],[594,13,594,55,0],[595,13,595,69,0],[596,13,596,84,0],[597,13,597,80,0],[598,13,598,46,0],[599,13,599,56,0],[600,13,600,72,0],[601,13,601,38,0],[602,13,602,67,0],[603,13,605,83,0],[608,13,608,76,0],[609,13,613,72,0],[614,13,618,70,0],[619,9,619,10,0],[622,9,622,10,0],[623,13,623,34,0],[624,13,624,14,0],[625,17,625,53,0],[626,17,626,56,0],[628,17,628,72,0],[629,17,629,77,0],[630,17,630,76,0],[631,17,631,74,0],[632,17,632,76,0],[633,17,633,72,0],[634,17,634,78,0],[635,17,635,72,0],[638,17,638,66,0],[641,17,641,76,0],[642,17,642,73,0],[643,17,643,61,0],[644,17,644,58,0],[645,17,645,67,0],[647,17,647,96,0],[648,17,648,97,0],[649,17,649,105,0],[650,17,650,100,0],[651,17,651,95,0],[652,17,652,101,0],[655,17,655,73,0],[656,17,656,45,0],[657,17,657,63,0],[658,13,658,14,0],[659,18,659,42,0],[660,13,660,14,0],[661,17,661,56,0],[662,17,662,59,0],[664,17,664,70,0],[667,17,667,76,0],[668,17,668,73,0],[669,17,669,61,0],[670,17,670,54,0],[671,17,671,67,0],[673,17,673,99,0],[674,17,674,97,0],[675,17,675,105,0],[676,17,676,98,0],[677,17,677,96,0],[679,17,679,98,0],[680,17,680,101,0],[681,17,681,95,0],[682,17,682,96,0],[683,17,683,107,0],[684,17,684,100,0],[685,17,685,100,0],[687,17,687,77,0],[689,17,689,77,0],[690,17,690,82,0],[691,17,691,81,0],[692,17,692,79,0],[693,17,693,81,0],[694,17,694,77,0],[695,17,695,78,0],[696,17,696,77,0],[698,17,698,49,0],[699,17,699,67,0],[700,13,700,14,0],[701,9,701,10,0],[704,9,704,10,0],[705,13,705,46,0],[706,13,706,35,0],[707,13,707,29,0],[708,13,708,55,0],[709,9,709,10,0],[712,9,712,10,0],[713,13,713,35,0],[715,13,715,56,0],[717,13,717,70,0],[718,13,718,14,0],[719,17,719,33,0],[720,17,720,97,0],[723,17,723,112,0],[726,17,726,83,0],[727,17,727,82,0],[728,17,728,96,0],[731,17,731,66,0],[732,17,732,75,0],[735,17,735,38,0],[736,17,736,41,0],[737,17,737,33,0],[738,17,738,24,0],[738,26,738,37,0],[738,38,738,40,0],[738,41,738,67,0],[739,17,739,18,0],[740,21,740,69,0],[741,25,741,72,0],[742,17,742,18,0],[744,17,744,24,0],[744,26,744,37,0],[744,38,744,40,0],[744,41,744,67,0],[745,17,745,18,0],[746,21,746,75,0],[747,25,747,78,0],[748,17,748,18,0],[750,17,750,41,0],[751,17,751,45,0],[753,17,753,24,0],[753,26,753,36,0],[753,37,753,39,0],[753,40,753,73,0],[754,17,754,18,0],[755,21,755,62,0],[756,21,756,22,0],[757,25,757,104,0],[758,25,758,70,0],[760,25,760,47,0],[761,29,761,74,0],[763,25,764,116,0],[766,25,766,70,0],[767,21,767,22,0],[769,21,769,62,0],[770,21,770,22,0],[771,25,771,75,0],[773,25,773,88,0],[774,25,774,69,0],[775,25,775,67,0],[776,25,776,75,0],[777,25,777,73,0],[778,25,778,81,0],[779,25,781,61,0],[782,25,784,61,0],[785,25,785,57,0],[786,25,786,57,0],[787,25,787,73,0],[789,25,789,66,0],[790,25,790,63,0],[792,25,792,88,0],[793,25,793,61,0],[794,25,794,37,0],[795,21,795,22,0],[796,17,796,18,0],[798,17,798,59,0],[799,21,799,99,0],[801,17,801,68,0],[802,17,802,18,0],[803,21,803,82,0],[805,21,805,28,0],[805,30,805,39,0],[805,40,805,42,0],[805,43,805,69,0],[806,21,806,22,0],[807,25,807,51,0],[808,21,808,22,0],[809,17,809,18,0],[813,17,815,28,0],[816,17,816,51,0],[818,17,818,30,0],[821,17,821,41,0],[822,17,822,24,0],[822,26,822,41,0],[822,42,822,44,0],[822,45,822,71,0],[823,17,823,18,0],[824,21,824,93,0],[826,21,826,41,0],[827,21,827,22,0],[828,25,829,64,0],[830,21,830,22,0],[831,21,831,36,0],[832,17,832,18,0],[833,13,833,14,0],[834,18,834,39,0],[835,13,835,14,0],[836,17,836,33,0],[837,17,837,78,0],[841,13,841,14,0],[842,18,842,42,0],[843,13,843,14,0],[844,17,844,33,0],[845,17,845,78,0],[846,17,846,77,0],[847,13,847,14,0],[849,13,849,55,0],[850,9,850,10,0],[853,9,853,10,0],[854,13,854,54,0],[855,13,855,14,0],[856,17,856,73,0],[857,17,857,18,0],[858,21,858,89,0],[859,17,859,18,0],[860,22,860,81,0],[861,17,861,18,0],[862,21,862,89,0],[863,17,863,18,0],[865,17,865,53,0],[866,13,866,14,0],[867,9,867,10,0],[871,9,871,10,0],[873,13,873,62,0],[874,13,874,14,0],[875,17,875,98,0],[876,17,876,96,0],[877,17,877,105,0],[878,17,878,97,0],[879,17,879,100,0],[880,17,880,96,0],[881,17,881,101,0],[882,17,882,94,0],[883,17,883,95,0],[884,13,884,14,0],[886,18,886,64,0],[887,13,887,14,0],[888,17,888,96,0],[889,17,889,97,0],[890,17,890,105,0],[891,17,891,100,0],[892,17,892,95,0],[893,17,893,101,0],[894,17,894,94,0],[895,13,895,14,0],[897,18,897,68,0],[898,13,898,14,0],[899,17,899,99,0],[900,17,900,97,0],[901,17,901,105,0],[902,17,902,98,0],[903,17,903,96,0],[905,17,905,98,0],[906,17,906,101,0],[907,17,907,95,0],[908,17,908,96,0],[909,17,909,107,0],[910,17,910,100,0],[911,17,911,95,0],[912,17,912,94,0],[913,17,913,100,0],[914,13,914,14,0],[915,9,915,10,0],[922,9,922,10,0],[923,13,923,76,0],[924,13,924,46,0],[925,9,925,10,0],[928,9,928,10,0],[929,13,929,71,0],[930,9,930,10,0],[933,9,933,10,0],[934,13,934,36,0],[935,13,935,14,0],[936,17,936,89,0],[937,17,937,71,0],[938,13,938,14,0],[939,18,939,41,0],[940,13,940,14,0],[941,17,941,58,0],[942,17,942,63,0],[943,13,943,14,0],[945,13,947,61,0],[948,9,948,10,0],[951,9,951,10,0],[952,13,952,52,0],[954,13,954,69,0],[955,13,955,74,0],[956,13,956,72,0],[957,13,957,77,0],[958,13,958,76,0],[959,13,959,77,0],[960,13,960,74,0],[961,13,961,72,0],[962,13,962,72,0],[963,13,963,72,0],[964,13,964,70,0],[965,13,965,69,0],[966,13,966,74,0],[968,13,968,27,0],[969,9,969,10,0],[972,9,972,10,0],[974,13,974,55,0],[975,13,975,14,0],[976,17,976,107,0],[978,17,978,47,0],[979,17,979,18,0],[980,21,980,71,0],[982,21,982,39,0],[983,21,983,97,0],[984,21,984,77,0],[985,21,987,29,0],[988,21,990,40,0],[991,21,993,40,0],[994,21,996,33,0],[997,21,997,60,0],[998,21,1000,40,0],[1002,21,1002,91,0],[1003,25,1006,111,0],[1008,25,1014,61,0],[1016,21,1016,89,0],[1017,25,1020,111,0],[1022,25,1028,61,0],[1029,21,1031,33,0],[1033,21,1035,31,0],[1037,21,1039,40,0],[1041,21,1041,38,0],[1042,17,1042,18,0],[1043,13,1043,14,0],[1044,9,1044,10,0],[1047,9,1047,10,0],[1048,13,1048,36,0],[1049,13,1049,41,0],[1050,13,1050,33,0],[1052,13,1052,37,0],[1053,13,1053,14,0],[1054,17,1054,89,0],[1055,13,1055,14,0],[1057,13,1057,14,0],[1058,17,1059,92,0],[1060,13,1060,14,0],[1062,13,1062,55,0],[1063,13,1063,14,0],[1064,17,1064,51,0],[1066,17,1066,60,0],[1068,17,1068,43,0],[1070,17,1070,61,0],[1071,17,1071,18,0],[1072,21,1072,38,0],[1073,17,1073,18,0],[1074,17,1074,62,0],[1075,17,1075,18,0],[1076,21,1076,38,0],[1077,17,1077,18,0],[1078,13,1078,14,0],[1080,13,1080,30,0],[1081,9,1081,10,0],[1084,9,1084,10,0],[1085,13,1085,55,0],[1086,13,1086,14,0],[1087,17,1087,92,0],[1088,17,1088,73,0],[1090,17,1093,73,0],[1095,17,1095,72,0],[1096,17,1096,65,0],[1097,17,1097,69,0],[1098,17,1099,70,0],[1100,17,1100,69,0],[1102,17,1102,84,0],[1103,17,1103,81,0],[1104,17,1104,75,0],[1105,17,1105,71,0],[1107,17,1107,70,0],[1108,17,1108,57,0],[1110,17,1110,50,0],[1111,17,1111,18,0],[1112,21,1112,74,0],[1113,21,1113,83,0],[1114,21,1114,76,0],[1115,17,1115,18,0],[1117,17,1119,38,0],[1120,17,1121,75,0],[1123,17,1124,101,0],[1126,17,1126,68,0],[1128,17,1128,73,0],[1129,17,1129,70,0],[1130,17,1130,66,0],[1131,17,1131,70,0],[1132,13,1132,14,0],[1133,9,1133,10,0],[1136,9,1136,10,0],[1137,13,1140,66,0],[1141,17,1141,58,0],[1143,13,1143,14,0],[1144,17,1144,66,0],[1146,17,1146,33,0],[1147,17,1147,62,0],[1148,17,1148,18,0],[1149,21,1149,65,0],[1150,17,1150,18,0],[1152,17,1152,35,0],[1153,17,1153,64,0],[1154,17,1154,18,0],[1155,21,1155,69,0],[1156,17,1156,18,0],[1158,17,1158,97,0],[1160,9,1160,10,0],[1163,9,1163,10,0],[1164,13,1164,91,0],[1165,13,1165,57,0],[1167,9,1167,10,0],[1170,9,1170,10,0],[1171,13,1171,122,0],[1174,13,1174,93,0],[1175,13,1175,47,0],[1177,13,1177,26,0],[1180,13,1180,63,0],[1181,13,1181,62,0],[1182,13,1182,76,0],[1183,13,1183,76,0],[1184,13,1184,72,0],[1187,13,1187,64,0],[1188,13,1188,52,0],[1189,13,1189,51,0],[1190,13,1190,33,0],[1193,13,1193,26,0],[1194,9,1194,10,0],[1197,9,1197,10,0],[1198,13,1198,47,0],[1199,13,1199,30,0],[1204,21,1204,73,0],[1205,21,1205,27,0],[1207,21,1207,73,0],[1208,21,1208,111,0],[1209,21,1209,57,0],[1210,21,1210,92,0],[1211,21,1211,27,0],[1214,13,1214,32,0],[1215,9,1215,10,0],[1218,9,1218,10,0],[1219,13,1219,95,0],[1221,13,1223,85,0],[1225,13,1225,42,0],[1226,17,1226,45,0],[1228,17,1228,44,0],[1229,9,1229,10,0],[1232,9,1232,10,0],[1233,13,1235,79,0],[1236,13,1236,49,0],[1237,13,1237,54,0],[1238,13,1238,53,0],[1239,13,1239,41,0],[1240,9,1240,10,0],[1247,9,1247,10,0],[1248,13,1249,63,0],[1250,13,1250,14,0],[1251,17,1253,65,0],[1256,13,1256,14,0],[1258,13,1258,14,0],[1259,17,1259,48,0],[1260,17,1260,48,0],[1261,21,1261,51,0],[1263,21,1263,45,0],[1265,17,1265,43,0],[1266,21,1266,42,0],[1267,22,1267,48,0],[1268,21,1268,42,0],[1269,22,1269,48,0],[1270,21,1270,42,0],[1272,21,1272,45,0],[1274,17,1276,65,0],[1278,17,1278,52,0],[1279,21,1279,93,0],[1280,13,1280,14,0],[1282,13,1282,81,0],[1283,17,1283,30,0],[1285,12,1286,65,0],[1287,9,1287,10,0],[1294,9,1294,10,0],[1295,13,1295,35,0],[1298,13,1298,14,0],[1299,17,1299,80,0],[1300,17,1300,18,0],[1301,21,1302,107,0],[1303,17,1303,18,0],[1304,13,1304,14,0],[1305,13,1305,18,0],[1306,13,1306,14,0],[1307,17,1307,44,0],[1308,13,1308,14,0],[1309,9,1309,10,0],[1312,9,1312,10,0],[1313,13,1313,73,0],[1314,9,1314,10,0],[1320,35,1320,39,0],[1320,40,1320,44,0],[1321,27,1321,31,0],[1321,32,1321,36,0],[1322,31,1322,35,0],[1322,36,1322,40,0],[1323,34,1323,38,0],[1323,39,1323,43,0],[1324,35,1324,39,0],[1324,40,1324,44,0],[1325,39,1325,43,0],[1325,44,1325,48,0],[1326,28,1326,32,0],[1326,33,1326,37,0],[1328,9,1328,48,0],[1333,13,1333,14,0],[1334,17,1334,48,0],[1335,21,1335,111,0],[1336,17,1336,43,0],[1337,13,1337,14,0],[1371,9,1371,57,0],[1390,9,1390,10,0],[1391,13,1391,41,0],[1393,13,1393,34,0],[1394,13,1394,82,0],[1396,13,1396,44,0],[1397,9,1397,10,0],[1400,9,1400,10,0],[1401,13,1401,31,0],[1402,13,1402,14,0],[1403,17,1403,78,0],[1404,17,1404,37,0],[1405,17,1405,18,0],[1406,21,1406,52,0],[1407,21,1407,70,0],[1408,17,1408,18,0],[1409,13,1409,14,0],[1411,13,1411,80,0],[1413,13,1414,63,0],[1415,13,1415,14,0],[1418,17,1420,65,0],[1421,13,1421,14,0],[1423,13,1423,14,0],[1424,17,1424,48,0],[1425,17,1425,48,0],[1426,21,1426,51,0],[1428,21,1428,45,0],[1430,17,1430,43,0],[1431,21,1431,42,0],[1432,22,1432,48,0],[1433,21,1433,42,0],[1434,22,1434,48,0],[1435,21,1435,42,0],[1437,21,1437,45,0],[1439,17,1441,65,0],[1442,17,1442,52,0],[1443,21,1443,93,0],[1444,13,1444,14,0],[1446,13,1446,31,0],[1447,13,1447,14,0],[1448,17,1448,78,0],[1449,17,1449,37,0],[1450,17,1450,18,0],[1451,21,1453,66,0],[1454,17,1454,18,0],[1455,13,1455,14,0],[1457,13,1459,58,0],[1460,9,1460,10,0]]);
    </script>
  </body>
</html>