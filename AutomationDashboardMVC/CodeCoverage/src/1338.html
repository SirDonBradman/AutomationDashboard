<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Common\BrixItemListReportPage.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Text;
using System.Web.Script.Serialization;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UI;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebNavigator;

namespace Aurigo.AMP3.Core
{
    public partial class BrixItemListReportPage : BrixPageBase
    {
        #region &quot;Class Variables&quot;

        public static int pageno;
        private string approveDate = String.Empty;
        private string context;
        protected ItemListModel listModel;
        private FormStateMgmt pageState;

        #endregion

        #region &quot;Overriden Functions&quot;

        /// &lt;summary&gt;
        /// &lt;remarks&gt;
        ///  &lt;![CDATA[ Author : Lijo ]]&gt;
        /// This is a overrided function that is called before pageload.This creates all the controls dynamically.
        /// &lt;/remarks&gt;
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            EnsureChildControls();

            // Creates a new ControlCollection. 
            CreateControlCollection();

            CreateControls();

            InitHtmlData();

            InitSortAndFilter();

            CreateToolBarMenu(listModel.Menus, MainToolBar_MenuItemClick);

            if (!string.IsNullOrEmpty(Request[&quot;hdnFilterType&quot;]))
                ApplyFilter();
            else
                BindGridControl();

            // Prevent child controls from being created again.
            ChildControlsCreated = true;
        }

        private void lnkRateAnalysis_Click(object sender, EventArgs e)
        {
            if (!string.IsNullOrEmpty(hdnItemIDList.Value.Trim(&#39;,&#39;)))
            {
                string redirectUrl =
                    &quot;~/Common/BrixItemPage.aspx?Context={0}&amp;ItemID={1}&amp;ParentID={2}&amp;PID={3}&amp;DisplayType=RA&amp;Mode={4}&quot;.
                        Format2(listModel.ModuleId, hdnItemIDList.Value.Trim(&#39;,&#39;).Parse2(), listModel.ParentID,
                            Request[&quot;PID&quot;], (int)ModeTypes.Edit);
                if (!string.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                    redirectUrl = &quot;{0}&amp;ContractID={1}&quot;.Format2(redirectUrl, Request[&quot;ContractID&quot;]);
                if (hdnReferenceItemType.Value.Equals(&quot;M&quot;)
                    &amp;&amp; (listModel.ModuleId.Equals(&quot;CHNGORD&quot;) || listModel.ModuleId.Equals(&quot;BDGTREV&quot;)))
                {
                    redirectUrl = &quot;{0}&amp;COType=M&quot;.Format2(redirectUrl);
                }
                if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                    redirectUrl = &quot;{0}&amp;ProjectEstimateID={1}&quot;.Format2(redirectUrl, Request[&quot;ProjectEstimateID&quot;]);
                Response.Redirect(redirectUrl, true);
            }
        }

        private void lnkSubItems_Click(object sender, EventArgs e)
        {
            if (!string.IsNullOrEmpty(hdnItemIDList.Value.Trim(&#39;,&#39;)))
            {
                string redirectUrl =
                    &quot;~/Common/BrixItemPage.aspx?Context={0}&amp;ItemID={1}&amp;ParentID={2}&amp;PID={3}&amp;DisplayType=SI&amp;Mode={4}&quot;.
                        Format2(listModel.ModuleId, hdnItemIDList.Value.Trim(&#39;,&#39;).Parse2(), listModel.ParentID,
                            Request[&quot;PID&quot;], (int)ModeTypes.Edit);
                if (!string.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                    redirectUrl = &quot;{0}&amp;ContractID={1}&quot;.Format2(redirectUrl, Request[&quot;ContractID&quot;]);
                if (hdnReferenceItemType.Value.Equals(&quot;M&quot;)
                    &amp;&amp; (listModel.ModuleId.Equals(&quot;CHNGORD&quot;) || listModel.ModuleId.Equals(&quot;BDGTREV&quot;)))
                {
                    redirectUrl = &quot;{0}&amp;COType=M&quot;.Format2(redirectUrl);
                }
                if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                    redirectUrl = &quot;{0}&amp;ProjectEstimateID={1}&quot;.Format2(redirectUrl, Request[&quot;ProjectEstimateID&quot;]);
                Response.Redirect(redirectUrl, true);
            }
        }

        private void CreateControls()
        {
            SetMenuDetails();

            SetJScriptDetails();
        }

        protected override void OnPreInit(EventArgs e)
        {
            if (!IsPostBack)
                Session.Remove(&quot;ERRLOG&quot;);

            listModel = SetListModel();
            if (listModel == null)
            {
                //TODO: Display approrinate message
                UIHelper.RedirectURL(MessageResourceManager.GetString(&quot;E_USRMGMT_NO_PERMISSIONS_TO_VIEW_PAGE&quot;,
                    Enumerations.MessageType.ErrorMessage),
                    ResolveUrl(Constants.URL_ENTERPRISE), null, Context);

                return;
            }
            ((BrixReport)Master).ModuleId = listModel.ModuleId;
            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            PageTitle = listModel.Header;
            //ModalPopupExtender PopupExtender = (ModalPopupExtender)this.Master.FindControl(&quot;filterExtender&quot;);
            //PopupExtender.Visible = true;
            PopupExtender.AddNewPopup(aspPnlFilter.ClientID, lbFilter.ClientID, btnCancel.ClientID, 300, 400);
            base.OnInit(e);
        }

        #endregion

        #region &quot;Page Events&quot;

        private void SetJScriptDetails()
        {
            ClientScript.RegisterHiddenField(&quot;hdnFilterType&quot;, string.Empty);

            btnFilter.Attributes.Add(&quot;onclick&quot;,
                &quot;applyFilter(&#39;&quot; + btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; + lbFilter.ClientID + &quot;&#39;);&quot;);

            btnReset.Attributes.Add(&quot;onClick&quot;,
                &quot;return resetFilters(&#39;&quot; + btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; + lbFilter.ClientID +
                &quot;&#39;);&quot;);

            lbFilterClr.OnClientClick = &quot;return resetFilters(&#39;&quot; + btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; + lbFilter.ClientID +
                                        &quot;&#39;);&quot;;
        }

        private void BindGridControl()
        {
            try
            {
                int pagecount;

                DataSet ContractorDT = listModel.GetList(200,
                    UIHelper.GetSortOrder(pageState.SortKey, pageState.SortOrder),
                    pageState.FilterCriterion, ref pageno, out pagecount);

                HGrid.ContainerTable = ContractorDT.Tables[&quot;Container&quot;];
                HGrid.ItemTable = ContractorDT.Tables[&quot;Items&quot;];
                HGrid.ItemSummaryTable = ContractorDT.Tables[&quot;ItemSummary&quot;];

                HGrid.ContainerIDColumn = &quot;ContainerID&quot;;
                HGrid.ParentContainerIDColumn = &quot;ParentContainerID&quot;;
                HGrid.ContainerNameColumn = &quot;ContainerName&quot;;

                HGrid.ItemIDColumn = &quot;ItemID&quot;;
                HGrid.ItemNameColumn = &quot;StandardItemNo&quot;;
                HGrid.ItemContainerIDColumn = &quot;ContainerID&quot;;

                //HierarchicalGridColumn tempColumn = listModel
                HGrid.AmountColumn = listModel.AmountColumn;
                HGrid.ItemSummaryDetails = listModel.HGridItemSummaryDetails();

                if (Request.QueryString[&quot;Context&quot;] == &quot;CHNGORD&quot; || Request.QueryString[&quot;Context&quot;] == &quot;BDGTREV&quot;)
                    HGrid.IsReadOnly = true;
                else
                    HGrid.IsReadOnly = listModel.DisplayUnlock;
                HGrid.Columns = listModel.HGridColumns();
                HGrid.HdnReferenceItemTypeCID = hdnReferenceItemType.ClientID;

                if (listModel.DisplayDelete)
                    HGrid.LnkDeleteClientID = MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).ClientID;
                if (listModel.DisplayEdit)
                    HGrid.LnkEditClientID = MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).ClientID;
                if (listModel.DisplayNew)
                    HGrid.LnkNewClientID = MainToolBar.GetMenuReference(&quot;lnkNew&quot;).ClientID;
                if (listModel.DisplayView)
                    HGrid.LnkViewClientID = MainToolBar.GetMenuReference(&quot;lnkView&quot;).ClientID;
                if (listModel.DisplaySubItems)
                    HGrid.LnkSubItemsClientID = MainToolBar.GetMenuReference(&quot;lnkSubItems&quot;).ClientID;
                if (listModel.DisplayRateAnalysis)
                    HGrid.LnkRateAnalysisClientID = MainToolBar.GetMenuReference(&quot;lnkRateAnalysis&quot;).ClientID;

                HGrid.saveEditedItems += SaveEditedItems;
                HGrid.FetchActivities += listModel.FetchActivities;
                HGrid.FetchSubItems += listModel.FetchSubItems;
                HGrid.SaveControlSettings += HGrid_SaveControlSettings;
                HGrid.IsItemSummaryVisible = listModel.DisplayItemSummary;

                HGrid.Bind();

                pageState.MaintainState(pageState.PageIndex, pageState.SortKey, pageState.SortOrder,
                    pageState.FilterCriterion);
            }
            catch (Exception ex)
            {
                msg.Text = ex.ToString2();
            }
        }


        private void HGrid_SaveControlSettings(object sender, EventArgs e)
        {
            var ud = (UserDetail)Session[&quot;UserDetail&quot;];
            var CSA = (ControlSettingArgs)e;
            listModel.SaveHGridSettings(ud.UID, &quot;HGrid_&quot; + Request[&quot;Context&quot;], CSA.CustomSettings);
        }

        private void SaveEditedItems(object sender, ItemsArgs e)
        {
            var sb = new StringBuilder();
            sb.Append(&quot;&lt;Items&gt;&quot;);
            foreach (var dic in e.Items)
            {
                sb.Append(&quot;&lt;Item &quot;);
                foreach (var pair in dic)
                    sb.AppendFormat(&quot;{0}=\&quot;{1}\&quot; &quot;, UIHelper.ReplaceXMLCharEntities(pair.Key),
                        UIHelper.ReplaceXMLCharEntities(pair.Value));
                sb.Append(&quot;/&gt;&quot;);
            }
            sb.Append(&quot;&lt;/Items&gt;&quot;);

            string xmlArgument = sb.ToString2();
            try
            {
                HGrid.CallbackResult = listModel.UpdateItems(xmlArgument).ToString2();
            }
            catch (Exception)
            {
                HGrid.CallbackResult = &quot;0&quot;;
            }
            BindGridControl();
        }

        private void InitHtmlData()
        {
            msg.Text = &quot;&quot;;
            var myForm = (HtmlForm)Page.Master.FindControl(&quot;form1&quot;);
            myForm.Attributes.Add(&quot;onkeypress&quot;, &quot;javascript:CheckEnter()&quot;);
        }

        private void InitSortAndFilter()
        {
            if ((pageState = UIHelper.GetModuleFromStateBag(context, Context) as FormStateMgmt) == null)
                pageState = new FormStateMgmt(context, listModel.ParentID);

            if (!IsPostBack &amp;&amp; !string.IsNullOrEmpty(pageState.FilterCriterion) &amp;&amp;
                pageState.FilterCriterionType == StateManagementBase.FilterType.Xml)
                pageState.RestoreFilterState(aspPnlFilter, pageState.FilterCriterion);

            ClientScript.RegisterArrayDeclaration(&quot;FilterFields&quot;, listModel.GetFilterHtml(tblFilter));

            ClientScript.RegisterStartupScript(aspPnlFilter.GetType(), &quot;showHideFilterButtons&quot;,
                &quot;showHideFilterButtons(&#39;&quot; + lbFilter.ClientID + &quot;&#39;);&quot;, true);

            if (string.IsNullOrEmpty(Request[&quot;hdnFilterType&quot;]))
                pageState.FilterCriterion = null;
        }

        private ItemListModel SetListModel()
        {
            context = Request.QueryString[&quot;context&quot;] + (Request.QueryString[&quot;Type&quot;] ?? &quot;&quot;);
            ItemListModel listModel = ItemListModel.GetInstance(Request, Response,
                Session[Constants.EIS_ADDITIONAL_INFO] == null
                    ? string.Empty
                    : Session[Constants.EIS_ADDITIONAL_INFO].ToString2());

            columnInfo = listModel.ColumnInfo;
            return listModel;
        }

        private void SetMenuDetails()
        {
            lbFilter.Visible = listModel.DisplayApplyFilter;
            divTabs.Visible = listModel.DisplayTabs;
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            Session[&quot;expandAll&quot;] = Request[&quot;pdfB&quot;];
            Session[&quot;expandedContainers&quot;] = Request[&quot;pdfA&quot;];
        }

        #endregion

        #region &quot;Generic Events&quot;

        protected void lnkViewLog_Click(object sender, EventArgs e)
        {
            JavaScriptSerializer JS = new JavaScriptSerializer();
            try
            {
                string retMsg = listModel.HandleLogView(UltraWebGridExcelExporter1);
                if (!retMsg.Equals(String.Empty))
                {
                    retMsg = JS.Serialize(retMsg.Replace(&quot;|&quot;, &quot;\\n&quot;));
                    ClientScript.RegisterStartupScript(GetType(), &quot;Exception: &quot; + retMsg,
                        &quot;&lt;script&gt;ShowError(&quot; + retMsg + &quot;);&lt;/script&gt;&quot;);
                }
            }
            catch (Exception ex)
            {
                string errMessage = JS.Serialize(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;));
                ClientScript.RegisterStartupScript(GetType(), &quot;Exception: &quot; + errMessage,
                    &quot;&lt;script&gt;ShowError(&quot; + errMessage + &quot;);&lt;/script&gt;&quot;);
            }
        }

        protected void lnkUnlock_Click(object sender, EventArgs e)
        {
            try
            {
                if (listModel.HandleUnlock() == 0)
                {
                    HGrid.IsReadOnly = false;
                    SetMenuDetails();
                    BindGridControl();
                    listModel.DisplayUnlock = !(listModel.DisplayLock = true);
                    MainToolBar.CreateToolBar(listModel.Menus);
                    CustomizeToolBar();

                    listModel.CustomUnlock(MainToolBar);
                }
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                string errMessage = JS.Serialize(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;));
                ClientScript.RegisterStartupScript(GetType(), &quot;Exception: &quot; + errMessage,
                    &quot;&lt;script&gt;ShowError(&quot; + errMessage + &quot;);&lt;/script&gt;&quot;);
            }
        }

        protected void lnkLock_Click(object sender, EventArgs e)
        {
            try
            {
                if (listModel.HandleLock() == 0)
                {
                    HGrid.IsReadOnly = true;
                    SetMenuDetails();
                    BindGridControl();
                    listModel.DisplayUnlock = !(listModel.DisplayLock = false);
                    MainToolBar.CreateToolBar(listModel.Menus);
                    CustomizeToolBar();

                    listModel.CustomUnlock(MainToolBar);
                }
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                string errMessage = JS.Serialize(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;));
                ClientScript.RegisterStartupScript(GetType(), &quot;Exception: &quot; + errMessage,
                    &quot;&lt;script&gt;ShowError(&quot; + errMessage + &quot;);&lt;/script&gt;&quot;);
            }
        }

        protected void btnFilterGhost_Click(object sender, EventArgs e)
        {
            //ApplyFilter();
        }

        protected void lnkNew_Click(object sender, EventArgs e)
        {
            if ((sender as Aurigo.AMP3.Core.UserControls.Menu).Enabled == false)
                return;

            listModel.HandleNew(GetLastSelectedContainerID().Parse2());
        }

        private string GetLastSelectedContainerID()
        {
            string id = hdnContainerIDList.Value.Trim(&#39;,&#39;);

            if (!string.IsNullOrEmpty(id))
            {
                if (id.Contains(&quot;,&quot;))
                {
                    string[] ids = id.Split(&#39;,&#39;);
                    id = ids[ids.Length - 1];
                }
            }
            else
            {
                id = hdnItemIDList.Value.Trim(&#39;,&#39;);
                if (!string.IsNullOrEmpty(id))
                {
                    if (id.Contains(&quot;,&quot;))
                    {
                        string[] ids = id.Split(&#39;,&#39;);
                        id = ids[ids.Length - 1];
                    }
                    int? ContainerID =
                        ItemManager.Instance.GetItemDetails(listModel.ModuleId, listModel.ParentID, id.Parse2()).
                            ContainerID;
                    id = (ContainerID.HasValue) ? ContainerID.Value.ToString2() : &quot;0&quot;;
                }
                else
                    id = &quot;0&quot;;
            }
            return id;
        }

        protected void lnkEdit_Click(object sender, EventArgs e)
        {
            if ((sender as Aurigo.AMP3.Core.UserControls.Menu).Enabled == false)
                return;
            try
            {
                if (hdnItemIDList.Value.Trim(&#39;,&#39;).Equals(string.Empty))
                    listModel.HandleEdit(ItemTypes.Container, hdnContainerIDList.Value.Trim(&#39;,&#39;).Parse2());
                else
                    listModel.HandleEdit(ItemTypes.Item, hdnItemIDList.Value.Trim(&#39;,&#39;).Parse2());
            }
            catch (Exception ex)
            {
                lblError.Text = ex.Message;
            }
        }

        protected void lnkView_Click(object sender, EventArgs e)
        {
            if ((sender as Aurigo.AMP3.Core.UserControls.Menu).Enabled == false)
                return;
            if (hdnItemIDList.Value.Trim(&#39;,&#39;).Equals(string.Empty))
                listModel.HandleView(ItemTypes.Container, hdnContainerIDList.Value.Trim(&#39;,&#39;).Parse2());
            else
                listModel.HandleView(ItemTypes.Item, hdnItemIDList.Value.Trim(&#39;,&#39;).Parse2());
        }

        protected void lnkDelete_Click(object sender, EventArgs e)
        {
            try
            {
                if ((sender as Aurigo.AMP3.Core.UserControls.Menu).Enabled == false)
                    return;
                if (!hdnContainerIDList.Value.Trim(&#39;,&#39;).Equals(string.Empty))
                    listModel.HandleDelete(ItemTypes.Container, hdnContainerIDList.Value.Trim(&#39;,&#39;));
                if (!hdnItemIDList.Value.Trim(&#39;,&#39;).Equals(string.Empty))
                    listModel.HandleDelete(ItemTypes.Item, hdnItemIDList.Value.Trim(&#39;,&#39;));

                string redirectUrl = &quot;BrixItemListPage.aspx?Context={0}&amp;ParentID={1}&amp;PID={2}&quot;.Format2(
                    listModel.ModuleId, Request[&quot;ParentID&quot;], Request[&quot;PID&quot;]);
                if (Request[&quot;context&quot;] == &quot;CHNGORD&quot; || Request[&quot;context&quot;] == &quot;BDGTREV&quot;)
                {
                    Response.Redirect(Request.UrlReferrer.AbsoluteUri, true);
                }
                Response.Redirect(redirectUrl, true);
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                ClientScript.RegisterStartupScript(GetType(), &quot;Exception Occured&quot;,
                    &quot;&lt;script&gt;ShowError(&quot; + JS.Serialize(ex.Message) + &quot;);&lt;/script&gt;&quot;);
            }
        }

        protected void lnkApprove_Click(object sender, EventArgs e)
        {
            if ((sender as Aurigo.AMP3.Core.UserControls.Menu).Enabled == false)
                return;
            listModel.HandleApprove();

            string redirectUrl = &quot;BrixItemListPage.aspx?Context={0}&amp;ParentID={1}&amp;PID={2}&quot;.Format2(listModel.ModuleId,
                Request[&quot;ParentID&quot;],
                Request[&quot;PID&quot;]);
            Response.Redirect(redirectUrl, true);
        }

        protected void lnkUnApprove_Click(object sender, EventArgs e)
        {
            if ((sender as Aurigo.AMP3.Core.UserControls.Menu).Enabled == false)
                return;

            listModel.HandleUnApprove();

            string redirectUrl = &quot;BrixItemListPage.aspx?Context={0}&amp;ParentID={1}&amp;PID={2}&quot;.Format2(listModel.ModuleId,
                Request[&quot;ParentID&quot;],
                Request[&quot;PID&quot;]);
            Response.Redirect(redirectUrl, true);
        }

        #endregion

        #region &quot;Custom functions&quot;

        protected void ApplyFilter()
        {
            pageState.FilterCriterion = listModel.GetFilterXML(
                tblFilter.UniqueID.Remove(tblFilter.UniqueID.Length - 9), Request);
            BindGridControl();
        }

        protected override void CustomizeToolBar()
        {
            if (listModel.DisplayUnApprove) MainToolBar.GetMenuReference(&quot;lnkUnApprove&quot;).Click += lnkUnApprove_Click;
            if (listModel.DisplayApprove) MainToolBar.GetMenuReference(&quot;lnkApprove&quot;).Click += lnkApprove_Click;
            if (listModel.DisplayUnlock) MainToolBar.GetMenuReference(&quot;lnkUnlock&quot;).Click += lnkUnlock_Click;
            if (listModel.DisplayLock) MainToolBar.GetMenuReference(&quot;lnkLock&quot;).Click += lnkLock_Click;
            if (listModel.DisplayNew) MainToolBar.GetMenuReference(&quot;lnkNew&quot;).Click += lnkNew_Click;
            if (listModel.DisplayView) MainToolBar.GetMenuReference(&quot;lnkView&quot;).Click += lnkView_Click;
            if (listModel.DisplayDelete) MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).Click += lnkDelete_Click;
            if (listModel.DisplayEdit) MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Click += lnkEdit_Click;
            if (listModel.DisplaySubItems) MainToolBar.GetMenuReference(&quot;lnkSubItems&quot;).Click += lnkSubItems_Click;
            if (listModel.DisplayRateAnalysis)
                MainToolBar.GetMenuReference(&quot;lnkRateAnalysis&quot;).Click += lnkRateAnalysis_Click;
            if (listModel.DisplayErrorLog) MainToolBar.GetMenuReference(&quot;lnkViewLog&quot;).Click += lnkViewLog_Click;

            if (!listModel.EnableNew &amp;&amp; listModel.DisplayNew) MainToolBar.DisableMenu(&quot;lnkNew&quot;);
            if (!listModel.EnableDelete &amp;&amp; listModel.DisplayDelete) MainToolBar.DisableMenu(&quot;lnkDelete&quot;);
            if (!listModel.EnableEdit &amp;&amp; listModel.DisplayEdit) MainToolBar.DisableMenu(&quot;lnkEdit&quot;);

            if (!listModel.EnableAddMulti &amp;&amp; listModel.DisplayAddMultiple) MainToolBar.DisableMenu(&quot;lnkAddMulti&quot;);
            if (!listModel.EnableImport &amp;&amp; listModel.DisplayImport) MainToolBar.DisableMenu(&quot;lnkExcelImport&quot;);

            if (!listModel.EnableNewCO &amp;&amp; listModel.DisplayNewCO)
            {
                MainToolBar.DisableMenu(&quot;lnkAddCOItem&quot;);
                MainToolBar.DisableMenu(&quot;lnkModifyExistingItem&quot;);
                MainToolBar.DisableMenu(&quot;lnkNCToC&quot;);
            }

            listModel.CustomDisplay(MainToolBar);
            // THIS IS TO APPLY THE JAVASCRIPT TO THE NEWLY CREATED TOOLBAR CONTROL

            if (listModel.DisplayEdit)
                MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).OnClientClick = &quot;return lnkGetSelectedIDs(&#39;&quot; +
                                                                        ValidateSelection.OneItemOrContainer.ToInt32_2() +
                                                                        &quot;&#39;, &#39;&quot; +
                                                                        hdnContainerIDList.ClientID + &quot;&#39;, &#39;&quot; +
                                                                        hdnItemIDList.ClientID + &quot;&#39;);&quot;;
            if (listModel.DisplaySubItems)
                MainToolBar.GetMenuReference(&quot;lnkSubItems&quot;).OnClientClick = &quot;return lnkGetSelectedIDs(&#39;&quot; +
                                                                            ValidateSelection.OneItem.ToInt32_2() +
                                                                            &quot;&#39;, &#39;&quot; + hdnContainerIDList.ClientID +
                                                                            &quot;&#39;, &#39;&quot; + hdnItemIDList.ClientID +
                                                                            &quot;&#39;);&quot;;
            if (listModel.DisplayRateAnalysis)
                MainToolBar.GetMenuReference(&quot;lnkRateAnalysis&quot;).OnClientClick = &quot;return lnkGetSelectedIDs(&#39;&quot; +
                                                                                ValidateSelection.OneItem.ToInt32_2() +
                                                                                &quot;&#39;, &#39;&quot; + hdnContainerIDList.ClientID +
                                                                                &quot;&#39;, &#39;&quot; + hdnItemIDList.ClientID +
                                                                                &quot;&#39;);&quot;;
            if (listModel.DisplayView)
                MainToolBar.GetMenuReference(&quot;lnkView&quot;).OnClientClick = &quot;return lnkGetSelectedIDs(&#39;&quot; +
                                                                        ValidateSelection.OneItemOrContainer.ToInt32_2() +
                                                                        &quot;&#39;, &#39;&quot; +
                                                                        hdnContainerIDList.ClientID + &quot;&#39;, &#39;&quot; +
                                                                        hdnItemIDList.ClientID + &quot;&#39;);&quot;;
            if (listModel.DisplayDelete)
                MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).OnClientClick = &quot;if(lnkGetSelectedIDs(&#39;&quot; +
                                                                          ValidateSelection.OneOrMoreItemsAndContainers
                                                                              .ToInt32_2() + &quot;&#39;, &#39;&quot; +
                                                                          hdnContainerIDList.ClientID + &quot;&#39;, &#39;&quot; +
                                                                          hdnItemIDList.ClientID +
                                                                          &quot;&#39;)) return ConfirmAction(&#39;Delete&#39;); else return false;&quot;;
            if (listModel.DisplayNew)
                MainToolBar.GetMenuReference(&quot;lnkNew&quot;).OnClientClick = &quot;return lnkGetSelectedIDs(&#39;&quot; +
                                                                       ValidateSelection.ZeroOrMoreItemsAndContainers
                                                                           .ToInt32_2() + &quot;&#39;, &#39;&quot; +
                                                                       hdnContainerIDList.ClientID + &quot;&#39;, &#39;&quot; +
                                                                       hdnItemIDList.ClientID + &quot;&#39;);&quot;;

            string lockMessage = &quot;Are you sure you want to Lock?&quot;;
            if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.MSP) &amp;&amp;
                listModel.ModuleId.Equals(Constants.MODID_CONTMGT))
                lockMessage =
                    &quot;It is advisable to Synchronise the Contract with MSP now to ensure that the Contract is fully in Sync with MSP. &quot; +
                    lockMessage;

            if (listModel.DisplayLock)
                MainToolBar.GetMenuReference(&quot;lnkLock&quot;).OnClientClick = &quot;return confirm(&#39;&quot; + lockMessage + &quot;&#39;);&quot;;
            if (listModel.DisplayUnlock)
                MainToolBar.GetMenuReference(&quot;lnkUnlock&quot;).OnClientClick =
                    &quot;return confirm(&#39;Are you sure you want to UnLock?&#39;);&quot;;
            if (listModel.DisplayAddMultiple)
                MainToolBar.GetSubMenuReference(&quot;lnkOthers&quot;, &quot;lnkAddMulti&quot;).OnClientClick =
                    &quot;return lnkGetSelectedIDs(&#39;&quot; +
                    ValidateSelection.ZeroOrMoreItemsAndContainers.ToInt32_2() + &quot;&#39;, &#39;&quot; +
                    hdnContainerIDList.ClientID + &quot;&#39;, &#39;&quot; + hdnItemIDList.ClientID + &quot;&#39;);&quot;;
            if (listModel.DisplayNewContainer)
                MainToolBar.GetMenuReference(&quot;lnkNewContainer&quot;).OnClientClick = &quot;return lnkGetSelectedIDs(&#39;&quot; +
                                                                                ValidateSelection
                                                                                    .ZeroOrMoreItemsAndContainers
                                                                                    .ToInt32_2() + &quot;&#39;, &#39;&quot; +
                                                                                hdnContainerIDList.ClientID + &quot;&#39;, &#39;&quot; +
                                                                                hdnItemIDList.ClientID + &quot;&#39;);&quot;;
            if (listModel.DisplayNewCO)
            {
                var menu = MainToolBar.GetSubMenuReference(&quot;lnkNewCO&quot;, &quot;lnkAddCOItem&quot;);

                if (menu != null)
                    menu.OnClientClick = &quot;return lnkGetSelectedIDs(&#39;&quot; +
                                         ValidateSelection.ZeroOrMoreItemsAndContainers.ToInt32_2() + &quot;&#39;, &#39;&quot; +
                                         hdnContainerIDList.ClientID + &quot;&#39;, &#39;&quot; + hdnItemIDList.ClientID + &quot;&#39;);&quot;;
            }
            if (listModel.DisplayAddExistingItem)
                MainToolBar.GetMenuReference(&quot;lnkAddExistingItem&quot;).OnClientClick = &quot;return lnkGetSelectedIDs(&#39;&quot; +
                                                                                   ValidateSelection
                                                                                       .ZeroOrMoreItemsAndContainers
                                                                                       .ToInt32_2() + &quot;&#39;, &#39;&quot; +
                                                                                   hdnContainerIDList.ClientID + &quot;&#39;, &#39;&quot; +
                                                                                   hdnItemIDList.ClientID + &quot;&#39;);&quot;;

            ////This Confirms from the User if he/she wants to continue and lose MSP data if Contract is Unlocked
            //if (listModel.DisplaySyncEIS &amp;&amp; listModel.DisplayLock)
            //    MainToolBar.AddAttributeToMenu(&quot;lnkSync&quot;, &quot;onClick&quot;,
            //                                   &quot;return confirm(\&quot;This will overwrite any existing MSP Project for this Contract. Are you sure you want to continue and Sync?\&quot;);&quot;);
            if (listModel.DisplayTabs)
            {
                foreach (OtherAction action in listModel.TabDetails)
                {
                    HtmlGenericControl li = CreateTabItem(action);
                    module_tabs.Controls.Add(li);
                }
            }
        }

        private HtmlGenericControl CreateTabItem(OtherAction action)
        {
            var ctrl = new HtmlGenericControl(&quot;li&quot;);
            var link = new HyperLink();
            link.CssClass = action.IsMainItem ? &quot;aSelected&quot; : &quot;aUnSelected&quot;;
            link.Text = GlobalizationUtility.SetResource(action.Name, false);
            link.NavigateUrl = action.Link;
            ctrl.Controls.Add(link);
            ctrl.Attributes.Add(&quot;class&quot;, action.IsMainItem ? &quot;liSelected&quot; : &quot;liUnSelected&quot;);
            return ctrl;
        }

        private Item CreateMenuItem(OtherAction action)
        {
            var item = new Item();
            item.Text = action.Name;
            if (action.Link != null &amp;&amp; !action.Link.Equals(string.Empty))
            {
                item.TargetUrl = action.Link + &quot;&amp;ReturnURL=&quot; + Request.Url.PathAndQuery;
            }
            return item;
        }

        protected void MainToolBar_MenuItemClick(object sender, EventArgs e)
        {
            var toolBarEventArg = (ToolBarEventArg)e;
            try
            {
                if (toolBarEventArg.Text.Equals(&quot;New Container&quot;) || toolBarEventArg.Text.Contains(&quot;Add CO&quot;))
                    listModel.HandleMenuItems(toolBarEventArg.Text, UltraWebGridExcelExporter1,
                        GetLastSelectedContainerID());
                else
                    listModel.HandleMenuItems(toolBarEventArg.Text, UltraWebGridExcelExporter1,
                        hdnContainerIDList.Value.Trim(&#39;,&#39;));
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                string errMessage = JS.Serialize(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;));
                ClientScript.RegisterStartupScript(GetType(), &quot;Exception: &quot; + errMessage,
                    &quot;&lt;script&gt;ShowError(&#39;&quot; + errMessage + &quot;&#39;);&lt;/script&gt;&quot;);
            }
            finally
            {
                if (listModel.IsMenuClickHandled)
                {
                    BindGridControl();
                    MainToolBar.CreateToolBar(listModel.Menus);
                    CustomizeToolBar();
                }
            }
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,51,0],[41,9,41,10,0],[42,13,42,35,0],[45,13,45,39,0],[47,13,47,30,0],[49,13,49,28,0],[51,13,51,33,0],[53,13,53,75,0],[55,13,55,65,0],[56,17,56,31,0],[58,17,58,35,0],[61,13,61,41,0],[62,9,62,10,0],[65,9,65,10,0],[66,13,66,70,0],[67,13,67,14,0],[68,17,71,66,0],[72,17,72,66,0],[73,21,73,100,0],[74,17,75,103,0],[76,17,76,18,0],[77,21,77,71,0],[78,17,78,18,0],[79,17,79,73,0],[80,21,80,114,0],[81,17,81,54,0],[82,13,82,14,0],[83,9,83,10,0],[86,9,86,10,0],[87,13,87,70,0],[88,13,88,14,0],[89,17,92,66,0],[93,17,93,66,0],[94,21,94,100,0],[95,17,96,103,0],[97,17,97,18,0],[98,21,98,71,0],[99,17,99,18,0],[100,17,100,73,0],[101,21,101,114,0],[102,17,102,54,0],[103,13,103,14,0],[104,9,104,10,0],[107,9,107,10,0],[108,13,108,30,0],[110,13,110,33,0],[111,9,111,10,0],[114,9,114,10,0],[115,13,115,29,0],[116,17,116,42,0],[118,13,118,40,0],[119,13,119,35,0],[120,13,120,14,0],[122,17,124,74,0],[126,17,126,24,0],[128,13,128,64,0],[129,13,129,31,0],[130,9,130,10,0],[133,9,133,10,0],[134,13,134,42,0],[137,13,137,111,0],[138,13,138,28,0],[139,9,139,10,0],[146,9,146,10,0],[147,13,147,77,0],[149,13,150,97,0],[152,13,154,24,0],[156,13,157,47,0],[158,9,158,10,0],[161,9,161,10,0],[163,13,163,14,0],[166,17,168,75,0],[170,17,170,73,0],[171,17,171,64,0],[172,17,172,77,0],[174,17,174,57,0],[175,17,175,69,0],[176,17,176,61,0],[178,17,178,47,0],[179,17,179,57,0],[180,17,180,61,0],[183,17,183,61,0],[184,17,184,80,0],[186,17,186,112,0],[187,21,187,45,0],[189,21,189,64,0],[190,17,190,58,0],[191,17,191,79,0],[193,17,193,45,0],[194,21,194,98,0],[195,17,195,43,0],[196,21,196,94,0],[197,17,197,42,0],[198,21,198,92,0],[199,17,199,43,0],[200,21,200,94,0],[201,17,201,47,0],[202,21,202,102,0],[203,17,203,51,0],[204,21,204,110,0],[206,17,206,58,0],[207,17,207,68,0],[208,17,208,64,0],[209,17,209,72,0],[210,17,210,75,0],[212,17,212,30,0],[214,17,215,48,0],[216,13,216,14,0],[217,13,217,33,0],[218,13,218,14,0],[219,17,219,43,0],[220,13,220,14,0],[221,9,221,10,0],[225,9,225,10,0],[226,13,226,56,0],[227,13,227,45,0],[228,13,228,100,0],[229,9,229,10,0],[232,9,232,10,0],[233,13,233,42,0],[234,13,234,34,0],[235,13,235,20,0],[235,22,235,29,0],[235,30,235,32,0],[235,33,235,40,0],[236,13,236,14,0],[237,17,237,37,0],[238,17,238,24,0],[238,26,238,34,0],[238,35,238,37,0],[238,38,238,41,0],[239,21,240,70,0],[241,17,241,33,0],[242,13,242,14,0],[243,13,243,35,0],[245,13,245,49,0],[247,13,247,14,0],[248,17,248,87,0],[249,13,249,14,0],[250,13,250,30,0],[251,13,251,14,0],[252,17,252,44,0],[253,13,253,14,0],[254,13,254,31,0],[255,9,255,10,0],[258,9,258,10,0],[259,13,259,27,0],[260,13,260,69,0],[261,13,261,76,0],[262,9,262,10,0],[265,9,265,10,0],[266,13,266,105,0],[267,17,267,76,0],[269,13,270,85,0],[271,17,271,87,0],[273,13,273,103,0],[275,13,276,78,0],[278,13,278,64,0],[279,17,279,50,0],[280,9,280,10,0],[283,9,283,10,0],[284,13,284,92,0],[285,13,288,75,0],[290,13,290,47,0],[291,13,291,30,0],[292,9,292,10,0],[295,9,295,10,0],[296,13,296,61,0],[297,13,297,53,0],[298,9,298,10,0],[301,9,301,10,0],[302,13,302,52,0],[303,13,303,61,0],[304,9,304,10,0],[311,9,311,10,0],[312,13,312,66,0],[314,13,314,14,0],[315,17,315,85,0],[316,17,316,50,0],[317,17,317,18,0],[318,21,318,71,0],[319,21,320,72,0],[321,17,321,18,0],[322,13,322,14,0],[323,13,323,33,0],[324,13,324,14,0],[325,17,325,82,0],[326,17,327,72,0],[328,13,328,14,0],[329,9,329,10,0],[332,9,332,10,0],[334,13,334,14,0],[335,17,335,51,0],[336,17,336,18,0],[337,21,337,46,0],[338,21,338,38,0],[339,21,339,39,0],[340,21,340,79,0],[341,21,341,64,0],[342,21,342,40,0],[344,21,344,57,0],[345,17,345,18,0],[346,13,346,14,0],[347,13,347,33,0],[348,13,348,14,0],[349,17,349,70,0],[350,17,350,82,0],[351,17,352,72,0],[353,13,353,14,0],[354,9,354,10,0],[357,9,357,10,0],[359,13,359,14,0],[360,17,360,49,0],[361,17,361,18,0],[362,21,362,45,0],[363,21,363,38,0],[364,21,364,39,0],[365,21,365,80,0],[366,21,366,64,0],[367,21,367,40,0],[369,21,369,57,0],[370,17,370,18,0],[371,13,371,14,0],[372,13,372,33,0],[373,13,373,14,0],[374,17,374,70,0],[375,17,375,82,0],[376,17,377,72,0],[378,13,378,14,0],[379,9,379,10,0],[382,9,382,10,0],[384,9,384,10,0],[387,9,387,10,0],[388,13,388,81,0],[389,17,389,24,0],[391,13,391,72,0],[392,9,392,10,0],[395,9,395,10,0],[396,13,396,60,0],[398,13,398,43,0],[399,13,399,14,0],[400,17,400,38,0],[401,17,401,18,0],[402,21,402,50,0],[403,21,403,46,0],[404,17,404,18,0],[405,13,405,14,0],[407,13,407,14,0],[408,17,408,52,0],[409,17,409,47,0],[410,17,410,18,0],[411,21,411,42,0],[412,21,412,22,0],[413,25,413,54,0],[414,25,414,50,0],[415,21,415,22,0],[416,21,418,41,0],[419,21,419,87,0],[420,17,420,18,0],[422,21,422,30,0],[423,13,423,14,0],[424,13,424,23,0],[425,9,425,10,0],[428,9,428,10,0],[429,13,429,81,0],[430,17,430,24,0],[432,13,432,14,0],[433,17,433,72,0],[434,21,434,108,0],[436,21,436,98,0],[437,13,437,14,0],[438,13,438,33,0],[439,13,439,14,0],[440,17,440,44,0],[441,13,441,14,0],[442,9,442,10,0],[445,9,445,10,0],[446,13,446,81,0],[447,17,447,24,0],[448,13,448,68,0],[449,17,449,104,0],[451,17,451,94,0],[452,9,452,10,0],[455,9,455,10,0],[457,13,457,14,0],[458,17,458,85,0],[459,21,459,28,0],[460,17,460,78,0],[461,21,461,101,0],[462,17,462,73,0],[463,21,463,91,0],[465,17,466,78,0],[467,17,467,88,0],[468,17,468,18,0],[469,21,469,78,0],[470,17,470,18,0],[471,17,471,54,0],[472,13,472,14,0],[473,13,473,33,0],[474,13,474,14,0],[475,17,475,70,0],[476,17,477,86,0],[478,13,478,14,0],[479,9,479,10,0],[482,9,482,10,0],[483,13,483,81,0],[484,17,484,24,0],[485,13,485,39,0],[487,13,489,33,0],[490,13,490,50,0],[491,9,491,10,0],[494,9,494,10,0],[495,13,495,81,0],[496,17,496,24,0],[498,13,498,41,0],[500,13,502,33,0],[503,13,503,50,0],[504,9,504,10,0],[511,9,511,10,0],[512,13,513,84,0],[514,13,514,31,0],[515,9,515,10,0],[518,9,518,10,0],[519,13,519,44,0],[519,45,519,118,0],[520,13,520,42,0],[520,43,520,112,0],[521,13,521,41,0],[521,42,521,109,0],[522,13,522,39,0],[522,40,522,103,0],[523,13,523,38,0],[523,39,523,100,0],[524,13,524,39,0],[524,40,524,103,0],[525,13,525,41,0],[525,42,525,109,0],[526,13,526,39,0],[526,40,526,103,0],[527,13,527,43,0],[527,44,527,115,0],[528,13,528,47,0],[529,17,529,96,0],[530,13,530,43,0],[530,44,530,113,0],[532,13,532,62,0],[532,63,532,97,0],[533,13,533,68,0],[533,69,533,106,0],[534,13,534,64,0],[534,65,534,100,0],[536,13,536,75,0],[536,76,536,115,0],[537,13,537,68,0],[537,69,537,111,0],[539,13,539,66,0],[540,13,540,14,0],[541,17,541,57,0],[542,17,542,66,0],[543,17,543,53,0],[544,13,544,14,0],[546,13,546,50,0],[549,13,549,39,0],[550,17,554,104,0],[555,13,555,43,0],[556,17,560,83,0],[561,13,561,47,0],[562,17,566,87,0],[567,13,567,39,0],[568,17,572,104,0],[573,13,573,41,0],[574,17,579,132,0],[580,13,580,38,0],[581,17,585,103,0],[587,13,587,67,0],[588,13,589,68,0],[590,17,592,33,0],[594,13,594,39,0],[595,17,595,114,0],[596,13,596,41,0],[597,17,598,75,0],[599,13,599,46,0],[600,17,603,91,0],[604,13,604,47,0],[605,17,610,112,0],[611,13,611,40,0],[612,13,612,14,0],[613,17,613,88,0],[615,17,615,34,0],[616,21,618,112,0],[619,13,619,14,0],[620,13,620,50,0],[621,17,626,115,0],[632,13,632,39,0],[633,13,633,14,0],[634,17,634,24,0],[634,26,634,44,0],[634,45,634,47,0],[634,48,634,68,0],[635,17,635,18,0],[636,21,636,67,0],[637,21,637,50,0],[638,17,638,18,0],[639,13,639,14,0],[640,9,640,10,0],[643,9,643,10,0],[644,13,644,53,0],[645,13,645,40,0],[646,13,646,77,0],[647,13,647,78,0],[648,13,648,44,0],[649,13,649,37,0],[650,13,650,93,0],[651,13,651,25,0],[652,9,652,10,0],[655,9,655,10,0],[656,13,656,35,0],[657,13,657,37,0],[658,13,658,74,0],[659,13,659,14,0],[660,17,660,89,0],[661,13,661,14,0],[662,13,662,25,0],[663,9,663,10,0],[666,9,666,10,0],[667,13,667,54,0],[669,13,669,14,0],[670,17,670,109,0],[671,21,672,55,0],[674,21,675,61,0],[676,13,676,14,0],[677,13,677,33,0],[678,13,678,14,0],[679,17,679,70,0],[680,17,680,82,0],[681,17,682,74,0],[683,13,683,14,0],[685,13,685,14,0],[686,17,686,50,0],[687,17,687,18,0],[688,21,688,39,0],[689,21,689,64,0],[690,21,690,40,0],[691,17,691,18,0],[692,13,692,14,0],[693,9,693,10,0]]);
    </script>
  </body>
</html>