<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Quantity Planning\EDPDetails.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.LibraryBL;
using Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI.BL;
using Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI.DTO;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;
using Infragistics.WebUI.WebDataInput;

namespace Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI
{
    public partial class EDPDetails : BrixPageBase
    {
        protected ModalPopupExtender PopupExtender;
        private string ResItemIdColumn = string.Empty;
        private GenericPickerControl resourcePicker;

        private bool IsERPConnected
        {
            get { return IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX); }
        }

        private int InstanceId { get; set; }

        private int ContractId { get; set; }

        private int QPID { get; set; }

        private int BucketCount { get; set; }

        private int StartNo
        {
            get { return Convert.ToInt32(Session[&quot;EDPStartNo&quot;]); }
            set { Session[&quot;EDPStartNo&quot;] = value; }
        }

        private int EndNo
        {
            get { return Convert.ToInt32(Session[&quot;EDPEndNo&quot;]); }
            set { Session[&quot;EDPEndNo&quot;] = value; }
        }

        private int CurrentLowerLimit
        {
            get { return Convert.ToInt32(Session[&quot;EDPCurrentLowerLimit&quot;]); }
            set { Session[&quot;EDPCurrentLowerLimit&quot;] = value; }
        }

        private int CurrentUpperLimit
        {
            get { return Convert.ToInt32(Session[&quot;EDPCurrentUpperLimit&quot;]); }
            set { Session[&quot;EDPCurrentUpperLimit&quot;] = value; }
        }

        private DataSet ScheduleData
        {
            get { return (DataSet)Session[&quot;EDPScheduleData&quot;]; }
            set { Session[&quot;EDPScheduleData&quot;] = value; }
        }

        private DataTable CurrentSource
        {
            get { return (DataTable)Session[&quot;EDPCurrentSource&quot;]; }
            set { Session[&quot;EDPCurrentSource&quot;] = value; }
        }

        private int tempDetailId
        {
            get { return Convert.ToInt32(Session[&quot;EDPtempDetailId&quot;]); }
            set { Session[&quot;EDPtempDetailId&quot;] = value; }
        }

        private string deletedResourceIDs
        {
            get { return Convert.ToString(Session[&quot;EDPdeletedResourceIDs&quot;]); }
            set { Session[&quot;EDPdeletedResourceIDs&quot;] = value; }
        }

        private int ResourceSource
        {
            get { return Convert.ToInt32(Session[&quot;EDPResourceSource&quot;]); }
            set { Session[&quot;EDPResourceSource&quot;] = value; }
        }

        //0 - Rate Analysis &amp; 1 - Library

        /// &lt;summary&gt;
        /// Gets the Project Mode : I-Integration, L-Live
        /// &lt;/summary&gt;
        private string ProjectMode
        {
            get { return (CacheManager.Instance.IsIntegrated(Request[Constants.QRY_PROJECTID].ToInt32_2()) ? &quot;I&quot; : &quot;L&quot;); }
        }

        protected override void OnPreInit(EventArgs e)
        {
            ModuleId = &quot;QTYPLAN&quot;;
            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            //wdcReleaseDate.Format = Infragistics.WebUI.WebSchedule.DateFormat.Short;
            //System.Globalization.CultureInfo cinfo = new System.Globalization.CultureInfo(System.Threading.Thread.CurrentThread.CurrentCulture.LCID);
            //DateTimeFormatInfo dateTimeCI = new DateTimeFormatInfo();
            ////dateTimeCI.FullDateTimePattern = Constants.FORMAT_DATE;
            //dateTimeCI.DateSeparator = &quot;-&quot;;
            //dateTimeCI.ShortDatePattern = Constants.FORMAT_DATE;
            //cinfo.DateTimeFormat = dateTimeCI;
            ////System.Threading.Thread.CurrentThread.CurrentCulture = cinfo;
            //wdcReleaseDate.CalendarLayout.Culture = cinfo; 

            //uwgEDP.InitializeRow += new InitializeRowEventHandler(uwgEDP_InitializeRow);
            //uwgEDP.on
            ResItemIdColumn = (IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;);
            resourcePicker = (ucResourcePicker as GenericPickerControl);
            ConfigureResourcePicker();
            QPID = Request[&quot;QPID&quot;].ToInt32_2();
            InstanceId = string.IsNullOrEmpty(Request[&quot;InstanceId&quot;]) ? 0 : Request[&quot;InstanceId&quot;].ToInt32_2();
            ContractId = Request[&quot;ParentID&quot;].ToInt32_2();
            DPMaster dto = QuantityPlanningManager.Instance.GetDeploymentDetails(InstanceId, &quot;QTYPEDP&quot;);
            ViewState[&quot;Status&quot;] = dto.Status;
            base.OnInit(e);
        }

        //private void uwgEDP_InitializeRow(object sender, RowEventArgs e)
        //{
        //if (e.Row.Cells.FromKey(&quot;Mode&quot;).Value.Equals(&quot;1&quot;))
        //    e.Row.Cells.FromKey(&quot;Mode&quot;).Text = &quot;Hired&quot;;
        //else if (e.Row.Cells.FromKey(&quot;Mode&quot;).Value.Equals(&quot;0&quot;))
        //    e.Row.Cells.FromKey(&quot;Mode&quot;).Text = &quot;Own&quot;;

        //}

        protected override void CreateChildControls()
        {
            EnsureChildControls();
            CreateControlCollection();

            DPMaster dto = QuantityPlanningManager.Instance.GetDeploymentDetails(Convert.ToInt32(QPID), &quot;QTYPEDP&quot;);

            List&lt;MenuGroup&gt; menuGroups = new List&lt;MenuGroup&gt;();
            MenuGroup generalGroup = new MenuGroup(&quot;General&quot;);
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)) &amp;&amp;
                Convert.ToInt32(ViewState[&quot;Status&quot;].ToString2()) &lt;= 2)
            {
                if (AllowSave)
                generalGroup.AddMenu(new LargeButton(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;));
                generalGroup.AddMenu(new TextIcon(&quot;lnkFromRateAnalysis&quot;, &quot;Add From Rate Analysis&quot;, &quot;Icn_Rateanalysis_16.png&quot;));
                generalGroup.AddMenu(new TextIcon(&quot;lnkFromLibrary&quot;, &quot;Add From Library&quot;, &quot;Icn_Lib_16.png&quot;));
                generalGroup.AddMenu(new TextIcon(&quot;lnkDelete&quot;, &quot;Delete&quot;, &quot;Icn_Delete_16.png&quot;));
            }
            generalGroup.AddMenu(new TextIcon(&quot;lnkCancel&quot;, &quot;Back&quot;, &quot;Icn_Back_16.png&quot;));
            generalGroup.AddMenu(new TextIcon(&quot;lnkPrevious&quot;, &quot;Previous Period&quot;, &quot;Icn_Previous_16.png&quot;));
            generalGroup.AddMenu(new TextIcon(&quot;lnkNext&quot;, &quot;Next Period&quot;, &quot;Icn_Next_16.png&quot;));



            menuGroups.Add(generalGroup);

            MenuGroup otherGroup = new MenuGroup(&quot;Others&quot;);
            SplitButton btnFilter = new SplitButton(&quot;lnkFilter_SplitButton&quot;, &quot;Filter&quot;, &quot;Icn_Filter.png&quot;);
            btnFilter.AddSubMenu(new TextIcon(&quot;lnkFilter&quot;, &quot;Filter&quot;, &quot;Icn_Filter.png&quot;));
            btnFilter.AddSubMenu(new TextIcon(&quot;lnkFilterClr&quot;, &quot;Remove Filter&quot;, &quot;Icn_Filterremove_16.png&quot;));
            otherGroup.AddMenu(btnFilter);

            menuGroups.Add(otherGroup);

            CreateToolBarMenu(menuGroups, null);


            if (Request[&quot;Mode&quot;] != &quot;View&quot;)
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).OnClientClick = &quot;return CheckSave();&quot;;
            InitFilter();
            SetPopUpDetails();
            ClientScript.RegisterStartupScript(aspPnlFilter.GetType(), &quot;showHideFilterButtons&quot;,
                                               &quot;showHideFilterButtons(&#39;&quot; +
                                               MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                               MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);&quot;, true);

            if (!IsPostBack)
                FormatNavigatorButtons();
        }

        private void SetPopUpDetails()
        {
            //PopupExtender = (ModalPopupExtender)this.Master.FindControl(&quot;filterExtender&quot;);
            PopupExtender.Visible = true;
            //PopupExtender.AddNewPopup(aspPnl.ClientID, btnHelper.ClientID, btnActCancel);

            if (MainToolBar.GetMenuReference(&quot;lnkFilter&quot;) != null &amp;&amp;
                MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;) != null)
            {
                //MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).Style.Add(&quot;display&quot;, &quot;block&quot;);
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).AddAttribute(&quot;style&quot;, &quot;display:none&quot;);
                PopupExtender.AddNewPopup(aspPnlFilter.ClientID,
                                          ((Request[&quot;Mode&quot;] == &quot;View&quot;)
                                               ? MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID
                                               : btnGhostCheck.ClientID), btnCancel.ClientID, 300, 550);
                PopupExtender.AddNewPopup(aspPnlFilter.ClientID,
                                          ((Request[&quot;Mode&quot;] == &quot;View&quot;)
                                               ? MainToolBar.GetMenuReference(&quot;lnkFilter_SplitButton&quot;).ClientID
                                               : btnGhostCheck.ClientID), btnCancel.ClientID, 300, 550);
                btnFilter.OnClientClick = &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID + &quot;&#39;).click();applyFilter(&#39;&quot; +
                                          btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                          MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                          MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);return false;&quot;;
                btnReset.Attributes.Add(&quot;onClick&quot;,
                                        &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID +
                                        &quot;&#39;).click();return resetFilters(&#39;&quot; + btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                        MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                        MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);&quot;);
                MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).OnClientClick = &quot;return resetFilters(&#39;&quot; +
                                                                             btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                                                             MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).
                                                                                 ClientID + &quot;&#39;, &#39;&quot; +
                                                                             MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;)
                                                                                 .ClientID + &quot;&#39;);&quot;;
            }
            // PopupExtender.Title = ((Request[hdnPickerClicked.ClientID] ?? &quot;R&quot;).Equals(&quot;P&quot;)) ? &quot;Filter&quot; : &quot;Activities&quot;;
        }


        private void InitFilter()
        {
            ClientScript.RegisterArrayDeclaration(&quot;FilterFields&quot;,
                                                  ModelHelper.GetFilterHtml(tblFilter, GetApplyFilterLabels()));
        }

        public BrixFilter[] GetApplyFilterLabels()
        {
            var filters = new BrixFilter[3];
            filters[0] = new BrixFilter();
            filters[0].Name = &quot;ResItemID&quot;;
            filters[0].Title = &quot;ResourceID&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].FilterType = BrixFilter.Type.Combo;
            filters[2].Name = &quot;Mode&quot;;
            filters[2].Title = &quot;Mode&quot;;
            filters[2].DataSource = new DataTable();
            var dicValues = new Dictionary&lt;string, string&gt;();
            dicValues.Add(&quot;Own&quot;, &quot;0&quot;);
            dicValues.Add(&quot;Hired&quot;, &quot;1&quot;);
            filters[2].Values = dicValues;
            return filters;
        }

        protected void btnFilterGhost_Click(object sender, EventArgs e)
        {
            string filter = ModelHelper.GetFilterXML(tblFilter.UniqueID.Remove(tblFilter.UniqueID.Length - 9), Request,
                                                     GetApplyFilterLabels());
            //LoadSubContractingData();
            FetchAndBindData(filter);
            FormatNavigatorButtons();
        }

        private void FormatNavigatorButtons()
        {
            if (CurrentLowerLimit + BucketCount &gt; EndNo)
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            else if (CurrentLowerLimit == StartNo &amp;&amp; (BucketCount &gt; 0 &amp;&amp; EndNo &gt; (CurrentLowerLimit + BucketCount)))
                MainToolBar.ShowMenu(&quot;lnkNext&quot;);

            if (CurrentUpperLimit - BucketCount &lt; StartNo)
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
        }

        protected override void CustomizeToolBar()
        {
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)) &amp;&amp;
                Convert.ToInt32(ViewState[&quot;Status&quot;].ToString2()) &lt;= 2)
            {
                if (MainToolBar.GetMenuReference(&quot;lnkSave&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += btnSave_Click;                
                if (MainToolBar.GetMenuReference(&quot;lnkDelete&quot;) != null)
                {
                    MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).Click += btnDeleteResource_Click;
                    MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).OnClientClick += &quot;return ValidateDelete();&quot;;
                }
                if (MainToolBar.GetMenuReference(&quot;lnkFromRateAnalysis&quot;) != null)
                    MainToolBar.GetMenuReference(&quot;lnkFromRateAnalysis&quot;).Click += lnkFromRateAnalysis_Click;
                if (MainToolBar.GetMenuReference(&quot;lnkFromLibrary&quot;) != null)
                    MainToolBar.GetMenuReference(&quot;lnkFromLibrary&quot;).Click += lnkFromLibrary_Click;
            }
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += btnCancel_Click;
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;

            MainToolBar.GetMenuReference(&quot;lnkNext&quot;).Click += btnFwdGhost_Click;
            MainToolBar.GetMenuReference(&quot;lnkNext&quot;).OnClientClick = &quot;return SaveAndProceed(&#39;1&#39;);&quot;;

            MainToolBar.GetMenuReference(&quot;lnkPrevious&quot;).Click += btnBwdGhost_Click;
            MainToolBar.GetMenuReference(&quot;lnkPrevious&quot;).OnClientClick = &quot;return SaveAndProceed(&#39;2&#39;);&quot;;
        }

        private void lnkFromRateAnalysis_Click(object sender, EventArgs e)
        {
            AddResource(0);
        }

        private void lnkFromLibrary_Click(object sender, EventArgs e)
        {
            AddResource(1);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            //TODO: Obtain bucket count from the user
            BucketCount = 5;
            SetEDPMode();
            if (!IsPostBack)
            {
                ResourceSource = 0; //RA
                FetchAndBindData(string.Empty);
            }
            else
            {
                SetFixedColumnProperties();
                FormatNavigatorButtons();
            }
        }

        private void SetEDPMode()
        {
            foreach (UltraGridRow row in uwgEDP.Rows)
            {
                row.Cells.FromKey(&quot;Mode&quot;).Text = GetMode(row.Cells.FromKey(&quot;Mode&quot;).Text);
            }
        }

        private void FetchAndBindData(string filter)
        {
            ScheduleData = QuantityPlanningManager.Instance.GetDPScheduleData(InstanceId, QPID, ContractId, filter);
            AppendScheduleInfo();
            FormCurrentSource(ScheduleData.Tables[0]);
            int rowCount = ScheduleData.Tables[1].Rows.Count;
            StartNo = CurrentLowerLimit = ScheduleData.Tables[1].Rows[0][&quot;Number&quot;].ToInt32_2();
            EndNo = ScheduleData.Tables[1].Rows[rowCount - 1][&quot;Number&quot;].ToInt32_2();
            if (CurrentLowerLimit + BucketCount &gt; EndNo)
            {
                CurrentUpperLimit = EndNo;
            }
            else CurrentUpperLimit = CurrentLowerLimit + (BucketCount - 1);
            LoadEDPData(true);
            tempDetailId = -1;
            deletedResourceIDs = &quot;&quot;;
        }

        private void AppendScheduleInfo()
        {
            DataTable scheduleInfo = ScheduleData.Tables[2];
            int tempScheduleID;
            foreach (DataColumn scheduleID in scheduleInfo.Columns)
                if (Int32.TryParse(scheduleID.ColumnName, out tempScheduleID))
                    ScheduleData.Tables[0].Columns.Add(tempScheduleID.ToString2());
            int resourceDetailId;
            foreach (DataRow resourceInfo in ScheduleData.Tables[0].Select())
            {
                resourceDetailId = resourceInfo[&quot;EDPDetailID&quot;].ToInt32_2();
                DataRow[] resourceScheduleInfo = scheduleInfo.Select(&quot;SchItemID = &#39;&quot; + resourceDetailId + &quot;&#39;&quot;);
                if (resourceScheduleInfo.Length &gt; 0)
                {
                    foreach (DataColumn scheduleID in scheduleInfo.Columns)
                    {
                        if (Int32.TryParse(scheduleID.ColumnName, out tempScheduleID))
                        {
                            resourceInfo[tempScheduleID.ToString2()] =
                                resourceScheduleInfo[0][tempScheduleID.ToString2()];
                        }
                    }
                }
            }
        }

        protected void btnFwdGhost_Click(object sender, EventArgs e)
        {
            SaveEditedItems();
            CurrentLowerLimit += BucketCount;
            if (CurrentUpperLimit + BucketCount &gt; EndNo) CurrentUpperLimit = EndNo;
            else CurrentUpperLimit += BucketCount;
            if (CurrentLowerLimit &gt; StartNo)
            {
                HideMenu(&quot;lnkPrevious&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
            }
            if (CurrentUpperLimit &lt; EndNo)
            {
                HideMenu(&quot;lnkNext&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            }

            LoadEDPData(false);
        }

        protected void btnBwdGhost_Click(object sender, EventArgs e)
        {
            SaveEditedItems();
            CurrentUpperLimit = CurrentLowerLimit - 1;
            CurrentLowerLimit -= BucketCount;
            if (CurrentLowerLimit &gt; StartNo)
            {
                HideMenu(&quot;lnkPrevious&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
            }
            if (CurrentUpperLimit &lt; EndNo)
            {
                HideMenu(&quot;lnkNext&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            }

            LoadEDPData(false);
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            SaveEditedItems();
            int scheduleId;
            int quantity;
            var sb = new StringBuilder();
            var sbNewResources = new StringBuilder();
            var sbEditedResources = new StringBuilder();
            var resourceRow = new UltraGridRow();
            sbNewResources.Append(&quot;&lt;Resources&gt;&quot;);
            sb.Append(&quot;&lt;Schedules&gt;&quot;);
            sbEditedResources.Append(&quot;&lt;EditedResources&gt;&quot;);
            foreach (DataRow resource in ScheduleData.Tables[0].Select())
            {
                foreach (DataColumn scheduleData in resource.Table.Columns)
                {
                    if (int.TryParse(scheduleData.ColumnName, out scheduleId))
                    {
                        if (int.TryParse(resource[scheduleData].ToString2(), out quantity) &amp;&amp; quantity != 0)
                        {
                            sb.Append(&quot;&lt;Schedule&gt;&quot;);
                            sb.AppendFormat(
                                &quot;&lt;EDPDetailID&gt;{0}&lt;/EDPDetailID&gt;&lt;ScheduleID&gt;{1}&lt;/ScheduleID&gt;&lt;Quantity&gt;{2}&lt;/Quantity&gt;&quot;,
                                resource[&quot;EDPDetailID&quot;], scheduleId, quantity);
                            sb.Append(&quot;&lt;/Schedule&gt;&quot;);
                        }
                    }
                }
                resourceRow =
                    uwgEDP.Rows.OfType&lt;UltraGridRow&gt;().ToList().Find(
                        row =&gt;
                        row.Cells.FromKey(&quot;EDPDetailID&quot;).Text.Equals(resource[&quot;EDPDetailID&quot;].ToString2(),
                                                                     StringComparison.CurrentCultureIgnoreCase));
                if (resource[&quot;EDPDetailID&quot;].ToInt32_2() &lt; 0)
                {
                    sbNewResources.Append(&quot;&lt;Resource&gt;&quot;);

                    sbNewResources.AppendFormat(
                        &quot;&lt;EDPDetailID&gt;{0}&lt;/EDPDetailID&gt;&lt;ResItemID&gt;{1}&lt;/ResItemID&gt;&lt;Description&gt;{2}&lt;/Description&gt;&lt;Mode&gt;{3}&lt;/Mode&gt;&lt;ReleaseDate&gt;{4}&lt;/ReleaseDate&gt;&quot;,
                        UIHelper.ReplaceXMLCharEntities(resource[&quot;EDPDetailID&quot;].ToString2()),
                        UIHelper.ReplaceXMLCharEntities(resource[&quot;ResItemID&quot;].ToString2()),
                        UIHelper.ReplaceXMLCharEntities(resource[&quot;Description&quot;].ToString2()),
                        UIHelper.ReplaceXMLCharEntities(GetMode(resourceRow.Cells.FromKey(&quot;Mode&quot;).Value.ToString2())),
                        resourceRow.Cells.FromKey(&quot;ReleaseDate&quot;).Value.ToUtc());
                    sbNewResources.Append(&quot;&lt;/Resource&gt;&quot;);
                }
                else
                {
                    sbEditedResources.Append(&quot;&lt;EditedResource&gt;&quot;);
                    sbEditedResources.AppendFormat(
                        &quot;&lt;EDPDetailID&gt;{0}&lt;/EDPDetailID&gt;&lt;Mode&gt;{1}&lt;/Mode&gt;&lt;ReleaseDate&gt;{2}&lt;/ReleaseDate&gt;&quot;,
                        resource[&quot;EDPDetailID&quot;],
                        UIHelper.ReplaceXMLCharEntities((GetMode(resourceRow.Cells.FromKey(&quot;Mode&quot;).Value.ToString2()))),
                        resourceRow.Cells.FromKey(&quot;ReleaseDate&quot;).Value.ToUtc());
                    sbEditedResources.Append(&quot;&lt;/EditedResource&gt;&quot;);
                }
            }
            sb.Append(&quot;&lt;/Schedules&gt;&quot;);
            sbNewResources.Append(&quot;&lt;/Resources&gt;&quot;);
            sbEditedResources.Append(&quot;&lt;/EditedResources&gt;&quot;);
            string xmlArgument = sb.ToString2();
            string xmlNewResources = sbNewResources.ToString2();
            string xmlEditedResources = sbEditedResources.ToString2();
            int result = 0;
            if (
                int.TryParse(
                    QuantityPlanningManager.Instance.SaveDPScheduleData(QPID, InstanceId, deletedResourceIDs,
                                                                        xmlNewResources, xmlArgument, xmlEditedResources,
                                                                        &#39;E&#39;).ToString2(), out result))
            {
                if (result == 1)
                    ClientScript.RegisterStartupScript(GetType(), &quot;alertMessage&quot;, &quot;ShowSuccess(&#39;Saved successfully.&#39;);&quot;, true);
                else
                    ClientScript.RegisterStartupScript(GetType(), &quot;alertMessage&quot;,
                                                       &quot;ShowError(&#39;The save was unsuccessful due to some unknown reason. Please try again.&#39;);&quot;,
                                                       true);
            }
            FetchAndBindData(string.Empty);
            FormatNavigatorButtons();
        }

        private string GetMode(string modeValue)
        {
            if (modeValue == &quot;Own&quot; || modeValue == &quot;0&quot;)
                return &quot;Own&quot;;
            else
                return &quot;Hired&quot;;
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            Response.Redirect(
                string.Format(
                    &quot;~/Modules/QTYPLAN/CreateDP.aspx?PID={0}&amp;ContractID={1}&amp;QPID={2}&amp;Context=QTYPEDP&amp;ID={3}&amp;Mode={4}&quot;,
                    Request[&quot;PID&quot;], ContractId, QPID, InstanceId, Request[&quot;Mode&quot;]));
        }

        private void FormCurrentSource(DataTable scheduleData)
        {
            CurrentSource = new DataTable();
            string hiddenColumns = &quot;SchItemID&quot;;

            int tempScheduleId;
            foreach (DataColumn col in scheduleData.Columns)
            {
                if (!hiddenColumns.Split(&#39;,&#39;).Contains(col.ColumnName) &amp;&amp;
                    !int.TryParse(col.ColumnName, out tempScheduleId))
                    CurrentSource.Columns.Add(col.ColumnName);
            }
            CurrentSource.Columns.Add(&quot;IsEdited&quot;);
            CurrentSource.AcceptChanges();

            string fixedColumns = &quot;EDPDetailID,ResItemID,Description,Mode,ReleaseDate,TotalNo&quot;;
            foreach (DataRow dr in scheduleData.Select())
            {
                DataRow newRow = CurrentSource.NewRow();
                foreach (string colName in fixedColumns.Split(&#39;,&#39;))
                    newRow[colName] = dr[colName];
                newRow[&quot;IsEdited&quot;] = false;
                CurrentSource.Rows.Add(newRow);
            }
        }

        private DataTable GetCurrentDataSource(DataTable scheduleData)
        {
            int tempScheduleId;
            DataColumn currentCol;
            for (int colCount = CurrentSource.Columns.Count - 1; colCount &gt;= 0; colCount--)
            {
                if (int.TryParse(CurrentSource.Columns[colCount].ColumnName, out tempScheduleId))
                {
                    currentCol = CurrentSource.Columns[colCount];
                    CurrentSource.Columns.Remove(currentCol);
                }
            }

            for (int colNo = CurrentLowerLimit; colNo &lt;= CurrentUpperLimit; colNo++)
            {
                CurrentSource.Columns.Add(colNo.ToString2());
            }
            CurrentSource.AcceptChanges();

            Int32 totalNo;
            foreach (DataRow dr in scheduleData.Select())
            {
                DataRow correspondingRow = CurrentSource.Select(&quot;EDPDetailID = &#39;&quot; + dr[&quot;EDPDetailID&quot;] + &quot;&#39;&quot;)[0];
                for (int colNo = CurrentLowerLimit; colNo &lt;= CurrentUpperLimit; colNo++)
                {
                    correspondingRow[colNo.ToString2()] = dr[colNo.ToString2()];
                }

                correspondingRow[&quot;TotalNo&quot;] = Int32.TryParse(dr[&quot;TotalNo&quot;].ToString2(), out totalNo)
                                                  ? totalNo
                                                  : dr[&quot;TotalNo&quot;];
                correspondingRow[&quot;IsEdited&quot;] = false;
            }

            return CurrentSource;
        }

        private void LoadEDPData(bool reFetch)
        {
            if (ScheduleData.Tables.Count.Equals(0))
                ScheduleData = QuantityPlanningManager.Instance.GetDPScheduleData(InstanceId, QPID, ContractId,
                                                                                  string.Empty);

            uwgEDP.DataSource = GetCurrentDataSource(ScheduleData.Tables[0]);
            try
            {
                uwgEDP.DataBind();
            }
            catch
            {
            }
            SetEDPGridColumnProperties();
        }

        private void SetEDPGridColumnProperties()
        {
            foreach (UltraGridColumn col in uwgEDP.Columns)
            {
                int scheduleId;
                if (int.TryParse(col.Key, out scheduleId))
                {
                    if (scheduleId &gt;= CurrentLowerLimit &amp;&amp; scheduleId &lt;= CurrentUpperLimit)
                    {
                        col.Header.Caption = GetColumnHeader(scheduleId);
                        col.Format =
                            CoreDatabaseHelper.GetNumberFormat(
                                CoreDatabaseHelper.GetDigitsGrouping(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT), 0);
                        //If there is no mode or the mode is View then the user should not able to modify the grid column values as well as 
                        //the background color will be transparent
                        if (Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;))
                        {
                            col.AllowUpdate = AllowUpdate.No;
                            col.CellStyle.BackColor = Color.Transparent;
                        }
                        else
                        {
                            col.AllowUpdate = AllowUpdate.Yes;
                            col.CellStyle.BackColor = Color.Yellow;
                        }
                        col.Hidden = false;
                        col.EditorControlID = &quot;wneCell&quot;;
                        col.Type = ColumnType.Custom;
                        col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
                        wneCell.DataMode = NumericDataMode.Int;
                    }
                    else
                        col.Hidden = true;
                }
            }
            SetFixedColumnProperties();
        }

        private void SetFixedColumnProperties()
        {
            uwgEDP.Bands[0].Columns.FromKey(&quot;Multi&quot;).AllowUpdate = AllowUpdate.Yes;
            if (uwgEDP.Columns.Exists(&quot;EDPDetailID&quot;)) uwgEDP.Columns.FromKey(&quot;EDPDetailID&quot;).Hidden = true;
            if (uwgEDP.Columns.Exists(&quot;IsEdited&quot;)) uwgEDP.Columns.FromKey(&quot;IsEdited&quot;).Hidden = true;
            if (uwgEDP.Columns.Exists(&quot;ResItemID&quot;)) uwgEDP.Columns.FromKey(&quot;ResItemID&quot;).Header.Caption = &quot;Resource ID&quot;;
            if (uwgEDP.Columns.Exists(&quot;TotalNo&quot;))
            {
                uwgEDP.Columns.FromKey(&quot;TotalNo&quot;).Format =
                    CoreDatabaseHelper.GetNumberFormat(CoreDatabaseHelper.GetDigitsGrouping(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT), 0);
                uwgEDP.Columns.FromKey(&quot;TotalNo&quot;).Header.Caption = &quot;Total Nos&quot;;
                uwgEDP.Columns.FromKey(&quot;TotalNo&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
            }
            if (uwgEDP.Columns.Exists(&quot;ReleaseDate&quot;))
            {
                UltraGridColumn dateCol = uwgEDP.Columns.FromKey(&quot;ReleaseDate&quot;);
                dateCol.Type = ColumnType.Custom;
                dateCol.EditorControlID = &quot;wdcReleaseDate&quot;;
                dateCol.DataType = &quot;System.DateTime&quot;;
                dateCol.Header.Caption = &quot;Release Date&quot;;
                //dateCol.Format = Constants.FORMAT_DATE;

                //If there is no mode or the mode is View then the user should not able to modify the grid column values as well as 
                //the background color will be transparent
                if (Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;))
                {
                    dateCol.AllowUpdate = AllowUpdate.No;
                    dateCol.CellStyle.BackColor = Color.Transparent;
                }
                else
                {
                    dateCol.AllowUpdate = AllowUpdate.Yes;
                    dateCol.CellStyle.BackColor = Color.Yellow;
                }
            }

            if (uwgEDP.Columns.Exists(&quot;Mode&quot;))
            {
                UltraGridColumn modeCol = uwgEDP.Columns.FromKey(&quot;Mode&quot;);
                modeCol.Type = ColumnType.DropDownList;
                //If there is no mode or the mode is View then the user should not able to modify the grid column values as well as 
                //the background color will be transparent
                if (Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;))
                {
                    modeCol.AllowUpdate = AllowUpdate.No;
                    modeCol.CellStyle.BackColor = Color.Transparent;
                }
                else
                {
                    modeCol.AllowUpdate = AllowUpdate.Yes;
                    modeCol.CellStyle.BackColor = Color.Yellow;
                }
                modeCol.ValueList.DisplayStyle = ValueListDisplayStyle.DisplayText;
                modeCol.DataType = typeof(string).ToString2();
                var lst2 = new ValueList();
                lst2.ValueListItems.Add(0, &quot;Own&quot;);
                lst2.ValueListItems.Add(1, &quot;Hired&quot;);
                modeCol.ValueList = lst2;
            }
        }

        private string GetColumnHeader(int number)
        {
            DataRow currentRow = ScheduleData.Tables[1].Select(&quot;Number = &#39;&quot; + number + &quot;&#39;&quot;)[0];
            DateTime dateColName;
            if (ScheduleData.Tables[1].Columns.Contains(&quot;Name&quot;))
            {
                if (currentRow[&quot;PeriodBasis&quot;].ToString2().Equals(&quot;2&quot;) &amp;&amp;
                    DateTime.TryParse(currentRow[&quot;Name&quot;].ToString2(), out dateColName))
                    return dateColName.ToMWDateTimeString_FormatDate();
                else
                    return currentRow[&quot;Name&quot;].ToString2();
            }
            else
                return @&quot;Week &quot; + (number - StartNo + 1) + &quot;: &quot; +
                       currentRow[&quot;StartDate&quot;].ToMWDateTimeString_FormatDate()
                       + &quot; - &quot; + currentRow[&quot;EndDate&quot;].ToMWDateTimeString_FormatDate();
        }

        private void SaveEditedItems()
        {
            int tempScheduleId, resourceDetailId;
            int quantity, newValue;

            foreach (UltraGridRow editedRow in uwgEDP.Rows)
            {
                if (editedRow.Cells.FromKey(&quot;IsEdited&quot;).Value != null &amp;&amp;
                    editedRow.Cells.FromKey(&quot;IsEdited&quot;).Value.Equals(&quot;true&quot;))
                {
                    resourceDetailId = editedRow.Cells.FromKey(&quot;EDPDetailID&quot;).Value.ToInt32_2();
                    DataRow[] resources = ScheduleData.Tables[0].Select(&quot;EDPDetailID = &#39;&quot; + resourceDetailId + &quot;&#39;&quot;);
                    if (resources.Length &gt; 0)
                    {
                        DataRow resource = resources[0];
                        foreach (DataColumn scheduleCol in CurrentSource.Columns)
                        {
                            if (int.TryParse(scheduleCol.ColumnName, out tempScheduleId))
                            {
                                newValue =
                                    int.TryParse(editedRow.Cells.FromKey(scheduleCol.ColumnName).Value.ToString2(),
                                                 out quantity)
                                        ? quantity
                                        : 0;
                                //difference += newValue - (int.TryParse(resource[scheduleCol.ColumnName].ToString2(), out quantity) ? quantity : 0);
                                resource[scheduleCol.ColumnName] = (newValue == 0
                                                                        ? DBNull.Value
                                                                        : editedRow.Cells.FromKey(scheduleCol.ColumnName)
                                                                              .Value);
                            }
                        }

                        try
                        {
                            DataRow correspondingRow =
                                CurrentSource.Select(&quot;EDPDetailID = &#39;&quot; + resourceDetailId + &quot;&#39;&quot;)[0];
                            resource[&quot;Mode&quot;] =
                                correspondingRow[&quot;Mode&quot;] = GetMode(editedRow.Cells.FromKey(&quot;Mode&quot;).Value.ToString2());
                            resource[&quot;ReleaseDate&quot;] =
                                correspondingRow[&quot;ReleaseDate&quot;] = editedRow.Cells.FromKey(&quot;ReleaseDate&quot;).Value;
                        }
                        catch
                        {
                            //Do nothing
                        }

                        resource[&quot;TotalNo&quot;] = GetMaximumNumber(resource);
                    }
                }
            }
        }

        private Int32 GetMaximumNumber(DataRow row)
        {
            int tempscheduleId, tempValue, maxValue = 0;
            foreach (DataColumn scheduleCol in row.Table.Columns)
            {
                if (int.TryParse(scheduleCol.ColumnName, out tempscheduleId))
                {
                    if (int.TryParse(row[scheduleCol].ToString2(), out tempValue) &amp;&amp; tempValue &gt; maxValue)
                        maxValue = row[scheduleCol].ToInt32_2();
                }
            }
            return maxValue;
        }

        public void AddResource(int source)
        {
            ResourceSource = source;
            SaveEditedItems();
            divResourcePicker.Visible = true;
            MainToolBar.Visible = false;
            resourcePicker.ChangeTableOrViewAndBind(&quot;&quot;);
            resourcePicker.StateMgmtContext = &quot;Resource Equipment&quot;;
            divItemDetails.Style.Value = &quot;display:none&quot;;
        }

        public void btnDeleteResource_Click(object sender, EventArgs e)
        {
            int delResourceID;
            for (int rowCount = uwgEDP.Rows.Count - 1; rowCount &gt;= 0; rowCount--)
            {
                if (uwgEDP.Rows[rowCount].Cells.FromKey(&quot;Multi&quot;).Value.ToString2().ToLower2().Equals(&quot;true&quot;))
                {
                    delResourceID = uwgEDP.Rows[rowCount].Cells.FromKey(&quot;EDPDetailID&quot;).Value.ToInt32_2();
                    if (delResourceID &gt; 0)
                    {
                        if (!string.IsNullOrEmpty(deletedResourceIDs))
                            deletedResourceIDs += &quot;,&quot; + delResourceID.ToString2();
                        else
                            deletedResourceIDs = delResourceID.ToString2();
                    }
                    uwgEDP.Rows.Remove(uwgEDP.Rows[rowCount]);

                    if (CurrentSource.Select(&quot;EDPDetailID = &#39;&quot; + delResourceID + &quot;&#39;&quot;).Length &gt; 0)
                        CurrentSource.Rows.Remove(CurrentSource.Select(&quot;EDPDetailID = &#39;&quot; + delResourceID + &quot;&#39;&quot;)[0]);
                    if (ScheduleData.Tables[0].Select(&quot;EDPDetailID = &#39;&quot; + delResourceID + &quot;&#39;&quot;).Length &gt; 0)
                        ScheduleData.Tables[0].Rows.Remove(
                            ScheduleData.Tables[0].Select(&quot;EDPDetailID = &#39;&quot; + delResourceID + &quot;&#39;&quot;)[0]);
                }
            }
            SetFixedColumnProperties();
        }

        private void ConfigureResourcePicker()
        {
            resourcePicker.BackClicked += equipmentPicker_BackClicked;
            resourcePicker.BindData += equipmentPicker_BindData;
            resourcePicker.ItemSelected += resourcePicker_ItemSelected;
            resourcePicker.GridNoDataMessage = &quot;No Data exist&quot;;
            resourcePicker.IsFilterXml = true;
            resourcePicker.DisplayFilter = true;
            resourcePicker.Filters = GetFilters();
            resourcePicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            resourcePicker.DefaultSortColumn = ResItemIdColumn;
            resourcePicker.ModifyColumnProperties(&quot;ID&quot;, true, null, null, null, false);
            resourcePicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
            if (!ResItemIdColumn.Equals(&quot;ResItemID&quot;))
                resourcePicker.ModifyColumnProperties(&quot;ResItemID&quot;, true, null, null, null, false);
            else
                resourcePicker.ModifyColumnProperties(&quot;ParentResItemID&quot;, true, null, null, null, false);
            resourcePicker.ModifyColumnProperties(ResItemIdColumn, false, null, null, null, false, &quot;Resource ID&quot;);
            resourcePicker.ModifyColumnProperties(&quot;ProjId&quot;, true, null, null, null, false);
            resourcePicker.ModifyColumnProperties(&quot;ResourceGroupId&quot;, true, null, null, null, false);
            resourcePicker.ModifyColumnProperties(&quot;Unit&quot;, true, null, null, null, false);
            resourcePicker.ModifyColumnProperties(&quot;Rate&quot;, true, null, null, null, false);
            resourcePicker.StateMgmtContext = &quot;Resource Equipment&quot;;
            resourcePicker.EnableMultipleSelect = true;
        }

        private void resourcePicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            DataTable newResources = e.SelectedItems;
            bool hasDuplicateResource = CheckDuplication(newResources);

            foreach (DataRow validResource in newResources.Select())
            {
                var newRowValues = new object[5];
                DataRow newCurrentResourceRow = CurrentSource.NewRow(),
                        newScheduleDataRow = ScheduleData.Tables[0].NewRow();
                newRowValues[0] = false;
                newRowValues[1] =
                    newCurrentResourceRow[&quot;EDPDetailID&quot;] = newScheduleDataRow[&quot;EDPDetailID&quot;] = tempDetailId--;
                newRowValues[2] =
                    newCurrentResourceRow[&quot;ResItemID&quot;] =
                    newScheduleDataRow[&quot;ResItemID&quot;] = validResource[ResItemIdColumn];
                newRowValues[3] =
                    newCurrentResourceRow[&quot;Description&quot;] =
                    newScheduleDataRow[&quot;Description&quot;] = validResource[&quot;Description&quot;];
                newRowValues[4] = newCurrentResourceRow[&quot;Mode&quot;] = newScheduleDataRow[&quot;Mode&quot;] = validResource[&quot;Mode&quot;];
                var newRow = new UltraGridRow(newRowValues);
                uwgEDP.Rows.Add(newRow);
                CurrentSource.Rows.Add(newCurrentResourceRow);
                ScheduleData.Tables[0].Rows.Add(newScheduleDataRow);
            }

            if (hasDuplicateResource)
                ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;, &quot;ShowError(&#39;Duplicate entries are discarded.&#39;);&quot;,
                                                   true);

            SetFixedColumnProperties();
            e.SelectedItems.Clear();
            equipmentPicker_BackClicked(sender, e);
        }

        private bool CheckDuplication(DataTable newResources)
        {
            bool hasDuplicateResources = false;
            if (!newResources.Columns.Contains(&quot;Mode&quot;))
                newResources.Columns.Add(&quot;Mode&quot;);
            newResources.AcceptChanges();
            int resourceCount;
            string existingMode;
            for (int rowCount = newResources.Rows.Count - 1; rowCount &gt;= 0; rowCount--)
            {
                resourceCount = 0;
                existingMode = &quot;Hired&quot;;
                foreach (UltraGridRow existingResource in uwgEDP.Rows)
                {
                    if (
                        existingResource.Cells.FromKey(&quot;ResItemID&quot;).Value.Equals(
                            newResources.Rows[rowCount][ResItemIdColumn]))
                    {
                        resourceCount++;
                        existingMode = existingResource.Cells.FromKey(&quot;Mode&quot;).Value.ToString2();
                    }
                }
                if (resourceCount &gt; 1)
                {
                    hasDuplicateResources = true;
                    newResources.Rows.Remove(newResources.Rows[rowCount]);
                }
                else
                    newResources.Rows[rowCount][&quot;Mode&quot;] = existingMode.Equals(&quot;Hired&quot;) ? &quot;Own&quot; : &quot;Hired&quot;;
            }

            return hasDuplicateResources;
        }

        private BrixFilter[] GetFilters()
        {
            var filters = new BrixFilter[2];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Resource ID :&quot;;
            filters[0].Name = ResItemIdColumn;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Description :&quot;;
            filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        private void equipmentPicker_BindData(string Filter, string SortOrder, out DataSet DsResult, ref int CurrentPage,
                                              int PageSize, out int PageCount)
        {
            if (ResourceSource.Equals(1))
            {
                string mappedCompany = Session[Constants.EIS_ADDITIONAL_INFO].ToString2();
                string resourceType = &quot;equipment&quot;;

                if (string.IsNullOrEmpty(Filter))
                {
                    Filter = &quot;&lt;XMLRoot&gt;&lt;/XMLRoot&gt;&quot;;
                }

                PageCount = (int)Math.Ceiling(GetPageCount(resourceType, SortOrder, Filter) / PageSize);
                DsResult = new BrixDataSet();
                DsResult.Tables.Add(
                    LibraryInterface.Instance.GetResourceItems(mappedCompany, resourceType, ((CurrentPage - 1) * PageSize) + 1, PageSize,
                                                SortOrder, Filter).Copy());
            }
            else
            {
                DsResult = new DataSet();
                PageCount = 0;
                if (string.IsNullOrEmpty(Filter))
                    Filter = &quot;&lt;XMLRoot&gt;&lt;/XMLRoot&gt;&quot;;
                else
                    Filter = Filter.Replace(ResItemIdColumn, &quot;ResItemID&quot;);
                DataTable dtResources =
                    QuantityPlanningManager.Instance.GetRAResourcesForDP(QPID, &#39;E&#39;, Filter, SortOrder, PageSize,
                                                                         ref CurrentPage, out PageCount).Tables[0].Copy();

                DsResult.Tables.Add(dtResources);
            }
        }

        private double GetPageCount(string resType, string sort, string filter)
        {
            string mappedCompany = Session[Constants.EIS_ADDITIONAL_INFO].ToString2();
            return LibraryInterface.Instance.GetResourceItemsCount(mappedCompany, resType, 0, sort, filter);
        }

        private void equipmentPicker_BackClicked(object sender, EventArgs e)
        {
            divResourcePicker.Visible = false;
            MainToolBar.Visible = true;
            divItemDetails.Style.Value = &quot;display:block&quot;;
            LoadEDPData(false);
            FormatNavigatorButtons();
        }

        private void HideMenu(string buttonID, bool bUnHide)
        {
            if (bUnHide) MainToolBar.ShowMenu(buttonID);
            else MainToolBar.HideMenu(buttonID);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,55,0],[30,17,30,18,0],[30,19,30,112,0],[30,113,30,114,0],[33,34,33,38,0],[33,39,33,43,0],[35,34,35,38,0],[35,39,35,43,0],[37,28,37,32,0],[37,33,37,37,0],[39,35,39,39,0],[39,40,39,44,0],[43,17,43,18,0],[43,19,43,65,0],[43,66,43,67,0],[44,17,44,18,0],[44,19,44,49,0],[44,50,44,51,0],[49,17,49,18,0],[49,19,49,63,0],[49,64,49,65,0],[50,17,50,18,0],[50,19,50,47,0],[50,48,50,49,0],[55,17,55,18,0],[55,19,55,75,0],[55,76,55,77,0],[56,17,56,18,0],[56,19,56,59,0],[56,60,56,61,0],[61,17,61,18,0],[61,19,61,75,0],[61,76,61,77,0],[62,17,62,18,0],[62,19,62,59,0],[62,60,62,61,0],[67,17,67,18,0],[67,19,67,62,0],[67,63,67,64,0],[68,17,68,18,0],[68,19,68,54,0],[68,55,68,56,0],[73,17,73,18,0],[73,19,73,65,0],[73,66,73,67,0],[74,17,74,18,0],[74,19,74,55,0],[74,56,74,57,0],[79,17,79,18,0],[79,19,79,70,0],[79,71,79,72,0],[80,17,80,18,0],[80,19,80,54,0],[80,55,80,56,0],[85,17,85,18,0],[85,19,85,77,0],[85,78,85,79,0],[86,17,86,18,0],[86,19,86,60,0],[86,61,86,62,0],[91,17,91,18,0],[91,19,91,72,0],[91,73,91,74,0],[92,17,92,18,0],[92,19,92,56,0],[92,57,92,58,0],[102,17,102,18,0],[102,19,102,121,0],[102,122,102,123,0],[106,9,106,10,0],[107,13,107,34,0],[108,13,108,31,0],[109,9,109,10,0],[112,9,112,10,0],[125,13,125,82,0],[126,13,126,73,0],[127,13,127,39,0],[128,13,128,48,0],[129,13,129,110,0],[130,13,130,58,0],[131,13,131,105,0],[132,13,132,46,0],[133,13,133,28,0],[134,9,134,10,0],[146,9,146,10,0],[147,13,147,35,0],[148,13,148,39,0],[150,13,150,116,0],[152,13,152,64,0],[153,13,153,63,0],[154,13,155,71,0],[156,13,156,14,0],[157,17,157,31,0],[158,17,158,90,0],[159,17,159,128,0],[160,17,160,108,0],[161,17,161,96,0],[162,13,162,14,0],[163,13,163,88,0],[164,13,164,105,0],[165,13,165,93,0],[169,13,169,42,0],[171,13,171,60,0],[172,13,172,106,0],[173,13,173,89,0],[174,13,174,108,0],[175,13,175,43,0],[177,13,177,40,0],[179,13,179,49,0],[182,13,182,43,0],[183,17,183,97,0],[184,13,184,26,0],[185,13,185,31,0],[186,13,189,117,0],[191,13,191,29,0],[192,17,192,42,0],[193,9,193,10,0],[196,9,196,10,0],[198,13,198,42,0],[201,13,202,70,0],[203,13,203,14,0],[205,17,205,97,0],[206,17,209,105,0],[210,17,213,105,0],[214,17,217,118,0],[218,17,222,104,0],[223,17,228,100,0],[229,13,229,14,0],[231,9,231,10,0],[235,9,235,10,0],[236,13,237,113,0],[238,9,238,10,0],[241,9,241,10,0],[242,13,242,45,0],[243,13,243,43,0],[244,13,244,43,0],[245,13,245,45,0],[246,13,246,58,0],[248,13,248,43,0],[249,13,249,64,0],[250,13,250,58,0],[252,13,252,43,0],[253,13,253,59,0],[254,13,254,38,0],[255,13,255,39,0],[256,13,256,53,0],[257,13,257,62,0],[258,13,258,39,0],[259,13,259,41,0],[260,13,260,43,0],[261,13,261,28,0],[262,9,262,10,0],[265,9,265,10,0],[266,13,267,78,0],[269,13,269,38,0],[270,13,270,38,0],[271,9,271,10,0],[274,9,274,10,0],[275,13,275,57,0],[276,17,276,49,0],[277,18,277,117,0],[278,17,278,49,0],[280,13,280,59,0],[281,17,281,53,0],[282,9,282,10,0],[285,9,285,10,0],[286,13,287,71,0],[288,13,288,14,0],[289,17,289,69,0],[290,17,290,80,0],[291,17,291,71,0],[292,17,292,18,0],[293,21,293,96,0],[294,21,294,107,0],[295,17,295,18,0],[296,17,296,81,0],[297,21,297,108,0],[298,17,298,76,0],[299,21,299,98,0],[300,13,300,14,0],[301,13,301,80,0],[302,13,302,80,0],[304,13,304,80,0],[305,13,305,99,0],[307,13,307,84,0],[308,13,308,103,0],[309,9,309,10,0],[312,9,312,10,0],[313,13,313,28,0],[314,9,314,10,0],[317,9,317,10,0],[318,13,318,28,0],[319,9,319,10,0],[322,9,322,10,0],[324,13,324,29,0],[325,13,325,26,0],[326,13,326,29,0],[327,13,327,14,0],[328,17,328,36,0],[329,17,329,48,0],[330,13,330,14,0],[332,13,332,14,0],[333,17,333,44,0],[334,17,334,42,0],[335,13,335,14,0],[336,9,336,10,0],[339,9,339,10,0],[340,13,340,20,0],[340,22,340,38,0],[340,39,340,41,0],[340,42,340,53,0],[341,13,341,14,0],[342,17,342,90,0],[343,13,343,14,0],[344,9,344,10,0],[347,9,347,10,0],[348,13,348,117,0],[349,13,349,34,0],[350,13,350,55,0],[351,13,351,62,0],[352,13,352,96,0],[353,13,353,85,0],[354,13,354,57,0],[355,13,355,14,0],[356,17,356,43,0],[357,13,357,14,0],[358,18,358,76,0],[359,13,359,31,0],[360,13,360,31,0],[361,13,361,37,0],[362,9,362,10,0],[365,9,365,10,0],[366,13,366,61,0],[368,13,368,20,0],[368,22,368,43,0],[368,44,368,46,0],[368,47,368,67,0],[369,17,369,79,0],[370,21,370,84,0],[372,13,372,20,0],[372,22,372,42,0],[372,43,372,45,0],[372,46,372,77,0],[373,13,373,14,0],[374,17,374,76,0],[375,17,375,112,0],[376,17,376,53,0],[377,17,377,18,0],[378,21,378,28,0],[378,30,378,51,0],[378,52,378,54,0],[378,55,378,75,0],[379,21,379,22,0],[380,25,380,87,0],[381,25,381,26,0],[382,29,383,85,0],[384,25,384,26,0],[385,21,385,22,0],[386,17,386,18,0],[387,13,387,14,0],[388,9,388,10,0],[391,9,391,10,0],[392,13,392,31,0],[393,13,393,46,0],[394,13,394,57,0],[394,58,394,84,0],[395,18,395,51,0],[396,13,396,45,0],[397,13,397,14,0],[398,17,398,47,0],[399,13,399,14,0],[401,13,401,14,0],[402,17,402,53,0],[403,13,403,14,0],[404,13,404,43,0],[405,13,405,14,0],[406,17,406,43,0],[407,13,407,14,0],[409,13,409,14,0],[410,17,410,49,0],[411,13,411,14,0],[413,13,413,32,0],[414,9,414,10,0],[417,9,417,10,0],[418,13,418,31,0],[419,13,419,55,0],[420,13,420,46,0],[421,13,421,45,0],[422,13,422,14,0],[423,17,423,47,0],[424,13,424,14,0],[426,13,426,14,0],[427,17,427,53,0],[428,13,428,14,0],[429,13,429,43,0],[430,13,430,14,0],[431,17,431,43,0],[432,13,432,14,0],[434,13,434,14,0],[435,17,435,49,0],[436,13,436,14,0],[438,13,438,32,0],[439,9,439,10,0],[442,9,442,10,0],[443,13,443,31,0],[446,13,446,42,0],[447,13,447,54,0],[448,13,448,57,0],[449,13,449,50,0],[450,13,450,50,0],[451,13,451,38,0],[452,13,452,59,0],[453,13,453,20,0],[453,22,453,38,0],[453,39,453,41,0],[453,42,453,73,0],[454,13,454,14,0],[455,17,455,24,0],[455,26,455,49,0],[455,50,455,52,0],[455,53,455,75,0],[456,17,456,18,0],[457,21,457,79,0],[458,21,458,22,0],[459,25,459,109,0],[460,25,460,26,0],[461,29,461,53,0],[462,29,464,80,0],[465,29,465,54,0],[466,25,466,26,0],[467,21,467,22,0],[468,17,468,18,0],[469,17,472,25,0],[472,25,473,112,0],[473,112,473,114,0],[469,17,473,114,0],[474,17,474,61,0],[475,17,475,18,0],[476,21,476,57,0],[478,21,484,81,0],[485,21,485,58,0],[486,17,486,18,0],[488,17,488,18,0],[489,21,489,66,0],[490,21,494,81,0],[495,21,495,67,0],[496,17,496,18,0],[497,13,497,14,0],[498,13,498,39,0],[499,13,499,51,0],[500,13,500,60,0],[501,13,501,49,0],[502,13,502,65,0],[503,13,503,71,0],[504,13,504,28,0],[505,13,509,103,0],[510,13,510,14,0],[511,17,511,33,0],[512,21,512,128,0],[514,21,516,62,0],[517,13,517,14,0],[518,13,518,44,0],[519,13,519,38,0],[520,9,520,10,0],[523,9,523,10,0],[524,13,524,56,0],[525,17,525,30,0],[527,17,527,32,0],[528,9,528,10,0],[531,9,531,10,0],[532,13,535,85,0],[536,9,536,10,0],[539,9,539,10,0],[540,13,540,45,0],[541,13,541,48,0],[544,13,544,20,0],[544,22,544,36,0],[544,37,544,39,0],[544,40,544,60,0],[545,13,545,14,0],[546,17,547,71,0],[548,21,548,63,0],[549,13,549,14,0],[550,13,550,51,0],[551,13,551,43,0],[553,13,553,96,0],[554,13,554,20,0],[554,22,554,32,0],[554,33,554,35,0],[554,36,554,57,0],[555,13,555,14,0],[556,17,556,57,0],[557,17,557,24,0],[557,26,557,40,0],[557,41,557,43,0],[557,44,557,67,0],[558,21,558,51,0],[559,17,559,44,0],[560,17,560,48,0],[561,13,561,14,0],[562,9,562,10,0],[565,9,565,10,0],[568,18,568,64,0],[568,66,568,79,0],[568,81,568,91,0],[569,13,569,14,0],[570,17,570,98,0],[571,17,571,18,0],[572,21,572,66,0],[573,21,573,62,0],[574,17,574,18,0],[575,13,575,14,0],[577,18,577,47,0],[577,49,577,75,0],[577,77,577,84,0],[578,13,578,14,0],[579,17,579,62,0],[580,13,580,14,0],[581,13,581,43,0],[584,13,584,20,0],[584,22,584,32,0],[584,33,584,35,0],[584,36,584,57,0],[585,13,585,14,0],[586,17,586,113,0],[587,22,587,51,0],[587,53,587,79,0],[587,81,587,88,0],[588,17,588,18,0],[589,21,589,81,0],[590,17,590,18,0],[592,17,594,67,0],[595,17,595,54,0],[596,13,596,14,0],[598,13,598,34,0],[599,9,599,10,0],[602,9,602,10,0],[603,13,603,53,0],[604,17,605,97,0],[607,13,607,78,0],[609,13,609,14,0],[610,17,610,35,0],[611,13,611,14,0],[612,13,612,18,0],[613,13,613,14,0],[614,13,614,14,0],[615,13,615,42,0],[616,9,616,10,0],[619,9,619,10,0],[620,13,620,20,0],[620,22,620,41,0],[620,42,620,44,0],[620,45,620,59,0],[621,13,621,14,0],[623,17,623,59,0],[624,17,624,18,0],[625,21,625,92,0],[626,21,626,22,0],[627,25,627,74,0],[628,25,630,122,0],[633,25,633,87,0],[634,25,634,26,0],[635,29,635,62,0],[636,29,636,73,0],[637,25,637,26,0],[639,25,639,26,0],[640,29,640,63,0],[641,29,641,68,0],[642,25,642,26,0],[643,25,643,44,0],[644,25,644,57,0],[645,25,645,54,0],[646,25,646,79,0],[647,25,647,64,0],[648,21,648,22,0],[650,25,650,43,0],[651,17,651,18,0],[652,13,652,14,0],[653,13,653,40,0],[654,9,654,10,0],[657,9,657,10,0],[658,13,658,84,0],[659,13,659,54,0],[659,55,659,107,0],[660,13,660,51,0],[660,52,660,101,0],[661,13,661,52,0],[661,53,661,120,0],[662,13,662,50,0],[663,13,663,14,0],[664,17,665,145,0],[666,17,666,80,0],[667,17,667,101,0],[668,13,668,14,0],[669,13,669,54,0],[670,13,670,14,0],[671,17,671,81,0],[672,17,672,50,0],[673,17,673,60,0],[674,17,674,54,0],[675,17,675,57,0],[680,17,680,79,0],[681,17,681,18,0],[682,21,682,58,0],[683,21,683,69,0],[684,17,684,18,0],[686,17,686,18,0],[687,21,687,59,0],[688,21,688,64,0],[689,17,689,18,0],[690,13,690,14,0],[692,13,692,47,0],[693,13,693,14,0],[694,17,694,74,0],[695,17,695,56,0],[698,17,698,79,0],[699,17,699,18,0],[700,21,700,58,0],[701,21,701,69,0],[702,17,702,18,0],[704,17,704,18,0],[705,21,705,59,0],[706,21,706,64,0],[707,17,707,18,0],[708,17,708,84,0],[709,17,709,63,0],[710,17,710,44,0],[711,17,711,51,0],[712,17,712,53,0],[713,17,713,42,0],[714,13,714,14,0],[715,9,715,10,0],[718,9,718,10,0],[719,13,719,96,0],[721,13,721,65,0],[722,13,722,14,0],[723,17,724,88,0],[725,21,725,72,0],[727,21,727,59,0],[730,17,732,88,0],[733,9,733,10,0],[736,9,736,10,0],[740,13,740,20,0],[740,22,740,44,0],[740,45,740,47,0],[740,48,740,59,0],[741,13,741,14,0],[742,17,743,78,0],[744,17,744,18,0],[745,21,745,97,0],[746,21,746,117,0],[747,21,747,46,0],[748,21,748,22,0],[749,25,749,57,0],[750,25,750,32,0],[750,34,750,56,0],[750,57,750,59,0],[750,60,750,81,0],[751,25,751,26,0],[752,29,752,90,0],[753,29,753,30,0],[754,33,758,45,0],[760,33,763,87,0],[764,29,764,30,0],[765,25,765,26,0],[768,25,768,26,0],[769,29,770,101,0],[771,29,772,119,0],[773,29,774,112,0],[775,25,775,26,0],[776,25,776,30,0],[777,25,777,26,0],[779,25,779,26,0],[781,25,781,74,0],[782,21,782,22,0],[783,17,783,18,0],[784,13,784,14,0],[785,9,785,10,0],[788,9,788,10,0],[789,44,789,56,0],[790,13,790,20,0],[790,22,790,44,0],[790,45,790,47,0],[790,48,790,65,0],[791,13,791,14,0],[792,17,792,78,0],[793,17,793,18,0],[794,21,794,107,0],[795,25,795,65,0],[796,17,796,18,0],[797,13,797,14,0],[798,13,798,29,0],[799,9,799,10,0],[802,9,802,10,0],[803,13,803,37,0],[804,13,804,31,0],[805,13,805,46,0],[806,13,806,41,0],[807,13,807,57,0],[808,13,808,68,0],[809,13,809,57,0],[810,9,810,10,0],[813,9,813,10,0],[815,18,815,54,0],[815,56,815,69,0],[815,71,815,81,0],[816,13,816,14,0],[817,17,817,110,0],[818,17,818,18,0],[819,21,819,106,0],[820,21,820,43,0],[821,21,821,22,0],[822,25,822,71,0],[823,29,823,83,0],[825,29,825,76,0],[826,21,826,22,0],[827,21,827,63,0],[829,21,829,98,0],[830,25,830,117,0],[831,21,831,107,0],[832,25,833,104,0],[834,17,834,18,0],[835,13,835,14,0],[836,13,836,40,0],[837,9,837,10,0],[840,9,840,10,0],[841,13,841,71,0],[842,13,842,65,0],[843,13,843,72,0],[844,13,844,64,0],[845,13,845,47,0],[846,13,846,49,0],[847,13,847,51,0],[848,13,848,83,0],[849,13,849,64,0],[850,13,850,88,0],[851,13,851,92,0],[852,13,852,54,0],[853,17,853,99,0],[855,17,855,105,0],[856,13,856,115,0],[857,13,857,92,0],[858,13,858,101,0],[859,13,859,90,0],[860,13,860,90,0],[861,13,861,68,0],[862,13,862,56,0],[863,9,863,10,0],[866,9,866,10,0],[867,13,867,54,0],[868,13,868,72,0],[870,13,870,20,0],[870,22,870,43,0],[870,44,870,46,0],[870,47,870,68,0],[871,13,871,14,0],[872,17,872,50,0],[873,17,873,71,0],[874,25,874,77,0],[875,17,875,41,0],[876,17,877,111,0],[878,17,880,86,0],[881,17,883,86,0],[884,17,884,118,0],[885,17,885,61,0],[886,17,886,41,0],[887,17,887,63,0],[888,17,888,69,0],[889,13,889,14,0],[891,13,891,38,0],[892,17,893,58,0],[895,13,895,40,0],[896,13,896,37,0],[897,13,897,52,0],[898,9,898,10,0],[901,9,901,10,0],[902,13,902,48,0],[903,13,903,56,0],[904,17,904,50,0],[905,13,905,42,0],[908,18,908,60,0],[908,62,908,75,0],[908,77,908,87,0],[909,13,909,14,0],[910,17,910,35,0],[911,17,911,40,0],[912,17,912,24,0],[912,26,912,55,0],[912,56,912,58,0],[912,59,912,70,0],[913,17,913,18,0],[914,21,916,75,0],[917,21,917,22,0],[918,25,918,41,0],[919,25,919,97,0],[920,21,920,22,0],[921,17,921,18,0],[922,17,922,39,0],[923,17,923,18,0],[924,21,924,50,0],[925,21,925,75,0],[926,17,926,18,0],[928,21,928,106,0],[929,13,929,14,0],[931,13,931,42,0],[932,9,932,10,0],[935,9,935,10,0],[936,13,936,45,0],[938,13,938,43,0],[939,13,939,48,0],[940,13,940,47,0],[941,13,941,58,0],[943,13,943,43,0],[944,13,944,48,0],[945,13,945,45,0],[946,13,946,58,0],[948,13,948,28,0],[949,9,949,10,0],[953,9,953,10,0],[954,13,954,42,0],[955,13,955,14,0],[956,17,956,91,0],[957,17,957,51,0],[959,17,959,50,0],[960,17,960,18,0],[961,21,961,52,0],[962,17,962,18,0],[964,17,964,105,0],[965,17,965,46,0],[966,17,968,76,0],[969,13,969,14,0],[971,13,971,14,0],[972,17,972,42,0],[973,17,973,31,0],[974,17,974,50,0],[975,21,975,52,0],[977,21,977,75,0],[978,17,980,123,0],[982,17,982,50,0],[983,13,983,14,0],[984,9,984,10,0],[987,9,987,10,0],[988,13,988,87,0],[989,13,989,109,0],[990,9,990,10,0],[993,9,993,10,0],[994,13,994,47,0],[995,13,995,40,0],[996,13,996,58,0],[997,13,997,32,0],[998,13,998,38,0],[999,9,999,10,0],[1002,9,1002,10,0],[1003,13,1003,25,0],[1003,26,1003,57,0],[1004,18,1004,49,0],[1005,9,1005,10,0]]);
    </script>
  </body>
</html>