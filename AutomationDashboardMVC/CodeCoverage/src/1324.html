<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\DOCMGMT\Documents.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Web;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.DocumentManagementBL;
using Aurigo.AMP3.DocumentManagementDTO;
using Aurigo.AMP3.LinksBL;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.ProjectBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.UserControls;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.WorkflowMediators;
using Aurigo.Common;
using Aurigo.Workflow;
using Infragistics.WebUI.UltraWebGrid;
using XF = Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.AMP3.DocumentManagementUI
{
    public partial class Documents : BrixPageBase, IXMLControl
    {
        private List&lt;string&gt; _dateColumns = new List&lt;string&gt;();
        private List&lt;string&gt; _docmgmtModuleComponents = null;
        private BrixFormModel model;
        private XMLFormManagerModel managerModel;

        protected int userid;
        protected int linkID;
        protected string _Action;
        protected string DocName = string.Empty;

        private string PageContext
        {
            get { return &quot;{0}_Docs&quot;.Format2(Constants.MODID_DOCMGMT); }
        }

        protected int FolderID
        {
            get { return string.IsNullOrEmpty(Request[&quot;FID&quot;]) ? 0 : Request[&quot;FID&quot;].ToInt32_2(); }
        }

        protected int ProjectID
        {
            get { return string.IsNullOrEmpty(Request[&quot;PID&quot;]) ? 0 : Request[&quot;PID&quot;].ToInt32_2(); }
        }

        protected int InstanceID
        {
            get { return string.IsNullOrEmpty(Request[&quot;IID&quot;]) ? 0 : Request[&quot;IID&quot;].ToInt32_2(); }
        }

        protected int ModuleInstanceID
        {
            get { return ViewState[&quot;MID&quot;].ToInt32_2(); }
            set { ViewState[&quot;MID&quot;] = value; }
        }

        protected string ModuleID
        {
            get { return ViewState[&quot;MCode&quot;].ToString2(); }
            set { ViewState[&quot;MCode&quot;] = value.ToString2(); }
        }

        protected int LinkID
        {
            get { return hdnLinkID.Value.ToInt32_2(); }
            set { hdnLinkID.Value = value.ToString2(); }
        }

        protected string DocType
        {
            get { return hdnDocType.Value; }
            set { hdnDocType.Value = value.ToString2(); }
        }

        private int DocId
        {
            get { return string.IsNullOrEmpty(Request[&quot;DocId&quot;]) ? 0 : Request[&quot;DocId&quot;].ToInt32_2(); }
        }

        public BrixFormModel Model
        {
            get { return model; }
            set { model = value; }
        }

        public string UploadifyControlClientID
        {
            get { return uploadify.FileUploadClientID; }
        }

        public string UploadifyExcelControlClientID
        {
            get { return uploadifyExcel.FileUploadClientID; }
        }

        public string UplodifyOnStartUploadCustomScript
        {
            get { return DocumentManager.Instance.GetOnUploadStartScript(); }
        }

        private List&lt;string&gt; DOCMGMTModuleComponents
        {
            get
            {
                if (_docmgmtModuleComponents == null)
                    _docmgmtModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);

                return _docmgmtModuleComponents;
            }
        }

        public override bool CheckAccess()
        {
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY.ToLower());
            if (Request.QueryString[&quot;Mode&quot;].ToString() == &quot;Edit&quot;)
                PermissionsToCheck.Add(&quot;editd&quot;);
            else if (Request.QueryString[&quot;Mode&quot;].ToString() == &quot;CheckIn&quot;)
                PermissionsToCheck.Add(&quot;checkin&quot;);
            else // Default is &quot;New&quot;
                PermissionsToCheck.Add(&quot;upload&quot;);

            List&lt;string&gt; allowedPermissions = Aurigo.AMP3.DocumentManagementBL.DocumentManager.Instance.GetFolderPermissions((Request[&quot;FID&quot;]).ToInt32_2(),
                 string.IsNullOrEmpty(Request[&quot;PID&quot;]) ? 0 : Request[&quot;PID&quot;].ToInt32_2(), Request.QueryString[&quot;MID&quot;].ToString(),
                 Request.QueryString[&quot;IID&quot;].ToInt32_2(), Brix.Platform.BusinessLayer.Controller.CurrentUser.CurrentUserDetail.UID, 0, true);

            // check if permissions to check is in allowed permissions.
            if (allowedPermissions.Count &lt; PermissionsToCheck.Count)
                return false;

            for (int i = 0; i &lt; PermissionsToCheck.Count; i++)
            {
                if (!allowedPermissions.Contains(PermissionsToCheck[i].ToLower()))
                    return false;
            }
            return true;
        }

        public override int GetProjectIdFromInstanceId()
        {
            if (DocId &gt; 0)
            {
                return DocumentManager.Instance.GetProjectIdFromDocumentId(DocId, FolderID);
            }

            else // return value coming from url
                return DocumentManager.Instance.GetProjectIdFromFolderId(FolderID);
        }

        protected override void OnInit(EventArgs e)
        {
            hdnBlockedFileTypes1.Value = AMP3ApplicationSettings.Instance.BlockedFileTypes;

            btnLinkDocument.Attributes.Add(&quot;onclick&quot;,
                string.Format(
                    &quot;return ShowDocumentsforLinking(&#39;{0}&#39;,&#39;{1}&#39;,&#39;{2}&#39;,&#39;{3}&#39;,&#39;{4}&#39;,&#39;{5}&#39;,&#39;{6}&#39;, &#39;{7}&#39;, &#39;{8}&#39;, &#39;{9}&#39;);&quot;,
                    btnLinkDocument.ClientID, grdAllDocuments.ClientID, trNewDocument.ClientID,
                    trLinkDocument.ClientID, btnGhostLoadDocument.ClientID, trDocWorkflow.ClientID,
                    null, hdnIsTemplate.ClientID, trIsTemplate.ClientID, divMetadata.ClientID));


            UserDetail ud = UserDetail.GetCurrentUserDetail();
            try
            {
                //Setting the controller for the multi upload
                docMultiUpload.UploadController = &quot;/api/DocumentsUpload/UploadFile?FID={0}&amp;PID={1}&amp;IID={2}&amp;MID={3}&amp;UID={4}&amp;UName={5}&quot;
                    .Format2(
                        UIHelper.UrlEncode(Request.QueryString[&quot;FID&quot;]), UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;]),
                        UIHelper.UrlEncode(Request.QueryString[&quot;IID&quot;]), UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;]),
                        ud.UID
                        ,
                        (ud.FirstName + (string.IsNullOrEmpty(ud.MiddleName) ? &quot;&quot; : &quot; &quot; + ud.MiddleName) +
                         (string.IsNullOrEmpty(ud.LastName) ? &quot;&quot; : &quot; &quot; + ud.LastName))
                    );

                docMultiUpload.OnSuccessScript = &quot;DocumentUploaded&quot;;
                docMultiUpload.OnCompleteScript = &quot;AllDocumentsUploaded&quot;;
                docMultiUpload.OnBeforeUploadScript = &quot;DocMultiUploadOnBeforeUploadScript&quot;;
                docMultiUpload.OnFileSelectScript = &quot;DocumentSelected&quot;;
                docMultiUpload.OnFileRemoveScript = &quot;DocumentRemoved&quot;;
            }
            catch (Exception ex)
            {
                //lblerrormsg.Text = ex.Message;
                ShowError(ex.Message);
            }

            try
            {
                uploadify.UploadController = &quot;/Modules/DOCMGMT/DocumentUploadHandler.ashx?FID={0}&amp;PID={1}&amp;IID={2}&amp;MID={3}&amp;UID={4}&amp;UName={5}&quot;
                    .Format2(
                       UIHelper.UrlEncode(Request.QueryString[&quot;FID&quot;]), UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;]),
                       UIHelper.UrlEncode(Request.QueryString[&quot;IID&quot;]), UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;]),
                        ud.UID,
                        (ud.FirstName + (string.IsNullOrEmpty(ud.MiddleName) ? &quot;&quot; : &quot; &quot; + ud.MiddleName) +
                         (string.IsNullOrEmpty(ud.LastName) ? &quot;&quot; : &quot; &quot; + ud.LastName))
                    );


                uploadify.AutomaticUpload = false;
                uploadify.OnFileSelectScript = &quot;MultiUploadifyOnFileSelectScript&quot;;
                uploadify.OnFileRemoveScript = &quot;MultiUploadifyOnFileRemoveScript&quot;;
                uploadify.OnUploadStartScript = &quot;UploadStartUploadify&quot;;
                uploadify.onQueueCompleteScript = &quot;AllDocumentsUploadedUploadify&quot;;
                uploadify.OnUploadSuccessfulScript = &quot;DocumentUploadedUploadify&quot;;
                uploadify.UploadButtonImage = &quot;/Images/uploadButton.png&quot;;
            }
            catch (Exception ex)
            {
                ShowError(ex.Message);
            }

            try
            {
                //Setting the controller for the multi upload excel
                docMultiUploadExcel.UploadController = &quot;/api/DocumentsUpload/MetaDataExcelValidate?FID={0}&amp;PID={1}&amp;IID={2}&amp;MID={3}&amp;UID={4}&amp;UName={5}&quot;
                    .Format2(
                        UIHelper.UrlEncode(Request.QueryString[&quot;FID&quot;]), UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;]), UIHelper.UrlEncode(Request.QueryString[&quot;IID&quot;]),
                        UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;]),
                        ud.UID,
                        (ud.FirstName + (string.IsNullOrEmpty(ud.MiddleName) ? &quot;&quot; : &quot; &quot; + ud.MiddleName) +
                         (string.IsNullOrEmpty(ud.LastName) ? &quot;&quot; : &quot; &quot; + ud.LastName))
                    );

                docMultiUploadExcel.OnBeforeUploadScript = &quot;MultiUploadExcelBeforeUploadScript&quot;;
                docMultiUploadExcel.OnSuccessScript = &quot;MultiUploadExcelOnSuccessScript&quot;;
                docMultiUploadExcel.OnFileSelectScript = &quot;MultiUploadExcelFileSelectScript&quot;;
                docMultiUploadExcel.OnFileRemoveScript = &quot;MultiUploadExcelFileRemoveScript&quot;;
                docMultiUploadExcel.AllowMultiple = false;
            }
            catch (Exception ex)
            {
                //lblerrormsg.Text = ex.Message;
                ShowError(ex.Message);
            }
            try
            {
                uploadifyExcel.UploadController = &quot;/Modules/DOCMGMT/MetadataExcelValidationHandler.ashx?FID={0}&amp;PID={1}&amp;IID={2}&amp;MID={3}&amp;UID={4}&amp;UName={5}&quot;
                    .Format2(
                        UIHelper.UrlEncode(Request.QueryString[&quot;FID&quot;]), UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;]),
                        UIHelper.UrlEncode(Request.QueryString[&quot;IID&quot;]), UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;]),
                        ud.UID,
                        (ud.FirstName + (string.IsNullOrEmpty(ud.MiddleName) ? &quot;&quot; : &quot; &quot; + ud.MiddleName) +
                         (string.IsNullOrEmpty(ud.LastName) ? &quot;&quot; : &quot; &quot; + ud.LastName))
                    );


                uploadifyExcel.AutomaticUpload = false;
                uploadifyExcel.OnFileSelectScript = &quot;MultiUploadifyExcelOnFileSelectScript&quot;;
                uploadifyExcel.OnFileRemoveScript = &quot;MultiUploadifyExcelOnFileRemoveScript&quot;;
                uploadifyExcel.OnUploadStartScript = &quot;MultiUploadifyExcelOnUploadStartScript&quot;;
                uploadifyExcel.OnUploadSuccessfulScript = &quot;MultiUploadifyExcelOnUploadSuccessfulScript&quot;;
                uploadifyExcel.UploadButtonImage = &quot;/Images/uploadButton.png&quot;;
                uploadifyExcel.Multi = false;
                //this stops the file from getting removed on upload success.
                uploadifyExcel.RemoveCompleted = false;
            }
            catch (Exception ex)
            {
                ShowError(ex.Message);
            }
            hdnCurLogInUser.Value = UserDetail.GetCurrentUserDetail().UID.ToString2();
            rddtAssociateDocs.NodeDataBound += rddtAssociateDocs_NodeDataBound;

            base.OnInit(e);
            SetManagerModel();
            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.OnInit(model, args);
        }

        private void SetManagerModel()
        {
            model = BrixFormModel.GetInstance(&quot;XDOCMGT&quot;, &quot;XDOCMGT&quot;, Request, Response);

            if (!string.IsNullOrEmpty(model.form.ManagerDLL) &amp;&amp; !string.IsNullOrEmpty(model.form.FormManagerClass))
            {
                managerModel = AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(model.form.ManagerDLL,
                    model.form.FormManagerClass);
            }
        }
        public override void InclueScriptAndStyleFiles()
        {
            base.InclueScriptAndStyleFiles();
            RegisterClientScriptInclude(&quot;~/Scripts/jquery.swipebox.min.js&quot;);
            RegisterClientScriptInclude(&quot;~/Scripts/Document.js&quot;);
          
        }
        protected void Page_Load(object sender, EventArgs e)
        {
            EnsureChildControls();

            //for disabling the Roles dropdown list
            UIHelper.DisableRoleSelection(Page);

            try
            {
                hdnHasViewOne.Value = (AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocumentViewer&quot;) &amp;&amp;
                                       AMP3ApplicationSettings.Instance.appSettings[&quot;DocumentViewer&quot;].ToUpper2() ==
                                       &quot;VIEWONE&quot;).ToString().ToLower();
                if (!Page.IsPostBack)
                {
                    trIsTemplate.Visible = MailMergeManager.IsMailMergeEnabled;
                    hdnIsTemplate.Value = trIsTemplate.Visible ? &quot;1&quot; : &quot;0&quot;;
                    if (Request.QueryString[&quot;Mode&quot;].ToString() == &quot;New&quot;)
                    {
                        txtdesc.Text = &quot;&quot;;
                    }
                }

                ShowPageControls();

                InitDocWorkflows();

                PopulateReviewDocuments();
            }
            catch (Exception ex)
            {
                ShowError(ex.Message);
            }


            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.OnPageLoad(model, args);
        }

        protected string selectedWorkflowId;

        private void InitDocWorkflows()
        {
            int selectedWF = 0;
            if (lstWorkflowsToAssociate.SelectedIndex &gt; 0)
            {
                selectedWorkflowId = lstWorkflowsToAssociate.Items[lstWorkflowsToAssociate.SelectedIndex].Value;
                selectedWF = lstWorkflowsToAssociate.SelectedIndex;
            }
            if (Page.IsCallback) return;
            EnableWorkflowNotesDialog(workflowAction_Click, &quot;XDOCMGT&quot;);
            MasterPage masterPage = Master.Master != null ? Master.Master : Master;
            if (null == appWorkflow) appWorkflow = (ApprovalWorkflow)masterPage.FindControl(&quot;appWorkflow&quot;);
            _Action = hdnAction.Value;
            //hdnAction.Value = &quot;&quot;;
            DataRow[] aWorkFlows;
            BrixWorkflowManager.Instance.GetAssociatedWorkflows(&quot;XDOCMGT&quot;, out aWorkFlows);
            if (null == aWorkFlows) return;

            lstWorkflowsToAssociate.Items.Clear();
            foreach (DataRow row in aWorkFlows)
            {
                ListItem item = new ListItem((string)row[&quot;Name&quot;], row[&quot;WorkflowGUID&quot;].ToString(), true);
                item.Attributes.Add(&quot;Title&quot;, (string)row[&quot;Description&quot;]);
                lstWorkflowsToAssociate.Items.Add(item);
            }

            lstWorkflowsToAssociate.Items.Insert(0, &quot;None&quot;);
            lstWorkflowsToAssociate.SelectedIndex = selectedWF;

            List&lt;string&gt; components =
                ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);
            if (components.Contains(&quot;AssociateWorkflowByDefault&quot;))
                optHasWorkflow.Checked = true;
        }

        protected void btnSaveDoc_Click(object sender, EventArgs e)
        {
            try
            {
                if (_Action == &quot;EditDocProp&quot;)
                {
                    if ((this.Page as BrixPageBase).xmlInjection != null)
                        (this.Page as BrixPageBase).xmlInjection.form.engine.IsNewMode = false;

                    //UltraGridRow GridRow = docgrid.DisplayLayout.SelectedRows[0];
                    //if (GridRow != null)
                    //{
                    int docid = 0;
                    //Call custom code and validate document metadata for file uniqueness if any.  
                    DocumentManager.Instance.ValidateMetadataForDocumentUniqueness(docid, ProjectID, this);


                    docid = Request.QueryString[&quot;DocId&quot;].ToInt32_2();
                    WorkflowEnabledForm form = new WorkflowEnabledForm();
                    form.FormName = &quot;XDOCMGT&quot;;
                    form.FormInstanceId = docid.ToString();
                    if (Request[&quot;MID&quot;] == &quot;PROJECT&quot; &amp;&amp; Request[&quot;PID&quot;].ToInt32_2() != 0)
                    {
                        form.ParentModuleId = Request[&quot;PID&quot;].ToInt32_2();
                    }
                    else if (Request[&quot;MID&quot;] == &quot;CONTMGT&quot; &amp;&amp; Request[&quot;IID&quot;].ToInt32_2() != 0)
                    {
                        form.ParentModuleId = Request[&quot;IID&quot;].ToInt32_2();
                    }
                    form.PID = ProjectID;
                    form.PostCancelRedirectUrl = PostCancelRedirectUrl;
                    form.SaveForm += SaveHandler;
                    form.GetRedirectUrlAfterSave += new PostSaveRedirectUrl(form_GetRedirectUrlAfterSave);


                    WorkflowEnabledSaveHandler(false, form);


                    Response.Redirect(form_GetRedirectUrlAfterSave(), true);
                    //}
                    //else
                    //    throw new Exception(&quot;Please select a record to edit.&quot;);
                }
                else
                {
                    //UltraGridRow GridRow = docgrid.DisplayLayout.SelectedRows[0];
                    //int docid = 0;
                    //if (GridRow != null &amp;&amp; GridRow.Cells.FromKey(&quot;DocId&quot;) != null) docid = GridRow.Cells.FromKey(&quot;DocId&quot;).Value.ToInt32_2();
                    string docIds = hdnDocumentIds.Value;
                    string DocumentNames = hdnDocumentNames.Value;
                    //The Auto incremented column is not working as expected because, FormInstanceId is set set above which renders the form in edit mode
                    //If the form is in edit mode, then the &lt;Auto Generated&gt; text is stored instead of evaluating the control. 

                    //Explicitly overring the mode, as form cannot determine the mode in case of injections
                    if ((this.Page as BrixPageBase).xmlInjection != null)
                        (this.Page as BrixPageBase).xmlInjection.form.engine.IsNewMode = true;

                    string[] ids = docIds.Split(new string[] { &quot;,&quot; }, StringSplitOptions.RemoveEmptyEntries);
                    string[] Names = DocumentNames.Split(new string[] { &quot;,&quot; }, StringSplitOptions.RemoveEmptyEntries);
                    for (int i = 0; i &lt; ids.Length; i++)
                    {
                        string docid = ids[i];
                        string DocName =
                            Names[i + 1].Split(new string[] { &quot;.&quot; }, StringSplitOptions.RemoveEmptyEntries)[0];


                        WorkflowEnabledForm form = new WorkflowEnabledForm();
                        form.FormName = &quot;XDOCMGT&quot;;
                        form.FormInstanceId = docid.ToString();
                        form.FormKey = DocName;


                        if (Request[&quot;MID&quot;] == &quot;PROJECT&quot; &amp;&amp; Request[&quot;PID&quot;].ToInt32_2() != 0)
                        {
                            form.ParentModuleId = Request[&quot;PID&quot;].ToInt32_2();
                        }
                        else if (Request[&quot;MID&quot;] == &quot;CONTMGT&quot; &amp;&amp; Request[&quot;IID&quot;].ToInt32_2() != 0)
                        {
                            form.ParentModuleId = Request[&quot;IID&quot;].ToInt32_2();
                        }
                        form.PID = ProjectID;
                        form.PostCancelRedirectUrl = PostCancelRedirectUrl;
                        form.SaveForm += SaveHandler;
                        form.GetRedirectUrlAfterSave += new PostSaveRedirectUrl(form_GetRedirectUrlAfterSave);

                        WorkflowEnabledSaveHandler(false, form);
                    }

                    if (hdnMetadataFileName.Value != &quot;&quot;)
                    {
                        DocumentManager.Instance.SaveExcelMetaData(docIds, Request[&quot;PID&quot;].ToInt32_2(), FolderID, hdnStorageFolderGuid.Value, hdnMetadataFileName.Value, this.Page);
                    }

                    if (docMultiUpload.ErrorMessagesList.Count() == 0)
                        Response.Redirect(
                            &quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; + Request.QueryString[&quot;FID&quot;].ToString() +
                            &quot;&amp;PID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;].ToString()) + &quot;&amp;IID=&quot; +
                            UIHelper.UrlEncode(Request.QueryString[&quot;IID&quot;].ToString()) + &quot;&amp;MID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;].ToString()), true);
                    else
                    {
                        docMultiUpload.ErrorMessagesList.ForEach(x =&gt; ShowError(x));
                        docMultiUpload.ClearErrorMessages();
                        ClearHiddenFields();
                    }
                }
            }
            catch (Exception ex)
            {
                ShowError(ex.Message);
            }
        }

        private void ClearHiddenFields()
        {
            hdnFilesToUploadInfo.Value = &quot;&quot;;
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            if (!string.IsNullOrEmpty(Request.QueryString[&quot;DMetadata&quot;]))
            {
                Response.Redirect(
                    &quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;FID&quot;].ToString()) + &quot;&amp;PID=&quot; +
                    UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;].ToString()) + &quot;&amp;IID=&quot; +
                    UIHelper.UrlEncode(Request.QueryString[&quot;IID&quot;].ToString()) + &quot;&amp;MID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;].ToString()) +
                    &quot;&amp;DMetadata=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;DMetadata&quot;].ToString()), true);
            }
            else
            {
                Response.Redirect(
                    &quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;FID&quot;].ToString()) + &quot;&amp;PID=&quot; +
                    UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;].ToString()) + &quot;&amp;IID=&quot; +
                    UIHelper.UrlEncode(Request.QueryString[&quot;IID&quot;].ToString()) + &quot;&amp;MID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;].ToString()), true);
            }
        }

        private string file;

        private string FormKey
        {
            get { return string.Format(&quot;Name: {0}, Description: {1}&quot;, Path.GetFileName(file), txtdesc.Text.Trim()); }
        }

        private bool SaveHandler(object sender, out string sSavedInstanceToken, out string sErrors,
            out string sRedirectTo)
        {
            sSavedInstanceToken = &quot;&quot;;
            if (sender is IWorkflowEnabled)
            {
                sSavedInstanceToken = (sender as IWorkflowEnabled).FormInstanceId;
                file = (sender as IWorkflowEnabled).FormKey;
            }

            sErrors = &quot;&quot;;
            sRedirectTo = &quot;&quot;;
            List&lt;string&gt; CheckComponents =
                Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);
            try
            {
                Page.Validate();
                if (Page.IsValid)
                {
                    UserDetail ud = UserDetail.GetCurrentUserDetail();
                    string uname = ud.UserName;
                    int uid = ud.UID;

                    XmlFormArgs args = new XmlFormArgs();
                    if (managerModel != null &amp;&amp; xmlEngine != null)
                        managerModel.BeforeSave(xmlEngine.model, args);
                    //passing brixform model for injection not for document template

                    string desc = txtdesc.Text.Trim().Replace(&quot;\r\n&quot;, &quot;|&quot;).ToString2();
                    if (_Action == &quot;Save&quot;)
                    {
                        if (CheckComponents.Contains(&quot;LogActivities&quot;))
                        {
                            string docName = HttpUtility.HtmlEncode(DocName);
                            if (string.IsNullOrEmpty(docName))
                                docName = file;
                            string fname =
                                HttpUtility.HtmlEncode(DocumentManager.Instance.GetFolderName(FolderID.ToInt32_2(),
                                    getDisplayName: true));
                            string message = string.Format(&quot;Uploaded document {0} to folder {1}.&quot;, docName, fname);
                            string activity = &quot;Added Document&quot;;
                            Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                            additionalParam.Add(&quot;FolderId&quot;, FolderID.ToString());
                            Dictionary&lt;string, object&gt; resultObject =
                                DocumentManager.Instance.GetLogMessage(sSavedInstanceToken.ToInt32_2(), &quot;Add&quot;,
                                    additionalParam);
                            if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                            {
                                message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                                activity = resultObject[&quot;activity&quot;].ToString();
                            }
                            DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, sSavedInstanceToken.ToInt32_2(),
                                String.Format(
                                    &quot;&lt;ACTION&gt;{4} &lt;/ACTION&gt; &lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt;  {1} &lt;/FOLDER&gt; &lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                                    docName, fname, FolderID, ProjectID, activity), message, userid);
                        }
                        DocumentManager.Instance.UpdateDocDetails(sSavedInstanceToken.ToInt32_2(), &quot;&quot;, desc, &quot;AL&quot;, -2,
                            chkIsTemplate.Checked);
                        if (lstWorkflowsToAssociate.SelectedIndex &gt; 0) // Other than &#39;None&#39;
                                                                       //!optNoWorkflow.Checked)
                        {
                            string sLog =
                                string.Format(
                                    &quot;Calling TriggerWorkflow!! {0} IsNew={1} bCreateNew={2} IsPostBack={3}, Is _WorkflowsInitiated Null ? {4}&quot;,
                                    &quot;XDOCMGT&quot;, IsNew, true, IsPostBack, _WorkflowsInitiated == null);
                            Utilities.LogToFile(AppConfig.LogFile(true), sLog, MethodBase.GetCurrentMethod());
                            string PID = ProjectID.ToString();
                            string ParentID = string.Empty;
                            if (Request[&quot;MID&quot;] == &quot;PROJECT&quot; &amp;&amp; Request[&quot;PID&quot;].ToInt32_2() != 0)
                                ParentID = Request[&quot;PID&quot;];
                            else if (Request[&quot;MID&quot;] == &quot;CONTMGT&quot; &amp;&amp; Request[&quot;IID&quot;].ToInt32_2() != 0)
                                ParentID = Request[&quot;IID&quot;];
                            if (lstWorkflowsToAssociate.SelectedIndex &gt; 0)
                                selectedWorkflowId = Request.Form[lstWorkflowsToAssociate.UniqueID];
                            if (!string.IsNullOrEmpty(selectedWorkflowId) &amp;&amp;
                                string.IsNullOrEmpty(BrixWorkflowManager.Instance.IsWorkflowAssociated(&quot;XDOCMGT&quot;,
                                    sSavedInstanceToken)))
                                //if workflow selected and if workflow is not attached, then create workflow mapping.
                                _WorkflowsInitiated =
                                    BrixWorkflowManager.Instance.TriggerWorkflow(TriggerPoint.TriggerActions[0],
                                        &quot;XDOCMGT&quot;, PID, ParentID, selectedWorkflowId, sSavedInstanceToken);
                        }
                        AssociateWorkflow(sender, sSavedInstanceToken);
                        (sender as WorkflowEnabledForm).FormKey = this.FormKey;
                        //Save Manual association if any.
                        if (!string.IsNullOrEmpty(rddtAssociateDocs.SelectedValue) &amp;&amp;
                            rddtAssociateDocs.SelectedValue != &quot;0&quot;)
                        {
                            DocumentManager.Instance.CreateAssociation(
                                Convert.ToInt32(rddtAssociateDocs.SelectedValue), String.Empty,
                                sSavedInstanceToken.ToInt32_2(), Convert.ToInt32(lstAssociationType.Value),
                                ProjectID.ToInt32_2());
                        }


                        return true;
                    }
                    else
                    {
                        if (lstWorkflowsToAssociate.SelectedIndex &gt; 0)
                        {
                            string sLog =
                                string.Format(
                                    &quot;Calling TriggerWorkflow!! {0} IsNew={1} bCreateNew={2} IsPostBack={3}, Is _WorkflowsInitiated Null ? {4}&quot;,
                                    &quot;XDOCMGT&quot;, IsNew, true, IsPostBack, _WorkflowsInitiated == null);
                            Utilities.LogToFile(AppConfig.LogFile(true), sLog, MethodBase.GetCurrentMethod());
                            string PID = ProjectID.ToString();
                            string ParentID = string.Empty;
                            if (Request[&quot;MID&quot;] == &quot;PROJECT&quot; &amp;&amp; Request[&quot;PID&quot;].ToInt32_2() != 0)
                                ParentID = Request[&quot;PID&quot;];
                            else if (Request[&quot;MID&quot;] == &quot;CONTMGT&quot; &amp;&amp; Request[&quot;IID&quot;].ToInt32_2() != 0)
                                ParentID = Request[&quot;IID&quot;];
                            if (lstWorkflowsToAssociate.SelectedIndex &gt; 0)
                                selectedWorkflowId = Request.Form[lstWorkflowsToAssociate.UniqueID];
                            if (!string.IsNullOrEmpty(selectedWorkflowId))
                                _WorkflowsInitiated =
                                    BrixWorkflowManager.Instance.TriggerWorkflow(TriggerPoint.TriggerActions[0],
                                        &quot;XDOCMGT&quot;, PID, ParentID, selectedWorkflowId, sSavedInstanceToken);
                        }

                        file = DocName;
                        string frm = sender is IWorkflowEnabled
                            ? ((IWorkflowEnabled)sender).FormInstanceId
                            : (string)sender;
                        DocumentManager.Instance.UpdateDocDetails(frm.ToInt32_2(), &quot;&quot;, desc, &quot;UL&quot;, LinkID,
                            chkIsTemplate.Checked);

                        //Update the removed associations
                        var selectedDocId = Convert.ToInt32(hdnEditDocId.Value);
                        DataSet ds = new DataSet();
                        //get all the associations for the doc being edited.
                        ds = DocumentManager.Instance.GetAssociatedDocs(selectedDocId);

                        DataTable associationToBeRemoved = new DataTable();
                        associationToBeRemoved.Columns.Add(&quot;MasterDocId&quot;, typeof(int));
                        associationToBeRemoved.Columns.Add(&quot;AssociatedDocId&quot;, typeof(int));

                        foreach (DataRow r in ds.Tables[0].Rows)
                        {
                            var docid = r[&quot;DocId&quot;].ToString();
                            //Check if the association is deleted from the grid. (soft delete done on click of &#39;remove association&#39;)
                            UltraGridRow Row =
                                ug_AssociatedDocs.Rows.OfType&lt;UltraGridRow&gt;()
                                    .ToList()
                                    .Find(
                                        row =&gt;
                                            row.Cells.FromKey(&quot;DocId&quot;)
                                                .Value.ToString()
                                                .Equals(docid, StringComparison.CurrentCultureIgnoreCase));
                            if (Row == null) //row is removed
                            {
                                var associationType = r[&quot;AssociationType&quot;].ToString();
                                //AssociationType
                                if (associationType == &quot;Parent&quot;)
                                    associationToBeRemoved.Rows.Add(docid, selectedDocId);
                                else
                                    associationToBeRemoved.Rows.Add(selectedDocId, docid);
                            }
                        }

                        DocumentManager.Instance.DeleteSelectedAssociationsForDocument(associationToBeRemoved);

                        //Log Edit action on Document
                        if (CheckComponents.Contains(&quot;LogActivities&quot;))
                        {
                            string fname =
                                HttpUtility.HtmlEncode(
                                    DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                                        getDisplayName: true));
                            string message = &quot;Edited properties&quot;;
                            string activity = &quot;Edit properties&quot;;
                            var docid = Request.QueryString[&quot;DocId&quot;].ToInt32_2();
                            Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                            additionalParam.Add(&quot;FolderId&quot;, FolderID.ToString());
                            Dictionary&lt;string, object&gt; resultObject = DocumentManager.Instance.GetLogMessage(docid,
                                &quot;Edit&quot;, additionalParam);

                            if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                            {
                                message = resultObject[&quot;message&quot;].ToString();
                                activity = resultObject[&quot;activity&quot;].ToString();
                            }

                            DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docid,
                                String.Format(
                                    &quot;&lt;ACTION&gt;{4}&lt;/ACTION&gt; &lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt;&lt;FOLDER&gt;  {1}&lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                                    DocName, fname, FolderID, ProjectID, activity), message);
                        }

                        sSavedInstanceToken = frm;
                        (sender as WorkflowEnabledForm).FormKey = this.FormKey;

                        return true;
                    }
                }
            }
            catch (Exception ex)
            {
                ShowError(ex.Message);
                sErrors = ex.Message;
            }
            return false;
        }

        public Guid? AssociateWorkflow(object sender, string sSavedInstanceToken)
        {
            if (lstWorkflowsToAssociate.SelectedIndex &gt; 0) // Other than &#39;None&#39;
                                                           //!optNoWorkflow.Checked)
            {
                string sLog =
                    string.Format(
                        &quot;Calling TriggerWorkflow!! {0} IsNew={1} bCreateNew={2} IsPostBack={3}, Is _WorkflowsInitiated Null ? {4}&quot;,
                        &quot;XDOCMGT&quot;, IsNew, true, IsPostBack, _WorkflowsInitiated == null);
                Utilities.LogToFile(AppConfig.LogFile(true), sLog, MethodBase.GetCurrentMethod());
                string PID = ProjectID.ToString();
                string ParentID = string.Empty;
                if (Request[&quot;MID&quot;] == &quot;PROJECT&quot; &amp;&amp; Request[&quot;PID&quot;].ToInt32_2() != 0)
                    ParentID = Request[&quot;PID&quot;];
                else if (Request[&quot;MID&quot;] == &quot;CONTMGT&quot; &amp;&amp; Request[&quot;IID&quot;].ToInt32_2() != 0)
                    ParentID = Request[&quot;IID&quot;];
                if (lstWorkflowsToAssociate.SelectedIndex &gt; 0)
                    selectedWorkflowId = Request.Form[lstWorkflowsToAssociate.UniqueID];
                if (!string.IsNullOrEmpty(selectedWorkflowId) &amp;&amp;
                    string.IsNullOrEmpty(BrixWorkflowManager.Instance.IsWorkflowAssociated(&quot;XDOCMGT&quot;,
                        sSavedInstanceToken)))
                    //if workflow selected and if workflow is not attached, then create workflow mapping.
                    _WorkflowsInitiated = BrixWorkflowManager.Instance.TriggerWorkflow(TriggerPoint.TriggerActions[0],
                        &quot;XDOCMGT&quot;, PID, ParentID, selectedWorkflowId, sSavedInstanceToken);
            }
            return (_WorkflowsInitiated != null &amp;&amp; _WorkflowsInitiated.Count &gt; 0)
                ? (Guid?)_WorkflowsInitiated[0]
                : null;
        }

        private static void WorkFlowValidation(int docid, string Action)
        {
            // Find if any WF is attached. If attached find the current stage and if it is editable, if editable check stake holders.
            //If the logged in user has got rights to edit in the current stage allow to check out, or else throw error.

            //Pass form instance id as doc id and check if wf is associated.
            string sGuid = BrixWorkflowManager.Instance.IsWorkflowAssociated(&quot;XDOCMGT&quot;, docid.ToString());
            if (!String.IsNullOrEmpty(sGuid))
            {
                //get the current state if WF exists
                Guid newGuid = Guid.Empty;
                DataTable dt = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(docid.ToString(), &quot;XDOCMGT&quot;);

                if (Boolean.Parse(dt.Rows[0][&quot;IsCompleted&quot;].ToString()))
                {
                    throw new Exception(
                        &quot;One or more records are already in the end stage of the workflow. Cannot do any more modifications. &quot;);
                }
                else
                {
                    IState state = BrixWorkflowManager.Instance.GetCurrentState(new Guid(sGuid), ref newGuid);

                    // get form stages visibility for this stage [workflow Section is a stage in xmlform]
                    Sections sections =
                        Sections.DeserializeSections(
                            HttpContext.Current.Server.UrlDecode(
                                (state as StateInfo).SectionDisplayInfo));
                    foreach (Aurigo.Common.Section sec in sections.Secs)
                    {
                        if (String.Compare(Action, &quot;checkin&quot;, true) == 0 ||
                            String.Compare(Action, &quot;checkout&quot;, true) == 0)
                        {
                            if (sec.SectionName == &quot;Document&quot;)
                            {
                                if (String.Compare(sec.Visibility, &quot;edit&quot;, true) == 0) // allow check in;
                                {
                                    string[] stakeHolders = null == state.ActionsMustBePerformedBy
                                        ? null
                                        : state.ActionsMustBePerformedBy.Split(&#39;,&#39;);

                                    bool bHasRoleToPlay = false;

                                    foreach (string stakeHolderRole in stakeHolders)
                                    {
                                        bHasRoleToPlay =
                                            UserManager.Instance.IsUserRole(UserDetail.GetCurrentUserDetail().UID,
                                                UserManager.Instance.GetUsersRoleId(
                                                    stakeHolderRole));
                                        if (bHasRoleToPlay) break;
                                    }

                                    if (!bHasRoleToPlay)
                                    {
                                        throw new Exception(
                                            &quot;One or more records are in a workflow stage where modifications are not allowed.&quot;);
                                    }
                                }
                                else // dont allow;
                                {
                                    throw new Exception(&quot;The current workflow stage of the document does not allow &quot; +
                                                        Action + &quot; . &quot;);
                                }
                                break;
                            }
                        }
                    }
                }
            }
        }

        protected void lnkCheckIn_ServerClick(object sender, EventArgs e)
        {
            try
            {
                Page.Validate();
                if (Page.IsValid)
                {
                    string storageid = string.Empty;
                    string docname = string.Empty;
                    int docid = Request.QueryString[&quot;DocId&quot;].ToInt32_2();
                    DataTable dt =
                        ComponentHelper.Instance.ExecuteDataSet(DocumentStoredProcedure.usp_GetDocInformation, null,
                            Request.QueryString[&quot;DocId&quot;].ToInt32_2()).Tables[0];
                    foreach (DataRow row in dt.Rows)
                    {
                        storageid = row[&quot;StorageId&quot;].ToString();
                        docname = row[&quot;DocName&quot;].ToString();
                    }
                    string filepath = uploaddoc.PostedFile.FileName;
                    int indx = filepath.LastIndexOf(&quot;\\&quot;, StringComparison.CurrentCultureIgnoreCase);
                    string filename = filepath.Substring(indx + 1, filepath.Length - (indx + 1));
                    //if (filename.ToUpper2() != docname.ToUpper2())
                    //    throw new Exception(&quot;Document name should be {0}. Request denied.&quot;.Format2(docname));

                    //Pass docid to validateFileName method, in customized way.
                    string validationErrorMessage = DocumentManager.Instance.ValidateFileNameForCheckIn(docid, docname,
                        filename);

                    if (!string.IsNullOrEmpty(validationErrorMessage))
                        throw new Exception(validationErrorMessage);

                    //Get list of forbidden extensions from web.config
                    if (ConfigurationManager.AppSettings[&quot;ForbiddenFileExtns&quot;] != null)
                    {
                        string[] lstExtensions =
                            ConfigurationManager.AppSettings[&quot;ForbiddenFileExtns&quot;].ToString().Split(&#39;,&#39;);
                        if (lstExtensions.Contains(filepath.Split(&#39;.&#39;).Last().ToUpper()))
                            throw new Exception(
                                &quot;The selected file is an executable file. For security reasons, this type of file is not allowed to be uploaded.&quot;);
                    }

                    int nfilelength = uploaddoc.PostedFile.ContentLength;
                    var filebytes = new byte[nfilelength];
                    uploaddoc.PostedFile.InputStream.Read(filebytes, 0, nfilelength);

                    UserDetail ud = UserDetail.GetCurrentUserDetail();

                    //Check if the current document is &#39;xref&#39; associated with a Master file, if so checkout-checkin master file  
                    //and if master file is already checked out do no allow to check in xref also.

                    bool result = DocumentManager.Instance.CheckIn(Request.QueryString[&quot;FID&quot;].ToInt32_2(), storageid,
                        txtdesc.Text, filename, filebytes, ud.UID, ud.UserName, ProjectID.ToInt32_2());
                    if (result)
                    {
                        //Update XML injection if exists
                        BrixFormModel model = ProjectManager.Instance.GetProjectMetadataXMLModel(ProjectID.ToInt32_2());
                        if (model != null)
                        {
                            BrixPageBase_SaveXMLInjectionData(sender, e);
                        }

                        List&lt;string&gt; CheckComponents =
                            Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(
                                Constants.MODID_DOCMGMT);

                        //Log Document checkin activity
                        if (CheckComponents.Contains(&quot;LogActivities&quot;))
                        {
                            string fname =
                                HttpUtility.HtmlEncode(DocumentManager.Instance.GetFolderName(FolderID,
                                    getDisplayName: true));
                            string message = string.Format(&quot;Checked In document {0} in folder {1}.&quot;, docname, fname);
                            ;
                            string activity = &quot;Checked in Document&quot;;


                            Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                            additionalParam.Add(&quot;FolderId&quot;, FolderID.ToString());
                            Dictionary&lt;string, object&gt; resultObject = DocumentManager.Instance.GetLogMessage(docid,
                                &quot;CheckedIn&quot;, additionalParam);

                            if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                            {
                                message = resultObject[&quot;message&quot;].ToString();
                                activity = resultObject[&quot;activity&quot;].ToString();
                            }

                            DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docid,
                                String.Format(
                                    &quot;&lt;ACTION&gt;{4}&lt;/ACTION&gt; &lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt;&lt;FOLDER&gt;  {1}&lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                                    DocName, fname, FolderID, ProjectID, activity), message);
                        }
                        // Send Notification Email.
                        List&lt;string&gt; docComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);
                        List&lt;string&gt; permissions =
                            Aurigo.AMP3.DocumentManagementBL.DocumentManager.Instance.GetPermissions(
                                Request.QueryString.Get(&quot;PID&quot;).ToInt32_2(), FolderID);
                        if (docComponents.Contains(&quot;DocumentCheckInNotification&quot;) &amp;&amp;
                            permissions.Contains(&quot;DocumentCheckInNotification&quot;))
                        {
                            //var FolderId = GridRow.Cells.FromKey(&quot;FolderId&quot;).Value.ToInt32_2();
                            DocumentManager.Instance.SendDocumentCheckInNotification(docid, docname,
                                HttpUtility.HtmlEncode(
                                    DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                                        getDisplayName: true)), ProjectID);
                        }

                        if (!string.IsNullOrEmpty(Request.QueryString[&quot;DMetadata&quot;]))
                        {
                            Response.Redirect(
                                &quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; +
                                Request.QueryString[&quot;FID&quot;].ToString() + &quot;&amp;PID=&quot; + Request.QueryString[&quot;PID&quot;].ToString() +
                                &quot;&amp;IID=&quot; +
                                Request.QueryString[&quot;IID&quot;].ToString() + &quot;&amp;MID=&quot; + Request.QueryString[&quot;MID&quot;].ToString() +
                                &quot;&amp;DMetadata=&quot; + Request.QueryString[&quot;DMetadata&quot;].ToString(), false);
                        }
                        else
                        {
                            Response.Redirect(
                                &quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; +
                                Request.QueryString[&quot;FID&quot;].ToString() + &quot;&amp;PID=&quot; + Request.QueryString[&quot;PID&quot;].ToString() +
                                &quot;&amp;IID=&quot; +
                                Request.QueryString[&quot;IID&quot;].ToString() + &quot;&amp;MID=&quot; + Request.QueryString[&quot;MID&quot;].ToString(),
                                false);
                        }
                    }
                    else
                        //lblerrormsg.Text = &quot;Error in Check In Document.&quot;;
                        ShowError(&quot;Error in Check In Document.&quot;);
                }
            }
            catch (Exception ex)
            {
                //lblerrormsg.Text = ex.Message;
                ShowError(ex.Message);
                ShowPageControls();
            }
        }

        protected void btnAssociatedDocuments_Click(object sender, EventArgs e)
        {
            var selectedDocId = Convert.ToInt32(hdnEditDocId.Value);
            BindAssociationGrid(selectedDocId);

            DataSet ds = DocumentManager.Instance.GetMissingAssociatedDocs(selectedDocId);
            if (ds.Tables[0].Rows.Count &gt; 0)
            {
                tblMissingAssociatedDocs.Style[&quot;display&quot;] = &quot;block&quot;;
                tblNoMissingAssociatedDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                ug_MissingassociatedDocs.DataSource = ds;
                ug_MissingassociatedDocs.DataBind();
                SetMissingAssociatedDocGridColumns();
            }
            else
            {
                tblMissingAssociatedDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                tblNoMissingAssociatedDocs.Style[&quot;display&quot;] = &quot;block&quot;;
            }
        }

        private DataSet BindAssociationGrid(int selectedDocId)
        {
            DataSet ds = new DataSet();
            ds = DocumentManager.Instance.GetAssociatedDocs(selectedDocId);
            if (ds.Tables[0].Rows.Count &gt; 0)
            {
                tblAssociatedDocs.Style[&quot;display&quot;] = &quot;block&quot;;
                tblNoAssociatedDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                ug_AssociatedDocs.DataSource = ds;
                ug_AssociatedDocs.DataBind();
                ug_AssociatedDocs.DisplayLayout.AllowUpdateDefault = AllowUpdate.Yes;
                ug_AssociatedDocs.DisplayLayout.CellClickActionDefault = CellClickAction.CellSelect;
                SetAssociatedDocGridColumns();

                foreach (UltraGridRow row in ug_AssociatedDocs.Rows)
                {
                    //Need to check permission on folder for each documents as it can be from different folders.
                    var AssociatedDocFolderID = Convert.ToInt32(row.Cells.FromKey(&quot;FolderId&quot;).Text);
                    var aPermissions = DocumentManagementBL.DocumentManager.Instance.GetPermissions(ProjectID,
                        AssociatedDocFolderID);


                    if (aPermissions.Contains(&quot;ViewD&quot;) &amp;&amp;
                        AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocumentViewer&quot;) &amp;&amp;
                        AMP3ApplicationSettings.Instance.appSettings[&quot;DocumentViewer&quot;].ToUpper2() == &quot;VIEWONE&quot;)
                    {
                        string docName = row.Cells.FromKey(&quot;DocName&quot;).Text;
                        string docId = row.Cells.FromKey(&quot;DocId&quot;).Text;
                        var storageId = row.Cells.FromKey(&quot;StorageId&quot;).Text;
                        var ver = row.Cells.FromKey(&quot;VersionNumber&quot;).Text;
                        row.Cells.FromKey(&quot;DocName&quot;).Value =
                            &quot;&lt;a href=&#39;javascript:void(0)&#39; title=&#39;{3}&#39; onclick=&#39;javascript:OpenVersionInViewOne(\&quot;{0}\&quot;,\&quot;{1}\&quot;,\&quot;{2}\&quot;,\&quot;{3}\&quot;)&#39;&gt;{4}&lt;/a&gt;&quot;
                                .Format2(storageId, docId, ver, ProjectID, docName);
                    }

                    string folderPath = row.Cells.FromKey(&quot;Folder&quot;).Value.ToString();
                    if (aPermissions.Contains(&quot;ViewF&quot;) &amp;&amp; !string.IsNullOrEmpty(folderPath))
                    {
                        Folder fld = DocumentManager.Instance.GetFolderDetails(AssociatedDocFolderID);
                        int iid = string.IsNullOrEmpty(fld.InstanceId) ? 0 : fld.InstanceId.ToInt32_2();
                        string location =
                            ResolveUrl(
                                string.Format(
                                    &quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID={0}&amp;PID={1}&amp;IID={2}&amp;MID={3}&quot;,
                                    AssociatedDocFolderID, ProjectID, iid, fld.ModuleId));

                        row.Cells.FromKey(&quot;Folder&quot;).Value = &quot;&lt;a href=&#39;&quot; + location + &quot;&#39;  style=&#39;color: blue&#39;&gt;&quot; +
                                                            folderPath + &quot;&lt;/a&gt;&quot;;
                    }
                }
            }
            else
            {
                tblAssociatedDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                tblNoAssociatedDocs.Style[&quot;display&quot;] = &quot;block&quot;;
            }
            return ds;
        }

        #region Link Documents

        protected void btnLoadDocuments_Click(object sender, EventArgs e)
        {
            BindFolderDropdownTree(Request.QueryString[&quot;MID&quot;], Request.QueryString[&quot;FID&quot;].ToInt32_2());
        }

        private void BindFolderDropdownTree(string moduleId, int folderId)
        {
            int instanceId = Request.QueryString[&quot;PID&quot;].ToInt32_2();
            string strProjectDocument = string.Empty,
                strEstimteDocument = string.Empty,
                strContractDocument = string.Empty;

            strProjectDocument = ConfigurationManager.AppSettings[&quot;HideProjectTree&quot;].ToUpper() == &quot;TRUE&quot; ? &quot;&quot; : &quot;YES&quot;;

            List&lt;string&gt; projectComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_ESTMATE);

            if (projectComponents.Contains(&quot;ShowEstimateDocuments&quot;))
            {
                strEstimteDocument = &quot;YES&quot;;
            }

            //Get documents in contract module if contMGT is enabled only.
            Dictionary&lt;string, string&gt; modules = ModuleManager.Instance.GetModuleList();
            if (modules.ContainsKey(&quot;CONTMGT&quot;))
            {
                strContractDocument = &quot;YES&quot;;
            }

            List&lt;string&gt; coreComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);

            string showSystemFolders = coreComponents.Contains(&quot;HideSystemFolderInTree&quot;) ? &quot;NO&quot; : &quot;YES&quot;;
            DataSet ds = DocumentManager.Instance.GetAllDocumentFolders(moduleId, instanceId,
                UserDetail.GetCurrentUserDetail().RID, strProjectDocument, strEstimteDocument, strContractDocument,
                showSystemFolders);

            DataRow datarw;
            rddtFolder.DataFieldID = &quot;ID&quot;;
            rddtFolder.DataFieldParentID = &quot;ParentID&quot;;
            rddtFolder.DataValueField = &quot;Value&quot;;
            rddtFolder.DataTextField = &quot;Text&quot;;
            rddtFolder.DataSource = ds;
            rddtFolder.DataBind();

            if (ds.Tables[0].Rows.Count != 0)
            {
                datarw = ds.Tables[0].Rows[0];

                if (datarw[&quot;Text&quot;] != null)
                {
                    rddtFolder.SelectedText = datarw[&quot;Text&quot;].ToString2();
                }
                else
                {
                    rddtFolder.SelectedText = LocalizationManager.GetString(&quot;Documents&quot;);
                }
            }
            if (!string.IsNullOrEmpty(rddtFolder.SelectedValue))
            {
                folderId = rddtFolder.SelectedValue.ToInt32_2();
            }
            BindDocGrid(folderId);
        }

        protected void btnFolderChanged_Click(object sender, EventArgs e)
        {
            grdAllDocuments.Rows.Clear();
            if (!string.IsNullOrEmpty(hdnSelectedFolderID.Value))
            {
                string[] items = hdnSelectedFolderID.Value.Split(&#39;-&#39;);
                int folderId = items[0].ToInt32_2();
                BindDocGrid(folderId);
                rddtFolder.SelectedText = hdnSelectedFolderID.Value.Remove(0, items[0].Length + 1);
            }
        }

        private void BindDocGrid(int folderId)
        {
            grdAllDocuments.Rows.Clear();
            if (Request.QueryString[&quot;FID&quot;].ToInt32_2() != folderId)
            {
                string iid = Request.QueryString[&quot;IID&quot;].ToString2();
                UserDetail ud = UserDetail.GetCurrentUserDetail();

                DataSet ds = LinksManager.Instance.GetAllPermittedDocumentsByFolder(folderId, 0, iid, ud.RID);
                grdAllDocuments.DataSource = ds.Tables[0].ToMWDateTime();
                grdAllDocuments.DataBind();
                grdAllDocuments.Columns.FromKey(&quot;CreatedDate&quot;).Header.Caption = &quot;Created On&quot;;
                grdAllDocuments.Columns.FromKey(&quot;LinkName&quot;).Header.Caption = &quot;Document Name&quot;;
                grdAllDocuments.Columns.FromKey(&quot;CreatedBy&quot;).Header.Caption = &quot;Created By&quot;;
                grdAllDocuments.Columns.FromKey(&quot;CreatedDate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
                grdAllDocuments.Columns.FromKey(&quot;LinkID&quot;).Hidden = true;
                grdAllDocuments.Columns.FromKey(&quot;DestID&quot;).Hidden = true;
                grdAllDocuments.Columns.FromKey(&quot;StorageId&quot;).Hidden = true;
                foreach (UltraGridColumn col in grdAllDocuments.Columns)
                {
                    col.HTMLEncodeContent = true;
                }
            }
        }

        protected void btnSaveLinkedDocument_Click(object sender, EventArgs e)
        {
            Page.Validate();
            if (Page.IsValid)
            {
                if (grdAllDocuments.DisplayLayout.SelectedRows.Count &gt; 0)
                {
                    CellsCollection cells = grdAllDocuments.DisplayLayout.SelectedRows[0].Cells;
                    int LinkID = cells.FromKey(&quot;LinkID&quot;).Value.ToInt32_2();
                    string DestID = cells.FromKey(&quot;DestID&quot;).Text;
                    string Description = string.IsNullOrEmpty(txtdesc.Text)
                        ? cells.FromKey(&quot;Title&quot;).Text
                        : txtdesc.Text;
                    string LinkName = cells.FromKey(&quot;LinkName&quot;).Text;
                    grdAllDocuments.DisplayLayout.SelectedRows.Clear();
                    string FID = Request[&quot;FID&quot;];
                    LinksManager.Instance.AddLinks(LinkName, ModuleInstanceID.ToString2(), ModuleID, DestID, &quot;DOCMGMT&quot;,
                        UserDetail.GetCurrentUserDetail().UserName, &quot;&quot;, Description,
                        FID.ToInt32_2());
                }

                Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; +
                                  Request.QueryString[&quot;FID&quot;].ToString() + &quot;&amp;PID=&quot; +
                                  Request.QueryString[&quot;PID&quot;].ToString() + &quot;&amp;IID=&quot; +
                                  Request.QueryString[&quot;IID&quot;].ToString() + &quot;&amp;MID=&quot; +
                                  Request.QueryString[&quot;MID&quot;].ToString());
            }
        }

        #endregion

        protected void ShowAssociateDocFields(object sender, EventArgs e)
        {
            BindAssociateDocDropdownTree();
            BindAssociatedTypeList();
        }

        private void BindAssociateDocDropdownTree()
        {
            //string moduleId = &quot;PROJECT&quot;;
            int instanceId = Request.QueryString[&quot;PID&quot;].ToInt32_2();
            var moduleId = Request.QueryString[&quot;MID&quot;].ToString();
            string strProjectDocument = string.Empty,
                strEstimteDocument = string.Empty,
                strContractDocument = string.Empty;

            strProjectDocument = ConfigurationManager.AppSettings[&quot;HideProjectTree&quot;].ToUpper() == &quot;TRUE&quot; ? &quot;&quot; : &quot;YES&quot;;

            List&lt;string&gt; projectComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_ESTMATE);

            if (projectComponents.Contains(&quot;ShowEstimateDocuments&quot;))
            {
                strEstimteDocument = &quot;YES&quot;;
            }

            Dictionary&lt;string, string&gt; modules = ModuleManager.Instance.GetModuleList();
            if (modules.ContainsKey(&quot;CONTMGT&quot;))
            {
                strContractDocument = &quot;YES&quot;;
            }
            List&lt;string&gt; coreComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);

            string showSystemFolders = coreComponents.Contains(&quot;HideSystemFolderInTree&quot;) ? &quot;NO&quot; : &quot;YES&quot;;

            DataSet ds = DocumentManager.Instance.GetAllDocumentsandFoldersWithRootFolder(moduleId, instanceId,
                UserDetail.GetCurrentUserDetail().RID, strProjectDocument, strEstimteDocument, strContractDocument,
                showSystemFolders);

            rddtAssociateDocs.DataFieldID = &quot;ID&quot;;
            rddtAssociateDocs.DataFieldParentID = &quot;ParentID&quot;;
            rddtAssociateDocs.DataValueField = &quot;DocID&quot;;
            rddtAssociateDocs.DataTextField = &quot;Name&quot;;
            rddtAssociateDocs.DataSource = ds;
            rddtAssociateDocs.DataBind();

            DataRow datarw;
            if (ds.Tables[0].Rows.Count != 0)
            {
                datarw = ds.Tables[0].Rows[0];
                //UploadFolder.SelectedValue = datarw[&quot;ID&quot;].ToString2();

                if (datarw[&quot;Name&quot;] != null)
                {
                    rddtAssociateDocs.SelectedText = datarw[&quot;Name&quot;].ToString2(); //&quot;Project Documents&quot;;
                }
                else
                {
                    rddtAssociateDocs.SelectedText = LocalizationManager.GetString(&quot;Documents&quot;);
                }
            }
        }

        private void BindAssociatedTypeList()
        {
            DataSet ds = DocumentManager.Instance.GetAllAssociationTypes();
            if (ds.Tables.Count &gt; 0 &amp;&amp; ds.Tables[0].Rows.Count &gt; 0)
            {
                var lst = from r in ds.Tables[0].AsEnumerable()
                          where r.Field&lt;string&gt;(&quot;AssociationType&quot;).ToUpper() != &quot;XREF&quot;
                          select r;

                lstAssociationType.DataSource = lst.CopyToDataTable();
                lstAssociationType.DataTextField = &quot;AssociationType&quot;;
                lstAssociationType.DataValueField = &quot;AssociationTypeId&quot;;
                lstAssociationType.DataBind();
            }
        }

        void rddtAssociateDocs_NodeDataBound(object sender, Telerik.Web.UI.DropDownTreeNodeDataBoundEventArguments e)
        {
            var IsFolder = Convert.ToBoolean(((DataRowView)e.DropDownTreeNode.DataItem)[&quot;IsFolder&quot;]);
            e.DropDownTreeNode.Value = (IsFolder) ? &quot;0&quot; : e.DropDownTreeNode.Value;
        }

        private void SetAssociatedDocGridColumns()
        {
            try
            {
                ug_AssociatedDocs.DisplayLayout.FrameStyle.Height = Unit.Pixel(180);
                ug_AssociatedDocs.DisplayLayout.FrameStyle.Width = Unit.Pixel(629);
                ug_MissingassociatedDocs.DisplayLayout.FrameStyle.BorderStyle = BorderStyle.None;
                ug_AssociatedDocs.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
                ug_AssociatedDocs.Columns.FromKey(&quot;DocName&quot;).Header.Caption = &quot;Document Name&quot;;
                ug_AssociatedDocs.Columns.FromKey(&quot;DocDesc&quot;).Header.Caption = &quot;Title&quot;;
                ug_AssociatedDocs.Columns.FromKey(&quot;DocType&quot;).Header.Caption = &quot;Type&quot;;
                ug_AssociatedDocs.Columns.FromKey(&quot;CheckedOutBy&quot;).Header.Caption = &quot;Checked Out To&quot;;
                ug_AssociatedDocs.Columns.FromKey(&quot;AssociatedDocumentPath&quot;).Hidden = true;
                ug_AssociatedDocs.Columns.FromKey(&quot;DocId&quot;).Hidden = true;
                ug_AssociatedDocs.Columns.FromKey(&quot;FolderId&quot;).Hidden = true;
                ug_AssociatedDocs.Columns.FromKey(&quot;StorageId&quot;).Hidden = true;
                ug_AssociatedDocs.Columns.FromKey(&quot;VersionNumber&quot;).Hidden = true;

                foreach (UltraGridColumn col in ug_AssociatedDocs.Columns)
                {
                    col.HTMLEncodeContent = true;
                }
            }
            catch (Exception ex)
            {
                throw new Exception(&quot;Documents Page Bind Grid &quot; + ex, ex);
            }
        }

        private void SetMissingAssociatedDocGridColumns()
        {
            try
            {
                ug_MissingassociatedDocs.DisplayLayout.FrameStyle.Height = Unit.Pixel(180);
                ug_MissingassociatedDocs.DisplayLayout.FrameStyle.BorderStyle = BorderStyle.None;
                ug_MissingassociatedDocs.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
                ug_MissingassociatedDocs.Columns.FromKey(&quot;AssociatedDocumentPath&quot;).Width = Unit.Pixel(629);
                ug_MissingassociatedDocs.Columns.FromKey(&quot;AssociatedDocumentPath&quot;).Header.Caption =
                    &quot;Associated Document Path&quot;;

                foreach (UltraGridColumn col in ug_MissingassociatedDocs.Columns)
                {
                    col.HTMLEncodeContent = true;
                }
            }
            catch (Exception ex)
            {
                throw new Exception(&quot;Documents Page Bind Grid &quot; + ex, ex);
            }
        }

        void FillWorkflowStageButtons(Guid gd, IState stage, ref StringBuilder buttonshtml)
        {
            if (null == stage) return;

            bool bGiveOpinion = BrixWorkflowManager.Instance.IsRoutedToUser(gd.ToString(), UserDetail.GetCurrentUserDetail().UID);
            string sScript = &quot;&quot;;
            string sButton = &quot;&quot;;
            if (bGiveOpinion)
            {
                sButton = AddActionToMenu(gd.ToString(), BrixWorkflowManager.GiveOpinion, &quot;Respond&quot;, ref sScript, &quot;Give Opinion&quot;,
                    &quot;Icn_Opinion.png&quot;);
                //script.Append(sScript);
                buttonshtml.Append(sButton);
            }

            bool bHasRoleToPlay = false;
            string[] stakeHolders = null == stage.ActionsMustBePerformedBy
                ? null
                : stage.ActionsMustBePerformedBy.Split(&#39;,&#39;);
            if (null != stakeHolders)
                foreach (string stakeHolderRole in stakeHolders)
                {
                    bHasRoleToPlay = UserManager.Instance.IsUserRole(UserDetail.GetCurrentUserDetail().UID,
                        UserManager.Instance.GetUsersRoleId(
                            stakeHolderRole));
                    if (bHasRoleToPlay) break;
                }
            if (!bHasRoleToPlay) return;
            //adding a property for adding or hiding ball in court in menu
            List&lt;string&gt; componentList = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
            if (componentList.Contains(&quot;ShowWorkflowBallIncourt&quot;))
            {
                if (!bGiveOpinion)
                {
                    sButton = AddActionToMenu(gd.ToString(), BrixWorkflowManager.RouteTo, &quot;Ball In Court&quot;, ref sScript, &quot;Get Opinion&quot;,
                        &quot;Icn_ballincourt_16.png&quot;);
                    //script.Append(sScript);
                    buttonshtml.Append(sButton);
                }
            }
            foreach (IAction action in stage.ActionButtons)
            {
                if (action is FormAction)
                {
                    FormAction frmAction = action as FormAction;
                    sButton = AddActionToMenu(gd.ToString(), action.InstanceId, action.ActionName, ref sScript,
                        action.ActionDisplayName, OnClientClick: frmAction.OnClientClick, isCommentsMandatory: frmAction.IsCommentsMandatory, checklistId: frmAction.AssociatedCheckList.ToInt32_2());
                }
                else
                {
                    sButton = AddActionToMenu(gd.ToString(), action.InstanceId, action.ActionName, ref sScript,
                        action.ActionDisplayName);
                }
                //script.Append(sScript);
                buttonshtml.Append(sButton);
            }
        }

        private string AddActionToMenu(string sWfInstanceId, string actionId, string actionName, ref string script,
            string toolTip = &quot;&quot;, string sIcon = &quot;Icn_Button.png&quot;,string OnClientClick=&quot;&quot;, bool isCommentsMandatory = false, int checklistId = 0)
        {
            script = &quot;&quot;;
            if (null == actionId) return &quot;&quot;;
            string frmActionJSON = $@&quot;{{onClientClickFunction:{(string.IsNullOrEmpty(OnClientClick) ? &quot;&#39;&#39;&quot; : OnClientClick)}, 
                                        isCommentsMandatory:{(isCommentsMandatory ? &quot;true&quot; : &quot;false&quot;)}, 
                                        associatedCheckList:{checklistId}}}&quot;;
            string menuButton =
                @&quot;&lt;a id=&quot;&quot;{0}_{1}_{2}&quot;&quot; title=&quot;&quot;{3}&quot;&quot; onclick=&quot;&quot;ShowWorkflowNotes(&#39;{0}_{1}_{2}&#39;, &#39;{4}&#39;, {6}); return false;&quot;&quot;
                                     href=&quot;&quot;javascript:btnSelected=this.id;&quot;&quot;&gt;
                                     &lt;SPAN&gt;&lt;IMG src=&quot;&quot;/Images/Officebar/{5}&quot;&quot;&gt;{2}&lt;/SPAN&gt;&lt;/A&gt;&quot;;
            menuButton = string.Format(menuButton, sWfInstanceId, actionId, actionName, toolTip, (actionId == &quot;RouteTo&quot;),
                sIcon, frmActionJSON);
            return menuButton;
        }

        private void workflowAction_Click(object sender, OkEventArgs e)
        {
            //UltraGridRow GridRow = docgrid.DisplayLayout.SelectedRows[0];
            //if (GridRow == null) throw new Exception(&quot;Please select a record.&quot;);
            int docid = Request.QueryString[&quot;DocId&quot;].ToInt32_2();
            WorkflowEnabledForm form = new WorkflowEnabledForm();
            form.FormName = &quot;XDOCMGT&quot;;
            form.FormInstanceId = docid.ToString();
            if (Request[&quot;MID&quot;] == &quot;PROJECT&quot; &amp;&amp; Request[&quot;PID&quot;].ToInt32_2() != 0)
            {
                form.ParentModuleId = Request[&quot;PID&quot;].ToInt32_2();
            }
            else if (Request[&quot;MID&quot;] == &quot;CONTMGT&quot; &amp;&amp; Request[&quot;IID&quot;].ToInt32_2() != 0)
            {
                form.ParentModuleId = Request[&quot;IID&quot;].ToInt32_2();
            }
            form.PID = ProjectID;
            form.PostCancelRedirectUrl = PostCancelRedirectUrl;
            form.SaveForm += SaveHandler;
            form.GetRedirectUrlAfterSave += new PostSaveRedirectUrl(form_GetRedirectUrlAfterSave);
            WorkflowActionClick(e, form);
        }

        string form_GetRedirectUrlAfterSave(string sSavedToken = &quot;&quot;)
        {
            return PostCancelRedirectUrl;
        }

        public string PostCancelRedirectUrl
        {
            get
            {
                if (!string.IsNullOrEmpty(Request.QueryString[&quot;DMetadata&quot;]))
                    return &quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; + Request.QueryString[&quot;FID&quot;].ToString() +
                           &quot;&amp;PID=&quot; + Request.QueryString[&quot;PID&quot;].ToString() + &quot;&amp;IID=&quot; +
                           Request.QueryString[&quot;IID&quot;].ToString() + &quot;&amp;MID=&quot; + Request.QueryString[&quot;MID&quot;].ToString() +
                           &quot;&amp;DMetadata=&quot; + Request.QueryString[&quot;DMetadata&quot;].ToString();
                else
                    return &quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; + Request.QueryString[&quot;FID&quot;].ToString() +
                           &quot;&amp;PID=&quot; + Request.QueryString[&quot;PID&quot;].ToString() + &quot;&amp;IID=&quot; +
                           Request.QueryString[&quot;IID&quot;].ToString() + &quot;&amp;MID=&quot; + Request.QueryString[&quot;MID&quot;].ToString();
            }
        }

        public HtmlGenericControl XMLContainterDiv
        {
            get { throw new NotImplementedException(); }
            set { throw new NotImplementedException(); }
        }

        public void HandleInjectionSaveException(object model, Exception ex, string parentFormInstanceId)
        {
        }

        public void HandleInjectionAfterSave(object model, string parentFormInstanceId)
        {
        }

        private void ShowPageControls()
        {
            if (Request.QueryString[&quot;Mode&quot;].ToString() == &quot;New&quot;)
            {
                PageTitle = &quot;New Document&quot;;
                btnDocOk.Style[&quot;display&quot;] = &quot;inline&quot;;
                btnCheckIn.Style[&quot;display&quot;] = &quot;none&quot;;
                btnLinkDocument.Style[&quot;display&quot;] = &quot;inline&quot;;
                trNewDocument.Style[&quot;display&quot;] = &quot;table-row&quot;;
                trLinkDocument.Style[&quot;display&quot;] = &quot;none&quot;;
                //txtdesc.Text = &quot;&quot;;
                trAssociatedDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                trDocDownloadLink.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trDocViewLink.Style.Add(&quot;display&quot;, &quot;none&quot;);
                aspPnlDoc.Style.Add(&quot;display&quot;, &quot;block&quot;);
                trReviewDocuments.Visible = false;

                ShowAssociateDocFields(new object(), new EventArgs());

                if (!DOCMGMTModuleComponents.Contains(&quot;AutoCadIntegration&quot;))
                {
                    trManuallyAssociateDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                    trDocAssn.Style[&quot;display&quot;] = &quot;none&quot;;
                }

                if (hdnIsTemplate.Value == &quot;1&quot;)
                {
                    trIsTemplate.Style[&quot;display&quot;] = &quot;table-row&quot;;
                }

                hdnViewType.Value = &quot;N&quot;;
                hdnAction.Value = &quot;Save&quot;;

                Page.ClientScript.RegisterStartupScript(this.GetType(), &quot;ShowViewN&quot;, &quot;$(document).ready(function(){ShowView(&#39;N&#39;)});&quot;, true);
            }
            else if (Request.QueryString[&quot;Mode&quot;].ToString() == &quot;Edit&quot;)
            {
                PageTitle = &quot;Edit Document&quot;;
                var docId = 0;
                var StorageId = string.Empty;
                var VersionNo = string.Empty;
                bool IsTemplate = false;

                DataTable dt = ComponentHelper.Instance.ExecuteDataSet(DocumentStoredProcedure.usp_GetDocInformation, null, Request[&quot;DocId&quot;].ToString()).Tables[0];

                foreach (DataRow row in dt.Rows)
                {
                    docId = row[&quot;DocId&quot;].ToInt32_2();
                    StorageId = row[&quot;StorageId&quot;].ToString();
                    VersionNo = row[&quot;VersionNo&quot;].ToString();
                    /*BUG 56228 :: Tile of the document will be initialized during page load....*/
                    if(!IsPostBack)
                        txtdesc.Text = row[&quot;DocDesc&quot;].ToString();
                    IsTemplate = row[&quot;IsTemplate&quot;].ToBoolean2();
                    DocName = row[&quot;DocName&quot;].ToString();
                    LinkID = row[&quot;LinkId&quot;].ToInt32_2();
                    DocType = row[&quot;DocType&quot;].ToString();
                    hdnStorageId.Value = row[&quot;StorageId&quot;].ToString();
                }

                btnDocOk.Style[&quot;display&quot;] = &quot;inline&quot;;
                btnCheckIn.Style[&quot;display&quot;] = &quot;none&quot;;

                if (hdnIsTemplate.Value == &quot;1&quot;)
                {
                    if (IsTemplate)
                        chkIsTemplate.Attributes.Add(&quot;checked&quot;, &quot;true&quot;);
                    else
                        chkIsTemplate.Attributes.Add(&quot;checked&quot;, &quot;false&quot;);
                    hdnDocName.Value = DocName;
                    int pos = DocName.LastIndexOf(&#39;.&#39;);

                    if (!(DocName.Substring(pos + 1) == &quot;doc&quot;) || !(DocName.Substring(pos + 1) == &quot;docx&quot;))
                    {
                        trIsTemplate.Style[&quot;display&quot;] = &quot;none&quot;;
                    }
                }

                hdnEditDocId.Value = docId.ToString();

                if (hdnIsTemplate.Value == &quot;1&quot;)
                    trIsTemplate.Style[&quot;display&quot;] = &quot;table-row&quot;;

                if (DOCMGMTModuleComponents.Contains(&quot;AutoCadIntegration&quot;))
                    trAssociatedDocs.Style[&quot;display&quot;] = &quot;table-row&quot;;
                else
                    trAssociatedDocs.Style[&quot;display&quot;] = &quot;none&quot;;

                if (hdnHasViewOne.Value == &quot;true&quot; &amp;&amp; hdnStorageId.Value != &quot;&quot;)
                    trDocViewLink.Visible = true;
                else
                    trDocViewLink.Visible = false;

                string sGuid = BrixWorkflowManager.Instance.IsWorkflowAssociated(&quot;XDOCMGT&quot;, Request.QueryString[&quot;DocId&quot;]);
                if (string.IsNullOrEmpty(sGuid)) //If Workflow is not attached, then show the workflow section
                    trDocWorkflow.Style[&quot;display&quot;] = &quot;table-row&quot;;
                else //Else the workflow section should be hidden
                    trDocWorkflow.Style.Add(&quot;display&quot;, &quot;none&quot;);

                btnLinkDocument.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trManuallyAssociateDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                trDocAssn.Style[&quot;display&quot;] = &quot;none&quot;;
                trNewDocument.Style.Add(&quot;display&quot;, &quot;none&quot;);
                //Showing the download links only in edit mode
                if (hdnStorageId.Value == &quot;&quot;)
                    trDocDownloadLink.Style[&quot;display&quot;] = &quot;none&quot;;
                else
                    trDocDownloadLink.Style[&quot;display&quot;] = &quot;table-row&quot;;
                trDocViewLink.Style[&quot;display&quot;] = &quot;table-row&quot;;
                aspPnlDoc.Style.Add(&quot;display&quot;, &quot;block&quot;);
                trReviewDocuments.Visible = true;

                hdnViewType.Value = &quot;E&quot;;
                hdnAction.Value = &quot;EditDocProp&quot;;

                //download link code
                string sPath = ConfigurationManager.AppSettings[&quot;SiteRoot&quot;];
                showDownloadLink.InnerHtml = sPath + &quot;Common/BrixListPage.aspx?context=DOCMGMT&amp;FID=&quot; +
                                             UIHelper.UrlEncode(Request.QueryString[&quot;FID&quot;].ToString())
                                             + &quot;&amp;PID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;].ToString())
                                             + &quot;&amp;IID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;IID&quot;].ToString())
                                             + &quot;&amp;MID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;].ToString())
                                             + &quot;&amp;DTD=&quot; + docId
                                             + &quot;&amp;Version=&quot; + UIHelper.UrlEncode(VersionNo);

                showViewLink.InnerHtml = sPath + &quot;ViewOne.aspx?DocID=&quot; + docId + &quot;&amp;ModuleID=&quot; +
                                         UIHelper.UrlEncode(Request.QueryString[&quot;MID&quot;]) + &quot;&amp;File=&quot; +
                                         UIHelper.UrlEncode(StorageId) + &quot;&amp;Version=&quot; +
                                         UIHelper.UrlEncode(VersionNo) + &quot;&amp;PID=&quot; + UIHelper.UrlEncode(Request.QueryString[&quot;PID&quot;]);

                //Call btnGhostShowAssociatedDocs.click postback event. to populate associated doc grid
                var selectedDocId = Convert.ToInt32(hdnEditDocId.Value);
                BindAssociationGrid(selectedDocId);

                DataSet ds = DocumentManager.Instance.GetMissingAssociatedDocs(selectedDocId);
                if (ds.Tables[0].Rows.Count &gt; 0)
                {
                    tblMissingAssociatedDocs.Style[&quot;display&quot;] = &quot;block&quot;;
                    tblNoMissingAssociatedDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                    ug_MissingassociatedDocs.DataSource = ds;
                    ug_MissingassociatedDocs.DataBind();
                    SetMissingAssociatedDocGridColumns();
                }
                else
                {
                    tblMissingAssociatedDocs.Style[&quot;display&quot;] = &quot;none&quot;;
                    tblNoMissingAssociatedDocs.Style[&quot;display&quot;] = &quot;block&quot;;
                }
                Page.ClientScript.RegisterStartupScript(this.GetType(), &quot;ShowViewE&quot;,
                    &quot;$(document).ready(function(){ShowView(&#39;E&#39;)});&quot;, true);
                ShowWorkflowButtons(Request.QueryString[&quot;DocId&quot;]);
                //dvWorkflowButtons.InnerHtml=&quot;Loading workflow actions...&quot;; 
                //RenderMetaDataHtml(&quot;Edit&quot;, Request.QueryString[&quot;DocId&quot;]);
            }
            else if (Request.QueryString[&quot;Mode&quot;].ToString() == &quot;CheckIn&quot;)
            {
                PageTitle = &quot;Checkin Document&quot;;

                btnDocOk.Style[&quot;display&quot;] = &quot;none&quot;;
                btnCheckIn.Style[&quot;display&quot;] = &quot;inline&quot;;
                trLinkDocument.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trNewDocument.Style[&quot;display&quot;] = &quot;table-row&quot;;
                trIsTemplate.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trAssociatedDocs.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trManuallyAssociateDocs.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trDocAssn.Style.Add(&quot;display&quot;, &quot;none&quot;);
                spnDesc.InnerText = &quot;Comments :&quot;;
                spnDesc.InnerHtml += &quot;&lt;span class=&#39;required&#39;&gt; *&lt;/span&gt;&quot;;
                trDocWorkflow.Style.Add(&quot;display&quot;, &quot;none&quot;);
                btnLinkDocument.Style.Add(&quot;display&quot;, &quot;none&quot;);
                //Hiding the download links while checkin in
                trDocDownloadLink.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trDocViewLink.Style.Add(&quot;display&quot;, &quot;none&quot;);
                aspPnlDoc.Style.Add(&quot;display&quot;, &quot;block&quot;);
                trReviewDocuments.Visible = true;
                //RenderMetaDataHtml(&quot;Edit&quot;, Request.QueryString[&quot;DocId&quot;]);
                hdnAction.Value = &quot;CheckIn&quot;;
                hdnViewType.Value = &quot;C&quot;;
                Page.ClientScript.RegisterStartupScript(this.GetType(), &quot;ShowViewC&quot;, &quot;$(document).ready(function(){ShowView(&#39;C&#39;)});&quot;, true);
            }
        }

        //private void RenderMetaDataHtml(string mode, string instanceID)
        //{
        //    BrixFormModel model = ProjectManager.Instance.GetProjectMetadataXMLModel(ProjectID);

        //    if (model != null)
        //    {
        //        model.form.instanceID = instanceID;
        //        divMetadata.Controls.Clear();
        //        XMLRenderingEngine xmlEngine = new XMLRenderingEngine(this, model, divMetadata);
        //        xmlEngine.Initialize();
        //        model.form.engine.Mode = mode;
        //        xmlEngine.Render(RenderFormat.RenderHtml);

        //    }

        //}

        private void ShowWorkflowButtons(string instanceID)
        {
            string sGuid = BrixWorkflowManager.Instance.IsWorkflowAssociated(&quot;XDOCMGT&quot;, instanceID);
            if (!String.IsNullOrEmpty(sGuid))
            {
                StringBuilder sButtonsHtml = new StringBuilder();
                Guid newGuid = Guid.Empty;
                IState state = BrixWorkflowManager.Instance.GetCurrentState(new Guid(sGuid), ref newGuid);
                if (newGuid != Guid.Empty) sGuid = newGuid.ToString();
                FillWorkflowStageButtons(new Guid(sGuid), state, ref sButtonsHtml);
                string html = @&quot;&lt;div id=&quot;&quot;buttons&quot;&quot;&gt;{1}&lt;/div&gt;&quot;;
                dvWorkflowButtons.InnerHtml = string.Format(html, &quot;&quot;, sButtonsHtml);
            }
        }

        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.OnPreRender(model, args);
        }

        public object[] ParentFormInstanceID
        {
            get
            {
                if (string.IsNullOrEmpty(Request.QueryString[&quot;DocId&quot;]))
                    return new object[] { 0 };
                else
                    return new object[] { Request.QueryString[&quot;DocId&quot;] };
            }
        }

        protected string GetSelectedItemsFromGrid(UltraWebGrid dg)
        {
            var ids = new StringBuilder();
            foreach (UltraGridRow ugr in dg.Rows)
            {
                if (ugr.Cells.FromKey(&quot;Multi&quot;).Value.ToString().Equals(&quot;true&quot;))
                {
                    if (ugr.Cells.FromKey(&quot;DocId&quot;).Value != null)
                        ids.AppendFormat(&quot;{0},&quot;, ugr.Cells.FromKey(&quot;DocId&quot;).Value);
                }
            }
            if (string.IsNullOrEmpty(ids.ToString()))
            {
                UltraGridRow SelRow = dg.DisplayLayout.ActiveRow;
                if (SelRow != null &amp;&amp; SelRow.Cells.FromKey(&quot;DocId&quot;).Value != null)
                    ids.AppendFormat(&quot;{0},&quot;, SelRow.Cells.FromKey(&quot;DocId&quot;).Value.ToString());
            }
            return ids.ToString().Trim(&#39;,&#39;);
        }

        protected void btnRemoveAssociation_Click(object sender, EventArgs e)
        {
            string selectdIds = GetSelectedItemsFromGrid(ug_AssociatedDocs);

            if (string.IsNullOrEmpty(selectdIds))
            {
                ScriptManager.RegisterStartupScript(this, this.GetType(), &quot;ShowError&quot;,
                    &quot;ShowError(&#39;Please select at least one association to be removed.&#39;)&quot;, true);
            }
            else
            {
                if (!selectdIds.EndsWith(&quot;,&quot;)) selectdIds += &quot;,&quot;;

                string[] selectedIdsArray = selectdIds.Split(&quot;,&quot;.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);

                foreach (var docid in selectedIdsArray)
                {
                    UltraGridRow toBeRemovedRow =
                        ug_AssociatedDocs.Rows.OfType&lt;UltraGridRow&gt;()
                            .ToList()
                            .Find(
                                row =&gt;
                                    row.Cells.FromKey(&quot;DocId&quot;)
                                        .Value.ToString()
                                        .Equals(docid, StringComparison.CurrentCultureIgnoreCase));
                    ug_AssociatedDocs.Rows.Remove(toBeRemovedRow);
                }
                //foreach (UltraGridRow row in ug_AssociatedDocs.Rows)
                //{
                //    if (selectedIdsArray.Contains(row.Cells.FromKey(&quot;DocId&quot;).Value.ToString()))
                //    {
                //        ug_AssociatedDocs.Rows.Remove(row);
                //    }
                //}
            }
        }

        /// &lt;summary&gt;
        /// Populates all the associated Review &amp; Consolidated documents for the selected document.
        /// Adds a download button as the last column.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void PopulateReviewDocuments()
        {
            var selectedDocId = DocId;

            DataTable dt = DocumentManager.Instance.GetAllReviewDocuments(selectedDocId);
            if (dt.Rows.Count &gt; 0)
            {
                tblReviewDocuments.Style[&quot;display&quot;] = &quot;block&quot;;
                tblNoReviewDocuments.Style[&quot;display&quot;] = &quot;none&quot;;
                uwgReviewDocuments.DataSource = dt;
                uwgReviewDocuments.DataBind();
                SetReviewDocumentsGridColumns();


                uwgReviewDocuments.Columns.Add(&quot;Download&quot;);
                UltraGridColumn colDownload = uwgReviewDocuments.Columns.FromKey(&quot;Download&quot;);
                colDownload.Header.Caption = &quot;Download&quot;;
                colDownload.Width = Unit.Pixel(80);
                colDownload.CellStyle.HorizontalAlign = HorizontalAlign.Center;

                Document doc = DocumentManager.Instance.ViewDocumentDetails(selectedDocId);
                List&lt;string&gt; permissions =
                    Aurigo.AMP3.DocumentManagementBL.DocumentManager.Instance.GetPermissions(
                        Request.QueryString.Get(&quot;PID&quot;).ToInt32_2(), doc.FolderId);

                if (permissions.Contains(&quot;ViewD&quot;) &amp;&amp; permissions.Contains(&quot;DownloadD&quot;))
                {
                }
                else
                {
                    uwgReviewDocuments.Columns.FromKey(&quot;Download&quot;).Hidden = true;
                }

                foreach (UltraGridRow row in uwgReviewDocuments.Rows)
                {
                    UltraGridCell cellDownload = row.Cells.FromKey(&quot;Download&quot;);
                    cellDownload.Value =
                        string.Format(
                            &quot;&lt;img src=&#39;/Images/Officebar/Icn_XMLImport.png&#39; onclick=&#39;javascript:DownloadDocumentWithAnnotation(\&quot;{0}\&quot;,\&quot;{1}\&quot;)&#39; /&gt;&quot;,
                            row.Cells.FromKey(&quot;DocId&quot;).Value.ToString(), row.Cells.FromKey(&quot;ID&quot;).Value.ToString());
                }
            }
            else
            {
                tblReviewDocuments.Style[&quot;display&quot;] = &quot;none&quot;;
                tblNoReviewDocuments.Style[&quot;display&quot;] = &quot;block&quot;;
            }

            string script = @&quot;toggleEditOverlay();&quot;;
            ScriptManager.RegisterStartupScript(this, this.GetType(), &quot;HideOverlay&quot;, script, true);
        }

        /// &lt;summary&gt;
        /// Sets properties for review documents grid
        /// &lt;/summary&gt;
        private void SetReviewDocumentsGridColumns()
        {
            UltraGridColumn colID = uwgReviewDocuments.Columns.FromKey(&quot;ID&quot;);
            if (colID != null)
                colID.Hidden = true;

            UltraGridColumn colDocId = uwgReviewDocuments.Columns.FromKey(&quot;DocId&quot;);
            if (colDocId != null)
                colDocId.Hidden = true;

            UltraGridColumn colDocName = uwgReviewDocuments.Columns.FromKey(&quot;DocumentName&quot;);
            if (colDocName != null)
            {
                colDocName.Header.Caption = &quot;File Name&quot;;
                colDocName.Width = new Unit(200, UnitType.Pixel);
            }

            UltraGridColumn colVersionNo = uwgReviewDocuments.Columns.FromKey(&quot;VersionNumber&quot;);
            if (colVersionNo != null)
                colVersionNo.Header.Caption = &quot;Version Number&quot;;

            UltraGridColumn colCreatedOn = uwgReviewDocuments.Columns.FromKey(&quot;CreatedOn&quot;);
            if (colCreatedOn != null)
            {
                colCreatedOn.Header.Caption = &quot;Reviewed On&quot;;
                colCreatedOn.Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
            }

            UltraGridColumn colCreatedBy = uwgReviewDocuments.Columns.FromKey(&quot;CreatedBy&quot;);
            if (colCreatedBy != null)
            {
                colCreatedBy.Header.Caption = &quot;Reviewed By&quot;;
                colCreatedBy.Width = new Unit(150, UnitType.Pixel);
            }

            foreach (UltraGridColumn col in uwgReviewDocuments.Columns)
            {
                col.HTMLEncodeContent = true;
            }
        }


        private bool skipDefaultXMLInjectionSave;

        public bool SkipDefaultXMLInjectionSave
        {
            get
            {
                if (hdnHasMetadataFile.Value == &quot;true&quot;)
                {
                    skipDefaultXMLInjectionSave = true;
                }
                return skipDefaultXMLInjectionSave;
            }
            set { skipDefaultXMLInjectionSave = value; }
        }

        private BrixFormModel GetMetadataXMLModel(int projectID)
        {
            if (string.IsNullOrEmpty(Request.QueryString[&quot;DMetadata&quot;]))
                return ProjectManager.Instance.GetProjectMetadataXMLModel(ProjectID.ToInt32_2());
            else
            {
                if (!string.IsNullOrEmpty(Request.QueryString[&quot;DMetadata&quot;]))
                    return new BrixFormModel(Request.QueryString[&quot;DMetadata&quot;], Request.QueryString[&quot;DMetadata&quot;] + &quot;.xml&quot;,
                        Brix.Platform.BusinessLayer.XmlForm_Framework.XMLType.Control);
                return null;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[38,9,38,64,1],[39,9,39,62,1],[46,9,46,49,1],[50,17,50,18,0],[50,19,50,70,0],[50,71,50,72,0],[55,17,55,18,1],[55,19,55,96,1],[55,97,55,98,1],[60,17,60,18,1],[60,19,60,96,1],[60,97,60,98,1],[65,17,65,18,0],[65,19,65,96,0],[65,97,65,98,0],[70,17,70,18,0],[70,19,70,55,0],[70,56,70,57,0],[71,17,71,18,0],[71,19,71,44,0],[71,45,71,46,0],[76,17,76,18,0],[76,19,76,57,0],[76,58,76,59,0],[77,17,77,18,0],[77,19,77,58,0],[77,59,77,60,0],[82,17,82,18,1],[82,19,82,54,1],[82,55,82,56,1],[83,17,83,18,1],[83,19,83,55,1],[83,56,83,57,1],[88,17,88,18,0],[88,19,88,43,0],[88,44,88,45,0],[89,17,89,18,1],[89,19,89,56,1],[89,57,89,58,1],[94,17,94,18,1],[94,19,94,100,1],[94,101,94,102,1],[99,17,99,18,0],[99,19,99,32,0],[99,33,99,34,0],[100,17,100,18,0],[100,19,100,33,0],[100,34,100,35,0],[105,17,105,18,1],[105,19,105,55,1],[105,56,105,57,1],[110,17,110,18,1],[110,19,110,60,1],[110,61,110,62,1],[115,17,115,18,1],[115,19,115,76,1],[115,77,115,78,1],[121,13,121,14,1],[122,17,122,54,1],[123,21,123,117,1],[125,17,125,49,1],[126,13,126,14,1],[130,9,130,10,1],[131,13,131,76,1],[132,13,132,66,1],[133,17,133,49,1],[134,18,134,74,1],[135,17,135,51,1],[137,17,137,50,1],[139,13,141,141,1],[144,13,144,69,1],[145,17,145,30,0],[147,18,147,27,1],[147,29,147,57,1],[147,59,147,62,1],[148,13,148,14,1],[149,17,149,83,1],[150,21,150,34,0],[151,13,151,14,1],[152,13,152,25,1],[153,9,153,10,1],[156,9,156,10,1],[157,13,157,27,1],[158,13,158,14,1],[159,17,159,93,1],[163,17,163,84,1],[164,9,164,10,1],[167,9,167,10,1],[168,13,168,92,1],[170,13,175,97,1],[178,13,178,63,1],[180,13,180,14,1],[182,17,190,23,1],[192,17,192,69,1],[193,17,193,74,1],[194,17,194,92,1],[195,17,195,72,1],[196,17,196,71,1],[197,13,197,14,1],[198,13,198,33,0],[199,13,199,14,0],[201,17,201,39,0],[202,13,202,14,0],[205,13,205,14,1],[206,17,213,23,1],[216,17,216,51,1],[217,17,217,83,1],[218,17,218,83,1],[219,17,219,72,1],[220,17,220,83,1],[221,17,221,82,1],[222,17,222,74,1],[223,13,223,14,1],[224,13,224,33,0],[225,13,225,14,0],[226,17,226,39,0],[227,13,227,14,0],[230,13,230,14,1],[232,17,239,23,1],[241,17,241,97,1],[242,17,242,89,1],[243,17,243,93,1],[244,17,244,93,1],[245,17,245,59,1],[246,13,246,14,1],[247,13,247,33,0],[248,13,248,14,0],[250,17,250,39,0],[251,13,251,14,0],[253,13,253,14,1],[254,17,261,23,1],[264,17,264,56,1],[265,17,265,93,1],[266,17,266,93,1],[267,17,267,95,1],[268,17,268,105,1],[269,17,269,79,1],[270,17,270,46,1],[272,17,272,56,1],[273,13,273,14,1],[274,13,274,33,0],[275,13,275,14,0],[276,17,276,39,0],[277,13,277,14,0],[278,13,278,87,1],[279,13,279,80,1],[281,13,281,28,1],[282,13,282,31,1],[283,13,283,50,1],[284,13,284,38,1],[285,17,285,50,0],[286,9,286,10,1],[289,9,289,10,1],[290,13,290,88,1],[292,13,292,116,1],[293,13,293,14,0],[294,17,295,50,0],[296,13,296,14,0],[297,9,297,10,1],[299,9,299,10,1],[300,13,300,46,1],[301,13,301,77,1],[302,13,302,66,1],[304,9,304,10,1],[306,9,306,10,1],[307,13,307,35,1],[310,13,310,49,1],[313,13,313,14,1],[314,17,316,72,1],[317,17,317,38,1],[318,17,318,18,1],[319,21,319,80,1],[320,21,320,76,1],[321,21,321,73,1],[322,21,322,22,1],[323,25,323,43,1],[324,21,324,22,1],[325,17,325,18,1],[327,17,327,36,1],[329,17,329,36,1],[331,17,331,43,1],[332,13,332,14,1],[333,13,333,33,0],[334,13,334,14,0],[335,17,335,39,0],[336,13,336,14,0],[339,13,339,50,1],[340,13,340,38,1],[341,17,341,54,0],[342,9,342,10,1],[347,9,347,10,1],[348,13,348,32,1],[349,13,349,59,1],[350,13,350,14,0],[351,17,351,113,0],[352,17,352,68,0],[353,13,353,14,0],[354,13,354,33,1],[354,34,354,41,0],[355,13,355,72,1],[356,13,356,84,1],[357,13,357,37,1],[357,38,357,108,0],[358,13,358,39,1],[361,13,361,92,1],[362,13,362,36,1],[362,37,362,44,0],[364,13,364,51,1],[365,13,365,20,1],[365,22,365,33,0],[365,34,365,36,1],[365,37,365,47,1],[366,13,366,14,0],[367,17,367,105,0],[368,17,368,74,0],[369,17,369,57,0],[370,13,370,14,0],[372,13,372,61,1],[373,13,373,64,1],[375,13,376,105,1],[377,13,377,67,1],[378,17,378,47,0],[379,9,379,10,1],[382,9,382,10,1],[384,13,384,14,1],[385,17,385,46,1],[386,17,386,18,1],[387,21,387,74,1],[388,25,388,96,0],[393,21,393,35,1],[395,21,395,108,1],[398,21,398,70,1],[399,21,399,74,1],[400,21,400,47,1],[401,21,401,60,1],[402,21,402,88,1],[403,21,403,22,0],[404,25,404,74,0],[405,21,405,22,0],[406,26,406,93,1],[407,21,407,22,1],[408,25,408,74,1],[409,21,409,22,1],[410,21,410,42,1],[411,21,411,72,1],[412,21,412,50,1],[413,21,413,107,1],[416,21,416,61,1],[419,21,419,77,1],[423,17,423,18,0],[425,17,425,18,1],[429,21,429,58,1],[430,21,430,67,1],[435,21,435,74,1],[436,25,436,95,0],[438,21,438,110,1],[439,21,439,119,1],[440,26,440,35,1],[440,37,440,51,1],[440,53,440,56,1],[441,21,441,22,1],[442,25,442,47,1],[443,25,444,112,1],[447,25,447,78,1],[448,25,448,51,1],[449,25,449,64,1],[450,25,450,48,1],[453,25,453,92,1],[454,25,454,26,0],[455,29,455,78,0],[456,25,456,26,0],[457,30,457,97,1],[458,25,458,26,1],[459,29,459,78,1],[460,25,460,26,1],[461,25,461,46,1],[462,25,462,76,1],[463,25,463,54,1],[464,25,464,111,1],[466,25,466,65,1],[467,21,467,22,1],[469,21,469,57,1],[470,21,470,22,0],[471,25,471,180,0],[472,21,472,22,0],[474,21,474,71,1],[475,25,478,164,1],[480,21,480,22,0],[481,25,481,71,0],[481,71,481,83,0],[481,83,481,85,0],[481,25,481,85,0],[482,25,482,61,0],[483,25,483,45,0],[484,21,484,22,0],[485,17,485,18,0],[486,13,486,14,0],[487,13,487,33,1],[488,13,488,14,1],[489,17,489,39,1],[490,13,490,14,1],[491,9,491,10,1],[494,9,494,10,0],[495,13,495,45,0],[496,9,496,10,0],[499,9,499,10,0],[500,13,500,73,0],[501,13,501,14,0],[502,17,506,108,0],[507,13,507,14,0],[509,13,509,14,0],[510,17,513,156,0],[514,13,514,14,0],[515,9,515,10,0],[521,17,521,18,1],[521,19,521,116,1],[521,117,521,118,1],[526,9,526,10,1],[527,13,527,38,1],[528,13,528,44,1],[529,13,529,14,1],[530,17,530,83,1],[531,17,531,61,1],[532,13,532,14,1],[534,13,534,26,1],[535,13,535,30,1],[536,13,537,117,1],[539,13,539,14,1],[540,17,540,33,1],[541,17,541,34,1],[542,17,542,18,1],[543,21,543,71,1],[544,21,544,48,1],[545,21,545,38,1],[547,21,547,58,1],[548,21,548,67,1],[549,25,549,72,0],[552,21,552,88,1],[553,21,553,43,1],[554,21,554,22,1],[555,25,555,71,1],[556,25,556,26,0],[557,29,557,78,0],[558,29,558,63,0],[559,33,559,48,0],[560,29,562,60,0],[563,29,563,116,0],[564,29,564,64,0],[565,29,565,107,0],[566,29,566,82,0],[567,29,569,54,0],[570,29,570,109,0],[571,29,571,30,0],[572,33,572,102,0],[573,33,573,80,0],[574,29,574,30,0],[575,29,578,102,0],[579,25,579,26,0],[580,25,581,52,1],[582,25,582,71,1],[584,25,584,26,0],[585,29,588,102,0],[589,29,589,111,0],[590,29,590,63,0],[591,29,591,60,0],[592,29,592,96,0],[593,33,593,59,0],[594,34,594,101,0],[595,33,595,59,0],[596,29,596,75,0],[597,33,597,101,0],[598,29,600,59,0],[602,33,604,108,0],[605,25,605,26,0],[606,25,606,72,1],[607,25,607,80,1],[609,25,610,68,1],[611,25,611,26,0],[612,29,615,56,0],[616,25,616,26,0],[619,25,619,37,1],[622,21,622,22,1],[623,25,623,71,1],[624,25,624,26,0],[625,29,628,102,0],[629,29,629,111,0],[630,29,630,63,0],[631,29,631,60,0],[632,29,632,96,0],[633,33,633,59,0],[634,34,634,101,0],[635,33,635,59,0],[636,29,636,75,0],[637,33,637,101,0],[638,29,638,75,0],[639,33,641,108,0],[642,25,642,26,0],[644,25,644,40,1],[645,25,647,46,1],[648,25,649,52,1],[652,25,652,81,1],[653,25,653,52,1],[655,25,655,88,1],[657,25,657,76,1],[658,25,658,88,1],[659,25,659,92,1],[661,25,661,32,1],[661,34,661,43,0],[661,44,661,46,1],[661,47,661,64,1],[662,25,662,26,0],[663,29,663,63,0],[665,29,670,45,0],[670,45,672,106,0],[672,106,672,108,0],[665,29,672,108,0],[673,29,673,45,0],[674,29,674,30,0],[675,33,675,87,0],[677,33,677,65,0],[678,37,678,91,0],[680,37,680,91,0],[681,29,681,30,0],[682,25,682,26,0],[684,25,684,112,1],[687,25,687,71,1],[688,25,688,26,0],[689,29,692,64,0],[693,29,693,66,0],[694,29,694,65,0],[695,29,695,82,0],[696,29,696,107,0],[697,29,697,82,0],[698,29,699,58,0],[701,29,701,109,0],[702,29,702,30,0],[703,33,703,78,0],[704,33,704,80,0],[705,29,705,30,0],[707,29,710,94,0],[711,25,711,26,0],[713,25,713,51,1],[714,25,714,80,1],[716,25,716,37,1],[719,13,719,14,0],[720,13,720,33,0],[721,13,721,14,0],[722,17,722,39,0],[723,17,723,38,0],[724,13,724,14,0],[725,13,725,26,0],[726,9,726,10,1],[729,9,729,10,1],[730,13,730,59,1],[732,13,732,14,0],[733,17,736,90,0],[737,17,737,99,0],[738,17,738,51,0],[739,17,739,48,0],[740,17,740,84,0],[741,21,741,47,0],[742,22,742,89,0],[743,21,743,47,0],[744,17,744,63,0],[745,21,745,89,0],[746,17,748,47,0],[750,21,751,92,0],[752,13,752,14,0],[753,13,755,24,1],[756,9,756,10,1],[759,9,759,10,0],[764,13,764,107,0],[765,13,765,46,0],[766,13,766,14,0],[768,17,768,43,0],[769,17,769,116,0],[771,17,771,73,0],[772,17,772,18,0],[773,21,774,129,0],[777,17,777,18,0],[778,21,778,111,0],[781,21,784,75,0],[785,21,785,28,0],[785,30,785,55,0],[785,56,785,58,0],[785,59,785,72,0],[786,21,786,22,0],[787,25,788,75,0],[789,25,789,26,0],[790,29,790,63,0],[791,29,791,30,0],[792,33,792,87,0],[793,33,793,34,0],[794,37,796,85,0],[798,37,798,65,0],[800,37,800,44,0],[800,46,800,68,0],[800,69,800,71,0],[800,72,800,84,0],[801,37,801,38,0],[802,41,805,71,0],[806,41,806,60,0],[806,61,806,67,0],[807,37,807,38,0],[809,37,809,57,0],[810,37,810,38,0],[811,41,812,129,0],[814,33,814,34,0],[816,33,816,34,0],[817,37,818,73,0],[820,33,820,39,0],[822,25,822,26,0],[823,21,823,22,0],[824,17,824,18,0],[825,13,825,14,0],[826,9,826,10,0],[829,9,829,10,1],[831,13,831,14,1],[832,17,832,33,1],[833,17,833,34,1],[834,17,834,18,1],[835,21,835,53,1],[836,21,836,51,1],[837,21,837,74,1],[838,21,840,81,1],[841,21,841,28,1],[841,30,841,41,1],[841,42,841,44,1],[841,45,841,52,1],[842,21,842,22,1],[843,25,843,65,1],[844,25,844,61,1],[845,21,845,22,1],[846,21,846,69,1],[847,21,847,102,1],[848,21,848,98,1],[853,21,854,35,1],[856,21,856,71,1],[857,25,857,69,1],[860,21,860,88,1],[861,21,861,22,0],[862,25,863,106,0],[864,25,864,90,0],[865,29,866,148,0],[867,21,867,22,0],[869,21,869,74,1],[870,21,870,59,1],[871,21,871,86,1],[873,21,873,71,1],[878,21,879,104,1],[880,21,880,32,1],[881,21,881,22,1],[883,25,883,121,1],[884,25,884,43,1],[885,25,885,26,0],[886,29,886,74,0],[887,25,887,26,0],[889,25,891,58,1],[894,25,894,71,1],[895,25,895,26,0],[896,29,898,60,0],[899,29,899,118,0],[900,29,900,30,0],[901,29,901,69,0],[904,29,904,107,0],[905,29,905,82,0],[906,29,907,63,0],[909,29,909,109,0],[910,29,910,30,0],[911,33,911,78,0],[912,33,912,80,0],[913,29,913,30,0],[915,29,918,94,0],[919,25,919,26,0],[921,25,921,123,1],[922,25,924,87,1],[925,25,926,81,1],[927,25,927,26,0],[929,29,932,76,0],[933,25,933,26,0],[935,25,935,85,1],[936,25,936,26,0],[937,29,942,101,0],[943,25,943,26,0],[945,25,945,26,1],[946,29,951,40,1],[952,25,952,26,1],[953,21,953,22,1],[956,25,956,66,0],[957,17,957,18,1],[958,13,958,14,1],[959,13,959,33,1],[960,13,960,14,1],[962,17,962,39,1],[963,17,963,36,1],[964,13,964,14,1],[965,9,965,10,1],[968,9,968,10,0],[969,13,969,69,0],[970,13,970,48,0],[972,13,972,91,0],[973,13,973,45,0],[974,13,974,14,0],[975,17,975,69,0],[976,17,976,70,0],[977,17,977,58,0],[978,17,978,53,0],[979,17,979,54,0],[980,13,980,14,0],[982,13,982,14,0],[983,17,983,68,0],[984,17,984,71,0],[985,13,985,14,0],[986,9,986,10,0],[989,9,989,10,1],[990,13,990,40,1],[991,13,991,76,1],[992,13,992,45,1],[993,13,993,14,0],[994,17,994,62,0],[995,17,995,63,0],[996,17,996,51,0],[997,17,997,46,0],[998,17,998,86,0],[999,17,999,101,0],[1000,17,1000,47,0],[1002,17,1002,24,0],[1002,26,1002,42,0],[1002,43,1002,45,0],[1002,46,1002,68,0],[1003,17,1003,18,0],[1005,21,1005,101,0],[1006,21,1007,48,0],[1010,21,1012,112,0],[1013,21,1013,22,0],[1014,25,1014,76,0],[1015,25,1015,72,0],[1016,25,1016,77,0],[1017,25,1017,75,0],[1018,25,1020,85,0],[1021,21,1021,22,0],[1023,21,1023,86,0],[1024,21,1024,93,0],[1025,21,1025,22,0],[1026,25,1026,103,0],[1027,25,1027,105,0],[1028,25,1032,91,0],[1034,25,1035,81,0],[1036,21,1036,22,0],[1037,17,1037,18,0],[1038,13,1038,14,0],[1040,13,1040,14,1],[1041,17,1041,61,1],[1042,17,1042,64,1],[1043,13,1043,14,1],[1044,13,1044,23,1],[1045,9,1045,10,1],[1050,9,1050,10,0],[1051,13,1051,104,0],[1052,9,1052,10,0],[1055,9,1055,10,0],[1056,13,1056,69,0],[1057,13,1057,53,0],[1058,17,1058,50,0],[1059,17,1059,51,0],[1061,13,1061,119,0],[1063,13,1063,115,0],[1065,13,1065,69,0],[1066,13,1066,14,0],[1067,17,1067,44,0],[1068,13,1068,14,0],[1071,13,1071,89,0],[1072,13,1072,48,0],[1073,13,1073,14,0],[1074,17,1074,45,0],[1075,13,1075,14,0],[1077,13,1077,109,0],[1079,13,1079,105,0],[1080,13,1082,36,0],[1085,13,1085,43,0],[1086,13,1086,55,0],[1087,13,1087,49,0],[1088,13,1088,47,0],[1089,13,1089,40,0],[1090,13,1090,35,0],[1092,13,1092,46,0],[1093,13,1093,14,0],[1094,17,1094,47,0],[1096,17,1096,44,0],[1097,17,1097,18,0],[1098,21,1098,74,0],[1099,17,1099,18,0],[1101,17,1101,18,0],[1102,21,1102,90,0],[1103,17,1103,18,0],[1104,13,1104,14,0],[1105,13,1105,65,0],[1106,13,1106,14,0],[1107,17,1107,65,0],[1108,13,1108,14,0],[1109,13,1109,35,0],[1110,9,1110,10,0],[1113,9,1113,10,0],[1114,13,1114,42,0],[1115,13,1115,66,0],[1116,13,1116,14,0],[1117,17,1117,71,0],[1118,17,1118,53,0],[1119,17,1119,39,0],[1120,17,1120,100,0],[1121,13,1121,14,0],[1122,9,1122,10,0],[1125,9,1125,10,0],[1126,13,1126,42,0],[1127,13,1127,68,0],[1128,13,1128,14,0],[1129,17,1129,69,0],[1130,17,1130,67,0],[1132,17,1132,111,0],[1133,17,1133,74,0],[1134,17,1134,44,0],[1135,17,1135,94,0],[1136,17,1136,94,0],[1137,17,1137,92,0],[1138,17,1138,118,0],[1139,17,1139,73,0],[1140,17,1140,73,0],[1141,17,1141,76,0],[1142,17,1142,24,0],[1142,26,1142,45,0],[1142,46,1142,48,0],[1142,49,1142,72,0],[1143,17,1143,18,0],[1144,21,1144,50,0],[1145,17,1145,18,0],[1146,13,1146,14,0],[1147,9,1147,10,0],[1150,9,1150,10,0],[1151,13,1151,29,0],[1152,13,1152,30,0],[1153,13,1153,14,0],[1154,17,1154,74,0],[1155,17,1155,18,0],[1156,21,1156,97,0],[1157,21,1157,76,0],[1158,21,1158,66,0],[1159,21,1161,40,0],[1162,21,1162,70,0],[1163,21,1163,72,0],[1164,21,1164,49,0],[1165,21,1167,42,0],[1168,17,1168,18,0],[1170,17,1174,74,0],[1175,13,1175,14,0],[1176,9,1176,10,0],[1181,9,1181,10,1],[1182,13,1182,44,1],[1183,13,1183,38,1],[1184,9,1184,10,1],[1187,9,1187,10,1],[1189,13,1189,69,1],[1190,13,1190,66,1],[1191,13,1191,53,1],[1192,17,1192,50,1],[1193,17,1193,51,1],[1195,13,1195,119,1],[1197,13,1197,115,1],[1199,13,1199,69,1],[1200,13,1200,14,0],[1201,17,1201,44,0],[1202,13,1202,14,0],[1204,13,1204,89,1],[1205,13,1205,48,1],[1206,13,1206,14,1],[1207,17,1207,45,1],[1208,13,1208,14,1],[1209,13,1209,109,1],[1211,13,1211,105,1],[1213,13,1215,36,1],[1217,13,1217,50,1],[1218,13,1218,62,1],[1219,13,1219,56,1],[1220,13,1220,54,1],[1221,13,1221,47,1],[1222,13,1222,42,1],[1225,13,1225,46,1],[1226,13,1226,14,1],[1227,17,1227,47,1],[1230,17,1230,44,1],[1231,17,1231,18,1],[1232,21,1232,81,1],[1233,17,1233,18,1],[1235,17,1235,18,0],[1236,21,1236,97,0],[1237,17,1237,18,0],[1238,13,1238,14,1],[1239,9,1239,10,1],[1242,9,1242,10,1],[1243,13,1243,76,1],[1244,13,1244,68,1],[1245,13,1245,14,1],[1246,17,1247,33,1],[1247,33,1247,87,1],[1247,87,1248,36,1],[1246,17,1248,36,1],[1250,17,1250,71,1],[1251,17,1251,70,1],[1252,17,1252,73,1],[1253,17,1253,47,1],[1254,13,1254,14,1],[1255,9,1255,10,1],[1258,9,1258,10,1],[1259,13,1259,102,1],[1260,13,1260,84,1],[1261,9,1261,10,1],[1264,9,1264,10,0],[1266,13,1266,14,0],[1267,17,1267,85,0],[1268,17,1268,84,0],[1269,17,1269,98,0],[1270,17,1270,95,0],[1271,17,1271,95,0],[1272,17,1272,87,0],[1273,17,1273,86,0],[1274,17,1274,101,0],[1275,17,1275,91,0],[1276,17,1276,74,0],[1277,17,1277,77,0],[1278,17,1278,78,0],[1279,17,1279,82,0],[1281,17,1281,24,0],[1281,26,1281,45,0],[1281,46,1281,48,0],[1281,49,1281,74,0],[1282,17,1282,18,0],[1283,21,1283,50,0],[1284,17,1284,18,0],[1285,13,1285,14,0],[1286,13,1286,33,0],[1287,13,1287,14,0],[1288,17,1288,75,0],[1290,9,1290,10,0],[1293,9,1293,10,0],[1295,13,1295,14,0],[1296,17,1296,92,0],[1297,17,1297,98,0],[1298,17,1298,102,0],[1299,17,1299,108,0],[1300,17,1301,48,0],[1303,17,1303,24,0],[1303,26,1303,45,0],[1303,46,1303,48,0],[1303,49,1303,81,0],[1304,17,1304,18,0],[1305,21,1305,50,0],[1306,17,1306,18,0],[1307,13,1307,14,0],[1308,13,1308,33,0],[1309,13,1309,14,0],[1310,17,1310,75,0],[1312,9,1312,10,0],[1315,9,1315,10,0],[1316,13,1316,31,0],[1316,32,1316,39,0],[1318,13,1318,131,0],[1319,13,1319,33,0],[1320,13,1320,33,0],[1321,13,1321,30,0],[1322,13,1322,14,0],[1323,17,1324,40,0],[1326,17,1326,45,0],[1327,13,1327,14,0],[1329,13,1329,41,0],[1330,13,1332,61,0],[1333,13,1333,38,0],[1334,17,1334,24,0],[1334,26,1334,48,0],[1334,49,1334,51,0],[1334,52,1334,64,0],[1335,17,1335,18,0],[1336,21,1338,47,0],[1339,21,1339,40,0],[1339,41,1339,47,0],[1340,17,1340,18,0],[1341,13,1341,33,0],[1341,34,1341,41,0],[1343,13,1343,108,0],[1344,13,1344,67,0],[1345,13,1345,14,0],[1346,17,1346,35,0],[1347,17,1347,18,0],[1348,21,1349,51,0],[1351,21,1351,49,0],[1352,17,1352,18,0],[1353,13,1353,14,0],[1354,13,1354,20,0],[1354,22,1354,36,0],[1354,37,1354,39,0],[1354,40,1354,59,0],[1355,13,1355,14,0],[1356,17,1356,42,0],[1357,17,1357,18,0],[1358,21,1358,65,0],[1359,21,1360,199,0],[1361,17,1361,18,0],[1363,17,1363,18,0],[1364,21,1365,51,0],[1366,17,1366,18,0],[1368,17,1368,45,0],[1369,13,1369,14,0],[1370,9,1370,10,0],[1374,9,1374,10,0],[1375,13,1375,25,0],[1376,13,1376,34,0],[1376,35,1376,45,0],[1377,13,1379,78,0],[1380,13,1383,95,0],[1384,13,1385,39,0],[1386,13,1386,31,0],[1387,9,1387,10,0],[1390,9,1390,10,0],[1393,13,1393,66,0],[1394,13,1394,66,0],[1395,13,1395,39,0],[1396,13,1396,52,0],[1397,13,1397,80,0],[1398,13,1398,14,0],[1399,17,1399,66,0],[1400,13,1400,14,0],[1401,18,1401,85,0],[1402,13,1402,14,0],[1403,17,1403,66,0],[1404,13,1404,14,0],[1405,13,1405,34,0],[1406,13,1406,64,0],[1407,13,1407,42,0],[1408,13,1408,99,0],[1409,13,1409,42,0],[1410,9,1410,10,0],[1413,9,1413,10,1],[1414,13,1414,42,1],[1415,9,1415,10,1],[1420,13,1420,14,1],[1421,17,1421,77,1],[1422,21,1425,88,0],[1427,21,1429,116,1],[1430,13,1430,14,1],[1435,17,1435,18,0],[1435,19,1435,55,0],[1436,17,1436,18,0],[1436,19,1436,55,0],[1440,9,1440,10,0],[1441,9,1441,10,0],[1444,9,1444,10,0],[1445,9,1445,10,0],[1448,9,1448,10,1],[1449,13,1449,65,1],[1450,13,1450,14,1],[1451,17,1451,44,1],[1452,17,1452,54,1],[1453,17,1453,54,1],[1454,17,1454,61,1],[1455,17,1455,62,1],[1456,17,1456,58,1],[1458,17,1458,60,1],[1459,17,1459,64,1],[1460,17,1460,60,1],[1461,17,1461,57,1],[1462,17,1462,51,1],[1464,17,1464,71,1],[1466,17,1466,77,1],[1467,17,1467,18,1],[1468,21,1468,71,1],[1469,21,1469,57,1],[1470,17,1470,18,1],[1472,17,1472,48,1],[1473,17,1473,18,1],[1474,21,1474,65,1],[1475,17,1475,18,1],[1477,17,1477,41,1],[1478,17,1478,42,1],[1480,17,1480,141,1],[1481,13,1481,14,1],[1482,18,1482,71,1],[1483,13,1483,14,1],[1484,17,1484,45,1],[1485,17,1485,31,1],[1486,17,1486,46,1],[1487,17,1487,46,1],[1488,17,1488,41,1],[1490,17,1490,164,1],[1492,17,1492,24,1],[1492,26,1492,37,1],[1492,38,1492,40,1],[1492,41,1492,48,1],[1493,17,1493,18,1],[1494,21,1494,54,1],[1495,21,1495,61,1],[1496,21,1496,61,1],[1498,21,1498,36,1],[1499,25,1499,66,1],[1500,21,1500,65,1],[1501,21,1501,57,1],[1502,21,1502,56,1],[1503,21,1503,57,1],[1504,21,1504,70,1],[1505,17,1505,18,1],[1507,17,1507,54,1],[1508,17,1508,54,1],[1510,17,1510,48,1],[1511,17,1511,18,1],[1512,21,1512,36,1],[1513,25,1513,73,0],[1515,25,1515,74,1],[1516,21,1516,48,1],[1517,21,1517,56,1],[1519,21,1519,107,1],[1520,21,1520,22,1],[1521,25,1521,64,1],[1522,21,1522,22,1],[1523,17,1523,18,1],[1525,17,1525,55,1],[1527,17,1527,48,1],[1528,21,1528,65,1],[1530,17,1530,76,1],[1531,21,1531,69,0],[1533,21,1533,64,1],[1535,17,1535,79,1],[1536,21,1536,50,0],[1538,21,1538,51,1],[1540,17,1540,123,1],[1541,17,1541,49,1],[1542,21,1542,66,1],[1544,21,1544,64,0],[1546,17,1546,62,1],[1547,17,1547,67,1],[1548,17,1548,53,1],[1549,17,1549,60,1],[1551,17,1551,46,1],[1552,21,1552,65,0],[1554,21,1554,70,1],[1555,17,1555,62,1],[1556,17,1556,57,1],[1557,17,1557,50,1],[1559,17,1559,41,1],[1560,17,1560,49,1],[1563,17,1563,77,1],[1564,17,1570,92,1],[1572,17,1575,131,1],[1578,17,1578,73,1],[1579,17,1579,52,1],[1581,17,1581,95,1],[1582,17,1582,49,1],[1583,17,1583,18,0],[1584,21,1584,73,0],[1585,21,1585,74,0],[1586,21,1586,62,0],[1587,21,1587,57,0],[1588,21,1588,58,0],[1589,17,1589,18,0],[1591,17,1591,18,1],[1592,21,1592,72,1],[1593,21,1593,75,1],[1594,17,1594,18,1],[1595,17,1596,76,1],[1597,17,1597,67,1],[1600,13,1600,14,1],[1601,18,1601,74,1],[1602,13,1602,14,1],[1603,17,1603,48,1],[1605,17,1605,52,1],[1606,17,1606,56,1],[1607,17,1607,61,1],[1608,17,1608,62,1],[1609,17,1609,59,1],[1610,17,1610,63,1],[1611,17,1611,70,1],[1612,17,1612,56,1],[1613,17,1613,50,1],[1614,17,1614,73,1],[1615,17,1615,60,1],[1616,17,1616,62,1],[1618,17,1618,64,1],[1619,17,1619,60,1],[1620,17,1620,57,1],[1621,17,1621,50,1],[1623,17,1623,45,1],[1624,17,1624,41,1],[1625,17,1625,141,1],[1626,13,1626,14,1],[1627,9,1627,10,1],[1647,9,1647,10,1],[1648,13,1648,101,1],[1649,13,1649,46,1],[1650,13,1650,14,0],[1651,17,1651,66,0],[1652,17,1652,43,0],[1653,17,1653,107,0],[1654,17,1654,43,0],[1654,44,1654,71,0],[1655,17,1655,84,0],[1656,17,1656,64,0],[1657,17,1657,85,0],[1658,13,1658,14,0],[1659,9,1659,10,1],[1662,9,1662,10,1],[1663,13,1663,33,1],[1665,13,1665,50,1],[1666,13,1666,38,1],[1667,17,1667,55,0],[1668,9,1668,10,1],[1673,13,1673,14,1],[1674,17,1674,72,1],[1675,21,1675,47,1],[1677,21,1677,74,1],[1678,13,1678,14,1],[1682,9,1682,10,0],[1683,13,1683,43,0],[1684,13,1684,20,0],[1684,22,1684,38,0],[1684,39,1684,41,0],[1684,42,1684,49,0],[1685,13,1685,14,0],[1686,17,1686,80,0],[1687,17,1687,18,0],[1688,21,1688,66,0],[1689,25,1689,84,0],[1690,17,1690,18,0],[1691,13,1691,14,0],[1692,13,1692,54,0],[1693,13,1693,14,0],[1694,17,1694,66,0],[1695,17,1695,83,0],[1696,21,1696,94,0],[1697,13,1697,14,0],[1698,13,1698,45,0],[1699,9,1699,10,0],[1702,9,1702,10,0],[1703,13,1703,77,0],[1705,13,1705,50,0],[1706,13,1706,14,0],[1707,17,1708,97,0],[1709,13,1709,14,0],[1711,13,1711,14,0],[1712,17,1712,47,0],[1712,48,1712,66,0],[1714,17,1714,120,0],[1716,17,1716,24,0],[1716,26,1716,35,0],[1716,36,1716,38,0],[1716,39,1716,55,0],[1717,17,1717,18,0],[1718,21,1723,37,0],[1723,37,1725,98,0],[1725,98,1725,100,0],[1718,21,1725,100,0],[1726,21,1726,67,0],[1727,17,1727,18,0],[1735,13,1735,14,0],[1736,9,1736,10,0],[1745,9,1745,10,1],[1746,13,1746,39,1],[1748,13,1748,90,1],[1749,13,1749,35,1],[1750,13,1750,14,0],[1751,17,1751,63,0],[1752,17,1752,64,0],[1753,17,1753,52,0],[1754,17,1754,47,0],[1755,17,1755,49,0],[1758,17,1758,60,0],[1759,17,1759,94,0],[1760,17,1760,57,0],[1761,17,1761,52,0],[1762,17,1762,80,0],[1764,17,1764,92,0],[1765,17,1767,83,0],[1769,17,1769,88,0],[1770,17,1770,18,0],[1771,17,1771,18,0],[1773,17,1773,18,0],[1774,21,1774,82,0],[1775,17,1775,18,0],[1777,17,1777,24,0],[1777,26,1777,42,0],[1777,43,1777,45,0],[1777,46,1777,69,0],[1778,17,1778,18,0],[1779,21,1779,80,0],[1780,21,1783,116,0],[1784,17,1784,18,0],[1785,13,1785,14,0],[1787,13,1787,14,1],[1788,17,1788,62,1],[1789,17,1789,65,1],[1790,13,1790,14,1],[1792,13,1792,53,1],[1793,13,1793,100,1],[1794,9,1794,10,1],[1800,9,1800,10,0],[1801,13,1801,78,0],[1802,13,1802,31,0],[1803,17,1803,37,0],[1805,13,1805,84,0],[1806,13,1806,34,0],[1807,17,1807,40,0],[1809,13,1809,93,0],[1810,13,1810,36,0],[1811,13,1811,14,0],[1812,17,1812,57,0],[1813,17,1813,66,0],[1814,13,1814,14,0],[1816,13,1816,96,0],[1817,13,1817,38,0],[1818,17,1818,64,0],[1820,13,1820,92,0],[1821,13,1821,38,0],[1822,13,1822,14,0],[1823,17,1823,61,0],[1824,17,1824,84,0],[1825,13,1825,14,0],[1827,13,1827,92,0],[1828,13,1828,38,0],[1829,13,1829,14,0],[1830,17,1830,61,0],[1831,17,1831,68,0],[1832,13,1832,14,0],[1834,13,1834,20,0],[1834,22,1834,41,0],[1834,42,1834,44,0],[1834,45,1834,71,0],[1835,13,1835,14,0],[1836,17,1836,46,0],[1837,13,1837,14,0],[1838,9,1838,10,0],[1846,13,1846,14,0],[1847,17,1847,56,0],[1848,17,1848,18,0],[1849,21,1849,56,0],[1850,17,1850,18,0],[1851,17,1851,52,0],[1852,13,1852,14,0],[1853,17,1853,18,0],[1853,19,1853,55,0],[1853,56,1853,57,0],[1857,9,1857,10,0],[1858,13,1858,72,0],[1859,17,1859,98,0],[1861,13,1861,14,0],[1862,17,1862,77,0],[1863,21,1864,88,0],[1865,17,1865,29,0],[1867,9,1867,10,0]]);
    </script>
  </body>
</html>