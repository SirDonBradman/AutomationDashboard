<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Pay Estimates\CreateEstimate.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Threading;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Xml;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.CONTMGTPEBL;
using Aurigo.AMP3.CONTMGTPEDTO;
using Aurigo.AMP3.ContractManagementPayEstimatesUI;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.AMP3.WORKORDBL;
using Aurigo.AMP3.WORKORDDTO;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.WebUI.UltraWebGrid;
using System.Web;
using Aurigo.Brix.Construction.ContractManager.BusinessLayer.BL;
using System.Web.Script.Serialization;

namespace Aurigo.AMP3.CONTMGTPEUI
{
    public partial class CreateEstimate : BrixPageBase, IWorkflowEnabled
    {
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid gridMBooks;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid uwgMBNotAdded;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid uwgMBModified;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid ppGrid;
        protected global::Infragistics.WebUI.WebSchedule.WebDateChooser wdcCreatedOn;
        protected global::Infragistics.WebUI.WebSchedule.WebDateChooser dtFromDt;
        protected global::Infragistics.WebUI.WebSchedule.WebDateChooser dtToDt;
        protected global::Infragistics.WebUI.WebSchedule.WebDateChooser dtRetRel;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid itemsGrid;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid uwgPrePayment;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneAmount;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid uwgMaterialDeductions;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneMaterialDeductionQty;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneMaterialDeductionRate;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid uwgRABAdditions;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneAdjustmentAmount;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid uwgRABDeductions;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wceContAdvPercentRec;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wceRetainage;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtHoldPercent;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtCurrentHoldAmount;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtHoldRelease;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtHoldReleaseAmt;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtHoldAmount;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtRetentionCP;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtRetentionCV;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtRetention;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtRetentionINR;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtTotalretAmt;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtRetentionValue;
        protected global::Aurigo.AMP3.Core.UserControls.AttachmentsControl peAttachments;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtRetRelease;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtRetReleaseAmt;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit txtRetentionPrevTotal;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid uwgAdvancePayment;


        private bool IsERPConnected
        {
            get { return IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX); }
        }

        #region Private Variables

        public enum PageMode
        {
            New,
            Edit,
            View
        }

        protected ModalPopupExtender PopupExtender;
        public PageMode _Mode;

        private int contractID;
        private DataSet dsRet;
        public bool enableMaterialDeductions;
        private GenericPickerControl genericAdjustmentPicker;

        private GenericPickerControl genericMBookPicker;
        private GenericPickerControl genericMIPicker;
        private GenericPickerControl genericPRMBookPicker;

        private GenericPickerControl genericPRRFIPicker;

        protected ModalPopupExtender popUpInvalidMBooks;
        protected ModalPopupExtender popupExtender1;
        private PESettings settings;
        private string viewStateContractor = &quot;PECONTRACTOR&quot;;
        private string viewStateFirstPE = &quot;PEFIRST&quot;;
        private string viewStateFromDt = &quot;PEFROMDT&quot;;
        private string viewStateSettings = &quot;PESETTINGS&quot;;
        private string viewStateToDt = &quot;PETODT&quot;;
        private string viewStateWO = &quot;PEWO&quot;;
        private string LocalizedContractName = LocalizationManager.GetString(&quot;Contract&quot;);

        private string WorkOrderType
        {
            get { return Session[&quot;RABWorkOrderType&quot;].ToString2(); }
            set { Session[&quot;RABWorkOrderType&quot;] = value; }
        }

        private decimal HoldAmountFromds
        {
            get { return decimal.Parse(hdnHoldAmt.Value); }
            set { hdnHoldAmt.Value = value.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture); }
        }

        private string ProjectMode
        {
            get
            {
                return (CacheManager.Instance.IsIntegrated(Request.QueryString[Constants.QRY_PROJECTID].ToInt32_2())
                            ? &quot;I&quot;
                            : &quot;L&quot;);
            }
        }

        private DataTable DTTotalAmt
        {
            get { return (DataTable)ViewState[&quot;DTTotalAmt&quot;]; }
            set { ViewState[&quot;DTTotalAmt&quot;] = value; }
        }

        private DataTable DTMBooks
        {
            get { return (DataTable)ViewState[&quot;DTMBooks&quot;]; }
            set { ViewState[&quot;DTMBooks&quot;] = value; }
        }

        private DataTable DTPRMBooks
        {
            get { return (DataTable)ViewState[&quot;DTPRMBooks&quot;]; }
            set { ViewState[&quot;DTPRMBooks&quot;] = value; }
        }

        private DataTable DTPRRFIs
        {
            get { return (DataTable)ViewState[&quot;DTPRRFIs&quot;]; }
            set { ViewState[&quot;DTPRRFIs&quot;] = value; }
        }

        private DataTable DTRetAmtFromRule
        {
            get { return (DataTable)ViewState[&quot;DTRetAmtFromRule&quot;]; }
            set { ViewState[&quot;DTRetAmtFromRule&quot;] = value; }
        }

        private bool IsFinal
        {
            get { return String.IsNullOrEmpty(Request[&quot;IsF&quot;]) ? false : Request[&quot;IsF&quot;].ToInt32_2().ToBoolean2(); }
        }

        /// &lt;summary&gt;
        /// Gets the Integration Cutoff Date
        /// &lt;/summary&gt;
        private DateTime IntegrationCutoffDate
        {
            get { return ((DateTime)Session[Constants.APP_IntegrationCutoffDate]).AddDays(-1); }
        }

        /// &lt;summary&gt;
        /// Gets the Default Record Date
        /// &lt;/summary&gt;
        private DateTime DefaultRecordDate
        {
            get { return (DateTime)Session[Constants.APP_DefaultRecordDate]; }
        }

        public PageMode Mode
        {
            set { _Mode = value; }
            get { return _Mode; }
        }

        private enum MIDivEnums
        {
            MIPicker = 1,
            CreatePE = 2,
            AdjustmentPicker = 3,
            MBPicker = 4,
            PRMBPicker = 5,
            PRRFIPicker = 6
        }

        private bool DisableModeForPrePayment
        {
            get { return (IntegrationCutoffDate == DateTime.MinValue); }
        }

        #endregion

        #region IWorkflowEnabled Members

        public void CancelHandler(object sender, bool bAfterSave, out string sRedirectTo)
        {
            throw new NotImplementedException();
        }

        public string FormInstanceId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;PEID&quot;])
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;PEID&quot;], out id) ? id : -1;
                return id.ToString();
            }
        }

        public string ClientValidationFunction
        {
            get { return string.Empty; }
        }

        public string FormKeyWONO
        {
            get
            {
                // return (!string.IsNullOrEmpty(Request[&quot;WOID&quot;])) ? Convert.ToString(ComponentHelper.Instance.ExecuteScalar(
                //         &quot;select WorkOrderNo from WORKORDMain where WorkOrderID = &#39;&quot; + Request[&quot;WOID&quot;] + &quot;&#39;&quot;)) : string.Empty;

                return (!string.IsNullOrEmpty(Request[&quot;WOID&quot;])) ? Convert.ToString(ComponentHelper.Instance.ExecuteScalar(
                       WOStoredProcedure.usp_WORKORDGetWorkOrderNoOfWorkOrder, null, Request[&quot;WOID&quot;])) : string.Empty;


            }
        }


        public string FormKey
        {
            get
            {
                return string.Format(&quot;{0} Number: {1}&quot; + (String.IsNullOrEmpty(FormKeyWONO) ? &quot;&quot; : &quot;,WorkOrder No:&quot; + FormKeyWONO), LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE), RABillNo.Text);
            }
        }

        public string FormName
        {
            get { return &quot;XPAYEST&quot;; }
        }

        public bool IsOldWorkflow
        {
            get { return true; }
        }

        public int PID
        {
            get { return Request.QueryString[&quot;PID&quot;].ToInt32_2(); }
        }

        public int ParentModuleId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;ContractID&quot;])
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;ContractID&quot;], out id) ? id : -1;
                return id;
            }
        }

        public string PostCancelRedirectUrl
        {
            get
            {
                if (Request[&quot;WOID&quot;] != null)
                {
                    return String.Format(CultureInfo.CurrentCulture,
                                         &quot;~/Common/BrixListPage.aspx?context=PAYESTM&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID={2}&quot;,
                                         PID, ParentModuleId, Request[&quot;WOID&quot;]);
                }
                else
                {
                    return String.Format(CultureInfo.CurrentCulture,
                                         &quot;~/Common/BrixListPage.aspx?context=PAYESTM&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&quot;, PID,
                                         ParentModuleId);
                }
            }
        }

        private bool HasRetentionRule { get; set; }

        public string PostSaveRedirectUrl(string sSavedToken = &quot;&quot;)
        {
            //TODO:  Test it whether it works for New/Edit and view modes and find out why it was being passed to same page
            if (Request[&quot;WOID&quot;] != null)
            {
                //if (string.IsNullOrEmpty(Request[&quot;Mode&quot;]) &amp;&amp; Request[&quot;Mode&quot;] != &quot;Edit&quot;)
                //    return BrixDatatypeHelper.Format2(&quot;CreateEstimate.aspx?ContractID={0}&amp;PID={1}&amp;ParentContext=CONTMGT&amp;WOID={2}&quot;, Request[&quot;ContractID&quot;], Request[&quot;PID&quot;], Request[&quot;WOID&quot;]);
                //else
                return String.Format(CultureInfo.CurrentCulture,
                                     &quot;~/Common/BrixListPage.aspx?Context=PAYESTM&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID={2}&quot;,
                                     PID, ParentModuleId, Request[&quot;WOID&quot;]);
            }
            else
            {
                //if (string.IsNullOrEmpty(Request[&quot;Mode&quot;]))
                //    return BrixDatatypeHelper.Format2(&quot;CreateEstimate.aspx?ContractID={0}&amp;PID={1}&amp;ParentContext=CONTMGT&quot;, Request[&quot;ContractID&quot;], Request[&quot;PID&quot;]);
                //else
                return String.Format(CultureInfo.CurrentCulture,
                                     &quot;~/Common/BrixListPage.aspx?Context=PAYESTM&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&quot;,
                                     PID, ParentModuleId);
            }
        }

        public bool SaveHandler(object sender, out string sSavedInstanceToken, out string sErrors,
                                out string sRedirectTo)
        {
            sSavedInstanceToken = &quot;&quot;;
            sRedirectTo = &quot;&quot;;
            sErrors = &quot;&quot;;
            int newID = 0;
            try
            {
                #region Preliminary Checks and mandatory field checks

                if (dtFromDt.Value == null || (Mode != PageMode.New &amp;&amp; ViewState[viewStateFromDt] == null))
                    throw new Exception(&quot;From Date is mandatory.&quot;);

                if (dtToDt.Value == null || (Mode != PageMode.New &amp;&amp; ViewState[viewStateToDt] == null))
                    throw new Exception(&quot;Construction Through Date is mandatory.&quot;);

                if (ddlContractor.SelectedIndex &lt; 1 || (Mode != PageMode.New &amp;&amp; ViewState[viewStateContractor] == null))
                    throw new Exception(&quot;Contractor is mandatory.&quot;);

                if ((rblContractorType.SelectedValue.Equals(&quot;S&quot;) &amp;&amp; ddlWorkOrder.SelectedIndex &lt; 1) ||
                    (Mode != PageMode.New &amp;&amp; ViewState[viewStateWO] == null))
                    throw new Exception(&quot;Work Order is mandatory.&quot;);

                if (Mode == PageMode.New &amp;&amp; ViewState[viewStateToDt] == null)
                    throw new Exception(&quot;Please Generate Postings for the chosen Date Range.&quot;);

                if (!dtFromDt.Value.ToString2().Equals(ViewState[viewStateFromDt].ToString2()))
                    throw new Exception(
                        &quot;From Date has changed since the last time Postings were generated. Please Generate Postings again for the chosen From Date.&quot;);

                if (!dtToDt.Value.ToString2().Equals(ViewState[viewStateToDt].ToString2()))
                    throw new Exception(
                        &quot;Construction Through Date has changed since the last time Postings were generated. Please Generate Postings again for the chosen Construction Through Date.&quot;);

                if (!ViewState[viewStateContractor].Equals(ddlContractor.SelectedValue))
                    throw new Exception(
                        &quot;Contractor has changed since the last time Postings were generated. Please Generate Postings again for the chosen Contractor.&quot;);

                if (!ViewState[viewStateWO].Equals(GetWOIdx()))
                    throw new Exception(
                        &quot;Work Order selection has changed since the last time Postings were generated. Please Generate Postings again for the chosen Work Orders.&quot;);

                if (IsFinal &amp;&amp; chkIsFinalRAB.Checked)
                {
                    if (dtRetRel.Value == null)
                        throw new Exception(&quot;Please select a date for Retention Release before saving the &quot; +
                                            PayEstimateName + &quot; as Final.&quot;);
                    if (ProjectMode.Equals(&quot;L&quot;))
                    {
                        if (dtRetRel.Value.ToMWDateTime().Date &lt; MWDateTimeHelper.MWToday)
                            throw new Exception(&quot;Retention Release date cannot be less than the current date.&quot;);
                    }
                    else
                    {
                        if (dtRetRel.Value.ToDateTime_MWCulture().Date &lt; dtToDt.Value.ToDateTime_MWCulture().Date)
                            throw new Exception(
                                &quot;Retention Release date cannot be less than the construction through date.&quot;);
                    }
                }

                #endregion

                if (ViewState[&quot;canBeSaved&quot;].ToBoolean2())
                {
                    #region Preparing the Pay Estimate DTO

                    var dto = new DTOPE();
                    dto.FromDt = Convert.ToDateTime(lblPayFromDt.Text, DateFormatCulture.GetDateFormatCulture());

                    dto.ToDt = dtToDt.Value.ToUtc();
                    dto.CreatedBy = UserDetail.GetCurrentUserDetail().UID;
                    dto.CreatedOn = Convert.ToDateTime(wdcCreatedOn.Value, DateFormatCulture.GetDateFormatCulture());

                    dto.HoldAmtCurr = txtCurrentHoldAmount.ValueDecimal;
                    dto.RetainageP = (txtHoldPercent.Text != &quot;&quot;) ? txtHoldPercent.Text.ToDecimal2() : 0;
                    dto.Comments = txtNotes.Text;
                    dto.RetainageRelP = (txtHoldRelease.Text != &quot;&quot;) ? txtHoldRelease.Text.ToDecimal2() : 0;

                    //dto.RetAmtFromRule = (txtRetentionINR.Text != &quot;&quot;) ? txtRetentionINR.Text.ToDecimal2() : 0;

                    dto.ContractAdvRecoveryPercent = wceContAdvPercentRec.ValueDecimal;
                    dto.WOID = ddlWorkOrder.SelectedValue.ToInt32_2();
                    string Contractor = (ddlContractor.SelectedItem.Text != &quot;--Select One--&quot;)
                                            ? ddlContractor.SelectedValue
                                            : null;

                    if (!String.IsNullOrEmpty(Contractor))
                    {
                        string[] strContr = Contractor.Split(&#39;,&#39;);

                        dto.ContractorID = strContr[0].ToInt32_2();
                        dto.ContractorType = strContr[1];
                        dto.IsRFI = dto.ContractorType.Equals(&quot;P&quot;) &amp;&amp;
                                    (BL.Instance.GetContrItemSource(Request[&quot;ContractID&quot;].ToInt32_2(), &quot;P&quot;).Equals(&quot;RFI&quot;));
                    }

                    if (Mode == PageMode.Edit)
                        dto.IDs.Add(Request[&quot;PEID&quot;].ToInt32_2());

                    #region MBook Integration

                    if (!WorkOrderType.Equals(&quot;E&quot;) &amp;&amp; dto.ContractorType == &quot;S&quot; &amp;&amp; hdnItemPostings.Value.Equals(&quot;1&quot;))
                    {
                        for (int i = 0; i &lt; itemsGrid.Rows.Count; i++)
                        {
                            SplitCerifiedQtyAcrossMBooks(itemsGrid.Rows[i]);
                            string mBookDetails = itemsGrid.Rows[i].Cells.FromKey(&quot;MBookList&quot;).Value.ToString2();
                            var sr = new StringReader(mBookDetails);
                            var ds = new DataSet();
                            ds.ReadXml(sr);
                            DataTable dt =
                                ds.Tables[&quot;MBook&quot;].Select(&quot;ParentID=&quot; +
                                                          itemsGrid.Rows[i].Cells.FromKey(&quot;ParentID&quot;).Value.ToString2())
                                    .CopyToDataTable();
                            foreach (DataRow row in dt.Rows)
                            {
                                var mBook = new PEMBooks();
                                mBook.MBookItemId = row[&quot;ID&quot;].ToInt32_2();
                                mBook.BillingQty = row[&quot;BillingQty&quot;].ToDecimal2();
                                mBook.CertifiedQty = row[&quot;CertifiedQty&quot;].ToDecimal2();
                                mBook.BillingRate = itemsGrid.Rows[i].Cells.FromKey(&quot;BillingRate&quot;).Value.ToDecimal2();
                                mBook.UnitRate = itemsGrid.Rows[i].Cells.FromKey(&quot;MaxAllowedPrice&quot;).Value.ToDecimal2();
                                mBook.ParentID = itemsGrid.Rows[i].Cells.FromKey(&quot;ParentID&quot;).Value.ToInt32_2();
                                mBook.IsPartRate = itemsGrid.Rows[i].Cells.FromKey(&quot;IsPartRate&quot;).Value.ToBoolean2();
                                if (mBook.IsPartRate != true)
                                    mBook.IsPartRate = !(mBook.BillingRate == mBook.UnitRate);
                                dto.MBooks.Add(mBook);
                            }
                        }
                    }
                    #endregion

                    #region Postings/RFIs

                    else
                    {
                        for (int i = 0; i &lt; itemsGrid.Rows.Count; i++)
                        {
                            var post = new PEPostings();
                            post.ID = itemsGrid.Rows[i].Cells.FromKey(&quot;PostingID&quot;).Text.ToInt32_2();
                            if (itemsGrid.Rows[i].Cells.Exists(&quot;ItemID&quot;))
                                post.ItemID = itemsGrid.Rows[i].Cells.FromKey(&quot;ItemID&quot;).Text.ToInt32_2();
                            if (itemsGrid.Rows[i].Cells.Exists(&quot;ActivityID&quot;))
                                post.ActivityID = itemsGrid.Rows[i].Cells.FromKey(&quot;ActivityID&quot;).Text.ToInt32_2();
                            if (dto.IsRFI)
                            {
                                post.MBQuantity = itemsGrid.Rows[i].Cells.FromKey(&quot;Quantity&quot;).Value.ToDecimal2();
                                post.CertifiedQuantity =
                                    itemsGrid.Rows[i].Cells.FromKey(&quot;Billed Qty&quot;).Value.ToDecimal2();
                            }
                            if (!WorkOrderType.Equals(&quot;E&quot;))
                            {
                                post.BillingRate = itemsGrid.Rows[i].Cells.FromKey(&quot;BillingRate&quot;).Value.ToDecimal2();
                                post.IsPartRate =
                                    !(itemsGrid.Rows[i].Cells.FromKey(&quot;UnitPrice&quot;).Value.ToDecimal2() ==
                                      itemsGrid.Rows[i].Cells.FromKey(&quot;BillingRate&quot;).Value.ToDecimal2());
                                post.ParentId = itemsGrid.Rows[i].Cells.FromKey(&quot;ParentID&quot;).Value.ToInt32_2();
                            }
                            dto.Postings.Add(post);
                        }
                    }

                    #endregion

                    if (IsFinal &amp;&amp; chkIsFinalRAB.Checked)
                    {
                        dto.IsFinal = true;
                        dto.RetentionReleaseDate = dtRetRel.Value.ToUtc();
                    }

                    #region Payestimate Prepayments

                    double totalPrePaymentsRecovered = 0;
                    for (int i = 0; i &lt; uwgPrePayment.Rows.Count; i++)
                    {
                        for (int j = 0; j &lt; uwgPrePayment.Rows[i].Rows.Count; j++)
                        {
                            UltraGridRow currentRow = uwgPrePayment.Rows[i].Rows[j];
                            var prepayment = new PEPrepayments
                            {
                                MOHID = int.Parse(currentRow.Cells.FromKey(&quot;MOHID&quot;).Text),
                                PrepaymentID = currentRow.Cells.FromKey(&quot;PrePaymentID&quot;).Text,
                                Amount = Decimal.Parse(currentRow.Cells.FromKey(&quot;Amount&quot;).Text),
                                CurrentRecovery =
                                                         Decimal.Parse(currentRow.Cells.FromKey(&quot;CurrentRecovery&quot;).Text)
                            };
                            dto.Prepayments.Add(prepayment);
                            totalPrePaymentsRecovered += Double.Parse(currentRow.Cells.FromKey(&quot;CurrentRecovery&quot;).Text);
                        }
                    }

                    #endregion

                    #region Pay Estimate Material Deductions

                    double totalMaterialRecovery = 0;
                    if (enableMaterialDeductions)
                    {
                        foreach (UltraGridRow ugr in uwgMaterialDeductions.Rows)
                        {
                            //Skip the rows with 0 amount
                            double tempAmount = 0;
                            if (ugr.Cells.FromKey(&quot;CurrentRecoveryAmount&quot;) != null)
                                Double.TryParse(ugr.Cells.FromKey(&quot;CurrentRecoveryAmount&quot;).Value.ToString2(),
                                                out tempAmount);
                            if (tempAmount &lt;= 0) continue;
                            totalMaterialRecovery += tempAmount;

                            var currDeduction = new PEMaterialDeduction
                            {
                                MIListID =
                                                            int.Parse(ugr.Cells.FromKey(&quot;MIListID&quot;).Value.ToString2()),
                                ResourceDetailID =
                                                            int.Parse(
                                                                ugr.Cells.FromKey(&quot;ResourceDetailID&quot;).Value.ToString2()),
                                RecoveredQuantity =
                                                            double.Parse(
                                                                ugr.Cells.FromKey(&quot;CurrentRecoveryQty&quot;).Value.ToString2()),
                                RecoveredRate =
                                                            double.Parse(
                                                                ugr.Cells.FromKey(&quot;CurrentRecoveryRate&quot;).Value.ToString2
                                                                    ()),
                            };
                            dto.MaterialDeductions.Add(currDeduction);
                        }
                    }

                    #endregion

                    #region Pay Estimate Adjustments

                    double totalAdditions = 0;
                    double totalDeductions = 0;
                    foreach (UltraGridRow ugr in uwgRABAdditions.Rows)
                    {
                        //Skip the rows with 0 amount
                        double tempAmount = 0;
                        if (ugr.Cells.FromKey(&quot;Amount&quot;) != null)
                            Double.TryParse(ugr.Cells.FromKey(&quot;Amount&quot;).Value.ToString2(), out tempAmount);
                        if (tempAmount &lt;= 0) continue;

                        var currAdjustment = new PEAdjustment
                        {
                            AdjustmentID = ugr.Cells.FromKey(&quot;AdjustmentID&quot;).Value.ToString2(),
                            AdjustmentDescription =
                                                         ugr.Cells.FromKey(&quot;AdjustmentDescription&quot;).Value.ToString2(),
                            AdjustmentType = 1,
                            Amount =
                                                         Double.Parse(ugr.Cells.FromKey(&quot;Amount&quot;).Value.ToString2())
                        };
                        dto.Adjustments.Add(currAdjustment);
                        totalAdditions += currAdjustment.Amount;
                    }

                    foreach (UltraGridRow ugr in uwgRABDeductions.Rows)
                    {
                        //Skip the rows with 0 amount
                        double tempAmount = 0;
                        if (ugr.Cells.FromKey(&quot;Amount&quot;) != null)
                            Double.TryParse(ugr.Cells.FromKey(&quot;Amount&quot;).Value.ToString2(), out tempAmount);
                        if (tempAmount &lt;= 0) continue;

                        var currAdjustment = new PEAdjustment
                        {
                            AdjustmentID = ugr.Cells.FromKey(&quot;AdjustmentID&quot;).Value.ToString2(),
                            AdjustmentDescription =
                                                         ugr.Cells.FromKey(&quot;AdjustmentDescription&quot;).Value.ToString2(),
                            AdjustmentType = 2,
                            Amount =
                                                         Double.Parse(ugr.Cells.FromKey(&quot;Amount&quot;).Value.ToString2())
                        };
                        dto.Adjustments.Add(currAdjustment);
                        totalDeductions += currAdjustment.Amount;
                    }

                    dto.AdditionsTotal = totalAdditions.ToDecimal2();
                    dto.DeductionsTotal = totalDeductions.ToDecimal2();

                    #endregion

                    double totalAmt, currRetentionValue;
                    double.TryParse(txtItemTotal.Value, out totalAmt);
                    if (totalAmt &lt; 0)
                        throw new Exception(&quot;Work done cannot be negative. Request denied.&quot;);
                    //currRetentionValue = (totalAmt - totalPrePaymentsRecovered - totalMaterialRecovery + totalAdditions -
                    //                      totalDeductions - txtCurrentHoldAmount.Value.ToDouble2() +
                    //                      txtHoldReleaseAmt.Value.ToDouble2()) * txtRetention.Value.ToDouble2() / 100;
                    // dto.RetAmtFromRule = ((currRetentionValue &gt; txtRetentionCV.Value.ToDouble2()) ? txtRetentionCV.Value.ToDouble2() : currRetentionValue).ToDecimal2();

                    //Calculate the Prepayment adv &amp; recovery, MOH adv and recover in the SP
                    if (rblRetChoice.SelectedValue.Equals(&quot;0&quot;))
                    {
                        currRetentionValue = (totalAmt - totalMaterialRecovery + totalAdditions -
                                             totalDeductions - txtCurrentHoldAmount.Value.ToDouble2() +
                                             txtHoldReleaseAmt.Value.ToDouble2()) * txtRetention.Value.ToDouble2() / 100;
                        dto.RetentionPercent = txtRetention.Value.ToDecimal2();
                        dto.RetentionMode = &quot;0&quot;;
                    }
                    else
                    {
                        currRetentionValue = txtRetentionValue.ValueDouble;
                        dto.RetentionMode = &quot;1&quot;;
                    }


                    dto.RetAmtFromRule = (currRetentionValue &lt; 0)
                                             ? 0
                                             : (((currRetentionValue &gt; txtRetentionCV.Value.ToDouble2())
                                                     ? txtRetentionCV.Value.ToDouble2()
                                                     : currRetentionValue).ToDecimal2());

                    dto.RetReleaseAmt = txtRetReleaseAmt.ValueDecimal;

                    #region

                    // Validation For Retention Amount

                    //if (DTRetAmtFromRule.Rows[0][0].ToDouble2() == txtRetentionCV.Value.ToDouble2())
                    //{
                    //    dto.RetAmtFromRule = 0;
                    //}
                    //else
                    //{
                    //    double totRetvalue;
                    //    totRetvalue = currRetentionValue + DTRetAmtFromRule.Rows[0][0].ToDouble2();
                    //    dto.RetAmtFromRule = (totRetvalue &gt; txtRetentionCV.Value.ToDouble2()) ? ((currRetentionValue - (totRetvalue - txtRetentionCV.Value.ToDouble2())).ToDecimal2()) : currRetentionValue.ToDecimal2();
                    //}
                    // This validation is not neccessary since it is done in back end 

                    #endregion

                    #endregion
                    //The prepayment recovery need not necessarily be recovered from the workdone alone, 
                    //it could be from any payable amount like Additions, Prepayments, Retention release, Hold Release etc.
                    //Hence the below validations is not required.
                    //if (totalPrePaymentsRecovered &gt; totalAmt)
                    //    throw new Exception(&quot;Prepayment recovered amount cannot be greater then total work done.&quot;);

                    newID = BL.Instance.CUDPE(contractID,
                                              Mode == PageMode.Edit ? PEOperations.Update : PEOperations.Create, dto);

                    UserDetail ud = UserDetail.GetCurrentUserDetail();
                    peAttachments.SaveAttachments(newID.ToString2(), FormName, ud.UID,
                        ud.UserName, &quot;Item Documents&quot;);

                    if (IsFinal &amp;&amp; !String.IsNullOrEmpty(Request[&quot;IsSubmit&quot;]) &amp;&amp; Request[&quot;IsSubmit&quot;].Equals(&quot;1&quot;))
                        newID = BL.Instance.CUDPE(contractID, PEOperations.Submit, dto);
                }

                if (Mode != PageMode.Edit)
                    sSavedInstanceToken = newID.ToString();
                else
                    sSavedInstanceToken = Request[&quot;PEID&quot;];

                return true;
            }
            catch (Exception ex)
            {
                base.ShowError(ex.Message.Replace(&quot;LOC_ITEM_ABBR&quot;, LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)));
                return false;
            }
        }

        #endregion

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);
            SetPageMode();

            if (Request[&quot;WOType&quot;] != null)
                WorkOrderType = Request[&quot;WOType&quot;].ToString2();

            #region Redirect User if any of the QueryString parameters are found to be missing / having unacceptable values

            if (String.IsNullOrEmpty(Request[Constants.QRY_PROJECTID]) || String.IsNullOrEmpty(Request[&quot;ContractID&quot;]) ||
                !Int32.TryParse(Request[&quot;ContractID&quot;], out contractID) || contractID &lt;= 0)
                Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID],
                                  true);

            if ((Mode == PageMode.Edit || Mode == PageMode.View) &amp;&amp; String.IsNullOrEmpty(Request[&quot;PEID&quot;]))
                Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID],
                                  true);

            #endregion

            hdnItemPostings.Value = String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                        ? (BL.Instance.GetContrItemSource(Request[&quot;ContractID&quot;].ToInt32_2(), &quot;P&quot;).Equals
                                               (&quot;RFI&quot;)
                                               ? &quot;0&quot;
                                               : &quot;1&quot;)
                                        : (BL.Instance.GetContrItemSource(Request[&quot;ContractID&quot;].ToInt32_2(), &quot;S&quot;).Equals
                                               (&quot;IP&quot;)
                                               ? &quot;0&quot;
                                               : &quot;1&quot;);

            #region Check if Material Issue Module is Uploaded

            Dictionary&lt;string, string&gt; dicContractModules = ModuleManager.Instance.GetModuleListByParent(&quot;CONTMGT&quot;);
            if (dicContractModules != null &amp;&amp; dicContractModules.ContainsKey(&quot;MATRISS&quot;) &amp;&amp;
                !String.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp; IsERPConnected)
                enableMaterialDeductions = true;
            else
                enableMaterialDeductions = false;

            #endregion

            #region Initializing the Material Issue Picker

            genericMIPicker = (ucMIPicker as GenericPickerControl);

            genericMIPicker.BackClicked += btnCancelMIPicker_Click;
            genericMIPicker.ItemSelected += genericMIPicker_ItemSelected;
            genericMIPicker.BindData += genericMIPicker_BindData;
            genericMIPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            genericMIPicker.DefaultSortColumn = &quot;MIListID&quot;;
            genericMIPicker.EnableMultipleSelect = true;
            genericMIPicker.DisplayFilter = false;
            genericMIPicker.StateMgmtContext = &quot;MIPicker&quot;;

            //Hidden Columns
            genericMIPicker.ModifyColumnProperties(&quot;MIListID&quot;, true, null, null, null, false);
            genericMIPicker.ModifyColumnProperties(&quot;ResourceDetailID&quot;, true, null, null, null, false);
            genericMIPicker.ModifyColumnProperties(&quot;CurrentRecoveryQty&quot;, true, null, null, null, false);
            genericMIPicker.ModifyColumnProperties(&quot;CurrentRecoveryRate&quot;, true, null, null, null, false);
            genericMIPicker.ModifyColumnProperties(&quot;CurrentRecoveryAmount&quot;, true, null, null, null, false);

            //Visible Columns
            genericMIPicker.ModifyColumnProperties(&quot;MaterialIssueID&quot;, false, 1, null, &quot;100&quot;, false, &quot;Material Issue ID&quot;);
            genericMIPicker.ModifyColumnProperties(&quot;IssuedDate&quot;, false, 2, AMP3ApplicationSettings.Instance.FORMAT_DATE, &quot;80&quot;, false,
                                                   &quot;Issue Date&quot;);
            genericMIPicker.ModifyColumnProperties(&quot;IssueType&quot;, false, 3, null, &quot;80&quot;, false, &quot;Issue Type&quot;);
            genericMIPicker.ModifyColumnProperties(&quot;ResDescription&quot;, false, 4, null, &quot;100&quot;, false, &quot;Description&quot;);
            genericMIPicker.ModifyColumnProperties(&quot;ParentResItemID&quot;, false, 5, null, &quot;80&quot;, false, &quot;Resource ID&quot;);
            genericMIPicker.ModifyColumnProperties(&quot;Size&quot;, false, 6, null, &quot;80&quot;, false);
            genericMIPicker.ModifyColumnProperties(&quot;Color&quot;, false, 7, null, &quot;80&quot;, false);
            genericMIPicker.ModifyColumnProperties(&quot;Configuration&quot;, false, 8, null, &quot;80&quot;, false);
            genericMIPicker.ModifyColumnProperties(&quot;IssuedQty&quot;, false, 9, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, &quot;120&quot;, false,
                                                   &quot;Issued Quantity&quot;);
            genericMIPicker.ModifyColumnProperties(&quot;IssuedRate&quot;, false, 10, AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE, &quot;120&quot;, false,
                                                   &quot;Issued Rate&quot;);
            genericMIPicker.ModifyColumnProperties(&quot;RemainingQty&quot;, false, 11, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, &quot;120&quot;, false,
                                                   &quot;Remaining Quantity&quot;);

            #endregion

            #region Initializing the Adjustments Picker

            genericAdjustmentPicker = (ucAdjustmentPicker as GenericPickerControl);

            genericAdjustmentPicker.BackClicked += btnCancelAdjustmentPicker_Click;
            genericAdjustmentPicker.ItemSelected += genericAdjustmentPicker_ItemSelected;
            genericAdjustmentPicker.BindData += genericAdjustmentPicker_BindData;
            genericAdjustmentPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            genericAdjustmentPicker.DefaultSortColumn = &quot;AdjustmentID&quot;;
            genericAdjustmentPicker.EnableMultipleSelect = true;
            genericAdjustmentPicker.DisplayFilter = false;
            genericAdjustmentPicker.StateMgmtContext = &quot;AdjustmentPicker&quot;;

            //Hidden Columns
            genericAdjustmentPicker.ModifyColumnProperties(&quot;ID&quot;, true, null, null, null, false);
            genericAdjustmentPicker.ModifyColumnProperties(&quot;AdjustmentType&quot;, true, null, null, null, false);
            genericAdjustmentPicker.ModifyColumnProperties(&quot;Amount&quot;, true, null, null, null, false);
            genericAdjustmentPicker.ModifyColumnProperties(&quot;Adjustment Type&quot;, true, null, null, null, false);

            //Visible Columns
            genericAdjustmentPicker.ModifyColumnProperties(&quot;AdjustmentID&quot;, false, 1, null, &quot;80&quot;, false, &quot;Label&quot;);
            genericAdjustmentPicker.ModifyColumnProperties(&quot;AdjustmentDescription&quot;, false, 2, null, &quot;120&quot;, false,
                                                           &quot;Description&quot;);

            #endregion

            #region Initializing the Measurement Book Picker

            genericMBookPicker = (ucMBookPicker as GenericPickerControl);
            genericMBookPicker.BackClicked += btnCancelMbookPicer_Click;
            genericMBookPicker.ItemSelected += genericMbookPicker_ItemSelected;
            genericMBookPicker.BindData += genericMBookPicker_BindData;
            genericMBookPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            genericMBookPicker.DefaultSortColumn = &quot;MBookID&quot;;
            genericMBookPicker.EnableMultipleSelect = true;
            genericMBookPicker.DisplayFilter = true;
            genericMBookPicker.IsFilterXml = true;
            genericMBookPicker.Filters = (WorkOrderType == &quot;A&quot;) ? SetActivityMBookFilters() : SetItemMBookFilters();
            genericMBookPicker.StateMgmtContext = &quot;MBookPicker&quot;;

            var grdMBook = (UltraWebGrid)genericMBookPicker.FindControl(&quot;GridMain&quot;);
            grdMBook.DisplayLayout.ClientSideEvents.DblClickHandler = &quot;&quot;;
            grdMBook.DisplayLayout.ClientSideEvents.BeforeCellUpdateHandler = &quot;MBPicker_BeforeCellUpdateHandler&quot;;

            grdMBook.DisplayLayout.ClientSideEvents.BeforeCellUpdateHandler = &quot;MBPicker_BeforeCellUpdateHandler&quot;;

            genericMBookPicker.ModifyColumnProperties(&quot;WorkOrderNo&quot;, true, null, null, null, false);
            genericMBookPicker.ModifyColumnProperties(&quot;LineNo&quot;, false, 3, null, null, false, &quot;Line No&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;StandardItemNo&quot;, false, 4, null, null, false, LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO));
            genericMBookPicker.ModifyColumnProperties(&quot;Description&quot;, false, 5, null, null, false, &quot;Description&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;BillingQty&quot;, false, 8, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null, true,
                                                      &quot;Billing Qty&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;Quantity&quot;, false, 6, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null, false,
                                                      &quot;Certified Qty&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;MBookID&quot;, false, 1, null, null, false, LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; ID&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;ID&quot;, true, null, null, null, false);
            genericMBookPicker.ModifyColumnProperties(&quot;MBookNo&quot;, true, 2, null, null, false, &quot;MBook No&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;ItemID&quot;, true, null, null, null, false);
            genericMBookPicker.ModifyColumnProperties(&quot;MaxAvailQty&quot;, false, 7, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null, false,
                                                      &quot;Remaining Qty&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;BilledQty&quot;, false, 8, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null, false,
                                                      &quot;Cumulative Billed Qty&quot;);

            genericMBookPicker.ModifyColumnProperties(&quot;ActivityID&quot;, true, null, null, null, false);
            genericMBookPicker.ModifyColumnProperties(&quot;SubItemID&quot;, true, null, null, null, false);
            genericMBookPicker.ModifyColumnProperties(&quot;ActivityName&quot;, false, 7, null, null, false, &quot;Activity Name&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;SubItem&quot;, false, 6, null, null, false, &quot;SubItem&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;BOQDescription&quot;, false, 5, null, null, false, LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR) + &quot; Description&quot;);
            genericMBookPicker.ModifyColumnProperties(&quot;ActivityDescription&quot;, false, 8, null, null, false,
                                                      &quot;Activity Description&quot;);

            #endregion

            #region Initializing the Part Rate Measurement Book Picker

            genericPRMBookPicker = (ucPartRateMBookPicker as GenericPickerControl);
            genericPRMBookPicker.BackClicked += btnCancelPRMbookPicer_Click;
            genericPRMBookPicker.ItemSelected += genericPRMbookPicker_ItemSelected;
            genericPRMBookPicker.BindData += genericPRMBookPicker_BindData;
            genericPRMBookPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            genericPRMBookPicker.DefaultSortColumn = &quot;MBookID&quot;;
            genericPRMBookPicker.EnableMultipleSelect = true;
            genericPRMBookPicker.DisplayFilter = true;
            genericPRMBookPicker.IsFilterXml = true;
            genericPRMBookPicker.Filters = (WorkOrderType == &quot;A&quot;) ? SetActivityPRMBookFilters() : SetItemPRMBookFilters();
            genericPRMBookPicker.StateMgmtContext = &quot;PRMBookPicker&quot;;

            genericPRMBookPicker.ModifyColumnProperties(&quot;WorkOrderNo&quot;, true, null, null, null, false);
            genericPRMBookPicker.ModifyColumnProperties(&quot;MBookList&quot;, true, null, null, null, false);
            genericPRMBookPicker.ModifyColumnProperties(&quot;LineNo&quot;, false, null, null, null, false, &quot;Line No&quot;);
            genericPRMBookPicker.ModifyColumnProperties(&quot;StandardItemNo&quot;, false, null, null, null, false, LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO));
            genericPRMBookPicker.ModifyColumnProperties(&quot;BillingQty&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null,
                                                        false, &quot;Billing Qty&quot;);
            genericPRMBookPicker.ModifyColumnProperties(&quot;CertifiedQty&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null,
                                                        false, &quot;Certified Qty&quot;);
            genericPRMBookPicker.ModifyColumnProperties(&quot;MBook Quantity&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null,
                                                        false, &quot;MBook Qty&quot;);
            genericPRMBookPicker.ModifyColumnProperties(&quot;ItemID&quot;, true, null, null, null, false);
            genericPRMBookPicker.ModifyColumnProperties(&quot;ActivityID&quot;, true, null, null, null, false);
            genericPRMBookPicker.ModifyColumnProperties(&quot;IsPartRate&quot;, true, null, null, null, false);
            genericPRMBookPicker.ModifyColumnProperties(&quot;ParentID&quot;, true, null, null, null, false);
            genericPRMBookPicker.ModifyColumnProperties(&quot;MaxAllowedPrice&quot;, true, null, null, null, false);
            genericPRMBookPicker.ModifyColumnProperties(&quot;MBookQuantity&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null,
                                                        false, &quot;MBook Qty&quot;);
            genericPRMBookPicker.ModifyColumnProperties(&quot;BillingRate&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null, false,
                                                        &quot;Billing Rate in &quot; +
                                                        LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL));
            genericPRMBookPicker.ModifyColumnProperties(&quot;MaxAvailQty&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null,
                                                        false, &quot;Remaining Qty&quot;);
            genericPRMBookPicker.ModifyColumnProperties(&quot;ActivityName&quot;, false, null, null, null, false, &quot;Activity Name&quot;);
            genericPRMBookPicker.ModifyColumnProperties(&quot;UnitPrice&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null, false,
                                                        LocalizationManager.GetString(KeyConstants.LOC_UNIT_PRICE));
            genericPRMBookPicker.ModifyColumnProperties(&quot;Amount&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null, false,
                                                        LocalizationManager.GetString(KeyConstants.LOC_AMOUNT));
            genericPRMBookPicker.ModifyColumnProperties(&quot;BOQDescription&quot;, false, null, null, null, false, LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR) + &quot; Description&quot;);
            genericPRMBookPicker.ModifyColumnProperties(&quot;ActivityDescription&quot;, false, null, null, null, false, &quot;Activity Description&quot;);

            #endregion

            #region Initializing the Part Rate RFI Picker

            genericPRRFIPicker = (ucPartRateRFIPicker as GenericPickerControl);
            genericPRRFIPicker.BackClicked += btnCancelPRRFIPicker_Click;
            genericPRRFIPicker.ItemSelected += genericPRRFIPicker_ItemSelected;
            genericPRRFIPicker.BindData += genericPRRFIPicker_BindData;
            genericPRRFIPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            genericPRRFIPicker.DefaultSortColumn = &quot;RFINo&quot;;
            genericPRRFIPicker.EnableMultipleSelect = true;
            genericPRRFIPicker.IsFilterXml = true;
            genericPRRFIPicker.DisplayFilter = true;
            genericPRRFIPicker.Filters = SetPRFilters();
            genericPRRFIPicker.StateMgmtContext = &quot;PRRFIPicker&quot;;

            //if (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) || (!String.IsNullOrEmpty(Request[&quot;WOType&quot;]) &amp;&amp; !Request[&quot;WOType&quot;].Equals(&quot;A&quot;)))
            //    genericPRRFIPicker.ModifyColumnProperties(&quot;PostingID&quot;, true, null, null, null, false);
            //else
            //    genericPRRFIPicker.ModifyColumnProperties(&quot;PostingID&quot;, false, null, null, null, false, &quot;Posting Id&quot;);
            genericPRRFIPicker.ModifyColumnProperties(&quot;PostingID&quot;, true, null, null, null, false);
            genericPRRFIPicker.ModifyColumnProperties(&quot;ItemId&quot;, true, null, null, null, false);
            genericPRRFIPicker.ModifyColumnProperties(&quot;Status&quot;, true, null, null, null, false);
            genericPRRFIPicker.ModifyColumnProperties(&quot;PDate&quot;, true, null, null, null, false);
            genericPRRFIPicker.ModifyColumnProperties(&quot;IsPartRate&quot;, true, null, null, null, false);
            genericPRRFIPicker.ModifyColumnProperties(&quot;ParentId&quot;, true, null, null, null, false);
            genericPRRFIPicker.ModifyColumnProperties(&quot;ActivityID&quot;, true, null, null, null, false);
            genericPRRFIPicker.ModifyColumnProperties(&quot;SubItemDescription&quot;, false, null, null, null, false,
                                                          ((String.IsNullOrEmpty(Request[&quot;WOID&quot;])) &amp;&amp;
                                                           hdnItemPostings.Value.Equals(&quot;0&quot;))
                                                              ? &quot;Location&quot;
                                                              : (WorkOrderType.Equals(&quot;A&quot;) ? &quot;Description&quot; : &quot;Sub Item&quot;));
            genericPRRFIPicker.ModifyColumnProperties(&quot;StdItemID&quot;, false, null, null, null, false, &quot;Standard Item No&quot;);
            genericPRRFIPicker.ModifyColumnProperties(&quot;Submitted Qty&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null,
                                                      false, &quot;Submitted Qty&quot;);
            genericPRRFIPicker.ModifyColumnProperties(&quot;Billed Qty&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null, false);
            genericPRRFIPicker.ModifyColumnProperties(&quot;Unit Price&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null, false,
                                                      LocalizationManager.GetString(KeyConstants.LOC_UNIT_PRICE));
            genericPRRFIPicker.ModifyColumnProperties(&quot;MaxAllowedPrice&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null,
                                                      false,
                                                      &quot;Available Price in &quot; +
                                                      LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL));
            genericPRRFIPicker.ModifyColumnProperties(&quot;Amt Placed&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null, false,
                                                      &quot;Amount placed in &quot; +
                                                      LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL));
            genericPRRFIPicker.ModifyColumnProperties(&quot;BillingRate&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null, false,
                                                      &quot;Billing Rate in &quot; +
                                                      LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL));
            genericPRRFIPicker.ModifyColumnProperties(&quot;RFINo&quot;, false, null, null, null, false, &quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; No&quot;);

            genericPRRFIPicker.ModifyColumnProperties(&quot;PostedQty&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null, false,
                                                      &quot;Quantity&quot;);
            genericPRRFIPicker.ModifyColumnProperties(&quot;LineNo&quot;, false, null, null, null, false, &quot;Line No&quot;);

            #endregion

            #region Updating the Material Issues with the latest status from AX

            if (!IsPostBack &amp;&amp; enableMaterialDeductions)
            {
                //Disabled the update of MI status and issued quantity for Integration Date Mode
                if (!CacheManager.Instance.IsIntegrated(PID))
                    UpdateMIStatusFromAX();
            }

            #endregion

            peAttachments.InstanceID = FormInstanceId;
            peAttachments.ReadOnly = IsView;

            #region Prepayment Pop Up
            //ModalPopupExtender popupExtender = (ModalPopupExtender)this.Master.FindControl(&quot;filterExtender&quot;);
            popupExtender1.AddNewPopup(pnlPPGrid.ClientID, btnAddPrepayments.ClientID, btnCancel.ClientID, 300, 500, Header: &quot;Pre-Payment List&quot;);

            #endregion
        }

        private void SetPageMode()
        {
            string tempMode = String.IsNullOrEmpty(Request[&quot;Mode&quot;]) ? &quot;New&quot; : Request[&quot;Mode&quot;].ToString2();
            switch (tempMode)
            {
                case &quot;New&quot;:
                    Mode = PageMode.New;
                    break;
                case &quot;Edit&quot;:
                    Mode = PageMode.Edit;
                    break;
                case &quot;View&quot;:
                    Mode = PageMode.View;
                    break;
            }
        }

        private void UpdateMIStatusFromAX()
        {
            //TODO: Get Status ONLY for Records whose status is unknown, NOT all records in the contract
            //DataTable dtMIToBoIssued = Aurigo.AMP3.ContractManager.BusinessLayer.BL.Instance.GetMaterialIssuesToBeIssued(contractID);
            string filterCriteria = &quot;&quot;;

            DataTable dtProj = IntegrationConnectorManager.Instance.GetERPObjectMapInfo(contractID.ToString2(),
                                                                                        AMP3Object.CONTMGT, null,
                                                                                        AMP3Object.UNKNOWN,
                                                                                        RegisteredEIS.AX);
            if (dtProj.Rows.Count &gt; 0)
            {
                filterCriteria = &quot;&lt;XMLRoot&gt;&lt;ProjId type=&#39;txt&#39;&gt;&quot; + dtProj.Rows[0][&quot;ERPId&quot;].ToString2() +
                                 &quot;&lt;/ProjId&gt;&lt;/XMLRoot&gt;&quot;;
            }
            else //When the contract has not been mapped in AX
                return;

            var filter = new ConnectionFilter(filterCriteria, null, null, null, null);

            string additionalInfo = Session[Constants.EIS_ADDITIONAL_INFO] != null
                                        ? Session[Constants.EIS_ADDITIONAL_INFO].ToString2()
                                        : &quot;&quot;;
            var objAdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
            objAdditionalInfo.AddInfo(Constants.EIS_ADDITIONAL_INFO, additionalInfo);

            var dictAdditionalInfo = new Dictionary&lt;RegisteredEIS, EISAdditionalInfo&gt;();
            dictAdditionalInfo.Add(RegisteredEIS.AX, objAdditionalInfo);
            var ConnectorParameters =
                new ConnectorParameters(dictAdditionalInfo, MethodBase.GetCurrentMethod(),
                                        AMP3ObjectType.Unknown, filter, null);
            DataSet ds = new BrixDataSet();
            int count = 0;
            if (IntegrationConnectorManager.HandleIntegration(ConnectorParameters, ref count, ref ds, true) &amp;&amp;
                !CacheManager.Instance.IsIntegrated(PID))
            {
                ContractManager.BusinessLayer.BL.Instance.UpdateMIStatusFromERPToBrix(ds.Tables[0]);
            }
        }

        private void ShowDiv(MIDivEnums divType)
        {
            ToogleDiv(DivMIPicker, (divType == MIDivEnums.MIPicker));
            ToogleDiv(divAdjustmentPicker, (divType == MIDivEnums.AdjustmentPicker));
            ToogleDiv(divCreatePE, (divType == MIDivEnums.CreatePE));
            ToogleDiv(divMBookPicker, (divType == MIDivEnums.MBPicker));
            ToogleDiv(divPartRatePicker, (divType == MIDivEnums.PRMBPicker));
            ToogleDiv(divPartRateRFIPicker, (divType == MIDivEnums.PRRFIPicker));

            if (divType == MIDivEnums.CreatePE)
                SetLocalizedStrings();

            switch (divType)
            {
                case MIDivEnums.AdjustmentPicker:
                case MIDivEnums.MBPicker:
                case MIDivEnums.MIPicker:
                case MIDivEnums.PRMBPicker:
                case MIDivEnums.PRRFIPicker:
                    MainToolBar.Visible = false;
                    break;
                case MIDivEnums.CreatePE:
                    MainToolBar.Visible = true;
                    break;
            }
        }

        private void ToogleDiv(HtmlGenericControl div, bool display)
        {
            div.Visible = display;
        }

        private void MakeControlsReadOnlyExceptComments(bool isReadOnly)
        {
            dtToDt.ReadOnly = txtCurrentHoldAmount.ReadOnly = txtHoldReleaseAmt.ReadOnly = txtHoldRelease.ReadOnly =
                                                              txtRetention.ReadOnly = txtRetentionValue.ReadOnly = txtHoldPercent.ReadOnly =
                                                                                           //txtHoldAmount.ReadOnly =
                                                                                           isReadOnly;
            chkRecFullContractAdvance.Enabled = btnGen.Enabled = btnItemsDelete.Enabled =
                                                                 btnAddAdditions.Enabled =
                                                                 btnAddDeductions.Enabled =
                                                                 btnAddPrepayments.Enabled =
                                                                 btnDeletePrepayments.Enabled =
                                                                 btnDelMaterialDeductions.Enabled =
                                                                 btnDelAdditions.Enabled =
                                                                 btnDelDeductions.Enabled =
                                                                 btnAddMaterialDeductions.Enabled =
                                                                 rblRetChoice.Enabled = !isReadOnly;

            uwgPrePayment.Columns.FromKey(&quot;CurrentRecovery&quot;).CellStyle.BackColor = isReadOnly
                                                                                       ? Color.White
                                                                                       : Color.Yellow;
            uwgPrePayment.Columns.FromKey(&quot;CurrentRecovery&quot;).AllowUpdate = isReadOnly ? AllowUpdate.No : AllowUpdate.Yes;

            if (uwgRABAdditions.Columns.Exists(&quot;AdjustmentDescription&quot;))
            {
                uwgRABAdditions.Columns.FromKey(&quot;AdjustmentDescription&quot;).CellStyle.BackColor = isReadOnly
                                                                                                   ? Color.White
                                                                                                   : Color.Yellow;
                uwgRABAdditions.Columns.FromKey(&quot;AdjustmentDescription&quot;).AllowUpdate = isReadOnly
                                                                                           ? AllowUpdate.No
                                                                                           : AllowUpdate.Yes;
            }
            if (uwgRABAdditions.Columns.Exists(&quot;Amount&quot;))
            {
                uwgRABAdditions.Columns.FromKey(&quot;Amount&quot;).CellStyle.BackColor = isReadOnly ? Color.White : Color.Yellow;
                uwgRABAdditions.Columns.FromKey(&quot;Amount&quot;).AllowUpdate = isReadOnly ? AllowUpdate.No : AllowUpdate.Yes;
            }
            if (uwgRABDeductions.Columns.Exists(&quot;AdjustmentDescription&quot;))
            {
                uwgRABDeductions.Columns.FromKey(&quot;AdjustmentDescription&quot;).CellStyle.BackColor = isReadOnly
                                                                                                    ? Color.White
                                                                                                    : Color.Yellow;
                uwgRABDeductions.Columns.FromKey(&quot;AdjustmentDescription&quot;).AllowUpdate = isReadOnly
                                                                                            ? AllowUpdate.No
                                                                                            : AllowUpdate.Yes;
            }
            if (uwgRABDeductions.Columns.Exists(&quot;Amount&quot;))
            {
                uwgRABDeductions.Columns.FromKey(&quot;Amount&quot;).CellStyle.BackColor = isReadOnly ? Color.White : Color.Yellow;
                uwgRABDeductions.Columns.FromKey(&quot;Amount&quot;).AllowUpdate = isReadOnly ? AllowUpdate.No : AllowUpdate.Yes;
            }
            if (itemsGrid != null &amp;&amp; isReadOnly)
            {
                ColumnsCollection cols = itemsGrid.Columns;
                if (cols.Exists(&quot;BillingRate&quot;))
                {
                    cols.FromKey(&quot;BillingRate&quot;).AllowUpdate = AllowUpdate.No;
                    cols.FromKey(&quot;BillingRate&quot;).CellStyle.BackColor = Color.White;
                }
            }
            btnPRRFIAdd.Enabled = !isReadOnly;
            if (uwgMaterialDeductions != null &amp;&amp; isReadOnly)
            {
                ColumnsCollection cols = uwgMaterialDeductions.Columns;
                if (cols.Exists(&quot;CurrentRecoveryQty&quot;))
                {
                    cols.FromKey(&quot;CurrentRecoveryQty&quot;).AllowUpdate = AllowUpdate.No;
                    cols.FromKey(&quot;CurrentRecoveryQty&quot;).CellStyle.BackColor = Color.White;
                }
                if (cols.Exists(&quot;CurrentRecoveryRate&quot;))
                {
                    cols.FromKey(&quot;CurrentRecoveryRate&quot;).AllowUpdate = AllowUpdate.No;
                    cols.FromKey(&quot;CurrentRecoveryRate&quot;).CellStyle.BackColor = Color.White;
                }
            }
            if (gridMBooks != null &amp;&amp; isReadOnly)
            {
                ColumnsCollection cols = gridMBooks.Columns;
                if (cols.Exists(&quot;BillingQty&quot;))
                {
                    cols.FromKey(&quot;BillingQty&quot;).AllowUpdate = AllowUpdate.No;
                    cols.FromKey(&quot;BillingQty&quot;).CellStyle.BackColor = Color.White;
                }
            }
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            uwgPrePayment.DisplayLayout.FrameStyle.Width = new Unit(&quot;100%&quot;);
            uwgPrePayment.DisplayLayout.FrameStyle.Height = new Unit(&quot;350px&quot;);
            uwgRABDeductions.DisplayLayout.FrameStyle.Width = new Unit(&quot;100%&quot;);
            uwgRABAdditions.DisplayLayout.FrameStyle.Width = new Unit(&quot;100%&quot;);

            if (!IsPostBack)
            {
                ViewState[&quot;canBeSaved&quot;] = true;

                wdcCreatedOn.CalendarLayout.Culture = DateFormatCulture.GetDateFormatCulture();
                wdcCreatedOn.MinDate = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : DefaultRecordDate.ToMWDateTime();
                wdcCreatedOn.MaxDate = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : IntegrationCutoffDate.ToMWDateTime();
                wdcCreatedOn.Value = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : DefaultRecordDate.ToMWDateTime();
                wdcCreatedOn.Enabled = !ProjectMode.Equals(&quot;L&quot;);

                //Restricting construction through date to current date.
                //dtToDt.MaxDate = DateTime.Today;

                lblItemHeader.Text = (!String.IsNullOrEmpty(Request[&quot;WOType&quot;]) &amp;&amp; Request[&quot;WoType&quot;].Equals(&quot;E&quot;))
                                         ? &quot;Equipment Logs&quot;
                                         : BL.Instance.GetItemGridHeader(
                                             (String.IsNullOrEmpty(Request[&quot;WOID&quot;])) ? 0 : Request[&quot;WOID&quot;].ToInt32_2(),
                                             Request[&quot;ContractID&quot;].ToInt32_2());

                #region User Role/Permissions related changes

                UIHelper.DisableRoleSelection(Page);

                #endregion

                #region Various attributes added to the Page Controls

                itemsGrid.Height = Unit.Pixel(300);
                //txtComments.Attributes.Add(&quot;maxLength&quot;, &quot;250&quot;);
                dtToDt.CalendarLayout.Culture = DateFormatCulture.GetDateFormatCulture();
                chkRecFullContractAdvance.Attributes.Add(&quot;onClick&quot;, &quot;SetRecoveryPercent()&quot;);
                chkRecFullMaterials.Attributes.Add(&quot;onClick&quot;, &quot;RecFullMaterials()&quot;);
                wceContAdvPercentRec.ReadOnly = true;
                RABillNoTitle.Text = LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; Number :&quot;;
                ContractorTitle.Text = String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? &quot;Prime Contractor :&quot; : &quot;Sub Contractor :&quot;;
                trWorkOrderNo.Visible = !String.IsNullOrEmpty(Request[&quot;WOID&quot;]);

                #endregion

                ViewState[viewStateFirstPE] = false;

                #region Initial selection of Contractor Type

                HideContractorSelection();
                hdnItemPostings.Value = (ContractorTitle.Text.Equals(&quot;Prime Contractor :&quot;))
                                            ? (BL.Instance.GetContrItemSource(Request[&quot;ContractID&quot;].ToInt32_2(), &quot;P&quot;).
                                                   Equals(&quot;RFI&quot;)
                                                   ? &quot;0&quot;
                                                   : &quot;1&quot;)
                                            : (BL.Instance.GetContrItemSource(Request[&quot;ContractID&quot;].ToInt32_2(), &quot;S&quot;).
                                                   Equals(&quot;IP&quot;)
                                                   ? &quot;0&quot;
                                                   : &quot;1&quot;);
                btnPRRFIAdd.Visible = (ContractorTitle.Text.Equals(&quot;Prime Contractor :&quot;) ||
                                       (!ContractorTitle.Text.Equals(&quot;Prime Contractor :&quot;) &amp;&amp;
                                        hdnItemPostings.Value.Equals(&quot;0&quot;) &amp;&amp;
                                        (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ||
                                         (!String.IsNullOrEmpty(Request[&quot;WOType&quot;]) &amp;&amp; !Request[&quot;WoType&quot;].Equals(&quot;E&quot;)))));
                trMB.Style.Add(&quot;display&quot;,
                               (!(!String.IsNullOrEmpty(Request[&quot;WOType&quot;]) &amp;&amp; Request[&quot;WoType&quot;].Equals(&quot;E&quot;)) &amp;&amp;
                                !String.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp; hdnItemPostings.Value.Equals(&quot;1&quot;))
                                   ? &quot;block&quot;
                                   : &quot;none&quot;);
                //If in Edit or View mode, take care of Selection of Prime/Sub Contractor RadioButton first!
                DataSet ds = null;
                if (Mode == PageMode.Edit || Mode == PageMode.View)
                {
                    hdnGenClicked.Value = &quot;1&quot;;
                    //Get all the PE Data in one shot here
                    ds = BL.Instance.GetPE(contractID, Request[&quot;PEID&quot;].ToInt32_2(),
                                           (String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                ? (int?)null
                                                : int.Parse(Request[&quot;WOID&quot;])));

                    if (ds.Tables[0].Rows[0][&quot;ContractorType&quot;].ToString2().Equals(&quot;P&quot;))
                    {
                        rblContractorType.SelectedIndex = 0;
                    }
                    else
                    {
                        rblContractorType.SelectedIndex = 1;
                    }
                    ContractorType_Changed(this, new EventArgs());

                    // if RAB is approved or IsChange ==&#39;N&#39; then dont save the record on workflow button click

                    if (ds.Tables[0].Rows[0][&quot;IsChange&quot;].ToString2().Equals(&quot;N&quot;)
                        ||
                        ds.Tables[0].Rows[0][&quot;PEApproved&quot;].ToString2().Equals(&quot;Y&quot;)
                        )
                    {
                        // Dont show the save button and save set the canBeSaved to False
                        //canBeSaved = false;
                        ViewState[&quot;canBeSaved&quot;] = false;
                    }
                }
                else //If New RAB and RAB type is Workorder, then populate(and select) subcontractor and workorder
                {
                    RABillNo.Text = BL.Instance.GetNextPEID(contractID,
                                                            String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                                ? (int?)null
                                                                : int.Parse(Request[&quot;WOID&quot;]));
                    if (!String.IsNullOrEmpty(Request[&quot;WOID&quot;]))
                    {
                        rblContractorType.SelectedIndex = 1;
                        WorkOrderDTO wo = WORKORDManager.Instance.GetWorkOrderDetails(int.Parse(Request[&quot;WOID&quot;]));
                        LoadContractors(); //It&#39;ll load the subcontractors.
                        String contractor = wo.ContractorID + &quot;,S&quot;;
                        ddlContractor.SelectedValue = ddlContractor.Items.FindByValue(contractor).Value;
                        PopulateWO(Request[&quot;WOID&quot;]);

                        WONumber.Text = ddlWorkOrder.SelectedItem.Text;
                    }
                    else
                    {
                        //Invoke the Event handler on change of contractor type - populates the Contractor/WO lists
                        ContractorType_Changed(this, new EventArgs());
                    }
                    Contractor.Text = ddlContractor.SelectedItem.Text;
                }


                //Now change the Label of Contract Advance based on Prime/Subcontractor
                if (rblContractorType.SelectedIndex == 0) //Prime Contractor
                    lblTotalContractAdvancehead.Text = &quot;Total &quot; + LocalizedContractName + &quot; Advance Received:&quot;;

                #endregion

                dtFromDt.Value = dtToDt.Value = null;
                hdnAdjustmentType.Value = &quot;1&quot;;
                lblTotMaterialDeductions.Text =
                    lblTotalAdditions.Text =
                    lblTotalDeductions.Text = lblAXOpeningBalances.Text = (0).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                FormatMaterialDeductionsGrid();
                FormatAdjustmentsGrid(uwgRABAdditions);
                FormatAdjustmentsGrid(uwgRABDeductions);

                if (settings.Tiered == &quot;Y&quot;)
                {
                    retTR.Style.Value = &quot;display:none&quot;;
                }

                btnMBPicker.Visible = ((!String.IsNullOrEmpty(Request[&quot;WOID&quot;])) &amp;&amp; hdnItemPostings.Value.Equals(&quot;1&quot;) &amp;&amp;
                                       Mode != PageMode.View);

                if (Mode == PageMode.Edit || Mode == PageMode.View)
                {

                    #region Redirect to View page if PE is approved, to Pay Estimates List page if there is any error

                    if (ds.Tables.Count &gt; 0 &amp;&amp; ds.Tables[0].Rows.Count &gt; 0)
                    {
                        try
                        {
                            if (Mode == PageMode.Edit &amp;&amp;
                                (ds.Tables[0].Rows[0][&quot;PEApproved&quot;].ToString2() == &quot;Y&quot; ||
                                 ds.Tables[0].Rows[0][&quot;IsChange&quot;].ToString2() == &quot;N&quot;))
                            {
                                //Response.Redirect(&quot;CreateEstimate.aspx?Mode=View&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] + &quot;&amp;ContractID=&quot; + contractID.ToString2() + &quot;&amp;PEID=&quot; + Request[&quot;PEID&quot;] + &quot;&amp;ParentContext=CONTMGT&quot; +
                                //    (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) + (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
                                Mode = PageMode.View;
                            }
                            ViewState[viewStateFirstPE] = ds.Tables[0].Rows[0][&quot;FirstPE&quot;].ToString2() == &quot;Y&quot;;
                        }
                        catch
                        {
                            Response.Redirect(
                                &quot;~/Common/BrixListPage.aspx?context=PAYESTM&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] +
                                &quot;&amp;ContractID=&quot; + contractID.ToString2() + &quot;&amp;ParentID=&quot; + contractID.ToString2() +
                                (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                                (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]),
                                true);
                        }
                    }
                    else
                        Response.Redirect(
                            &quot;~/Common/BrixListPage.aspx?context=PAYESTM&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] +
                            &quot;&amp;ContractID=&quot; + contractID.ToString2() + &quot;&amp;ParentID=&quot; + contractID.ToString2() +
                            (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                            (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]),
                            true);

                    #endregion

                    DataRow dr = ds.Tables[0].Rows[0];

                    #region Setting the values of Page controls based on PE Data

                    if (MainToolBar.GetMenuReference(&quot;lnkEdit&quot;) != null)
                        MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Visible =
                            !(dr[&quot;PEApproved&quot;].ToString2() == &quot;Y&quot; || dr[&quot;IsChange&quot;].ToString2() == &quot;N&quot;);
                    RABillNo.Text = dr[&quot;Pay Item No.&quot;].ToString();
                    dtFromDt.Value = dr[&quot;FromDt&quot;];
                    wdcCreatedOn.Value = Convert.ToDateTime(dr[&quot;CreatedOn&quot;]);
                    lblFromDt.Text = dtFromDt.Value.ToString2();

                    //Restricting construction through date to current date.
                    if (Convert.ToDateTime(dr[&quot;ToDt&quot;]).Date &gt; MWDateTimeHelper.MWToday.ToUtc().Date)
                        dtToDt.Value = MWDateTimeHelper.MWToday;
                    else
                        dtToDt.Value = dr[&quot;ToDt&quot;].ToMWDateTime();

                    lblToDt.Text = dtToDt.Text.Split(&#39; &#39;)[0];

                    //wceRetainage.Value = dr[&quot;RetP&quot;];
                    //lblRetainage.Text = wceRetainage.Text;
                    //wceRetainageRelease.Value = dr[&quot;RetRelP&quot;];
                    //lblRetRelease.Text = wceRetainageRelease.Text;
                    //lblTotalDeductions.Text = BrixDatatypeHelper.ToDouble2(dr[&quot;DeductionsTotal&quot;]).ToString(Constants.FORMAT_AMOUNT);
                    //lblTotalAdditions.Text = BrixDatatypeHelper.ToDouble2(dr[&quot;AdditionsTotal&quot;]).ToString(Constants.FORMAT_AMOUNT);
                    //dvComments.InnerText = txtComments.Text = dr[&quot;Comments&quot;].ToString2();

                    lblPayFromDt.Text = dtFromDt.Value.ToMWDateTimeString_FormatDate();
                    // cbIncMohRet.Checked = dr[&quot;RetMOHInc&quot;].ToString2() == &quot;Y&quot;;
                    lblContractor.Text = dr[&quot;Contractor&quot;].Equals(DBNull.Value) ? &quot;&quot; : dr[&quot;Contractor&quot;].ToString2();

                    #endregion

                    #region Selecting the PE&#39;s Contractor

                    string ContractorType = &quot;P&quot;;
                    if (!DBNull.Value.Equals(dr[&quot;ContractorID&quot;]))
                    {
                        ContractorType = dr[&quot;ContractorType&quot;].ToString2();
                        if (
                            ddlContractor.Items.FindByValue(dr[&quot;ContractorID&quot;].ToString2() + &quot;,&quot; +
                                                            dr[&quot;ContractorType&quot;].ToString2()) != null)
                        {
                            ddlContractor.SelectedValue =
                                ddlContractor.Items.FindByValue(dr[&quot;ContractorID&quot;].ToString2() + &quot;,&quot; +
                                                                dr[&quot;ContractorType&quot;].ToString2()).Value;
                        }
                    }
                    else if (ddlContractor.Items.FindByText(&quot;--Select One--&quot;) != null)
                    {
                        ddlContractor.SelectedValue = ddlContractor.Items.FindByText(&quot;--Select One--&quot;).Value;
                    }
                    Contractor.Text = ddlContractor.SelectedItem.Text;

                    #endregion

                    #region Selecting the Active Work Order

                    PopulateWO(dr[&quot;WOID&quot;].Equals(DBNull.Value) ? string.Empty : dr[&quot;WOID&quot;].ToString2());

                    ViewState[viewStateWO] = GetWOIdx();

                    #endregion

                    #region Loading the Grid with the Postings

                    if (ds.Tables[1].Rows.Count &gt; 0)
                    {
                        decimal sumTotal = 0;
                        divItems.Style[&quot;display&quot;] = &quot;block&quot;;
                        totAmt.Visible = btnItemsDelete.Visible = !(lblNoRows.Visible = false);
                        txtItemTotal.Style.Value = lblNoRows.Visible ? &quot;display:none&quot; : &quot;display:block&quot;;
                        if (!WorkOrderType.Equals(&quot;E&quot;))
                        {
                            if (ContractorType.Equals(&quot;S&quot;) &amp;&amp; hdnItemPostings.Value.Equals(&quot;1&quot;))
                            {
                                BindAndFormatMBookDetails(ds.Tables[1]);
                                try
                                {
                                    sumTotal = ds.Tables[1].Compute(&quot;sum(Amount)&quot;, string.Empty).ToDecimal2();
                                }
                                catch (InvalidCastException)
                                {
                                    sumTotal = 0;
                                }
                            }
                            else
                            {
                                AddColumnsToGrid(itemsGrid, WorkOrderType, ContractorType,
                                                 (ContractorType.Equals(&quot;P&quot;) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;))
                                                     ? ItemSource.RFI
                                                     : ItemSource.ItemPostings);
                                string strTemp = String.Empty;
                                for (int i = 0; i &lt; ds.Tables[1].Rows.Count; i++)
                                {
                                    sumTotal += ds.Tables[1].Rows[i][&quot;Amt Placed&quot;].ToDecimal2();

                                    if (!ContractorType.Equals(&quot;S&quot;) &amp;&amp; !hdnItemPostings.Value.Equals(&quot;1&quot;))
                                    {
                                        itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                                                {
                                                                                    false,
                                                                                    ds.Tables[1].Rows[i][&quot;ItemID&quot;],
                                                                                    (String.IsNullOrEmpty(
                                                                                        strTemp =
                                                                                        ds.Tables[1].Rows[i][
                                                                                            &quot;Work Order No&quot;].ToString2()))
                                                                                        ? &quot;NA&quot;
                                                                                        : strTemp,
                                                                                    ds.Tables[1].Rows[i][&quot;StatusText&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;PDate&quot;].
                                                                                        ToMWDateTimeString_FormatDate(),
                                                                                    ds.Tables[1].Rows[i][&quot;PostingID&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;StdItemID&quot;],
                                                                                    ds.Tables[1].Rows[i][
                                                                                        &quot;SubItemDescription&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;Description&quot;],
                                                                                    ds.Tables[1].Rows[i][
                                                                                        ds.Tables[1].Columns.Contains(
                                                                                            &quot;Submitted Qty&quot;)
                                                                                            ? &quot;Submitted Qty&quot;
                                                                                            : &quot;Qty Placed&quot;].ToDecimal2()
                                                                                        .ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;Qty Placed&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;IsPartRate&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;Unit Price&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][
                                                                                        &quot;MaxAllowedPrice&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;BillingRate&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;Amt Placed&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;ParentId&quot;],
                                                                                    ds.Tables[1].Rows[i][
                                                                                        (ds.Tables[1].Columns.Contains(
                                                                                            &quot;RFIID&quot;))
                                                                                            ? &quot;RFIID&quot;
                                                                                            : &quot;PostingID&quot;].ToInt32_2(),
                                                                                    (ds.Tables[1].Columns.Contains(
                                                                                        &quot;RefNo&quot;))
                                                                                        ? ds.Tables[1].Rows[i][&quot;RefNo&quot;]
                                                                                        : null
                                                                                }));
                                    }
                                    else if (!WorkOrderType.Equals(&quot;A&quot;))
                                    {
                                        itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                                                {
                                                                                    false,
                                                                                    ds.Tables[1].Rows[i][&quot;ItemID&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;LineNo&quot;],
                                                                                    (String.IsNullOrEmpty(
                                                                                        strTemp =
                                                                                        ds.Tables[1].Rows[i][
                                                                                            &quot;Work Order No&quot;].ToString2()))
                                                                                        ? &quot;NA&quot;
                                                                                        : strTemp,
                                                                                    ds.Tables[1].Rows[i][&quot;StatusText&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;PDate&quot;].
                                                                                        ToMWDateTimeString_FormatDate(),
                                                                                    ds.Tables[1].Rows[i][&quot;PostingID&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;StdItemID&quot;],
                                                                                    ds.Tables[1].Rows[i][
                                                                                        &quot;SubItemDescription&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;Description&quot;],
                                                                                    ds.Tables[1].Rows[i][
                                                                                        ds.Tables[1].Columns.Contains(
                                                                                            &quot;Submitted Qty&quot;)
                                                                                            ? &quot;Submitted Qty&quot;
                                                                                            : &quot;Qty Placed&quot;].ToDecimal2()
                                                                                        .ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;Qty Placed&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;IsPartRate&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;Unit Price&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][
                                                                                        &quot;MaxAllowedPrice&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;BillingRate&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;Amt Placed&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;ParentId&quot;],
                                                                                    ds.Tables[1].Rows[i][
                                                                                        (ds.Tables[1].Columns.Contains(
                                                                                            &quot;RFIID&quot;))
                                                                                            ? &quot;RFIID&quot;
                                                                                            : &quot;PostingID&quot;].ToInt32_2()
                                                                                }));
                                    }
                                    else
                                    {
                                        itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                                                {
                                                                                    false,
                                                                                    0,
                                                                                    ds.Tables[1].Rows[i][&quot;LineNo&quot;],
                                                                                    (String.IsNullOrEmpty(
                                                                                        strTemp =
                                                                                        ds.Tables[1].Rows[i][
                                                                                            &quot;Work Order No&quot;].ToString2()))
                                                                                        ? &quot;NA&quot;
                                                                                        : strTemp,
                                                                                    ds.Tables[1].Rows[i][&quot;ActivityID&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;ActivityName&quot;]
                                                                                    ,
                                                                                    ds.Tables[1].Rows[i][&quot;StatusText&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;PDate&quot;].
                                                                                        ToMWDateTimeString_FormatDate(),
                                                                                    ds.Tables[1].Rows[i][&quot;PostingID&quot;],
                                                                                    &quot;&quot;,
                                                                                    ds.Tables[1].Rows[i][&quot;Description&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;StdItemID&quot;],
                                                                                    ds.Tables[1].Rows[i][&quot;Qty Placed&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;Qty Placed&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;IsPartRate&quot;].
                                                                                        ToBoolean2(),
                                                                                    ds.Tables[1].Rows[i][&quot;Unit Price&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][
                                                                                        &quot;MaxAllowedPrice&quot;].ToDecimal2().
                                                                                        ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;BillingRate&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;Amt Placed&quot;].
                                                                                        ToDecimal2().ToString(
                                                                                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                            CultureInfo.CurrentCulture),
                                                                                    ds.Tables[1].Rows[i][&quot;ParentID&quot;]
                                                                                }));
                                    }
                                }
                                //if (WorkOrderType.Equals(&quot;A&quot;))
                                //{
                                //    itemsGrid.Columns.FromKey(&quot;Description&quot;).Hidden =
                                //    itemsGrid.Columns.FromKey(&quot;UnitPrice&quot;).Hidden =
                                //    itemsGrid.Columns.FromKey(&quot;Pay Item No.&quot;).Hidden = true;
                                //}
                                if (!ContractorType.Equals(&quot;S&quot;) ||
                                    (ContractorType.Equals(&quot;S&quot;) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;)))
                                {
                                    ModifyRFIDetailsColumnProperties();
                                }
                            }
                        }
                        else
                        {
                            itemsGrid.DataSource = ds.Tables[1];
                            itemsGrid.DataBind();
                            sumTotal = ds.Tables[1].Compute(&quot;sum(Amount)&quot;, string.Empty).ToDecimal2();
                            ModifyEquipmentLogDetailsColumnProperties();
                        }
                        //if (itemsGrid.Rows.Count &gt; 0 &amp;&amp; itemsGrid.Columns.Exists(&quot;Work Order No&quot;))
                        //    itemsGrid.Columns.FromKey(&quot;Work Order No&quot;).Hidden = (itemsGrid.Rows[0].Cells.FromKey(&quot;Work Order No&quot;).Text.Equals(&quot;NA&quot;) || (!String.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp; hdnItemPostings.Value.Equals(&quot;1&quot;)));
                        //ViewState[viewStateTotal] = sumTotal;
                        totAmt.Text = &quot;Total : &quot; +
                                      sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                        txtItemTotal.Value = sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                        txtItemTotal.Style.Add(HtmlTextWriterStyle.TextAlign, &quot;right&quot;);
                    }
                    else
                    {
                        divItems.Style[&quot;display&quot;] = &quot;none&quot;;
                        totAmt.Visible = btnItemsDelete.Visible = !(lblNoRows.Visible = true);
                        txtItemTotal.Style.Value = lblNoRows.Visible ? &quot;display:none&quot; : &quot;display:block&quot;;
                        lblNoRows.Text = (!String.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp; hdnItemPostings.Value.Equals(&quot;1&quot;))
                                             ? &quot;No &quot; + LocalizationManager.GetString(&quot;LOC_MeasurementBook&quot;) + &quot;s Available.&quot;
                                             : ((String.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp;
                                                 !hdnItemPostings.Value.Equals(&quot;1&quot;))
                                                    ? &quot;No &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot;s Available&quot;
                                                    : &quot;No Postings Available&quot;);
                    }

                    #endregion

                    #region Storing the Selected From, To dates and Contractor in ViewState

                    ViewState[viewStateFromDt] = dtFromDt.Value;
                    ViewState[viewStateToDt] = dtToDt.Value;
                    ViewState[viewStateContractor] = (ddlContractor.SelectedIndex &gt; 0)
                                                         ? ddlContractor.SelectedValue
                                                         : null;

                    #endregion

                    SetPESettings();

                    #region Loading Prepayment Details

                    LoadPrepaymentDetails(Convert.ToDateTime(dtToDt.Value),
                                          DBNull.Value.Equals(dr[&quot;ContractorID&quot;])
                                              ? (int?)null
                                              : int.Parse(dr[&quot;ContractorID&quot;].ToString()),
                                          Convert.ToString(dr[&quot;ContractorType&quot;]), &quot;N&quot;, &quot;N&quot;);

                    #endregion

                    #region Loading Material Deduction Details

                    if (enableMaterialDeductions)
                    {
                        LoadMaterialDeductionDetailsGrid(true, null,
                                                         DBNull.Value.Equals(dr[&quot;ContractorID&quot;])
                                                             ? (int?)null
                                                             : int.Parse(dr[&quot;ContractorID&quot;].ToString()),
                                                         Convert.ToString(dr[&quot;ContractorType&quot;]), &quot;N&quot;);
                    }

                    #endregion

                    #region Loading the Adjustment Details

                    LoadAdjustmentsGrid(
                        String.IsNullOrEmpty(Request[&quot;PEID&quot;]) ? (int?)null : Request[&quot;PEID&quot;].ToInt32_2(), true, false);

                    #endregion

                    //if (ContractorType.Equals(&quot;S&quot;) &amp;&amp; hdnItemPostings.Value.Equals(&quot;1&quot;))
                    //    FillMBooksTable();

                    MakeControlsReadOnlyExceptComments(dr[&quot;IsSubmit&quot;].ToInt32_2().Equals(1));//After submit then read only
                    if (IsFinal)
                    {
                        trFinalRAB.Style.Value = trRetRelDate.Style.Value = &quot;display:block&quot;;
                        chkIsFinalRAB.Checked = true;
                        if (Mode == PageMode.View)
                            dtRetRel.Enabled = chkIsFinalRAB.Enabled = false;
                        dtRetRel.Value = dr[&quot;RetReleaseDate&quot;] != null
                                             ? dr[&quot;RetReleaseDate&quot;].ToMWDateTime()
                                             : dr[&quot;ToDt&quot;].ToMWDateTime();
                    }

                    if (Mode == PageMode.View)
                    {
                        if (txtItemTotal.Visible &amp;&amp; totAmt.Visible &amp;&amp; itemsGrid.Rows.Count &gt; 0)
                            itemsGrid.Columns.FromKey(&quot;To&quot;).Hidden = true;
                        lblWorkOrder.Text = ddlWorkOrder.SelectedItem.Text;

                        //Contract Advance related fields
                        if (ds.Tables[0].Rows[0][&quot;ContractorType&quot;].ToString2().Equals(&quot;P&quot;))
                            lblContAdvHead.Text = &quot;Total &quot; + LocalizedContractName + &quot; Advance Paid:&quot;;
                        else
                            lblContAdvHead.Text = &quot;Total &quot; + LocalizedContractName + &quot; Advance Received:&quot;;
                        lblContAdv.Text =
                            (ds.Tables[0].Rows[0][&quot;CurrMOHAmt&quot;].ToDecimal2()).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                       CultureInfo.CurrentCulture);
                        lblContAdvRec.Text =
                            (ds.Tables[0].Rows[0][&quot;CurrMOHRecAmt&quot;].ToDecimal2()).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                          CultureInfo.CurrentCulture);

                        if (uwgPrePayment.Columns.Exists(&quot;CurrentRecovery&quot;))
                        {
                            uwgPrePayment.Columns.FromKey(&quot;CurrentRecovery&quot;).CellStyle.BackColor = Color.White;
                            uwgPrePayment.Columns.FromKey(&quot;CurrentRecovery&quot;).AllowUpdate = AllowUpdate.No;
                        }

                        trAddDeletePrepayments.Style.Value = &quot;display:none;&quot;;
                        btnMBPicker.Visible = btnPRMBPickerAdd.Visible = btnMBDeleteItem.Visible = false;
                    }
                }

                #region Set the From Date to 1/1/1900 and setting the Pay From Date Label based on whether its the first PE or not

                ViewState[viewStateFromDt] = dtFromDt.Value = new DateTime(1900, 1, 1);
                if ((Mode == PageMode.New &amp;&amp; settings.NextFromDt.HasValue)
                    || (Mode == PageMode.Edit) &amp;&amp; !ViewState[viewStateFirstPE].ToBoolean2())
                {
                    ViewState[viewStateFromDt] = dtFromDt.Value = new DateTime(1900, 1, 1);
                    trPayFromChoose.Style.Value = &quot;display: none&quot;;
                    trSpacerFromChooser.Style.Value = &quot;display: none&quot;;
                }
                else
                {
                    if (settings.ContractStartDt.HasValue)
                    {
                        if (Mode != PageMode.View &amp;&amp; Mode != PageMode.Edit)
                            lblPayFromDt.Text = settings.ContractStartDt.ToMWDateTimeString_FormatDate();
                        trPayFromChoose.Style.Value = &quot;display: none&quot;;
                        trSpacerFromChooser.Style.Value = &quot;display: none&quot;;
                    }
                }

                #endregion

                SetLocalizedStrings();

                dsRet = BL.Instance.GetPE(contractID, Request[&quot;PEID&quot;].ToInt32_2(),
                                          (String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                               ? (int?)null
                                               : int.Parse(Request[&quot;WOID&quot;])));

                if (dsRet.Tables[2].Rows.Count &gt; 0)
                {
                    HasRetentionRule = true;
                    var ceilingMode = (RetentionCeilingMode)dsRet.Tables[2].Rows[0][&quot;RetentionCeilingMode&quot;].ToInt32_2();
                    decimal retcp = dsRet.Tables[2].Rows[0][&quot;RetentionCeilingValue&quot;].ToString().ToDecimal2();

                    decimal ret = dsRet.Tables[2].Rows[0][&quot;Retention&quot;].ToString().ToDecimal2();
                    txtRetention.Text = ret.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                    decimal retcv = dsRet.Tables[3].Rows[0][&quot;TotalAmount&quot;].ToString().ToDecimal2();
                    txtRetentionCP.Text =
                        (ceilingMode.Equals(RetentionCeilingMode.Percentage) ? retcp : (retcp * 100 / retcv)).ToString(
                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                    decimal retcvval = ceilingMode.Equals(RetentionCeilingMode.Percentage) ? (retcv * retcp / 100) : retcp;

                    txtRetentionCV.Text = retcvval.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                    decimal totretamount = dsRet.Tables[4].Rows[0][&quot;RetentionAmount&quot;].ToString().ToDecimal2();

                    if (totretamount &gt; retcvval)
                    {
                        txtTotalretAmt.Text = retcvval.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                    }
                    else
                    {
                        txtTotalretAmt.Text = totretamount.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                    }
                    DTTotalAmt = dsRet.Tables[3];

                    DTRetAmtFromRule = dsRet.Tables[4];
                }
                else
                {
                    HasRetentionRule = false;
                    txtRetention.Enabled = txtRetentionINR.Enabled = txtRetentionPrevTotal.Enabled = txtRetRelease.Enabled = txtRetReleaseAmt.Enabled = false;
                    txtRetentionValue.Enabled = rblRetChoice.Enabled = false;
                }

                //Setting the nett value of retention done till this bill. This is used for calculating the retention release
                if (dsRet.Tables[4].Rows.Count &gt; 0)
                {
                    decimal prevRetTotal = DBNull.Value != dsRet.Tables[4].Rows[0][&quot;RetentionPrevTotal&quot;] ? dsRet.Tables[4].Rows[0][&quot;RetentionPrevTotal&quot;].ToString().ToDecimal2() : 0;
                    txtRetentionPrevTotal.Text = prevRetTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                }
                else
                    txtRetentionPrevTotal.Text = 0.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                if (dsRet.Tables[5].Rows.Count &gt; 0)
                {
                    decimal holdAmt = DBNull.Value != dsRet.Tables[5].Rows[0][&quot;TotalHeld&quot;] ? dsRet.Tables[5].Rows[0][&quot;TotalHeld&quot;].ToString().ToDecimal2() : 0;
                    decimal holdRelAmt = DBNull.Value != dsRet.Tables[5].Rows[0][&quot;HoldRel&quot;] ? dsRet.Tables[5].Rows[0][&quot;HoldRel&quot;].ToString().ToDecimal2() : 0;

                    HoldAmountFromds = holdAmt;

                    txtHoldAmount.Text = holdAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                }

                if (Mode == PageMode.Edit || Mode == PageMode.View)
                {
                    GetRetentionDetails();
                    if (DTTotalAmt != null &amp;&amp; DTTotalAmt.Rows.Count &gt; 0)
                    {
                        hdnWOAmount.Value = DTTotalAmt.Rows[0][&quot;TotalAmount&quot;].ToString2();
                        hdnBilledAmount.Value = DTTotalAmt.Rows[0][&quot;PreviousCostAmt&quot;].ToString2();
                    }
                }

                tblRetentionBlock.Visible = true;
                tdRetention.InnerText = LocalizationManager.GetString(KeyConstants.LOC_RETAINAGE);
                int retentionMode = 0;
                if (ds != null &amp;&amp; ds.Tables.Count &gt; 0 &amp;&amp; ds.Tables[0].Rows.Count &gt; 0 &amp;&amp; ds.Tables[0].Columns.Contains(&quot;RetentionMode&quot;))
                    int.TryParse(ds.Tables[0].Rows[0][&quot;RetentionMode&quot;].ToString2(), out retentionMode);
                rblRetChoice.SelectedValue = retentionMode.ToString2();
                tabHoldRel.GroupingText = LocalizationManager.GetString(KeyConstants.LOC_RETAINAGE) + &quot; &amp; Hold&quot;;
                if (Request[&quot;WOID&quot;] != null)
                    hdnWOID.Value = Request[&quot;WOID&quot;];
                hdnRetention.Value = LocalizationManager.GetString(KeyConstants.LOC_RETAINAGE) + &quot; &amp; Hold&quot;;

                hdnVisibleTab.Value = &quot;tab1&quot;;
                if (Mode == PageMode.New)
                {
                    divItems.Style[&quot;display&quot;] = &quot;block&quot;;
                    if (!WorkOrderType.Equals(&quot;E&quot;) &amp;&amp; !String.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp;
                        hdnItemPostings.Value.Equals(&quot;1&quot;)) //Subcontractor with MBooks
                        BindAndFormatMBookDetails(new DataTable());
                    else if (!WorkOrderType.Equals(&quot;E&quot;))
                        ShowEmptyGrid();
                    else
                        ShowEquipmentHireOrderGrid();
                }
                if (CacheManager.Instance.IsIntegrated(PID))
                {
                    lblAXOpeningBalances.Visible = false;
                    tdCaption.Visible = false;
                }
                else
                {
                    lblAXOpeningBalances.Visible = true;
                    tdCaption.Visible = true;

                    string Contractor = (ddlContractor.SelectedItem.Text != &quot;--Select One--&quot;)
                                            ? ddlContractor.SelectedValue
                                            : null;
                    int? ContractorID = null;
                    string ContractorType = null;
                    if (!String.IsNullOrEmpty(Contractor))
                    {
                        string[] strContr = Contractor.Split(&#39;,&#39;);

                        ContractorID = strContr[0].ToInt32_2();
                        ContractorType = strContr[1];
                    }
                    FetchAXOpeningBalancesForPrePayment(Session[&quot;AXCompany&quot;].ToString(), ContractorID.ToString(),
                                                        ContractorType, Request[&quot;ContractID&quot;]);
                }

                #region Check for Mode should be disable for ONG

                if (DisableModeForPrePayment)
                    if (uwgPrePayment.Columns.Exists(&quot;Mode&quot;))
                        uwgPrePayment.Columns.FromKey(&quot;Mode&quot;).Hidden = true;

                if (uwgPrePayment.Columns.Exists(&quot;Amount&quot;))
                    uwgPrePayment.Columns.FromKey(&quot;Amount&quot;).Header.Caption = LocalizationManager.GetString(&quot;Contract&quot;) + &quot; Amount Received&quot;;

                #endregion

                chkRecFullContractAdvance.Text = &quot;Recover Full Remaining &quot; + LocalizedContractName + &quot; Advance&quot;;
                tdtcar.InnerText = &quot;Total &quot; + LocalizedContractName + &quot; Advance Recovered:&quot;;
                tdtcarem.InnerText = &quot;Total &quot; + LocalizedContractName + &quot; Advance Remaining:&quot;;
                btnMBPicker.Text = &quot;Add Submitted Bills&quot;;
            }
            else
            {
                SetLocalizedStrings();
                settings = (PESettings)ViewState[viewStateSettings];
            }
            if (!IsERPConnected)
                trOpeningBalance.Style.Add(&quot;display&quot;, &quot;none&quot;);
            hdnAmountDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT).ToString2();
            hdnPriceDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE).ToString2();
        }

        private void GetRetentionDetails()
        {
            string[] strtotAmt = totAmt.Text.Split(&#39;:&#39;);
            decimal totamt, retpercent, retentionINR, totretamount;

            decimal.TryParse(txtItemTotal.Value, out totamt);
            decimal.TryParse(txtRetention.Text, out retpercent);
            decimal.TryParse(dsRet.Tables[4].Rows[0][&quot;RetentionAmount&quot;].ToString(), out totretamount);

            //decimal totamt = strtotAmt[1].ToString().ToDecimal2();
            retentionINR = (totamt * retpercent) / 100;
            txtTotalretAmt.Text = totretamount.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
            txtNotes.Text = dsRet.Tables[0].Rows[0][&quot;Comments&quot;].ToString2();
            txtRetentionINR.Text = (retentionINR &gt; txtTotalretAmt.Text.ToDecimal2())
                                       ? dsRet.Tables[4].Rows[0][&quot;RetentionAmount&quot;].ToString()
                                       : retentionINR.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

            string tableName = &quot;Table5&quot;;

            if (dsRet.Tables[tableName].Rows.Count &gt; 0)
            {
                DataRow drDetails = dsRet.Tables[tableName].Rows[0];
                decimal holdAmt, holdCurAmt, holdRelAmt, holdRelPercent, total, holdpercent, totalHoldAmount;
                decimal.TryParse(drDetails[&quot;TotalHeld&quot;].ToString2(), out holdAmt);

                decimal.TryParse(drDetails[&quot;HoldAmount&quot;].ToString2(), out holdCurAmt);
                txtCurrentHoldAmount.Text = holdCurAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                decimal.TryParse(drDetails[&quot;HoldRel&quot;].ToString2(), out holdRelAmt);
                txtHoldReleaseAmt.Text = holdRelAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                holdRelPercent = (holdAmt != 0) ? ((holdRelAmt * 100) / (holdAmt)) : 0;
                txtHoldRelease.Text = holdRelPercent.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                decimal.TryParse(txtItemTotal.Value, out total);
                holdpercent = (total != 0) ? ((holdCurAmt * 100) / (total)) : 0;
                txtHoldPercent.Text = holdpercent.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                totalHoldAmount = holdAmt;
                txtHoldAmount.Text = totalHoldAmount.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                //the nett held value till this bill (excluding this bill)
                HoldAmountFromds = holdAmt;
            }

            if (Mode == PageMode.Edit || Mode == PageMode.View)
            {
                if (dsRet.Tables[0].Rows[0][&quot;RetAmtFromRule&quot;] != null)
                {
                    decimal rabAmtWORetention = 0;
                    decimal.TryParse(dsRet.Tables[0].Rows[0][&quot;RABAmountWORetention&quot;].ToString2(), out rabAmtWORetention);
                    if (rabAmtWORetention != 0)
                        txtRetention.Value = dsRet.Tables[0].Rows[0][&quot;RetAmtFromRule&quot;].ToDecimal2() * 100 / rabAmtWORetention;

                    txtRetentionValue.Value = dsRet.Tables[0].Rows[0][&quot;RetAmtFromRule&quot;].ToDecimal2();
                    txtRetReleaseAmt.Value = dsRet.Tables[0].Rows[0][&quot;RetReleaseAmt&quot;].ToDecimal2();
                    txtRetRelease.Value = txtRetentionPrevTotal.ValueDecimal != 0 ? txtRetReleaseAmt.ValueDecimal * 100 / txtRetentionPrevTotal.ValueDecimal : 0;
                }
                if (Mode == PageMode.View)
                {
                    txtRetention.ReadOnly = txtRetentionValue.ReadOnly =
                        txtRetReleaseAmt.ReadOnly = txtRetRelease.ReadOnly = true;
                    rblRetChoice.Enabled = false;
                }
            }
        }

        private void HideContractorSelection()
        {
            //Hides the prime contractor/sub contractor and work order selection.
            trPCSCSelection.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            trSC.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            trWONos.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
        }

        protected override void CreateChildControls()
        {
            EnsureChildControls();
            CreateControlCollection();
            var featurelist = (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS];

            var menus = new MenuArray();
            if (Mode != PageMode.View)
                AddSaveButton(menus);
            //if workflow is uploaded, going to edit from view mode is disabled
            //TODO: check for the status of the workflow and go to the edit mode.
            //else if (Request[&quot;Mode&quot;].ToString().Equals(&quot;View&quot;) &amp;&amp; featurelist.Contains(CMConstans.MODFEAT_EDIT))
            //    menus.Add(new BrixMenu(&quot;lnkEdit&quot;, &quot;Edit&quot;, &quot;IcnEdit.png&quot;, 55));
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
            SetPopUpDetails();
        }

        protected void SetPopUpDetails()
        {
            //PopupExtender = (ModalPopupExtender)this.Master.FindControl(&quot;filterExtender&quot;);
            PopupExtender.AddNewPopup(aspPnl.ClientID, btnHelper.ClientID, btnMBCancel.ClientID, 300, 550);

            //popUpInvalidMBooks = (ModalPopupExtender)this.Master.FindControl(&quot;subFilterExtender&quot;);
            popUpInvalidMBooks.AddNewPopup(pnlInvalidMBooks.ClientID, btnMBWarningOk.ClientID,
                                           btnMBWarningClose.ClientID, 300, 400, Header: &quot;Message&quot;);
        }

        protected override void CustomizeToolBar()
        {
            if (Mode != PageMode.View)
            {
                if (HasSaveButton)
                {
                    Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        lnkSave.Click += btnSubmitMaster_Click;
                        if (IsFinal)
                            lnkSave.OnClientClick = &quot;return ConfirmFinalSave();&quot;;
                    }
                }
            }
            else if (Mode == PageMode.View)
            {
                if (MainToolBar.GetMenuReference(&quot;lnkEdit&quot;) != null)
                    MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Click += btnEditContract_Click;
            }
            if (MainToolBar.GetMenuReference(&quot;lnkCancel&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += btnBack_Click;
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;
            }

            if (ViewState[&quot;canBeSaved&quot;].ToBoolean2() == false)
            {
                if (HasSaveButton)
                {
                    Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        MainToolBar.HideMenu(&quot;lnkSave&quot;);
                    }
                }
            }
        }

        private void SetPESettings()
        {
            #region Getting PE Settings from the DataBase and storing to ViewState

            int? ContractorID = null;
            int CID = 0;
            if (!int.TryParse(ddlContractor.SelectedValue.Split(&#39;,&#39;)[0], out CID))
                ContractorID = null;
            else
                ContractorID = CID;
            string ContractorType = null;
            if (ddlContractor.SelectedValue.Split(&#39;,&#39;).Length &gt; 1)
                ContractorType = ddlContractor.SelectedValue.Split(&#39;,&#39;)[1];
            else
                ContractorType = null;
            DataSet dsPESettings = BL.Instance.GetAllPESettings(contractID, ContractorID, ContractorType,
                                                                ddlWorkOrder.SelectedValue.ToInt32_2());
            DataRow dr = dsPESettings.Tables[0].Rows[0];

            hdnContractAdvanceRecPercent.Value = dr[&quot;RecoveryPercentage&quot;].ToString2();

            //Redirect user if Contract is deleted
            if (dr[&quot;ContractDeleted&quot;].ToString2() == &quot;Y&quot;)
                Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID],
                                  true);

            //Setting the values of the PESettings object
            settings.Tiered = dr[&quot;Tier&quot;].ToString2();

            if (dr[&quot;NextDt&quot;].Equals(DBNull.Value))
                settings.NextFromDt = null;
            else
                settings.NextFromDt =
                    ((dr[&quot;NextDt&quot;].ToString2().ToDateTime_MWCulture()).ToString(&quot;MM/dd/yyyy&quot;, CultureInfo.CurrentCulture) +
                     &quot; 12:00:00 AM&quot;).ToDateTime_MWCulture();

            if (dr[&quot;ContractStartDt&quot;].Equals(DBNull.Value))
                settings.ContractStartDt = null;
            else
                settings.ContractStartDt = dr[&quot;ContractStartDt&quot;].ToMWDateTime();

            ViewState[viewStateSettings] = settings;

            //Setting the Cutoff date label here!
            if (settings.NextFromDt.HasValue &amp;&amp; Mode == PageMode.New)
            {
                lblPayFromDt.Text = settings.NextFromDt.Value.ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture);
            }

            #endregion
        }

        private void SetLocalizedStrings()
        {
            string PayEstimate = LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE);
            ;
            if (Mode == PageMode.New)
            {
                PageTitle = &quot;New &quot; + PayEstimate;
            }
            else if (Mode == PageMode.Edit)
            {
                PageTitle = &quot;Edit &quot; + PayEstimate;
            }
            else if (Mode == PageMode.View)
            {
                PageTitle = &quot;View &quot; + PayEstimate;
            }
        }

        protected void btnClear_Click(object sender, EventArgs e)
        {
            itemsGrid.Clear();
            lblNoRows.Text = &quot;No Postings Available&quot;;

            dtFromDt.Value = dtToDt.Value = null;
            divItems.Style[&quot;display&quot;] = &quot;none&quot;;
            totAmt.Visible = btnItemsDelete.Visible = !(lblNoRows.Visible = true);
            txtItemTotal.Style.Value = lblNoRows.Visible ? &quot;display:none&quot; : &quot;display:block&quot;;
        }

        protected void btnGen_Click(object sender, EventArgs e)
        {
            try
            {
                #region Checking for mandatory fields and preliminary checks

                if (dtFromDt.Value == null)
                    throw new Exception(&quot;From Date is mandatory.&quot;);

                if (dtToDt.Value == null)
                    throw new Exception(&quot;Construction Through Date is mandatory.&quot;);

                if (ddlContractor.SelectedIndex &lt; 1)
                    throw new Exception(&quot;Contractor is mandatory.&quot;);

                if (rblContractorType.SelectedValue.Equals(&quot;S&quot;) &amp;&amp; ddlWorkOrder.SelectedIndex &lt; 1)
                    throw new Exception(&quot;Work Order is mandatory.&quot;);

                if (
                    Convert.ToDateTime(lblPayFromDt.Text, DateFormatCulture.GetDateFormatCulture()).CompareTo(
                        dtToDt.Value.ToDateTime_MWCulture()) &gt; 0)
                {
                    throw new Exception(@&quot;Construction Through Date cannot be earlier than Cutoff Date.&quot;);
                }

                if ((Mode != PageMode.Edit &amp;&amp; ((PESettings)ViewState[viewStateSettings]).NextFromDt.HasValue &amp;&amp;
                     ((PESettings)ViewState[viewStateSettings]).NextFromDt.Value.CompareTo(dtToDt.Value.ToDateTime_MWCulture()) &gt;
                     0)
                    ||
                    (Mode == PageMode.Edit &amp;&amp;
                     Convert.ToDateTime(lblPayFromDt.Text, DateFormatCulture.GetDateFormatCulture()).CompareTo(
                         dtToDt.Value.ToDateTime_MWCulture()) &gt; 0))
                {
                    throw new Exception(@&quot;Construction Through Date cannot be earlier than Cutoff Date.&quot;);
                }

                #endregion

                #region Storing current Values of From and ToDates, Contractor and Work Order Selection to ViewState

                ViewState[viewStateFromDt] = dtFromDt.Value;
                ViewState[viewStateToDt] = dtToDt.Value;
                ViewState[viewStateContractor] = (ddlContractor.SelectedIndex &gt; 0) ? ddlContractor.SelectedValue : null;
                ViewState[viewStateWO] = GetWOIdx();

                #endregion

                hdnGenClicked.Value = &quot;1&quot;;

                #region Getting Contractor and Contractor Type strings

                string Contractor = (ddlContractor.SelectedItem.Text != &quot;--Select One--&quot;)
                                        ? ddlContractor.SelectedValue
                                        : null;
                int? ContractorID = null;
                string ContractorType = null;

                if (!String.IsNullOrEmpty(Contractor))
                {
                    string[] strContr = Contractor.Split(&#39;,&#39;);

                    ContractorID = strContr[0].ToInt32_2();
                    ContractorType = strContr[1];
                }

                #endregion

                #region Populating Billing Item Details

                FetchBillingItemsDetails(ContractorID, ContractorType, dtFromDt.Value.ToDateTime_MWCulture(),
                                         dtToDt.Value.ToDateTime_MWCulture());

                #endregion

                #region Populating Prepayment Details

                LoadPrepaymentDetails(Convert.ToDateTime(dtToDt.Value), ContractorID, ContractorType, &quot;Y&quot;, &quot;N&quot;);

                #endregion

                #region Adding the Applicable (Deductable) Material Issues

                if (enableMaterialDeductions)
                {
                    LoadMaterialDeductionDetailsGrid(false, Convert.ToDateTime(dtToDt.Value).ToUtc(), ContractorID,
                                                     ContractorType, &quot;N&quot;);
                }

                #endregion
            }
            catch (Exception ex)
            {
                base.ShowError(ex.Message);
            }
        }

        private void FetchBillingItemsDetails(int? ContractorID, string ContractorType, DateTime fromDate,
                                              DateTime toDate)
        {
            //BrixDatatypeHelper.ToDateTime2(dtToDt.Value)
            DataTable dt = null;

            #region Fetching the Postings / RFIs / Equipments Logs based on Contractor Type / Work Order Type

            bool subContractor = !ContractorType.Equals(&quot;P&quot;);
            bool itemPostings;
            itemPostings = (!subContractor)
                               ? !(BL.Instance.GetContrItemSource(Request[&quot;ContractID&quot;].ToInt32_2(), &quot;P&quot;).Equals(&quot;RFI&quot;))
                               : ((hdnItemPostings.Value.Equals(&quot;1&quot;)) ? false : true);
            if (WorkOrderType.Equals(&quot;A&quot;) &amp;&amp; itemPostings) //Subcontractor with itempostings
            {
                dt = BL.Instance.GetActivitiesPE(contractID,
                                                 String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                     ? (int?)null
                                                     : Request[&quot;PEID&quot;].ToInt32_2(),
                                                 &quot;&lt;XMLRoot&gt;&lt;PostedFromDt&gt;{0}&lt;/PostedFromDt&gt;&lt;PostedToDt&gt;{1}&lt;/PostedToDt&gt;&lt;IsApproved&gt;{2}&lt;/IsApproved&gt;&lt;ContractorID&gt;{3}&lt;/ContractorID&gt;&lt;ContractorType&gt;{4}&lt;/ContractorType&gt;&lt;WOIDs&gt;{5}&lt;/WOIDs&gt;&lt;/XMLRoot&gt;&quot;
                                                     .Format2(
                                                         (fromDate.ToDateOnlyString_ForDatabaseOpenXml() +
                                                          &quot; 12:00:00 AM&quot;).ToUtc(),
                                                         (toDate.ToDateOnlyString_ForDatabaseOpenXml() +
                                                         &quot; 23:59:59 PM&quot;).ToUtc(), &quot;A&quot;, ContractorID, ContractorType, GetWOIDs()));
            }
            else if (WorkOrderType.Equals(&quot;A&quot;)) //Subcontractor with Measurement books
            {
                //Binding MBook Picker with the new data
                FillMBooksTable();

                ScriptManager.RegisterStartupScript(this, GetType(), &quot;MBPicker&quot;, &quot;$(&#39;#&quot; + btnMBPicker.ClientID + &quot;&#39;).click();&quot;, true);

                //lblNoRows.Visible = false;
            }
            else if (WorkOrderType.Equals(&quot;E&quot;))
            {
                dt = BL.Instance.GetEquipmentLogsPE(contractID,
                                                    String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                        ? (int?)null
                                                        : Request[&quot;PEID&quot;].ToInt32_2(),
                                                    &quot;&lt;XMLRoot&gt;&lt;PostedFromDt&gt;{0}&lt;/PostedFromDt&gt;&lt;PostedToDt&gt;{1}&lt;/PostedToDt&gt;&lt;IsApproved&gt;{2}&lt;/IsApproved&gt;&lt;ContractorID&gt;{3}&lt;/ContractorID&gt;&lt;ContractorType&gt;{4}&lt;/ContractorType&gt;&lt;WOIDs&gt;{5}&lt;/WOIDs&gt;&lt;/XMLRoot&gt;&quot;
                                                        .Format2(
                                                            (fromDate.ToString(&quot;MM/dd/yyyy&quot;, CultureInfo.CurrentCulture) +
                                                             &quot; 12:00:00 AM&quot;),
                                                            toDate.ToString(&quot;MM/dd/yyyy&quot;, CultureInfo.CurrentCulture) +
                                                            &quot; 23:59:59 PM&quot;, &quot;A&quot;, ContractorID, ContractorType,
                                                            GetWOIDs()));
            }
            else
            {
                //bool itemPostingSettings = true;
                //For sub contractor with item postings or For Prime Contractor with Item postings
                if ((subContractor &amp;&amp; itemPostings) || (!subContractor &amp;&amp; itemPostings))
                {
                    DataSet ds = BL.Instance.GetItemsPE(contractID,
                                                        String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                            ? (int?)null
                                                            : Request[&quot;PEID&quot;].ToInt32_2(),
                                                        &quot;&lt;XMLRoot&gt;&lt;PostedFromDt&gt;{0}&lt;/PostedFromDt&gt;&lt;PostedToDt&gt;{1}&lt;/PostedToDt&gt;&lt;IsApproved&gt;{2}&lt;/IsApproved&gt;&lt;ContractorID&gt;{3}&lt;/ContractorID&gt;&lt;ContractorType&gt;{4}&lt;/ContractorType&gt;&lt;WOIDs&gt;{5}&lt;/WOIDs&gt;&lt;/XMLRoot&gt;&quot;
                                                            .Format2(
                                                                (fromDate.ToString(&quot;MM/dd/yyyy&quot;,
                                                                                   CultureInfo.CurrentCulture) +
                                                                 &quot; 12:00:00 AM&quot;),
                                                                toDate.ToString(&quot;MM/dd/yyyy&quot;, CultureInfo.CurrentCulture) +
                                                                &quot; 23:59:59 PM&quot;, &quot;A&quot;, ContractorID, ContractorType,
                                                                GetWOIDs()));

                    DataRow[] rows = ds.Tables[0].Select(&quot;[Qty Placed] &lt;&gt; 0&quot;);
                    if (rows.Length &gt; 0)
                        dt = rows.CopyToDataTable();
                    else
                    {
                        ds.Tables[0].Rows.Clear();
                        dt = ds.Tables[0];
                    }
                }
                else if (!subContractor) //For Prime contractor with RFIs
                {
                    //TODO: Implement RFI mode
                    dt = BL.Instance.GetSubmittedRFIList(contractID, (Request[&quot;PEID&quot;] ?? &quot;0&quot;).ToInt32_2(), toDate.ToUtc());
                    FillPRRFITable();
                }
                else
                {
                    //Binding MBook Picker with the new data
                    FillMBooksTable();
                    //btnMBPickerAdd_Click(new object(), new EventArgs());
                    ScriptManager.RegisterStartupScript(this, GetType(), &quot;MBPicker&quot;, &quot;$(&#39;#&quot; + btnMBPicker.ClientID + &quot;&#39;).click();&quot;, true);
                    //lblNoRows.Visible = false;
                }
            }

            #endregion

            #region Adding Postings to the Grid

            if (dt != null &amp;&amp; dt.Rows.Count &gt; 0)
            {
                itemsGrid.Clear();
                decimal sumTotal = 0;
                decimal sumTotalForRetCalc = 0;
                divItems.Style[&quot;display&quot;] = &quot;block&quot;;
                totAmt.Visible = btnItemsDelete.Visible = !(lblNoRows.Visible = false);
                txtItemTotal.Style.Value = lblNoRows.Visible ? &quot;display:none&quot; : &quot;display:block&quot;;
                if (!WorkOrderType.Equals(&quot;E&quot;))
                {
                    AddColumnsToGrid(itemsGrid, WorkOrderType, ContractorType,
                                     (ContractorType.Equals(&quot;P&quot;) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;))
                                         ? ItemSource.RFI
                                         : ItemSource.ItemPostings);

                    string strTemp = string.Empty;
                    for (int i = 0; i &lt; dt.Rows.Count; i++)
                    {
                        sumTotal += dt.Rows[i][&quot;Amt Placed&quot;].ToDecimal2();

                        if (!subContractor &amp;&amp; !itemPostings)
                        {
                            itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                                    {
                                                                        false, dt.Rows[i][&quot;ItemID&quot;],
                                                                        dt.Rows[i][&quot;RFI No&quot;],
                                                                        dt.Rows[i][&quot;Status&quot;],
                                                                        dt.Rows[i][&quot;PDate&quot;].ToDateTime_MWCulture().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_DATE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;PostingID&quot;],
                                                                        dt.Rows[i][&quot;StdItemID&quot;],
                                                                        dt.Rows[i][&quot;SubItemDescription&quot;],
                                                                        dt.Rows[i][&quot;Description&quot;],
                                                                        dt.Rows[i][&quot;Submitted Qty&quot;].ToDecimal2().
                                                                            ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                     CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;Billed Qty&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;IsPartRate&quot;].ToBoolean2(),
                                                                        dt.Rows[i][&quot;Unit Price&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;MaxAllowedPrice&quot;].ToDecimal2().
                                                                            ToString(AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                                     CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;BillingRate&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;Amt Placed&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;ParentID&quot;],
                                                                        dt.Rows[i][
                                                                            dt.Columns.Contains(&quot;RFIID&quot;)
                                                                                ? &quot;RFIID&quot;
                                                                                : &quot;PostingID&quot;].ToInt32_2(),
                                                                        dt.Rows[i][&quot;RefNo&quot;]
                                                                    }));
                        }
                        else if (!WorkOrderType.Equals(&quot;A&quot;))
                        {
                            itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                                    {
                                                                        false, dt.Rows[i][&quot;ItemID&quot;],
                                                                        dt.Rows[i][&quot;LineNo&quot;],
                                                                        (String.IsNullOrEmpty(
                                                                            strTemp =
                                                                            dt.Rows[i][&quot;Work Order No&quot;].ToString2()))
                                                                            ? &quot;NA&quot;
                                                                            : strTemp,
                                                                        dt.Rows[i][&quot;StatusText&quot;],
                                                                        dt.Rows[i][&quot;PDate&quot;].ToDateTime_MWCulture().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_DATE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;PostingID&quot;],
                                                                        dt.Rows[i][&quot;StdItemID&quot;],
                                                                        dt.Rows[i][&quot;SubItemDescription&quot;],
                                                                        dt.Rows[i][&quot;Description&quot;],
                                                                        dt.Rows[i][&quot;Qty Placed&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;Qty Placed&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;IsPartRate&quot;].ToBoolean2(),
                                                                        dt.Rows[i][&quot;Unit Price&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;MaxAllowedPrice&quot;].ToDecimal2().
                                                                            ToString(AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                                     CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;BillingRate&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;Amt Placed&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;ParentID&quot;]
                                                                    }));
                        }
                        else
                        {
                            itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                                    {
                                                                        false,
                                                                        0,
                                                                        dt.Rows[i][&quot;LineNo&quot;],
                                                                        (String.IsNullOrEmpty(
                                                                            strTemp =
                                                                            dt.Rows[i][&quot;Work Order No&quot;].ToString2()))
                                                                            ? &quot;NA&quot;
                                                                            : strTemp,
                                                                        dt.Rows[i][&quot;ActivityID&quot;],
                                                                        dt.Rows[i][&quot;ActivityName&quot;],
                                                                        dt.Rows[i][&quot;StatusText&quot;],
                                                                        dt.Rows[i][&quot;PDate&quot;].ToDateTime_MWCulture().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_DATE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;PostingID&quot;],
                                                                        &quot;&quot;,
                                                                        dt.Rows[i][&quot;Description&quot;],
                                                                        dt.Rows[i][&quot;StdItemID&quot;],
                                                                        dt.Rows[i][&quot;Qty Placed&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;Qty Placed&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;IsPartRate&quot;].ToBoolean2(),
                                                                        dt.Rows[i][&quot;Unit Price&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;MaxAllowedPrice&quot;].ToDecimal2().
                                                                            ToString(AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                                     CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;BillingRate&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;Amt Placed&quot;].ToDecimal2().ToString(
                                                                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                            CultureInfo.CurrentCulture),
                                                                        dt.Rows[i][&quot;ParentID&quot;]
                                                                    }));
                        }
                    }
                    if (!subContractor || itemPostings)
                    {
                        ModifyRFIDetailsColumnProperties();
                    }
                }
                else
                {
                    itemsGrid.DataSource = dt;
                    itemsGrid.DataBind();
                    sumTotal = dt.Compute(&quot;sum(Amount)&quot;, string.Empty).ToDecimal2();
                    ModifyEquipmentLogDetailsColumnProperties();
                }
                if (itemsGrid.Columns.Exists(&quot;Work Order No&quot;))
                    itemsGrid.Columns.FromKey(&quot;Work Order No&quot;).Hidden = itemPostings;
                //ViewState[viewStateTotal] = sumTotal;
                sumTotalForRetCalc = sumTotal;
                totAmt.Text = &quot;Total: &quot; + sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                txtItemTotal.Value = sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                txtItemTotal.Style.Add(HtmlTextWriterStyle.TextAlign, &quot;right&quot;);

                HoldReleaseCalculation(sumTotal);

                ScriptManager.RegisterStartupScript(updPnlFormValidate, typeof(Page), &quot;ADD_FORM&quot;,
                                                    &quot;AttachEventHandlerToControl(&#39;&quot; + btnItemsDelete.ClientID +
                                                    &quot;&#39;, &#39;Button&#39;);AttachEventHandlerToControl(&#39;&quot; + itemsGrid.ClientID +
                                                    &quot;&#39;, &#39;WebGrid&#39;);&quot;, true);
            }
            else if (!(subContractor &amp;&amp; hdnItemPostings.Value.Equals(&quot;1&quot;)) || WorkOrderType.Equals(&quot;E&quot;))
            {
                //Modified the messages for Equipment Hire Order
                lblNoRows.Text = &quot;No &quot; +
                                 ((!WorkOrderType.Equals(&quot;A&quot;) &amp;&amp; (!subContractor &amp;&amp; !itemPostings))
                                      ? &quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot;s&quot;
                                      : (WorkOrderType.Equals(&quot;E&quot;) ? &quot;Equipment Logs&quot; : &quot;Postings&quot;)) + &quot; Available.&quot;;
                divItems.Style[&quot;display&quot;] = &quot;none&quot;;
                totAmt.Visible = btnItemsDelete.Visible = !(lblNoRows.Visible = true);
                txtItemTotal.Style.Value = lblNoRows.Visible ? &quot;display:none&quot; : &quot;display:block&quot;;
            }
            else
            {
                if (!IsPostBack)
                {
                    lblNoRows.Text = &quot;No &quot; + LocalizationManager.GetString(&quot;LOC_MeasurementBook&quot;) + &quot;s Available.&quot;;
                    divItems.Style[&quot;display&quot;] = &quot;none&quot;;
                    totAmt.Visible = btnItemsDelete.Visible = !(lblNoRows.Visible = true);
                }
                txtItemTotal.Style.Value = lblNoRows.Visible ? &quot;display:none&quot; : &quot;display:block&quot;;
                if (itemsGrid.Rows.Count == 0)
                    BindAndFormatMBookDetails(new DataTable());
            }

            #endregion
        }

        private void ModifyEquipmentLogDetailsColumnProperties()
        {
            ColumnsCollection cols = itemsGrid.Columns;
            if (cols.Exists(&quot;Date&quot;)) cols.FromKey(&quot;Date&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
            if (cols.Exists(&quot;LineNo&quot;)) cols.FromKey(&quot;LineNo&quot;).Header.Caption = &quot;Sl. No.&quot;;
            if (cols.Exists(&quot;LogBookNo&quot;)) cols.FromKey(&quot;LogBookNo&quot;).Header.Caption = &quot;Log Book No.&quot;;
            if (cols.Exists(&quot;FixedAssetName&quot;)) cols.FromKey(&quot;FixedAssetName&quot;).Header.Caption = &quot;Equipment Name&quot;;
            if (cols.Exists(&quot;IdentificationNo&quot;))
                cols.FromKey(&quot;IdentificationNo&quot;).Header.Caption = &quot;Serial No./Registration No.&quot;;
            if (cols.Exists(&quot;Duration&quot;)) cols.FromKey(&quot;Duration&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            if (cols.Exists(&quot;Rate&quot;)) cols.FromKey(&quot;Rate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            if (cols.Exists(&quot;Amount&quot;)) cols.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            if (cols.Exists(&quot;PostingID&quot;)) cols.FromKey(&quot;PostingID&quot;).Hidden = true;
            if (cols.Exists(&quot;EquipmentID&quot;)) cols.FromKey(&quot;EquipmentID&quot;).Hidden = true;
        }

        private void ModifyRFIDetailsColumnProperties()
        {
            ColumnsCollection cols = itemsGrid.Columns;
            if (cols.Exists(&quot;BillingRate&quot;))
            {
                cols.FromKey(&quot;BillingRate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                cols.FromKey(&quot;BillingRate&quot;).AllowUpdate = AllowUpdate.Yes;
                cols.FromKey(&quot;BillingRate&quot;).CellStyle.BackColor = Color.Yellow;
                cols.FromKey(&quot;BillingRate&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;BillingRate&quot;).Header.Caption = &quot;Billing Rate in &quot; +
                                                             LocalizationManager.GetString(
                                                                 KeyConstants.LOC_CURRENCY_SYMBOL);
            }
            if (cols.Exists(&quot;MaxAllowedPrice&quot;))
            {
                cols.FromKey(&quot;MaxAllowedPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;MaxAllowedPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                cols.FromKey(&quot;MaxAllowedPrice&quot;).Header.Caption = &quot;Available Price in &quot; +
                                                                 LocalizationManager.GetString(
                                                                     KeyConstants.LOC_CURRENCY_SYMBOL);
                cols.FromKey(&quot;MaxAllowedPrice&quot;).CellStyle.Padding.Right = Unit.Pixel(5);
                cols.FromKey(&quot;MaxAllowedPrice&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;MaxAllowedPrice&quot;).Header.Style.Padding.Right = Unit.Pixel(5);
            }
            if (cols.Exists(&quot;UnitPrice&quot;))
            {
                cols.FromKey(&quot;UnitPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;UnitPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                cols.FromKey(&quot;UnitPrice&quot;).CellStyle.Padding.Right = Unit.Pixel(5);
                cols.FromKey(&quot;UnitPrice&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;UnitPrice&quot;).Header.Style.Padding.Right = Unit.Pixel(5);
            }
            if (cols.Exists(&quot;Quantity&quot;))
            {
                cols.FromKey(&quot;Quantity&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Quantity&quot;).Header.Style.Padding.Right = Unit.Pixel(5);
                cols.FromKey(&quot;Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                //Aurigo.AMP3.Common.Constants.FORMAT_QUANTITY;
                cols.FromKey(&quot;Quantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Quantity&quot;).CellStyle.Padding.Right = Unit.Pixel(5);
            }
            foreach (UltraGridRow row in itemsGrid.Rows)
            {
                row.Cells.FromKey(&quot;IsPartRate&quot;).Style.BackgroundImage =
                    (row.Cells.FromKey(&quot;IsPartRate&quot;).Value.ToString2().Equals(&quot;1&quot;) ||
                     row.Cells.FromKey(&quot;IsPartRate&quot;).Value.ToString2().Equals(&quot;True&quot;))
                        ? &quot;../../Images/PartRate.png&quot;
                        : &quot;../../Images/FullRate.png&quot;;
                row.Cells.FromKey(&quot;IsPartRate&quot;).Style.Padding.Left = new Unit(&quot;16px&quot;, CultureInfo.CurrentCulture);
                row.Cells.FromKey(&quot;IsPartRate&quot;).Style.CustomRules =
                    &quot;background-repeat: no-repeat;background-position: center center&quot;;
                row.Cells.FromKey(&quot;IsPartRate&quot;).Style.Font.Size = FontUnit.Point(0);
            }
            if (itemsGrid.Rows.Count &gt; 0)
            {
                btnItemsDelete.Visible = true;
                txtItemTotal.Style.Value = &quot;display:block&quot;;
                txtItemTotal.Style.Add(HtmlTextWriterStyle.TextAlign, &quot;right&quot;);
            }

            if (WorkOrderType.Equals(&quot;A&quot;))
            {
                //itemsGrid.Columns.FromKey(&quot;Description&quot;).Hidden =
                itemsGrid.Columns.FromKey(&quot;Pay Item No.&quot;).Hidden = true;
                itemsGrid.Columns.FromKey(&quot;SubItemDescription&quot;).Header.Caption = &quot;Description&quot;;
            }
            //if(cols.Exists(&quot;IsPartRate&quot;)) cols.FromKey(&quot;IsPartRate&quot;).CellStyle.
        }

        //Gets Selected Work Order Indexes
        private string GetWOIdx()
        {
            string woidx = string.Empty;
            woidx += ddlWorkOrder.SelectedIndex;
            return woidx;
        }

        //Gets Selected Work Order Database IDs
        private string GetWOIDs()
        {
            string woids = string.Empty;
            woids += ddlWorkOrder.SelectedValue;
            return woids;
        }

        private void AddColumnsToGrid(UltraWebGrid grid, string woType, string ContractorType, ItemSource itemSource)
        {
            List&lt;string&gt; components = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);

            if (grid.Columns.Count != 1)
                return;

            var col = new UltraGridColumn();
            col.Key = &quot;ItemID&quot;;
            col.Header.Caption = &quot;ItemID&quot;;
            col.Hidden = true;
            grid.Columns.Add(col);

            if (ContractorType.Equals(&quot;S&quot;) || itemSource == ItemSource.ItemPostings)
            {
                col = new UltraGridColumn();
                col.Key = &quot;LineNo&quot;;
                col.Header.Caption = &quot;Line No&quot;;
                col.Hidden = !(ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.ItemPostings);
                grid.Columns.Add(col);
            }

            col = new UltraGridColumn();
            col.Key = &quot;Work Order No&quot;;
            col.Header.Caption = (ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.RFI)
                                     ? &quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; No&quot;
                                     : &quot;Work Order No&quot;;
            col.Hidden = (itemSource == ItemSource.ItemPostings);
            grid.Columns.Add(col);

            if (ContractorType.Equals(&quot;S&quot;) &amp;&amp; WorkOrderType.Equals(&quot;A&quot;))
            {
                col = new UltraGridColumn();
                col.Key = &quot;ActivityID&quot;;
                col.Hidden = true;
                grid.Columns.Add(col);

                col = new UltraGridColumn();
                col.Key = &quot;Activity&quot;;
                col.Header.Caption = &quot;Activity&quot;;
                grid.Columns.Add(col);
            }

            col = new UltraGridColumn();
            col.Key = &quot;Status&quot;;
            col.Header.Caption = &quot;Status&quot;;
            col.Hidden = (ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.ItemPostings);
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;DatePosted&quot;;
            col.Header.Caption = &quot;Posted Date&quot;;
            col.Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
            col.Hidden = (ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.RFI);
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;PostingID&quot;;
            col.Hidden = true;
            col.Header.Caption = &quot;PostingID&quot;;
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;Pay Item No.&quot;;
            col.Header.Caption = PayItemNo;
            col.Hidden = (WorkOrderType.Equals(&quot;A&quot;));
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;SubItemDescription&quot;;
            col.Header.Caption = (ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.RFI) ? &quot;Location&quot; : &quot;Sub Item&quot;;
            if ((ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.RFI))
                col.Hidden = true;
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;Description&quot;;
            col.Header.Caption = (woType.Equals(&quot;A&quot;)) ? &quot;Standard Item No&quot; : ItemNameAbbr + &quot; Description&quot;;
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;Quantity&quot;;
            col.Header.Caption = (ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.RFI)
                                     ? &quot;Certified Qty&quot;
                                     : &quot;Quantity&quot;;
            col.Header.Style.HorizontalAlign = HorizontalAlign.Right;
            col.Header.Style.Padding.Right = Unit.Pixel(5);
            col.Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY; //Aurigo.AMP3.Common.Constants.FORMAT_QUANTITY;
            col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            col.CellStyle.Padding.Right = Unit.Pixel(5);
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = col.Header.Caption = &quot;Billed Qty&quot;;
            col.Header.Style.HorizontalAlign = HorizontalAlign.Right;
            col.Header.Style.Padding.Right = Unit.Pixel(5);
            col.Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY; //Aurigo.AMP3.Common.Constants.FORMAT_QUANTITY;
            col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            col.CellStyle.Padding.Right = Unit.Pixel(5);
            col.Hidden = !(ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.RFI);
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;IsPartRate&quot;;
            col.Header.Caption = &quot;Part Rate&quot;;
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;UnitPrice&quot;;
            col.Header.Caption = &quot;Unit Price&quot;;
            col.Header.Style.HorizontalAlign = HorizontalAlign.Right;
            col.Header.Style.Padding.Right = Unit.Pixel(5);
            col.Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE; //Constants.FORMAT_CURRENCY_UNIT_PRICE;
            col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            col.CellStyle.Padding.Right = Unit.Pixel(5);
            if (!components.Contains(&quot;ItemUnitPrice&quot;)) col.Hidden = true;
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;MaxAllowedPrice&quot;;
            col.Header.Caption = &quot;Available Price&quot;;
            col.Header.Style.HorizontalAlign = HorizontalAlign.Right;
            col.Header.Style.Padding.Right = Unit.Pixel(5);
            col.Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE; //Constants.FORMAT_CURRENCY_UNIT_PRICE;
            col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            col.CellStyle.Padding.Right = Unit.Pixel(5);
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;BillingRate&quot;;
            col.Header.Caption = &quot;Billing Price&quot;;
            col.Header.Style.HorizontalAlign = HorizontalAlign.Right;
            col.Header.Style.Padding.Right = Unit.Pixel(5);
            col.Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE; //Constants.FORMAT_CURRENCY_UNIT_PRICE;
            col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            col.CellStyle.Padding.Right = Unit.Pixel(5);
            col.AllowUpdate = AllowUpdate.Yes;
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;Amount&quot;;
            col.Header.Caption = &quot;Amount&quot;;
            col.Header.Style.HorizontalAlign = HorizontalAlign.Right;
            col.Header.Style.Padding.Right = Unit.Pixel(5);
            col.Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT; //FORMAT_CURRRENCY_AMOUNT_TOTAL;
            col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            col.CellStyle.Padding.Right = Unit.Pixel(5);
            grid.Columns.Add(col);

            col = new UltraGridColumn();
            col.Key = &quot;ParentId&quot;;
            col.Header.Caption = &quot;ParentId&quot;;
            col.Hidden = true;
            grid.Columns.Add(col);

            if (ContractorType.Equals(&quot;P&quot;) &amp;&amp; itemSource == ItemSource.RFI)
            {
                col = new UltraGridColumn();
                col.Key = col.Header.Caption = &quot;RFIID&quot;;
                col.Hidden = true;
                grid.Columns.Add(col);

                col = new UltraGridColumn();
                col.Key = &quot;RefNo&quot;;
                col.Header.Caption = &quot;RefNo&quot;;
                grid.Columns.Add(col);
            }
        }

        private void ShowEquipmentHireOrderGrid()
        {
            var dt = new DataTable();
            dt.Columns.Add(&quot;LineNo&quot;);
            dt.Columns.Add(&quot;PostingID&quot;);
            dt.Columns.Add(&quot;LogBookNo&quot;);
            dt.Columns.Add(&quot;Date&quot;);
            dt.Columns.Add(&quot;FixedAssetName&quot;);
            dt.Columns.Add(&quot;IdentificationNo&quot;);
            dt.Columns.Add(&quot;Duration&quot;);
            dt.Columns.Add(&quot;Unit&quot;);
            dt.Columns.Add(&quot;EquipmentRate&quot;);
            dt.Columns.Add(&quot;Amount&quot;);
            itemsGrid.DataSource = dt;
            itemsGrid.DataBind();
            ModifyEquipmentLogDetailsColumnProperties();
        }

        private void ShowEmptyGrid() //UltraWebGrid grid, string woType, string ContractorType, ItemSource itemSource)
        {
            string contractorType;
            ItemSource itemSource;
            contractorType = (String.IsNullOrEmpty(Request[&quot;WOID&quot;])) ? &quot;P&quot; : &quot;S&quot;;
            itemSource = (contractorType.Equals(&quot;P&quot;) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;))
                             ? ItemSource.RFI
                             : ItemSource.ItemPostings;
            AddColumnsToGrid(itemsGrid, WorkOrderType, contractorType, itemSource);
        }

        protected void btnItemsDelete_Click(object sender, EventArgs e)
        {
            try
            {
                #region Getting Contractor and Contractor Type strings

                string Contractor = (ddlContractor.SelectedItem.Text != &quot;--Select One--&quot;)
                                        ? ddlContractor.SelectedValue
                                        : null;
                int? ContractorID = null;
                string ContractorType = null;

                if (!String.IsNullOrEmpty(Contractor))
                {
                    string[] strContr = Contractor.Split(&#39;,&#39;);

                    ContractorID = strContr[0].ToInt32_2();
                    ContractorType = strContr[1];
                }

                #endregion

                List&lt;UltraGridRow&gt; rows = null;
                bool hasChecked = false;
                decimal sumTotal; //= (decimal)ViewState[viewStateTotal];
                sumTotal = (string.IsNullOrEmpty(txtItemTotal.Value)) ? 0 : Convert.ToDecimal(txtItemTotal.Value);

                for (int i = 0; i &lt; itemsGrid.Rows.Count; i++)
                {
                    if (itemsGrid.Rows[i].Cells.FromKey(&quot;To&quot;).Value.ToBoolean2())
                    {
                        if (!hasChecked)
                            rows = new List&lt;UltraGridRow&gt;();

                        #region Remove all Postings of the same RFI

                        if (ContractorType.Equals(&quot;P&quot;)) //Case when RFI Items are being removed
                        {
                            int rfiID = 0;
                            if (itemsGrid.Rows[i].Cells.FromKey(&quot;RFIID&quot;) != null &amp;&amp;
                                Int32.TryParse(itemsGrid.Rows[i].Cells.FromKey(&quot;RFIID&quot;).Value.ToString2(), out rfiID))
                            {
                                for (int j = 0; j &lt; itemsGrid.Rows.Count; j++)
                                {
                                    if (j == i)
                                        continue;
                                    int rfiTempID = 0;
                                    if (itemsGrid.Rows[j].Cells.FromKey(&quot;RFIID&quot;) != null &amp;&amp;
                                        Int32.TryParse(itemsGrid.Rows[j].Cells.FromKey(&quot;RFIID&quot;).Value.ToString2(),
                                                       out rfiTempID) &amp;&amp;
                                        (rfiID == rfiTempID) &amp;&amp;
                                        !itemsGrid.Rows[j].Cells.FromKey(&quot;To&quot;).Value.ToBoolean2())
                                    {
                                        sumTotal -=
                                            itemsGrid.Rows[j].Cells.FromKey(&quot;Amount&quot;).Text.Replace(&quot;,&quot;, &quot;&quot;).Replace(
                                                LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL), &quot;&quot;).
                                                ToDecimal2();
                                        rows.Add(itemsGrid.Rows[j]);
                                    }
                                }
                            }
                        }

                        #endregion

                        hasChecked = true;
                        sumTotal -=
                            itemsGrid.Rows[i].Cells.FromKey(&quot;Amount&quot;).Text.Replace(&quot;,&quot;, &quot;&quot;).Replace(
                                LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL), &quot;&quot;).ToDecimal2();
                        rows.Add(itemsGrid.Rows[i]);
                    }
                }
                if (hasChecked)
                {
                    for (int i = 0; i &lt; rows.Count; i++)
                    {
                        itemsGrid.Rows.Remove(rows[i]);
                    }
                }

                totAmt.Text = &quot;Total: &quot;;
                totAmt.Text = totAmt.Text + sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                txtItemTotal.Value = sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);

                decimal sumTotalForRetCalc = 0;
                sumTotalForRetCalc = sumTotal;

                //Modified the messages for Equipment Hire Order
                if (!hasChecked)
                    throw new Exception(&quot;Please select at least one &quot; +
                                        ((ddlContractor.SelectedIndex == 1) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;)
                                             ? &quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot;s&quot;
                                             : (WorkOrderType.Equals(&quot;E&quot;) ? &quot;Equipment Logs&quot; : &quot;Postings&quot;) +
                                               &quot; to delete.&quot;));

                if (itemsGrid.Rows.Count == 0)
                {
                    //lblNoRows.Text = &quot;No &quot; + ((ddlContractor.SelectedIndex == 1 &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;)) ? &quot;RFIs&quot; : (WorkOrderType.Equals(&quot;E&quot;) ? &quot;Equipment Logs&quot; : &quot;Postings&quot;)) + &quot; Available&quot;;
                    lblNoRows.Text = &quot;No records to display&quot;;
                    divItems.Style[&quot;display&quot;] = &quot;none&quot;;
                    totAmt.Visible = btnItemsDelete.Visible = !(lblNoRows.Visible = true);
                    txtItemTotal.Style.Value = lblNoRows.Visible ? &quot;display:none&quot; : &quot;display:block&quot;;
                }

                // -------------------------- Calculate Retention when Rows are deleted --------------------------

                HoldReleaseCalculation(sumTotal);
            }
            catch (Exception ex)
            {
                base.ShowError(ex.Message);
            }
        }

        protected void btnSubmitMaster_Click(object sender, EventArgs e)
        {
            try
            {
                WorkflowEnabledSaveHandler(true);
            }
            catch (Exception ex)
            {
                base.ShowError(ex.Message.Replace(&quot;LOC_ITEM_ABBR&quot;, LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)));
            }
        }

        private void RemoveIntegrationPrepaymentRecovery()
        {
            string prepaymentID = &quot;&quot;;
            string zeroDecimals = (0).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
            if ((string.IsNullOrEmpty(lblAXOpeningBalances.Text) ||
                 lblAXOpeningBalances.Text.Equals(
                     LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL).Trim() + &quot; &quot; + zeroDecimals)) &amp;&amp;
                !CacheManager.Instance.IsIntegrated(PID))
            {
                for (int i = 0; i &lt; uwgPrePayment.Rows.Count; i++)
                {
                    UltraGridRow currentRow = uwgPrePayment.Rows[i];
                    if (currentRow != null &amp;&amp; currentRow.Cells.FromKey(&quot;IsIntegrationMode&quot;).Text.Equals(&quot;True&quot;))
                    {
                        currentRow.Cells.FromKey(&quot;CurrentRecovery&quot;).Text = zeroDecimals;
                        prepaymentID = prepaymentID + currentRow.Cells.FromKey(&quot;PrePaymentID&quot;).Text + &quot;,&quot;;
                    }
                }
                if (!string.IsNullOrEmpty(prepaymentID))
                {
                    if (prepaymentID.Trim().EndsWith(&quot;,&quot;))
                        prepaymentID = prepaymentID.Trim().Remove(prepaymentID.Trim().Length - 1);

                    throw new Exception(
                        &quot;There is no opening balances for the pre-payments in AX. Pre-Payments with ID &quot; + prepaymentID +
                        &quot; can not be recovered.&quot;);
                }
            }
        }

        protected void btnEditContract_Click(object sender, EventArgs e)
        {
            Response.Redirect(&quot;CreateEstimate.aspx?Mode=Edit&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] + &quot;&amp;ContractID=&quot; +
                              contractID.ToString2() + &quot;&amp;ParentID=&quot; + contractID.ToString2() + &quot;&amp;PEID=&quot; + Request[&quot;PEID&quot;] + &quot;&amp;ParentContext=CONTMGT&quot; +
                              (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                              (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]),
                              true);
        }

        protected void btnBack_Click(object sender, EventArgs e)
        {
            Response.Redirect(
                &quot;~/Common/BrixListPage.aspx?context=PAYESTM&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] + &quot;&amp;ContractID=&quot; +
                contractID.ToString2() + &quot;&amp;ParentID=&quot; + contractID.ToString2() +
                (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
        }

        protected void ddlContractor_Changed(object sender, EventArgs e)
        {
            PopulateWO(string.Empty);
        }

        private void PopulateWO(string woid)
        {
            WorkOrderType = &quot;&quot;;
            ddlWorkOrder.Items.Clear();
            ddlWorkOrder.Items.Insert(0, new ListItem(&quot;--Select One--&quot;, &quot;0&quot;));
            string WONo = string.Empty;
            if (ddlContractor.SelectedIndex &gt; 0)
            {
                DataTable dtFiltered = WORKORDManager.Instance.GetWOOrContractorForRAB(contractID, null,
                                                                                       ddlContractor.SelectedItem.Value.
                                                                                           Split(new[] { &#39;,&#39; })[0].
                                                                                           ToInt32_2());
                int i = 1;

                if (!string.IsNullOrEmpty(woid))
                    WONo =
                        ComponentHelper.Instance.ExecuteScalar(
                            WOStoredProcedure.usp_WORKORDGetWorkOrderNoOfWorkOrder, null, woid).ToString2();
                foreach (DataRow dRow in dtFiltered.Rows)
                {
                    ddlWorkOrder.Items.Insert(i,
                                              new ListItem(dRow[&quot;WorkOrderNo&quot;].ToString2(),
                                                           dRow[&quot;WorkOrderID&quot;].ToString2()));
                    if (!string.IsNullOrEmpty(woid) &amp;&amp; !dRow[&quot;WorkOrderType&quot;].Equals(DBNull.Value) &amp;&amp;
                        dRow[&quot;WorkOrderNo&quot;].ToString2().Equals(WONo))
                        WorkOrderType = dRow[&quot;WorkOrderType&quot;].ToString2();

                    i++;
                }
            }
            ddlWorkOrder.SelectedIndex = -1;
            if (!string.IsNullOrEmpty(woid) &amp;&amp; ddlWorkOrder.Items.FindByText(WONo) != null)
                ddlWorkOrder.SelectedValue = ddlWorkOrder.Items.FindByText(WONo).Value;
            else
                ddlWorkOrder.SelectedIndex = 0;

            WONumber.Text = ddlWorkOrder.SelectedItem.Text;

            SetPESettings();
        }

        private void LoadContractors()
        {
            DataTable dTable = ContractManager.BusinessLayer.BL.Instance.GetContractors(contractID);
            DataRow[] contractorSelectedRows;

            if (rblContractorType.SelectedValue.Equals(&quot;P&quot;))
            {
                contractorSelectedRows = dTable.Select(&quot;CType&lt;&gt;&#39;P&#39;&quot;);

                foreach (DataRow cRow in contractorSelectedRows)
                {
                    dTable.Rows.Remove(cRow);
                }
            }
            else
            {
                contractorSelectedRows = dTable.Select(&quot;CType&lt;&gt;&#39;S&#39;&quot;);

                foreach (DataRow cRow in contractorSelectedRows)
                {
                    dTable.Rows.Remove(cRow);
                }
            }

            ddlContractor.DataSource = dTable;
            ddlContractor.DataTextField = &quot;Contact&quot;;
            ddlContractor.DataValueField = &quot;ValueandType&quot;;
            ddlContractor.DataBind();

            var li = new ListItem(&quot;--Select One--&quot;, &quot;--Select One--&quot;);
            ddlContractor.Items.Insert(0, li);
        }

        protected void ContractorType_Changed(object sender, EventArgs e)
        {
            //Populate the Sub contractors for this contract

            LoadContractors();
            if (rblContractorType.SelectedValue.Equals(&quot;P&quot;))
            {
                ddlContractor.SelectedIndex = 1;
                ddlContractor.Enabled = false;

                PopulateWO(string.Empty);

                ddlWorkOrder.SelectedIndex = 0;
                ddlWorkOrder.Enabled = false;
            }
            else
            {
                ddlContractor.SelectedIndex = 0;
                ddlContractor.Enabled = true;

                PopulateWO(string.Empty);

                ddlWorkOrder.SelectedIndex = 0;
                ddlWorkOrder.Enabled = true;
            }

            //Now change the Label of Contract Advance based on Prime/Subcontractor
            if (rblContractorType.SelectedIndex == 0) //Prime Contractor
                lblTotalContractAdvancehead.Text = &quot;Total &quot; + LocalizedContractName + &quot; Advance Received:&quot;;
            else
                lblTotalContractAdvancehead.Text = &quot;Total &quot; + LocalizedContractName + &quot; Advance Paid:&quot;;
        }

        protected void ddlWorkOrder_Changed(object sender, EventArgs e)
        {
            SetPESettings();

            WorkOrderType = ddlWorkOrder.SelectedIndex &gt; 0
                                ? WORKORDManager.Instance.GetWOOrContractorForRAB(contractID,
                                                                                  ddlWorkOrder.SelectedItem.Value.
                                                                                      ToInt32_2(),
                                                                                  ddlContractor.SelectedItem.Value.Split
                                                                                      (new[] { &#39;,&#39; })[0].ToInt32_2()).Rows
                                      [0][&quot;WorkOrderType&quot;].ToString2()
                                : string.Empty;
        }

        public void HoldReleaseCalculation(decimal sumTotal)
        {
            decimal sumTotalForRetCalc = sumTotal;
            if (txtHoldPercent.Text != &quot;&quot;)
            {
                decimal holdAmt = sumTotal * ((txtHoldPercent.Text.ToDecimal2()) / 100);
                txtCurrentHoldAmount.Text = holdAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
            }

            if (txtRetentionCP.Text != &quot;&quot;)
            {
                decimal totWOamt = DTTotalAmt.Rows[0][&quot;TotalAmount&quot;].ToString().ToDecimal2();
                decimal retentionCV = totWOamt * ((txtRetentionCP.Text.ToDecimal2()) / 100);
                decimal retentionVal = sumTotalForRetCalc * ((txtRetention.Text.ToDecimal2()) / 100);
                decimal totRetAmt = DTRetAmtFromRule.Rows[0][&quot;RetentionAmount&quot;].ToDecimal2();

                txtTotalretAmt.Text = totRetAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                if (retentionCV &gt; (DTRetAmtFromRule.Rows[0][&quot;RetentionAmount&quot;].ToDecimal2() + retentionVal))
                {
                    txtRetentionINR.Text = retentionVal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                    sumTotalForRetCalc = sumTotalForRetCalc - txtRetentionINR.Text.ToDecimal2();

                    totRetAmt = totRetAmt + retentionVal;

                    txtTotalretAmt.Text = totRetAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                }
                else
                {
                    if (retentionCV != DTRetAmtFromRule.Rows[0][0].ToDecimal2())
                    {
                        decimal retentionExceedVal = (DTRetAmtFromRule.Rows[0][&quot;RetentionAmount&quot;].ToDecimal2() +
                                                      retentionVal) - retentionCV;
                        decimal retExceeded;
                        if (retentionVal &gt; retentionExceedVal)
                            retExceeded = retentionVal - retentionExceedVal;
                        else
                            retExceeded = retentionExceedVal - retentionVal;

                        txtRetentionINR.Text = retExceeded.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                        sumTotalForRetCalc = (sumTotalForRetCalc + totRetAmt) - retentionVal;

                        totRetAmt = totRetAmt + retExceeded;

                        txtTotalretAmt.Text = totRetAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                    }
                    else
                    {
                        decimal retval = DTRetAmtFromRule.Rows[0][&quot;RetentionAmount&quot;].ToDecimal2();
                        txtRetentionINR.Text = retval.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                    }
                }
            }
        }

        protected override void SetModes()
        {
            base.SetModes();
            _IsNew = string.IsNullOrEmpty(Request.QueryString[&quot;PEID&quot;]) &amp;&amp; !IsPostBack;
            _IsEdit = !(bool)_IsNew;
        }

        public override Dictionary&lt;string, string&gt; PassInformationToWorkFlow()
        {
            Dictionary&lt;string, string&gt; ds = base.PassInformationToWorkFlow();
            ds.Add(&quot;UserName&quot;, UserDetail.GetCurrentUserDetail().UserName);

            return ds;
        }

        #region Additions/Deductions Grids

        private void LoadAdjustmentsGrid(int? peID, bool isGridClear, bool isMasterDataLoaded)
        {
            if (isGridClear)
            {
                uwgRABDeductions.Rows.Clear();
                uwgRABAdditions.Rows.Clear();
            }

            if (peID.GetValueOrDefault(0) != 0)
            {
                DataTable dtPESpecificAdjustments = BL.Instance.GetPEAdjustmentDetails(peID, null);

                DataRow[] AdditionRows = dtPESpecificAdjustments.Select(&quot;AdjustmentType=1&quot;);
                AddAdjustmentsToGrid(uwgRABAdditions, AdditionRows);

                DataRow[] DeductionRows = dtPESpecificAdjustments.Select(&quot;AdjustmentType=2&quot;);
                AddAdjustmentsToGrid(uwgRABDeductions, DeductionRows);
            }

            if (isMasterDataLoaded)
            {
                DataTable dtAdjustmentsMaster =
                    BL.Instance.GetAdjustmentMasterList(Session[Constants.EIS_ADDITIONAL_INFO].ToString(), null);
                DataRow[] AdditionMasterRows = dtAdjustmentsMaster.Select(&quot;AdjustmentType=1&quot;);
                AddAdjustmentsToGrid(uwgRABAdditions, AdditionMasterRows);

                DataRow[] DeductionMasterRows = dtAdjustmentsMaster.Select(&quot;AdjustmentType=2&quot;);
                AddAdjustmentsToGrid(uwgRABDeductions, DeductionMasterRows);
            }

            FormatAdjustmentsGrid(uwgRABAdditions);
            FormatAdjustmentsGrid(uwgRABDeductions);

            UpdateAdjustmentsTotal();
        }

        private void FormatAdjustmentsGrid(UltraWebGrid uwg)
        {
            uwg.Width = Unit.Pixel(730);
            uwg.Columns.FromKey(&quot;ID&quot;).Hidden = true;
            uwg.Columns.FromKey(&quot;AdjustmentType&quot;).Hidden = true;

            uwg.Columns.FromKey(&quot;AdjustmentID&quot;).Header.Caption = &quot;Label&quot;;
            uwg.Columns.FromKey(&quot;AdjustmentID&quot;).Width = 150;
            uwg.Columns.FromKey(&quot;AdjustmentDescription&quot;).Header.Caption = &quot;Description&quot;;
            uwg.Columns.FromKey(&quot;AdjustmentDescription&quot;).Width = 300;
            uwg.Columns.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            uwg.Columns.FromKey(&quot;Amount&quot;).Width = 280;

            if (Mode != PageMode.View)
            {
                uwg.Columns.FromKey(&quot;AdjustmentDescription&quot;).CellStyle.BackColor = Color.Yellow;
                uwg.Columns.FromKey(&quot;AdjustmentDescription&quot;).AllowUpdate = AllowUpdate.Yes;
                uwg.Columns.FromKey(&quot;Amount&quot;).CellStyle.BackColor = Color.Yellow;
                uwg.Columns.FromKey(&quot;Amount&quot;).AllowUpdate = AllowUpdate.Yes;
            }
        }

        private void AddAdjustmentsToGrid(UltraWebGrid uwg, DataRow[] AdjustmentRows)
        {
            for (int i = 0; i &lt; AdjustmentRows.Length; i++)
            {
                bool isAdjustmentFound = false;

                foreach (UltraGridRow ugr in uwg.Rows)
                {
                    if (
                        ugr.Cells.FromKey(&quot;AdjustmentID&quot;).ToString2().Equals(
                            AdjustmentRows[i][&quot;AdjustmentID&quot;].ToString2()))
                    {
                        isAdjustmentFound = true;
                        break;
                    }
                }

                if (isAdjustmentFound) continue;

                uwg.Rows.Add(new UltraGridRow(new[]
                                                  {
                                                      false
                                                      , AdjustmentRows[i][&quot;ID&quot;]
                                                      , AdjustmentRows[i][&quot;AdjustmentType&quot;]
                                                      , AdjustmentRows[i][&quot;AdjustmentID&quot;]
                                                      , AdjustmentRows[i][&quot;AdjustmentDescription&quot;]
                                                      , AdjustmentRows[i][&quot;Amount&quot;]
                                                  }));
            }
        }

        private void UpdateAdjustmentsTotal()
        {
            decimal totalAdditions = 0;
            foreach (UltraGridRow currRow in uwgRABAdditions.Rows)
            {
                decimal temp = 0;
                Decimal.TryParse(currRow.Cells.FromKey(&quot;Amount&quot;).Value.ToString2(), out temp);
                totalAdditions += temp;
            }
            lblTotalAdditions.Text = totalAdditions.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);

            decimal totalDeductions = 0;
            foreach (UltraGridRow currRow in uwgRABDeductions.Rows)
            {
                decimal temp = 0;
                Decimal.TryParse(currRow.Cells.FromKey(&quot;Amount&quot;).Value.ToString2(), out temp);
                totalDeductions += temp;
            }
            lblTotalDeductions.Text = totalDeductions.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
        }

        #endregion

        #region Material Deductions Grid

        private void LoadMaterialDeductionDetailsGrid(bool isGridClear, DateTime? ToDate, int? ContractorID,
                                                      String ContractorType, string includeAllTypes)
        {
            DataTable dtMaterialDeductions = BL.Instance.GetPEMIDetails(contractID,
                                                                        String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                                            ? (int?)null
                                                                            : int.Parse(Request[&quot;PEID&quot;]), ToDate,
                                                                        ContractorID,
                                                                        ContractorType,
                                                                        (String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                                             ? (int?)null
                                                                             : int.Parse(Request[&quot;WOID&quot;])),
                                                                        includeAllTypes);

            if (isGridClear)
                uwgMaterialDeductions.Rows.Clear();

            AddMaterialDeductionsToGrid(dtMaterialDeductions);

            FormatMaterialDeductionsGrid();

            UpdateMaterialDeductionTotal();
        }

        private void UpdateMaterialDeductionTotal()
        {
            decimal totalMaterialDeductions = 0;
            foreach (UltraGridRow currRow in uwgMaterialDeductions.Rows)
            {
                decimal temp = 0;
                Decimal.TryParse(currRow.Cells.FromKey(&quot;CurrentRecoveryAmount&quot;).Value.ToString2(), out temp);
                totalMaterialDeductions += temp;
            }
            lblTotMaterialDeductions.Text = totalMaterialDeductions.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
        }

        private void AddMaterialDeductionsToGrid(DataTable dtMaterialDeductions)
        {
            for (int i = 0; i &lt; dtMaterialDeductions.Rows.Count; i++)
            {
                bool isMIFound = false;

                foreach (UltraGridRow ugr in uwgMaterialDeductions.Rows)
                {
                    if (ugr.Cells.FromKey(&quot;MIListID&quot;).ToString2().Equals(
                        dtMaterialDeductions.Rows[i][&quot;MIListID&quot;].ToString2())
                        &amp;&amp;
                        ugr.Cells.FromKey(&quot;ResourceDetailID&quot;).ToString2().Equals(
                            dtMaterialDeductions.Rows[i][&quot;ResourceDetailID&quot;].ToString2()))
                    {
                        isMIFound = true;
                        break;
                    }
                }

                if (isMIFound) continue;

                uwgMaterialDeductions.Rows.Add(new UltraGridRow(new[]
                                                                    {
                                                                        false
                                                                        , dtMaterialDeductions.Rows[i][&quot;MIListID&quot;]
                                                                        ,
                                                                        dtMaterialDeductions.Rows[i][&quot;MaterialIssueID&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;IssuedDate&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;IssueType&quot;]
                                                                        ,
                                                                        dtMaterialDeductions.Rows[i][&quot;ResourceDetailID&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;ResDescription&quot;]
                                                                        ,
                                                                        dtMaterialDeductions.Rows[i][&quot;ParentResItemID&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;Size&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;Color&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;Configuration&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;IssuedQty&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;IssuedRate&quot;]
                                                                        , dtMaterialDeductions.Rows[i][&quot;RemainingQty&quot;]
                                                                        ,
                                                                        dtMaterialDeductions.Rows[i][
                                                                            &quot;CurrentRecoveryQty&quot;]
                                                                        ,
                                                                        dtMaterialDeductions.Rows[i][
                                                                            &quot;CurrentRecoveryRate&quot;]
                                                                        ,
                                                                        dtMaterialDeductions.Rows[i][
                                                                            &quot;CurrentRecoveryAmount&quot;]
                                                                    }));
            }
        }

        private void FormatMaterialDeductionsGrid()
        {
            #region Grouping of Columns

            foreach (UltraGridColumn c in uwgMaterialDeductions.DisplayLayout.Bands[0].Columns)
                c.Header.RowLayoutColumnInfo.OriginY = 1;

            var ch = new ColumnHeader(true);
            ch.Caption = &quot;Total Issued&quot;;
            ch.Style.HorizontalAlign = HorizontalAlign.Center;
            ch.RowLayoutColumnInfo.OriginY = 0;
            ch.RowLayoutColumnInfo.OriginX = 11;
            ch.RowLayoutColumnInfo.SpanX = 2;
            ch.RowLayoutColumnInfo.SpanY = 1;

            uwgMaterialDeductions.DisplayLayout.Bands[0].HeaderLayout.Add(ch);

            ch = new ColumnHeader(true);
            ch.Caption = &quot;Recovery in this Bill&quot;;
            ch.Style.HorizontalAlign = HorizontalAlign.Center;
            ch.RowLayoutColumnInfo.OriginY = 0;
            ch.RowLayoutColumnInfo.OriginX = 14;
            ch.RowLayoutColumnInfo.SpanX = 3;
            ch.RowLayoutColumnInfo.SpanY = 1;

            uwgMaterialDeductions.DisplayLayout.Bands[0].HeaderLayout.Add(ch);

            // All the Headers for bound columns initialize to SpanY=1.  Since we want them
            // to extend across the added column header we are going to need to span them down a level
            foreach (UltraGridColumn c in uwgMaterialDeductions.Columns)
            {
                if (!(c.Key.Equals(&quot;CurrentRecoveryQty&quot;) || c.Key.Equals(&quot;CurrentRecoveryRate&quot;) ||
                      c.Key.Equals(&quot;CurrentRecoveryAmount&quot;) || c.Key.Equals(&quot;IssuedQty&quot;) || c.Key.Equals(&quot;IssuedRate&quot;)))
                {
                    c.Header.RowLayoutColumnInfo.OriginY = 0;
                    c.Header.RowLayoutColumnInfo.SpanY = 2;
                }
            }

            #endregion

            #region Formatting the Columns

            uwgMaterialDeductions.DisplayLayout.AllowColSizingDefault = AllowSizing.Fixed;
            uwgMaterialDeductions.DisplayLayout.Bands[0].AllowColSizing = AllowSizing.Fixed;

            uwgMaterialDeductions.Columns.FromKey(&quot;MIListID&quot;).Hidden = true;
            uwgMaterialDeductions.Columns.FromKey(&quot;ResourceDetailID&quot;).Hidden = true;

            uwgMaterialDeductions.Columns.FromKey(&quot;MaterialIssueID&quot;).Header.Caption = &quot;Material Issue ID&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;MaterialIssueID&quot;).Width = 110;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedDate&quot;).Header.Caption = &quot;Issue Date&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedDate&quot;).Width = 80;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedDate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssueType&quot;).Header.Caption = &quot;Issue Type&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssueType&quot;).Width = 80;
            uwgMaterialDeductions.Columns.FromKey(&quot;ResDescription&quot;).Header.Caption = &quot;Description&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;ResDescription&quot;).Width = 100;
            uwgMaterialDeductions.Columns.FromKey(&quot;ParentResItemID&quot;).Header.Caption = &quot;Resource ID&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;ParentResItemID&quot;).Width = 80;
            uwgMaterialDeductions.Columns.FromKey(&quot;Size&quot;).Header.Caption = &quot;Size&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;Size&quot;).Width = 80;
            uwgMaterialDeductions.Columns.FromKey(&quot;Color&quot;).Header.Caption = &quot;Color&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;Color&quot;).Width = 80;
            uwgMaterialDeductions.Columns.FromKey(&quot;Configuration&quot;).Header.Caption = &quot;Configuration&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;Configuration&quot;).Width = 80;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedQty&quot;).Header.Caption = &quot;Quantity&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedQty&quot;).Width = 100;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedRate&quot;).Header.Caption = &quot;Rate&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedRate&quot;).Width = 100;
            uwgMaterialDeductions.Columns.FromKey(&quot;IssuedRate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            uwgMaterialDeductions.Columns.FromKey(&quot;RemainingQty&quot;).Header.Caption = &quot;Remaining Quantity&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;RemainingQty&quot;).Width = 120;
            uwgMaterialDeductions.Columns.FromKey(&quot;RemainingQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryQty&quot;).Header.Caption = &quot;Quantity&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryQty&quot;).Width = 100;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryRate&quot;).Header.Caption = &quot;Rate&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryRate&quot;).Width = 100;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryRate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryAmount&quot;).Header.Caption = &quot;Amount&quot;;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryAmount&quot;).Width = 100;
            uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryAmount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;

            if (Mode != PageMode.View)
            {
                uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryQty&quot;).CellStyle.BackColor = Color.Yellow;
                uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryQty&quot;).AllowUpdate = AllowUpdate.Yes;
                uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryRate&quot;).CellStyle.BackColor = Color.Yellow;
                uwgMaterialDeductions.Columns.FromKey(&quot;CurrentRecoveryRate&quot;).AllowUpdate = AllowUpdate.Yes;
            }

            #endregion
        }

        #endregion

        #region Load Prepayment Details

        private DataTable GetDataSourceForPrepayment(DataTable dt, string ContractorType, int? ContractorID)
        {
            if (IsERPConnected)
            {
                DataTable dtFinal = dt.Clone();
                var dtMOH = new DataTable();
                string mappedCompany = &quot;&quot;, erpProjectID = &quot;&quot;;
                ;
                ConnectorParameters connectorParameter = null;
                int count = 0;
                var dsPE = new DataSet();
                var ConBrixInfo = new List&lt;ConnectionBrixInfo&gt;();
                ConBrixInfo.Add(new ConnectionBrixInfo(AMP3Object.CONTMGT, contractID.ToString(), AMP3Object.UNKNOWN,
                                                       &quot;0&quot;));

                DataTable dtMap = IntegrationConnectorManager.Instance.GetERPObjectMapInfo(contractID.ToString(),
                                                                                           AMP3Object.CONTMGT, null,
                                                                                           AMP3Object.UNKNOWN,
                                                                                           RegisteredEIS.AX);
                if (dtMap != null &amp;&amp; dtMap.Rows.Count &gt; 0)
                {
                    mappedCompany = dtMap.Rows[0][&quot;ERPCompany&quot;].ToString2();
                    erpProjectID = dtMap.Rows[0][&quot;ERPId&quot;].ToString2();
                }

                //#region Preparing the additional information
                var objAdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
                objAdditionalInfo.AddInfo(Constants.EIS_ADDITIONAL_INFO, mappedCompany);
                var dictAdditionalInfo = new Dictionary&lt;RegisteredEIS, EISAdditionalInfo&gt;();
                dictAdditionalInfo.Add(RegisteredEIS.AX, objAdditionalInfo);
                string filter = &quot;&lt;XMLRoot&gt;&quot;;
                int i = 0;
                var dtRef = new DataTable();
                dtRef.Columns.Add(&quot;MOHID&quot;, typeof(String));
                dtRef.Columns.Add(&quot;JournalNum&quot;, typeof(String));
                foreach (DataRow dr in dt.Rows)
                {
                    if (!Convert.ToBoolean(dr[&quot;IsIntegrationMode&quot;]))
                    {
                        dtMOH = IntegrationConnectorManager.Instance.GetERPObjectMapInfo(dr[&quot;MOHID&quot;].ToString(),
                                                                                         AMP3Object.CONTMOH,
                                                                                         contractID.ToString(),
                                                                                         AMP3Object.CONTMGT,
                                                                                         RegisteredEIS.AX);
                        if (dtMOH != null &amp;&amp; dtMOH.Rows.Count &gt; 0)
                        {
                            filter += &quot;&lt;JournalNum&quot; + i + &quot; type=&#39;txt&#39;&gt;&quot; +
                                      dtMOH.Rows[0][&quot;ERPId&quot;].ToString2().Split(&#39;;&#39;)[0] + &quot;&lt;/JournalNum&quot; + i + &quot;&gt;&quot;;
                            DataRow drRef = dtRef.NewRow();
                            drRef[&quot;MOHID&quot;] = dr[&quot;MOHID&quot;].ToString();
                            drRef[&quot;JournalNum&quot;] = dtMOH.Rows[0][&quot;ERPId&quot;].ToString2().Split(&#39;;&#39;)[0];
                            dtRef.Rows.Add(drRef);
                            i++;
                        }
                    }
                    else
                    {
                        DataRow drRefNew = dtRef.NewRow();
                        drRefNew[&quot;MOHID&quot;] = dr[&quot;MOHID&quot;].ToString();
                        drRefNew[&quot;JournalNum&quot;] = &quot;&quot;;
                        dtRef.Rows.Add(drRefNew);
                        i++;
                    }
                }
                filter += &quot;&lt;/XMLRoot&gt;&quot;;
                if (!filter.Equals(&quot;&lt;XMLRoot&gt;&lt;/XMLRoot&gt;&quot;))
                {
                    var filterInfo = new ConnectionFilter(filter, null, null, null, null);
                    connectorParameter = new ConnectorParameters(dictAdditionalInfo, MethodBase.GetCurrentMethod(),
                                                                 AMP3ObjectType.Unknown, filterInfo, ConBrixInfo);
                    DataTable dtPE = null;
                    if (IntegrationConnectorManager.HandleIntegration(connectorParameter, ref count, ref dsPE, true))
                    {
                        if (dsPE.Tables[0] != null &amp;&amp; dsPE.Tables[0].Rows.Count &gt; 0)
                        {
                            dtPE = dsPE.Tables[0].Clone();
                            DataRow[] drPE = dsPE.Tables[0].Select(&quot;Posted = 1&quot;);
                            foreach (DataRow dr in drPE)
                                dtPE.ImportRow(dr);
                            if (dtPE.Rows.Count &gt; 0)
                            {
                                dtPE.Columns.Add(&quot;MOHID&quot;, typeof(String));
                                DataRow drPE1 = dtPE.NewRow();
                                foreach (DataRow dr in dtPE.Rows)
                                {
                                    drPE1 = dtRef.Select(&quot;JournalNum = &#39;&quot; + dr[0] + &quot;&#39;&quot;)[0];
                                    dr[&quot;MOHID&quot;] = drPE1[&quot;MOHID&quot;].ToString();
                                }
                                DataRow drFinal = dtFinal.NewRow();
                                foreach (DataRow dr in dtPE.Rows)
                                {
                                    drFinal = dt.Select(&quot;MOHID = &#39;&quot; + dr[&quot;MOHID&quot;] + &quot;&#39;&quot;)[0];
                                    dtFinal.ImportRow(drFinal);
                                }
                            }
                        }
                    }
                    //ADD Approved prepayments of the Integration mode project
                    foreach (DataRow drRef in dtRef.Rows)
                    {
                        DataRow[] drSelect = dt.Select(&quot;MOHID = &#39;&quot; + drRef[&quot;MOHID&quot;] + &quot;&#39; AND IsIntegrationMode = 1&quot;);
                        if (drSelect.Length &gt; 0)
                        {
                            if (dtFinal.Select(&quot;MOHID = &#39;&quot; + drSelect[0][&quot;MOHId&quot;] + &quot;&#39;&quot;).Length == 0)
                                dtFinal.ImportRow(drSelect[0]);
                        }
                    }
                    dsPE = new DataSet();
                }
                else
                {
                    foreach (DataRow drRef in dtRef.Rows)
                    {
                        DataRow drFinal = dt.Select(&quot;MOHID = &#39;&quot; + drRef[&quot;MOHID&quot;] + &quot;&#39;&quot;)[0];
                        dtFinal.ImportRow(drFinal);
                    }
                }
                FetchAXOpeningBalancesForPrePayment(mappedCompany, ContractorID.ToString(), ContractorType,
                                                    Request[&quot;ContractID&quot;]);
                return dtFinal;
            }
            else
                return dt;
        }

        private void FetchAXOpeningBalancesForPrePayment(string company, string ContractorID, string ContractorType,
                                                         string contractID)
        {
            // PROJECT IN LIVE MODE 
            var dsPE = new DataSet();
            int count = 0;
            var ConBrixInfo = new List&lt;ConnectionBrixInfo&gt;();
            string erpProjectID = &quot;&quot;;
            var objAdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
            objAdditionalInfo.AddInfo(Constants.EIS_ADDITIONAL_INFO, company);
            var dictAdditionalInfo = new Dictionary&lt;RegisteredEIS, EISAdditionalInfo&gt;();
            dictAdditionalInfo.Add(RegisteredEIS.AX, objAdditionalInfo);
            DataTable dtMap = IntegrationConnectorManager.Instance.GetERPObjectMapInfo(contractID, AMP3Object.CONTMGT,
                                                                                       null, AMP3Object.UNKNOWN,
                                                                                       RegisteredEIS.AX);
            if (dtMap != null &amp;&amp; dtMap.Rows.Count &gt; 0)
            {
                company = dtMap.Rows[0][&quot;ERPCompany&quot;].ToString2();
                erpProjectID = dtMap.Rows[0][&quot;ERPId&quot;].ToString2();
            }
            if (!CacheManager.Instance.IsIntegrated(PID))
            {
                lblAXOpeningBalances.Visible = true;
                tdCaption.Visible = true;
                //FETCH THE PREPAYMENT OPENING BALANCES
                string accountNumber = (!string.IsNullOrEmpty(ContractorType)) &amp;&amp; ContractorType.Equals(&quot;S&quot;) ? ContractorID : erpProjectID;
                string filter = &quot;&lt;XMLRoot&gt;&lt;AccountNumber type=&#39;txt&#39;&gt;&quot; + accountNumber + &quot;&lt;/AccountNumber&gt;&lt;/XMLRoot&gt;&quot;;
                ConBrixInfo.Add(new ConnectionBrixInfo(AMP3Object.CONTMGT, contractID, AMP3Object.UNKNOWN, &quot;0&quot;));
                var connectorParameter = new ConnectorParameters(dictAdditionalInfo,
                                                                 MethodBase.GetCurrentMethod().DeclaringType.ToString(),
                                                                 &quot;LoadPrepaymentOpeningBalances_&quot; + ContractorType,
                                                                 AMP3ObjectType.Unknown,
                                                                 new ConnectionFilter(filter, null, null, null, null),
                                                                 ConBrixInfo);
                if (IntegrationConnectorManager.HandleIntegration(connectorParameter, ref count, ref dsPE, true))
                {
                    if (dsPE.Tables[0] != null &amp;&amp; dsPE.Tables[0].Rows.Count &gt; 0 &amp;&amp;
                        !string.IsNullOrEmpty(Convert.ToString(dsPE.Tables[0].Rows[0][&quot;OpeningBalancesVoucher&quot;])))
                    {
                        lblAXOpeningBalances.Text =
                            LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL).Trim() + &quot; &quot; +
                            Convert.ToDecimal(
                                dsPE.Tables[0].Rows[0][&quot;OpeningBalancesVoucher&quot;]).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                    }
                }
            }
            else
            {
                lblAXOpeningBalances.Visible = false;
                tdCaption.Visible = false;
            }
        }

        private void LoadPrepaymentDetails(DateTime ToDate, int? ContractorID, String ContractorType,
                                           string getAvailableMOH, string isForPopUp)
        {
            #region Pre-Payment Pop Up Loading

            if (Mode != PageMode.View)
            {
                DataTable dtPrepayment = BL.Instance.GetPEPrepaymentDetails(contractID,
                                                                            String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                                                ? (int?)null
                                                                                : int.Parse(Request[&quot;PEID&quot;]), ToDate.ToUtc(),
                                                                            ContractorID,
                                                                            ContractorType,
                                                                            (String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                                                 ? (int?)null
                                                                                 : int.Parse(Request[&quot;WOID&quot;])), &quot;Y&quot;, &quot;Y&quot;)
                    .Tables[0];

                ppGrid.DataSource = GetDataSourceForPrepayment(dtPrepayment, ContractorType, ContractorID);
                ppGrid.DataBind();
                SetPrepaymentPopUpGridColumns();
            }

            #endregion

            DataSet dsPrepayment = BL.Instance.GetPEPrepaymentDetails(contractID,
                                                                      String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                                          ? (int?)null
                                                                          : int.Parse(Request[&quot;PEID&quot;]),
                                                                      ToDate.ToUtc(), ContractorID, ContractorType,
                                                                      (String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                                           ? (int?)null
                                                                           : int.Parse(Request[&quot;WOID&quot;])),
                                                                      getAvailableMOH, isForPopUp);

            //Check for Integration Date Mode of the Project.If Integration Mode then Load all pre-payments from BRIX.               
            string projectMode = CacheManager.Instance.IsIntegrated(Request[Constants.QRY_PROJECTID].ToInt32_2())
                                     ? &quot;I&quot;
                                     : &quot;L&quot;;
            DataTable dtParent = dsPrepayment.Tables[1];
            DataTable dtChild = dsPrepayment.Tables[0];
            if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX) &amp;&amp;
                !projectMode.Equals(&quot;I&quot;))
            {
                dtChild = GetDataSourceForPrepayment(dtChild, ContractorType, ContractorID);
                dsPrepayment.Tables[0].Clear();
                dsPrepayment.Tables[0].Merge(dtChild);
            }

            for (int i = 0; i &lt; dtParent.Rows.Count; i++)
            {
                DataRow drChild =
                    dtChild.Rows.OfType&lt;DataRow&gt;().ToList().Find(
                        row =&gt;
                        (row[&quot;MOHTypeID&quot;].ToString().Equals(dtParent.Rows[i][&quot;MOHTypeID&quot;].ToString(),
                                                            StringComparison.CurrentCultureIgnoreCase)));
                if (drChild == null)
                {
                    dtParent.Rows.Remove(dtParent.Rows[i]);
                    i--;
                }
                else
                {
                    dtParent.Rows[i][&quot;Amount&quot;] = &quot;0&quot;;
                    dtParent.Rows[i][&quot;AmountRecovered&quot;] = &quot;0&quot;;
                    dtParent.Rows[i][&quot;AmountRemaining&quot;] = &quot;0&quot;;
                    dtParent.Rows[i][&quot;CurrentRecovery&quot;] = &quot;0&quot;;
                    dtParent.Rows[i][&quot;MaxRecoveryValue&quot;] = &quot;0&quot;;
                    for (int j = 0; j &lt; dtChild.Rows.Count; j++)
                    {
                        if (dtParent.Rows[i][&quot;MOHTypeID&quot;].ToString() == dtChild.Rows[j][&quot;MOHTypeID&quot;].ToString())
                        {
                            //dtChild.Rows[j][&quot;CurrentRecovery&quot;] = (dtChild.Rows[j][&quot;AmountRemaining&quot;].ToDecimal2() &gt; dtChild.Rows[j][&quot;MaxRecoveryValue&quot;].ToDecimal2()) ? dtChild.Rows[j][&quot;MaxRecoveryValue&quot;].ToDecimal2().ToString() : dtChild.Rows[j][&quot;AmountRemaining&quot;].ToDecimal2().ToString();
                            dtParent.Rows[i][&quot;Amount&quot;] =
                                (dtParent.Rows[i][&quot;Amount&quot;].ToDecimal2() + dtChild.Rows[j][&quot;Amount&quot;].ToDecimal2()).
                                    ToString();
                            dtParent.Rows[i][&quot;AmountRecovered&quot;] =
                                (dtParent.Rows[i][&quot;AmountRecovered&quot;].ToDecimal2() +
                                 dtChild.Rows[j][&quot;AmountRecovered&quot;].ToDecimal2()).ToString();
                            dtParent.Rows[i][&quot;AmountRemaining&quot;] =
                                (dtParent.Rows[i][&quot;AmountRemaining&quot;].ToDecimal2() +
                                 dtChild.Rows[j][&quot;AmountRemaining&quot;].ToDecimal2()).ToString();
                            dtParent.Rows[i][&quot;CurrentRecovery&quot;] =
                                (dtParent.Rows[i][&quot;CurrentRecovery&quot;].ToDecimal2() +
                                 dtChild.Rows[j][&quot;CurrentRecovery&quot;].ToDecimal2()).ToString();
                            dtParent.Rows[i][&quot;MaxRecoveryValue&quot;] =
                                (dtParent.Rows[i][&quot;MaxRecoveryValue&quot;].ToDecimal2() +
                                 dtChild.Rows[j][&quot;MaxRecoveryValue&quot;].ToDecimal2()).ToString();
                        }
                    }
                }
            }

            if (dtParent.Rows.Count &gt; 0)
            {
                if (dtChild.Rows.Count &gt; 0)
                {
                    var drPrepayment = new DataRelation(&quot;ParentChild&quot;, dsPrepayment.Tables[1].Columns[&quot;MOHTypeID&quot;],
                                                        dsPrepayment.Tables[0].Columns[&quot;MOHTypeID&quot;]);
                    dsPrepayment.Relations.Add(drPrepayment);
                }
            }
            else
            {
                if (dtChild.Rows.Count &gt; 0)
                    dsPrepayment.Tables.Remove(dtParent);
            }

            uwgPrePayment.DisplayLayout.ViewType = ViewType.Hierarchical;
            uwgPrePayment.Bands.Clear();
            uwgPrePayment.DataSource = dtParent;
            uwgPrePayment.DataBind();

            SetHierarchicalGridProperties(dsPrepayment);
            uwgPrePayment.ExpandAll(false);

            uwgPrePayment.DisplayLayout.ColFootersVisibleDefault = ShowMarginInfo.Yes;

            //Update Prepayment Percentage...            
            Decimal TotalRecovery = 0;

            TotalRecovery = dtChild.AsEnumerable().Sum(x =&gt; x.Field&lt;Decimal&gt;(&quot;CurrentRecovery&quot;));
            wceContAdvPercentRec.Value = TotalRecovery;

            if (!isForPopUp.ToLower2().Equals(&quot;y&quot;))
            {
                uwgAdvancePayment.DataSource = dsPrepayment.Tables[2];
                uwgAdvancePayment.DataBind();
                if (uwgAdvancePayment.Columns.Exists(&quot;MOHID&quot;)) uwgAdvancePayment.Columns.FromKey(&quot;MOHID&quot;).Hidden = true;
                if (uwgAdvancePayment.Columns.Exists(&quot;PrePaymentID&quot;))
                {
                    uwgAdvancePayment.Columns.FromKey(&quot;PrePaymentID&quot;).Width = Unit.Pixel(175);
                    uwgAdvancePayment.Columns.FromKey(&quot;PrePaymentID&quot;).Header.Caption = &quot;Pre-Payment ID&quot;;
                }

                if (uwgAdvancePayment.Columns.Exists(&quot;ApprovedOn&quot;))
                {
                    uwgAdvancePayment.Columns.FromKey(&quot;ApprovedOn&quot;).Width = Unit.Pixel(155);
                    uwgAdvancePayment.Columns.FromKey(&quot;ApprovedOn&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
                    uwgAdvancePayment.Columns.FromKey(&quot;ApprovedOn&quot;).Header.Caption = &quot;Approved On&quot;;
                }

                if (uwgAdvancePayment.Columns.Exists(&quot;MOHType&quot;))
                {
                    uwgAdvancePayment.Columns.FromKey(&quot;MOHType&quot;).Width = Unit.Pixel(215);
                    uwgAdvancePayment.Columns.FromKey(&quot;MOHType&quot;).Header.Caption = &quot;Pre-Payment Type&quot;;
                }


                uwgAdvancePayment.DisplayLayout.ColFootersVisibleDefault = ShowMarginInfo.Yes;
                if (uwgAdvancePayment.Columns.Exists(&quot;Amount&quot;))
                {
                    uwgAdvancePayment.Columns.FromKey(&quot;Amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    uwgAdvancePayment.Columns.FromKey(&quot;Amount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                    uwgAdvancePayment.Columns.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                    uwgAdvancePayment.Columns.FromKey(&quot;Amount&quot;).Footer.Total = SummaryInfo.Sum;
                    uwgAdvancePayment.Columns.FromKey(&quot;Amount&quot;).Footer.Style.HorizontalAlign = HorizontalAlign.Right;
                    uwgAdvancePayment.Columns.FromKey(&quot;Amount&quot;).Width = Unit.Pixel(175);
                }
            }
        }

        private void SetHierarchicalGridProperties(DataSet sourceDataSet)
        {
            SetPrepaymentGridColumns(uwgPrePayment.Bands[0].Columns, 0);
            uwgPrePayment.Bands[0].ColHeadersVisible = ShowMarginInfo.Yes;
            uwgPrePayment.Bands[0].Indentation = 22;
            uwgPrePayment.Bands[0].IndentationType = IndentationType.Flat;
            uwgPrePayment.Bands[0].RowExpAreaStyle.Width = Unit.Pixel(0);

            if (sourceDataSet.Tables.Count &gt; 1 &amp;&amp; sourceDataSet.Tables[1].Rows.Count &gt; 0)
            {
                SetPrepaymentGridColumns(uwgPrePayment.Bands[1].Columns, 1);
                uwgPrePayment.Bands[1].SelectTypeRow = SelectType.Single;
                uwgPrePayment.Bands[1].Indentation = 3;
                uwgPrePayment.Bands[1].IndentationType = IndentationType.Flat;
                uwgPrePayment.Bands[1].RowSelectors = RowSelectors.Yes;
                uwgPrePayment.Bands[1].RowExpAreaStyle.Width = Unit.Pixel(0);
                uwgPrePayment.Bands[1].ColHeadersVisible = ShowMarginInfo.No;
                uwgPrePayment.Bands[1].ColFootersVisible = ShowMarginInfo.No;
            }
        }

        /// &lt;summary&gt;
        /// Set the Prepayment Hierarchical Grid Columns
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cols&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;contractorType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;band&quot;&gt;&lt;/param&gt;
        private void SetPrepaymentGridColumns(ColumnsCollection cols, int band)
        {
            if (cols.Exists(&quot;MOHTypeID&quot;))
                cols.FromKey(&quot;MOHTypeID&quot;).Hidden = true;

            if (cols.Exists(&quot;MOHType&quot;))
            {
                cols.FromKey(&quot;MOHType&quot;).Header.Caption = &quot;Pre-Payment Type&quot;;
                cols.FromKey(&quot;MOHType&quot;).Width = 70;
            }

            if (cols.Exists(&quot;IsIntegrationMode&quot;))
                cols.FromKey(&quot;IsIntegrationMode&quot;).Hidden = true;

            if (cols.Exists(&quot;Mode&quot;))
                cols.FromKey(&quot;Mode&quot;).Width = 80;

            if (cols.Exists(&quot;MOHID&quot;))
                cols.FromKey(&quot;MOHID&quot;).Hidden = true;

            if (cols.Exists(&quot;PrePaymentID&quot;))
            {
                cols.FromKey(&quot;PrePaymentID&quot;).Header.Caption = &quot;Pre-Payment ID&quot;;
                cols.FromKey(&quot;PrePaymentID&quot;).Width = 90;
            }

            if (cols.Exists(&quot;Description&quot;))
                cols.FromKey(&quot;Description&quot;).Width = 80;

            if (cols.Exists(&quot;Amount&quot;))
            {
                cols.FromKey(&quot;Amount&quot;).Header.Caption = LocalizedContractName + &quot; Amount Received&quot;;
                cols.FromKey(&quot;Amount&quot;).Width = 150;
                cols.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                cols.FromKey(&quot;Amount&quot;).Footer.Total = SummaryInfo.Sum;
                cols.FromKey(&quot;Amount&quot;).Footer.Style.HorizontalAlign = HorizontalAlign.Left;
            }

            if (cols.Exists(&quot;AmountRecovered&quot;))
            {
                cols.FromKey(&quot;AmountRecovered&quot;).Header.Caption = &quot;Advance Recovered Till Date&quot;;
                cols.FromKey(&quot;AmountRecovered&quot;).Width = 150;
                cols.FromKey(&quot;AmountRecovered&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                cols.FromKey(&quot;AmountRecovered&quot;).Footer.Total = SummaryInfo.Sum;
                cols.FromKey(&quot;AmountRecovered&quot;).Footer.Style.HorizontalAlign = HorizontalAlign.Left;
            }

            if (cols.Exists(&quot;AmountRemaining&quot;))
            {
                if (Mode == PageMode.View)
                {
                    cols.FromKey(&quot;AmountRemaining&quot;).Hidden = true;
                }
                else
                {
                    cols.FromKey(&quot;AmountRemaining&quot;).Hidden = false;
                    cols.FromKey(&quot;AmountRemaining&quot;).Header.Caption = &quot;Advance Remaining&quot;;
                    cols.FromKey(&quot;AmountRemaining&quot;).Width = 100;
                    cols.FromKey(&quot;AmountRemaining&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                    cols.FromKey(&quot;AmountRemaining&quot;).Footer.Total = SummaryInfo.Sum;
                    cols.FromKey(&quot;AmountRemaining&quot;).Footer.Style.HorizontalAlign = HorizontalAlign.Left;
                }
            }

            if (cols.Exists(&quot;CurrentRecovery&quot;))
            {
                cols.FromKey(&quot;CurrentRecovery&quot;).Header.Caption = &quot;Recovery in this Bill&quot;;
                cols.FromKey(&quot;CurrentRecovery&quot;).Width = 100;
                cols.FromKey(&quot;CurrentRecovery&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                cols.FromKey(&quot;CurrentRecovery&quot;).Footer.Total = SummaryInfo.Sum;
                cols.FromKey(&quot;CurrentRecovery&quot;).Footer.Style.HorizontalAlign = HorizontalAlign.Left;

                if (Mode != PageMode.View)
                {
                    cols.FromKey(&quot;CurrentRecovery&quot;).CellStyle.BackColor = Color.Yellow;
                    cols.FromKey(&quot;CurrentRecovery&quot;).AllowUpdate = AllowUpdate.Yes;
                }
            }

            if (cols.Exists(&quot;MaxRecoveryValue&quot;))
            {
                cols.FromKey(&quot;MaxRecoveryValue&quot;).Hidden = true;
                cols.FromKey(&quot;MaxRecoveryValue&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                if (cols.Exists(&quot;CurrentRecovery&quot;) &amp;&amp; Mode == PageMode.New &amp;&amp; band == 0)
                {
                    for (int j = 0; j &lt; uwgPrePayment.Rows.Count; j++)
                    {
                        UltraGridRow currentRow = uwgPrePayment.Rows[j];
                        currentRow.Style.BackColor = Color.LightGray;
                        currentRow.Cells.FromKey(&quot;CurrentRecovery&quot;).Style.BackColor = Color.Yellow;
                        currentRow.Cells.FromKey(&quot;CurrentRecovery&quot;).Value =
                            (currentRow.Cells.FromKey(&quot;AmountRemaining&quot;).Value.ToDecimal2() &lt;
                             currentRow.Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value.ToDecimal2())
                                ? currentRow.Cells.FromKey(&quot;AmountRemaining&quot;).Value.ToDecimal2()
                                : currentRow.Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value.ToDecimal2();

                        for (int k = 0; k &lt; currentRow.Rows.Count; k++)
                        {
                            UltraGridRow childRow = currentRow.Rows[k];
                            childRow.Cells.FromKey(&quot;CurrentRecovery&quot;).Value =
                                (childRow.Cells.FromKey(&quot;AmountRemaining&quot;).Value.ToDecimal2() &lt;
                                 childRow.Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value.ToDecimal2())
                                    ? childRow.Cells.FromKey(&quot;AmountRemaining&quot;).Value.ToDecimal2()
                                    : childRow.Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value.ToDecimal2();
                        }
                    }
                }
            }

            if (cols.Exists(&quot;CanBeDeleted&quot;))
                cols.FromKey(&quot;CanBeDeleted&quot;).Hidden = true;

            if (DisableModeForPrePayment)
                if (cols.Exists(&quot;Mode&quot;))
                    cols.FromKey(&quot;Mode&quot;).Hidden = true;
        }

        #region Prepayment Pop Up

        /// &lt;summary&gt;
        /// Set the Prepayment Pop Up Grid Columns
        /// &lt;/summary&gt;
        private void SetPrepaymentPopUpGridColumns()
        {
            ColumnsCollection cols = ppGrid.Columns;

            if (cols.Exists(&quot;MOHTypeID&quot;))
                cols.FromKey(&quot;MOHTypeID&quot;).Hidden = true;

            if (cols.Exists(&quot;MOHType&quot;))
                cols.FromKey(&quot;MOHType&quot;).Header.Caption = &quot;Pre-Payment Type&quot;;

            if (cols.Exists(&quot;IsIntegrationMode&quot;))
                cols.FromKey(&quot;IsIntegrationMode&quot;).Hidden = true;

            if (cols.Exists(&quot;MOHID&quot;))
                cols.FromKey(&quot;MOHID&quot;).Hidden = true;

            if (cols.Exists(&quot;PrePaymentID&quot;))
                cols.FromKey(&quot;PrePaymentID&quot;).Header.Caption = &quot;Pre-Payment ID&quot;;

            if (cols.Exists(&quot;Description&quot;))
                cols.FromKey(&quot;Description&quot;).Width = 80;

            if (cols.Exists(&quot;Amount&quot;))
            {
                cols.FromKey(&quot;Amount&quot;).Header.Caption = LocalizedContractName + &quot; Amount Received&quot;;
                cols.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                cols.FromKey(&quot;Amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Amount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            }

            if (cols.Exists(&quot;AmountRecovered&quot;))
            {
                cols.FromKey(&quot;AmountRecovered&quot;).Header.Caption = &quot;Advance Recovered Till Date&quot;;
                cols.FromKey(&quot;AmountRecovered&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                cols.FromKey(&quot;AmountRecovered&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;AmountRecovered&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            }

            if (cols.Exists(&quot;AmountRemaining&quot;))
            {
                cols.FromKey(&quot;AmountRemaining&quot;).Header.Caption = &quot;Advance Remaining&quot;;
                cols.FromKey(&quot;AmountRemaining&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                cols.FromKey(&quot;AmountRemaining&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;AmountRemaining&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            }

            if (cols.Exists(&quot;CurrentRecovery&quot;))
                cols.FromKey(&quot;CurrentRecovery&quot;).Hidden = true;

            if (cols.Exists(&quot;MaxRecoveryValue&quot;))
                cols.FromKey(&quot;MaxRecoveryValue&quot;).Hidden = true;

            if (cols.Exists(&quot;CanBeDeleted&quot;))
                cols.FromKey(&quot;CanBeDeleted&quot;).Hidden = true;

            if (DisableModeForPrePayment)
                if (cols.Exists(&quot;Mode&quot;))
                    cols.FromKey(&quot;Mode&quot;).Hidden = true;
        }

        /// &lt;summary&gt;
        /// This event is fired when the user clicks the Done button or double click on a row in Prepayment Pop Up.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnCAdd_Click(object sender, EventArgs e)
        {
            try
            {
                bool isDuplicate = false;
                bool isAdd, isParentNewlyAdded, isFirstRow = false;

                for (int i = 0; i &lt; ppGrid.Rows.Count; i++)
                {
                    isAdd = true;
                    isParentNewlyAdded = false;

                    if ((ppGrid.Rows[i].Cells.FromKey(&quot;To&quot;).Value.ToBoolean2()) ||
                        (ppGrid.Rows[i] == ppGrid.DisplayLayout.ActiveRow))
                    {
                        if (uwgPrePayment.Rows.Count == 0)
                            isFirstRow = true;

                        if (isFirstRow)
                        {
                            var childBand = new UltraGridBand(true);
                            childBand.Columns.Add(&quot;MOHTypeID&quot;);
                            childBand.Columns.Add(&quot;MOHType&quot;);
                            childBand.Columns.Add(&quot;IsIntegrationMode&quot;);
                            childBand.Columns.Add(&quot;Mode&quot;);
                            childBand.Columns.Add(&quot;MOHID&quot;);
                            childBand.Columns.Add(&quot;PrePaymentID&quot;);
                            childBand.Columns.Add(&quot;Description&quot;);
                            childBand.Columns.Add(&quot;Amount&quot;);
                            childBand.Columns.Add(&quot;AmountRecovered&quot;);
                            childBand.Columns.Add(&quot;AmountRemaining&quot;);
                            childBand.Columns.Add(&quot;CurrentRecovery&quot;);
                            childBand.Columns.Add(&quot;MaxRecoveryValue&quot;);
                            childBand.Columns.Add(&quot;CanBeDeleted&quot;);
                            uwgPrePayment.Bands.Add(childBand);

                            SetPrepaymentGridColumns(uwgPrePayment.Bands[1].Columns, 1);
                            uwgPrePayment.Bands[1].SelectTypeRow = SelectType.Single;
                            uwgPrePayment.Bands[1].Indentation = 10;
                            uwgPrePayment.Bands[1].IndentationType = IndentationType.Flat;
                            uwgPrePayment.Bands[1].RowSelectors = RowSelectors.Yes;
                            uwgPrePayment.Bands[1].RowExpAreaStyle.Width = Unit.Pixel(0);
                            uwgPrePayment.Bands[1].ColHeadersVisible = ShowMarginInfo.Yes;
                            uwgPrePayment.Bands[1].ColFootersVisible = ShowMarginInfo.No;
                        }

                        for (int j = 0; isFirstRow || j &lt; uwgPrePayment.Rows.Count; j++)
                        {
                            UltraGridRow parrentRow =
                                uwgPrePayment.Rows.OfType&lt;UltraGridRow&gt;().ToList().Find(
                                    row =&gt;
                                    (row.Cells.FromKey(&quot;MOHTypeID&quot;).Text.Equals(
                                        ppGrid.Rows[i].Cells.FromKey(&quot;MOHTypeID&quot;).Value.ToString(),
                                        StringComparison.CurrentCultureIgnoreCase)));
                            //Adding parent if it does not exists.
                            if (parrentRow == null)
                            {
                                var values = new object[13];
                                values[0] = ppGrid.Rows[i].Cells.FromKey(&quot;MOHTypeID&quot;).Value;
                                values[1] = ppGrid.Rows[i].Cells.FromKey(&quot;MOHType&quot;).Value;
                                values[2] = null;
                                values[3] = null;
                                values[4] = null;
                                values[5] = null;
                                values[6] = null;
                                values[7] = ppGrid.Rows[i].Cells.FromKey(&quot;Amount&quot;).Value;
                                values[8] = ppGrid.Rows[i].Cells.FromKey(&quot;AmountRecovered&quot;).Value;
                                values[9] = ppGrid.Rows[i].Cells.FromKey(&quot;AmountRemaining&quot;).Value;
                                values[10] = (ppGrid.Rows[i].Cells.FromKey(&quot;AmountRemaining&quot;).Value.ToDecimal2() &gt;
                                              ppGrid.Rows[i].Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value.ToDecimal2())
                                                 ? ppGrid.Rows[i].Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value
                                                 : ppGrid.Rows[i].Cells.FromKey(&quot;AmountRemaining&quot;).Value;
                                values[11] = ppGrid.Rows[i].Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value;
                                values[12] = ppGrid.Rows[i].Cells.FromKey(&quot;CanBeDeleted&quot;).Value;
                                var urg = new UltraGridRow(values);
                                uwgPrePayment.Rows.Add(urg);

                                uwgPrePayment.Rows[uwgPrePayment.Rows.Count - 1].Style.BackColor = Color.LightGray;
                                uwgPrePayment.Rows[uwgPrePayment.Rows.Count - 1].Cells.FromKey(&quot;CurrentRecovery&quot;).Style.
                                    BackColor = Color.Yellow;

                                isParentNewlyAdded = true;
                                break;
                            }

                            //Checking wheather duplicate child record exists.
                            for (int k = 0; k &lt; uwgPrePayment.Rows[j].Rows.Count; k++)
                            {
                                if (uwgPrePayment.Rows[j].Rows[k].Cells[4].Key == null)
                                    uwgPrePayment.Rows[j].Rows[k].Cells[4].Key = &quot;MOHID&quot;;
                                if (ppGrid.Rows[i].Cells.FromKey(&quot;MOHID&quot;).Value.ToInt32_2() ==
                                    uwgPrePayment.Rows[j].Rows[k].Cells.FromKey(&quot;MOHID&quot;).Value.ToInt32_2())
                                {
                                    isDuplicate = true;
                                    isAdd = false;
                                    break;
                                }
                            }
                        }
                        if (isAdd)
                        {
                            //While changing the index of the values array, please change the related index below for loop.
                            var values = new object[13];
                            values[0] = ppGrid.Rows[i].Cells.FromKey(&quot;MOHTypeID&quot;).Value;
                            values[1] = ppGrid.Rows[i].Cells.FromKey(&quot;MOHType&quot;).Value;
                            values[2] = ppGrid.Rows[i].Cells.FromKey(&quot;IsIntegrationMode&quot;).Value;
                            values[3] = ppGrid.Rows[i].Cells.FromKey(&quot;Mode&quot;).Value;
                            values[4] = ppGrid.Rows[i].Cells.FromKey(&quot;MOHID&quot;).Value;
                            values[5] = ppGrid.Rows[i].Cells.FromKey(&quot;PrePaymentID&quot;).Value;
                            values[6] = ppGrid.Rows[i].Cells.FromKey(&quot;Description&quot;).Value;
                            values[7] = ppGrid.Rows[i].Cells.FromKey(&quot;Amount&quot;).Value;
                            values[8] = ppGrid.Rows[i].Cells.FromKey(&quot;AmountRecovered&quot;).Value;
                            values[9] = ppGrid.Rows[i].Cells.FromKey(&quot;AmountRemaining&quot;).Value;
                            values[10] = (ppGrid.Rows[i].Cells.FromKey(&quot;AmountRemaining&quot;).Value.ToDecimal2() &gt;
                                          ppGrid.Rows[i].Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value.ToDecimal2())
                                             ? ppGrid.Rows[i].Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value
                                             : ppGrid.Rows[i].Cells.FromKey(&quot;AmountRemaining&quot;).Value;
                            values[11] = ppGrid.Rows[i].Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value;
                            values[12] = ppGrid.Rows[i].Cells.FromKey(&quot;CanBeDeleted&quot;).Value;
                            var urg = new UltraGridRow(values);

                            for (int l = 0; l &lt; uwgPrePayment.Rows.Count; l++)
                            {
                                //Adding the child row under respective parent row.
                                if (
                                    uwgPrePayment.Rows[l].Cells.FromKey(&quot;MOHTypeID&quot;).Value.ToString().Equals(
                                        values[0].ToString()))
                                {
                                    uwgPrePayment.Rows[l].Rows.Add(urg);

                                    isFirstRow = false;

                                    //Updating the parent values after adding the child record if the parent record is not newly created.
                                    if (!isParentNewlyAdded)
                                    {
                                        uwgPrePayment.Rows[l].Cells.FromKey(&quot;Amount&quot;).Value =
                                            uwgPrePayment.Rows[l].Cells.FromKey(&quot;Amount&quot;).Value.ToDecimal2() +
                                            values[7].ToDecimal2();
                                        uwgPrePayment.Rows[l].Cells.FromKey(&quot;AmountRecovered&quot;).Value =
                                            uwgPrePayment.Rows[l].Cells.FromKey(&quot;AmountRecovered&quot;).Value.ToDecimal2() +
                                            values[8].ToDecimal2();
                                        uwgPrePayment.Rows[l].Cells.FromKey(&quot;AmountRemaining&quot;).Value =
                                            uwgPrePayment.Rows[l].Cells.FromKey(&quot;AmountRemaining&quot;).Value.ToDecimal2() +
                                            values[9].ToDecimal2();
                                        uwgPrePayment.Rows[l].Cells.FromKey(&quot;CurrentRecovery&quot;).Value =
                                            uwgPrePayment.Rows[l].Cells.FromKey(&quot;CurrentRecovery&quot;).Value.ToDecimal2() +
                                            values[10].ToDecimal2();
                                        uwgPrePayment.Rows[l].Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value =
                                            uwgPrePayment.Rows[l].Cells.FromKey(&quot;MaxRecoveryValue&quot;).Value.ToDecimal2() +
                                            values[11].ToDecimal2();
                                    }
                                    break;
                                }
                            }
                        }
                        ppGrid.Rows[i].Cells.FromKey(&quot;To&quot;).Value = false;
                    }
                }

                ScriptManager.RegisterStartupScript(updPnlFormValidate, typeof(Page), &quot;ADD_FORM&quot;,
                                                    &quot;AttachEventHandlerToControl(&#39;&quot; + btnCancel.ClientID +
                                                    &quot;&#39;, &#39;Button&#39;);&quot;, true);

                if (isDuplicate)
                    throw new Exception(&quot;Duplicate Pre-payments are not added.&quot;);
            }
            catch (Exception ex)
            {
                base.ShowError(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;));
            }
        }

        #endregion

        #endregion

        #region Adjustment Picker Handlers / Functions

        protected void btnCancelAdjustmentPicker_Click(object sender, EventArgs e)
        {
            ShowDiv(MIDivEnums.CreatePE);
        }

        private void genericAdjustmentPicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            if (!String.IsNullOrEmpty(hdnAdjustmentType.Value))
            {
                UltraWebGrid currUWG = (Int32.Parse(hdnAdjustmentType.Value) == 1) ? uwgRABAdditions : uwgRABDeductions;
                AddAdjustmentsToGrid(currUWG, e.SelectedItems.Select());
                e.SelectedItems.Clear();

                FormatAdjustmentsGrid(currUWG);

                UpdateAdjustmentsTotal();
            }

            ShowDiv(MIDivEnums.CreatePE);
        }

        private void genericAdjustmentPicker_BindData(string Filter, string SortOrder, out DataSet DsResult,
                                                      ref int CurrentPage, int PageSize, out int PageCount)
        {
            DataTable dtAdjustments =
                BL.Instance.GetAdjustmentMasterList(Session[Constants.EIS_ADDITIONAL_INFO].ToString(),
                                                    (String.IsNullOrEmpty(hdnAdjustmentType.Value)
                                                         ? (int?)null
                                                         : Int32.Parse(hdnAdjustmentType.Value)));
            //To add amount column - Connector does not return Amount Column.
            if (!dtAdjustments.Columns.Contains(&quot;Amount&quot;))
            {
                dtAdjustments.Columns.Add(&quot;Amount&quot;, typeof(Double));
                foreach (DataRow drAdjustment in dtAdjustments.Rows)
                    drAdjustment[&quot;Amount&quot;] = (double)0;
            }

            PageCount = (int)Math.Ceiling(dtAdjustments.Rows.Count.ToDouble2() / PageSize.ToDouble2());
            DsResult = dtAdjustments.DataSet;
        }

        protected void btnAddAdditions_Click(object sender, EventArgs e)
        {
            PageTitle = LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; Addition&quot;;
            hdnAdjustmentType.Value = &quot;1&quot;;
            ShowDiv(MIDivEnums.AdjustmentPicker);
            genericAdjustmentPicker.ChangeTableOrViewAndBind(null);
        }

        protected void btnAddDeductions_Click(object sender, EventArgs e)
        {
            PageTitle = LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; Deduction&quot;;
            hdnAdjustmentType.Value = &quot;2&quot;;
            ShowDiv(MIDivEnums.AdjustmentPicker);
            genericAdjustmentPicker.ChangeTableOrViewAndBind(null);
        }

        #endregion

        #region Material Deduction Picker Handlers / Functions

        protected BrixFilter[] SetItemMBookFilters()
        {
            var filters = new BrixFilter[4];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;MBook ID :&quot;;
            filters[0].Name = &quot;MBookID&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Line No :&quot;;
            filters[1].Name = &quot;LineNo&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].Title = &quot;Name :&quot;;
            filters[2].Name = &quot;StandardItemNo&quot;;
            filters[2].FilterType = BrixFilter.Type.Text;

            filters[3] = new BrixFilter();
            filters[3].Title = &quot;Description :&quot;;
            filters[3].Name = &quot;Description&quot;;
            filters[3].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        protected BrixFilter[] SetActivityMBookFilters()
        {
            var filters = new BrixFilter[4];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;MBook ID :&quot;;
            filters[0].Name = &quot;MBookID&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Line No :&quot;;
            filters[1].Name = &quot;LineNo&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].Title = &quot;Activity Name :&quot;;
            filters[2].Name = &quot;ActivityName&quot;;
            filters[2].FilterType = BrixFilter.Type.Text;

            filters[3] = new BrixFilter();
            filters[3].Title = &quot;Activity Description :&quot;;
            filters[3].Name = &quot;ActivityDescription&quot;;
            filters[3].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        protected void btnCancelMIPicker_Click(object sender, EventArgs e)
        {
            ShowDiv(MIDivEnums.CreatePE);
        }

        private void genericMIPicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            AddMaterialDeductionsToGrid(e.SelectedItems);

            FormatMaterialDeductionsGrid();

            UpdateMaterialDeductionTotal();

            ShowDiv(MIDivEnums.CreatePE);
        }

        private void genericMIPicker_BindData(string Filter, string SortOrder, out DataSet DsResult, ref int CurrentPage,
                                              int PageSize, out int PageCount)
        {
            #region Getting Contractor and Contractor Type strings

            string Contractor = (ddlContractor.SelectedItem.Text != &quot;--Select One--&quot;)
                                    ? ddlContractor.SelectedValue
                                    : null;
            int? ContractorID = null;
            string ContractorType = null;

            if (!String.IsNullOrEmpty(Contractor))
            {
                string[] strContr = Contractor.Split(&#39;,&#39;);

                ContractorID = strContr[0].ToInt32_2();
                ContractorType = strContr[1];
            }

            #endregion

            #region Fetching the list of applicable Material Issues of all Types

            DataTable dtMaterialDeductions = BL.Instance.GetPEMIDetails(contractID, null, null, ContractorID,
                                                                        ContractorType,
                                                                        (String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                                             ? (int?)null
                                                                             : int.Parse(Request[&quot;WOID&quot;])), &quot;Y&quot;);

            #endregion

            PageCount = (int)Math.Ceiling(dtMaterialDeductions.Rows.Count.ToDouble2() / PageSize.ToDouble2());
            DsResult = dtMaterialDeductions.DataSet;
        }

        protected void btnAddMaterialDeductions_Click(object sender, EventArgs e)
        {
            PageTitle = &quot;Select Material Issue&quot;;
            ShowDiv(MIDivEnums.MIPicker);
        }

        #endregion

        #region Measurement Book Picker Handlers / Functions

        protected void itemsGrid_InitializeRow(object sender, RowEventArgs e)
        {
            if (!String.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp; int.Parse(Request[&quot;WOID&quot;]) != 0)
            {
                if (hdnItemPostings.Value.Equals(&quot;1&quot;))
                {
                    if (e.Row.Cells.Exists(&quot;IsPartRate&quot;))
                    {
                        e.Row.Cells.FromKey(&quot;IsPartRate&quot;).Style.BackgroundImage =
                            (e.Row.Cells.FromKey(&quot;IsPartRate&quot;).Value.ToString2().Equals(&quot;1&quot;) ||
                             e.Row.Cells.FromKey(&quot;IsPartRate&quot;).Value.ToString2().Equals(&quot;True&quot;))
                                ? &quot;../../Images/PartRate.png&quot;
                                : &quot;../../Images/FullRate.png&quot;;
                        e.Row.Cells.FromKey(&quot;IsPartRate&quot;).Style.Padding.Left = new Unit(&quot;16px&quot;,
                                                                                        CultureInfo.CurrentCulture);
                        e.Row.Cells.FromKey(&quot;IsPartRate&quot;).Style.CustomRules =
                            &quot;background-repeat: no-repeat;background-position: center center&quot;;
                        e.Row.Cells.FromKey(&quot;IsPartRate&quot;).Style.Font.Size = FontUnit.Point(0);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// MBook Picker binding event
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Filter&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;SortOrder&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;DsResult&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;CurrentPage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;PageSize&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;PageCount&quot;&gt;&lt;/param&gt;
        protected void genericMBookPicker_BindData(string filter, string sortOrder, out DataSet dsResult,
                                                   ref int currentPage, int pageSize, out int pageCount)
        {
            try
            {
                DataTable dtMBookDetails = new BrixDataTable();
                if (!String.IsNullOrEmpty(filter) &amp;&amp; DTMBooks != null &amp;&amp; DTMBooks.Rows.Count &gt; 0)
                {
                    var filterXml = new XmlDocument();
                    filterXml.LoadXml(filter);
                    string strFilter = string.Empty;

                    if (filterXml.DocumentElement.SelectSingleNode(&quot;MBookID&quot;) != null)
                        strFilter = &quot;MBookID = &quot; + filterXml.DocumentElement.SelectSingleNode(&quot;MBookID&quot;).InnerText.ToString2();

                    if (filterXml.DocumentElement.SelectSingleNode(&quot;LineNo&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) +
                                    &quot;LineNo = &quot; + filterXml.DocumentElement.SelectSingleNode(&quot;LineNo&quot;).InnerText.ToString2();

                    if (WorkOrderType == &quot;W&quot; &amp;&amp; filterXml.DocumentElement.SelectSingleNode(&quot;StandardItemNo&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) + &quot;StandardItemNo like &#39;%&quot;
                                    + filterXml.DocumentElement.SelectSingleNode(&quot;StandardItemNo&quot;).InnerText.ToString2() + &quot;%&#39;&quot;;
                    else if (WorkOrderType == &quot;A&quot; &amp;&amp; filterXml.DocumentElement.SelectSingleNode(&quot;ActivityName&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) + &quot;ActivityName like &#39;%&quot;
                                    + filterXml.DocumentElement.SelectSingleNode(&quot;ActivityName&quot;).InnerText.ToString2() + &quot;%&#39;&quot;;

                    if (WorkOrderType == &quot;W&quot; &amp;&amp; filterXml.DocumentElement.SelectSingleNode(&quot;Description&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) + &quot;Description like &#39;%&quot;
                                    + filterXml.DocumentElement.SelectSingleNode(&quot;Description&quot;).InnerText.ToString2() + &quot;%&#39;&quot;;
                    else if (WorkOrderType == &quot;A&quot; &amp;&amp; filterXml.DocumentElement.SelectSingleNode(&quot;ActivityDescription&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) + &quot;ActivityDescription like &#39;%&quot;
                                    + filterXml.DocumentElement.SelectSingleNode(&quot;ActivityDescription&quot;).InnerText.ToString2() + &quot;%&#39;&quot;;

                    dtMBookDetails = DTMBooks.Copy().Select(strFilter).CopyToDataTable();
                }
                else if (DTMBooks != null)
                    dtMBookDetails = DTMBooks.Copy();
                dsResult = new DataSet();
                dsResult.Tables.Add(dtMBookDetails);
                pageCount = (int)Math.Ceiling(((DTMBooks == null) ? 0 : DTMBooks.Rows.Count.ToDouble2()) / pageSize.ToDouble2());

            }
            catch (Exception)
            {
                dsResult = null;
                pageCount = 0;
                return;
            }
        }

        /// &lt;summary&gt;
        /// Event that fires when cancel button is clicked in MBook picker
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnCancelMbookPicer_Click(object sender, EventArgs e)
        {
            ShowDiv(MIDivEnums.CreatePE);
        }

        /// &lt;summary&gt;
        /// Event that fires when done is clicked in MBookpicker
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void genericMbookPicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            AddMBookDetailsToGrid(e.SelectedItems);
            HoldReleaseCalculation(txtItemTotal.Value.ToDecimal2());
        }

        /// &lt;summary&gt;
        /// Displays the MBook Picker
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnMBPickerAdd_Click(object sender, EventArgs e)
        {
            PageTitle = &quot;Select &quot; + LocalizationManager.GetString(&quot;LOC_MeasurementBook&quot;) + &quot;s&quot;;
            ShowDiv(MIDivEnums.MBPicker);
            FillMBooksTable();
            ScriptManager.RegisterStartupScript(this, GetType(), &quot;selectall&quot;, &quot;$(document).ready(function () { SelAllInPicker(&#39;&quot; + (genericMBookPicker.FindControl(&quot;GridMain&quot;) as UltraWebGrid).ClientID + &quot;&#39;);});&quot;, true);
            //HoldReleaseCalculation(txtItemTotal.Value.ToDecimal2());
        }

        /// &lt;summary&gt;
        /// Updates the MBook quantites and Opens the popup details
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnMBViewDetails_Click(object sender, EventArgs e)
        {
            UltraGridRow ugrSelRow = null;
            int selectedCount = 0;//For validating multiple selections
            foreach (UltraGridRow row in itemsGrid.Rows)
            {
                if (row.Cells.FromKey(&quot;To&quot;).Value.ToString().Equals(&quot;true&quot;))
                {
                    selectedCount++;
                    ugrSelRow = row;
                    if (selectedCount &gt; 1)
                        break;
                }
            }
            if (selectedCount == 0)//If none of the record chkbox is selected
                ugrSelRow = itemsGrid.DisplayLayout.ActiveRow;
            if (ugrSelRow != null &amp;&amp; selectedCount &lt;= 1)
            {
                SplitCerifiedQtyAcrossMBooks(ugrSelRow);
                string mBookDetails = ugrSelRow.Cells.FromKey(&quot;MBookList&quot;).Value.ToString2();
                if (ugrSelRow.Cells.FromKey(&quot;MaxAvailQty&quot;) != null)
                    lblMaxAvail.Text = ugrSelRow.Cells.FromKey(&quot;MaxAvailQty&quot;).Value.ToString2();
                //Disabling save for part rated items
                btnMBSave.Enabled = (ugrSelRow.Cells.FromKey(&quot;ParentID&quot;).Value.ToString2().Equals(&quot;0&quot;));
                var sr = new StringReader(mBookDetails);
                var ds = new DataSet();
                ds.ReadXml(sr);
                decimal totBQty = 0;
                DataTable dt =
                    ds.Tables[&quot;MBook&quot;].Select(&quot;ParentID=&quot; + ugrSelRow.Cells.FromKey(&quot;ParentID&quot;).Value.ToString2()).
                        CopyToDataTable();
                foreach (DataRow rw in dt.Rows)
                //ds.Tables[0].Select(&quot;ParentID=&quot;+ugrSelRow.Cells.FromKey(&quot;ParentID&quot;).Value.ToString2()))
                {
                    totBQty += rw[&quot;BillingQty&quot;].ToDecimal2();
                }
                lblTotBQty.Text = totBQty.ToString2();
                gridMBooks.DataSource = dt;
                gridMBooks.DataBind();

                if (gridMBooks.Columns.Exists(&quot;ID&quot;))
                {
                    gridMBooks.Columns.FromKey(&quot;ID&quot;).Hidden = true;
                }

                if (gridMBooks.Columns.Exists(&quot;MBookNo&quot;))
                {
                    gridMBooks.Columns.FromKey(&quot;MBookNo&quot;).Header.Caption = &quot;MBook No&quot;;
                }

                if (gridMBooks.Columns.Exists(&quot;BillingQty&quot;))
                {
                    gridMBooks.Columns.FromKey(&quot;BillingQty&quot;).AllowUpdate = AllowUpdate.Yes;
                    gridMBooks.Columns.FromKey(&quot;BillingQty&quot;).Header.Caption = &quot;Billing Qty&quot;;
                    gridMBooks.Columns.FromKey(&quot;BillingQty&quot;).CellStyle.BackColor = Color.Yellow;
                    gridMBooks.Columns.FromKey(&quot;BillingQty&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    gridMBooks.Columns.FromKey(&quot;BillingQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;

                    if (Mode == PageMode.View || !(ugrSelRow.Cells.FromKey(&quot;ParentID&quot;).Value.ToString2().Equals(&quot;0&quot;)))
                    {
                        gridMBooks.Columns.FromKey(&quot;BillingQty&quot;).AllowUpdate = AllowUpdate.No;
                        gridMBooks.Columns.FromKey(&quot;BillingQty&quot;).CellStyle.BackColor = Color.White;
                    }
                }

                if (gridMBooks.Columns.Exists(&quot;MBookQty&quot;))
                {
                    gridMBooks.Columns.FromKey(&quot;MBookQty&quot;).Header.Caption = &quot;Certified Qty&quot;;
                    gridMBooks.Columns.FromKey(&quot;MBookQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                    gridMBooks.Columns.FromKey(&quot;MBookQty&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                }

                if (gridMBooks.Columns.Exists(&quot;CertifiedQty&quot;))
                {
                    gridMBooks.Columns.FromKey(&quot;CertifiedQty&quot;).Hidden = true;
                }
                if (gridMBooks.Columns.Exists(&quot;ParentID&quot;))
                {
                    gridMBooks.Columns.FromKey(&quot;ParentID&quot;).Hidden = true;
                }
                hdnMBDetails.Value = &quot;1&quot;;
            }
            else
                base.ShowError(&quot;Select a single record to view&quot;);
        }

        /// &lt;summary&gt;
        /// Deletes selected items from the items grid
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnMBDeleteItem_Click(object sender, EventArgs e)
        {
            var rowsSel = new List&lt;UltraGridRow&gt;();
            foreach (UltraGridRow row in itemsGrid.Rows)
            {
                if (row.Cells.FromKey(&quot;To&quot;).Value.ToString().Equals(&quot;true&quot;))
                    rowsSel.Add(row);
            }
            if (rowsSel.Count &gt; 0)
            {
                foreach (UltraGridRow row in rowsSel)
                    itemsGrid.Rows.Remove(row);
            }
            else
            {
                UltraGridRow ugrSelRow = itemsGrid.DisplayLayout.ActiveRow;

                if (ugrSelRow != null)
                {
                    itemsGrid.DisplayLayout.ActiveRow.Delete();
                }
                else
                {
                    base.ShowError(&quot;Select a record to delete&quot;);
                    return;
                }
            }
            decimal sumTotal = 0;
            foreach (UltraGridRow ugr in itemsGrid.Rows)
            {
                sumTotal += ugr.Cells.FromKey(&quot;Amount&quot;).Value.ToDecimal2();
            }
            //ViewState[viewStateTotal] = sumTotal;
            txtItemTotal.Value = sumTotal.ToString2();
            totAmt.Text = &quot;Total : &quot; + sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
            txtItemTotal.Value = sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);

            //HoldReleaseCalculation(txtItemTotal.Value.ToDecimal2());
            //}
            //else
            //    Page.ClientScript.RegisterStartupScript(this.GetType(), &quot;showAlert&quot;, &quot;alert(&#39;Select a record to delete&#39;)&quot;);
        }

        /// &lt;summary&gt;
        /// Event that fires when save button is clicked on popup
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnMBSave_Click(object sender, EventArgs e)
        {
            #region creating new XML with the updated values

            var ds = new DataSet();
            //Dataset is used to get the parent root name as Item. Eg. &lt;Item&gt;&lt;MBook&gt;..&lt;/MBook&gt;..&lt;/Item&gt;
            ds.DataSetName = &quot;Item&quot;;
            var dtModifiedMBooks = new DataTable();
            dtModifiedMBooks.TableName = &quot;MBook&quot;;
            dtModifiedMBooks.Columns.Add(&quot;ID&quot;);
            dtModifiedMBooks.Columns.Add(&quot;MBookNo&quot;);
            dtModifiedMBooks.Columns.Add(&quot;MBookQty&quot;);
            dtModifiedMBooks.Columns.Add(&quot;BillingQty&quot;, Type.GetType(&quot;System.Double&quot;));
            dtModifiedMBooks.Columns.Add(&quot;CertifiedQty&quot;, Type.GetType(&quot;System.Double&quot;));
            dtModifiedMBooks.Columns.Add(&quot;ParentID&quot;);
            UltraGridRowsEnumerator enParentRow = gridMBooks.Bands[0].GetRowsEnumerator();
            DataRow dr = null;
            CellsCollection cells;
            while (enParentRow.MoveNext())
            {
                cells = enParentRow.Current.Cells;
                dr = dtModifiedMBooks.NewRow();
                dr[&quot;ID&quot;] = cells.FromKey(&quot;ID&quot;).Text;
                dr[&quot;MBookNo&quot;] = cells.FromKey(&quot;MBookNo&quot;).Text;
                dr[&quot;MBookQty&quot;] = cells.FromKey(&quot;MBookQty&quot;).Text.ToDecimal2();
                dr[&quot;BillingQty&quot;] = cells.FromKey(&quot;BillingQty&quot;).Text.ToDecimal2();
                dr[&quot;CertifiedQty&quot;] = cells.FromKey(&quot;CertifiedQty&quot;).Text.ToDecimal2();
                dr[&quot;ParentID&quot;] = cells.FromKey(&quot;ParentID&quot;).Text;
                dtModifiedMBooks.Rows.Add(dr);
            }
            ds.Tables.Add(dtModifiedMBooks);
            string newXml = ToStringAsXml(ds.Tables[0]);

            #endregion

            #region Updating Items grid

            //Updatin Items grid with the new values

            //Actual total before updating
            decimal actTotal =
                totAmt.Text.Substring(totAmt.Text.IndexOf(&#39;:&#39;) + 2, totAmt.Text.Length - (totAmt.Text.IndexOf(&#39;:&#39;) + 2))
                    .ToDecimal2();
            actTotal = txtItemTotal.Value.ToDecimal2();
            //Acutal Qty before updating
            decimal billingQty = itemsGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;BillingQty&quot;).Text.ToDecimal2();
            decimal amt = billingQty * itemsGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;BillingRate&quot;).Text.ToDecimal2();
            actTotal = actTotal - amt; //Subtracting the Item total from the grand total
            //New Billing Qty
            billingQty = dtModifiedMBooks.Compute(&quot;sum(BillingQty)&quot;, string.Empty).ToDecimal2();
            //New Item total 
            amt = amt = billingQty * itemsGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;BillingRate&quot;).Text.ToDecimal2();
            //New grand total
            actTotal = actTotal + amt;
            //Updating the Item grid
            itemsGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;MBookList&quot;).Text = newXml;
            itemsGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;BillingQty&quot;).Text = billingQty.ToString2();
            itemsGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;CertifiedQty&quot;).Text = billingQty.ToString2();
            itemsGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;Amount&quot;).Text = amt.ToString2();

            //Updating the grand total
            totAmt.Text = &quot;Total : &quot; + actTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
            txtItemTotal.Value = actTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);

            #endregion

            hdnMBDetails.Value = &quot;0&quot;;
        }

        /// &lt;summary&gt;
        /// Used to Bind MBook Picker
        /// &lt;/summary&gt;
        private void FillMBooksTable()
        {
            string filterText =
                &quot;&lt;XMLRoot&gt;&lt;PostedFromDt&gt;{0}&lt;/PostedFromDt&gt;&lt;PostedToDt&gt;{1}&lt;/PostedToDt&gt;&lt;Status&gt;{2}&lt;/Status&gt;&lt;PEID&gt;{3}&lt;/PEID&gt;&lt;WOType&gt;{4}&lt;/WOType&gt;&lt;/XMLRoot&gt;&quot;
                    .Format2(
                        (dtFromDt.Value.ToDateTime_MWCulture().ToString(&quot;MM/dd/yyyy&quot;, CultureInfo.CurrentCulture) +
                         &quot; 12:00:00 AM&quot;),
                        dtToDt.Value.ToDateTime_MWCulture().ToString(&quot;MM/dd/yyyy&quot;, CultureInfo.CurrentCulture) + &quot; 23:59:59 PM&quot;,
                        &quot;2&quot;, (String.IsNullOrEmpty(Request[&quot;PEID&quot;])) ? 0 : int.Parse(Request[&quot;PEID&quot;]), WorkOrderType);
            DTMBooks =
                BL.Instance.GetPEMBookDetails((String.IsNullOrEmpty(Request[&quot;WOID&quot;])) ? 0 : int.Parse(Request[&quot;WOID&quot;]),
                                              filterText);
            genericMBookPicker.ChangeTableOrViewAndBind(string.Empty);
        }

        /// &lt;summary&gt;
        /// This method is called when done clicked in MBook picker to bind 
        /// selected MBooks to Item Grid
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dtMBooks&quot;&gt;&lt;/param&gt;
        private void AddMBookDetailsToGrid(DataTable dtMBooks)
        {
            dtMBooks.TableName = &quot;MBooks&quot;;
            string xmlSelectedMBooks = ToStringAsXml(dtMBooks);

            string[] xmlExistingList = GetPEItemsFromGrid();
            string xmlExistingMBooks = xmlExistingList[0];
            string xmlExistingPRMBooks = xmlExistingList[1];
            xmlExistingMBooks = xmlExistingMBooks.Replace(&quot;&amp;gt;&quot;, &quot;&gt;&quot;).Replace(&quot;&amp;lt;&quot;, &quot;&lt;&quot;);
            xmlExistingPRMBooks = xmlExistingPRMBooks.Replace(&quot;&amp;gt;&quot;, &quot;&gt;&quot;).Replace(&quot;&amp;lt;&quot;, &quot;&lt;&quot;);

            int wOId = (!String.IsNullOrEmpty(Request[&quot;WOID&quot;])) ? Request[&quot;WOID&quot;].ToInt32_2() : 0;
            int peId = (!String.IsNullOrEmpty(Request[&quot;PEID&quot;])) ? (Request[&quot;PEID&quot;].ToInt32_2()) : 0;

            DataSet dsMBookDetails;
            if (!WorkOrderType.Equals(&quot;A&quot;))
                dsMBookDetails = BL.Instance.GetSelectedMBookDetails(wOId, peId, xmlSelectedMBooks, xmlExistingMBooks,
                                                                     xmlExistingPRMBooks);
            else
                dsMBookDetails =
                    BL.Instance.GetSelectedACTIWOMBookDetails(wOId, peId, xmlSelectedMBooks, xmlExistingMBooks,
                                                              xmlExistingPRMBooks).DataSet;
            BindAndFormatMBookDetails(dsMBookDetails.Tables[0]);

            if (dsMBookDetails.Tables[1] != null &amp;&amp; dsMBookDetails.Tables[1].Rows.Count &gt; 0)
            {
                DataTable dtRemoved = (dsMBookDetails.Tables[1].Select(&quot;AllowedQty = 0&quot;).Length &gt; 0)
                                          ? dsMBookDetails.Tables[1].Select(&quot;AllowedQty = 0&quot;).CopyToDataTable()
                                          : null;
                if (dtRemoved != null &amp;&amp; dtRemoved.Rows.Count &gt; 0)
                {
                    lblMBooksNotAdded.Text =
                        &quot;Total billed qty will be greater than WO Qtuantity. Hence the following MBooks can not be added&quot;;
                    uwgMBNotAdded.DataSource = dtRemoved;
                    uwgMBNotAdded.DataBind();
                    trMBNotAdded.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                    //uwgMBNotAdded.Style[&quot;display&quot;] = &quot;block&quot;;

                    if (uwgMBNotAdded.Columns.Exists(&quot;MBookID&quot;))
                        uwgMBNotAdded.Columns.FromKey(&quot;MBookID&quot;).Hidden = true;
                    if (uwgMBNotAdded.Columns.Exists(&quot;ActivityID&quot;))
                        uwgMBNotAdded.Columns.FromKey(&quot;ActivityID&quot;).Hidden = true;
                    if (uwgMBNotAdded.Columns.Exists(&quot;SubItemID&quot;))
                        uwgMBNotAdded.Columns.FromKey(&quot;SubItemID&quot;).Hidden = true;
                    if (uwgMBNotAdded.Columns.Exists(&quot;ItemID&quot;))
                        uwgMBNotAdded.Columns.FromKey(&quot;ItemID&quot;).Hidden = true;
                    if (uwgMBModified.Columns.Exists(&quot;RequestedQty&quot;))
                        uwgMBModified.Columns.FromKey(&quot;RequestedQty&quot;).Header.Caption = &quot;Requested Billing Qty&quot;;
                    if (uwgMBModified.Columns.Exists(&quot;AllowedQty&quot;))
                        uwgMBModified.Columns.FromKey(&quot;AllowedQty&quot;).Header.Caption = &quot;Allowed Billing Qty&quot;;
                }
                else
                {
                    trMBNotAdded.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                    //uwgMBNotAdded.Style[&quot;display&quot;] = &quot;none&quot;;
                    lblMBooksNotAdded.Text = string.Empty;
                }

                DataTable dtModified = (dsMBookDetails.Tables[1].Select(&quot;AllowedQty &lt;&gt; 0&quot;).Length &gt; 0)
                                           ? dsMBookDetails.Tables[1].Select(&quot;AllowedQty &lt;&gt; 0&quot;).CopyToDataTable()
                                           : null;
                if (dtModified != null &amp;&amp; dtModified.Rows.Count &gt; 0)
                {
                    lblMBooksMod.Text =
                        &quot;Total billed qty will be greater than WO Qtuantity. Hence the following MBooks are trimmed&quot;;
                    uwgMBModified.DataSource = dtModified;
                    uwgMBModified.DataBind();
                    trMBModified.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                    //uwgMBModified.Style[&quot;display&quot;] = &quot;block&quot;;

                    if (uwgMBModified.Columns.Exists(&quot;MBookID&quot;))
                        uwgMBModified.Columns.FromKey(&quot;MBookID&quot;).Hidden = true;
                    if (uwgMBModified.Columns.Exists(&quot;ActivityID&quot;))
                        uwgMBModified.Columns.FromKey(&quot;ActivityID&quot;).Hidden = true;
                    if (uwgMBModified.Columns.Exists(&quot;SubItemID&quot;))
                        uwgMBModified.Columns.FromKey(&quot;SubItemID&quot;).Hidden = true;
                    if (uwgMBModified.Columns.Exists(&quot;ItemID&quot;))
                        uwgMBModified.Columns.FromKey(&quot;ItemID&quot;).Hidden = true;
                    if (uwgMBModified.Columns.Exists(&quot;RequestedQty&quot;))
                        uwgMBModified.Columns.FromKey(&quot;RequestedQty&quot;).Header.Caption = &quot;Requested Billing Qty&quot;;
                    if (uwgMBModified.Columns.Exists(&quot;AllowedQty&quot;))
                        uwgMBModified.Columns.FromKey(&quot;AllowedQty&quot;).Header.Caption = &quot;Allowed Billing Qty&quot;;
                }
                else
                {
                    trMBModified.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                    //uwgMBModified.Style[&quot;display&quot;] = &quot;none&quot;;
                    lblMBooksMod.Text = string.Empty;
                }
                hdnMBMessage.Value = &quot;1&quot;;
            }

            ShowDiv(MIDivEnums.CreatePE);
            if (itemsGrid.Rows.Count &gt; 0)
            {
                divItems.Style[&quot;display&quot;] = &quot;block&quot;;
                lblNoRows.Visible = false;
                txtItemTotal.Visible = true;
            }
        }

        /// &lt;summary&gt;
        /// Converts Grid to datatable and to XML
        /// &lt;/summary&gt;
        /// &lt;returns&gt;String in XML format&lt;/returns&gt;
        private string[] GetPEItemsFromGrid()
        {
            var dtExistingItems = new DataTable();
            dtExistingItems.TableName = &quot;ExistingItems&quot;;
            dtExistingItems = CreateMBookSchema(dtExistingItems);

            var dtExistingPRItems = new DataTable();
            dtExistingPRItems.TableName = &quot;ExistingPRItems&quot;;
            dtExistingPRItems = CreateMBookSchema(dtExistingPRItems);

            if (itemsGrid.Rows.Count == 0)
                BindAndFormatMBookDetails(new DataTable());

            UltraGridRowsEnumerator enParentRow = itemsGrid.Bands[0].GetRowsEnumerator();
            DataRow dr = null;
            CellsCollection cells;
            while (enParentRow.MoveNext())
            {
                cells = enParentRow.Current.Cells;

                //dr = (cells.FromKey(&quot;IsPartRate&quot;).Text.Equals(&quot;0&quot;)) ? dtExistingItems.NewRow() : dtExistingPRItems.NewRow();
                dr = (cells.FromKey(&quot;ParentID&quot;).Text.Equals(&quot;0&quot;))
                         ? dtExistingItems.NewRow()
                         : dtExistingPRItems.NewRow();

                dr[&quot;Work Order No&quot;] = cells.FromKey(&quot;Work Order No&quot;).Text;
                dr[&quot;MBookList&quot;] = cells.FromKey(&quot;MBookList&quot;).Text;

                if (!WorkOrderType.Equals(&quot;A&quot;)) //For BOQ Based Workorder
                {
                    dr[&quot;ItemID&quot;] = cells.FromKey(&quot;ItemID&quot;).Text;
                    dr[&quot;LineNo&quot;] = cells.FromKey(&quot;LineNo&quot;).Text;
                    dr[&quot;StandardItemNo&quot;] = cells.FromKey(&quot;StandardItemNo&quot;).Text;
                }
                else //For Activity Based workorder
                {
                    dr[&quot;ActivityID&quot;] = cells.FromKey(&quot;ActivityID&quot;).Text;
                    dr[&quot;ActivityName&quot;] = cells.FromKey(&quot;ActivityName&quot;).Text;
                    dr[&quot;SubItem&quot;] = cells.FromKey(&quot;SubItem&quot;).Text;
                }

                dr[&quot;Description&quot;] = cells.FromKey(&quot;Description&quot;).Text;
                dr[&quot;UnitPrice&quot;] = cells.FromKey(&quot;UnitPrice&quot;).Text;
                dr[&quot;MaxAllowedPrice&quot;] = cells.FromKey(&quot;MaxAllowedPrice&quot;).Text;
                dr[&quot;MBookQuantity&quot;] = cells.FromKey(&quot;MBookQuantity&quot;).Text;
                dr[&quot;BillingQty&quot;] = cells.FromKey(&quot;BillingQty&quot;).Text;
                dr[&quot;BillingRate&quot;] = cells.FromKey(&quot;BillingRate&quot;).Text;
                dr[&quot;CertifiedQty&quot;] = cells.FromKey(&quot;CertifiedQty&quot;).Text;
                dr[&quot;Amount&quot;] = cells.FromKey(&quot;Amount&quot;).Text;
                dr[&quot;IsPartRate&quot;] = cells.FromKey(&quot;IsPartRate&quot;).Text;
                dr[&quot;ParentID&quot;] = cells.FromKey(&quot;ParentID&quot;).Text;

                if (cells.FromKey(&quot;ParentID&quot;).Text.Equals(&quot;0&quot;))
                    dtExistingItems.Rows.Add(dr);
                else
                    dtExistingPRItems.Rows.Add(dr);
            }
            var existingList = new string[2];
            existingList[0] = ToStringAsXml(dtExistingItems); //Converting the datatable to xml
            existingList[1] = ToStringAsXml(dtExistingPRItems);
            return existingList;
            //return ToStringAsXml(dtExistingItems); 
        }

        /// &lt;summary&gt;
        /// Creates the MBooks Schema
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dtMBooks&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private DataTable CreateMBookSchema(DataTable dtMBooks)
        {
            dtMBooks.Columns.Clear();
            dtMBooks.Columns.Add(&quot;Work Order No&quot;);
            dtMBooks.Columns.Add(&quot;MBookList&quot;);
            if (!WorkOrderType.Equals(&quot;A&quot;))
            {
                dtMBooks.Columns.Add(&quot;ItemID&quot;);
                dtMBooks.Columns.Add(&quot;LineNo&quot;);
                dtMBooks.Columns.Add(&quot;StandardItemNo&quot;);
            }
            else
            {
                dtMBooks.Columns.Add(&quot;ActivityID&quot;);
                dtMBooks.Columns.Add(&quot;ActivityName&quot;);
                dtMBooks.Columns.Add(&quot;SubItem&quot;);
            }
            dtMBooks.Columns.Add(&quot;Description&quot;);
            dtMBooks.Columns.Add(&quot;UnitPrice&quot;);
            dtMBooks.Columns.Add(&quot;MaxAllowedPrice&quot;);
            dtMBooks.Columns.Add(&quot;BillingRate&quot;);
            dtMBooks.Columns.Add(&quot;MBookQuantity&quot;);
            dtMBooks.Columns.Add(&quot;MaxAvailQty&quot;);
            dtMBooks.Columns.Add(&quot;IsPartRate&quot;);
            dtMBooks.Columns.Add(&quot;ParentID&quot;);
            dtMBooks.Columns.Add(&quot;BillingQty&quot;);
            dtMBooks.Columns.Add(&quot;CertifiedQty&quot;);
            dtMBooks.Columns.Add(&quot;Amount&quot;);
            return dtMBooks;
        }

        /// &lt;summary&gt;
        /// Binds the Items tables with the selected MBooks
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dtMBooks&quot;&gt;&lt;/param&gt;
        private void BindAndFormatMBookDetails(DataTable dtMBooks)
        {
            if (dtMBooks.Rows.Count == 0)
            {
                dtMBooks = CreateMBookSchema(dtMBooks);
            }
            btnItemsDelete.Visible = false;
            btnMBViewDetails.Visible = btnMBDeleteItem.Visible = (dtMBooks.Rows.Count &gt; 0);
            itemsGrid.DataSource = dtMBooks;
            itemsGrid.DataBind();
            decimal sumTotal = 0;
            sumTotal = (dtMBooks.Rows.Count &gt; 0) ? dtMBooks.Compute(&quot;sum(Amount)&quot;, string.Empty).ToDecimal2() : 0;
            //ViewState[viewStateTotal] = sumTotal;
            totAmt.Text = &quot;Total : &quot; + sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
            totAmt.Visible = true;
            txtItemTotal.Value = sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
            txtItemTotal.Visible = true;

            if (itemsGrid.Columns.Exists(&quot;MBookList&quot;))
                itemsGrid.Columns.FromKey(&quot;MBookList&quot;).Hidden = true;

            if (itemsGrid.Columns.Exists(&quot;ParentID&quot;))
                itemsGrid.Columns.FromKey(&quot;ParentID&quot;).Hidden = true;

            if (itemsGrid.Columns.Exists(&quot;BaseID&quot;))
                itemsGrid.Columns.FromKey(&quot;BaseID&quot;).Hidden = true;

            if (itemsGrid.Columns.Exists(&quot;StandardItemNo&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;StandardItemNo&quot;).Header.Caption = LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO);
                itemsGrid.Columns.FromKey(&quot;StandardItemNo&quot;).CellStyle.Width = Unit.Pixel(200);
            }

            if (itemsGrid.Columns.Exists(&quot;LineNo&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;LineNo&quot;).Header.Caption = &quot;Line No&quot;;
                itemsGrid.Columns.FromKey(&quot;LineNo&quot;).CellStyle.Width = Unit.Pixel(150);
            }

            if (itemsGrid.Columns.Exists(&quot;Description&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;Description&quot;).CellStyle.Width = Unit.Pixel(300);
            }

            if (itemsGrid.Columns.Exists(&quot;MBookQuantity&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;MBookQuantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                itemsGrid.Columns.FromKey(&quot;MBookQuantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                itemsGrid.Columns.FromKey(&quot;MBookQuantity&quot;).CellStyle.Width = Unit.Pixel(250);
                itemsGrid.Columns.FromKey(&quot;MBookQuantity&quot;).Header.Caption = &quot;MBook Qty&quot;;
                itemsGrid.Columns.FromKey(&quot;MBookQuantity&quot;).Hidden = true;
            }

            if (itemsGrid.Columns.Exists(&quot;BillingQty&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;BillingQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                itemsGrid.Columns.FromKey(&quot;BillingQty&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                itemsGrid.Columns.FromKey(&quot;BillingQty&quot;).Header.Caption = &quot;Billing Qty&quot;;
                itemsGrid.Columns.FromKey(&quot;BillingQty&quot;).CellStyle.Width = Unit.Pixel(250);
            }

            if (itemsGrid.Columns.Exists(&quot;CertifiedQty&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;CertifiedQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                itemsGrid.Columns.FromKey(&quot;CertifiedQty&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                //itemsGrid.Columns.FromKey(&quot;CertifiedQty&quot;).AllowUpdate = AllowUpdate.Yes;
                //itemsGrid.Columns.FromKey(&quot;CertifiedQty&quot;).CellStyle.BackColor = Color.Yellow;
                itemsGrid.Columns.FromKey(&quot;CertifiedQty&quot;).CellStyle.Width = Unit.Pixel(250);
                itemsGrid.Columns.FromKey(&quot;CertifiedQty&quot;).Header.Caption = &quot;Certified Qty&quot;;

                //if (Mode == PageMode.View)
                //{
                //    itemsGrid.Columns.FromKey(&quot;CertifiedQty&quot;).AllowUpdate = AllowUpdate.No;
                //    itemsGrid.Columns.FromKey(&quot;CertifiedQty&quot;).CellStyle.BackColor = Color.White;
                //}
            }

            if (itemsGrid.Columns.Exists(&quot;Amount&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                itemsGrid.Columns.FromKey(&quot;Amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                itemsGrid.Columns.FromKey(&quot;Amount&quot;).CellStyle.Width = Unit.Pixel(200);
                itemsGrid.Columns.FromKey(&quot;Amount&quot;).Header.Caption =
                    LocalizationManager.GetString(KeyConstants.LOC_AMOUNT);
            }

            if (itemsGrid.Columns.Exists(&quot;UnitPrice&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;UnitPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                itemsGrid.Columns.FromKey(&quot;UnitPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                itemsGrid.Columns.FromKey(&quot;UnitPrice&quot;).CellStyle.Width = Unit.Pixel(250);
                itemsGrid.Columns.FromKey(&quot;UnitPrice&quot;).Header.Caption =
                    LocalizationManager.GetString(KeyConstants.LOC_UNIT_PRICE);
            }

            if (itemsGrid.Columns.Exists(&quot;MaxAllowedPrice&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;MaxAllowedPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                itemsGrid.Columns.FromKey(&quot;MaxAllowedPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                itemsGrid.Columns.FromKey(&quot;MaxAllowedPrice&quot;).CellStyle.Width = Unit.Pixel(250);
                itemsGrid.Columns.FromKey(&quot;MaxAllowedPrice&quot;).Header.Caption = &quot;Available Part rate in &quot; +
                                                                              LocalizationManager.GetString(
                                                                                  KeyConstants.LOC_CURRENCY_SYMBOL);
            }

            if (itemsGrid.Columns.Exists(&quot;BillingRate&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;BillingRate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                itemsGrid.Columns.FromKey(&quot;BillingRate&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                itemsGrid.Columns.FromKey(&quot;BillingRate&quot;).CellStyle.Width = Unit.Pixel(250);
                itemsGrid.Columns.FromKey(&quot;BillingRate&quot;).Header.Caption = &quot;Part Rate in &quot; +
                                                                          LocalizationManager.GetString(
                                                                              KeyConstants.LOC_CURRENCY_SYMBOL);
                itemsGrid.Columns.FromKey(&quot;BillingRate&quot;).AllowUpdate = AllowUpdate.Yes;
                itemsGrid.Columns.FromKey(&quot;BillingRate&quot;).CellStyle.BackColor = Color.Yellow;
                if (Mode == PageMode.View)
                {
                    itemsGrid.Columns.FromKey(&quot;BillingRate&quot;).AllowUpdate = AllowUpdate.No;
                    itemsGrid.Columns.FromKey(&quot;BillingRate&quot;).CellStyle.BackColor = Color.White;
                }
            }

            if (itemsGrid.Columns.Exists(&quot;MaxAvailQty&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;MaxAvailQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                itemsGrid.Columns.FromKey(&quot;MaxAvailQty&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                itemsGrid.Columns.FromKey(&quot;MaxAvailQty&quot;).CellStyle.Width = Unit.Pixel(250);
                itemsGrid.Columns.FromKey(&quot;MaxAvailQty&quot;).Header.Caption = &quot;Remaining WO Qty&quot;;
                itemsGrid.Columns.FromKey(&quot;MaxAvailQty&quot;).Hidden = true;
            }

            if (itemsGrid.Columns.Exists(&quot;Work Order No&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;Work Order No&quot;).Hidden = true;
            }

            if (itemsGrid.Columns.Exists(&quot;ItemID&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;ItemID&quot;).Hidden = true;
            }

            if (itemsGrid.Columns.Exists(&quot;ActivityID&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;ActivityID&quot;).Hidden = true;
            }

            if (itemsGrid.Columns.Exists(&quot;SubItem&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;SubItem&quot;).CellStyle.Width = Unit.Pixel(150);
            }

            if (itemsGrid.Columns.Exists(&quot;ActivityName&quot;))
            {
                itemsGrid.Columns.FromKey(&quot;ActivityName&quot;).Header.Caption = &quot;Activity Name&quot;;
                itemsGrid.Columns.FromKey(&quot;ActivityName&quot;).CellStyle.Width = Unit.Pixel(150);
            }

            if (itemsGrid.Columns.Exists(&quot;IsPartRate&quot;))
            {
                //itemsGrid.Columns.FromKey(&quot;IsPartRate&quot;).Type = ColumnType.CheckBox;
                itemsGrid.Columns.FromKey(&quot;IsPartRate&quot;).AllowUpdate = AllowUpdate.No;
                itemsGrid.Columns.FromKey(&quot;IsPartRate&quot;).Header.Caption = &quot;Part Rate&quot;;
            }

            foreach (UltraGridRow ugr in itemsGrid.Rows)
            {
                if (ugr.Cells.Exists(&quot;ParentID&quot;))
                {
                    if (!ugr.Cells.FromKey(&quot;ParentID&quot;).Text.Equals(&quot;0&quot;))
                    // || ugr.Cells.FromKey(&quot;IsPartRate&quot;).Text.Equals(&quot;True&quot;))
                    {
                        if (ugr.Cells.Exists(&quot;CertifiedQty&quot;))
                        {
                            ugr.Cells.FromKey(&quot;CertifiedQty&quot;).AllowEditing = AllowEditing.No;
                            ugr.Cells.FromKey(&quot;CertifiedQty&quot;).Style.BackColor = Color.White;
                        }
                    }
                }
                if (ugr.Cells.Exists(&quot;IsPartRate&quot;))
                {
                    ugr.Cells.FromKey(&quot;IsPartRate&quot;).Column.Type = ColumnType.NotSet;
                    ugr.Cells.FromKey(&quot;IsPartRate&quot;).Style.BackgroundImage =
                        (ugr.Cells.FromKey(&quot;IsPartRate&quot;).Value.ToString2().Equals(&quot;1&quot;) ||
                         ugr.Cells.FromKey(&quot;IsPartRate&quot;).Value.ToString2().ToLower().Equals(&quot;true&quot;))
                            ? &quot;../../Images/PartRate.png&quot;
                            : &quot;../../Images/FullRate.png&quot;;
                    ugr.Cells.FromKey(&quot;IsPartRate&quot;).Style.Padding.Left = new Unit(&quot;16px&quot;, CultureInfo.CurrentCulture);
                    ugr.Cells.FromKey(&quot;IsPartRate&quot;).Style.CustomRules =
                        &quot;background-repeat: no-repeat;background-position: center center&quot;;
                    ugr.Cells.FromKey(&quot;IsPartRate&quot;).Style.Font.Size = FontUnit.Point(0);
                }
            }
        }

        /// &lt;summary&gt;
        /// Converts Datatable to XML
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dt&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string ToStringAsXml(DataTable dt)
        {
            var sw = new StringWriter();
            dt.WriteXml(sw, XmlWriteMode.IgnoreSchema);
            string s = sw.ToString();
            return s;
        }

        /// &lt;summary&gt;
        /// Split the Item certified quantity across all the items
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ugr&quot;&gt;Selected row in Grid&lt;/param&gt;
        protected void SplitCerifiedQtyAcrossMBooks(UltraGridRow ugr)
        {
            string mBookDetails = ugr.Cells.FromKey(&quot;MBookList&quot;).Value.ToString2();
            decimal curCertQty = ugr.Cells.FromKey(&quot;CertifiedQty&quot;).Value.ToDecimal2();
            var sr = new StringReader(mBookDetails);
            var ds = new DataSet();
            ds.ReadXml(sr);
            decimal actCertQty = 0;
            DataTable dtSorted = ds.Tables[&quot;MBook&quot;].Clone();
            ds.Tables[&quot;MBook&quot;].Select(&quot;ParentID=&quot; + ugr.Cells.FromKey(&quot;ParentID&quot;).Value.ToString2(), &quot;ID DESC&quot;).
                CopyToDataTable(dtSorted, LoadOption.OverwriteChanges);
            foreach (DataRow row in dtSorted.Rows)
            {
                actCertQty += decimal.Parse(row[&quot;CertifiedQty&quot;].ToString2());
            }
            if (actCertQty != curCertQty)
            {
                decimal difference = actCertQty - curCertQty;
                decimal tempDifference = difference;
                foreach (DataRow row in dtSorted.Rows)
                {
                    decimal certQty = row[&quot;CertifiedQty&quot;].ToDecimal2();

                    if (certQty &gt; tempDifference)
                    {
                        certQty = certQty - tempDifference;
                        tempDifference = 0;
                    }
                    else
                    {
                        tempDifference = tempDifference - certQty;
                        certQty = 0;
                    }

                    row.BeginEdit();
                    row[&quot;CertifiedQty&quot;] = certQty;
                    row.EndEdit();
                    row.AcceptChanges();
                    if (tempDifference == 0)
                        break;
                }
                var dsTemp = new DataSet();
                dsTemp.DataSetName = &quot;Item&quot;;
                dsTemp.Tables.Add(dtSorted);
                ugr.Cells.FromKey(&quot;MBookList&quot;).Value = ToStringAsXml(dtSorted);
            }
        }

        #endregion

        #region Part Rate Measurement Book Picker Handlers / Functions

        protected BrixFilter[] SetItemPRMBookFilters()
        {
            var filters = new BrixFilter[3];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Line No :&quot;;
            filters[0].Name = &quot;LineNo&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Name :&quot;;
            filters[1].Name = &quot;StandardItemNo&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].Title = &quot;Description :&quot;;
            filters[2].Name = &quot;Description&quot;;
            filters[2].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        protected BrixFilter[] SetActivityPRMBookFilters()
        {
            var filters = new BrixFilter[3];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Line No :&quot;;
            filters[0].Name = &quot;LineNo&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Activity Name :&quot;;
            filters[1].Name = &quot;ActivityName&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].Title = &quot;Activity Description :&quot;;
            filters[2].Name = &quot;ActivityDescription&quot;;
            filters[2].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        /// &lt;summary&gt;
        /// Part rate MBook Picker binding event
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Filter&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;SortOrder&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;DsResult&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;CurrentPage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;PageSize&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;PageCount&quot;&gt;&lt;/param&gt;
        protected void genericPRMBookPicker_BindData(string filter, string sortOrder, out DataSet dsResult,
                                                     ref int currentPage, int pageSize, out int pageCount)
        {
            try
            {
                DataTable dtPRMBookDetails = new BrixDataTable();
                if (!String.IsNullOrEmpty(filter) &amp;&amp; DTPRMBooks != null &amp;&amp; DTPRMBooks.Rows.Count &gt; 0)
                {
                    var filterXml = new XmlDocument();
                    filterXml.LoadXml(filter);
                    string strFilter = string.Empty;

                    if (filterXml.DocumentElement.SelectSingleNode(&quot;LineNo&quot;) != null)
                        strFilter = &quot;LineNo = &quot; + filterXml.DocumentElement.SelectSingleNode(&quot;LineNo&quot;).InnerText.ToString2();

                    if (WorkOrderType == &quot;W&quot; &amp;&amp; filterXml.DocumentElement.SelectSingleNode(&quot;StandardItemNo&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) + &quot;StandardItemNo like &#39;%&quot;
                                    + filterXml.DocumentElement.SelectSingleNode(&quot;StandardItemNo&quot;).InnerText.ToString2() + &quot;%&#39;&quot;;
                    else if (WorkOrderType == &quot;A&quot; &amp;&amp; filterXml.DocumentElement.SelectSingleNode(&quot;ActivityName&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) + &quot;ActivityName like &#39;%&quot;
                                    + filterXml.DocumentElement.SelectSingleNode(&quot;ActivityName&quot;).InnerText.ToString2() + &quot;%&#39;&quot;;

                    if (WorkOrderType == &quot;W&quot; &amp;&amp; filterXml.DocumentElement.SelectSingleNode(&quot;Description&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) + &quot;Description like &#39;%&quot;
                                    + filterXml.DocumentElement.SelectSingleNode(&quot;Description&quot;).InnerText.ToString2() + &quot;%&#39;&quot;;
                    else if (WorkOrderType == &quot;A&quot; &amp;&amp; filterXml.DocumentElement.SelectSingleNode(&quot;ActivityDescription&quot;) != null)
                        strFilter = ((string.IsNullOrEmpty(strFilter)) ? strFilter : strFilter + &quot; AND &quot;) + &quot;ActivityDescription like &#39;%&quot;
                                    + filterXml.DocumentElement.SelectSingleNode(&quot;ActivityDescription&quot;).InnerText.ToString2() + &quot;%&#39;&quot;;

                    dtPRMBookDetails = DTPRMBooks.Copy().Select(strFilter).CopyToDataTable();
                }
                else if (DTPRMBooks != null)
                    dtPRMBookDetails = DTPRMBooks.Copy();
                dsResult = new DataSet();
                dsResult.Tables.Add(dtPRMBookDetails);
                pageCount = (int)Math.Ceiling(((DTPRMBooks == null) ? 0 : DTPRMBooks.Rows.Count.ToDouble2()) / pageSize.ToDouble2());
            }
            catch (Exception)
            {
                dsResult = null;
                pageCount = 0;
            }
        }

        /// &lt;summary&gt;
        /// Event that fires when cancel button is clicked in Part rate MBook picker
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnCancelPRMbookPicer_Click(object sender, EventArgs e)
        {
            ShowDiv(MIDivEnums.CreatePE);
        }

        /// &lt;summary&gt;
        /// Event that fires when done is clicked in Part rate MBookpicker
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void genericPRMbookPicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            DataTable dtSelectedPartRates = e.SelectedItems;
            decimal sumTotal; //= BrixDatatypeHelper.ToDecimal2(ViewState[viewStateTotal]);
            sumTotal = (String.IsNullOrEmpty(txtItemTotal.Value)) ? 0 : txtItemTotal.Value.ToDecimal2();
            string[] xmlExistingList = GetPEItemsFromGrid();
            string existingPRSXML = (xmlExistingList.Length &gt; 0) ? xmlExistingList[1] : &quot;&lt;DocumentElement /&gt;&quot;;
            var sr = new StringReader(existingPRSXML);
            var ds = new DataSet();
            ds.ReadXml(sr);
            foreach (DataRow dr in dtSelectedPartRates.Rows)
            {
                if (!WorkOrderType.Equals(&quot;A&quot;)) //For BOQ Based Workorder
                {
                    if (ds.Tables.Count &gt; 0 &amp;&amp;
                        ds.Tables[0].Select(&quot;ItemID = &quot; + dr[&quot;ItemID&quot;] + &quot; AND ParentID = &quot; + dr[&quot;ParentID&quot;]).Count() &gt;
                        0)
                        continue;
                }
                else
                {
                    if (ds.Tables.Count &gt; 0 &amp;&amp;
                        ds.Tables[0].Select(&quot;ActivityID = &quot; + dr[&quot;ActivityID&quot;] + &quot; AND ParentID = &quot; + dr[&quot;ParentID&quot;]).
                            Count() &gt; 0)
                        continue;
                }

                var values = new object[17];

                values[0] = &quot;0&quot;;
                values[1] = dr[&quot;WorkOrderNo&quot;];
                values[2] = dr[&quot;MBookList&quot;];

                if (!WorkOrderType.Equals(&quot;A&quot;)) //For BOQ Based Workorder
                {
                    values[3] = dr[&quot;ItemID&quot;];
                    values[4] = dr[&quot;LineNo&quot;];
                    values[5] = dr[&quot;StandardItemNo&quot;];
                    values[6] = dr[&quot;Description&quot;];
                }
                else //For Activity Based Workorder
                {
                    values[3] = dr[&quot;ActivityID&quot;];
                    values[4] = dr[&quot;ActivityName&quot;];
                    values[5] = dr[&quot;SubItem&quot;];
                    values[6] = dr[&quot;ActivityDescription&quot;];
                }

                values[7] = dr[&quot;UnitPrice&quot;];
                values[8] = dr[&quot;MaxAllowedPrice&quot;];
                values[9] = dr[&quot;BillingRate&quot;];
                values[10] = dr[&quot;MBookQuantity&quot;];
                values[11] = dr[&quot;MaxAvailQty&quot;];
                values[12] = dr[&quot;IsPartRate&quot;];
                values[13] = dr[&quot;ParentID&quot;];
                values[14] = dr[&quot;BillingQty&quot;];
                values[15] = dr[&quot;CertifiedQty&quot;];
                values[16] = dr[&quot;Amount&quot;];
                var ugr = new UltraGridRow(values);

                ugr.Cells[12].Style.BackgroundImage = &quot;../../Images/PartRate.png&quot;;
                ugr.Cells[12].Style.Padding.Right = new Unit(&quot;16px&quot;, CultureInfo.CurrentCulture);
                ugr.Cells[12].Style.CustomRules = &quot;background-repeat: no-repeat;background-position: center center&quot;;
                ugr.Cells[12].Style.Font.Size = FontUnit.Point(1);

                itemsGrid.Rows.Add(ugr);

                if (ugr.Cells.Exists(&quot;BillingRate&quot;))
                {
                    //ugr.Cells.FromKey(&quot;BillingRate&quot;).AllowEditing = AllowEditing.No;
                    //ugr.Cells.FromKey(&quot;BillingRate&quot;).Style.BackColor = System.Drawing.Color.White;
                    ugr.Cells.FromKey(&quot;BillingRate&quot;).Column.Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                }
                if (ugr.Cells.Exists(&quot;CertifiedQty&quot;))
                {
                    ugr.Cells.FromKey(&quot;CertifiedQty&quot;).AllowEditing = AllowEditing.No;
                    ugr.Cells.FromKey(&quot;CertifiedQty&quot;).Style.BackColor = Color.White;
                }
                sumTotal += dr[&quot;Amount&quot;].ToDecimal2();
            }
            btnMBViewDetails.Visible = btnMBDeleteItem.Visible = (itemsGrid.Rows.Count &gt; 0);

            ViewState[&quot;viewStateTotal&quot;] = sumTotal;
            totAmt.Text = &quot;Total : &quot; + sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
            totAmt.Visible = true;
            txtItemTotal.Value = sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
            txtItemTotal.Visible = true;

            ShowDiv(MIDivEnums.CreatePE);
            if (itemsGrid.Rows.Count &gt; 0)
            {
                txtItemTotal.Value = sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                divItems.Style[&quot;display&quot;] = &quot;block&quot;;
                lblNoRows.Visible = false;
            }
        }

        /// &lt;summary&gt;
        /// Displays the MBook Picker
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnPRMBPickerAdd_Click(object sender, EventArgs e)
        {
            PageTitle = &quot;Select Part Rate &quot; + LocalizationManager.GetString(&quot;LOC_MeasurementBook&quot;) + &quot;s&quot;;
            ShowDiv(MIDivEnums.PRMBPicker);
            FillPRMBooksTable();
        }

        /// &lt;summary&gt;
        /// Used to bind the Part rate MBook picker
        /// &lt;/summary&gt;
        private void FillPRMBooksTable()
        {
            if (!WorkOrderType.Equals(&quot;A&quot;))
                DTPRMBooks =
                    BL.Instance.GetPartRates((String.IsNullOrEmpty(Request[&quot;WOID&quot;])) ? 0 : int.Parse(Request[&quot;WOID&quot;]),
                                             (String.IsNullOrEmpty(Request[&quot;PEID&quot;])) ? 0 : int.Parse(Request[&quot;PEID&quot;]));
            else // For activity based Workorder
                DTPRMBooks =
                    BL.Instance.GetACTIPartRates(
                        (String.IsNullOrEmpty(Request[&quot;WOID&quot;])) ? 0 : int.Parse(Request[&quot;WOID&quot;]),
                        (String.IsNullOrEmpty(Request[&quot;PEID&quot;])) ? 0 : int.Parse(Request[&quot;PEID&quot;]));
            genericPRMBookPicker.ChangeTableOrViewAndBind(string.Empty);
        }

        #endregion

        #region Part Rate RFI Picker Handlers / Functions

        private void FillPRRFITable()
        {
            if ((String.IsNullOrEmpty(Request[&quot;WOID&quot;])) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;))
                DTPRRFIs = BL.Instance.GetPartRateRFIs(Request[&quot;ContractID&quot;].ToInt32_2(),
                                                       String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                           ? 0
                                                           : Request[&quot;PEID&quot;].ToInt32_2());
            else if (String.IsNullOrEmpty(WorkOrderType) || !WorkOrderType.Equals(&quot;A&quot;))
                DTPRRFIs = BL.Instance.GetPartRateIPs(Request[&quot;ContractID&quot;].ToInt32_2(),
                                                      (String.IsNullOrEmpty(Request[&quot;WOID&quot;]))
                                                          ? 0
                                                          : Request[&quot;WOID&quot;].ToInt32_2(),
                                                      String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                          ? 0
                                                          : Request[&quot;PEID&quot;].ToInt32_2());
            else
                DTPRRFIs = BL.Instance.GetACTIWOPartRateIPs(Request[&quot;ContractID&quot;].ToInt32_2(),
                                                            (String.IsNullOrEmpty(Request[&quot;WOID&quot;]))
                                                                ? 0
                                                                : Request[&quot;WOID&quot;].ToInt32_2(),
                                                            String.IsNullOrEmpty(Request[&quot;PEID&quot;])
                                                                ? 0
                                                                : Request[&quot;PEID&quot;].ToInt32_2());
            genericPRRFIPicker.ChangeTableOrViewAndBind(string.Empty);
        }

        protected void btnPRRFIAdd_Click(object sender, EventArgs e)
        {
            PageTitle = &quot;Select Part Rate &quot;;
            FillPRRFITable();
            ShowDiv(MIDivEnums.PRRFIPicker);

            genericPRRFIPicker.ChangeTableOrViewAndBind(&quot;PRRFIPicker&quot;);
        }

        protected BrixFilter[] SetPRFilters()
        {
            if ((String.IsNullOrEmpty(Request[&quot;WOID&quot;])) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;))
                return SetPRRFIFilters();
            else if ((String.IsNullOrEmpty(Request[&quot;WOType&quot;])) || !Request[&quot;WOType&quot;].Equals(&quot;A&quot;))
                return SetPRIPFilters();
            else
                return SetPRIPSubACTIFilters();
        }

        protected BrixFilter[] SetPRRFIFilters()
        {
            var filters = new BrixFilter[3];
            filters[0] = new BrixFilter();
            filters[0].Title = &quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; No :&quot;;
            filters[0].Name = &quot;RFINo&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Standard Item No :&quot;;
            filters[1].Name = &quot;StdItemID&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].Title = &quot;Description :&quot;;
            filters[2].Name = &quot;Description&quot;;
            filters[2].FilterType = BrixFilter.Type.Text;

            //filters[3] = new BrixFilter();
            //filters[3].Title = &quot;Location :&quot;;
            //filters[3].Name = &quot;SubItemDescription&quot;;
            //filters[3].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        protected BrixFilter[] SetPRIPFilters()
        {
            var filters = new BrixFilter[4];
            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Line No :&quot;;
            filters[0].Name = &quot;LineNo&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Standard Item No :&quot;;
            filters[1].Name = &quot;StdItemID&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].Title = &quot;Description :&quot;;
            filters[2].Name = &quot;Description&quot;;
            filters[2].FilterType = BrixFilter.Type.Text;

            filters[3] = new BrixFilter();
            filters[3].Title = &quot;Sub Item :&quot;;
            filters[3].Name = &quot;SubItemDescription&quot;;
            filters[3].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        protected BrixFilter[] SetPRIPSubACTIFilters()
        {
            var filters = new BrixFilter[1];
            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Posting Id :&quot;;
            filters[0].Name = &quot;PostingID&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        protected void genericPRRFIPicker_BindData(string filter, string sortOrder, out DataSet dsResult,
                                                   ref int currentPage, int pageSize, out int pageCount)
        {
            try
            {
                DataTable dtPRRFIDetails = new BrixDataTable();
                if (!String.IsNullOrEmpty(filter))
                {
                    var filterXml = new XmlDocument();
                    filterXml.LoadXml(filter);
                    if (!WorkOrderType.Equals(&quot;A&quot;))
                    {
                        string rfiNo;
                        if ((String.IsNullOrEmpty(Request[&quot;WOID&quot;])) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;))
                            rfiNo = ((filterXml).DocumentElement.SelectSingleNode(&quot;RFINo&quot;)) == null
                                        ? string.Empty
                                        : ((filterXml).DocumentElement.SelectSingleNode(&quot;RFINo&quot;)).InnerText.ToString2();
                        else
                            rfiNo = ((filterXml).DocumentElement.SelectSingleNode(&quot;LineNo&quot;)) == null
                                        ? string.Empty
                                        : ((filterXml).DocumentElement.SelectSingleNode(&quot;LineNo&quot;)).InnerText.ToString2();
                        string stdItemNo = ((filterXml).DocumentElement.SelectSingleNode(&quot;StdItemID&quot;)) == null
                                               ? string.Empty
                                               : ((filterXml).DocumentElement.SelectSingleNode(&quot;StdItemID&quot;)).InnerText.
                                                     ToString2();
                        string description = ((filterXml).DocumentElement.SelectSingleNode(&quot;Description&quot;)) == null
                                                 ? string.Empty
                                                 : ((filterXml).DocumentElement.SelectSingleNode(&quot;Description&quot;)).
                                                       InnerText.ToString2();
                        string location = ((filterXml).DocumentElement.SelectSingleNode(&quot;SubItemDescription&quot;)) == null
                                              ? string.Empty
                                              : ((filterXml).DocumentElement.SelectSingleNode(&quot;SubItemDescription&quot;)).
                                                    InnerText.ToString2();
                        if (DTPRRFIs == null)
                            FillPRRFITable();
                        if ((String.IsNullOrEmpty(Request[&quot;WOID&quot;])) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;))
                            dtPRRFIDetails =
                                DTPRRFIs.Copy().Select(&quot;[RFINo] like &#39;%&quot; + rfiNo + &quot;%&#39; and Description like &#39;%&quot; +
                                                       description + &quot;%&#39; and StdItemID like &#39;%&quot; + stdItemNo +
                                                       &quot;%&#39; and SubItemDescription like &#39;%&quot; + location + &quot;%&#39;&quot;).
                                    CopyToDataTable();
                        else if (String.IsNullOrEmpty(WorkOrderType) || !WorkOrderType.Equals(&quot;A&quot;))
                            dtPRRFIDetails =
                                DTPRRFIs.Copy().Select(&quot;[LineNo] like &#39;%&quot; + rfiNo + &quot;%&#39; and Description like &#39;%&quot; +
                                                       description + &quot;%&#39; and StdItemID like &#39;%&quot; + stdItemNo +
                                                       &quot;%&#39; and SubItemDescription like &#39;%&quot; + location + &quot;%&#39;&quot;).
                                    CopyToDataTable();
                    }
                    else
                    {
                        string postingId;
                        postingId = ((filterXml).DocumentElement.SelectSingleNode(&quot;PostingID&quot;)) == null
                                        ? string.Empty
                                        : ((filterXml).DocumentElement.SelectSingleNode(&quot;PostingID&quot;)).InnerText.
                                              ToString2();
                        if (DTPRRFIs == null)
                            FillPRRFITable();
                        dtPRRFIDetails =
                            DTPRRFIs.Copy().Select(&quot;[PostingId] like &#39;%&quot; + postingId + &quot;%&#39;&quot;).CopyToDataTable();
                    }
                }
                else
                {
                    if (DTPRRFIs == null)
                        FillPRRFITable();
                    dtPRRFIDetails = DTPRRFIs.Copy();
                }
                dsResult = new DataSet();
                dsResult.Tables.Add(dtPRRFIDetails);
                pageCount = (int)Math.Ceiling(dtPRRFIDetails.Rows.Count.ToDouble2() / pageSize.ToDouble2());
            }
            catch (Exception)
            {
                dsResult = null;
                pageCount = 0;
            }
        }

        protected void genericPRRFIPicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            var duplicatePostings = new int[e.SelectedItems.Rows.Count];
            var duplicateActivities = new int[e.SelectedItems.Rows.Count];
            int i = 0;
            DataTable dtSelectedPRs = e.SelectedItems;
            foreach (DataRow row in dtSelectedPRs.Rows)
            {
                foreach (UltraGridRow ugr in itemsGrid.Rows)
                {
                    if (!WorkOrderType.Equals(&quot;A&quot;))
                    {
                        if (ugr.Cells.Exists(&quot;PostingId&quot;) &amp;&amp;
                            ugr.Cells.FromKey(&quot;PostingId&quot;).Value.ToInt32_2() == row[&quot;PostingId&quot;].ToInt32_2())
                        {
                            duplicatePostings[i] = row[&quot;PostingId&quot;].ToInt32_2();
                            i++;
                            break;
                        }
                    }
                    else
                    {
                        if (ugr.Cells.Exists(&quot;PostingId&quot;) &amp;&amp; ugr.Cells.Exists(&quot;ActivityID&quot;) &amp;&amp;
                            (ugr.Cells.FromKey(&quot;PostingId&quot;).Value.ToInt32_2() == row[&quot;PostingId&quot;].ToInt32_2() &amp;&amp;
                             ugr.Cells.FromKey(&quot;ActivityID&quot;).Value.ToInt32_2() == row[&quot;ActivityID&quot;].ToInt32_2()))
                        {
                            duplicatePostings[i] = row[&quot;PostingId&quot;].ToInt32_2();
                            duplicateActivities[i] = row[&quot;ActivityID&quot;].ToInt32_2();
                            i++;
                            break;
                        }
                    }
                }
            }
            for (int j = 0; j &lt; i; j++)
            {
                DataRow row;
                if (!WorkOrderType.Equals(&quot;A&quot;))
                    row = dtSelectedPRs.Select(&quot;PostingId =&quot; + duplicatePostings[j])[0];
                else
                    row =
                        dtSelectedPRs.Select(&quot;PostingId =&quot; + duplicatePostings[j] + &quot; AND ActivityID =&quot; +
                                             duplicateActivities[j])[0];
                dtSelectedPRs.Rows.Remove(row);
                dtSelectedPRs.AcceptChanges();
                //dtSelectedPRs = dtSelectedPRs.Select(&quot;PostingId &lt;&gt;&quot; + duplicatePostings[j]).CopyToDataTable();
            }
            if (itemsGrid.Rows.Count &lt;= 1)
            {
                string contractor = (ddlContractor.SelectedItem.Text != &quot;--Select One--&quot;)
                                        ? ddlContractor.SelectedValue
                                        : null;
                string contractorType = &quot;P&quot;;
                if (!String.IsNullOrEmpty(contractor))
                {
                    contractorType = contractor.Split(&#39;,&#39;)[1];
                }
                AddColumnsToGrid(itemsGrid, WorkOrderType, contractorType,
                                 hdnItemPostings.Value.Equals(&quot;1&quot;) ? ItemSource.ItemPostings : ItemSource.RFI);
            }
            decimal sumTotal = String.IsNullOrEmpty(txtItemTotal.Value) ? 0 : txtItemTotal.Value.ToDecimal2();

            foreach (DataRow row in dtSelectedPRs.Rows)
            {
                sumTotal += row[&quot;Amt Placed&quot;].ToDecimal2();
                if ((String.IsNullOrEmpty(Request[&quot;WOID&quot;])) &amp;&amp; hdnItemPostings.Value.Equals(&quot;0&quot;))
                    itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                            {
                                                                false, row[&quot;ItemID&quot;],
                                                                row[&quot;RFINo&quot;],
                                                                row[&quot;Status&quot;],
                                                                row[&quot;PDate&quot;].ToDateTime_MWCulture().ToString(
                                                                    AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture),
                                                                row[&quot;PostingID&quot;],
                                                                row[&quot;StdItemID&quot;],
                                                                row[&quot;SubItemDescription&quot;],
                                                                row[&quot;Description&quot;],
                                                                row[&quot;Submitted Qty&quot;].ToDecimal2().ToString(
                                                                    AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                    CultureInfo.CurrentCulture),
                                                                row[&quot;Billed Qty&quot;].ToDecimal2().ToString(
                                                                    AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                    CultureInfo.CurrentCulture),
                                                                row[&quot;IsPartRate&quot;].ToBoolean2(),
                                                                row[&quot;Unit Price&quot;].ToDecimal2().ToString(
                                                                    AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                    CultureInfo.CurrentCulture),
                                                                row[&quot;MaxAllowedPrice&quot;],
                                                                row[&quot;BillingRate&quot;],
                                                                row[&quot;Amt Placed&quot;].ToDecimal2().ToString(
                                                                    AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture)
                                                                ,
                                                                row[&quot;ParentID&quot;],
                                                                row[&quot;PostingID&quot;].ToInt32_2(),
                                                                row[&quot;RefNo&quot;]
                                                            }));
                else
                {
                    if (!WorkOrderType.Equals(&quot;A&quot;))
                        itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                                {
                                                                    false, row[&quot;ItemID&quot;],
                                                                    row[&quot;LineNo&quot;],
                                                                    row[&quot;Work Order No&quot;],
                                                                    row[&quot;Status&quot;],
                                                                    row[&quot;PDate&quot;].ToDateTime_MWCulture().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_DATE,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;PostingID&quot;],
                                                                    row[&quot;StdItemID&quot;],
                                                                    row[&quot;SubItemDescription&quot;],
                                                                    row[&quot;Description&quot;],
                                                                    row[&quot;PostedQty&quot;].ToDecimal2().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;PostedQty&quot;].ToDecimal2().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;IsPartRate&quot;].ToBoolean2(),
                                                                    row[&quot;Unit Price&quot;].ToDecimal2().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;MaxAllowedPrice&quot;],
                                                                    row[&quot;BillingRate&quot;],
                                                                    row[&quot;Amt Placed&quot;].ToDecimal2().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;ParentID&quot;]
                                                                }));
                    else
                        itemsGrid.Rows.Add(new UltraGridRow(new[]
                                                                {
                                                                    false,
                                                                    0,
                                                                    row[&quot;LineNo&quot;],
                                                                    row[&quot;Work Order No&quot;],
                                                                    row[&quot;ActivityID&quot;],
                                                                    row[&quot;ActivityName&quot;],
                                                                    row[&quot;Status&quot;],
                                                                    row[&quot;PDate&quot;].ToDateTime_MWCulture().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_DATE,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;PostingID&quot;],
                                                                    &quot;&quot;,
                                                                    row[&quot;Description&quot;],
                                                                    row[&quot;StdItemID&quot;],
                                                                    row[&quot;PostedQty&quot;].ToDecimal2().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;PostedQty&quot;].ToDecimal2().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;IsPartRate&quot;].ToBoolean2(),
                                                                    row[&quot;Unit Price&quot;].ToDecimal2().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;MaxAllowedPrice&quot;],
                                                                    row[&quot;BillingRate&quot;],
                                                                    row[&quot;Amt Placed&quot;].ToDecimal2().ToString(
                                                                        AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                        CultureInfo.CurrentCulture),
                                                                    row[&quot;ParentID&quot;]
                                                                }));
                }
            }
            ShowDiv(MIDivEnums.CreatePE);
            if (itemsGrid.Rows.Count &gt; 0)
            {
                txtItemTotal.Value = sumTotal.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                divItems.Style[&quot;display&quot;] = &quot;block&quot;;
                lblNoRows.Visible = false;
            }
            ModifyRFIDetailsColumnProperties();
        }

        protected void btnCancelPRRFIPicker_Click(object sender, EventArgs e)
        {
            ShowDiv(MIDivEnums.CreatePE);
        }

        #endregion

        #region Nested type: ItemSource

        private enum ItemSource
        {
            ItemPostings = 1,
            RFI = 2,
            MBook = 3
        }

        #endregion

        #region Nested type: RetentionCeilingMode

        private enum RetentionCeilingMode
        {
            Amount = 0,
            Percentage = 1
        }

        #endregion
    }

    [CustomResourceType(&quot;Forms&quot;, &quot;XPAYEST&quot;)]
    public class PerformPEOperation : FormsCustomResource
    {
        public PerformPEOperation()
        {
            _Namespace = &quot;Forms&quot;;
            _Path = &quot;Forms.Contract.PE&quot;;
            _Name = &quot;PerformPEOperation&quot;;
            _Desc = &quot;Perform Pay Estimate Operations&quot;;

            _InParameters = new[] { &quot;Operation,System.String&quot; };
            _OutParameters = new[] { &quot;IsSuccessful,System.Boolean&quot;, &quot;Message,System.String&quot; };
        }

        public DataSet GetRequiredData()
        {
            //string cmd = &quot;SELECT ContractID,IsFinal,WOID FROM CONTMGTPEMaster WHERE ID = &quot; + InstanceId;
            //DataSet dsReqData = ComponentHelper.Instance.ExecuteDataSet(cmd);
            //return dsReqData;

            return BL.Instance.GetWFReqData(InstanceId.ToInt32_2());
        }

        public override void ExecuteDerived()
        {
            string operation = GetInputParam(&quot;Operation&quot;).ToString();
            string culture = GetInputParam(&quot;Culture&quot;).ToString();
            string uiCulture = GetInputParam(&quot;UICulture&quot;).ToString();
            Thread.CurrentThread.CurrentCulture = new CultureInfo(culture);
            Thread.CurrentThread.CurrentUICulture = new CultureInfo(uiCulture);

            switch (operation.ToUpper())
            {
                case &quot;SUBMIT&quot;:
                case &quot;RE-DRAFT&quot;:
                    SubmitPE(operation);
                    break;
                case &quot;VALIDATEAPPROVE&quot;:
                    ValidateApprovePE();
                    break;
                case &quot;APPROVE&quot;:
                    ApprovePE();
                    break;
                case &quot;UNAPPROVE&quot;:
                    UnApprovePE();
                    break;
            }
        }

        private void SubmitPE(string OperationName)
        {
            bool bsubmit = true;
            string sMsg = string.Empty;
            try
            {
                string selPEId = InstanceId;
                DataSet ds = GetRequiredData();
                int contractID = ds.Tables[0].Rows[0][&quot;ContractID&quot;].ToInt32_2();
                int woID = ds.Tables[0].Rows[0][&quot;WOID&quot;].ToInt32_2();
                bool isFinal = ds.Tables[0].Rows[0][&quot;IsFinal&quot;].ToBoolean2();
                if (!String.IsNullOrEmpty(selPEId))
                {
                    var dto = new DTOPE();

                    if (isFinal)
                        sMsg = ValidatePEForFinal(InstanceId.ToInt32_2(), woID);
                    if (!String.IsNullOrEmpty(sMsg))
                        throw new Exception(sMsg);

                    dto.IDs.Add(selPEId.ToInt32_2());
                    var opName = (OperationName.ToUpper() == &quot;SUBMIT&quot;) ? PEOperations.Submit : PEOperations.ReDraft;
                    BL.Instance.CUDPE(contractID, opName, dto);
                    selPEId = InstanceId;
                    SetOutParam(&quot;IsSuccessful&quot;, bsubmit, &quot;System.Boolean&quot;);
                    SetOutParam(&quot;Message&quot;, sMsg, &quot;System.String&quot;);
                }
            }
            catch (Exception ex)
            {
                bsubmit = false;
                SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
                sMsg = ex.Message;
                SetOutParam(&quot;Message&quot;, sMsg, &quot;System.String&quot;);
                throw new Exception(sMsg);
            }
        }

        private void ValidateApprovePE()
        {
            bool bApprove = true;
            string sMsg = string.Empty;
            var dto = new DTOPE();
            DataSet ds = GetRequiredData();
            int contractID = ds.Tables[0].Rows[0][&quot;ContractID&quot;].ToInt32_2();
            bool isFinal = ds.Tables[0].Rows[0][&quot;IsFinal&quot;].ToBoolean2();
            int woID = ds.Tables[0].Rows[0][&quot;WOID&quot;].ToInt32_2();

            try
            {
                sMsg = ValidateApprove(contractID, woID, isFinal);
                if (!String.IsNullOrEmpty(sMsg))
                    throw new Exception(sMsg);
                else
                {
                    bApprove = true;
                    SetOutParam(&quot;IsSuccessful&quot;, bApprove, &quot;System.Boolean&quot;);
                    sMsg = &quot;Validated&quot;;
                    SetOutParam(&quot;Message&quot;, sMsg, &quot;System.String&quot;);
                }
            }
            catch (Exception ex)
            {
                bApprove = false;
                SetOutParam(&quot;IsSuccessful&quot;, bApprove, &quot;System.Boolean&quot;);
                sMsg = ex.Message;
                SetOutParam(&quot;Message&quot;, sMsg, &quot;System.String&quot;);
                throw new Exception(sMsg);
            }
        }

        private void ApprovePE()
        {
            bool bApprove = true;
            string sMsg = string.Empty;
            var dto = new DTOPE();

            int selPEId = InstanceId.ToInt32_2();
            DataSet ds = GetRequiredData();
            int contractID = ds.Tables[0].Rows[0][&quot;ContractID&quot;].ToInt32_2();
            bool isFinal = ds.Tables[0].Rows[0][&quot;IsFinal&quot;].ToBoolean2();
            int woID = ds.Tables[0].Rows[0][&quot;WOID&quot;].ToInt32_2();
            int CostAmt = ds.Tables[0].Rows[0][&quot;CostAmt&quot;].ToInt32_2();
            int projectId = ds.Tables[0].Rows[0][&quot;ProjectID&quot;].ToInt32_2();
            string WoType = ds.Tables[0].Rows[0][&quot;WorkOrderType&quot;].ToString2();

            try
            {
                sMsg = Approve(contractID, woID, isFinal);
                if (!String.IsNullOrEmpty(sMsg))
                    throw new Exception(sMsg);
                if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                {
                    var eisPEModel = new EISEstimatesListModel();
                    string companyName = GetInputParam(&quot;Company&quot;).ToString();
                    string userName = GetInputParam(&quot;UserName&quot;).ToString();
                    eisPEModel.EISApprovePE(ref sMsg, selPEId, contractID, woID, isFinal, CostAmt, companyName,
                                            projectId, userName, WoType);
                }
                if (String.IsNullOrEmpty(sMsg) || sMsg.Contains(&quot;Approve Successful&quot;) ||
                    sMsg.Contains(&quot;approved successfully&quot;))
                {
                    if (isFinal &amp;&amp; woID != 0)
                    {
                        string woType = ds.Tables[0].Rows[0][&quot;WorkOrderType&quot;].ToString2();
                        CloseOutWorkOrder(contractID, woID, woType);
                    }

                    bApprove = true;
                    SetOutParam(&quot;IsSuccessful&quot;, bApprove, &quot;System.Boolean&quot;);
                    sMsg = &quot;The Pay Estimate is approved&quot;;
                    SetOutParam(&quot;Message&quot;, sMsg, &quot;System.String&quot;);
                }
                else
                {
                    bApprove = false;
                    SetOutParam(&quot;IsSuccessful&quot;, bApprove, &quot;System.Boolean&quot;);
                    SetOutParam(&quot;Message&quot;, sMsg, &quot;System.String&quot;);
                    throw new Exception(sMsg);
                }
            }
            catch (Exception ex)
            {
                bApprove = false;
                SetOutParam(&quot;IsSuccessful&quot;, bApprove, &quot;System.Boolean&quot;);
                sMsg = ex.Message;
                SetOutParam(&quot;Message&quot;, sMsg, &quot;System.String&quot;);
                throw new Exception(sMsg);
            }
        }

        private void UnApprovePE()
        {
            if (!IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
            {
                bool bUnApprove = true;
                string sMsg = &quot;&quot;;
                var dto = new DTOPE();

                int selPEId = InstanceId.ToInt32_2();
                dto.IDs.Add(selPEId);

                //TODO: Need to remove this raw sql
                DataSet ds = GetRequiredData();
                int contractID = ds.Tables[0].Rows[0][&quot;ContractID&quot;].ToInt32_2();
                bool isFinal = ds.Tables[0].Rows[0][&quot;IsFinal&quot;].ToBoolean2();
                int woid = ds.Tables[0].Rows[0][&quot;WOID&quot;].ToInt32_2();
                //dto.CreatedBy = UserDetail.GetCurrentUserDetail().UID;

                int userId = GetInputParam(&quot;_CurrentUserId&quot;).ToInt32_2();
                dto.CreatedBy = userId.ToInt32_2();

                try
                {
                    int? i;
                    if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                    {
                        var eisPEModel = new EISEstimatesListModel { WorkOrderID = woid, UserID = userId, ContractID = contractID };
                        eisPEModel.EISUndoApprove(selPEId.ToString2(), woid, userId, contractID);
                    }
                    else
                    {
                        if (isFinal)
                            throw new Exception(&quot;Final &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) +
                                                &quot; approval cannot be reopened.&quot;);
                        i = BL.Instance.CUDPE(contractID, PEOperations.UnApprove, dto);
                        if (i == 0 || i == null)
                        {
                            throw new Exception(&quot;The Pay Estimate does not exists&quot;);
                        }
                        else
                        {
                            bUnApprove = true;
                            SetOutParam(&quot;IsSuccessful&quot;, bUnApprove, &quot;System.Boolean&quot;);
                            SetOutParam(&quot;Message&quot;, &quot;The Un-Aprrove succeeded&quot;, &quot;System.String&quot;);
                        }
                    }
                }
                catch (Exception ex)
                {
                    bUnApprove = false;
                    SetOutParam(&quot;IsSuccessful&quot;, bUnApprove, &quot;System.Boolean&quot;);
                    sMsg = ex.Message;
                    SetOutParam(&quot;Message&quot;, sMsg, &quot;System.String&quot;);
                    throw new Exception(sMsg);
                }
            }
            else
                throw new Exception(&quot;This &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) +
                                    &quot; cannot be unapproved.&quot;);
        }

        private string ValidateApprove(int contractID, int woID, bool isFinal)
        {
            try
            {
                string selPEId = InstanceId;
                if (!String.IsNullOrEmpty(selPEId))
                {
                    if (isFinal)
                    {
                        string retMsg = ValidatePEForFinal(selPEId.ToInt32_2(), woID);
                        if (!string.IsNullOrEmpty(retMsg)) throw new Exception(retMsg);
                    }
                }
                BL.Instance.ValidatePE(contractID, selPEId.ToInt32_2(), PEOperations.Approve);

            }
            catch (Exception ex)
            {
                return ex.Message.Replace(&quot;Pay Estimate&quot;, LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE));
            }
            return String.Empty;
        }

        private string Approve(int contractID, int woID, bool isFinal)
        {
            try
            {
                var dto = new DTOPE();
                string selPEId = InstanceId;
                if (!String.IsNullOrEmpty(selPEId))
                {
                    //TODO:Merge - new workflow
                    //if (!this.displayWorkFlow &amp;&amp; IsFinal)
                    if (isFinal)
                    {
                        string retMsg = ValidatePEForFinal(selPEId.ToInt32_2(), woID);
                        if (!string.IsNullOrEmpty(retMsg)) throw new Exception(retMsg);
                    }
                    dto.IDs.Add(selPEId.ToInt32_2());
                }

                int currentUserId = GetInputParam(&quot;_CurrentUserId&quot;).ToInt32_2();
                dto.CreatedBy = currentUserId;
                dto.CreatedOn = DateTime.UtcNow;
                //dto.CreatedOn = String.IsNullOrEmpty(ApproveDate) ? DateTime.UtcNow : Convert.ToDateTime(ApproveDate);
                int newPEID = BL.Instance.CUDPE(contractID, PEOperations.Approve, dto);
                if (newPEID == 0 || newPEID == null)
                    throw new Exception(&quot;The &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) +
                                        &quot; does not exists&quot;);
            }
            catch (Exception ex)
            {
                return ex.Message.Replace(&quot;Pay Estimate&quot;, LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE));
            }
            return String.Empty;
        }

        protected string ValidatePEForFinal(int peId, int woID)
        {
            string errMessage = string.Empty;

            errMessage = PayEstimateValidationManager.Instance.ValidateRABforFinal(peId, (woID != 0));
            return errMessage;

        }

        protected void CloseOutWorkOrder(int contractID, int woID, string woType)
        {
            int currentUserId = GetInputParam(&quot;_CurrentUserId&quot;).ToInt32_2();
            string currentUser = GetInputParam(&quot;_CurrentUser&quot;).ToString();
            int latestWOID = WOManager.Instance.GetLatestWorkOrderID(woID);
            if (woType.Equals(&quot;A&quot;))
                WOManager.Instance.CloseWorkOrder(latestWOID, currentUserId, currentUser, DateTime.UtcNow, &quot;Closed&quot;, &quot;Y&quot;);
            else
                WORKORDManager.Instance.CloseWorkOrder(latestWOID, currentUserId, currentUser, DateTime.UtcNow, &quot;Closed&quot;,
                                                       &quot;Y&quot;);
            if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
            {
                WORKORDManager.Instance.HandleAXIntegrationforCloseOut(woID.ToString2(), contractID.ToString2());
            }
        }

        #region AX

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[78,17,78,18,0],[78,19,78,112,0],[78,113,78,114,0],[107,9,107,61,0],[108,9,108,53,0],[109,9,109,53,0],[110,9,110,57,0],[111,9,111,49,0],[112,9,112,45,0],[113,9,113,90,0],[117,17,117,18,0],[117,19,117,66,0],[117,67,117,68,0],[118,17,118,18,0],[118,19,118,55,0],[118,56,118,57,0],[123,17,123,18,0],[123,19,123,58,0],[123,59,123,60,0],[124,17,124,18,0],[124,19,124,129,0],[124,130,124,131,0],[130,13,130,14,0],[131,17,133,36,0],[134,13,134,14,0],[139,17,139,18,0],[139,19,139,61,0],[139,62,139,63,0],[140,17,140,18,0],[140,19,140,51,0],[140,52,140,53,0],[145,17,145,18,0],[145,19,145,59,0],[145,60,145,61,0],[146,17,146,18,0],[146,19,146,49,0],[146,50,146,51,0],[151,17,151,18,0],[151,19,151,61,0],[151,62,151,63,0],[152,17,152,18,0],[152,19,152,51,0],[152,52,152,53,0],[157,17,157,18,0],[157,19,157,59,0],[157,60,157,61,0],[158,17,158,18,0],[158,19,158,49,0],[158,50,158,51,0],[163,17,163,18,0],[163,19,163,67,0],[163,68,163,69,0],[164,17,164,18,0],[164,19,164,57,0],[164,58,164,59,0],[169,17,169,18,0],[169,19,169,113,0],[169,114,169,115,0],[177,17,177,18,0],[177,19,177,95,0],[177,96,177,97,0],[185,17,185,18,0],[185,19,185,77,0],[185,78,185,79,0],[190,17,190,18,0],[190,19,190,33,0],[190,34,190,35,0],[191,17,191,18,0],[191,19,191,32,0],[191,33,191,34,0],[206,17,206,18,0],[206,19,206,71,0],[206,72,206,73,0],[214,9,214,10,0],[215,13,215,49,0],[221,13,221,14,0],[222,17,224,92,0],[225,17,225,38,0],[226,13,226,14,0],[231,17,231,18,0],[231,19,231,39,0],[231,40,231,41,0],[237,13,237,14,0],[241,17,242,119,0],[245,13,245,14,0],[252,13,252,14,0],[253,17,253,210,0],[254,13,254,14,0],[259,17,259,18,0],[259,19,259,36,0],[259,37,259,38,0],[264,17,264,18,0],[264,19,264,31,0],[264,32,264,33,0],[269,17,269,18,0],[269,19,269,65,0],[269,66,269,67,0],[275,13,275,14,0],[276,17,278,98,0],[279,17,279,27,0],[280,13,280,14,0],[286,13,286,14,0],[287,17,287,45,0],[288,17,288,18,0],[289,21,291,80,0],[294,17,294,18,0],[295,21,297,58,0],[299,13,299,14,0],[302,41,302,45,0],[302,46,302,50,0],[305,9,305,10,0],[307,13,307,41,0],[308,13,308,14,0],[312,17,314,76,0],[317,13,317,14,0],[321,17,323,59,0],[325,9,325,10,0],[329,9,329,10,0],[330,13,330,38,0],[331,13,331,30,0],[332,13,332,26,0],[333,13,333,27,0],[335,13,335,14,0],[338,17,338,108,0],[339,21,339,68,0],[341,17,341,104,0],[342,21,342,84,0],[344,17,344,121,0],[345,21,345,69,0],[347,17,348,78,0],[349,21,349,69,0],[351,17,351,78,0],[352,21,352,96,0],[354,17,354,96,0],[355,21,356,152,0],[358,17,358,92,0],[359,21,360,184,0],[362,17,362,89,0],[363,21,364,154,0],[366,17,366,64,0],[367,21,368,165,0],[370,17,370,54,0],[371,17,371,18,0],[372,21,372,48,0],[373,25,374,77,0],[375,21,375,49,0],[376,21,376,22,0],[377,25,377,91,0],[378,29,378,113,0],[379,21,379,22,0],[381,21,381,22,0],[382,25,382,115,0],[383,29,384,110,0],[385,21,385,22,0],[386,17,386,18,0],[390,17,390,58,0],[391,17,391,18,0],[394,21,394,43,0],[395,21,395,114,0],[397,21,397,53,0],[398,21,398,75,0],[399,21,399,118,0],[401,21,401,73,0],[402,21,402,105,0],[403,21,403,50,0],[404,21,404,108,0],[408,21,408,88,0],[409,21,409,71,0],[410,21,412,52,0],[414,21,414,59,0],[415,21,415,22,0],[416,25,416,67,0],[418,25,418,68,0],[419,25,419,58,0],[420,25,421,124,0],[422,21,422,22,0],[424,21,424,47,0],[425,25,425,66,0],[429,21,429,118,0],[430,21,430,22,0],[431,30,431,39,0],[431,41,431,65,0],[431,67,431,70,0],[432,25,432,26,0],[433,29,433,77,0],[434,29,434,114,0],[435,29,435,69,0],[436,29,436,52,0],[437,29,437,44,0],[438,29,441,56,0],[442,29,442,36,0],[442,38,442,49,0],[442,50,442,52,0],[442,53,442,60,0],[443,29,443,30,0],[444,33,444,60,0],[445,33,445,75,0],[446,33,446,83,0],[447,33,447,87,0],[448,33,448,119,0],[449,33,449,120,0],[450,33,450,112,0],[451,33,451,117,0],[452,33,452,62,0],[453,37,453,95,0],[454,33,454,55,0],[455,29,455,30,0],[456,25,456,26,0],[457,21,457,22,0],[463,21,463,22,0],[464,30,464,39,0],[464,41,464,65,0],[464,67,464,70,0],[465,25,465,26,0],[466,29,466,57,0],[467,29,467,101,0],[468,29,468,74,0],[469,33,469,106,0],[470,29,470,78,0],[471,33,471,114,0],[472,29,472,43,0],[473,29,473,30,0],[474,33,474,114,0],[475,33,476,102,0],[477,29,477,30,0],[478,29,478,60,0],[479,29,479,30,0],[480,33,480,118,0],[481,33,483,106,0],[484,33,484,111,0],[485,29,485,30,0],[486,29,486,52,0],[487,25,487,26,0],[488,21,488,22,0],[492,21,492,58,0],[493,21,493,22,0],[494,25,494,44,0],[495,25,495,75,0],[496,21,496,22,0],[500,21,500,58,0],[501,26,501,35,0],[501,37,501,65,0],[501,67,501,70,0],[502,21,502,22,0],[503,30,503,39,0],[503,41,503,77,0],[503,79,503,82,0],[504,25,504,26,0],[505,29,505,85,0],[506,29,513,31,0],[514,29,514,61,0],[515,29,515,121,0],[516,25,516,26,0],[517,21,517,22,0],[523,21,523,54,0],[524,21,524,50,0],[525,21,525,22,0],[526,25,526,32,0],[526,34,526,50,0],[526,51,526,53,0],[526,54,526,80,0],[527,25,527,26,0],[529,29,529,51,0],[530,29,530,84,0],[531,33,532,65,0],[533,29,533,49,0],[533,50,533,59,0],[534,29,534,65,0],[536,29,550,31,0],[551,29,551,71,0],[552,25,552,26,0],[553,21,553,22,0],[559,21,559,47,0],[560,21,560,48,0],[561,21,561,28,0],[561,30,561,46,0],[561,47,561,49,0],[561,50,561,70,0],[562,21,562,22,0],[564,25,564,47,0],[565,25,565,65,0],[566,29,566,108,0],[567,25,567,45,0],[567,46,567,55,0],[569,25,577,27,0],[578,25,578,61,0],[579,25,579,65,0],[580,21,580,22,0],[582,21,582,28,0],[582,30,582,46,0],[582,47,582,49,0],[582,50,582,71,0],[583,21,583,22,0],[585,25,585,47,0],[586,25,586,65,0],[587,29,587,108,0],[588,25,588,45,0],[588,46,588,55,0],[590,25,598,27,0],[599,25,599,61,0],[600,25,600,66,0],[601,21,601,22,0],[603,21,603,70,0],[604,21,604,72,0],[609,21,609,71,0],[610,21,610,38,0],[611,25,611,94,0],[618,21,618,64,0],[619,21,619,22,0],[620,25,622,122,0],[623,25,623,80,0],[624,25,624,49,0],[625,21,625,22,0],[627,21,627,22,0],[628,25,628,76,0],[629,25,629,49,0],[630,21,630,22,0],[633,21,637,90,0],[639,21,639,71,0],[666,21,667,119,0],[669,21,669,71,0],[670,21,671,56,0],[673,21,673,114,0],[674,25,674,89,0],[675,17,675,18,0],[677,17,677,43,0],[678,21,678,60,0],[680,21,680,59,0],[682,17,682,29,0],[684,13,684,33,0],[685,13,685,14,0],[686,17,686,128,0],[687,17,687,30,0],[689,9,689,10,0],[694,9,694,10,0],[695,13,695,28,0],[696,13,696,27,0],[698,13,698,43,0],[699,17,699,63,0],[703,13,704,91,0],[705,17,706,41,0],[708,13,708,107,0],[709,17,710,41,0],[714,13,722,55,0],[726,13,726,117,0],[727,13,728,74,0],[729,17,729,49,0],[731,17,731,50,0],[737,13,737,68,0],[739,13,739,68,0],[740,13,740,74,0],[741,13,741,66,0],[742,13,742,84,0],[743,13,743,60,0],[744,13,744,57,0],[745,13,745,51,0],[746,13,746,59,0],[749,13,749,95,0],[750,13,750,103,0],[751,13,751,105,0],[752,13,752,106,0],[753,13,753,108,0],[756,13,756,122,0],[757,13,758,66,0],[759,13,759,108,0],[760,13,760,115,0],[761,13,761,115,0],[762,13,762,89,0],[763,13,763,90,0],[764,13,764,98,0],[765,13,766,71,0],[767,13,768,67,0],[769,13,770,74,0],[776,13,776,84,0],[778,13,778,84,0],[779,13,779,90,0],[780,13,780,82,0],[781,13,781,92,0],[782,13,782,72,0],[783,13,783,65,0],[784,13,784,59,0],[785,13,785,75,0],[788,13,788,97,0],[789,13,789,109,0],[790,13,790,101,0],[791,13,791,110,0],[794,13,794,114,0],[795,13,796,75,0],[802,13,802,74,0],[803,13,803,73,0],[804,13,804,80,0],[805,13,805,72,0],[806,13,806,87,0],[807,13,807,62,0],[808,13,808,60,0],[809,13,809,53,0],[810,13,810,51,0],[811,13,811,117,0],[812,13,812,65,0],[814,13,814,85,0],[815,13,815,74,0],[816,13,816,114,0],[818,13,818,114,0],[820,13,820,101,0],[821,13,821,105,0],[822,13,822,163,0],[823,13,823,114,0],[824,13,825,70,0],[826,13,827,72,0],[828,13,828,162,0],[829,13,829,92,0],[830,13,830,106,0],[831,13,831,96,0],[832,13,833,72,0],[834,13,835,80,0],[837,13,837,100,0],[838,13,838,99,0],[839,13,839,117,0],[840,13,840,106,0],[841,13,841,178,0],[842,13,843,79,0],[849,13,849,84,0],[850,13,850,77,0],[851,13,851,84,0],[852,13,852,76,0],[853,13,853,89,0],[854,13,854,64,0],[855,13,855,62,0],[856,13,856,55,0],[857,13,857,53,0],[858,13,858,123,0],[859,13,859,69,0],[861,13,861,103,0],[862,13,862,101,0],[863,13,863,110,0],[864,13,864,168,0],[865,13,866,79,0],[867,13,868,81,0],[869,13,870,77,0],[871,13,871,98,0],[872,13,872,102,0],[873,13,873,102,0],[874,13,874,100,0],[875,13,875,107,0],[876,13,877,77,0],[878,13,880,122,0],[881,13,882,81,0],[883,13,883,122,0],[884,13,885,117,0],[886,13,887,113,0],[888,13,888,183,0],[889,13,889,136,0],[895,13,895,80,0],[896,13,896,74,0],[897,13,897,80,0],[898,13,898,72,0],[899,13,899,87,0],[900,13,900,60,0],[901,13,901,60,0],[902,13,902,51,0],[903,13,903,53,0],[904,13,904,57,0],[905,13,905,65,0],[911,13,911,99,0],[912,13,912,96,0],[913,13,913,96,0],[914,13,914,95,0],[915,13,915,100,0],[916,13,916,98,0],[917,13,917,100,0],[918,13,922,123,0],[923,13,923,120,0],[924,13,925,79,0],[926,13,926,145,0],[927,13,928,115,0],[929,13,932,120,0],[933,13,935,120,0],[936,13,938,120,0],[939,13,939,168,0],[941,13,942,67,0],[943,13,943,108,0],[949,13,949,57,0],[950,13,950,14,0],[952,17,952,62,0],[953,21,953,44,0],[954,13,954,14,0],[958,13,958,55,0],[959,13,959,45,0],[963,13,963,146,0],[966,9,966,10,0],[969,9,969,10,0],[970,13,970,107,0],[971,13,971,30,0],[974,21,974,41,0],[975,21,975,27,0],[977,21,977,42,0],[978,21,978,27,0],[980,21,980,42,0],[981,21,981,27,0],[983,9,983,10,0],[986,9,986,10,0],[989,13,989,40,0],[991,13,994,107,0],[995,13,995,39,0],[996,13,996,14,0],[997,17,998,56,0],[999,13,999,14,0],[1001,17,1001,24,0],[1003,13,1003,87,0],[1005,13,1007,46,0],[1008,13,1008,77,0],[1009,13,1009,86,0],[1011,13,1011,89,0],[1012,13,1012,73,0],[1013,13,1015,79,0],[1016,13,1016,44,0],[1017,13,1017,27,0],[1018,13,1019,58,0],[1020,13,1020,14,0],[1021,17,1021,101,0],[1022,13,1022,14,0],[1023,9,1023,10,0],[1026,9,1026,10,0],[1027,13,1027,70,0],[1028,13,1028,86,0],[1029,13,1029,70,0],[1030,13,1030,73,0],[1031,13,1031,78,0],[1032,13,1032,82,0],[1034,13,1034,48,0],[1035,17,1035,39,0],[1037,13,1037,29,0],[1044,21,1044,49,0],[1045,21,1045,27,0],[1047,21,1047,48,0],[1048,21,1048,27,0],[1050,9,1050,10,0],[1053,9,1053,10,0],[1054,13,1054,35,0],[1055,9,1055,10,0],[1058,9,1058,10,0],[1059,13,1062,103,0],[1063,13,1072,101,0],[1074,13,1076,103,0],[1077,13,1077,122,0],[1079,13,1079,73,0],[1080,13,1080,14,0],[1081,17,1083,115,0],[1084,17,1086,110,0],[1087,13,1087,14,0],[1088,13,1088,58,0],[1089,13,1089,14,0],[1090,17,1090,121,0],[1091,17,1091,119,0],[1092,13,1092,14,0],[1093,13,1093,74,0],[1094,13,1094,14,0],[1095,17,1097,116,0],[1098,17,1100,111,0],[1101,13,1101,14,0],[1102,13,1102,59,0],[1103,13,1103,14,0],[1104,17,1104,122,0],[1105,17,1105,120,0],[1106,13,1106,14,0],[1107,13,1107,49,0],[1108,13,1108,14,0],[1109,17,1109,60,0],[1110,17,1110,48,0],[1111,17,1111,18,0],[1112,21,1112,78,0],[1113,21,1113,83,0],[1114,17,1114,18,0],[1115,13,1115,14,0],[1116,13,1116,47,0],[1117,13,1117,61,0],[1118,13,1118,14,0],[1119,17,1119,72,0],[1120,17,1120,55,0],[1121,17,1121,18,0],[1122,21,1122,85,0],[1123,21,1123,90,0],[1124,17,1124,18,0],[1125,17,1125,56,0],[1126,17,1126,18,0],[1127,21,1127,86,0],[1128,21,1128,91,0],[1129,17,1129,18,0],[1130,13,1130,14,0],[1131,13,1131,50,0],[1132,13,1132,14,0],[1133,17,1133,61,0],[1134,17,1134,47,0],[1135,17,1135,18,0],[1136,21,1136,77,0],[1137,21,1137,82,0],[1138,17,1138,18,0],[1139,13,1139,14,0],[1140,9,1140,10,0],[1143,9,1143,10,0],[1144,13,1144,77,0],[1145,13,1145,79,0],[1146,13,1146,80,0],[1147,13,1147,79,0],[1149,13,1149,29,0],[1150,13,1150,14,0],[1151,17,1151,48,0],[1153,17,1153,96,0],[1154,17,1154,132,0],[1155,17,1155,136,0],[1156,17,1156,130,0],[1157,17,1157,65,0],[1162,17,1166,81,0],[1170,17,1170,53,0],[1176,17,1176,52,0],[1178,17,1178,90,0],[1179,17,1179,93,0],[1180,17,1180,85,0],[1181,17,1181,54,0],[1182,17,1182,113,0],[1183,17,1183,122,0],[1184,17,1184,80,0],[1188,17,1188,53,0],[1192,17,1192,43,0],[1193,17,1201,59,0],[1202,17,1206,122,0],[1207,17,1211,46,0],[1213,17,1213,35,0],[1214,17,1214,68,0],[1215,17,1215,18,0],[1216,21,1216,47,0],[1218,21,1221,80,0],[1223,21,1223,88,0],[1224,21,1224,22,0],[1225,25,1225,61,0],[1226,21,1226,22,0],[1228,21,1228,22,0],[1229,25,1229,61,0],[1230,21,1230,22,0],[1231,21,1231,67,0],[1235,21,1238,26,0],[1239,21,1239,22,0],[1242,25,1242,57,0],[1243,21,1243,22,0],[1244,17,1244,18,0],[1246,17,1246,18,0],[1247,21,1250,95,0],[1251,21,1251,64,0],[1252,21,1252,22,0],[1253,25,1253,61,0],[1254,25,1254,115,0],[1255,25,1255,43,0],[1256,25,1256,68,0],[1257,25,1257,105,0],[1258,25,1258,53,0],[1260,25,1260,72,0],[1261,21,1261,22,0],[1263,21,1263,22,0],[1265,25,1265,71,0],[1266,21,1266,22,0],[1267,21,1267,71,0],[1268,17,1268,18,0],[1272,17,1272,58,0],[1273,21,1273,112,0],[1277,17,1277,54,0],[1278,17,1278,47,0],[1279,17,1281,136,0],[1282,17,1282,48,0],[1283,17,1283,56,0],[1284,17,1284,57,0],[1286,17,1286,44,0],[1287,17,1287,18,0],[1288,21,1288,56,0],[1289,17,1289,18,0],[1291,17,1292,63,0],[1294,17,1294,68,0],[1295,17,1295,18,0],[1299,21,1299,76,0],[1300,21,1300,22,0],[1302,25,1302,26,0],[1303,29,1305,87,0],[1306,29,1306,30,0],[1309,33,1309,54,0],[1310,29,1310,30,0],[1311,29,1311,110,0],[1312,25,1312,26,0],[1313,25,1313,30,0],[1314,25,1314,26,0],[1315,29,1320,39,0],[1321,25,1321,26,0],[1322,21,1322,22,0],[1324,25,1329,35,0],[1333,21,1333,55,0],[1337,21,1337,73,0],[1338,25,1339,105,0],[1340,21,1340,67,0],[1341,21,1341,51,0],[1342,21,1342,78,0],[1343,21,1343,65,0],[1346,21,1346,101,0],[1347,25,1347,65,0],[1349,25,1349,66,0],[1351,21,1351,62,0],[1361,21,1361,88,0],[1363,21,1363,116,0],[1369,21,1369,49,0],[1370,21,1370,66,0],[1371,21,1371,22,0],[1372,25,1372,75,0],[1373,25,1375,103,0],[1376,25,1376,26,0],[1377,29,1379,105,0],[1380,25,1380,26,0],[1381,21,1381,22,0],[1382,26,1382,87,0],[1383,21,1383,22,0],[1384,25,1384,110,0],[1385,21,1385,22,0],[1386,21,1386,71,0],[1392,21,1392,105,0],[1394,21,1394,57,0],[1400,21,1400,53,0],[1401,21,1401,22,0],[1402,25,1402,46,0],[1403,25,1403,61,0],[1404,25,1404,96,0],[1405,25,1405,105,0],[1406,25,1406,56,0],[1407,25,1407,26,0],[1408,29,1408,97,0],[1409,29,1409,30,0],[1410,33,1410,73,0],[1412,33,1412,34,0],[1413,37,1413,111,0],[1414,33,1414,34,0],[1415,33,1415,61,0],[1416,33,1416,34,0],[1417,37,1417,50,0],[1418,33,1418,34,0],[1419,29,1419,30,0],[1421,29,1421,30,0],[1422,33,1425,81,0],[1426,33,1426,63,0],[1427,38,1427,47,0],[1427,49,1427,76,0],[1427,78,1427,81,0],[1428,33,1428,34,0],[1429,37,1429,97,0],[1431,37,1431,107,0],[1432,37,1432,38,0],[1433,41,1485,85,0],[1486,37,1486,38,0],[1487,42,1487,73,0],[1488,37,1488,38,0],[1489,41,1538,85,0],[1539,37,1539,38,0],[1541,37,1541,38,0],[1542,41,1591,85,0],[1592,37,1592,38,0],[1593,33,1593,34,0],[1600,33,1601,103,0],[1602,33,1602,34,0],[1603,37,1603,72,0],[1604,33,1604,34,0],[1605,29,1605,30,0],[1606,25,1606,26,0],[1608,25,1608,26,0],[1609,29,1609,65,0],[1610,29,1610,50,0],[1611,29,1611,103,0],[1612,29,1612,73,0],[1613,25,1613,26,0],[1617,25,1618,133,0],[1619,25,1619,112,0],[1620,25,1620,88,0],[1621,21,1621,22,0],[1623,21,1623,22,0],[1624,25,1624,60,0],[1625,25,1625,95,0],[1626,25,1626,105,0],[1627,25,1632,80,0],[1633,21,1633,22,0],[1639,21,1639,65,0],[1640,21,1640,61,0],[1641,21,1643,65,0],[1647,21,1647,37,0],[1651,21,1655,93,0],[1661,21,1661,50,0],[1662,21,1662,22,0],[1663,25,1667,103,0],[1668,21,1668,22,0],[1674,21,1675,120,0],[1682,21,1682,94,0],[1683,21,1683,33,0],[1684,21,1684,22,0],[1685,25,1685,93,0],[1686,25,1686,54,0],[1687,25,1687,51,0],[1688,29,1688,78,0],[1689,25,1691,74,0],[1692,21,1692,22,0],[1694,21,1694,47,0],[1695,21,1695,22,0],[1696,25,1696,96,0],[1697,29,1697,75,0],[1698,25,1698,76,0],[1701,25,1701,92,0],[1702,29,1702,103,0],[1704,29,1704,107,0],[1705,25,1707,116,0],[1708,25,1710,119,0],[1712,25,1712,77,0],[1713,25,1713,26,0],[1714,29,1714,112,0],[1715,29,1715,107,0],[1716,25,1716,26,0],[1718,25,1718,78,0],[1719,25,1719,106,0],[1720,21,1720,22,0],[1721,17,1721,18,0],[1725,17,1725,88,0],[1726,17,1727,93,0],[1728,17,1728,18,0],[1729,21,1729,92,0],[1730,21,1730,67,0],[1731,21,1731,71,0],[1732,17,1732,18,0],[1734,17,1734,18,0],[1735,21,1735,59,0],[1736,21,1736,22,0],[1737,25,1737,76,0],[1738,29,1738,106,0],[1739,25,1739,71,0],[1740,25,1740,75,0],[1741,21,1741,22,0],[1742,17,1742,18,0],[1746,17,1746,39,0],[1748,17,1751,79,0],[1753,17,1753,52,0],[1754,17,1754,18,0],[1755,21,1755,45,0],[1756,21,1756,121,0],[1757,21,1757,110,0],[1759,21,1759,96,0],[1760,21,1760,130,0],[1762,21,1762,100,0],[1763,21,1765,105,0],[1766,21,1766,124,0],[1768,21,1768,137,0],[1770,21,1770,111,0],[1772,21,1772,49,0],[1773,21,1773,22,0],[1774,25,1774,141,0],[1775,21,1775,22,0],[1777,21,1777,22,0],[1778,25,1778,145,0],[1779,21,1779,22,0],[1780,21,1780,50,0],[1782,21,1782,56,0],[1783,17,1783,18,0],[1785,17,1785,18,0],[1786,21,1786,46,0],[1787,21,1787,159,0],[1788,21,1788,78,0],[1789,17,1789,18,0],[1792,17,1792,52,0],[1793,17,1793,18,0],[1794,21,1794,182,0],[1795,21,1795,148,0],[1796,17,1796,18,0],[1798,21,1798,137,0],[1800,17,1800,52,0],[1801,17,1801,18,0],[1802,21,1802,159,0],[1803,21,1803,158,0],[1805,21,1805,48,0],[1807,21,1807,135,0],[1808,17,1808,18,0],[1810,17,1810,68,0],[1811,17,1811,18,0],[1812,21,1812,43,0],[1813,21,1813,73,0],[1814,21,1814,22,0],[1815,25,1815,91,0],[1816,25,1816,99,0],[1817,21,1817,22,0],[1818,17,1818,18,0],[1820,17,1820,50,0],[1821,17,1821,99,0],[1822,17,1822,39,0],[1823,17,1823,136,0],[1824,21,1824,104,0],[1825,17,1825,72,0],[1826,17,1826,113,0],[1827,17,1827,45,0],[1828,21,1828,53,0],[1829,17,1829,108,0],[1831,17,1831,46,0],[1832,17,1832,42,0],[1833,17,1833,18,0],[1834,21,1834,57,0],[1835,21,1836,59,0],[1837,25,1837,68,0],[1838,26,1838,57,0],[1839,25,1839,41,0],[1841,25,1841,54,0],[1842,17,1842,18,0],[1843,17,1843,61,0],[1844,17,1844,18,0],[1845,21,1845,58,0],[1846,21,1846,47,0],[1847,17,1847,18,0],[1849,17,1849,18,0],[1850,21,1850,57,0],[1851,21,1851,46,0],[1853,21,1855,52,0],[1856,21,1856,46,0],[1857,21,1857,50,0],[1858,21,1858,59,0],[1859,21,1859,22,0],[1860,25,1860,67,0],[1862,25,1862,64,0],[1863,25,1863,54,0],[1864,21,1864,22,0],[1865,21,1866,96,0],[1867,17,1867,18,0],[1871,17,1871,46,0],[1872,21,1872,62,0],[1873,25,1873,77,0],[1875,17,1875,60,0],[1876,21,1876,141,0],[1880,17,1880,113,0],[1881,17,1881,93,0],[1882,17,1882,95,0],[1883,17,1883,58,0],[1884,13,1884,14,0],[1886,13,1886,14,0],[1887,17,1887,39,0],[1888,17,1888,69,0],[1889,13,1889,14,0],[1890,13,1890,33,0],[1891,17,1891,63,0],[1892,13,1892,138,0],[1893,13,1893,141,0],[1894,9,1894,10,0],[1897,9,1897,10,0],[1898,13,1898,57,0],[1901,13,1901,62,0],[1902,13,1902,65,0],[1903,13,1903,103,0],[1906,13,1906,56,0],[1907,13,1907,133,0],[1908,13,1908,77,0],[1909,13,1911,140,0],[1913,13,1913,41,0],[1915,13,1915,56,0],[1916,13,1916,14,0],[1917,17,1917,69,0],[1919,17,1919,83,0],[1921,17,1921,87,0],[1922,17,1922,141,0],[1924,17,1924,84,0],[1925,17,1925,138,0],[1927,17,1927,88,0],[1928,17,1928,139,0],[1930,17,1930,65,0],[1931,17,1931,81,0],[1932,17,1932,136,0],[1934,17,1934,43,0],[1935,17,1935,139,0],[1938,17,1938,44,0],[1939,13,1939,14,0],[1941,13,1941,64,0],[1942,13,1942,14,0],[1943,17,1943,71,0],[1944,17,1944,18,0],[1945,21,1945,51,0],[1946,21,1946,122,0],[1947,21,1947,48,0],[1948,25,1948,127,0],[1950,21,1950,102,0],[1951,21,1951,100,0],[1952,21,1952,162,0],[1953,17,1953,18,0],[1954,17,1954,43,0],[1955,17,1955,18,0],[1956,21,1957,83,0],[1958,21,1958,50,0],[1959,17,1959,18,0],[1960,13,1960,14,0],[1961,9,1961,10,0],[1964,9,1964,10,0],[1966,13,1966,76,0],[1967,13,1967,65,0],[1968,13,1968,68,0],[1969,9,1969,10,0],[1972,9,1972,10,0],[1973,13,1973,35,0],[1974,13,1974,39,0],[1975,13,1975,89,0],[1977,13,1977,41,0],[1978,13,1978,39,0],[1979,17,1979,38,0],[1984,13,1984,82,0],[1985,13,1985,44,0],[1986,13,1986,31,0],[1987,9,1987,10,0],[1990,9,1990,10,0],[1992,13,1992,108,0],[1995,13,1996,101,0],[1997,9,1997,10,0],[2000,9,2000,10,0],[2001,13,2001,39,0],[2002,13,2002,14,0],[2003,17,2003,35,0],[2004,17,2004,18,0],[2005,21,2005,82,0],[2006,21,2006,41,0],[2007,21,2007,22,0],[2008,25,2008,64,0],[2009,25,2009,37,0],[2010,29,2010,82,0],[2011,21,2011,22,0],[2012,17,2012,18,0],[2013,13,2013,14,0],[2014,18,2014,44,0],[2015,13,2015,14,0],[2016,17,2016,69,0],[2017,21,2017,92,0],[2018,13,2018,14,0],[2019,13,2019,67,0],[2020,13,2020,14,0],[2021,17,2021,82,0],[2022,17,2022,84,0],[2023,13,2023,14,0],[2025,13,2025,63,0],[2026,13,2026,14,0],[2027,17,2027,35,0],[2028,17,2028,18,0],[2029,21,2029,82,0],[2030,21,2030,41,0],[2031,21,2031,22,0],[2032,25,2032,57,0],[2033,21,2033,22,0],[2034,17,2034,18,0],[2035,13,2035,14,0],[2036,9,2036,10,0],[2039,9,2039,10,0],[2042,13,2042,38,0],[2043,13,2043,25,0],[2044,13,2044,83,0],[2045,17,2045,37,0],[2047,17,2047,36,0],[2048,13,2048,42,0],[2049,13,2049,67,0],[2050,17,2050,76,0],[2052,17,2052,39,0],[2053,13,2054,105,0],[2055,13,2055,57,0],[2057,13,2057,87,0],[2060,13,2060,58,0],[2061,17,2062,41,0],[2065,13,2065,54,0],[2067,13,2067,51,0],[2068,17,2068,44,0],[2070,17,2072,61,0],[2074,13,2074,60,0],[2075,17,2075,49,0],[2077,17,2077,81,0],[2079,13,2079,53,0],[2082,13,2082,70,0],[2083,13,2083,14,0],[2084,17,2084,146,0],[2085,13,2085,14,0],[2088,9,2088,10,0],[2091,9,2091,10,0],[2092,13,2092,95,0],[2093,13,2093,14,0],[2094,13,2094,38,0],[2095,13,2095,14,0],[2096,17,2096,50,0],[2097,13,2097,14,0],[2098,18,2098,44,0],[2099,13,2099,14,0],[2100,17,2100,51,0],[2101,13,2101,14,0],[2102,18,2102,44,0],[2103,13,2103,14,0],[2104,17,2104,51,0],[2105,13,2105,14,0],[2106,9,2106,10,0],[2109,9,2109,10,0],[2110,13,2110,31,0],[2111,13,2111,54,0],[2113,13,2113,50,0],[2114,13,2114,48,0],[2115,13,2115,83,0],[2116,13,2116,93,0],[2117,9,2117,10,0],[2120,9,2120,10,0],[2122,13,2122,14,0],[2125,17,2125,44,0],[2126,21,2126,68,0],[2128,17,2128,42,0],[2129,21,2129,84,0],[2131,17,2131,53,0],[2132,21,2132,69,0],[2134,17,2134,99,0],[2135,21,2135,69,0],[2137,17,2139,66,0],[2140,17,2140,18,0],[2141,21,2141,107,0],[2144,17,2150,68,0],[2151,17,2151,18,0],[2152,21,2152,107,0],[2159,17,2159,61,0],[2160,17,2160,57,0],[2161,17,2161,121,0],[2162,17,2162,53,0],[2166,17,2166,43,0],[2170,17,2172,48,0],[2173,17,2173,42,0],[2174,17,2174,46,0],[2176,17,2176,55,0],[2177,17,2177,18,0],[2178,21,2178,63,0],[2180,21,2180,60,0],[2181,21,2181,50,0],[2182,17,2182,18,0],[2188,17,2189,79,0],[2195,17,2195,113,0],[2201,17,2201,46,0],[2202,17,2202,18,0],[2203,21,2204,75,0],[2205,17,2205,18,0],[2208,13,2208,14,0],[2209,13,2209,33,0],[2210,13,2210,14,0],[2211,17,2211,44,0],[2212,13,2212,14,0],[2213,9,2213,10,0],[2217,9,2217,10,0],[2219,13,2219,33,0],[2223,13,2223,62,0],[2225,13,2227,87,0],[2228,13,2228,59,0],[2229,13,2229,14,0],[2230,17,2239,131,0],[2240,13,2240,14,0],[2241,18,2241,48,0],[2242,13,2242,14,0],[2244,17,2244,35,0],[2246,17,2246,135,0],[2249,13,2249,14,0],[2250,18,2250,48,0],[2251,13,2251,14,0],[2252,17,2262,74,0],[2263,13,2263,14,0],[2265,13,2265,14,0],[2268,17,2268,89,0],[2269,17,2269,18,0],[2270,21,2281,78,0],[2283,21,2283,79,0],[2284,21,2284,41,0],[2285,25,2285,53,0],[2287,21,2287,22,0],[2288,25,2288,51,0],[2289,25,2289,43,0],[2290,21,2290,22,0],[2291,17,2291,18,0],[2292,22,2292,41,0],[2293,17,2293,18,0],[2295,21,2295,124,0],[2296,21,2296,38,0],[2297,17,2297,18,0],[2299,17,2299,18,0],[2301,21,2301,39,0],[2303,21,2303,139,0],[2305,17,2305,18,0],[2306,13,2306,14,0],[2312,13,2312,49,0],[2313,13,2313,14,0],[2314,17,2314,35,0],[2315,17,2315,38,0],[2316,17,2316,48,0],[2317,17,2317,53,0],[2318,17,2318,88,0],[2319,17,2319,97,0],[2320,17,2320,48,0],[2321,17,2321,18,0],[2322,21,2325,69,0],[2327,21,2327,51,0],[2328,26,2328,35,0],[2328,37,2328,54,0],[2328,56,2328,59,0],[2329,21,2329,22,0],[2330,25,2330,75,0],[2332,25,2332,61,0],[2333,25,2333,26,0],[2334,29,2371,73,0],[2372,25,2372,26,0],[2373,30,2373,61,0],[2374,25,2374,26,0],[2375,29,2412,73,0],[2413,25,2413,26,0],[2415,25,2415,26,0],[2416,29,2456,73,0],[2457,25,2457,26,0],[2458,21,2458,22,0],[2459,21,2459,56,0],[2460,21,2460,22,0],[2461,25,2461,60,0],[2462,21,2462,22,0],[2463,17,2463,18,0],[2465,17,2465,18,0],[2466,21,2466,47,0],[2467,21,2467,42,0],[2468,21,2468,85,0],[2469,21,2469,65,0],[2470,17,2470,18,0],[2471,17,2471,63,0],[2472,21,2472,86,0],[2474,17,2474,47,0],[2475,17,2475,137,0],[2476,17,2476,104,0],[2477,17,2477,80,0],[2479,17,2479,50,0],[2481,17,2484,77,0],[2485,13,2485,14,0],[2486,18,2486,105,0],[2487,13,2487,14,0],[2489,17,2492,118,0],[2493,17,2493,52,0],[2494,17,2494,87,0],[2495,17,2495,97,0],[2496,13,2496,14,0],[2498,13,2498,14,0],[2499,17,2499,33,0],[2500,17,2500,18,0],[2501,21,2501,116,0],[2502,21,2502,56,0],[2503,21,2503,91,0],[2504,17,2504,18,0],[2505,17,2505,97,0],[2506,17,2506,47,0],[2507,21,2507,64,0],[2508,13,2508,14,0],[2511,9,2511,10,0],[2514,9,2514,10,0],[2515,13,2515,56,0],[2516,13,2516,37,0],[2516,38,2516,113,0],[2517,13,2517,39,0],[2517,40,2517,90,0],[2518,13,2518,42,0],[2518,43,2518,101,0],[2519,13,2519,47,0],[2519,48,2519,113,0],[2520,13,2520,49,0],[2521,17,2521,97,0],[2522,13,2522,41,0],[2522,42,2522,125,0],[2523,13,2523,37,0],[2523,38,2523,119,0],[2524,13,2524,39,0],[2524,40,2524,119,0],[2525,13,2525,42,0],[2525,43,2525,83,0],[2526,13,2526,44,0],[2526,45,2526,87,0],[2527,9,2527,10,0],[2530,9,2530,10,0],[2531,13,2531,56,0],[2532,13,2532,44,0],[2533,13,2533,14,0],[2534,17,2534,105,0],[2535,17,2535,75,0],[2536,17,2536,80,0],[2537,17,2537,95,0],[2538,17,2540,100,0],[2541,13,2541,14,0],[2542,13,2542,48,0],[2543,13,2543,14,0],[2544,17,2544,99,0],[2545,17,2545,109,0],[2546,17,2548,104,0],[2549,17,2549,89,0],[2550,17,2550,102,0],[2551,17,2551,92,0],[2552,13,2552,14,0],[2553,13,2553,42,0],[2554,13,2554,14,0],[2555,17,2555,93,0],[2556,17,2556,103,0],[2557,17,2557,83,0],[2558,17,2558,96,0],[2559,17,2559,86,0],[2560,13,2560,14,0],[2561,13,2561,41,0],[2562,13,2562,14,0],[2563,17,2563,95,0],[2564,17,2564,85,0],[2565,17,2565,100,0],[2567,17,2567,92,0],[2568,17,2568,82,0],[2569,13,2569,14,0],[2570,13,2570,20,0],[2570,22,2570,38,0],[2570,39,2570,41,0],[2570,42,2570,56,0],[2571,13,2571,14,0],[2572,17,2576,55,0],[2577,17,2577,115,0],[2578,17,2579,87,0],[2580,17,2580,85,0],[2581,13,2581,14,0],[2582,13,2582,42,0],[2583,13,2583,14,0],[2584,17,2584,47,0],[2585,17,2585,60,0],[2586,17,2586,80,0],[2587,13,2587,14,0],[2589,13,2589,43,0],[2590,13,2590,14,0],[2592,17,2592,73,0],[2593,17,2593,96,0],[2594,13,2594,14,0],[2596,9,2596,10,0],[2600,9,2600,10,0],[2601,13,2601,41,0],[2602,13,2602,49,0],[2603,13,2603,26,0],[2604,9,2604,10,0],[2608,9,2608,10,0],[2609,13,2609,41,0],[2610,13,2610,49,0],[2611,13,2611,26,0],[2612,9,2612,10,0],[2615,9,2615,10,0],[2616,13,2616,105,0],[2618,13,2618,41,0],[2619,17,2619,24,0],[2621,13,2621,45,0],[2622,13,2622,32,0],[2623,13,2623,43,0],[2624,13,2624,31,0],[2625,13,2625,35,0],[2627,13,2627,85,0],[2628,13,2628,14,0],[2629,17,2629,45,0],[2630,17,2630,36,0],[2631,17,2631,48,0],[2632,17,2632,101,0],[2633,17,2633,39,0],[2634,13,2634,14,0],[2636,13,2636,41,0],[2637,13,2637,39,0],[2638,13,2640,56,0],[2641,13,2641,66,0],[2642,13,2642,35,0],[2644,13,2644,73,0],[2645,13,2645,14,0],[2646,17,2646,45,0],[2647,17,2647,40,0],[2648,17,2648,35,0],[2649,17,2649,39,0],[2651,17,2651,45,0],[2652,17,2652,38,0],[2653,17,2653,49,0],[2654,17,2654,39,0],[2655,13,2655,14,0],[2657,13,2657,41,0],[2658,13,2658,32,0],[2659,13,2659,43,0],[2660,13,2660,96,0],[2661,13,2661,35,0],[2663,13,2663,41,0],[2664,13,2664,36,0],[2665,13,2665,48,0],[2666,13,2666,71,0],[2667,13,2667,87,0],[2668,13,2668,35,0],[2670,13,2670,41,0],[2671,13,2671,35,0],[2672,13,2672,31,0],[2673,13,2673,46,0],[2674,13,2674,35,0],[2676,13,2676,41,0],[2677,13,2677,38,0],[2678,13,2678,44,0],[2679,13,2679,54,0],[2680,13,2680,35,0],[2682,13,2682,41,0],[2683,13,2683,44,0],[2684,13,2684,121,0],[2685,13,2685,78,0],[2686,17,2686,35,0],[2687,13,2687,35,0],[2689,13,2689,41,0],[2690,13,2690,37,0],[2691,13,2691,108,0],[2692,13,2692,35,0],[2694,13,2694,41,0],[2695,13,2695,34,0],[2696,13,2698,51,0],[2699,13,2699,70,0],[2700,13,2700,60,0],[2701,13,2701,75,0],[2702,13,2702,67,0],[2703,13,2703,57,0],[2704,13,2704,35,0],[2706,13,2706,41,0],[2707,13,2707,57,0],[2708,13,2708,70,0],[2709,13,2709,60,0],[2710,13,2710,75,0],[2711,13,2711,67,0],[2712,13,2712,57,0],[2713,13,2713,88,0],[2714,13,2714,35,0],[2716,13,2716,41,0],[2717,13,2717,36,0],[2718,13,2718,46,0],[2719,13,2719,35,0],[2721,13,2721,41,0],[2722,13,2722,35,0],[2723,13,2723,47,0],[2724,13,2724,70,0],[2725,13,2725,60,0],[2726,13,2726,77,0],[2727,13,2727,67,0],[2728,13,2728,57,0],[2729,13,2729,55,0],[2729,56,2729,74,0],[2730,13,2730,35,0],[2732,13,2732,41,0],[2733,13,2733,41,0],[2734,13,2734,52,0],[2735,13,2735,70,0],[2736,13,2736,60,0],[2737,13,2737,77,0],[2738,13,2738,67,0],[2739,13,2739,57,0],[2740,13,2740,35,0],[2742,13,2742,41,0],[2743,13,2743,37,0],[2744,13,2744,50,0],[2745,13,2745,70,0],[2746,13,2746,60,0],[2747,13,2747,77,0],[2748,13,2748,67,0],[2749,13,2749,57,0],[2750,13,2750,47,0],[2751,13,2751,35,0],[2753,13,2753,41,0],[2754,13,2754,32,0],[2755,13,2755,43,0],[2756,13,2756,70,0],[2757,13,2757,60,0],[2758,13,2758,73,0],[2759,13,2759,67,0],[2760,13,2760,57,0],[2761,13,2761,35,0],[2763,13,2763,41,0],[2764,13,2764,34,0],[2765,13,2765,45,0],[2766,13,2766,31,0],[2767,13,2767,35,0],[2769,13,2769,76,0],[2770,13,2770,14,0],[2771,17,2771,45,0],[2772,17,2772,56,0],[2773,17,2773,35,0],[2774,17,2774,39,0],[2776,17,2776,45,0],[2777,17,2777,35,0],[2778,17,2778,46,0],[2779,17,2779,39,0],[2780,13,2780,14,0],[2781,9,2781,10,0],[2784,9,2784,10,0],[2785,13,2785,38,0],[2786,13,2786,38,0],[2787,13,2787,41,0],[2788,13,2788,41,0],[2789,13,2789,36,0],[2790,13,2790,46,0],[2791,13,2791,48,0],[2792,13,2792,40,0],[2793,13,2793,36,0],[2794,13,2794,45,0],[2795,13,2795,38,0],[2796,13,2796,39,0],[2797,13,2797,34,0],[2798,13,2798,57,0],[2799,9,2799,10,0],[2802,9,2802,10,0],[2805,13,2805,82,0],[2806,13,2808,56,0],[2809,13,2809,84,0],[2810,9,2810,10,0],[2813,9,2813,10,0],[2815,13,2815,14,0],[2818,17,2820,48,0],[2821,17,2821,42,0],[2822,17,2822,46,0],[2824,17,2824,55,0],[2825,17,2825,18,0],[2826,21,2826,63,0],[2828,21,2828,60,0],[2829,21,2829,50,0],[2830,17,2830,18,0],[2834,17,2834,48,0],[2835,17,2835,41,0],[2837,17,2837,115,0],[2839,22,2839,31,0],[2839,33,2839,57,0],[2839,59,2839,62,0],[2840,17,2840,18,0],[2841,21,2841,82,0],[2842,21,2842,22,0],[2843,25,2843,41,0],[2844,29,2844,61,0],[2848,25,2848,56,0],[2849,25,2849,26,0],[2850,29,2850,43,0],[2851,29,2852,119,0],[2853,29,2853,30,0],[2854,38,2854,47,0],[2854,49,2854,73,0],[2854,75,2854,78,0],[2855,33,2855,34,0],[2856,37,2856,48,0],[2857,41,2857,50,0],[2858,37,2858,55,0],[2859,37,2863,99,0],[2864,37,2864,38,0],[2865,41,2868,62,0],[2869,41,2869,69,0],[2870,37,2870,38,0],[2871,33,2871,34,0],[2872,29,2872,30,0],[2873,25,2873,26,0],[2877,25,2877,43,0],[2878,25,2880,115,0],[2881,25,2881,53,0],[2882,21,2882,22,0],[2883,17,2883,18,0],[2884,17,2884,32,0],[2885,17,2885,18,0],[2886,26,2886,35,0],[2886,37,2886,51,0],[2886,53,2886,56,0],[2887,21,2887,22,0],[2888,25,2888,56,0],[2889,21,2889,22,0],[2890,17,2890,18,0],[2892,17,2892,41,0],[2893,17,2893,139,0],[2894,17,2894,104,0],[2896,17,2896,48,0],[2897,17,2897,47,0],[2900,17,2900,33,0],[2901,21,2905,64,0],[2907,17,2907,47,0],[2908,17,2908,18,0],[2910,21,2910,62,0],[2911,21,2911,56,0],[2912,21,2912,91,0],[2913,21,2913,101,0],[2914,17,2914,18,0],[2918,17,2918,50,0],[2919,13,2919,14,0],[2920,13,2920,33,0],[2921,13,2921,14,0],[2922,17,2922,44,0],[2923,13,2923,14,0],[2924,9,2924,10,0],[2927,9,2927,10,0],[2929,13,2929,14,0],[2930,17,2930,50,0],[2931,13,2931,14,0],[2932,13,2932,33,0],[2933,13,2933,14,0],[2934,17,2934,128,0],[2935,13,2935,14,0],[2936,9,2936,10,0],[2939,9,2939,10,0],[2940,13,2940,38,0],[2941,13,2941,96,0],[2942,13,2945,58,0],[2946,13,2946,14,0],[2947,22,2947,31,0],[2947,33,2947,61,0],[2947,63,2947,66,0],[2948,17,2948,18,0],[2949,21,2949,69,0],[2950,21,2950,113,0],[2951,21,2951,22,0],[2952,25,2952,89,0],[2953,25,2953,107,0],[2954,21,2954,22,0],[2955,17,2955,18,0],[2956,17,2956,57,0],[2957,17,2957,18,0],[2958,21,2958,59,0],[2959,25,2959,99,0],[2961,21,2963,51,0],[2965,13,2965,14,0],[2966,9,2966,10,0],[2969,9,2969,10,0],[2970,13,2974,37,0],[2975,9,2975,10,0],[2978,9,2978,10,0],[2979,13,2983,114,0],[2984,9,2984,10,0],[2987,9,2987,10,0],[2988,13,2988,38,0],[2989,9,2989,10,0],[2992,9,2992,10,0],[2993,13,2993,32,0],[2994,13,2994,40,0],[2995,13,2995,79,0],[2996,13,2996,40,0],[2997,13,2997,49,0],[2998,13,2998,14,0],[2999,17,3002,105,0],[3003,17,3003,27,0],[3005,17,3005,49,0],[3006,21,3008,109,0],[3009,17,3009,24,0],[3009,26,3009,38,0],[3009,39,3009,41,0],[3009,42,3009,57,0],[3010,17,3010,18,0],[3011,21,3013,94,0],[3014,21,3015,70,0],[3016,25,3016,75,0],[3018,21,3018,25,0],[3019,17,3019,18,0],[3020,13,3020,14,0],[3021,13,3021,45,0],[3022,13,3022,92,0],[3023,17,3023,88,0],[3025,17,3025,48,0],[3027,13,3027,60,0],[3029,13,3029,29,0],[3030,9,3030,10,0],[3033,9,3033,10,0],[3034,13,3034,101,0],[3037,13,3037,61,0],[3038,13,3038,14,0],[3039,17,3039,70,0],[3041,17,3041,24,0],[3041,26,3041,38,0],[3041,39,3041,41,0],[3041,42,3041,64,0],[3042,17,3042,18,0],[3043,21,3043,46,0],[3044,17,3044,18,0],[3045,13,3045,14,0],[3047,13,3047,14,0],[3048,17,3048,70,0],[3050,17,3050,24,0],[3050,26,3050,38,0],[3050,39,3050,41,0],[3050,42,3050,64,0],[3051,17,3051,18,0],[3052,21,3052,46,0],[3053,17,3053,18,0],[3054,13,3054,14,0],[3056,13,3056,47,0],[3057,13,3057,53,0],[3058,13,3058,59,0],[3059,13,3059,38,0],[3061,13,3061,71,0],[3062,13,3062,47,0],[3063,9,3063,10,0],[3066,9,3066,10,0],[3069,13,3069,31,0],[3070,13,3070,61,0],[3071,13,3071,14,0],[3072,17,3072,49,0],[3073,17,3073,47,0],[3075,17,3075,42,0],[3077,17,3077,48,0],[3078,17,3078,46,0],[3079,13,3079,14,0],[3081,13,3081,14,0],[3082,17,3082,49,0],[3083,17,3083,46,0],[3085,17,3085,42,0],[3087,17,3087,48,0],[3088,17,3088,45,0],[3089,13,3089,14,0],[3092,13,3092,54,0],[3093,17,3093,108,0],[3095,17,3095,104,0],[3096,9,3096,10,0],[3099,9,3099,10,0],[3100,13,3100,29,0],[3102,13,3109,48,0],[3110,9,3110,10,0],[3113,9,3113,10,0],[3114,13,3114,51,0],[3115,13,3115,43,0],[3116,13,3116,14,0],[3117,17,3117,89,0],[3118,17,3118,138,0],[3119,13,3119,14,0],[3121,13,3121,43,0],[3122,13,3122,14,0],[3123,17,3123,94,0],[3124,17,3124,93,0],[3125,17,3125,102,0],[3126,17,3126,94,0],[3128,17,3128,134,0],[3130,17,3130,109,0],[3131,17,3131,18,0],[3132,21,3132,142,0],[3134,21,3134,97,0],[3136,21,3136,58,0],[3138,21,3138,138,0],[3139,17,3139,18,0],[3141,17,3141,18,0],[3142,21,3142,81,0],[3143,21,3143,22,0],[3144,25,3145,83,0],[3147,25,3147,63,0],[3148,29,3148,77,0],[3150,29,3150,77,0],[3152,25,3152,145,0],[3154,25,3154,94,0],[3156,25,3156,61,0],[3158,25,3158,142,0],[3159,21,3159,22,0],[3161,21,3161,22,0],[3162,25,3162,99,0],[3163,25,3163,140,0],[3164,21,3164,22,0],[3165,17,3165,18,0],[3166,13,3166,14,0],[3167,9,3167,10,0],[3170,9,3170,10,0],[3171,13,3171,29,0],[3172,13,3172,87,0],[3173,13,3173,37,0],[3174,9,3174,10,0],[3177,9,3177,10,0],[3178,13,3178,78,0],[3179,13,3179,76,0],[3181,13,3181,23,0],[3182,9,3182,10,0],[3187,9,3187,10,0],[3188,13,3188,29,0],[3189,13,3189,14,0],[3190,17,3190,47,0],[3191,17,3191,46,0],[3192,13,3192,14,0],[3194,13,3194,48,0],[3195,13,3195,14,0],[3196,17,3196,100,0],[3198,17,3198,93,0],[3199,17,3199,69,0],[3201,17,3201,94,0],[3202,17,3202,71,0],[3203,13,3203,14,0],[3205,13,3205,36,0],[3206,13,3206,14,0],[3207,17,3208,114,0],[3209,17,3209,95,0],[3210,17,3210,75,0],[3212,17,3212,96,0],[3213,17,3213,77,0],[3214,13,3214,14,0],[3216,13,3216,52,0],[3217,13,3217,53,0],[3219,13,3219,38,0],[3220,9,3220,10,0],[3223,9,3223,10,0],[3224,13,3224,41,0],[3225,13,3225,53,0],[3226,13,3226,65,0],[3228,13,3228,74,0],[3229,13,3229,61,0],[3230,13,3230,89,0],[3231,13,3231,70,0],[3232,13,3232,99,0],[3233,13,3233,55,0],[3235,13,3235,39,0],[3236,13,3236,14,0],[3237,17,3237,97,0],[3238,17,3238,92,0],[3239,17,3239,82,0],[3240,17,3240,77,0],[3241,13,3241,14,0],[3242,9,3242,10,0],[3245,9,3245,10,0],[3246,18,3246,27,0],[3246,29,3246,54,0],[3246,56,3246,59,0],[3247,13,3247,14,0],[3248,17,3248,48,0],[3250,17,3250,24,0],[3250,26,3250,42,0],[3250,43,3250,45,0],[3250,46,3250,54,0],[3251,17,3251,18,0],[3252,21,3254,76,0],[3255,21,3255,22,0],[3256,25,3256,50,0],[3257,25,3257,31,0],[3259,17,3259,18,0],[3261,17,3261,39,0],[3261,40,3261,49,0],[3263,17,3271,55,0],[3272,13,3272,14,0],[3273,9,3273,10,0],[3276,9,3276,10,0],[3277,13,3277,40,0],[3278,13,3278,20,0],[3278,22,3278,42,0],[3278,43,3278,45,0],[3278,46,3278,66,0],[3279,13,3279,14,0],[3280,17,3280,34,0],[3281,17,3281,95,0],[3282,17,3282,40,0],[3283,13,3283,14,0],[3284,13,3284,110,0],[3286,13,3286,41,0],[3287,13,3287,20,0],[3287,22,3287,42,0],[3287,43,3287,45,0],[3287,46,3287,67,0],[3288,13,3288,14,0],[3289,17,3289,34,0],[3290,17,3290,95,0],[3291,17,3291,41,0],[3292,13,3292,14,0],[3293,13,3293,112,0],[3294,9,3294,10,0],[3302,9,3302,10,0],[3303,13,3312,90,0],[3314,13,3314,29,0],[3315,17,3315,52,0],[3317,13,3317,63,0],[3319,13,3319,44,0],[3321,13,3321,44,0],[3322,9,3322,10,0],[3325,9,3325,10,0],[3326,13,3326,49,0],[3327,13,3327,20,0],[3327,22,3327,42,0],[3327,43,3327,45,0],[3327,46,3327,72,0],[3328,13,3328,14,0],[3329,17,3329,34,0],[3330,17,3330,110,0],[3331,17,3331,49,0],[3332,13,3332,14,0],[3333,13,3333,126,0],[3334,9,3334,10,0],[3337,9,3337,10,0],[3338,18,3338,27,0],[3338,29,3338,64,0],[3338,66,3338,69,0],[3339,13,3339,14,0],[3340,17,3340,40,0],[3342,17,3342,24,0],[3342,26,3342,42,0],[3342,43,3342,45,0],[3342,46,3342,72,0],[3343,17,3343,18,0],[3344,21,3348,91,0],[3349,21,3349,22,0],[3350,25,3350,42,0],[3351,25,3351,31,0],[3353,17,3353,18,0],[3355,17,3355,31,0],[3355,32,3355,41,0],[3357,17,3385,73,0],[3386,13,3386,14,0],[3387,9,3387,10,0],[3390,9,3390,10,0],[3393,13,3393,20,0],[3393,22,3393,39,0],[3393,40,3393,42,0],[3393,43,3393,95,0],[3394,17,3394,58,0],[3396,13,3396,45,0],[3397,13,3397,41,0],[3398,13,3398,63,0],[3399,13,3399,48,0],[3400,13,3400,49,0],[3401,13,3401,46,0],[3402,13,3402,46,0],[3404,13,3404,79,0],[3406,13,3406,41,0],[3407,13,3407,50,0],[3408,13,3408,63,0],[3409,13,3409,48,0],[3410,13,3410,49,0],[3411,13,3411,46,0],[3412,13,3412,46,0],[3414,13,3414,79,0],[3418,13,3418,20,0],[3418,22,3418,39,0],[3418,40,3418,42,0],[3418,43,3418,72,0],[3419,13,3419,14,0],[3420,17,3421,121,0],[3422,17,3422,18,0],[3423,21,3423,62,0],[3424,21,3424,60,0],[3425,17,3425,18,0],[3426,13,3426,14,0],[3432,13,3432,91,0],[3433,13,3433,93,0],[3435,13,3435,77,0],[3436,13,3436,85,0],[3438,13,3438,107,0],[3439,13,3439,82,0],[3440,13,3440,95,0],[3441,13,3441,76,0],[3442,13,3442,119,0],[3443,13,3443,94,0],[3444,13,3444,75,0],[3445,13,3445,100,0],[3446,13,3446,81,0],[3447,13,3447,101,0],[3448,13,3448,81,0],[3449,13,3449,83,0],[3450,13,3450,70,0],[3451,13,3451,85,0],[3452,13,3452,71,0],[3453,13,3453,101,0],[3454,13,3454,79,0],[3455,13,3455,92,0],[3456,13,3456,76,0],[3457,13,3457,122,0],[3458,13,3458,89,0],[3459,13,3459,77,0],[3460,13,3460,125,0],[3461,13,3461,105,0],[3462,13,3462,79,0],[3463,13,3463,125,0],[3464,13,3464,101,0],[3465,13,3465,85,0],[3466,13,3466,131,0],[3467,13,3467,98,0],[3468,13,3468,86,0],[3469,13,3469,134,0],[3470,13,3470,102,0],[3471,13,3471,88,0],[3472,13,3472,132,0],[3474,13,3474,39,0],[3475,13,3475,14,0],[3476,17,3476,112,0],[3477,17,3477,107,0],[3478,17,3478,113,0],[3479,17,3479,108,0],[3480,13,3480,14,0],[3483,9,3483,10,0],[3490,9,3490,10,0],[3491,13,3491,32,0],[3492,13,3492,14,0],[3493,17,3493,48,0],[3494,17,3494,45,0],[3495,17,3495,42,0],[3495,44,3495,61,0],[3496,17,3496,18,0],[3497,17,3497,63,0],[3498,17,3498,31,0],[3499,17,3499,42,0],[3500,17,3500,66,0],[3501,17,3502,62,0],[3504,17,3507,110,0],[3508,17,3508,59,0],[3509,17,3509,18,0],[3510,21,3510,77,0],[3511,21,3511,71,0],[3512,17,3512,18,0],[3515,17,3515,81,0],[3516,17,3516,89,0],[3517,17,3517,93,0],[3518,17,3518,77,0],[3519,17,3519,45,0],[3520,17,3520,27,0],[3521,17,3521,45,0],[3522,17,3522,60,0],[3523,17,3523,65,0],[3524,17,3524,24,0],[3524,26,3524,36,0],[3524,37,3524,39,0],[3524,40,3524,47,0],[3525,17,3525,18,0],[3526,21,3526,69,0],[3527,21,3527,22,0],[3528,25,3532,108,0],[3533,25,3533,67,0],[3534,25,3534,26,0],[3535,29,3536,115,0],[3537,29,3537,60,0],[3538,29,3538,69,0],[3539,29,3539,100,0],[3540,29,3540,51,0],[3541,29,3541,33,0],[3542,25,3542,26,0],[3543,21,3543,22,0],[3545,21,3545,22,0],[3546,25,3546,59,0],[3547,25,3547,68,0],[3548,25,3548,53,0],[3549,25,3549,50,0],[3550,25,3550,29,0],[3551,21,3551,22,0],[3552,17,3552,18,0],[3553,17,3553,40,0],[3554,17,3554,59,0],[3555,17,3555,18,0],[3556,21,3556,91,0],[3557,21,3558,115,0],[3559,21,3559,43,0],[3560,21,3560,118,0],[3561,21,3561,22,0],[3562,25,3562,85,0],[3563,25,3563,26,0],[3564,29,3564,59,0],[3565,29,3565,82,0],[3566,29,3566,36,0],[3566,38,3566,48,0],[3566,49,3566,51,0],[3566,52,3566,56,0],[3567,33,3567,52,0],[3568,29,3568,53,0],[3569,29,3569,30,0],[3570,33,3570,75,0],[3571,33,3571,63,0],[3572,33,3572,40,0],[3572,42,3572,52,0],[3572,53,3572,55,0],[3572,56,3572,65,0],[3573,33,3573,34,0],[3574,37,3574,93,0],[3575,37,3575,77,0],[3576,33,3576,34,0],[3577,33,3577,68,0],[3578,33,3578,40,0],[3578,42,3578,52,0],[3578,53,3578,55,0],[3578,56,3578,65,0],[3579,33,3579,34,0],[3580,37,3580,93,0],[3581,37,3581,64,0],[3582,33,3582,34,0],[3583,29,3583,30,0],[3584,25,3584,26,0],[3585,21,3585,22,0],[3587,21,3587,28,0],[3587,30,3587,43,0],[3587,44,3587,46,0],[3587,47,3587,57,0],[3588,21,3588,22,0],[3589,25,3589,118,0],[3590,25,3590,49,0],[3591,25,3591,26,0],[3592,29,3592,102,0],[3593,33,3593,64,0],[3594,25,3594,26,0],[3595,21,3595,22,0],[3596,21,3596,42,0],[3597,17,3597,18,0],[3599,17,3599,18,0],[3600,21,3600,28,0],[3600,30,3600,43,0],[3600,44,3600,46,0],[3600,47,3600,57,0],[3601,21,3601,22,0],[3602,25,3602,92,0],[3603,25,3603,52,0],[3604,21,3604,22,0],[3605,17,3605,18,0],[3606,17,3607,76,0],[3608,17,3608,32,0],[3611,17,3611,27,0],[3612,9,3612,10,0],[3616,9,3616,10,0],[3618,13,3618,38,0],[3619,13,3619,27,0],[3620,13,3620,62,0],[3621,13,3621,38,0],[3622,13,3622,77,0],[3623,13,3623,79,0],[3624,13,3624,89,0],[3625,13,3625,73,0],[3626,13,3628,106,0],[3629,13,3629,55,0],[3630,13,3630,14,0],[3631,17,3631,67,0],[3632,17,3632,67,0],[3633,13,3633,14,0],[3634,13,3634,58,0],[3635,13,3635,14,0],[3636,17,3636,53,0],[3637,17,3637,42,0],[3639,17,3639,140,0],[3640,17,3640,118,0],[3641,17,3641,114,0],[3642,17,3647,79,0],[3648,17,3648,114,0],[3649,17,3649,18,0],[3650,21,3651,115,0],[3652,21,3652,22,0],[3653,25,3656,140,0],[3657,21,3657,22,0],[3658,17,3658,18,0],[3659,13,3659,14,0],[3661,13,3661,14,0],[3662,17,3662,54,0],[3663,17,3663,43,0],[3664,13,3664,14,0],[3665,9,3665,10,0],[3669,9,3669,10,0],[3672,13,3672,39,0],[3673,13,3673,14,0],[3674,17,3683,32,0],[3685,17,3685,108,0],[3686,17,3686,35,0],[3687,17,3687,49,0],[3688,13,3688,14,0],[3692,13,3700,100,0],[3703,13,3705,44,0],[3706,13,3706,57,0],[3707,13,3707,56,0],[3708,13,3709,42,0],[3710,13,3710,14,0],[3711,17,3711,93,0],[3712,17,3712,48,0],[3713,17,3713,55,0],[3714,13,3714,14,0],[3716,18,3716,27,0],[3716,29,3716,52,0],[3716,54,3716,57,0],[3717,13,3717,14,0],[3718,17,3721,25,0],[3721,25,3722,104,0],[3722,104,3722,106,0],[3718,17,3722,106,0],[3723,17,3723,37,0],[3724,17,3724,18,0],[3725,21,3725,60,0],[3726,21,3726,25,0],[3727,17,3727,18,0],[3729,17,3729,18,0],[3730,21,3730,54,0],[3731,21,3731,63,0],[3732,21,3732,63,0],[3733,21,3733,63,0],[3734,21,3734,64,0],[3735,26,3735,35,0],[3735,37,3735,59,0],[3735,61,3735,64,0],[3736,21,3736,22,0],[3737,25,3737,113,0],[3738,25,3738,26,0],[3740,29,3742,48,0],[3743,29,3745,94,0],[3746,29,3748,94,0],[3749,29,3751,94,0],[3752,29,3754,95,0],[3755,25,3755,26,0],[3756,21,3756,22,0],[3757,17,3757,18,0],[3758,13,3758,14,0],[3760,13,3760,41,0],[3761,13,3761,14,0],[3762,17,3762,44,0],[3763,17,3763,18,0],[3764,21,3765,102,0],[3766,21,3766,62,0],[3767,17,3767,18,0],[3768,13,3768,14,0],[3770,13,3770,14,0],[3771,17,3771,44,0],[3772,21,3772,58,0],[3773,13,3773,14,0],[3775,13,3775,74,0],[3776,13,3776,41,0],[3777,13,3777,49,0],[3778,13,3778,38,0],[3780,13,3780,57,0],[3781,13,3781,44,0],[3783,13,3783,87,0],[3786,13,3786,39,0],[3788,13,3788,61,0],[3788,61,3788,96,0],[3788,96,3788,98,0],[3788,13,3788,98,0],[3789,13,3789,56,0],[3791,13,3791,52,0],[3792,13,3792,14,0],[3793,17,3793,71,0],[3794,17,3794,46,0],[3795,17,3795,63,0],[3795,64,3795,121,0],[3796,17,3796,70,0],[3797,17,3797,18,0],[3798,21,3798,95,0],[3799,21,3799,105,0],[3800,17,3800,18,0],[3802,17,3802,68,0],[3803,17,3803,18,0],[3804,21,3804,93,0],[3805,21,3805,123,0],[3806,21,3806,100,0],[3807,17,3807,18,0],[3809,17,3809,65,0],[3810,17,3810,18,0],[3811,21,3811,90,0],[3812,21,3812,102,0],[3813,17,3813,18,0],[3816,17,3816,95,0],[3817,17,3817,64,0],[3818,17,3818,18,0],[3819,21,3819,115,0],[3820,21,3820,118,0],[3821,21,3821,121,0],[3822,21,3822,96,0],[3823,21,3823,118,0],[3824,21,3824,89,0],[3825,17,3825,18,0],[3826,13,3826,14,0],[3827,9,3827,10,0],[3830,9,3830,10,0],[3831,13,3831,73,0],[3832,13,3832,75,0],[3833,13,3833,53,0],[3834,13,3834,75,0],[3835,13,3835,74,0],[3837,13,3837,90,0],[3838,13,3838,14,0],[3839,17,3839,77,0],[3840,17,3840,74,0],[3841,17,3841,56,0],[3842,17,3842,79,0],[3843,17,3843,72,0],[3844,17,3844,78,0],[3845,17,3845,78,0],[3846,17,3846,78,0],[3847,13,3847,14,0],[3848,9,3848,10,0],[3857,9,3857,10,0],[3858,13,3858,42,0],[3859,17,3859,57,0],[3861,13,3861,40,0],[3862,13,3862,14,0],[3863,17,3863,77,0],[3864,17,3864,52,0],[3865,13,3865,14,0],[3867,13,3867,50,0],[3868,17,3868,65,0],[3870,13,3870,37,0],[3871,17,3871,49,0],[3873,13,3873,38,0],[3874,17,3874,53,0],[3876,13,3876,45,0],[3877,13,3877,14,0],[3878,17,3878,80,0],[3879,17,3879,57,0],[3880,13,3880,14,0],[3882,13,3882,44,0],[3883,17,3883,56,0],[3885,13,3885,39,0],[3886,13,3886,14,0],[3887,17,3887,100,0],[3888,17,3888,52,0],[3889,17,3889,96,0],[3890,17,3890,71,0],[3891,17,3891,92,0],[3892,13,3892,14,0],[3894,13,3894,48,0],[3895,13,3895,14,0],[3896,17,3896,96,0],[3897,17,3897,61,0],[3898,17,3898,105,0],[3899,17,3899,80,0],[3900,17,3900,101,0],[3901,13,3901,14,0],[3903,13,3903,48,0],[3904,13,3904,14,0],[3905,17,3905,43,0],[3906,17,3906,18,0],[3907,21,3907,67,0],[3908,17,3908,18,0],[3910,17,3910,18,0],[3911,21,3911,68,0],[3912,21,3912,90,0],[3913,21,3913,65,0],[3914,21,3914,109,0],[3915,21,3915,84,0],[3916,21,3916,105,0],[3917,17,3917,18,0],[3918,13,3918,14,0],[3920,13,3920,48,0],[3921,13,3921,14,0],[3922,17,3922,90,0],[3923,17,3923,61,0],[3924,17,3924,105,0],[3925,17,3925,80,0],[3926,17,3926,101,0],[3928,17,3928,43,0],[3929,17,3929,18,0],[3930,21,3930,88,0],[3931,21,3931,83,0],[3932,17,3932,18,0],[3933,13,3933,14,0],[3935,13,3935,49,0],[3936,13,3936,14,0],[3937,17,3937,64,0],[3938,17,3938,106,0],[3939,17,3939,89,0],[3940,17,3940,18,0],[3941,26,3941,35,0],[3941,37,3941,65,0],[3941,67,3941,70,0],[3942,21,3942,22,0],[3943,25,3943,73,0],[3944,25,3944,70,0],[3945,25,3945,100,0],[3946,25,3950,99,0],[3952,30,3952,39,0],[3952,41,3952,66,0],[3952,68,3952,71,0],[3953,25,3953,26,0],[3954,29,3954,72,0],[3955,29,3959,101,0],[3960,25,3960,26,0],[3961,21,3961,22,0],[3962,17,3962,18,0],[3963,13,3963,14,0],[3965,13,3965,45,0],[3966,17,3966,60,0],[3968,13,3968,42,0],[3969,17,3969,41,0],[3970,21,3970,56,0],[3971,9,3971,10,0],[3979,9,3979,10,0],[3980,13,3980,53,0],[3982,13,3982,42,0],[3983,17,3983,57,0],[3985,13,3985,40,0],[3986,17,3986,77,0],[3988,13,3988,50,0],[3989,17,3989,65,0],[3991,13,3991,38,0],[3992,17,3992,53,0],[3994,13,3994,45,0],[3995,17,3995,80,0],[3997,13,3997,44,0],[3998,17,3998,56,0],[4000,13,4000,39,0],[4001,13,4001,14,0],[4002,17,4002,100,0],[4003,17,4003,96,0],[4004,17,4004,90,0],[4005,17,4005,93,0],[4006,13,4006,14,0],[4008,13,4008,48,0],[4009,13,4009,14,0],[4010,17,4010,96,0],[4011,17,4011,105,0],[4012,17,4012,99,0],[4013,17,4013,102,0],[4014,13,4014,14,0],[4016,13,4016,48,0],[4017,13,4017,14,0],[4018,17,4018,86,0],[4019,17,4019,105,0],[4020,17,4020,99,0],[4021,17,4021,102,0],[4022,13,4022,14,0],[4024,13,4024,48,0],[4025,17,4025,63,0],[4027,13,4027,49,0],[4028,17,4028,64,0],[4030,13,4030,45,0],[4031,17,4031,60,0],[4033,13,4033,42,0],[4034,17,4034,41,0],[4035,21,4035,56,0],[4036,9,4036,10,0],[4044,9,4044,10,0],[4046,13,4046,14,0],[4047,17,4047,42,0],[4048,49,4048,67,0],[4050,22,4050,31,0],[4050,33,4050,54,0],[4050,56,4050,59,0],[4051,17,4051,18,0],[4052,21,4052,34,0],[4053,21,4053,48,0],[4055,21,4056,76,0],[4057,21,4057,22,0],[4058,25,4058,59,0],[4059,29,4059,47,0],[4061,25,4061,40,0],[4062,25,4062,26,0],[4063,29,4063,69,0],[4064,29,4064,64,0],[4065,29,4065,62,0],[4066,29,4066,72,0],[4067,29,4067,59,0],[4068,29,4068,60,0],[4069,29,4069,67,0],[4070,29,4070,66,0],[4071,29,4071,61,0],[4072,29,4072,70,0],[4073,29,4073,70,0],[4074,29,4074,70,0],[4075,29,4075,71,0],[4076,29,4076,67,0],[4077,29,4077,64,0],[4079,29,4079,89,0],[4080,29,4080,86,0],[4081,29,4081,69,0],[4082,29,4082,91,0],[4083,29,4083,84,0],[4084,29,4084,90,0],[4085,29,4085,91,0],[4086,29,4086,90,0],[4087,25,4087,26,0],[4089,30,4089,39,0],[4089,41,4089,83,0],[4089,85,4089,88,0],[4090,25,4090,26,0],[4091,29,4094,37,0],[4094,37,4096,84,0],[4096,84,4096,86,0],[4091,29,4096,86,0],[4098,29,4098,52,0],[4099,29,4099,30,0],[4100,33,4100,61,0],[4101,33,4101,93,0],[4102,33,4102,91,0],[4103,33,4103,50,0],[4104,33,4104,50,0],[4105,33,4105,50,0],[4106,33,4106,50,0],[4107,33,4107,50,0],[4108,33,4108,90,0],[4109,33,4109,99,0],[4110,33,4110,99,0],[4111,33,4114,106,0],[4115,33,4115,101,0],[4116,33,4116,97,0],[4117,33,4117,68,0],[4118,33,4118,61,0],[4120,33,4120,116,0],[4121,33,4122,62,0],[4124,33,4124,59,0],[4125,33,4125,39,0],[4129,34,4129,43,0],[4129,45,4129,81,0],[4129,83,4129,86,0],[4130,29,4130,30,0],[4131,33,4131,88,0],[4132,37,4132,90,0],[4133,33,4134,108,0],[4135,33,4135,34,0],[4136,37,4136,56,0],[4137,37,4137,51,0],[4138,37,4138,43,0],[4140,29,4140,30,0],[4141,25,4141,26,0],[4142,25,4142,35,0],[4143,25,4143,26,0],[4145,29,4145,57,0],[4146,29,4146,89,0],[4147,29,4147,87,0],[4148,29,4148,97,0],[4149,29,4149,84,0],[4150,29,4150,85,0],[4151,29,4151,92,0],[4152,29,4152,91,0],[4153,29,4153,86,0],[4154,29,4154,95,0],[4155,29,4155,95,0],[4156,29,4159,102,0],[4160,29,4160,97,0],[4161,29,4161,93,0],[4162,29,4162,64,0],[4164,34,4164,43,0],[4164,45,4164,73,0],[4164,75,4164,78,0],[4165,29,4165,30,0],[4167,33,4169,63,0],[4170,33,4170,34,0],[4171,37,4171,73,0],[4173,37,4173,56,0],[4176,37,4176,61,0],[4177,37,4177,38,0],[4178,41,4180,68,0],[4181,41,4183,68,0],[4184,41,4186,68,0],[4187,41,4189,69,0],[4190,41,4192,69,0],[4193,37,4193,38,0],[4194,37,4194,43,0],[4196,29,4196,30,0],[4197,25,4197,26,0],[4198,25,4198,74,0],[4199,21,4199,22,0],[4200,17,4200,18,0],[4202,17,4204,76,0],[4206,17,4206,33,0],[4207,21,4207,82,0],[4208,13,4208,14,0],[4209,13,4209,33,0],[4210,13,4210,14,0],[4211,17,4211,64,0],[4212,13,4212,14,0],[4213,9,4213,10,0],[4222,9,4222,10,0],[4223,13,4223,42,0],[4224,9,4224,10,0],[4227,9,4227,10,0],[4228,13,4228,64,0],[4229,13,4229,14,0],[4230,17,4230,121,0],[4231,17,4231,73,0],[4232,17,4232,41,0],[4234,17,4234,48,0],[4236,17,4236,42,0],[4237,13,4237,14,0],[4239,13,4239,42,0],[4240,9,4240,10,0],[4244,9,4244,10,0],[4245,13,4249,99,0],[4251,13,4251,59,0],[4252,13,4252,14,0],[4253,17,4253,69,0],[4254,17,4254,24,0],[4254,26,4254,46,0],[4254,47,4254,49,0],[4254,50,4254,68,0],[4255,21,4255,56,0],[4256,13,4256,14,0],[4258,13,4258,104,0],[4259,13,4259,46,0],[4260,9,4260,10,0],[4263,9,4263,10,0],[4264,13,4264,100,0],[4265,13,4265,43,0],[4266,13,4266,50,0],[4267,13,4267,68,0],[4268,9,4268,10,0],[4271,9,4271,10,0],[4272,13,4272,101,0],[4273,13,4273,43,0],[4274,13,4274,50,0],[4275,13,4275,68,0],[4276,9,4276,10,0],[4283,9,4283,10,0],[4284,13,4284,45,0],[4286,13,4286,43,0],[4287,13,4287,45,0],[4288,13,4288,41,0],[4289,13,4289,58,0],[4291,13,4291,43,0],[4292,13,4292,44,0],[4293,13,4293,40,0],[4294,13,4294,58,0],[4296,13,4296,43,0],[4297,13,4297,41,0],[4298,13,4298,48,0],[4299,13,4299,58,0],[4301,13,4301,43,0],[4302,13,4302,48,0],[4303,13,4303,45,0],[4304,13,4304,58,0],[4306,13,4306,28,0],[4307,9,4307,10,0],[4310,9,4310,10,0],[4311,13,4311,45,0],[4313,13,4313,43,0],[4314,13,4314,45,0],[4315,13,4315,41,0],[4316,13,4316,58,0],[4318,13,4318,43,0],[4319,13,4319,44,0],[4320,13,4320,40,0],[4321,13,4321,58,0],[4323,13,4323,43,0],[4324,13,4324,50,0],[4325,13,4325,46,0],[4326,13,4326,58,0],[4328,13,4328,43,0],[4329,13,4329,57,0],[4330,13,4330,53,0],[4331,13,4331,58,0],[4333,13,4333,28,0],[4334,9,4334,10,0],[4337,9,4337,10,0],[4338,13,4338,42,0],[4339,9,4339,10,0],[4342,9,4342,10,0],[4343,13,4343,58,0],[4345,13,4345,44,0],[4347,13,4347,44,0],[4349,13,4349,42,0],[4350,9,4350,10,0],[4354,9,4354,10,0],[4357,13,4359,44,0],[4360,13,4360,38,0],[4361,13,4361,42,0],[4363,13,4363,51,0],[4364,13,4364,14,0],[4365,17,4365,59,0],[4367,17,4367,56,0],[4368,17,4368,46,0],[4369,13,4369,14,0],[4375,13,4379,114,0],[4383,13,4383,111,0],[4384,13,4384,53,0],[4385,9,4385,10,0],[4388,9,4388,10,0],[4389,13,4389,49,0],[4390,13,4390,42,0],[4391,9,4391,10,0],[4398,9,4398,10,0],[4399,13,4399,91,0],[4400,13,4400,14,0],[4401,17,4401,55,0],[4402,17,4402,18,0],[4403,21,4403,58,0],[4404,21,4404,22,0],[4405,25,4409,63,0],[4410,25,4411,117,0],[4412,25,4413,95,0],[4414,25,4414,95,0],[4415,21,4415,22,0],[4416,17,4416,18,0],[4417,13,4417,14,0],[4418,9,4418,10,0],[4431,9,4431,10,0],[4433,13,4433,14,0],[4434,17,4434,64,0],[4435,17,4435,98,0],[4436,17,4436,18,0],[4437,21,4437,55,0],[4438,21,4438,47,0],[4439,21,4439,53,0],[4441,21,4441,87,0],[4442,25,4442,128,0],[4444,21,4444,86,0],[4445,25,4446,126,0],[4448,21,4448,118,0],[4449,25,4450,129,0],[4451,26,4451,121,0],[4452,25,4453,127,0],[4455,21,4455,115,0],[4456,25,4457,126,0],[4458,26,4458,128,0],[4459,25,4460,134,0],[4462,21,4462,90,0],[4463,17,4463,18,0],[4464,22,4464,43,0],[4465,21,4465,54,0],[4466,17,4466,42,0],[4467,17,4467,53,0],[4468,17,4468,130,0],[4470,13,4470,14,0],[4471,13,4471,30,0],[4472,13,4472,14,0],[4473,17,4473,33,0],[4474,17,4474,31,0],[4475,17,4475,24,0],[4477,9,4477,10,0],[4485,9,4485,10,0],[4486,13,4486,42,0],[4487,9,4487,10,0],[4495,9,4495,10,0],[4496,13,4496,52,0],[4497,13,4497,69,0],[4498,9,4498,10,0],[4506,9,4506,10,0],[4507,13,4507,96,0],[4508,13,4508,42,0],[4509,13,4509,31,0],[4510,13,4510,220,0],[4512,9,4512,10,0],[4520,9,4520,10,0],[4521,13,4521,43,0],[4522,13,4522,35,0],[4523,13,4523,20,0],[4523,22,4523,38,0],[4523,39,4523,41,0],[4523,42,4523,56,0],[4524,13,4524,14,0],[4525,17,4525,77,0],[4526,17,4526,18,0],[4527,21,4527,37,0],[4528,21,4528,37,0],[4529,21,4529,43,0],[4530,25,4530,31,0],[4531,17,4531,18,0],[4532,13,4532,14,0],[4533,13,4533,36,0],[4534,17,4534,63,0],[4535,13,4535,57,0],[4536,13,4536,14,0],[4537,17,4537,57,0],[4538,17,4538,94,0],[4539,17,4539,68,0],[4540,21,4540,97,0],[4542,17,4542,105,0],[4543,17,4543,57,0],[4544,17,4544,40,0],[4545,17,4545,32,0],[4546,17,4546,37,0],[4547,17,4549,43,0],[4550,17,4550,24,0],[4550,26,4550,36,0],[4550,37,4550,39,0],[4550,40,4550,47,0],[4552,17,4552,18,0],[4553,21,4553,62,0],[4554,17,4554,18,0],[4555,17,4555,55,0],[4556,17,4556,44,0],[4557,17,4557,39,0],[4559,17,4559,53,0],[4560,17,4560,18,0],[4561,21,4561,68,0],[4562,17,4562,18,0],[4564,17,4564,58,0],[4565,17,4565,18,0],[4566,21,4566,87,0],[4567,17,4567,18,0],[4569,17,4569,61,0],[4570,17,4570,18,0],[4571,21,4571,92,0],[4572,21,4572,93,0],[4573,21,4573,97,0],[4574,21,4574,112,0],[4575,21,4575,120,0],[4577,21,4577,119,0],[4578,21,4578,22,0],[4579,25,4579,95,0],[4580,25,4580,100,0],[4581,21,4581,22,0],[4582,17,4582,18,0],[4584,17,4584,59,0],[4585,17,4585,18,0],[4586,21,4586,93,0],[4587,21,4587,118,0],[4588,21,4588,110,0],[4589,17,4589,18,0],[4591,17,4591,63,0],[4592,17,4592,18,0],[4593,21,4593,78,0],[4594,17,4594,18,0],[4595,17,4595,59,0],[4596,17,4596,18,0],[4597,21,4597,74,0],[4598,17,4598,18,0],[4599,17,4599,42,0],[4600,13,4600,14,0],[4602,17,4602,66,0],[4603,9,4603,10,0],[4611,9,4611,10,0],[4612,13,4612,52,0],[4613,13,4613,20,0],[4613,22,4613,38,0],[4613,39,4613,41,0],[4613,42,4613,56,0],[4614,13,4614,14,0],[4615,17,4615,77,0],[4616,21,4616,38,0],[4617,13,4617,14,0],[4618,13,4618,35,0],[4619,13,4619,14,0],[4620,17,4620,24,0],[4620,26,4620,42,0],[4620,43,4620,45,0],[4620,46,4620,53,0],[4621,21,4621,48,0],[4622,13,4622,14,0],[4624,13,4624,14,0],[4625,17,4625,76,0],[4627,17,4627,39,0],[4628,17,4628,18,0],[4629,21,4629,64,0],[4630,17,4630,18,0],[4632,17,4632,18,0],[4633,21,4633,65,0],[4634,21,4634,28,0],[4636,13,4636,14,0],[4637,13,4637,34,0],[4638,13,4638,20,0],[4638,22,4638,38,0],[4638,39,4638,41,0],[4638,42,4638,56,0],[4639,13,4639,14,0],[4640,17,4640,76,0],[4641,13,4641,14,0],[4643,13,4643,55,0],[4644,13,4644,134,0],[4645,13,4645,100,0],[4651,9,4651,10,0],[4659,9,4659,10,0],[4662,13,4662,36,0],[4664,13,4664,37,0],[4665,13,4665,52,0],[4666,13,4666,50,0],[4667,13,4667,48,0],[4668,13,4668,53,0],[4669,13,4669,54,0],[4670,13,4670,87,0],[4671,13,4671,89,0],[4672,13,4672,54,0],[4673,13,4673,91,0],[4674,13,4674,31,0],[4676,13,4676,43,0],[4677,13,4677,14,0],[4678,17,4678,51,0],[4679,17,4679,48,0],[4680,17,4680,53,0],[4681,17,4681,63,0],[4682,17,4682,78,0],[4683,17,4683,82,0],[4684,17,4684,86,0],[4685,17,4685,65,0],[4686,17,4686,47,0],[4687,13,4687,14,0],[4688,13,4688,45,0],[4689,13,4689,57,0],[4698,13,4700,35,0],[4701,13,4701,56,0],[4703,13,4703,114,0],[4704,13,4704,121,0],[4705,13,4705,39,0],[4707,13,4707,97,0],[4709,13,4709,119,0],[4711,13,4711,39,0],[4713,13,4713,88,0],[4714,13,4714,105,0],[4715,13,4715,107,0],[4716,13,4716,94,0],[4719,13,4719,134,0],[4720,13,4720,100,0],[4724,13,4724,38,0],[4725,9,4725,10,0],[4731,9,4731,10,0],[4732,13,4738,119,0],[4739,13,4741,59,0],[4742,13,4742,71,0],[4743,9,4743,10,0],[4751,9,4751,10,0],[4752,13,4752,43,0],[4753,13,4753,64,0],[4755,13,4755,61,0],[4756,13,4756,59,0],[4757,13,4757,61,0],[4758,13,4758,93,0],[4759,13,4759,97,0],[4761,13,4761,99,0],[4762,13,4762,101,0],[4765,13,4765,44,0],[4766,17,4767,91,0],[4769,17,4771,92,0],[4772,13,4772,65,0],[4774,13,4774,93,0],[4775,13,4775,14,0],[4776,17,4778,50,0],[4779,17,4779,67,0],[4780,17,4780,18,0],[4781,21,4782,123,0],[4783,21,4783,58,0],[4784,21,4784,46,0],[4785,21,4785,82,0],[4788,21,4788,65,0],[4789,25,4789,80,0],[4790,21,4790,68,0],[4791,25,4791,83,0],[4792,21,4792,67,0],[4793,25,4793,82,0],[4794,21,4794,64,0],[4795,25,4795,79,0],[4796,21,4796,70,0],[4797,25,4797,112,0],[4798,21,4798,68,0],[4799,25,4799,108,0],[4800,17,4800,18,0],[4802,17,4802,18,0],[4803,21,4803,81,0],[4805,21,4805,59,0],[4806,17,4806,18,0],[4808,17,4810,51,0],[4811,17,4811,69,0],[4812,17,4812,18,0],[4813,21,4814,118,0],[4815,21,4815,59,0],[4816,21,4816,46,0],[4817,21,4817,82,0],[4820,21,4820,65,0],[4821,25,4821,80,0],[4822,21,4822,68,0],[4823,25,4823,83,0],[4824,21,4824,67,0],[4825,25,4825,82,0],[4826,21,4826,64,0],[4827,25,4827,79,0],[4828,21,4828,70,0],[4829,25,4829,112,0],[4830,21,4830,68,0],[4831,25,4831,108,0],[4832,17,4832,18,0],[4834,17,4834,18,0],[4835,21,4835,81,0],[4837,21,4837,54,0],[4838,17,4838,18,0],[4839,17,4839,42,0],[4840,13,4840,14,0],[4842,13,4842,42,0],[4843,13,4843,42,0],[4844,13,4844,14,0],[4845,17,4845,53,0],[4846,17,4846,43,0],[4847,17,4847,45,0],[4848,13,4848,14,0],[4849,9,4849,10,0],[4856,9,4856,10,0],[4857,13,4857,51,0],[4858,13,4858,57,0],[4859,13,4859,66,0],[4861,13,4861,53,0],[4862,13,4862,61,0],[4863,13,4863,70,0],[4865,13,4865,43,0],[4866,17,4866,60,0],[4868,13,4868,90,0],[4869,13,4869,31,0],[4871,13,4871,43,0],[4872,13,4872,14,0],[4873,17,4873,51,0],[4876,17,4878,55,0],[4880,17,4880,75,0],[4881,17,4881,67,0],[4883,17,4883,48,0],[4884,17,4884,18,0],[4885,21,4885,65,0],[4886,21,4886,65,0],[4887,21,4887,81,0],[4888,17,4888,18,0],[4890,17,4890,18,0],[4891,21,4891,73,0],[4892,21,4892,77,0],[4893,21,4893,67,0],[4894,17,4894,18,0],[4896,17,4896,71,0],[4897,17,4897,67,0],[4898,17,4898,79,0],[4899,17,4899,75,0],[4900,17,4900,69,0],[4901,17,4901,71,0],[4902,17,4902,73,0],[4903,17,4903,61,0],[4904,17,4904,69,0],[4905,17,4905,65,0],[4907,17,4907,64,0],[4908,21,4908,50,0],[4910,21,4910,52,0],[4911,13,4911,14,0],[4912,13,4912,46,0],[4913,13,4913,62,0],[4914,13,4914,64,0],[4915,13,4915,33,0],[4917,9,4917,10,0],[4925,9,4925,10,0],[4926,13,4926,38,0],[4927,13,4927,51,0],[4928,13,4928,47,0],[4929,13,4929,44,0],[4930,13,4930,14,0],[4931,17,4931,48,0],[4932,17,4932,48,0],[4933,17,4933,56,0],[4934,13,4934,14,0],[4936,13,4936,14,0],[4937,17,4937,52,0],[4938,17,4938,54,0],[4939,17,4939,49,0],[4940,13,4940,14,0],[4941,13,4941,49,0],[4942,13,4942,47,0],[4943,13,4943,53,0],[4944,13,4944,49,0],[4945,13,4945,51,0],[4946,13,4946,49,0],[4947,13,4947,48,0],[4948,13,4948,46,0],[4949,13,4949,48,0],[4950,13,4950,50,0],[4951,13,4951,44,0],[4952,13,4952,29,0],[4953,9,4953,10,0],[4960,9,4960,10,0],[4961,13,4961,42,0],[4962,13,4962,14,0],[4963,17,4963,56,0],[4964,13,4964,14,0],[4965,13,4965,44,0],[4966,13,4966,92,0],[4967,13,4967,45,0],[4968,13,4968,34,0],[4969,13,4969,34,0],[4970,13,4970,115,0],[4972,13,4972,134,0],[4973,13,4973,35,0],[4974,13,4974,100,0],[4975,13,4975,41,0],[4977,13,4977,55,0],[4978,17,4978,70,0],[4980,13,4980,54,0],[4981,17,4981,69,0],[4983,13,4983,52,0],[4984,17,4984,67,0],[4986,13,4986,60,0],[4987,13,4987,14,0],[4988,17,4988,138,0],[4989,17,4989,95,0],[4990,13,4990,14,0],[4992,13,4992,52,0],[4993,13,4993,14,0],[4994,17,4994,80,0],[4995,17,4995,87,0],[4996,13,4996,14,0],[4998,13,4998,57,0],[4999,13,4999,14,0],[5000,17,5000,92,0],[5001,13,5001,14,0],[5003,13,5003,59,0],[5004,13,5004,14,0],[5005,17,5005,118,0],[5006,17,5006,110,0],[5007,17,5007,94,0],[5008,17,5008,89,0],[5009,17,5009,74,0],[5010,13,5010,14,0],[5012,13,5012,56,0],[5013,13,5013,14,0],[5014,17,5014,115,0],[5015,17,5015,107,0],[5016,17,5016,88,0],[5017,17,5017,91,0],[5018,13,5018,14,0],[5020,13,5020,58,0],[5021,13,5021,14,0],[5022,17,5022,117,0],[5023,17,5023,109,0],[5026,17,5026,93,0],[5027,17,5027,92,0],[5034,13,5034,14,0],[5036,13,5036,52,0],[5037,13,5037,14,0],[5038,17,5038,109,0],[5039,17,5039,103,0],[5040,17,5040,87,0],[5041,17,5042,76,0],[5043,13,5043,14,0],[5045,13,5045,55,0],[5046,13,5046,14,0],[5047,17,5047,112,0],[5048,17,5048,106,0],[5049,17,5049,90,0],[5050,17,5051,80,0],[5052,13,5052,14,0],[5054,13,5054,61,0],[5055,13,5055,14,0],[5056,17,5056,118,0],[5057,17,5057,112,0],[5058,17,5058,96,0],[5059,17,5061,117,0],[5062,13,5062,14,0],[5064,13,5064,57,0],[5065,13,5065,14,0],[5066,17,5066,114,0],[5067,17,5067,108,0],[5068,17,5068,92,0],[5069,17,5071,113,0],[5072,17,5072,88,0],[5073,17,5073,93,0],[5074,17,5074,43,0],[5075,17,5075,18,0],[5076,21,5076,91,0],[5077,21,5077,96,0],[5078,17,5078,18,0],[5079,13,5079,14,0],[5081,13,5081,57,0],[5082,13,5082,14,0],[5083,17,5083,116,0],[5084,17,5084,108,0],[5085,17,5085,92,0],[5086,17,5086,94,0],[5087,17,5087,72,0],[5088,13,5088,14,0],[5090,13,5090,59,0],[5091,13,5091,14,0],[5092,17,5092,74,0],[5093,13,5093,14,0],[5095,13,5095,52,0],[5096,13,5096,14,0],[5097,17,5097,67,0],[5098,13,5098,14,0],[5100,13,5100,56,0],[5101,13,5101,14,0],[5102,17,5102,71,0],[5103,13,5103,14,0],[5105,13,5105,53,0],[5106,13,5106,14,0],[5107,17,5107,88,0],[5108,13,5108,14,0],[5110,13,5110,58,0],[5111,13,5111,14,0],[5112,17,5112,92,0],[5113,17,5113,93,0],[5114,13,5114,14,0],[5116,13,5116,56,0],[5117,13,5117,14,0],[5119,17,5119,86,0],[5120,17,5120,86,0],[5121,13,5121,14,0],[5123,13,5123,20,0],[5123,22,5123,38,0],[5123,39,5123,41,0],[5123,42,5123,56,0],[5124,13,5124,14,0],[5125,17,5125,50,0],[5126,17,5126,18,0],[5127,21,5127,73,0],[5129,21,5129,22,0],[5130,25,5130,62,0],[5131,25,5131,26,0],[5132,29,5132,94,0],[5133,29,5133,93,0],[5134,25,5134,26,0],[5135,21,5135,22,0],[5136,17,5136,18,0],[5137,17,5137,52,0],[5138,17,5138,18,0],[5139,21,5139,85,0],[5140,21,5144,59,0],[5145,21,5145,119,0],[5146,21,5147,91,0],[5148,21,5148,89,0],[5149,17,5149,18,0],[5150,13,5150,14,0],[5151,9,5151,10,0],[5159,9,5159,10,0],[5160,13,5160,41,0],[5161,13,5161,56,0],[5162,13,5162,38,0],[5163,13,5163,22,0],[5164,9,5164,10,0],[5171,9,5171,10,0],[5172,13,5172,84,0],[5173,13,5173,87,0],[5174,13,5174,53,0],[5175,13,5175,36,0],[5176,13,5176,28,0],[5177,13,5177,36,0],[5178,13,5178,61,0],[5179,13,5180,72,0],[5181,13,5181,20,0],[5181,22,5181,33,0],[5181,34,5181,36,0],[5181,37,5181,50,0],[5182,13,5182,14,0],[5183,17,5183,78,0],[5184,13,5184,14,0],[5185,13,5185,42,0],[5186,13,5186,14,0],[5187,17,5187,62,0],[5188,17,5188,53,0],[5189,17,5189,24,0],[5189,26,5189,37,0],[5189,38,5189,40,0],[5189,41,5189,54,0],[5190,17,5190,18,0],[5191,21,5191,72,0],[5193,21,5193,50,0],[5194,21,5194,22,0],[5195,25,5195,60,0],[5196,25,5196,44,0],[5197,21,5197,22,0],[5199,21,5199,22,0],[5200,25,5200,67,0],[5201,25,5201,37,0],[5202,21,5202,22,0],[5204,21,5204,37,0],[5205,21,5205,51,0],[5206,21,5206,35,0],[5207,21,5207,41,0],[5208,21,5208,45,0],[5209,25,5209,31,0],[5210,17,5210,18,0],[5211,17,5211,44,0],[5212,17,5212,45,0],[5213,17,5213,45,0],[5214,17,5214,80,0],[5215,13,5215,14,0],[5216,9,5216,10,0],[5223,9,5223,10,0],[5224,13,5224,45,0],[5226,13,5226,43,0],[5227,13,5227,44,0],[5228,13,5228,40,0],[5229,13,5229,58,0],[5231,13,5231,43,0],[5232,13,5232,41,0],[5233,13,5233,48,0],[5234,13,5234,58,0],[5236,13,5236,43,0],[5237,13,5237,48,0],[5238,13,5238,45,0],[5239,13,5239,58,0],[5241,13,5241,28,0],[5242,9,5242,10,0],[5245,9,5245,10,0],[5246,13,5246,45,0],[5248,13,5248,43,0],[5249,13,5249,44,0],[5250,13,5250,40,0],[5251,13,5251,58,0],[5253,13,5253,43,0],[5254,13,5254,50,0],[5255,13,5255,46,0],[5256,13,5256,58,0],[5258,13,5258,43,0],[5259,13,5259,57,0],[5260,13,5260,53,0],[5261,13,5261,58,0],[5263,13,5263,28,0],[5264,9,5264,10,0],[5277,9,5277,10,0],[5279,13,5279,14,0],[5280,17,5280,66,0],[5281,17,5281,102,0],[5282,17,5282,18,0],[5283,21,5283,55,0],[5284,21,5284,47,0],[5285,21,5285,53,0],[5287,21,5287,86,0],[5288,25,5288,126,0],[5290,21,5290,118,0],[5291,25,5292,129,0],[5293,26,5293,121,0],[5294,25,5295,127,0],[5297,21,5297,115,0],[5298,25,5299,126,0],[5300,26,5300,128,0],[5301,25,5302,134,0],[5304,21,5304,94,0],[5305,17,5305,18,0],[5306,22,5306,45,0],[5307,21,5307,58,0],[5308,17,5308,42,0],[5309,17,5309,55,0],[5310,17,5310,134,0],[5311,13,5311,14,0],[5312,13,5312,30,0],[5313,13,5313,14,0],[5314,17,5314,33,0],[5315,17,5315,31,0],[5316,13,5316,14,0],[5317,9,5317,10,0],[5325,9,5325,10,0],[5326,13,5326,42,0],[5327,9,5327,10,0],[5335,9,5335,10,0],[5336,13,5336,61,0],[5338,13,5338,105,0],[5339,13,5339,61,0],[5340,13,5340,111,0],[5341,13,5341,55,0],[5342,13,5342,36,0],[5343,13,5343,28,0],[5344,13,5344,20,0],[5344,22,5344,32,0],[5344,33,5344,35,0],[5344,36,5344,60,0],[5345,13,5345,14,0],[5346,17,5346,48,0],[5347,17,5347,18,0],[5348,21,5350,27,0],[5351,25,5351,34,0],[5352,17,5352,18,0],[5354,17,5354,18,0],[5355,21,5357,41,0],[5358,25,5358,34,0],[5359,17,5359,18,0],[5361,17,5361,45,0],[5363,17,5363,33,0],[5364,17,5364,47,0],[5365,17,5365,45,0],[5367,17,5367,48,0],[5368,17,5368,18,0],[5369,21,5369,46,0],[5370,21,5370,46,0],[5371,21,5371,54,0],[5372,21,5372,51,0],[5373,17,5373,18,0],[5375,17,5375,18,0],[5376,21,5376,50,0],[5377,21,5377,52,0],[5378,21,5378,47,0],[5379,21,5379,59,0],[5380,17,5380,18,0],[5382,17,5382,45,0],[5383,17,5383,51,0],[5384,17,5384,47,0],[5385,17,5385,50,0],[5386,17,5386,48,0],[5387,17,5387,47,0],[5388,17,5388,45,0],[5389,17,5389,47,0],[5390,17,5390,49,0],[5391,17,5391,43,0],[5392,17,5392,52,0],[5394,17,5394,83,0],[5395,17,5395,98,0],[5396,17,5396,117,0],[5397,17,5397,67,0],[5399,17,5399,41,0],[5401,17,5401,53,0],[5402,17,5402,18,0],[5405,21,5405,117,0],[5406,17,5406,18,0],[5407,17,5407,54,0],[5408,17,5408,18,0],[5409,21,5409,86,0],[5410,21,5410,85,0],[5411,17,5411,18,0],[5412,17,5412,55,0],[5413,13,5413,14,0],[5414,13,5414,93,0],[5416,13,5416,52,0],[5417,13,5417,134,0],[5418,13,5418,35,0],[5419,13,5419,100,0],[5420,13,5420,41,0],[5422,13,5422,42,0],[5423,13,5423,42,0],[5424,13,5424,14,0],[5425,17,5425,104,0],[5426,17,5426,53,0],[5427,17,5427,43,0],[5428,13,5428,14,0],[5429,9,5429,10,0],[5437,9,5437,10,0],[5438,13,5438,106,0],[5439,13,5439,44,0],[5440,13,5440,33,0],[5441,9,5441,10,0],[5447,9,5447,10,0],[5448,13,5448,44,0],[5449,17,5451,120,0],[5453,17,5456,99,0],[5457,13,5457,73,0],[5458,9,5458,10,0],[5465,9,5465,10,0],[5466,13,5466,94,0],[5467,17,5470,91,0],[5471,18,5471,88,0],[5472,17,5478,90,0],[5480,17,5486,96,0],[5487,13,5487,71,0],[5488,9,5488,10,0],[5491,9,5491,10,0],[5492,13,5492,45,0],[5493,13,5493,30,0],[5494,13,5494,45,0],[5496,13,5496,72,0],[5497,9,5497,10,0],[5500,9,5500,10,0],[5501,13,5501,94,0],[5502,17,5502,42,0],[5503,18,5503,98,0],[5504,17,5504,41,0],[5506,17,5506,48,0],[5507,9,5507,10,0],[5510,9,5510,10,0],[5511,13,5511,45,0],[5512,13,5512,43,0],[5513,13,5513,105,0],[5514,13,5514,39,0],[5515,13,5515,58,0],[5517,13,5517,43,0],[5518,13,5518,53,0],[5519,13,5519,43,0],[5520,13,5520,58,0],[5522,13,5522,43,0],[5523,13,5523,48,0],[5524,13,5524,45,0],[5525,13,5525,58,0],[5532,13,5532,28,0],[5533,9,5533,10,0],[5536,9,5536,10,0],[5537,13,5537,45,0],[5538,13,5538,43,0],[5539,13,5539,44,0],[5540,13,5540,40,0],[5541,13,5541,58,0],[5543,13,5543,43,0],[5544,13,5544,53,0],[5545,13,5545,43,0],[5546,13,5546,58,0],[5548,13,5548,43,0],[5549,13,5549,48,0],[5550,13,5550,45,0],[5551,13,5551,58,0],[5553,13,5553,43,0],[5554,13,5554,45,0],[5555,13,5555,52,0],[5556,13,5556,58,0],[5558,13,5558,28,0],[5559,9,5559,10,0],[5562,9,5562,10,0],[5563,13,5563,45,0],[5564,13,5564,43,0],[5565,13,5565,47,0],[5566,13,5566,43,0],[5567,13,5567,58,0],[5569,13,5569,28,0],[5570,9,5570,10,0],[5574,9,5574,10,0],[5576,13,5576,14,0],[5577,17,5577,64,0],[5578,17,5578,51,0],[5579,17,5579,18,0],[5580,21,5580,55,0],[5581,21,5581,47,0],[5582,21,5582,52,0],[5583,21,5583,22,0],[5585,25,5585,106,0],[5586,29,5588,121,0],[5590,29,5592,122,0],[5593,25,5596,66,0],[5597,25,5600,78,0],[5601,25,5604,75,0],[5605,25,5605,46,0],[5606,29,5606,46,0],[5607,25,5607,106,0],[5608,29,5612,55,0],[5613,30,5613,100,0],[5614,29,5618,55,0],[5619,21,5619,22,0],[5621,21,5621,22,0],[5623,25,5626,59,0],[5627,25,5627,46,0],[5628,29,5628,46,0],[5629,25,5630,112,0],[5631,21,5631,22,0],[5632,17,5632,18,0],[5634,17,5634,18,0],[5635,21,5635,42,0],[5636,25,5636,42,0],[5637,21,5637,54,0],[5638,17,5638,18,0],[5639,17,5639,42,0],[5640,17,5640,53,0],[5641,17,5641,109,0],[5642,13,5642,14,0],[5643,13,5643,30,0],[5644,13,5644,14,0],[5645,17,5645,33,0],[5646,17,5646,31,0],[5647,13,5647,14,0],[5648,9,5648,10,0],[5651,9,5651,10,0],[5652,13,5652,73,0],[5653,13,5653,75,0],[5654,13,5654,23,0],[5655,13,5655,55,0],[5656,13,5656,20,0],[5656,22,5656,33,0],[5656,34,5656,36,0],[5656,37,5656,55,0],[5657,13,5657,14,0],[5658,17,5658,24,0],[5658,26,5658,42,0],[5658,43,5658,45,0],[5658,46,5658,60,0],[5659,17,5659,18,0],[5660,21,5660,52,0],[5661,21,5661,22,0],[5662,25,5663,110,0],[5664,25,5664,26,0],[5665,29,5665,81,0],[5666,29,5666,33,0],[5667,29,5667,35,0],[5669,21,5669,22,0],[5671,21,5671,22,0],[5672,25,5674,114,0],[5675,25,5675,26,0],[5676,29,5676,81,0],[5677,29,5677,84,0],[5678,29,5678,33,0],[5679,29,5679,35,0],[5681,21,5681,22,0],[5682,17,5682,18,0],[5683,13,5683,14,0],[5684,18,5684,27,0],[5684,29,5684,34,0],[5684,36,5684,39,0],[5685,13,5685,14,0],[5687,17,5687,48,0],[5688,21,5688,89,0],[5690,21,5692,73,0],[5693,17,5693,48,0],[5694,17,5694,47,0],[5696,13,5696,14,0],[5697,13,5697,43,0],[5698,13,5698,14,0],[5699,17,5701,48,0],[5702,17,5702,45,0],[5703,17,5703,55,0],[5704,17,5704,18,0],[5705,21,5705,63,0],[5706,17,5706,18,0],[5707,17,5708,112,0],[5709,13,5709,14,0],[5710,13,5710,111,0],[5712,13,5712,20,0],[5712,22,5712,33,0],[5712,34,5712,36,0],[5712,37,5712,55,0],[5713,13,5713,14,0],[5714,17,5714,60,0],[5715,17,5715,98,0],[5716,21,5745,65,0],[5747,17,5747,18,0],[5748,21,5748,52,0],[5749,25,5778,69,0],[5780,25,5812,69,0],[5813,17,5813,18,0],[5814,13,5814,14,0],[5815,13,5815,42,0],[5816,13,5816,42,0],[5817,13,5817,14,0],[5818,17,5818,104,0],[5819,17,5819,53,0],[5820,17,5820,43,0],[5821,13,5821,14,0],[5822,13,5822,48,0],[5823,9,5823,10,0],[5826,9,5826,10,0],[5827,13,5827,42,0],[5828,9,5828,10,0],[5857,9,5857,36,0],[5858,9,5858,10,0],[5859,13,5859,34,0],[5860,13,5860,41,0],[5861,13,5861,42,0],[5862,13,5862,55,0],[5864,13,5864,65,0],[5865,13,5865,95,0],[5866,9,5866,10,0],[5869,9,5869,10,0],[5874,13,5874,69,0],[5875,9,5875,10,0],[5878,9,5878,10,0],[5879,13,5879,70,0],[5880,13,5880,66,0],[5881,13,5881,70,0],[5882,13,5882,76,0],[5883,13,5883,80,0],[5885,13,5885,41,0],[5889,21,5889,41,0],[5890,21,5890,27,0],[5892,21,5892,41,0],[5893,21,5893,27,0],[5895,21,5895,33,0],[5896,21,5896,27,0],[5898,21,5898,35,0],[5899,21,5899,27,0],[5901,9,5901,10,0],[5904,9,5904,10,0],[5905,13,5905,33,0],[5906,13,5906,40,0],[5908,13,5908,14,0],[5909,17,5909,45,0],[5910,17,5910,48,0],[5911,17,5911,81,0],[5912,17,5912,69,0],[5913,17,5913,77,0],[5914,17,5914,52,0],[5915,17,5915,18,0],[5916,21,5916,43,0],[5918,21,5918,33,0],[5919,25,5919,81,0],[5920,21,5920,53,0],[5921,25,5921,51,0],[5923,21,5923,54,0],[5924,21,5924,117,0],[5925,21,5925,64,0],[5926,21,5926,42,0],[5927,21,5927,76,0],[5928,21,5928,67,0],[5929,17,5929,18,0],[5930,13,5930,14,0],[5931,13,5931,33,0],[5932,13,5932,14,0],[5933,17,5933,33,0],[5934,17,5934,70,0],[5935,17,5935,35,0],[5936,17,5936,63,0],[5937,17,5937,43,0],[5939,9,5939,10,0],[5942,9,5942,10,0],[5943,13,5943,34,0],[5944,13,5944,40,0],[5945,13,5945,35,0],[5946,13,5946,44,0],[5947,13,5947,77,0],[5948,13,5948,73,0],[5949,13,5949,65,0],[5952,13,5952,14,0],[5953,17,5953,67,0],[5954,17,5954,49,0],[5955,21,5955,47,0],[5957,17,5957,18,0],[5958,21,5958,37,0],[5959,21,5959,77,0],[5960,21,5960,40,0],[5961,21,5961,67,0],[5962,17,5962,18,0],[5963,13,5963,14,0],[5964,13,5964,33,0],[5965,13,5965,14,0],[5966,17,5966,34,0],[5967,17,5967,73,0],[5968,17,5968,35,0],[5969,17,5969,63,0],[5970,17,5970,43,0],[5972,9,5972,10,0],[5975,9,5975,10,0],[5976,13,5976,34,0],[5977,13,5977,40,0],[5978,13,5978,35,0],[5980,13,5980,50,0],[5981,13,5981,44,0],[5982,13,5982,77,0],[5983,13,5983,73,0],[5984,13,5984,65,0],[5985,13,5985,71,0],[5986,13,5986,75,0],[5987,13,5987,79,0],[5990,13,5990,14,0],[5991,17,5991,59,0],[5992,17,5992,49,0],[5993,21,5993,47,0],[5994,17,5994,107,0],[5995,17,5995,18,0],[5996,21,5996,66,0],[5997,21,5997,78,0],[5998,21,5998,76,0],[5999,21,6000,74,0],[6001,17,6001,18,0],[6002,17,6003,60,0],[6004,17,6004,18,0],[6005,21,6005,46,0],[6006,21,6006,22,0],[6007,25,6007,91,0],[6008,25,6008,69,0],[6009,21,6009,22,0],[6011,21,6011,37,0],[6012,21,6012,77,0],[6013,21,6013,59,0],[6014,21,6014,67,0],[6015,17,6015,18,0],[6017,17,6017,18,0],[6018,21,6018,38,0],[6019,21,6019,77,0],[6020,21,6020,67,0],[6021,21,6021,47,0],[6023,13,6023,14,0],[6024,13,6024,33,0],[6025,13,6025,14,0],[6026,17,6026,34,0],[6027,17,6027,73,0],[6028,17,6028,35,0],[6029,17,6029,63,0],[6030,17,6030,43,0],[6032,9,6032,10,0],[6035,9,6035,10,0],[6036,13,6036,104,0],[6037,13,6037,14,0],[6038,17,6038,40,0],[6039,17,6039,34,0],[6040,17,6040,39,0],[6042,17,6042,54,0],[6043,17,6043,38,0],[6046,17,6046,48,0],[6047,17,6047,81,0],[6048,17,6048,77,0],[6049,17,6049,69,0],[6052,17,6052,74,0],[6053,17,6053,52,0],[6056,17,6056,18,0],[6058,21,6058,111,0],[6059,21,6059,22,0],[6060,25,6060,133,0],[6061,25,6061,98,0],[6062,21,6062,22,0],[6064,21,6064,22,0],[6065,25,6065,37,0],[6066,29,6067,82,0],[6068,25,6068,88,0],[6069,25,6069,49,0],[6070,25,6070,26,0],[6071,29,6071,85,0],[6074,25,6074,26,0],[6075,29,6075,47,0],[6076,29,6076,87,0],[6077,29,6077,97,0],[6078,25,6078,26,0],[6079,21,6079,22,0],[6080,17,6080,18,0],[6081,17,6081,37,0],[6082,17,6082,18,0],[6083,21,6083,40,0],[6084,21,6084,79,0],[6085,21,6085,39,0],[6086,21,6086,67,0],[6087,21,6087,47,0],[6089,13,6089,14,0],[6091,17,6092,63,0],[6093,9,6093,10,0],[6096,9,6096,10,0],[6098,13,6098,14,0],[6099,17,6099,45,0],[6100,17,6100,52,0],[6101,17,6101,18,0],[6102,21,6102,33,0],[6103,21,6103,22,0],[6104,25,6104,87,0],[6105,25,6105,59,0],[6105,60,6105,88,0],[6106,21,6106,22,0],[6107,17,6107,18,0],[6108,17,6108,95,0],[6110,13,6110,14,0],[6111,13,6111,33,0],[6112,13,6112,14,0],[6113,17,6113,121,0],[6115,13,6115,33,0],[6116,9,6116,10,0],[6119,9,6119,10,0],[6121,13,6121,14,0],[6122,17,6122,39,0],[6123,17,6123,45,0],[6124,17,6124,52,0],[6125,17,6125,18,0],[6128,21,6128,33,0],[6129,21,6129,22,0],[6130,25,6130,87,0],[6131,25,6131,59,0],[6131,60,6131,88,0],[6132,21,6132,22,0],[6133,21,6133,54,0],[6134,17,6134,18,0],[6136,17,6136,81,0],[6137,17,6137,47,0],[6138,17,6138,49,0],[6140,17,6140,88,0],[6141,17,6141,53,0],[6142,21,6143,61,0],[6144,13,6144,14,0],[6145,13,6145,33,0],[6146,13,6146,14,0],[6147,17,6147,121,0],[6149,13,6149,33,0],[6150,9,6150,10,0],[6153,9,6153,10,0],[6154,13,6154,46,0],[6156,13,6156,103,0],[6157,13,6157,31,0],[6159,9,6159,10,0],[6162,9,6162,10,0],[6163,13,6163,77,0],[6164,13,6164,75,0],[6165,13,6165,76,0],[6166,13,6166,36,0],[6167,17,6167,123,0],[6169,17,6170,61,0],[6171,13,6171,103,0],[6172,13,6172,14,0],[6173,17,6173,114,0],[6174,13,6174,14,0],[6175,9,6175,10,0]]);
    </script>
  </body>
</html>