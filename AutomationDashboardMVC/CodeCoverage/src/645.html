<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\BL\SQLData.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.ConcreteModels.Utility;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Newtonsoft.Json;

namespace Aurigo.DataBinding
{
    public class SQLData
    {
        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Context&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;parentID&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;calendarID&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;qpid&quot;&gt;if qpid for the project is know then pass here. otherwise it will be got from URL param&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public ScheduleDetails GetData(string Context, int parentID, int calendarID, int? qpid = null)
        {
            ScheduleDetails details = new ScheduleDetails();
            ScheduleUpdationModel model = ScheduleUpdationModel.GetInstance(Context); //&quot;CONTMGT&quot;
            if (model != null)
            {
                if (qpid.HasValue)
                    details = model.GetDetails(parentID, qpid.Value);
                else
                    details = model.GetDetails(parentID);

            }
            return details;
        }

        public ScheduleDetails GetFilteredData(string Context, int parentID, int calendarID, string filterXml)
        {
            ScheduleDetails details = new ScheduleDetails();
            ScheduleUpdationModel model = ScheduleUpdationModel.GetInstance(Context); //&quot;CONTMGT&quot;
            if (model != null)
                details = model.GetDetailsWithFilter(parentID, filterXml);
            return details;
        }

        public bool SaveData(string Context, List&lt;TaskInfo&gt; xmlData, int parentID, int PID, int UID)
        {
            ScheduleUpdationModel model = ScheduleUpdationModel.GetInstance(Context);
            if (model != null)
            {
                model.SaveSchedule(xmlData, parentID, PID, UID);
                model.SaveDetails(xmlData, parentID, PID, UID);
            }
            return true;
        }

        public bool SaveGanttViewInclude(string Context, int InstanceID, string xmlData, int parentID, int PID, int UID,
            int RID)
        {
            ScheduleUpdationModel model = ScheduleUpdationModel.GetInstance(Context);
            if (model != null)
            {
                model.SaveGanttViewInclude(Context, InstanceID, xmlData, parentID, PID, UID, RID);
            }
            return true;
        }

        public TaskInfo GetYearWiseSplit(string Context, int parentID, DateTime planYear, TaskInfo task)
        {
            ScheduleUpdationModel model = ScheduleUpdationModel.GetInstance(Context);
            if (model != null)
                task = model.GetYearWiseSplit(parentID, planYear, task);
            return task;
        }

        private Dictionary&lt;string, Type&gt; _ContextDictionary = null;

        private Dictionary&lt;string, Type&gt; ContextDictionary
        {
            get
            {
                if (_ContextDictionary == null)
                    _ContextDictionary = ScheduleUpdationModel.GetModelObjects();
                return _ContextDictionary;
            }
        }

        //private Tuple&lt;DateTime?, DateTime?&gt; ProjectStartAndEndDate = new Tuple&lt;DateTime?, DateTime?&gt;(null, null);

        public CalendarDetails GetLibraryCalendarDetails(int calendarID, int ContractID = 0)
        {
            CalendarDetails _Calendar = new CalendarDetails();
            _Calendar.ID = calendarID;
            //if (ProjectStartAndEndDate.Item1.HasValue)
            //    _Calendar.ProjectStartDate = ProjectStartAndEndDate.Item1.Value;
            //if (ProjectStartAndEndDate.Item2.HasValue)
            //    _Calendar.ProjectEndDate = ProjectStartAndEndDate.Item2.Value;
            int CurrentPage = 1;
            int count;
            Dictionary&lt;string, string&gt; filter = new Dictionary&lt;string, string&gt;();
            filter.Add(&quot;ID&quot;, calendarID.ToString());
            bool LibraryCalender = true;
            DataTable dt = new DataTable();
            if (ContractID == 0)
                dt = GetLibraryCalendarList(filter);
            else
                dt = GetLibraryCalendarListWithAdditionalParameter(calendarID, out LibraryCalender, filter, ContractID);

            if (dt != null &amp;&amp; dt.Rows.Count &gt; 0)
            {
                DataRow dr = dt.Rows[0];
                _Calendar.Name = dr[&quot;Name&quot;].ToString();
                string time = dr[&quot;DefaultStartTime&quot;].ToString();
                _Calendar.DefaultStartTime = Convert.ToDateTime(time).TimeOfDay;
                time = dr[&quot;DefaultEndTime&quot;].ToString();
                _Calendar.DefaultEndTime = Convert.ToDateTime(time).TimeOfDay;
                string hrs = dr[&quot;Hours&quot;].ToString();
                _Calendar.Hours = new TimeSpan(Convert.ToInt32(hrs.Substring(0, 2)),
                    Convert.ToInt32(hrs.Substring(3, 2)), 0);
                _Calendar.WeekStartDay = (DayOfWeek)Enum.Parse(typeof(DayOfWeek), dr[&quot;WeekStartDay&quot;].ToString());
                _Calendar.WorkingDays = new List&lt;DayOfWeek&gt;();
                string workingDays = dr[&quot;WorkingDays&quot;].ToString();
                if (!string.IsNullOrEmpty(workingDays))
                    foreach (string dw in workingDays.Split(&#39;,&#39;))
                        _Calendar.WorkingDays.Add((DayOfWeek)Enum.Parse(typeof(DayOfWeek), dw));
                filter.Remove(&quot;ID&quot;);

                if (LibraryCalender)
                    filter.Add(&quot;CalendarID&quot;, calendarID.ToString());
                else
                    filter.Add(&quot;CalendarID&quot;, dr[&quot;ID&quot;].ToString());

                _Calendar.Holidays = new List&lt;DateTime&gt;();

                DataSet dsReturn = CoreDatabaseHelper.GetODSData(&quot;LIBRARYCalendarHolidays&quot;, int.MaxValue, &quot;ID&quot;, null,
                    true, ref CurrentPage, out count, null, filter);

                if (dsReturn != null &amp;&amp; dsReturn.Tables.Count &gt; 0)
                    foreach (DataRow holiday in dsReturn.Tables[0].Rows)
                        _Calendar.Holidays.Add(Convert.ToDateTime(holiday[&quot;Date&quot;].ToString()));
                dsReturn = null;
                if (!dr[&quot;CalendarType&quot;].Equals(DBNull.Value))
                {
                    _Calendar.CalendarType = Convert.ToInt32(dr[&quot;CalendarType&quot;]);
                    if (_Calendar.CalendarType == 1)
                    {
                        try
                        {
                            if (LibraryCalender)
                                dsReturn = CoreDatabaseHelper.GetODSData(&quot;LIBRARYCalendarCurve&quot;, int.MaxValue, &quot;ID&quot;,
                                    null, true, ref CurrentPage, out count, null, filter);
                            else
                                dsReturn = CoreDatabaseHelper.GetODSData(&quot;CONTMGTCalendarCurve&quot;, int.MaxValue, &quot;ID&quot;,
                                    null, true, ref CurrentPage, out count, null, filter);
                        }
                        catch
                        {
                        }
                        if (dsReturn != null &amp;&amp; dsReturn.Tables.Count &gt; 0)
                        {
                            int totDays = 0;
                            foreach (DataRow curve in dsReturn.Tables[0].Rows)
                            {
                                totDays += double.Parse(curve[&quot;WorkingDays&quot;].ToString()).ToInt32_2();
                                _Calendar.MonthWiseWorkDays.Add(new Tuple&lt;int, int&gt;(
                                    double.Parse(curve[&quot;WorkingDays&quot;].ToString()).ToInt32_2(),
                                    ((Months)Enum.Parse(typeof(Months), curve[&quot;Month&quot;].ToString())).ToInt32_2()));
                            }
                            _Calendar.TotalMonthWiseWorkDays = totDays;
                        }
                    }
                }
            }
            return _Calendar;
        }

        public decimal GetYearWiseValue(CalendarDetails calendar, TaskInfo task, Decimal value, decimal totDays,
            DateTime planYear)
        {
            return new PlatformCalendarCalculations().GetYearWiseValue(calendar, task, value, totDays, planYear);
        }

        public int GetWorkingDaysCount(DateTime startDate, DateTime endDate, CalendarDetails calendar,
            bool useDefaultCalendar = false) //int calandarID, 
        {
            return
                Convert.ToInt32(new PlatformCalendarCalculations().GetWorkingDaysCount(startDate, endDate, calendar,
                    useDefaultCalendar));
        }

        public DateTime GetEndDate(DateTime startDate, int days, CalendarDetails calendar, int calendarType = 1) //, int calandarID
        {
            // Note: CalendarType -&gt; 0 - Calendar Days, 1 - Working Days
            if (calendarType == 0)
                return startDate.AddDays(days - 1);
            else
                return new PlatformCalendarCalculations().GetEndDate(startDate, days, calendar);
        }

        public DataTable GetLibraryCalendarList(Dictionary&lt;string, string&gt; filter = null)
        {
            int CurrentPage = 1;
            int count;
            DataSet dsReturn = CoreDatabaseHelper.GetODSData(&quot;LIBRARYCalendar&quot;, int.MaxValue, &quot;Name&quot;, null, true,
                ref CurrentPage, out count, null, filter);
            if (dsReturn != null &amp;&amp; dsReturn.Tables.Count &gt; 0)
            {
                DataTable dt = dsReturn.Tables[0];
                foreach (DataRow dr in dt.Rows)
                {
                    if (dr[&quot;CalendarType&quot;].ToInt32_2() == 1)
                        dr[&quot;Name&quot;] = &quot;{0}&quot;.Format2(dr[&quot;Name&quot;]);
                }
                return dt;
            }
            return null;
        }

        public DataTable GetLibraryCalendarListWithAdditionalParameter(int calendarID, out bool LibraryCalender,
            Dictionary&lt;string, string&gt; filter = null, int ContractID = 0)
        {
            int CurrentPage = 1;
            int count;
            DataSet dsReturn = new DataSet();
            if (ContractID == 0)
            {
                LibraryCalender = true;
                dsReturn = CoreDatabaseHelper.GetODSData(&quot;LIBRARYCalendar&quot;, int.MaxValue, &quot;Name&quot;, null, true,
                    ref CurrentPage, out count, null, filter);
            }
            else
            {
                DataSet dsGetLibraryCalender = CoreDatabaseHelper.GetODSData(&quot;LIBRARYCalendar&quot;, int.MaxValue, &quot;Name&quot;,
                    null, true, ref CurrentPage, out count, null, filter);
                string LIBRARYCalendarName = &quot;&quot;;
                string CONTMGTCalendarName = &quot;&quot;;

                //Getting Library Calender Name
                if (dsGetLibraryCalender != null &amp;&amp; dsGetLibraryCalender.Tables.Count &gt; 0 &amp;&amp;
                    dsGetLibraryCalender.Tables[0].Rows.Count &gt; 0)
                {
                    LIBRARYCalendarName = dsGetLibraryCalender.Tables[0].Rows[0][&quot;Name&quot;].ToString();
                }

                filter.Clear();
                filter.Add(&quot;ContractID&quot;, ContractID.ToString());
                filter.Add(&quot;IsLatest&quot;, &quot;1&quot;.ToString());

                dsReturn = CoreDatabaseHelper.GetODSData(&quot;CONTMGTCalendar&quot;, int.MaxValue, &quot;Name&quot;, null, true,
                    ref CurrentPage, out count, null, filter);

                //Getting Contract Calender Name and LatestOne
                if (dsReturn != null &amp;&amp; dsReturn.Tables.Count &gt; 0 &amp;&amp; dsReturn.Tables[0].Rows.Count &gt; 0)
                {
                    CONTMGTCalendarName = dsReturn.Tables[0].Rows[0][&quot;Name&quot;].ToString();
                }

                filter.Remove(&quot;ContractID&quot;);
                filter.Remove(&quot;IsLatest&quot;);

                //if (!(dsReturn != null &amp;&amp; dsReturn.Tables.Count &gt; 0))
                if (LIBRARYCalendarName.ToUpper() != CONTMGTCalendarName.ToUpper())
                {
                    dsReturn = dsGetLibraryCalender;
                    LibraryCalender = true;
                }
                else
                    LibraryCalender = false;
            }

            if (dsReturn != null &amp;&amp; dsReturn.Tables.Count &gt; 0)
            {
                DataTable dt = dsReturn.Tables[0];
                foreach (DataRow dr in dt.Rows)
                {
                    if (dr[&quot;CalendarType&quot;].ToInt32_2() == 1)
                        dr[&quot;Name&quot;] = &quot;{0}(Expenditure Curve)&quot;.Format2(dr[&quot;Name&quot;]);
                }
                return dt;
            }
            return null;
        }
    }

    [Serializable]
    public class TagInfo
    {
        public TagInfo()
        {
        }

        //string.Format(&quot;A,{0},{1},{2}&quot;, containerID, itemid, subitemid, activityid)
        public char Type { get; set; } //&#39;A&#39;,&#39;S&#39;,&#39;I&#39;,&#39;C&#39;,&#39;R&#39;(activity,subitem,item,container,root-contract), &#39;O&#39; - Other
        public string ContainerID { get; set; }
        public int ItemID { get; set; }
        public int SubItemID { get; set; }
        public int ActivityID { get; set; }
        public Decimal Quantity { get; set; }

        public override string ToString()
        {
            return string.Format(&quot;{0},{1},{2},{3},{4}&quot;, Type, ContainerID, ItemID, SubItemID, ActivityID);
        }
    }

    [Serializable]
    public class TaskInfo
    {
        public TaskInfo()
        {
            Include = true;
        }

        // Summary:
        //     The description of this task.
        public string Description { get; set; }
        //
        // Summary:
        //     The required effort of the task.
        public TimeSpan Effort { get; set; }
        //
        // Summary:
        //     The unique ID of this task.
        public int ID { get; set; }
        //
        // Summary:
        //     The Indent level that dictates the parent-child relationship between this
        //     activity and it&#39;s adjacent activities.
        public int IndentLevel { get; set; }
        //
        // Summary:
        //     Represents the expanded state of the activity. This is currently not used.
        public bool IsOpen { get; set; }
        //
        // Summary:
        //     The name of this activity.
        public string Name { get; set; }
        //
        // Summary:
        //     A string that represents the predecessors of this taks.
        public string PredecessorIndices { get; set; }
        //
        // Summary:
        //     The preferred start time of the activity.
        public DateTime PreferredStartTime { get; set; }
        //
        // Summary:
        //     Place holder for the task&#39;s priority.
        public int Priority { get; set; }
        //
        // Summary:
        //     The amount of work that&#39;s completed in percentage.
        public double ProgressPercent { get; set; }
        //
        // Summary:
        //     The resources that are currently assigned to this task.
        public string Resources { get; set; }
        //
        // Summary:
        //     Specifies the order in which the items should be persisted.
        public int SortOrder { get; set; }


        DateTime startDate;
        //
        // Summary:
        //     The start time of the activity.
        public DateTime StartTime
        {
            get { return startDate; }

            set
            {
                startDate = DateTime.SpecifyKind(value, value.Kind);
            }
        }
        //
        // Summary:
        //     A place holder of any miscelaneous info.
        public TagInfo Tag { get; set; }

        public string Unit { get; set; }

        public string UnitPrice { get; set; }

        public decimal Quantity { get; set; }

        DateTime endDate;
        public DateTime EndTime
        {
            get { return endDate; }

            set
            {
                endDate = DateTime.SpecifyKind(value, value.Kind);
            }
        }

        public string Calendar { get; set; }

        public string Before { get; set; }

        public string After { get; set; }

        public string StatusName { get; set; }

        public Decimal Year1 { get; set; }

        public Decimal Year2 { get; set; }

        public Decimal Year3 { get; set; }

        public Decimal Year4 { get; set; }

        public Decimal Year5 { get; set; }

        public Decimal Year6 { get; set; }

        public Decimal Year7 { get; set; }

        public Decimal Year8 { get; set; }

        public Decimal Year9 { get; set; }

        public Decimal Year10 { get; set; }

        public Decimal Year11 { get; set; }

        public Decimal Year12 { get; set; }

        public Decimal Year13 { get; set; }

        public Decimal Year14 { get; set; }

        public Decimal Year15 { get; set; }

        public Decimal Year16 { get; set; }

        public Decimal Year17 { get; set; }

        public Decimal Year18 { get; set; }

        public Decimal Year19 { get; set; }

        public Decimal Year20 { get; set; }

        public string Status { get; set; }

        public string PriorityString { get; set; }

        public bool Include { get; set; }

        public bool IsLocked { get; set; }

        public int Days { get; set; }

        public bool IsAuto { get; set; }

        public double Progress { get; set; }

        public string ModuleID { get; set; }

        public string ParentID { get; set; }

        public int QPID { get; set; }

        // Inflation fields
        public bool IsInflationEnabled { get; set; }

        public decimal UninflatedQuantity { get; set; }

        private decimal annualInflationRate;
           
        public decimal AnnualInflationRate
        {
            get
            {
                return annualInflationRate;
            }
            set
            {
                annualInflationRate = IsInflationEnabled ? value : 0;
            }
        }

        private DateTime? inflationEffectiveFrom;

        public DateTime? InflationEffectiveFrom
        {
            get
            {
                return inflationEffectiveFrom;
            }
            set
            {
                inflationEffectiveFrom = IsInflationEnabled &amp;&amp; value != null ? value.ToDateTimeAndSetKindToUtc() : (DateTime?)null;
            }
        }

        public int QuantityPrecision
        {
            get
            {
                string format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                return format.Length - (format.LastIndexOf(&#39;.&#39;) == -1 ? format.Length - 1 : format.LastIndexOf(&#39;.&#39;)) - 1;
            }
        }
        // End of Inflation fields

        // Inflation methods
        public void InflateAmount()
        {
            // before inflation, copy and backup the uninflated quantity
            if (UninflatedQuantity == 0)
                UninflatedQuantity = Quantity;

            // ensure that Inflation is enabled, and Quantity isn&#39;t already inflated
            if (IsInflationEnabled &amp;&amp; Quantity == UninflatedQuantity)
                Tag.Quantity = Quantity = GetInflatedAmount(Quantity);
        }

        private decimal GetInflatedAmount(decimal amount)
        {
            return amount + GetInflation(amount);
        }

        private decimal GetInflation(decimal amount)
        {
            if (!IsInflationEnabled || amount == 0 || AnnualInflationRate == 0 || InflationEffectiveFrom == null || startDate == DateTime.MinValue)
            {
                return 0;
            }

            DateTime currentStartDate = startDate.ToDateTimeAndSetKindToUtc().Date;
            DateTime inflationEffectiveFrom = InflationEffectiveFrom.ToDateTimeAndSetKindToUtc().Date;
            int noOfDays = (currentStartDate - inflationEffectiveFrom).Days + 1;

            if (noOfDays &lt;= 0)
            {
                return 0;
            }

            decimal inflatedAmount = Math.Round(amount * (decimal)Math.Pow((1 + (double)annualInflationRate / 100.0), (noOfDays / 365.0)), QuantityPrecision);
            return inflatedAmount - amount;
        }
        // End of Inflation methods
    }

    [Serializable]
    public enum Months
    {
        January = 1,
        February = 2,
        March = 3,
        April = 4,
        May = 5,
        June = 6,
        July = 7,
        August = 8,
        September = 9,
        October = 10,
        November = 11,
        December = 12
    }

    [Serializable]
    public enum CalendarExceptionType
    {
        Holiday = 1,
        WorkingDay = 2
    }
    [Serializable]
    public class CalendarDetails
    {
        public int ID;
        public string Name;
        public DayOfWeek WeekStartDay;
        public TimeSpan DefaultStartTime;
        public TimeSpan DefaultEndTime;
        public TimeSpan Hours;
        public int CalendarType;
        public List&lt;DayOfWeek&gt; WorkingDays;
        public List&lt;DateTime&gt; Holidays;
        public List&lt;DateTime&gt; ExceptionalWorkingDays;
        public List&lt;DateTime&gt; AnnuallyRecurringHolidays;
        public List&lt;DateTime&gt; AnnuallyRecurringWorkingDays;
        public List&lt;Tuple&lt;int, int&gt;&gt; MonthWiseWorkDays;
        public string Culture;
        public string AmountFormat;
        public string DateFormat;
        public string DateTimeFormat;
        public string PercentageFormat;
        public string QuantityFormat;
        public string TimeFormat;
        public string UnitPriceFormat;
        public string AppName;
        public DateTime? ProjectStartDate;
        public DateTime? ProjectEndDate;
        public int TotalMonthWiseWorkDays;
        public int Days;
        public string BaseCalendar;
        public string ExceptionCalendar; //Gantt Exceptional Calendar

        public CalendarDetails()
        {
            ID = CalendarType = 0;
            Name = &quot;24Hours by 7Days Calendar(Default)&quot;;
            WeekStartDay = DayOfWeek.Sunday;
            DefaultStartTime = new TimeSpan(0, 0, 0);
            DefaultEndTime = new TimeSpan(23, 0, 0);
            Hours = new TimeSpan(23, 0, 0);
            BaseCalendar = &quot;MON 00:00:00 23:00:00;TUE 00:00:00 23:00:00;WED 00:00:00 23:00:00;THU 00:00:00 23:00:00;FRI 00:00:00 23:00:00;SAT 00:00:00 23:00:00&quot;;
            ExceptionCalendar = string.Empty;

            WorkingDays = new List&lt;DayOfWeek&gt;()
            {
                DayOfWeek.Monday,
                DayOfWeek.Tuesday,
                DayOfWeek.Wednesday,
                DayOfWeek.Thursday,
                DayOfWeek.Friday,
                DayOfWeek.Saturday,
                DayOfWeek.Sunday
            };

            Holidays = new List&lt;DateTime&gt;();
            ExceptionalWorkingDays = new List&lt;DateTime&gt;();
            AnnuallyRecurringHolidays = new List&lt;DateTime&gt;();
            AnnuallyRecurringWorkingDays = new List&lt;DateTime&gt;();
            MonthWiseWorkDays = new List&lt;Tuple&lt;int, int&gt;&gt;();
            //pass settings to control
            Culture = AMP3ApplicationSettings.Instance.Culture.Equals(&quot;en-ZW&quot;)
                ? &quot;en-IN&quot;
                : AMP3ApplicationSettings.Instance.Culture;
            AmountFormat = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            DateFormat = AMP3ApplicationSettings.Instance.FORMAT_DATE;
            DateTimeFormat = AMP3ApplicationSettings.Instance.FORMAT_DATETIME;
            PercentageFormat = AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE;
            QuantityFormat = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            TimeFormat = AMP3ApplicationSettings.Instance.FORMAT_TIME;
            UnitPriceFormat = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            AppName = AMP3ApplicationSettings.Instance.AppName;
        }

        public static CalendarDetails GetCalendarDetails(DataSet ds)
        {
            //We will be considering the recurring holiday for 50 years for WBS
            const int years = 50;
            CalendarDetails calendar = new CalendarDetails();

            if (ds != null &amp;&amp; ds.Tables.Count &gt; 1)
            {
                DataTable dtCalendarDetails = ds.Tables[0];
                DataTable dtExceptions = ds.Tables[1];

                if (dtCalendarDetails.Rows.Count &gt; 0)
                {
                    DataRow dr = dtCalendarDetails.Rows[0];
                    calendar.ID = dr[&quot;ID&quot;].ToInt16_2();
                    calendar.Name = dr[&quot;Name&quot;].ToString2();

                    string nonWorkingDays = dr[&quot;NonWorkingDays&quot;].ToString();
                    if (!string.IsNullOrEmpty(nonWorkingDays))
                        foreach (string dw in nonWorkingDays.Split(&#39;,&#39;))
                            calendar.WorkingDays.Remove((DayOfWeek)Enum.Parse(typeof(DayOfWeek), dw));

                    if (dtExceptions.Rows.Count &gt; 0)
                    {
                        foreach (DataRow row in dtExceptions.Rows)
                        {
                            if (CalendarExceptionType.Holiday == (CalendarExceptionType)Enum.Parse(typeof(CalendarExceptionType), row[&quot;Type&quot;].ToString()))
                            {
                                DateTime holiday = row[&quot;ExceptionDate&quot;].ToMWDateTime();
                                calendar.Holidays.Add(holiday);

                                if (row[&quot;IsRecurring&quot;].ToBoolean2())
                                {
                                    calendar.AnnuallyRecurringHolidays.Add(holiday);

                                    for (int i = 1; i &lt;= years; i++)
                                    {
                                        calendar.Holidays.Add(holiday.AddYears(i));
                                    }
                                }
                            }
                            else if (CalendarExceptionType.WorkingDay == (CalendarExceptionType)Enum.Parse(typeof(CalendarExceptionType), row[&quot;Type&quot;].ToString()))
                            {
                                DateTime workingDay = row[&quot;ExceptionDate&quot;].ToMWDateTime();
                                calendar.ExceptionalWorkingDays.Add(workingDay);

                                if (row[&quot;IsRecurring&quot;].ToBoolean2())
                                {
                                    calendar.AnnuallyRecurringWorkingDays.Add(workingDay);

                                    for (int i = 1; i &lt;= years; i++)
                                    {
                                        calendar.ExceptionalWorkingDays.Add(workingDay.AddYears(i));
                                    }
                                }
                            }

                        }
                    }

                }
            }

            return calendar;
        }

        public static CalendarDetails GetForecastCalendarDetails(DataSet ds)
        {
            CalendarDetails calendar = new CalendarDetails();

            if (ds != null &amp;&amp; ds.Tables.Count &gt; 1)
            {
                DataTable dtCalendarDetails = ds.Tables[0];
                DataTable dtMonthWiseWorkingDays = ds.Tables[1];

                if (dtCalendarDetails.Rows.Count &gt; 0)
                {
                    DataRow dr = dtCalendarDetails.Rows[0];
                    calendar.ID = dr[&quot;ID&quot;].ToInt16_2();
                    calendar.Name = dr[&quot;Name&quot;].ToString2();

                    calendar.WeekStartDay = (DayOfWeek)Enum.Parse(typeof(DayOfWeek), dr[&quot;WeekStartDay&quot;].ToString());

                    if (!dr[&quot;CalendarType&quot;].Equals(DBNull.Value))
                        calendar.CalendarType = Convert.ToInt32(dr[&quot;CalendarType&quot;]);

                    string starttime = Convert.ToString(dr[&quot;DefaultStartTime&quot;]);
                    calendar.DefaultStartTime = (calendar.CalendarType == 1)
                        ? TimeSpan.Zero
                        : Convert.ToDateTime(starttime).ToMWDateTime().TimeOfDay;

                    string endtime = Convert.ToString(dr[&quot;DefaultEndTime&quot;]);
                    calendar.DefaultEndTime = (calendar.CalendarType == 1)
                        ? new TimeSpan(24, 0, 0)
                        : Convert.ToDateTime(endtime).ToMWDateTime().TimeOfDay;

                    string hrs = Convert.ToString(dr[&quot;Hours&quot;]);
                    calendar.Hours = (calendar.CalendarType == 1)
                        ? new TimeSpan(24, 0, 0)
                        : new TimeSpan(Convert.ToInt32(hrs.Substring(0, 2)), Convert.ToInt32(hrs.Substring(3, 2)), 0);

                    string workingDays = dr[&quot;WorkingDays&quot;].ToString();
                    if (!string.IsNullOrEmpty(workingDays))
                        foreach (string dw in workingDays.Split(&#39;,&#39;))
                            calendar.WorkingDays.Remove((DayOfWeek)Enum.Parse(typeof(DayOfWeek), dw));
                }

                if (dtMonthWiseWorkingDays.Rows.Count &gt; 0)
                {
                    int totDays = 0;
                    foreach (DataRow curve in dtMonthWiseWorkingDays.Rows)
                    {
                        totDays += double.Parse(curve[&quot;WorkingDays&quot;].ToString()).ToInt32_2();
                        calendar.MonthWiseWorkDays.Add(new Tuple&lt;int, int&gt;(
                            double.Parse(curve[&quot;WorkingDays&quot;].ToString()).ToInt32_2(),
                            ((Months)Enum.Parse(typeof(Months), curve[&quot;Month&quot;].ToString())).ToInt32_2()));
                    }
                    calendar.TotalMonthWiseWorkDays = totDays;
                }
            }

            return calendar;
        }

        public override string ToString()
        {
            return JsonConvert.SerializeObject(this, Formatting.None);
        }
    }

    [Serializable]
    public class ScheduleDetails
    {
        public ScheduleDetails()
        {
            TaskInfoList = new List&lt;TaskInfo&gt;();
            CalendarInfo = new CalendarDetails();
        }

        public List&lt;TaskInfo&gt; TaskInfoList;
        public CalendarDetails CalendarInfo;
        public DateTime? ProjectStartDate;
        public DateTime? ProjectEndDate;
        public DateTime? StartDate;
        public DateTime? EndDate;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,1],[25,13,25,61,1],[26,13,26,86,1],[27,13,27,31,1],[28,13,28,14,1],[29,17,29,35,1],[30,21,30,70,0],[32,21,32,58,1],[34,13,34,14,1],[35,13,35,28,1],[36,9,36,10,1],[39,9,39,10,0],[40,13,40,61,0],[41,13,41,86,0],[42,13,42,31,0],[43,17,43,75,0],[44,13,44,28,0],[45,9,45,10,0],[48,9,48,10,0],[49,13,49,86,0],[50,13,50,31,0],[51,13,51,14,0],[52,17,52,65,0],[53,17,53,64,0],[54,13,54,14,0],[55,13,55,25,0],[56,9,56,10,0],[60,9,60,10,0],[61,13,61,86,0],[62,13,62,31,0],[63,13,63,14,0],[64,17,64,99,0],[65,13,65,14,0],[66,13,66,25,0],[67,9,67,10,0],[70,9,70,10,0],[71,13,71,86,0],[72,13,72,31,0],[73,17,73,73,0],[74,13,74,25,0],[75,9,75,10,0],[77,9,77,68,1],[82,13,82,14,0],[83,17,83,48,0],[84,21,84,82,0],[85,17,85,43,0],[86,13,86,14,0],[92,9,92,10,1],[93,13,93,63,1],[94,13,94,39,1],[99,13,99,33,1],[101,13,101,82,1],[102,13,102,53,1],[103,13,103,41,1],[104,13,104,44,1],[105,13,105,33,1],[106,17,106,53,0],[108,17,108,121,1],[110,13,110,49,1],[111,13,111,14,0],[112,17,112,41,0],[113,17,113,56,0],[114,17,114,65,0],[115,17,115,81,0],[116,17,116,56,0],[117,17,117,79,0],[118,17,118,53,0],[119,17,120,62,0],[121,17,121,114,0],[122,17,122,63,0],[123,17,123,67,0],[124,17,124,56,0],[125,21,125,28,0],[125,30,125,39,0],[125,40,125,42,0],[125,43,125,65,0],[126,25,126,97,0],[127,17,127,37,0],[129,17,129,37,0],[130,21,130,69,0],[132,21,132,67,0],[134,17,134,59,0],[136,17,137,69,0],[139,17,139,67,0],[140,21,140,28,0],[140,30,140,45,0],[140,46,140,48,0],[140,49,140,72,0],[141,25,141,96,0],[142,17,142,33,0],[143,17,143,62,0],[144,17,144,18,0],[145,21,145,82,0],[146,21,146,53,0],[147,21,147,22,0],[149,25,149,26,0],[150,29,150,49,0],[151,33,152,91,0],[154,33,155,91,0],[156,25,156,26,0],[157,25,157,30,0],[158,25,158,26,0],[159,25,159,26,0],[160,25,160,75,0],[161,25,161,26,0],[162,29,162,45,0],[163,29,163,36,0],[163,38,163,51,0],[163,52,163,54,0],[163,55,163,78,0],[164,29,164,30,0],[165,33,165,102,0],[166,33,168,115,0],[169,29,169,30,0],[170,29,170,72,0],[171,25,171,26,0],[172,21,172,22,0],[173,17,173,18,0],[174,13,174,14,0],[175,13,175,30,1],[176,9,176,10,1],[180,9,180,10,0],[181,13,181,114,0],[182,9,182,10,0],[186,9,186,10,1],[187,13,189,42,1],[190,9,190,10,1],[193,9,193,10,0],[195,13,195,35,0],[196,17,196,52,0],[198,17,198,97,0],[199,9,199,10,0],[202,9,202,10,0],[203,13,203,33,0],[205,13,206,59,0],[207,13,207,63,0],[208,13,208,14,0],[209,17,209,51,0],[210,17,210,24,0],[210,26,210,36,0],[210,37,210,39,0],[210,40,210,47,0],[211,17,211,18,0],[212,21,212,61,0],[213,25,213,64,0],[214,17,214,18,0],[215,17,215,27,0],[217,13,217,25,0],[218,9,218,10,0],[222,9,222,10,1],[223,13,223,33,1],[225,13,225,46,1],[226,13,226,33,1],[227,13,227,14,0],[228,17,228,40,0],[229,17,230,63,0],[231,13,231,14,0],[233,13,233,14,1],[234,17,235,75,1],[236,17,236,49,1],[237,17,237,49,1],[240,17,241,67,1],[242,17,242,18,0],[243,21,243,101,0],[244,17,244,18,0],[246,17,246,32,1],[247,17,247,65,1],[248,17,248,56,1],[250,17,251,63,1],[254,17,254,104,1],[255,17,255,18,0],[256,21,256,89,0],[257,17,257,18,0],[259,17,259,45,1],[260,17,260,43,1],[263,17,263,84,1],[264,17,264,18,0],[265,21,265,53,0],[266,21,266,44,0],[267,17,267,18,0],[269,21,269,45,1],[270,13,270,14,1],[272,13,272,63,1],[273,13,273,14,1],[274,17,274,51,1],[275,17,275,24,1],[275,26,275,36,0],[275,37,275,39,1],[275,40,275,47,1],[276,17,276,18,0],[277,21,277,61,0],[278,25,278,83,0],[279,17,279,18,0],[280,17,280,27,1],[282,13,282,25,0],[283,9,283,10,1],[289,9,289,25,1],[290,9,290,10,1],[291,9,291,10,1],[294,28,294,32,1],[294,33,294,37,1],[295,37,295,41,1],[295,42,295,46,1],[296,29,296,33,1],[296,34,296,38,1],[297,32,297,36,1],[297,37,297,41,0],[298,33,298,37,1],[298,38,298,42,1],[299,35,299,39,1],[299,40,299,44,1],[302,9,302,10,1],[303,13,303,107,1],[304,9,304,10,1],[310,9,310,26,1],[311,9,311,10,1],[312,13,312,28,1],[313,9,313,10,1],[317,37,317,41,0],[317,42,317,46,1],[321,34,321,38,1],[321,39,321,43,1],[325,25,325,29,1],[325,30,325,34,1],[330,34,330,38,1],[330,39,330,43,1],[334,30,334,34,0],[334,35,334,39,0],[338,30,338,34,1],[338,35,338,39,1],[342,44,342,48,1],[342,49,342,53,1],[346,46,346,50,1],[346,51,346,55,0],[350,31,350,35,0],[350,36,350,40,0],[354,41,354,45,1],[354,46,354,50,1],[358,35,358,39,1],[358,40,358,44,1],[362,32,362,36,0],[362,37,362,41,1],[371,17,371,18,1],[371,19,371,36,1],[371,37,371,38,1],[374,13,374,14,1],[375,17,375,69,1],[376,13,376,14,1],[381,30,381,34,1],[381,35,381,39,1],[383,30,383,34,1],[383,35,383,39,1],[385,35,385,39,0],[385,40,385,44,1],[387,35,387,39,1],[387,40,387,44,1],[392,17,392,18,1],[392,19,392,34,1],[392,35,392,36,1],[395,13,395,14,1],[396,17,396,67,1],[397,13,397,14,1],[400,34,400,38,0],[400,39,400,43,0],[402,32,402,36,1],[402,37,402,41,1],[404,31,404,35,1],[404,36,404,40,1],[406,36,406,40,1],[406,41,406,45,1],[408,32,408,36,1],[408,37,408,41,1],[410,32,410,36,1],[410,37,410,41,1],[412,32,412,36,1],[412,37,412,41,1],[414,32,414,36,1],[414,37,414,41,1],[416,32,416,36,1],[416,37,416,41,1],[418,32,418,36,1],[418,37,418,41,1],[420,32,420,36,1],[420,37,420,41,1],[422,32,422,36,1],[422,37,422,41,1],[424,32,424,36,1],[424,37,424,41,1],[426,33,426,37,1],[426,38,426,42,1],[428,33,428,37,1],[428,38,428,42,1],[430,33,430,37,1],[430,38,430,42,1],[432,33,432,37,1],[432,38,432,42,1],[434,33,434,37,1],[434,38,434,42,1],[436,33,436,37,1],[436,38,436,42,1],[438,33,438,37,1],[438,38,438,42,1],[440,33,440,37,1],[440,38,440,42,1],[442,33,442,37,1],[442,38,442,42,1],[444,33,444,37,1],[444,38,444,42,1],[446,33,446,37,1],[446,38,446,42,1],[448,32,448,36,1],[448,37,448,41,1],[450,40,450,44,0],[450,45,450,49,0],[452,31,452,35,1],[452,36,452,40,1],[454,32,454,36,1],[454,37,454,41,1],[456,27,456,31,0],[456,32,456,36,0],[458,30,458,34,1],[458,35,458,39,1],[460,34,460,38,0],[460,39,460,43,0],[462,34,462,38,1],[462,39,462,43,1],[464,34,464,38,1],[464,39,464,43,1],[466,27,466,31,1],[466,32,466,36,1],[469,42,469,46,1],[469,47,469,51,1],[471,45,471,49,1],[471,50,471,54,1],[478,13,478,14,1],[479,17,479,44,1],[480,13,480,14,1],[482,13,482,14,1],[483,17,483,70,1],[484,13,484,14,1],[492,13,492,14,1],[493,17,493,47,1],[494,13,494,14,1],[496,13,496,14,1],[497,17,497,132,1],[498,13,498,14,1],[504,13,504,14,1],[505,17,505,80,1],[506,17,506,122,1],[507,13,507,14,1],[513,9,513,10,1],[515,13,515,41,1],[516,17,516,47,1],[519,13,519,70,1],[520,17,520,71,1],[521,9,521,10,1],[524,9,524,10,1],[525,13,525,50,1],[526,9,526,10,1],[529,9,529,10,1],[530,13,530,148,1],[531,13,531,14,1],[532,17,532,26,1],[535,13,535,84,0],[536,13,536,103,0],[537,13,537,81,0],[539,13,539,31,0],[540,13,540,14,0],[541,17,541,26,0],[544,13,544,159,0],[545,13,545,44,0],[546,9,546,10,1],[605,9,605,33,1],[606,9,606,10,1],[607,13,607,35,1],[608,13,608,57,1],[609,13,609,45,1],[610,13,610,54,1],[611,13,611,53,1],[612,13,612,44,1],[613,13,613,162,1],[614,13,614,46,1],[616,13,625,15,1],[627,13,627,45,1],[628,13,628,59,1],[629,13,629,62,1],[630,13,630,65,1],[631,13,631,61,1],[633,13,635,60,1],[636,13,636,75,1],[637,13,637,71,1],[638,13,638,79,1],[639,13,639,83,1],[640,13,640,79,1],[641,13,641,71,1],[642,13,642,82,1],[643,13,643,64,1],[644,9,644,10,1],[647,9,647,10,1],[650,13,650,62,1],[652,13,652,51,1],[653,13,653,14,1],[654,17,654,60,1],[655,17,655,55,1],[657,17,657,54,1],[658,17,658,18,1],[659,21,659,60,1],[660,21,660,56,1],[661,21,661,60,1],[663,21,663,77,1],[664,21,664,63,1],[665,25,665,32,1],[665,34,665,43,1],[665,44,665,46,1],[665,47,665,72,1],[666,29,666,103,1],[668,21,668,53,1],[669,21,669,22,0],[670,25,670,32,0],[670,34,670,45,0],[670,46,670,48,0],[670,49,670,66,0],[671,25,671,26,0],[672,29,672,155,0],[673,29,673,30,0],[674,33,674,88,0],[675,33,675,64,0],[677,33,677,69,0],[678,33,678,34,0],[679,37,679,85,0],[681,42,681,51,0],[681,53,681,63,0],[681,65,681,68,0],[682,37,682,38,0],[683,41,683,84,0],[684,37,684,38,0],[685,33,685,34,0],[686,29,686,30,0],[687,34,687,163,0],[688,29,688,30,0],[689,33,689,91,0],[690,33,690,81,0],[692,33,692,69,0],[693,33,693,34,0],[694,37,694,91,0],[696,42,696,51,0],[696,53,696,63,0],[696,65,696,68,0],[697,37,697,38,0],[698,41,698,101,0],[699,37,699,38,0],[700,33,700,34,0],[701,29,701,30,0],[703,25,703,26,0],[704,21,704,22,0],[706,17,706,18,1],[707,13,707,14,1],[709,13,709,29,1],[710,9,710,10,1],[713,9,713,10,0],[714,13,714,62,0],[716,13,716,51,0],[717,13,717,14,0],[718,17,718,60,0],[719,17,719,65,0],[721,17,721,54,0],[722,17,722,18,0],[723,21,723,60,0],[724,21,724,56,0],[725,21,725,60,0],[727,21,727,117,0],[729,21,729,66,0],[730,25,730,85,0],[732,21,732,81,0],[733,21,735,82,0],[737,21,737,77,0],[738,21,740,80,0],[742,21,742,64,0],[743,21,745,119,0],[747,21,747,71,0],[748,21,748,60,0],[749,25,749,32,0],[749,34,749,43,0],[749,44,749,46,0],[749,47,749,69,0],[750,29,750,103,0],[751,17,751,18,0],[753,17,753,59,0],[754,17,754,18,0],[755,21,755,37,0],[756,21,756,28,0],[756,30,756,43,0],[756,44,756,46,0],[756,47,756,74,0],[757,21,757,22,0],[758,25,758,94,0],[759,25,761,107,0],[762,21,762,22,0],[763,21,763,63,0],[764,17,764,18,0],[765,13,765,14,0],[767,13,767,29,0],[768,9,768,10,0],[771,9,771,10,0],[772,13,772,71,0],[773,9,773,10,0],[779,9,779,33,1],[780,9,780,10,1],[781,13,781,49,1],[782,13,782,50,1],[783,9,783,10,1]]);
    </script>
  </body>
</html>