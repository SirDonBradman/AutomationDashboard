<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\XmlForm Framework\FormComponents\DynamicGrid.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aurigo.AMP3.Common;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Json;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Web.UI.WebControls;
using System.Xml;
using System.Xml.Serialization;
using Telerik.Web.UI;
using X = Aurigo.Brix.Platform.BusinessLayer.XMLForm;

namespace Aurigo.Brix.Platform.BusinessLayer.XMLForm
{
    public class DynamicGrid : DataBaseContainer
    {
        [XmlAttribute(&quot;Caption&quot;)]
        [FormDesignerAttribute(Priority = 10000)]
        public string Caption;

        [XmlAttribute(&quot;Totals&quot;), DefaultValue(&quot;&quot;)]
        public string Totals;
        // this string contains a comma separated list of columns that should have totals shown and calclulated

        [XmlAttribute(&quot;ReadOnly&quot;), DefaultValue(false)]
        public bool ReadOnly = false;

        [XmlIgnore]
        public bool bGridBound;

        [XmlAttribute(&quot;PickerName&quot;), DefaultValue(&quot;&quot;)]
        public string PickerName;

        [XmlAttribute(&quot;PickerButtonText&quot;), DefaultValue(&quot;&quot;)]
        public string PickerButtonText;

        [XmlAttribute(&quot;PickerButtonWidth&quot;), DefaultValue(&quot;&quot;)]
        public string PickerButtonWidth;

        [XmlAttribute(&quot;EnableMultiSelect&quot;), DefaultValue(false)]
        public bool EnableMultiSelect;

        [XmlAttribute(&quot;ShowAddButton&quot;), DefaultValue(true)]
        public bool ShowAddButton = true;

        [XmlAttribute(&quot;ShowEditButton&quot;), DefaultValue(true)]
        public bool ShowEditButton = true;

        [XmlAttribute(&quot;ShowDeleteButton&quot;), DefaultValue(true)]
        public bool ShowDeleteButton = true;
        [XmlAttribute(&quot;EditButtonText&quot;), DefaultValue(&quot;&quot;)]
        public string EditButtonText;

        [XmlAttribute(&quot;ShowViewButton&quot;), DefaultValue(false)]
        public bool ShowViewButton = false;

        [XmlAttribute(&quot;AllowInlineEdit&quot;), DefaultValue(false)]
        public bool AllowInlineEdit = false;

        [XmlAttribute(&quot;EnableViewState&quot;), DefaultValue(false)]
        public bool EnableViewState = false;

        [XmlAttribute(&quot;PickerIdColumn&quot;), DefaultValue(&quot;&quot;)]
        public string PickerIdColumn;

        [XmlAttribute(&quot;AllowFiltering&quot;), DefaultValue(false)]
        public bool AllowFiltering = false;

        [XmlAttribute(&quot;AllowSorting&quot;), DefaultValue(true)]
        public bool AllowSorting = true;

        /// &lt;summary&gt;
        /// When ever a row is inserted or updated in the dynamic grid, this function will be called.
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;AfterRowUpdateScript&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string AfterRowUpdateScript;

        [XmlAttribute(&quot;AllowMultiSelect&quot;), DefaultValue(false)]
        public bool AllowMultiSelect;


        /// &lt;summary&gt;
        /// When ever a row is inserted or updated in the dynamic grid, this function will be called.
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;BeforeRowUpdateScript&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string BeforeRowUpdateScript;

        /// &lt;summary&gt;
        /// When ever a row is inserted or updated in the dynamic grid, this function will be called.
        /// Attribute to specify the minimum number of rows required.
        /// &lt;/summary&gt;
        /// &lt;summary&gt;
        /// When ever a row is deleted in the dynamic grid, this function will be called.
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;AfterRowDeleteScript&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string AfterRowDeleteScript;

        /// &lt;summary&gt;
        /// When ever a row is about to be deleted in the dynamic grid, this function will be called.
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;BeforeRowDeleteScript&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string BeforeRowDeleteScript;

        /// &lt;summary&gt;
        /// Script that will be called after picker select
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;AfterSelectScript&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string AfterSelectScript;

        /// &lt;summary&gt;
        /// Script that will be called before the picker is loaded - it is used to pass information from javascript. 
        /// The result should be in form of json which the picker understands.
        /// The filter should be in the form of query in jsonObject.Filter
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;BeforePickerLoadScript&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string BeforePickerLoadScript;

        /// &lt;summary&gt;
        /// Script that will be called after the cell value change in the grid using in-line editing
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;OnEditCellValueChanged&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string OnEditCellValueChanged;

        /// &lt;summary&gt;
        /// Script that will be called after the row is getting moved.
        /// &lt;/summary&gt;
        [XmlIgnore]
        public string OnRowDropping;

        /// &lt;summary&gt;
        /// Script that will be called before the edit template is loaded on Add
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;BeforeRowAddScript&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string BeforeRowAddScript;

        /// &lt;summary&gt;
        /// Script that will be called before the edit template is loaded on Edit or View
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;BeforeRowEditScript&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string BeforeRowEditScript;

        /// &lt;summary&gt;
        /// This template is a kendo template used in mobile.
        /// &lt;/summary&gt;
        [XmlElement(&quot;Template&quot;)]
        public ListPageTemplate Template { get; set; }

        /// &lt;summary&gt;
        /// To group the columns in the grid
        /// &lt;/summary&gt;
        [XmlElement(&quot;ColumnGroups&quot;)]
        public xColumnGroups ColumnGroups { get; set; }

        [XmlElement(&quot;DataSource&quot;)]
        public DataSourceObject DataSource { get; set; }

        [XmlAttribute(&quot;MinimumNumberOfRows&quot;), DefaultValue(0)]
        public int MinimumNumberOfRows;

        [XmlAttribute(&quot;MinimumNumberOfRowsCondition&quot;), DefaultValue(&quot;&quot;)]
        public string MinimumNumberOfRowsCondition;

        [XmlAttribute(&quot;RowHeight&quot;), DefaultValue(&quot;28px&quot;)]
        public string RowHeight;

        /// &lt;summary&gt;
        /// This attribute can be used to validate row count on custom menus/buttons
        /// &lt;/summary&gt;
        [XmlAttribute(&quot;ValidateOn&quot;), DefaultValue(&quot;&quot;)]
        [FormDesignerAttribute(AttributeType = AttributeType.Advanced)]
        public string ValidateOn { get; set; }

        /// &lt;summary&gt;
        /// List of control types that are to be hidden in the Dynamic Grid List.
        /// &lt;/summary&gt;
        [XmlIgnore]
        public X.ControlType[] ControlTypesNotToBeShownOnList { get; private set; }

        public DynamicGrid()
        {
            bGridBound = false;
            ControlTypesNotToBeShownOnList = new ControlType[] { X.ControlType.PickerTrigger };
        }

        internal override void CreateTable(StringBuilder sb, bool dropIfExists)
        {
            sb.Append(SQLHelper_Get_Comment(&quot;START DynamicGrid&quot;));

            if (dropIfExists)
                sb.AppendFormat(SQLHelper_DDL_Table_DropTableIfExist(ActualTableNameInDatabase, TemporalTableNameInDatabase));

            sb.Append(SQLHelper_DDL_Table_START_CreateTableIfNotExist(ActualTableNameInDatabase));

            StringBuilder sbr_DDL_Query_ColumnAlter = new StringBuilder();

            bool hasAtleastOneColumnToAlter = false;

            ProcessControlsForDBContainer(this,
               ctrl =&gt;
               {
                   sb.Append(&quot;\r\n\t [&quot; + ctrl.Name + &quot;] &quot; + ctrl.DBType + &quot;,&quot;);

                   if (!ctrl.PrimaryKey &amp;&amp; !string.IsNullOrEmpty(ctrl.DBType))
                   {
                       hasAtleastOneColumnToAlter = true;
                       sbr_DDL_Query_ColumnAlter.Append(&quot;\t&quot;);
                       sbr_DDL_Query_ColumnAlter.AppendLine(SQLHelper_DDL_Table_AddNewColumn(ActualTableNameInDatabase, ctrl.Name, ctrl.DBType));
                   }
               }
               , true);

            sb.Append(SQLHelper_DDL_Table_END_CreateTableIfNotExist(ActualTableNameInDatabase, PrimaryKeyName));

            sb.Append(&quot;\r\n\t&quot;);
            sb.AppendLine(&quot; END &quot;);

            if (hasAtleastOneColumnToAlter)
            {
                sb.AppendLine(&quot; ELSE &quot;);
                sb.AppendLine(&quot; BEGIN &quot;);
                //this will create new columns if it does not already exists
                sb.AppendLine(sbr_DDL_Query_ColumnAlter.ToString());
                sb.AppendLine(&quot; END &quot;);
            }

            sb.AppendLine(&quot;;&quot;);

            base.CreateTable(sb, dropIfExists);

            Containers.OfType&lt;DynamicGrid&gt;().ForEach(DBC =&gt; DBC.CreateTable(sb, dropIfExists)); //Asheesh: not sure why this line is here.

            // Logging cdc vs temporal tables
            if (form.EnableAuditLog)
            {
                if (CheckForAuditLogColumns(this))
                {
                    if (AMP3ApplicationSettings.Instance.AuditLogType.Equals(AuditLogType.CDC.ToString()))
                        EnableCDC(sb, false, ActualTableNameInDatabase);
                    else if (AMP3ApplicationSettings.Instance.AuditLogType.Equals(AuditLogType.TemporalTable.ToString()))
                        EnableTemporalTable(sb, ActualTableNameInDatabase, TemporalTableNameInDatabase, PrimaryKeyName);
                }
            }
            else
            {
                if (AMP3ApplicationSettings.Instance.AuditLogType.Equals(AuditLogType.CDC.ToString()))
                    DisableCDC(sb, ActualTableNameInDatabase);
                else if (AMP3ApplicationSettings.Instance.AuditLogType.Equals(AuditLogType.TemporalTable.ToString()))
                    DisableTemporalTable(sb, ActualTableNameInDatabase);
            }

            sb.Append(SQLHelper_Get_Comment(&quot;END DynamicGrid&quot;));
        }

        public override void ModifyTable(StringBuilder sb)
        {
            CreateTable(sb, false);
        }


        public override void GetInstanceData(bool isUTC_to_MWDateTime_ConversionRequired)
        {
            if (ParentObject is DynamicGrid)
            {
                // get the parent grid here
                // Get the data table of that grid
                // find out all the primary key values from that table and then create the query to retrieve data for child table
                var parentGrid = ParentObject as DynamicGrid;
                if (parentGrid.Table.Rows.Count &gt; 0)
                {
                    List&lt;xControl&gt; fKeys = GetForeignKeyControls();
                    // Assuming there will be only one foreign key as of now
                    string parentInstanceIds = &quot;&quot;;
                    foreach (DataRow dr in parentGrid.Table.Rows)
                    {
                        parentInstanceIds += dr[parentGrid.PrimaryKeyName] + &quot;,&quot;;
                    }
                    parentInstanceIds = parentInstanceIds.TrimEnd(new[] { &#39;,&#39; });
                    string foreignKeyFilter = &quot; where &quot;;
                    foreach (xControl key in fKeys)
                    {
                        if (key.ForeignKey)
                            foreignKeyFilter += key.Name + &quot; in (&quot; + parentInstanceIds + &quot;) AND &quot;;
                        else
                            foreignKeyFilter += key.Name + &quot; = &#39;&quot; + key.EvaluateControlValue() + &quot;&#39; AND &quot;;
                    }

                    if (foreignKeyFilter.EndsWith(&quot; AND &quot;))
                        foreignKeyFilter = foreignKeyFilter.Remove(foreignKeyFilter.Length - 5);

                    Table =
                        ComponentHelper.Instance.ExecuteDataSet(&quot;select * from &quot; + TableName + foreignKeyFilter).Tables[
                            0];
                }
            }
            else
                base.GetInstanceData(isUTC_to_MWDateTime_ConversionRequired);

            foreach (DynamicGrid innerGrid in Containers.OfType&lt;DynamicGrid&gt;())
                innerGrid.GetInstanceData(isUTC_to_MWDateTime_ConversionRequired);
        }


        public override void Save(RenderFormat format)
        {
            // should work hierarchically - check it later
            RemoveDeletedEntries();
            string primaryKeyValue = &quot;&quot;;
            int nRow = 0;
            object valobj = &quot;&quot;;
            //Making save work in both HTML and XML format
            //TODO: Need to see a generic way of getting count.
            int rowCount = 0;
            {
                //This in in HTML format
                if ((this as DynamicGrid).ControlReference.Count &gt; 0 &amp;&amp;
                    ((this as DynamicGrid).ControlReference[0] is RadGrid))
                    rowCount = MWGrid.GetRows(((this as DynamicGrid).ControlReference[0] as RadGrid)).Count;
                //This is in XML format
                else if (format == RenderFormat.RenderHtml &amp;&amp; (this as DynamicGrid).ControlReference.Count &gt; 0 &amp;&amp;
                         ((this as DynamicGrid).ControlReference[0] is XmlElement))
                    rowCount = ((this as DynamicGrid).ControlReference[0] as XmlElement).ChildNodes.Count;
                else if (format == RenderFormat.RenderJSON)
                {
                    JsonArray rows = (this.form.Renderer as JSONRenderer).GetControlXMLNode(this as DynamicGrid);
                    rowCount = rows == null ? 0 : rows.Count;
                }
            }
            while (rowCount &gt; nRow)
            {
                Dictionary&lt;string, string&gt; colValues = new Dictionary&lt;string, string&gt;();
                List&lt;string&gt; cols = GetColumnNamesforDB(this, string.IsNullOrEmpty(IdentityColumnName));
                // this list doesnot include primary key col if that is identity
                int pkValue = 0;
                bool isEditRow = false;

                // now get the values
                var vals = new List&lt;string&gt;();
                int colIndex = 0;
                int dbColIndex = 0;
                int guidColIndex = 0;
                foreach (xControl ctrl in Controls)
                {
                    if (ctrl.Name == $&quot;{(this as DynamicGrid).Name}RowGuid&quot;)
                    {
                        guidColIndex = colIndex;
                    }
                    if (!string.IsNullOrEmpty(ctrl.DBType) &amp;&amp; ctrl.Type != ControlType.AttachmentControl)
                    {
                        valobj = form.Renderer.CellGetters[(int)ContainerTypes.DynamicGrid](this, nRow, colIndex);
                        if (valobj == null)
                        {
                            // remove the column from the cols list
                            //Primary key is not there in the list, hence -1
                            cols.RemoveAt(dbColIndex - 1);
                            continue;
                        }
                        else if (ctrl.Type == ControlType.Numeric &amp;&amp; string.Equals(valobj, string.Empty))
                            valobj = &quot;_DBNULL_&quot;;

                        if (ctrl.PrimaryKey ||
                            (ctrl.Name.Equals(this.PrimaryKeyName, StringComparison.CurrentCultureIgnoreCase)))
                        {
                            #region If Primary key
                            if (!ctrl.IsIdentity)
                            {
                                // check in database if the primary key exists or not
                                object countObj =
                                    ComponentHelper.Instance.ExecuteScalar(&quot;select count (*) from &quot; + TableName +
                                                                           &quot; where [&quot; + PrimaryKeyName + &quot;] = {0}&quot;, valobj);
                                int count = 0;
                                Int32.TryParse(countObj.ToString(), out count);
                                if (count == 1)
                                {
                                    isEditRow = true;
                                    vals.Add(&quot;&#39;&quot; + valobj.ToString().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;);
                                    primaryKeyValue = valobj.ToString();
                                }
                                else if (ctrl.ForeignKey &amp;&amp; string.IsNullOrEmpty(valobj.ToString()))
                                {
                                    vals.Add(&quot;&#39;&quot; + ctrl.EvaluateControlValue().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;);
                                }
                            }
                            else if (Int32.TryParse(valobj.ToString2(), out pkValue) &amp;&amp; pkValue != 0)
                            {
                                //Primary key of this table is an identity column
                                primaryKeyValue = pkValue.ToString();
                                isEditRow = true;
                            }
                            #endregion If Primary key
                        }
                        else if (ctrl.ForeignKey)
                            vals.Add(&quot;&#39;&quot; + ctrl.EvaluateControlValue().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;);
                        else if (ctrl.ReEvaluate)
                        {
                            if (ctrl.IsTimezoneApplicable)
                                vals.Add(&quot;&#39;&quot; + CheckForDateAndSetFormat(ctrl, ctrl.EvaluateControlValue(), isConvertToUTC: true).ToString() + &quot;&#39;&quot;);
                            else
                                vals.Add(&quot;&#39;&quot; + ctrl.EvaluateControlValue().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;);
                        }
                        else
                        {
                            if (ctrl.Type != ControlType.DDLDisplayControl)
                            {
                                valobj = CheckForDateAndSetFormat(ctrl, valobj, isConvertToUTC: true);

                                //Asheesh_Check: check if this has to use open xml format or ToString_MWCulture()
                                //if (ctrl.IsTimezoneApplicable)
                                //{
                                //    DateTime dtCtrl;
                                //    if (valobj.TryParseObjectAsDateTime(out dtCtrl, DateFormatCulture.MWDateFormatCulture))
                                //        valobj = dtCtrl.ToUtc().ToString_MWCulture();
                                //}
                                vals.Add(&quot;&#39;&quot; + valobj.ToString() + &quot;&#39;&quot;);
                            }
                        }
                        dbColIndex++;
                    }
                    colIndex++;
                }

                // fix up the value strings
                for (int i = 0; i &lt; vals.Count; i++)
                    if (vals[i] == &quot;&#39;_DBNULL_&#39;&quot;)
                        vals[i] = &quot;NULL&quot;;

                string query;

                var predicates = new List&lt;Predicate&lt;string&gt;&gt;();
                predicates.Add(str =&gt; str.Contains(&quot;_Disp&quot;) == false);

                var results = new List&lt;string&gt;();

                foreach (var p in predicates)
                    results.AddRange(from i in cols where p.Invoke(i) select i);
                cols.Clear();
                cols = results.ToList();

                if (isEditRow)
                {
                    query = BuildUpdateQuery(cols, vals, PrimaryKeyName, primaryKeyValue);
                    try
                    {
                        ComponentHelper.Instance.ExecuteNonQuery(query);
                    }
                    catch (Exception ex)
                    {
                        Utilities.LogError(ex,
                            new AppErrInfo() { appWhere = &quot;DynamicGridSave - Update&quot;, appWhat = query },
                            MethodBase.GetCurrentMethod());
                    }
                }
                else
                {
                    query = BuildInsertQuery(cols, vals);
                    try
                    {
                        if (!string.IsNullOrEmpty(IdentityColumnName))
                            query += &quot;; select scope_identity();&quot;;

                        object obj = ComponentHelper.Instance.ExecuteScalar(query);
                        primaryKeyValue = null == obj ? null : obj.ToString();
                    }
                    catch (Exception ex)
                    {
                        Utilities.LogError(ex,
                            new AppErrInfo() { appWhere = &quot;DynamicGridSave - Insert&quot;, appWhat = query },
                            MethodBase.GetCurrentMethod());
                    }
                }


                foreach (DynamicGrid innerDGrid in Containers.OfType&lt;DynamicGrid&gt;())
                {
                    // The value of instanceID provides value for foreign key of child dynamic grid
                    innerDGrid.instanceID = primaryKeyValue;
                    innerDGrid.Save(format);
                }
                //Write logic to save attachments within the grid.
                var guid = form.Renderer.CellGetters[(int)ContainerTypes.DynamicGrid](this, nRow, guidColIndex);
                SaveAttachmentControls(primaryKeyValue, isEditRow ? nRow : guid);

                nRow++;
            }
        }

        private void SaveAttachmentControls(string primaryKeyValue, object rowIndex)
        {
            foreach (AttachmentControl ctrl in Controls.OfType&lt;AttachmentControl&gt;())
            {
                ctrl.SetServerValue(new { RowIndex = rowIndex, InstanceID = primaryKeyValue });
                ctrl.GetServerValue();
            }
        }

        public override void GetLinkedInstanceDetails(RenderFormat format, LinkedInstanceDetails linkedInstanceDetails)
        {
            foreach (LinkedInstance li in linkedInstanceDetails.LinkedDestinationInstances)
            {
                if (li.ReferencedBy is xColumn &amp;&amp; li.ReferencedBy.ParentObject is DynamicGrid)
                {
                    var dGrid = li.ReferencedBy.ParentObject as DynamicGrid;

                    int colIndex = 0;
                    foreach (xControl ctrl in dGrid.Controls)
                    {
                        if (ctrl.Name == li.ReferencedBy.Name)
                            break;
                        colIndex++;
                    }

                    int rowCount = MWGrid.GetRows(dGrid.ControlReference[0] as RadGrid).Count;
                    for (int index = 0; index &lt; rowCount; index++)
                    {
                        var valobj = form.Renderer.CellGetters[(int)ContainerTypes.DynamicGrid](dGrid, index, colIndex);
                        li.DestinationInstanceIds.Add(valobj.ToString());
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// RemoveDeletedEntries:
        ///     Deletes rows this ControlContainers database table that the user deleted while editing the form.
        /// &lt;/summary&gt;
        private void RemoveDeletedEntries()
        {
            string shouldExist = string.Empty;

            // cant save without a primary key; Get the primay col index
            int pkIndex = 0;
            foreach (xControl xc in Controls)
            {
                if (xc.PrimaryKey ||
                    (xc.Name != null &amp;&amp; xc.Name.Equals(this.PrimaryKeyName, StringComparison.CurrentCultureIgnoreCase)))
                    break;
                else
                    pkIndex++;
            }
            if (pkIndex &gt;= Controls.Count)
                return;

            int nRow = 0;
            object valobj = &quot;&quot;;
            while (valobj != null)
            {
                int pkValue;
                valobj = form.Renderer.CellGetters[(int)ContainerTypes.DynamicGrid](this, nRow, pkIndex);
                if (valobj == null) break;
                if (int.TryParse(valobj.ToString2(), out pkValue))
                    shouldExist += pkValue + &quot;,&quot;;

                nRow++;
            }

            string deleteQuery = string.Empty;
            if (!string.IsNullOrEmpty(shouldExist))
            {
                shouldExist = shouldExist.Substring(0, shouldExist.Length - 1);
                deleteQuery = &quot;delete from &quot; + ActualTableNameInDatabase + BuildForeignKeyFilterForDelete() + &quot; and &quot; + PrimaryKeyName +
                              &quot; NOT IN (&quot; + shouldExist + &quot;)&quot;;
            }
            else
            {
                deleteQuery = &quot;delete from &quot; + ActualTableNameInDatabase + BuildForeignKeyFilterForDelete();
            }

            try
            {
                ComponentHelper.Instance.ExecuteNonQuery(deleteQuery);
            }
            catch (Exception)
            {
            }
        }

        public override void Render(object parent, RenderFormat format)
        {
            if (form.Renderer.ContainerRenderers[(int)ContainerTypes.DynamicGrid] != null)
                form.Renderer.ContainerRenderers[(int)ContainerTypes.DynamicGrid](this, parent);
        }

        internal DataTable CreateDerivedColumns(DataTable table, Object ndParentData = null)
        {
            var dt = new DataTable();
            dt = table.Copy();

            // Find out all the defived columns in the List&lt;Columns&gt;
            // Create all these new columns in the table 
            // set theres Positions to match the dynamic grid columns
            // Now, foreach row of the table, calculate the value of these columns
            // for each value starting from $ - first look into the row and then in the form.

            int colIndex = 0;
            var derivedCols = new List&lt;xColumn&gt;();

            foreach (xControl colctrl in Controls)
            {
                xColumn col = (colctrl as xColumn);
                if (col != null)
                {
                    if ((string.IsNullOrEmpty(col.DBType) || col.Type == ControlType.DDLDisplayControl)
                        &amp;&amp; !col.Type.IsEqualToAny(ControlTypesNotToBeShownOnList))
                    {
                        // insert the new column here
                        var dc = new DataColumn(col.Name, typeof(string));
                        if (!dt.Columns.Contains(col.Name))
                        {
                            dc.Caption = col.Caption;
                            dt.Columns.Add(dc);
                            dc.SetOrdinal(colIndex);
                        }
                        derivedCols.Add(col);
                    }
                }
                colIndex++;
            }

            Dictionary&lt;string, List&lt;FormListItem&gt;&gt; ddlDataSource = new Dictionary&lt;string, List&lt;FormListItem&gt;&gt;();
            Dictionary&lt;string, DataTable&gt; ddTreeDataSource = new Dictionary&lt;string, DataTable&gt;();

            foreach (DataRow dr in dt.Rows)
            {
                foreach (xColumn col in derivedCols)
                {
                    xControl xc = col;
                    if (xc.Type == ControlType.DDLDisplayControl)
                    {
                        xControl xcDisp = form.GetControl(xc.Name.Substring(0, xc.Name.Length - (&quot;_Disp&quot;).Length));
                        xControl xcTemp = xcDisp;
                        if (!string.IsNullOrEmpty(xcDisp.DataSource) &amp;&amp;
                            (xcDisp.DataSource.Contains(&quot;=$&quot;) || xcDisp.DataSource.Contains(&quot;=&#39;$&quot;)))
                        {
                            string bindProperties = xControl.ReplaceVariablesWithValues(ref xcDisp.DataSource, null, xcDisp.form, dr, null);
                            xcTemp = new xControl
                            {
                                Name = xcDisp.Name,
                                DataSource = bindProperties,
                                ParentObject = xcDisp.ParentObject,
                                Type = xcDisp.Type
                            };
                        }

                        string selectedText = string.Empty;

                        if (xcTemp.Type == ControlType.DropDownList)
                        {
                            if (!ddlDataSource.ContainsKey(xcTemp.Name))
                                ddlDataSource.Add(xcTemp.Name, xcTemp.GetFormList());

                            selectedText = GetSelectedTextForDropDownList(xcTemp.Name,
                                dr[col.Name.Substring(0, col.Name.Length - (&quot;_Disp&quot;).Length)].ToString2(), ddlDataSource);
                        }
                        else if (xcTemp.Type == ControlType.DropDownTreeDataControl)
                        {
                            if (!ddTreeDataSource.ContainsKey(xcTemp.Name))
                                ddTreeDataSource.Add(xcTemp.Name, xcTemp.GetTreeItemDataList());

                            selectedText = GetSelectedListForDropDownTree(xcTemp.Name,
                                dr[col.Name.Substring(0, col.Name.Length - (&quot;_Disp&quot;).Length)].ToString2(), ddTreeDataSource);
                        }

                        dr[col.Name] = selectedText;
                    }
                }
            }


            return dt;
        }

        private string GetSelectedTextForDropDownList(string controlName, string selectedValue, Dictionary&lt;string, List&lt;FormListItem&gt;&gt; ddlDataSource)
        {
            string selectedText = string.Empty;

            List&lt;FormListItem&gt; lbis = ddlDataSource[controlName];
            if (lbis.FirstOrDefault(item =&gt; item.value.ToString2() == selectedValue) != null)
            {
                FormListItem selectedItem = lbis.FirstOrDefault(item =&gt; item.value.ToString2() == selectedValue);
                selectedText = selectedItem.display;
            }
            return selectedText;
        }

        private string GetSelectedListForDropDownTree(string controlName, string selectedValues, Dictionary&lt;string, DataTable&gt; ddTreeDataSource)
        {
            string selectedText = string.Empty;
            DataTable dt = ddTreeDataSource[controlName];
            List&lt;string&gt; selectedValuesList = selectedValues.Split(&quot;,&quot;.ToCharArray(), StringSplitOptions.RemoveEmptyEntries).ToList();

            foreach (DataRow dr in dt.Rows)
            {
                if (selectedValuesList.Contains(dr[HtmlRenderer.CONST_DDTree_ID_Field]))
                {
                    selectedText = string.Format(&quot;{0}; {1}&quot;, selectedText, dr[HtmlRenderer.CONST_DDTree_DisplayText_Field]);
                }
            }

            return selectedText.Trim().TrimStart(&quot;;&quot;.ToCharArray());
        }

        public override void ApplyContainerChanges(object parent, RenderFormat format)
        {
            if (form.Renderer.ApplyChangesToContainer[(int)ContainerTypes.DynamicGrid] != null)
                form.Renderer.ApplyChangesToContainer[(int)ContainerTypes.DynamicGrid](this);
        }

        public DataTable BuildDataTable()
        {
            //create DataTable Structure
            DataTable tbl = CreateTable();
            foreach (DataSourceRow lstitem in this.DataSource.DataSourceRow)
            {
                DataRow row = tbl.NewRow();
                for (int i = 0; i &lt; this.Controls.Count; i++)
                {
                    row[this.Controls[i].Name] = lstitem.DataSourceColumn[i].Value;
                }
                tbl.Rows.Add(row);
            }
            return tbl;
        }

        public void AddDataSource(DataTable dt, bool append)
        {
            if (append)
            {
                foreach (DataRow dtRow in dt.Rows)
                {
                    DataSourceRow row = new DataSourceRow();
                    foreach (var item in this.Controls)
                    {
                        xDataSourceColumn col = new xDataSourceColumn();
                        col.Name = item.Name;
                        col.Value = Convert.ToString(dtRow[item.Name]);
                        row.DataSourceColumn.Add(col);
                    }

                    this.DataSource.DataSourceRow.Add(row);
                }
            }
            else
            {
                this.DataSource.DataSourceRow.Clear();
                foreach (DataRow dtRow in dt.Rows)
                {
                    DataSourceRow row = new DataSourceRow();
                    foreach (DataColumn item in dt.Columns)
                    {
                        xDataSourceColumn col = new xDataSourceColumn();
                        col.Name = item.ColumnName;
                        col.Value = Convert.ToString(dtRow[item.ColumnName]);
                        row.DataSourceColumn.Add(col);
                    }

                    this.DataSource.DataSourceRow.Add(row);
                }
            }
        }

        private DataTable CreateTable()
        {
            DataTable tbl = new DataTable(this.TableName);
            foreach (var prop in this.Controls)
            {
                tbl.Columns.Add(prop.Name);
            }
            return tbl;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,38,1],[51,9,51,42,1],[54,9,54,43,1],[57,9,57,45,1],[62,9,62,44,1],[65,9,65,45,1],[68,9,68,45,1],[74,9,74,44,1],[77,9,77,41,1],[162,44,162,48,0],[162,49,162,53,0],[168,45,168,49,1],[168,50,168,54,0],[171,46,171,50,1],[171,51,171,55,0],[187,36,187,40,0],[187,41,187,45,0],[193,65,193,69,1],[193,70,193,82,1],[195,9,195,29,1],[196,9,196,10,1],[197,13,197,32,1],[198,13,198,96,1],[199,9,199,10,1],[202,9,202,10,1],[203,13,203,67,1],[205,13,205,30,1],[206,17,206,127,1],[208,13,208,99,1],[210,13,210,75,1],[212,13,212,53,1],[214,13,216,16,1],[216,16,216,17,1],[216,17,217,20,1],[217,20,217,81,1],[217,81,219,20,1],[219,20,219,79,1],[219,79,220,20,1],[220,20,220,21,1],[220,21,221,24,1],[221,24,221,58,1],[221,58,222,24,1],[222,24,222,63,1],[222,63,223,24,1],[223,24,223,146,1],[223,146,224,20,1],[224,20,224,21,1],[224,21,225,16,1],[225,16,225,17,1],[225,17,226,24,1],[214,13,226,24,1],[228,13,228,113,1],[230,13,230,33,1],[231,13,231,36,1],[233,13,233,44,1],[234,13,234,14,1],[235,17,235,41,1],[236,17,236,42,1],[238,17,238,69,1],[239,17,239,40,1],[240,13,240,14,1],[242,13,242,32,1],[244,13,244,48,1],[246,13,246,61,1],[246,61,246,94,0],[246,94,246,96,1],[246,13,246,96,1],[249,13,249,37,1],[250,13,250,14,0],[251,17,251,51,0],[252,17,252,18,0],[253,21,253,107,0],[254,25,254,73,0],[255,26,255,122,0],[256,25,256,121,0],[257,17,257,18,0],[258,13,258,14,0],[260,13,260,14,1],[261,17,261,103,1],[262,21,262,63,1],[263,22,263,118,0],[264,21,264,73,0],[265,13,265,14,1],[267,13,267,65,1],[268,9,268,10,1],[271,9,271,10,0],[272,13,272,36,0],[273,9,273,10,0],[277,9,277,10,1],[278,13,278,45,1],[279,13,279,14,0],[283,17,283,62,0],[284,17,284,53,0],[285,17,285,18,0],[286,21,286,68,0],[288,21,288,51,0],[289,21,289,28,0],[289,30,289,40,0],[289,41,289,43,0],[289,44,289,65,0],[290,21,290,22,0],[291,25,291,82,0],[292,21,292,22,0],[293,21,293,82,0],[294,21,294,57,0],[295,21,295,28,0],[295,30,295,42,0],[295,43,295,45,0],[295,46,295,51,0],[296,21,296,22,0],[297,25,297,44,0],[298,29,298,99,0],[300,29,300,107,0],[301,21,301,22,0],[303,21,303,60,0],[304,25,304,97,0],[306,21,308,32,0],[309,17,309,18,0],[310,13,310,14,0],[312,17,312,78,1],[314,13,314,20,1],[314,22,314,43,0],[314,44,314,46,1],[314,47,314,79,1],[315,17,315,83,0],[316,9,316,10,1],[320,9,320,10,1],[322,13,322,36,1],[323,13,323,41,1],[324,13,324,26,1],[325,13,325,32,1],[328,13,328,30,1],[329,13,329,14,1],[331,17,332,76,1],[333,21,333,109,1],[335,22,336,84,1],[337,21,337,107,0],[338,22,338,60,1],[339,17,339,18,1],[340,21,340,114,1],[341,21,341,62,1],[342,17,342,18,1],[343,13,343,14,1],[344,13,344,36,1],[345,13,345,14,1],[346,17,346,89,1],[347,17,347,105,1],[349,17,349,33,1],[350,17,350,40,1],[353,17,353,47,1],[354,17,354,34,1],[355,17,355,36,1],[356,17,356,38,1],[357,17,357,24,1],[357,26,357,39,1],[357,40,357,42,1],[357,43,357,51,1],[358,17,358,18,1],[359,21,359,77,1],[360,21,360,22,0],[361,25,361,49,0],[362,21,362,22,0],[363,21,363,106,1],[364,21,364,22,1],[365,25,365,115,1],[366,25,366,44,1],[367,25,367,26,0],[370,29,370,59,0],[371,29,371,38,0],[373,30,373,106,1],[374,29,374,49,0],[376,25,377,112,1],[378,25,378,26,1],[380,29,380,50,1],[381,29,381,30,0],[383,33,385,125,0],[386,33,386,47,0],[387,33,387,80,0],[388,33,388,48,0],[389,33,389,34,0],[390,37,390,54,0],[391,37,391,96,0],[392,37,392,73,0],[393,33,393,34,0],[394,38,394,101,0],[395,33,395,34,0],[396,37,396,106,0],[397,33,397,34,0],[398,29,398,30,0],[399,34,399,102,1],[400,29,400,30,1],[402,33,402,70,1],[403,33,403,50,1],[404,29,404,30,1],[406,25,406,26,1],[407,30,407,50,1],[408,29,408,98,1],[409,30,409,50,1],[410,25,410,26,1],[411,29,411,59,1],[412,33,412,148,1],[414,33,414,102,1],[415,25,415,26,1],[417,25,417,26,1],[418,29,418,76,1],[419,29,419,30,1],[420,33,420,103,1],[429,33,429,73,1],[430,29,430,30,1],[431,25,431,26,1],[432,25,432,38,1],[433,21,433,22,1],[434,21,434,32,1],[435,17,435,18,1],[438,22,438,31,1],[438,33,438,47,1],[438,49,438,52,1],[439,21,439,49,1],[440,25,440,42,1],[444,17,444,64,1],[445,17,445,39,1],[445,39,445,69,1],[445,69,445,71,1],[445,17,445,71,1],[447,17,447,50,1],[449,17,449,24,1],[449,26,449,31,1],[449,32,449,34,1],[449,35,449,45,1],[450,21,450,59,1],[450,59,450,70,1],[450,70,450,81,1],[450,21,450,81,1],[451,17,451,30,1],[452,17,452,41,1],[454,17,454,31,1],[455,17,455,18,1],[456,21,456,91,1],[458,21,458,22,1],[459,25,459,73,1],[460,21,460,22,1],[461,21,461,41,0],[462,21,462,22,0],[463,25,465,60,0],[466,21,466,22,0],[467,17,467,18,1],[469,17,469,18,1],[470,21,470,58,1],[472,21,472,22,1],[473,25,473,71,1],[474,29,474,67,1],[476,25,476,84,1],[477,25,477,79,1],[478,21,478,22,1],[479,21,479,41,0],[480,21,480,22,0],[481,25,483,60,0],[484,21,484,22,0],[485,17,485,18,1],[488,17,488,24,1],[488,26,488,48,0],[488,49,488,51,1],[488,52,488,84,1],[489,17,489,18,0],[491,21,491,61,0],[492,21,492,45,0],[493,17,493,18,0],[495,17,495,113,1],[496,17,496,82,1],[498,17,498,24,1],[499,13,499,14,1],[500,9,500,10,1],[503,9,503,10,1],[504,13,504,20,1],[504,22,504,44,0],[504,45,504,47,1],[504,48,504,84,1],[505,13,505,14,0],[506,17,506,96,0],[507,17,507,39,0],[508,13,508,14,0],[509,9,509,10,1],[512,9,512,10,0],[513,13,513,20,0],[513,22,513,39,0],[513,40,513,42,0],[513,43,513,91,0],[514,13,514,14,0],[515,17,515,95,0],[516,17,516,18,0],[517,21,517,77,0],[519,21,519,38,0],[520,21,520,28,0],[520,30,520,43,0],[520,44,520,46,0],[520,47,520,61,0],[521,21,521,22,0],[522,25,522,63,0],[523,29,523,35,0],[524,25,524,36,0],[525,21,525,22,0],[527,21,527,95,0],[528,26,528,39,0],[528,41,528,57,0],[528,59,528,66,0],[529,21,529,22,0],[530,25,530,121,0],[531,25,531,74,0],[532,21,532,22,0],[533,17,533,18,0],[534,13,534,14,0],[535,9,535,10,0],[542,9,542,10,1],[543,13,543,47,1],[546,13,546,29,1],[547,13,547,20,1],[547,22,547,33,1],[547,34,547,36,1],[547,37,547,45,1],[548,13,548,14,1],[549,17,550,121,1],[551,21,551,27,1],[553,21,553,31,1],[554,13,554,14,1],[555,13,555,43,1],[556,17,556,24,0],[558,13,558,26,1],[559,13,559,32,1],[560,13,560,35,1],[561,13,561,14,1],[563,17,563,106,1],[564,17,564,36,1],[564,37,564,43,1],[565,17,565,67,1],[566,21,566,50,1],[568,17,568,24,1],[569,13,569,14,1],[571,13,571,47,1],[572,13,572,52,1],[573,13,573,14,1],[574,17,574,80,1],[575,17,576,63,1],[577,13,577,14,1],[579,13,579,14,1],[580,17,580,109,1],[581,13,581,14,1],[584,13,584,14,1],[585,17,585,71,1],[586,13,586,14,1],[587,13,587,30,0],[588,13,588,14,0],[589,13,589,14,0],[590,9,590,10,1],[593,9,593,10,1],[594,13,594,91,1],[595,17,595,97,1],[596,9,596,10,1],[599,9,599,10,1],[600,13,600,38,1],[601,13,601,31,1],[609,13,609,30,1],[610,13,610,51,1],[612,13,612,20,1],[612,22,612,38,1],[612,39,612,41,1],[612,42,612,50,1],[613,13,613,14,1],[614,17,614,52,1],[615,17,615,33,1],[616,17,616,18,1],[617,21,618,83,1],[619,21,619,22,1],[621,25,621,75,1],[622,25,622,60,1],[623,25,623,26,1],[624,29,624,54,1],[625,29,625,48,1],[626,29,626,53,1],[627,25,627,26,1],[628,25,628,46,1],[629,21,629,22,1],[630,17,630,18,1],[631,17,631,28,1],[632,13,632,14,1],[634,13,634,113,1],[635,13,635,98,1],[637,13,637,20,1],[637,22,637,32,1],[637,33,637,35,1],[637,36,637,43,1],[638,13,638,14,1],[639,17,639,24,1],[639,26,639,37,0],[639,38,639,40,1],[639,41,639,52,1],[640,17,640,18,0],[641,21,641,39,0],[642,21,642,66,0],[643,21,643,22,0],[644,25,644,116,0],[645,25,645,50,0],[646,25,647,101,0],[648,25,648,26,0],[649,29,649,141,0],[650,29,656,31,0],[657,25,657,26,0],[659,25,659,60,0],[661,25,661,69,0],[662,25,662,26,0],[663,29,663,73,0],[664,33,664,86,0],[666,29,667,123,0],[668,25,668,26,0],[669,30,669,85,0],[670,25,670,26,0],[671,29,671,76,0],[672,33,672,97,0],[674,29,675,126,0],[676,25,676,26,0],[678,25,678,53,0],[679,21,679,22,0],[680,17,680,18,0],[681,13,681,14,1],[684,13,684,23,1],[685,9,685,10,1],[688,9,688,10,0],[689,13,689,48,0],[691,13,691,66,0],[692,13,692,45,0],[692,45,692,84,0],[692,84,692,94,0],[692,13,692,94,0],[693,13,693,14,0],[694,17,694,73,0],[694,73,694,112,0],[694,112,694,114,0],[694,17,694,114,0],[695,17,695,53,0],[696,13,696,14,0],[697,13,697,33,0],[698,9,698,10,0],[701,9,701,10,0],[702,13,702,48,0],[703,13,703,58,0],[704,13,704,135,0],[706,13,706,20,0],[706,22,706,32,0],[706,33,706,35,0],[706,36,706,43,0],[707,13,707,14,0],[708,17,708,89,0],[709,17,709,18,0],[710,21,710,125,0],[711,17,711,18,0],[712,13,712,14,0],[714,13,714,69,0],[715,9,715,10,0],[718,9,718,10,1],[719,13,719,96,1],[720,17,720,94,1],[721,9,721,10,1],[724,9,724,10,0],[726,13,726,43,0],[727,13,727,20,0],[727,22,727,43,0],[727,44,727,46,0],[727,47,727,76,0],[728,13,728,14,0],[729,17,729,44,0],[730,22,730,31,0],[730,33,730,56,0],[730,58,730,61,0],[731,17,731,18,0],[732,21,732,84,0],[733,17,733,18,0],[734,17,734,35,0],[735,13,735,14,0],[736,13,736,24,0],[737,9,737,10,0],[740,9,740,10,0],[741,13,741,24,0],[742,13,742,14,0],[743,17,743,24,0],[743,26,743,39,0],[743,40,743,42,0],[743,43,743,50,0],[744,17,744,18,0],[745,21,745,61,0],[746,21,746,28,0],[746,30,746,38,0],[746,39,746,41,0],[746,42,746,55,0],[747,21,747,22,0],[748,25,748,73,0],[749,25,749,46,0],[750,25,750,72,0],[751,25,751,55,0],[752,21,752,22,0],[754,21,754,60,0],[755,17,755,18,0],[756,13,756,14,0],[758,13,758,14,0],[759,17,759,55,0],[760,17,760,24,0],[760,26,760,39,0],[760,40,760,42,0],[760,43,760,50,0],[761,17,761,18,0],[762,21,762,61,0],[763,21,763,28,0],[763,30,763,45,0],[763,46,763,48,0],[763,49,763,59,0],[764,21,764,22,0],[765,25,765,73,0],[766,25,766,52,0],[767,25,767,78,0],[768,25,768,55,0],[769,21,769,22,0],[771,21,771,60,0],[772,17,772,18,0],[773,13,773,14,0],[774,9,774,10,0],[777,9,777,10,0],[778,13,778,59,0],[779,13,779,20,0],[779,22,779,30,0],[779,31,779,33,0],[779,34,779,47,0],[780,13,780,14,0],[781,17,781,44,0],[782,13,782,14,0],[783,13,783,24,0],[784,9,784,10,0]]);
    </script>
  </body>
</html>