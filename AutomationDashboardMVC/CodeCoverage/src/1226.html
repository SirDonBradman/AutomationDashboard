<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\WORKFLW\CodeActivityResource.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.Brix.JavaScriptHost;
using Aurigo.Common;
using Wf = Aurigo.Common;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;

namespace Aurigo.Workflow
{

    [CustomResourceType(&quot;Workflow&quot;)]
    public class CodeActivityResource : WFCustomResource
    {
        private const string NAME = &quot;Run Javascript Code&quot;;
        public const string WFNAMESPACE = &quot;WF.&quot;;

        public CodeActivityResource()
        {
            _Namespace = WFNAMESPACE;
            _Path = WFNAMESPACE + &quot;WorkflowResources&quot;;
            _Name = NAME;
            _Desc = &quot;Run Code Activity&quot;;
        }

        public override IParams GetInputParamNames()
        {
            if (null != _InParams) return _InParams;
            _InParams = new Params(Guid.NewGuid());
            _InParams.SetParam(new Param() { Name = &quot;Code&quot;, Type = &quot;System.String&quot; }, true);
#if kk
            Param action = null;
            action = new Param();
            action.Name = &quot;AssociatedFormInstance&quot;;
            action.IsDerived = true;
            action.IsResolved = false;
            action.IsMandatory = false;
            action.DerivedPath = &quot;_Host_&quot; + _TemplateId + &quot;_&quot; + &quot;AssociatedFormInstance&quot;;
            action.Type = &quot;System.Int32&quot;;
            _InParams.SetParam(action, true);

            action = new Param();
            action.Name = &quot;CurrentUserId&quot;;
            action.IsDerived = true;
            action.IsResolved = false;
            action.IsMandatory = false;
            action.DerivedPath = &quot;_Host_&quot; + _TemplateId + &quot;_&quot; + &quot;CurrentUserId&quot;;
            action.Type = &quot;System.Int32&quot;;
            _InParams.SetParam(action, true);

            action = new Param();
            action.Name = &quot;CurrentRoleId&quot;;
            action.IsDerived = true;
            action.IsResolved = false;
            action.IsMandatory = false;
            action.DerivedPath = &quot;_Host_&quot; + _TemplateId + &quot;_&quot; + &quot;CurrentRoleId&quot;;
            action.Type = &quot;System.Int32&quot;;
            _InParams.SetParam(action, true);

            action = new Param();
            action.Name = &quot;CurrentUser&quot;;
            action.IsDerived = true;
            action.IsResolved = false;
            action.IsMandatory = false;
            action.DerivedPath = &quot;_Host_&quot; + _TemplateId + &quot;_&quot; + &quot;CurrentUser&quot;;
            action.Type = &quot;System.String&quot;;
            _InParams.SetParam(action, true);

            action = new Param();
            action.Name = &quot;UserRoles&quot;;
            action.IsDerived = true;
            action.IsResolved = false;
            action.IsMandatory = false;
            action.DerivedPath = &quot;_Host_&quot; + _TemplateId + &quot;_&quot; + &quot;UserRoles&quot;;
            action.Type = &quot;System.String&quot;;
            _InParams.SetParam(action, true);

            action = new Param();
            action.Name = &quot;StakeHolderRoles&quot;;
            action.IsDerived = true;
            action.IsResolved = false;
            action.IsMandatory = false;
            action.DerivedPath = &quot;_Host_&quot; + _TemplateId + &quot;_&quot; + &quot;StakeHolderRoles&quot;;
            action.Type = &quot;System.String&quot;;
            _InParams.SetParam(action, true);
#endif

            return _InParams;
        }

        public override IParams GetOutputParamNames()
        {
            if (null != _OutputParams) return _OutputParams;

            _OutputParams = new Params(Guid.NewGuid());
            var action = new Param() { Name = &quot;IsSuccess&quot;, Type = &quot;System.Boolean&quot; };
            _OutputParams.SetParam(action, true);
            action = new Param() { Name = &quot;Message&quot;, Type = &quot;System.String&quot; };
            _OutputParams.SetParam(action, true);
            return _OutputParams;
        }

        public override IParams Execute(IParams p)
        {
            string sErr;
            object Code = GetParam2(p, &quot;Code&quot;, out sErr);

            object q = GetParam2(p, &quot;associatedforminstance&quot;, out sErr);

            object a = GetParam2(p, &quot;currentuserid&quot;, out sErr);



            var host = new JavaScriptHost();

            var s = Code.ToString();

            var result = host.ExecuteScript(s, GetHostParametersValue(), out sErr);

            var ps = new Params(GetOutputParamNames().RefId);
            ps.SetParam(&quot;Message&quot;, result, &quot;System.String&quot;, true);
            ps.SetParam(&quot;IsSuccess&quot;, true, &quot;System.Boolean&quot;, true);
            return ps;
        }

        private IDictionary&lt;string, object&gt; GetHostParametersValue()
        {
            Dictionary&lt;string, object&gt; hostParamsValue = new Dictionary&lt;string, object&gt;();
            IParams hostParams = GetHostParams();
            if (hostParams != null)
            {
                foreach (IParam param in hostParams.Contents.Values)
                {
                    hostParamsValue.Add(param.Name, param.Value);
                }
            }
            return hostParamsValue;
        }

        public override Params GetPossibleValuesFor(string sInputParamName, IResourceInstance optionalRI)
        {
            return null;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,38,0],[21,9,21,10,0],[22,13,22,38,0],[23,13,23,55,0],[24,13,24,26,0],[25,13,25,41,0],[26,9,26,10,0],[29,9,29,10,0],[30,13,30,35,0],[30,36,30,53,0],[31,13,31,52,0],[32,13,32,93,0],[90,13,90,30,0],[91,9,91,10,0],[94,9,94,10,0],[95,13,95,39,0],[95,40,95,61,0],[97,13,97,56,0],[98,13,98,86,0],[99,13,99,50,0],[100,13,100,79,0],[101,13,101,50,0],[102,13,102,34,0],[103,9,103,10,0],[106,9,106,10,0],[108,13,108,58,0],[110,13,110,73,0],[112,13,112,64,0],[116,13,116,45,0],[118,13,118,37,0],[120,13,120,84,0],[122,13,122,62,0],[123,13,123,67,0],[124,13,124,68,0],[125,13,125,23,0],[126,9,126,10,0],[129,9,129,10,0],[130,13,130,91,0],[131,13,131,50,0],[132,13,132,36,0],[133,13,133,14,0],[134,17,134,24,0],[134,26,134,38,0],[134,39,134,41,0],[134,42,134,68,0],[135,17,135,18,0],[136,21,136,66,0],[137,17,137,18,0],[138,13,138,14,0],[139,13,139,36,0],[140,9,140,10,0],[143,9,143,10,0],[144,13,144,25,0],[145,9,145,10,0]]);
    </script>
  </body>
</html>