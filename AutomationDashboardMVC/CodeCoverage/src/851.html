<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\AbstractModels\ItemListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.Web;
using System.Web.UI;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.BusinessLayer.DTO;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.Documents.Excel;
using Infragistics.WebUI.UltraWebGrid;
using Infragistics.WebUI.UltraWebGrid.ExcelExport;
using NPOI.SS.UserModel;
using System.Linq;
using System.Web.Script.Serialization;

namespace Aurigo.AMP3.Core.AbstractModels
{
    [ContextElement(Name = &quot;Item List&quot;)]
    [ListModelContext(Table = &quot;CORITEMItemDetails&quot;)]
    public abstract class ItemListModel : ListModel
    {
        public static new Dictionary&lt;string, Type&gt; contextDictionary;
        private static readonly List&lt;string&gt; eisContextList;

        protected Dictionary&lt;string, object&gt; eisData = new Dictionary&lt;string, object&gt;();

        private const string IMPROT_EXPORT_SHEET_NAME = &quot;Item&quot;;

        //public string ExportFileDownloadTokenID
        //{
        //    get; set;
        //}

        //public string ExportFileDownloadTokenValue
        //{
        //    get; set;
        //}

        static ItemListModel()
        {
            if (eisContextList == null)
            {
                eisContextList = new List&lt;string&gt;();
                eisContextList.Add(Constants.MODID_CONTMGT);
            }
            if (contextDictionary == null)
            {
                contextDictionary = ModelHelper.GetModelObjects(typeof(ItemListModel));
            }
        }

        public override int GetProjectIdFromInstanceId()
        {
            return GetProjectIdOfItem(ModuleId, ParentID);
        }

        public virtual int GetProjectIdOfItem(string moduleId, int parentInstanceID)
        {
            if ((moduleId.Equals(Constants.MODID_CONTMGT, StringComparison.CurrentCultureIgnoreCase) ||
               moduleId.Equals(Constants.MODID_ESTMATE, StringComparison.CurrentCultureIgnoreCase)) ||
               moduleId.Equals(&quot;BDGTEMP&quot;, StringComparison.CurrentCultureIgnoreCase) ||
               moduleId.Equals(&quot;BDGTEST&quot;, StringComparison.CurrentCultureIgnoreCase) ||
               moduleId.Equals(&quot;BDGTREV&quot;, StringComparison.CurrentCultureIgnoreCase) ||
               moduleId.Equals(Constants.MODID_ESTMADD, StringComparison.CurrentCultureIgnoreCase) ||
               moduleId.Equals(Constants.MODID_CHNGORD, StringComparison.CurrentCultureIgnoreCase) ||
               moduleId.Equals(Constants.MODID_CHNGORD, StringComparison.CurrentCultureIgnoreCase))
            {
                return ItemListModel.GetProjectIdOfItemList(moduleId, parentInstanceID);
            }
            else
            {
                return (string.IsNullOrEmpty(Request.QueryString[&quot;PID&quot;]) ? 0 : Request.QueryString[&quot;PID&quot;].ToInt32_2());
            }
        }

        /// &lt;summary&gt;
        /// Gets the Project Mode : I-Integration, L-Live
        /// &lt;/summary&gt;
        private new string ProjectMode
        {
            get
            {
                return (CacheManager.Instance.IsIntegrated(Request.QueryString[Constants.QRY_PROJECTID].ToInt32_2())
                    ? &quot;I&quot;
                    : &quot;L&quot;);
            }
        }

        protected override bool DisplayTemplateExportWithData
        {
            get
            {
                return true;
            }
        }

        public Dictionary&lt;string, object&gt; EISData
        {
            get { return eisData; }
        }

        #region Properties

        protected bool displayAmountColumn = true;
        protected bool displayItemSummary = true;
        protected bool isContainerEditable = true;
        public bool allowNegativeUnit = false;
        public string AfterEditItemScript = String.Empty;
        public int parentID;
        protected bool displayBudgetItemAssociatePicker = false;

        private List&lt;string&gt; _budgetModuleComponent = null;
        public List&lt;string&gt; BudgetModuleComponent
        {
            get
            {
                if (_budgetModuleComponent == null)
                    _budgetModuleComponent = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_BDGMGMT);
                return _budgetModuleComponent;
            }
        }
        public int ParentID
        {
            get { return parentID; }
        }

        public virtual HierarchicalGridColumn AmountColumn
        {
            get
            {
                var col = new HierarchicalGridColumn(&quot;Amount&quot;, 120, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                    false);
                col.Caption = &quot;Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL);
                return col;
            }
        }

        public bool DisplayBudgetItemAssociatePicker
        {
            get { return displayBudgetItemAssociatePicker; }
            set { displayBudgetItemAssociatePicker = value; }
        }

        public bool DisplayItemSummary
        {
            get { return displayItemSummary; }
        }

        public bool DisplayAmountColumn
        {
            get { return displayAmountColumn; }
        }

        public bool IsContainerEditable
        {
            get { return isContainerEditable; }
        }

        public string SelectedItems { get; set; }
        public string SelectedContainers { get; set; }
        public string SelectedSubItems { get; set; }

        public string ItemIdHiddenControl { get; set; }
        public string SubItemIdHiddenControl { get; set; }
        public string ContainerIdHiddenControl { get; set; }

        public bool DisplayReorder { get; set; }

        protected bool showFlatList = false;

        public bool ShowFlatList
        {
            get { return showFlatList; }
            set { showFlatList = value; }
        }

        public bool ShowContainerDetails { get; set; }

        public int ShowContainerDetailsAtPosition { get; set; }

        public HierarchicalGrid hGrid { get; set; }

        protected bool disableSave = true;

        public bool DisableSave
        {
            get { return disableSave; }
            set { disableSave = value; }
        }

        protected bool enableSave = true;

        public bool EnableSave
        {
            get { return enableSave; }
            set { enableSave = value; }
        }

        /// &lt;summary&gt;
        /// This will override the Activities in the component
        /// Can be used if we have to show activties in certain pages
        /// &lt;/summary&gt;
        public bool ShowActivities { get; set; }

        public override List&lt;MenuGroup&gt; MenuGroups
        {
            get
            {
                List&lt;MenuGroup&gt; menuGroups = base.MenuGroups;
                MenuGroup generalGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_GENERAL);
                if (generalGroup == null)
                    generalGroup = new MenuGroup(GROUP_GENERAL);
                MenuGroup otherGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_OTHERS);
                if (otherGroup == null)
                    otherGroup = new MenuGroup(GROUP_OTHERS);

                if ((displayNew &amp;&amp; displayNewContainer) || (displayNew &amp;&amp; displayAddMultiple))
                {
                    // Removing if new button exists
                    LargeButton newButton = (LargeButton)generalGroup.Menus.Find(m =&gt; m.ID == &quot;lnkNew&quot;);
                    if (newButton != null)
                        generalGroup.Menus.Remove(newButton);

                    var newMenu = new MenuButton(&quot;lnkAddNew&quot;, &quot;New&quot;, &quot;Icn_New.png&quot;, showRedirectConfirmMessage: true);
                    newMenu.AddSubMenu(new TextIcon(&quot;lnkNew&quot;, &quot;New&quot;, &quot;Icn_New_16.png&quot;, showRedirectConfirmMessage: true));
                    if (displayAddMultiple)
                        newMenu.AddSubMenu(new TextIcon(&quot;lnkAddMulti&quot;, &quot;Add Multiple&quot;, &quot;Icn_Addmultiple_16.png&quot;,
                            showRedirectConfirmMessage: true));
                    if (displayNewContainer)
                        newMenu.AddSubMenu(new TextIcon(&quot;lnkNewContainer&quot;,
                            &quot;New &quot; + LocalizationManager.GetString(&quot;Container&quot;), &quot;Icn_Folder_16.png&quot;,
                            showRedirectConfirmMessage: true));
                    generalGroup.AddMenu(newMenu, 0);
                }

                else if (displayNew &amp;&amp; !displayNewContainer)
                {
                    LargeButton newButton = (LargeButton)generalGroup.Menus.Find(m =&gt; m.ID == MENU_NEW_ID);
                    if (newButton == null)
                        generalGroup.AddMenu(new LargeButton(&quot;lnkNew&quot;, &quot;New&quot;, &quot;Icn_New.png&quot;,
                            showRedirectConfirmMessage: true));
                }
                else if (displayNewContainer)
                    generalGroup.AddMenu(new LargeButton(&quot;lnkNewContainer&quot;, &quot;New&quot;, &quot;Icn_Folder.png&quot;, &quot;&quot;, &quot;New Container&quot;,
                        showRedirectConfirmMessage: true));

                if (DisableSave)
                {
                    generalGroup.AddMenu(new LargeButton(&quot;lnkListSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;,
                        showRedirectConfirmMessage: false));
                }

                if (menuGroups.Contains(generalGroup))
                {
                    if (generalGroup.Menus.Count &lt;= 0)
                        menuGroups.Remove(generalGroup);
                }
                else
                {
                    if (generalGroup.Menus.Count &gt; 0)
                        menuGroups.Insert(0, generalGroup);
                }

                if (showFlatList)
                    otherGroup.AddMenu(new TextIcon(&quot;lnkFlatList&quot;, &quot;Flat List&quot;, &quot;Icn_exceltemplateexport_16.png&quot;,
                        showRedirectConfirmMessage: true));

                #region Details

                List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);

                MenuGroup itemDetail = new MenuGroup(GlobalizationUtility.SetResource(&quot;Item&quot;, false) + &quot; Details&quot;);
                if (DisplayReorder)
                    itemDetail.AddMenu(new TextIcon(&quot;lnkReorder&quot;, &quot;Reorder&quot;, &quot;Icn_Reorder_16.png&quot;,
                        showRedirectConfirmMessage: true));
                MenuButton itemBtn = new MenuButton(&quot;lnkItemDetails&quot;, &quot;Actions&quot;, &quot;Icn_Itemdetails.png&quot;,
                    showRedirectConfirmMessage: true);
                if (displaySubItems &amp;&amp; ModuleComponents.Contains(&quot;SubItems&quot;) &amp;&amp; ModuleComponents.Contains(&quot;ONGFundMgmt&quot;))
                    itemBtn.AddSubMenu(new TextIcon(&quot;lnkSubItems&quot;, &quot;Sub items&quot;, &quot;Icn_Subitems_16.png&quot;,
                        showRedirectConfirmMessage: true));
                if (ModuleComponents.Contains(&quot;RateAnalysis&quot;) &amp;&amp; displayRateAnalysis)
                    itemBtn.AddSubMenu(new TextIcon(&quot;lnkRateAnalysis&quot;, &quot;Rate Analysis&quot;, &quot;Icn_Rateanalysis_16.png&quot;,
                        showRedirectConfirmMessage: true));
                if (displayItemCopyPaste)
                    itemBtn.AddSubMenu(new TextIcon(&quot;lnkItemCopyPaste&quot;, &quot;Copy &quot; + ItemNameAbbr + &quot;s&quot;,
                        &quot;Icn_Copyitems_16.png&quot;, showRedirectConfirmMessage: true));
                if (displaySubItemCopyPaste &amp;&amp; ModuleComponents.Contains(&quot;SubItems&quot;) &amp;&amp;
                    ModuleComponents.Contains(&quot;ONGFundMgmt&quot;))
                    itemBtn.AddSubMenu(new TextIcon(&quot;lnkSubItemCopyPaste&quot;, &quot;Copy Sub Items&quot;, &quot;Icn_Copy_16.png&quot;,
                        showRedirectConfirmMessage: true));
                if (DisplayExecutionView)
                    itemBtn.AddSubMenu(new TextIcon(&quot;lnkExecutionView&quot;, &quot;Execution View&quot;, &quot;Icn_Executionview_16.png&quot;,
                        showRedirectConfirmMessage: true));
                if (DisplayContractView)
                    itemBtn.AddSubMenu(new TextIcon(&quot;lnkContractView&quot;, &quot;Contract View&quot;, &quot;Icn_ContractView_16.png&quot;,
                        showRedirectConfirmMessage: true));
                if (DisplayCostManager)
                    itemDetail.AddMenu(new TextIcon(&quot;lnkCostManager&quot;, &quot;Cost Sheet&quot;, &quot;Icn_Costview_16.png&quot;,
                        showRedirectConfirmMessage: true));
                if (DisplayGlobalGroups)
                    itemBtn.AddSubMenu(new TextIcon(&quot;lnkGlobalGroups&quot;, &quot;Global Groups&quot;, &quot;Icn_Subitems_16.png&quot;,
                        showRedirectConfirmMessage: true));

                if (displayBudgetItemAssociatePicker &amp;&amp; ModuleManager.Instance.ModuleExists(Constants.MODID_BDGMGMT) &amp;&amp;
                    BudgetModuleComponent.Contains(&quot;LinkBudgetItem&quot;))
                {
                    MenuButton lnkAssociation = new MenuButton(&quot;lnkAssociation&quot;, &quot;Association&quot;, &quot;Icn_Association.png&quot;);

                    TextIcon manuallyAssociate = new TextIcon(&quot;lnkManuallyAssociate&quot;, &quot;Associate Budget Items&quot;,
                        &quot;Icn_Addexistingrecord_16.png&quot;);
                    lnkAssociation.AddSubMenu(manuallyAssociate);

                    TextIcon removeAssociation = new TextIcon(&quot;lnkRemoveAssociation&quot;, &quot;Disassociate Budget Items&quot;,
                        &quot;Icn_Addexistingrecord_16.png&quot;);
                    lnkAssociation.AddSubMenu(removeAssociation);

                    if (lnkAssociation.SubMenus.Count &gt; 0)
                        itemDetail.AddMenu(lnkAssociation);

                }

                //if (DisplayPlanningMenu)
                //{
                //    var planningMenu = new TextIcon(&quot;lnkPlanning&quot;, &quot;Scheduling&quot;, &quot;Icn_Scheduling_16.png&quot;);
                //    if (displaySyncEIS)
                //        planningMenu.AddSubMenu(new TextIcon(&quot;lnkSync&quot;, &quot;Synchronise&quot;, &quot;Icn_Sync_16.png&quot;));
                //    if (displayFetchEIS)
                //        planningMenu.AddSubMenu(new TextIcon(&quot;lnkFetch&quot;, &quot;Fetch&quot;, &quot;Icn_Fetch_16.png&quot;));
                //    itemDetail.AddMenu(planningMenu);
                //}
                //else
                //{
                //    if (displaySyncEIS) itemBtn.AddSubMenu(new TextIcon(&quot;lnkSync&quot;, &quot;Scheduling - Synchronise&quot;, &quot;Icn_Sync_16.png&quot;));
                //    if (displayFetchEIS) itemBtn.AddSubMenu(new TextIcon(&quot;lnkFetch&quot;, &quot;Scheduling - Fetch&quot;, &quot;Icn_Fetch_16.png&quot;));
                //}
                if (itemBtn.SubMenus.Count &gt; 0)
                    itemDetail.AddMenu(itemBtn);
                if (itemDetail.Menus.Count &gt; 0 || itemBtn.SubMenus.Count &gt; 0)
                    menuGroups.Insert((menuGroups.Count &gt; 1) ? 1 : menuGroups.Count, itemDetail);

                if (menuGroups.Contains(otherGroup))
                {
                    if (otherGroup.Menus.Count &lt;= 0)
                        menuGroups.Remove(otherGroup);
                }
                else
                {
                    if (otherGroup.Menus.Count &gt; 0)
                        menuGroups.Add(otherGroup);
                }

                #endregion

                return menuGroups;
            }
        }

        public virtual bool AllowGridEdit { get; set; }

        public string RollUpColumnName { get; set; }

        #endregion

        #region Utility Methods

        private new void SetColumnInfo()
        {
            columnInfo = new BrixDataTable();
            columnInfo.Columns.Add(&quot;Key&quot;);
            columnInfo.Columns.Add(&quot;ColumnWidth&quot;);
            columnInfo.Columns.Add(&quot;Hidden&quot;);
            columnInfo.Columns.Add(&quot;Position&quot;);
            columnInfo.Columns.Add(&quot;Format&quot;);
            columnInfo.Columns.Add(&quot;AllowUpdate&quot;);

            gridImageInfo = new BrixDataTable();
            gridImageInfo.Columns.Add(&quot;Key&quot;);
            gridImageInfo.Columns.Add(&quot;Value&quot;);
            gridImageInfo.Columns.Add(&quot;ImageFile&quot;);
            gridImageInfo.Columns.Add(&quot;Caption&quot;);
        }

        public new static ItemListModel GetInstance(HttpRequest request, HttpResponse response, string additionalInfo)
        {
            string context = request[&quot;Context&quot;];
            context = GetEISContextMap(context, eisContextList);
            return GetInstance(context, request, response, additionalInfo);
        }

        public new static ItemListModel GetInstance(string context, HttpRequest request, HttpResponse response,
            string additionalInfo)
        {
            if (!contextDictionary.ContainsKey(context)
                || contextDictionary[context] == null)
            {
                return null;
            }

            var listModel = (ItemListModel)Activator.CreateInstance(contextDictionary[context]);
            listModel.DisplayFilterManagerMenuGroup = false;

            if (request != null)
            {
                int.TryParse(request[&quot;ParentID&quot;], out listModel.parentID);
            }
            listModel.Request = request;
            listModel.Response = response;
            var objAdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
            objAdditionalInfo.AddInfo(Constants.EIS_ADDITIONAL_INFO, additionalInfo);
            listModel.AdditionalInfo = objAdditionalInfo;
            listModel.SetColumnInfo();
            listModel.SetUIDetails();

            return listModel;
        }

        public static ItemListModel GetInstance(string context, int ParentInstanceID, HttpRequest request,
            HttpResponse response, string additionalInfo)
        {
            if (!contextDictionary.ContainsKey(context)
                || contextDictionary[context] == null)
            {
                return null;
            }

            var listModel = (ItemListModel)Activator.CreateInstance(contextDictionary[context]);
            listModel.DisplayFilterManagerMenuGroup = false;

            listModel.parentID = ParentInstanceID;

            listModel.Request = request;
            listModel.Response = response;
            var objAdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
            objAdditionalInfo.AddInfo(Constants.EIS_ADDITIONAL_INFO, additionalInfo);
            listModel.AdditionalInfo = objAdditionalInfo;
            listModel.SetColumnInfo();
            listModel.SetUIDetails();

            return listModel;
        }

        public static int GetProjectIdOfItemList(string moduleID, int parentInstanceID)
        {
            int id = -1;
            object objId = ComponentHelper.Instance.ExecuteScalar(StoredProcedure.usp_CORITEMGetProjectIDOfItemList, null, moduleID, parentInstanceID);

            if (objId != null) int.TryParse(objId.ToString(), out id);
            return id;
        }

        public static DataTable GetContainer(HttpRequest request, bool isList, string moduleID)
        {
            string parentID = request[&quot;ParentID&quot;];

            return ComponentHelper.Instance.ExecuteDataSet(StoredProcedure.usp_CORITEMGetContainer, null,
                moduleID, parentID, isList ? null : request[&quot;ContainerID&quot;]).
                Tables[0];
        }

        public static int GetProjectIdOfContainer(string moduleID, int parentInstanceID, int containerId)
        {
            int id = -1;
            object objId = ComponentHelper.Instance.ExecuteScalar(StoredProcedure.usp_CORITEMGetProjectIDOfContainer, null, moduleID,
                parentInstanceID, containerId);

            if (objId != null) int.TryParse(objId.ToString(), out id);
            return id;
        }

        public virtual void FetchActivities(HierarchicalGrid sender, int itemID)
        {
            sender.ActivityTable =
                ItemManager.Instance.GetItemActivities(ModuleId,
                    Convert.ToInt32(Request[&quot;ParentID&quot;], CultureInfo.CurrentCulture),
                    itemID, &quot;N&quot;).Tables[0];
        }

        public virtual DataTable FetchActivitiesByItemIdList(List&lt;int&gt; itemIdList)
        {
            return ItemManager.Instance.GetItemActivitiesByIdList(ModuleId, Convert.ToInt32(Request[&quot;ParentID&quot;], CultureInfo.CurrentCulture), itemIdList, &quot;N&quot;).Tables[0];
        }

        public virtual void FetchSubItems(HierarchicalGrid sender, int itemID)
        {
            sender.SubItemTable =
                ItemManager.Instance.GetSubItemData(ModuleId,
                    Convert.ToInt32(Request[&quot;ParentID&quot;], CultureInfo.CurrentCulture),
                    itemID).Tables[0];
        }

        public virtual DataTable FetchSubItemsByItemIdList(List&lt;int&gt; itemIdList)
        {
            return ItemManager.Instance.GetSubItemDataByItemIdList(ModuleId, Convert.ToInt32(Request[&quot;ParentID&quot;], CultureInfo.CurrentCulture), itemIdList).Tables[0];
        }

        public virtual void FetchActivitiesWithAltID(HierarchicalGrid sender, int itemID, int altID)
        {
        }

        public virtual void FetchSubItemsWithAltID(HierarchicalGrid sender, int itemID, int altID)
        {
        }

        public void SaveHGridSettings(int UID, string ControlName, string CustomSettings)
        {
            CoreDatabaseHelper.SaveControlSettings(UID, ControlName, CustomSettings);
        }

        #endregion

        #region Virtual Methods

        protected virtual void SortExportList(DataSet ds)
        {
            if (ds != null &amp;&amp; ds.Tables.Count &gt; 0)
            {
                string ParentIDCol = &quot;ParentID&quot;;
                DataTable dt = ds.Tables[0];
                if (dt.Columns.Contains(ImportItems.INTERNAL_ID_COl_NAME)
                  &amp;&amp; dt.Columns.Contains(ImportItems.RESOURCE_TYPE_COL_NAME)
                  &amp;&amp; dt.Columns.Contains(ItemsDBColumns.LINE_NO)
                  &amp;&amp; dt.Columns.Contains(ParentIDCol))
                {
                    DataTable sortedTable = dt.Clone();
                    SortItemChildren(dt, sortedTable, 0, true);
                    ds.Tables.RemoveAt(0);
                    ds.Tables.Add(sortedTable);
                }
            }
        }

        private void SortItemChildren(DataTable dt, DataTable sortedDt, int itemId, bool isContainer)
        {
            string lineNoCol = ItemsDBColumns.LINE_NO;
            string ParentIDCol = &quot;ParentID&quot;;

            //DataTable sortedTable = dt.Clone();

            DataRow[] rows = null;

            if (isContainer)
            {
                rows = dt.Select(ImportItems.RESOURCE_TYPE_COL_NAME + &quot;= &#39;&quot; + ImportItems.ITEM_TYPE + &quot;&#39; AND &quot; + ParentIDCol + &quot;= &quot; + itemId, lineNoCol + &quot; ASC&quot;);
                foreach (DataRow row in rows)
                {
                    sortedDt.ImportRow(row);
                    SortItemChildren(dt, sortedDt, (int)row[ImportItems.INTERNAL_ID_COl_NAME], false);
                }

                rows = dt.Select(ImportItems.RESOURCE_TYPE_COL_NAME + &quot;= &#39;&quot; + ImportItems.CONTAINER_TYPE + &quot;&#39; AND &quot; + ParentIDCol + &quot;=&quot; + itemId, ImportItems.INTERNAL_ID_COl_NAME + &quot; ASC&quot;);
                foreach (DataRow row in rows)
                {
                    sortedDt.ImportRow(row);
                    SortItemChildren(dt, sortedDt, (int)row[ImportItems.INTERNAL_ID_COl_NAME], true);
                }
            }
            else
            {
                rows = dt.Select(ImportItems.RESOURCE_TYPE_COL_NAME + &quot;= &#39;&quot; + ImportItems.SUB_ITEM_TYPE + &quot;&#39; AND &quot; + ParentIDCol + &quot;=&quot; + itemId, ImportItems.INTERNAL_ID_COl_NAME + &quot; ASC&quot;);
                foreach (DataRow row in rows)
                {
                    sortedDt.ImportRow(row);
                }

                rows = dt.Select(ImportItems.RESOURCE_TYPE_COL_NAME + &quot;&lt;&gt; &#39;&quot; + ImportItems.CONTAINER_TYPE + &quot;&#39; AND &quot;
                    + ImportItems.RESOURCE_TYPE_COL_NAME + &quot;&lt;&gt; &#39;&quot; + ImportItems.ITEM_TYPE + &quot;&#39; AND &quot;
                    + ImportItems.RESOURCE_TYPE_COL_NAME + &quot;&lt;&gt; &#39;&quot; + ImportItems.SUB_ITEM_TYPE + &quot;&#39; AND &quot;
                    + ParentIDCol + &quot;=&quot; + itemId, ImportItems.INTERNAL_ID_COl_NAME + &quot; ASC&quot;);
                foreach (DataRow row in rows)
                {
                    sortedDt.ImportRow(row);
                }
            }
        }

        private ImportItems _ImportExportItems = null;
        public virtual ImportItems ImportExportItems
        {
            get
            {
                if (_ImportExportItems == null)
                    _ImportExportItems = string.IsNullOrEmpty(Request[&quot;context&quot;]) ? null : ImportBase.GetInstance(Request[&quot;context&quot;]) as ImportItems;

                return _ImportExportItems;
            }
        }

        public virtual object GetExportList(string ExportContext)
        {
            StoredProcedure sp = StoredProcedure.usp_CORITEMGetDetailsForExport;
            DataSet ds = ComponentHelper.Instance.ExecuteDataSet(sp, null,
                ModuleId, parentID, null, ExportContext, null);

            SortExportList(ds);

            UpdateRolledUpValue(ds.Tables[0]);

            List&lt;string&gt; coreComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
            if (String.IsNullOrEmpty(ExportContext) || ExportContext.Equals(&quot;Excel&quot;))
            {
                List&lt;string&gt; components = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
                //Item table
                if (!components.Contains(&quot;ItemMargin&quot;))
                    if (ds.Tables[0].Columns.Contains(&quot;Margin&quot;))
                        ds.Tables[0].Columns.Remove(&quot;Margin&quot;);
                if (!components.Contains(&quot;ItemDiscount&quot;))
                    if (ds.Tables[0].Columns.Contains(&quot;Discount&quot;))
                        ds.Tables[0].Columns.Remove(&quot;Discount&quot;);
                
                ds.Tables[0].TableName = IMPROT_EXPORT_SHEET_NAME;
                // ds.Tables[1].TableName = &quot;Resource&quot;;  //LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR);
                if (ds.Tables[0].Columns.Contains(&quot;Unit&quot;))
                    ds.Tables[0].Columns[&quot;Unit&quot;].ColumnName = LocalizationManager.GetString(&quot;Unit&quot;);
                if (ds.Tables[0].Columns.Contains(&quot;ScheduledGroup&quot;))
                    ds.Tables[0].Columns[&quot;ScheduledGroup&quot;].ColumnName = LocalizationManager.GetString(KeyConstants.Group);
                if (ds.Tables[0].Columns.Contains(&quot;Standard Item No&quot;))
                    ds.Tables[0].Columns[&quot;Standard Item No&quot;].ColumnName =
                        LocalizationManager.GetString(KeyConstants.LOC_STDPAYITEM);
                if (ds.Tables[0].Columns.Contains(&quot;Base Cost&quot;))
                    ds.Tables[0].Columns[&quot;Base Cost&quot;].ColumnName =
                        LocalizationManager.GetString(KeyConstants.LOC_UNIT_PRICE);
                if (ds.Tables[0].Columns.Contains(&quot;AltCode&quot;))
                    ds.Tables[0].Columns[&quot;AltCode&quot;].ColumnName = &quot;Alternate&quot;;

                if (ds.Tables[0].Columns.Contains(&quot;Wastage Percent&quot;))
                    ds.Tables[0].Columns.Remove(&quot;Wastage Percent&quot;);

                if (ds.Tables[0].Columns.Contains(&quot;Size&quot;))
                    ds.Tables[0].Columns.Remove(&quot;Size&quot;);

                if (ds.Tables[0].Columns.Contains(&quot;Color&quot;))
                    ds.Tables[0].Columns.Remove(&quot;Color&quot;);

                if (ds.Tables[0].Columns.Contains(&quot;Configuration&quot;))
                    ds.Tables[0].Columns.Remove(&quot;Configuration&quot;);

                //if (ds.Tables[1].Columns.Contains(&quot;StandardItemNo&quot;))
                //    ds.Tables[1].Columns[&quot;StandardItemNo&quot;].ColumnName =
                //        LocalizationManager.GetString(KeyConstants.LOC_STDPAYITEM);

                //int tableNo = 2;
                //if (!this.ModuleId.Equals(Constants.MODID_LIBRARY) &amp;&amp; coreComponents.Contains(&quot;SubItems&quot;))
                //    ds.Tables[tableNo++].TableName = &quot;SubItems&quot;;


                //if (coreComponents.Contains(&quot;Activities&quot;)) ds.Tables[tableNo++].TableName = &quot;Activities&quot;;
                //if (coreComponents.Contains(&quot;Components&quot;)) ds.Tables[tableNo++].TableName = &quot;Components&quot;;
                //if (coreComponents.Contains(&quot;RateAnalysis&quot;))
                //{
                //    ds.Tables[tableNo++].TableName = LocalizationManager.GetString(KeyConstants.LOC_ICA_EQUIPMENT);
                //    ds.Tables[tableNo++].TableName = LocalizationManager.GetString(KeyConstants.LOC_ICA_MANPOWER);
                //    ds.Tables[tableNo++].TableName = LocalizationManager.GetString(KeyConstants.LOC_ICA_MATERIALS);
                //    ds.Tables[tableNo++].TableName = LocalizationManager.GetString(KeyConstants.LOC_ICA_MISC);
                //    ds.Tables[tableNo++].TableName = &quot;SubContract&quot;;
                //}


                DataSet importExportDS = GetSchema();
                if (ds != null)
                {
                    for (int i = 0; i &lt; importExportDS.Tables.Count; i++)
                    {

                        List&lt;string&gt; colsToRemove = new List&lt;string&gt;();
                        foreach (DataColumn c in ds.Tables[i].Columns)
                        {
                            if (!importExportDS.Tables[i].Columns.Contains(c.ColumnName))
                                colsToRemove.Add(c.ColumnName);
                        }

                        foreach (string name in colsToRemove)
                            ds.Tables[i].Columns.Remove(name);
                    }
                }

                GetExportListData(ds);

                
               // ImportItems importItems = string.IsNullOrEmpty(Request[&quot;context&quot;])? null: ImportBase.GetInstance(Request[&quot;context&quot;]) as ImportItems;

                if (ImportExportItems != null &amp;&amp; ImportExportItems.HasXMLInjectionFields)
                {
                    DataTable dtExt = ImportExportItems.GetXMLInjectionExportListData(ImportItems.INTERNAL_ID_COl_NAME);
                    if (dtExt != null)
                    {
                        DataTable dt = JoinXmlInjectedFields(ds.Tables[0], dtExt, ImportItems.INTERNAL_ID_COl_NAME);
                        ds.Tables.Remove(ds.Tables[0]);
                        ds.Tables.Add(dt);
                    }
                }

                LocalizeExportData(ds, importExportDS);
            }

            return ds;
        }

        private void UpdateRolledUpValue(DataTable dt)
        {
            if(!string.IsNullOrEmpty(RollUpColumnName))
            {
                if (dt != null &amp;&amp; dt.Rows != null &amp;&amp; dt.Rows.Count &gt; 0 &amp;&amp; dt.Columns.Contains(RollUpColumnName))
                {
                    for (int i = 0; i &lt; dt.Rows.Count; i++)
                    {
                        if (dt.Rows[i][&quot;Type&quot;].ToString() == &quot;Container&quot;)
                        {
                            int containerId = Convert.ToInt32(dt.Rows[i][&quot;Internal ID&quot;].ToString());
                            decimal rollUpColumnValue = Convert.ToDecimal(dt.Rows[i][RollUpColumnName].ToString());
                            dt.Rows[i][RollUpColumnName] = GetRolledUpValue(containerId, dt, rollUpColumnValue);
                        }
                    }
                }
            }
           
        }        

        private decimal GetRolledUpValue(int parentContainerId, DataTable dt,decimal parentContainerRollUpValue)
        {
            decimal total = parentContainerRollUpValue;
            if (dt != null &amp;&amp; dt.Rows != null &amp;&amp; dt.Rows.Count &gt; 0)
            {
                for (int i = 0; i &lt; dt.Rows.Count; i++)
                {

                    int parentId = Convert.ToInt32(dt.Rows[i][&quot;ParentID&quot;].ToString());                   
                    if (parentId == parentContainerId &amp;&amp; dt.Rows[i][&quot;Type&quot;].ToString() == &quot;Container&quot;)
                    {
                        int containerId = Convert.ToInt32(dt.Rows[i][&quot;Internal ID&quot;].ToString());
                        decimal rollUpColumnValue = Convert.ToDecimal(dt.Rows[i][RollUpColumnName].ToString());
                        total = total + GetRolledUpValue(containerId, dt, rollUpColumnValue);
                    }

                }
            }
            return total;

        }

        protected virtual DataTable JoinXmlInjectedFields(DataTable dt, DataTable dtExt, string joinField)
        {
            DataTable dtResult = new DataTable();
            dtResult.TableName = dt.TableName;
            var joinTable = from t1 in dt.AsEnumerable()
                            join tExt in dtExt.AsEnumerable()
                            on new { a = t1[joinField], b = t1[ImportItems.RESOURCE_TYPE_COL_NAME].ToString() } equals new { a = tExt[joinField], b = &quot;Item&quot; }
                            into result
                            from t2 in result.DefaultIfEmpty()
                            select new { r1 = t1, r2 = (t2 != null ? t2 : dtExt.NewRow()) };

            foreach (DataColumn col in dt.Columns)
                dtResult.Columns.Add(col.ColumnName, typeof(string));

            DataTable dtExtClone = dtExt.Clone();
            dtExtClone.Columns.Remove(joinField);

            foreach (DataColumn col in dtExtClone.Columns)
                dtResult.Columns.Add(col.ColumnName, typeof(string));

            foreach (var row in joinTable)
            {
                var newRow = dtResult.NewRow();
                foreach (DataColumn col in dt.Columns)
                    newRow[col.ColumnName] = row.r1[col.ColumnName];
                foreach (DataColumn col in dtExtClone.Columns)
                    newRow[col.ColumnName] = row.r2[col.ColumnName];

                dtResult.Rows.Add(newRow);
            }
            return dtResult;
        }

        protected virtual void LocalizeExportData(DataSet ds, DataSet importExportSchema, bool isTemplateWithData = true)
        {
            if (isTemplateWithData)
            {
                if (ds != null &amp;&amp; ds.Tables.Contains(IMPROT_EXPORT_SHEET_NAME) &amp;&amp; ds.Tables[IMPROT_EXPORT_SHEET_NAME].Columns.Contains(ImportItems.ITEM_TYPE_COL_NAME))
                {
                    foreach (DataRow row in ds.Tables[IMPROT_EXPORT_SHEET_NAME].Rows)
                    {
                        if (!string.IsNullOrEmpty(row[ImportItems.ITEM_TYPE_COL_NAME].ToString2()))
                        {
                            row[ImportItems.ITEM_TYPE_COL_NAME] = ImportItems.GetLocalResourceName(row[ImportItems.ITEM_TYPE_COL_NAME].ToString2());
                        }
                    }
                }
            }

            if (ds != null &amp;&amp; ds != null &amp;&amp; ds.Tables.Contains(IMPROT_EXPORT_SHEET_NAME)
                &amp;&amp; importExportSchema != null &amp;&amp; importExportSchema.Tables.Contains(IMPROT_EXPORT_SHEET_NAME))
            {
                foreach (DataColumn c in ds.Tables[IMPROT_EXPORT_SHEET_NAME].Columns)
                {
                    if (importExportSchema.Tables[IMPROT_EXPORT_SHEET_NAME].Columns.Contains(c.ColumnName))
                    {
                        DataColumn col = importExportSchema.Tables[IMPROT_EXPORT_SHEET_NAME].Columns[c.ColumnName];
                        if (!string.IsNullOrEmpty(col.Caption) &amp;&amp; col.Caption != c.ColumnName)
                        {
                            string temp = string.Empty;
                            if (ds.Tables[IMPROT_EXPORT_SHEET_NAME].Columns.Contains(col.Caption))
                            {
                                int i = 0;
                                while (ds.Tables[IMPROT_EXPORT_SHEET_NAME].Columns.Contains(col.Caption + temp))
                                {
                                    i++;
                                    temp = &quot;(&quot; + i.ToString() + &quot;)&quot;;
                                }
                            }
                            c.ColumnName = col.Caption + temp;
                        }

                    }
                }
            }
        }


    

        protected virtual void GetExportListData(DataSet ds)
        {
            if (ds.Tables[0].Columns.Contains(ItemsDBColumns.IS_COMPLETE))
                ds.Tables[0].Columns.Remove(ItemsDBColumns.IS_COMPLETE);
            if (ds.Tables[0].Columns.Contains(ItemsDBColumns.IS_NON_CONTRACT))
                ds.Tables[0].Columns.Remove(ItemsDBColumns.IS_NON_CONTRACT);
            if (ds.Tables[0].Columns.Contains(ItemsDBColumns.ALT_CODE))
                ds.Tables[0].Columns.Remove(ItemsDBColumns.ALT_CODE);
            if (ds.Tables[0].Columns.Contains(ItemsDBColumns.FORCE_UNIT_PRICE))
                ds.Tables[0].Columns.Remove(ItemsDBColumns.FORCE_UNIT_PRICE);

            //if (ds.Tables[LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)].Columns.Contains(&quot;IsComplete&quot;))
            //    ds.Tables[LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)].Columns.Remove(&quot;IsComplete&quot;);
            //if (ds.Tables[LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)].Columns.Contains(&quot;IsNonContract&quot;))
            //    ds.Tables[LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)].Columns.Remove(&quot;IsNonContract&quot;);
            //if (ds.Tables[LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)].Columns.Contains(&quot;AltCode&quot;))
            //    ds.Tables[LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)].Columns.Remove(&quot;AltCode&quot;);
            //if (ds.Tables[LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)].Columns.Contains(&quot;IsMustBid&quot;))
            //    ds.Tables[LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)].Columns.Remove(&quot;IsMustBid&quot;);
        }

        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int currentPage,
            out int count)
        {
            count = 1;
            DataSet ds = ComponentHelper.Instance.ExecuteDataSet(StoredProcedure.usp_CORITEMGetItemDetails, null,
                ModuleId, parentID, null, null, filter, null,
                String.Empty, null, false, null, null, null);
            switch (ds.Tables.Count)
            {
                case 1:
                    break;
                default:
                    ds.Tables[0].TableName = &quot;Container&quot;;
                    ds.Tables[1].TableName = &quot;Items&quot;;
                    ds.Tables[2].TableName = &quot;ItemSummary&quot;;
                    ds.Tables[4].TableName = &quot;ActivityDates&quot;;
                    if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                    {
                        foreach (DataRow dr in ds.Tables[&quot;Items&quot;].Rows)
                        {
                            DataTable dtEISLookUp =
                                IntegrationConnectorManager.Instance.GetEISLookUpInfo(
                                    Convert.ToInt32(dr[&quot;UnitID&quot;], CultureInfo.CurrentCulture), RegisteredEIS.AX,
                                    EISObjectType.Unit);
                            if (dtEISLookUp.Rows.Count &gt; 0)
                                dr[&quot;Unit&quot;] = dtEISLookUp.Rows[0][&quot;ERPId&quot;].ToString();
                        }
                    }
                    break;
            }
            return ds;
        }

        private List&lt;string&gt; _ContainerCustomColumns = new List&lt;string&gt;();

        public virtual List&lt;string&gt; ContainerCustomColumns
        {
           get
            {
                return _ContainerCustomColumns;
            }
        }

        public virtual HierarchicalGridColumns HGridColumns()
        {
            List&lt;string&gt; components = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
            // get the current user id and then get the custom values for the HGrid and the current context
            // if it is not null then apply that to to object being returned else return the default object
            var ud = (UserDetail)HttpContext.Current.Session[&quot;UserDetail&quot;];
            string customSettings = CoreDatabaseHelper.GetControlSettings(ud.UID, &quot;HGrid_&quot; + Request[&quot;Context&quot;]);
            var tempHGridColumns = new HierarchicalGridColumns();
            bool IsSaved = false;
            var dic = new Dictionary&lt;string, int&gt;();

            DataSet unitDS = ComponentHelper.Instance.ExecuteDataSet(&quot;select UnitId,Unit from PROJECTMeasurementUnits&quot;);
            JavaScriptSerializer jsSerializer = new JavaScriptSerializer();
            List&lt;Dictionary&lt;string, object&gt;&gt; parentRow = new List&lt;Dictionary&lt;string, object&gt;&gt;();
            Dictionary&lt;string, object&gt; childRow;
            foreach (DataRow row in unitDS.Tables[0].Rows)
            {
                childRow = new Dictionary&lt;string, object&gt;();
                foreach (DataColumn col in unitDS.Tables[0].Columns)
                {
                    childRow.Add(col.ColumnName, row[col]);
                }
                parentRow.Add(childRow);
            }
            var hdnData = jsSerializer.Serialize(parentRow);

            if (!string.IsNullOrEmpty(customSettings))
            {
                string[] values = customSettings.Split(&quot;;&quot;.ToCharArray());
                string[] tempHolder;
                foreach (string str in values)
                {
                    tempHolder = str.Split(&quot;=&quot;.ToCharArray());
                    if (!dic.ContainsKey(tempHolder[0]))
                        dic.Add(tempHolder[0], Int32.Parse(tempHolder[1], CultureInfo.CurrentCulture));
                }
                IsSaved = true;
            }

            tempHGridColumns.TreeColumnWidth = (IsSaved &amp;&amp; dic.ContainsKey(&quot;TreeColumnWidth&quot;))
                ? dic[&quot;TreeColumnWidth&quot;]
                : 280;
            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;LineNo&quot;,
                (IsSaved &amp;&amp; dic.ContainsKey(&quot;LineNo&quot;)) ? dic[&quot;LineNo&quot;] : 120));

            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Description&quot;,
                (IsSaved &amp;&amp; dic.ContainsKey(&quot;Description&quot;))
                    ? dic[&quot;Description&quot;]
                    : 180, !components.Contains(&quot;DisabledStandardItemEdit&quot;), null, false,
                LocalizationManager.GetString(&quot;ItemDescription&quot;)));

            if (Request[&quot;context&quot;] == &quot;ESTMATE&quot;)
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;AlternateCode&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;AlternateCode&quot;))
                        ? dic[&quot;AlternateCode&quot;]
                        : 120, false, null, false, &quot;Alternate Group&quot;));

            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;GroupName&quot;,
                (IsSaved &amp;&amp; dic.ContainsKey(&quot;GroupName&quot;)) ? dic[&quot;GroupName&quot;] : 100, false, null, false,
                LocalizationManager.GetString(KeyConstants.Group), null));

            if (displayBudgetItemAssociatePicker &amp;&amp; ModuleManager.Instance.ModuleExists(Constants.MODID_BDGMGMT) &amp;&amp;
                    BudgetModuleComponent.Contains(&quot;LinkBudgetItem&quot;))
            {
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;LinkedBudgetItemName&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;LinkedBudgetItemName&quot;)) ? dic[&quot;LinkedBudgetItemName&quot;] : 100, false, null, false,
                    &quot;Budget Item&quot;, null));
            }

            // Show Accounting Code Only For Fargo
            if (components.Contains(&quot;ShowAccountingCode&quot;))
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;AccountingCode&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;AccountingCode&quot;)) ? dic[&quot;AccountingCode&quot;] : 60, false, null, false,
                    &quot;Accounting Code&quot;));
            //For MTO, its hidden
            if (!components.Contains(&quot;UnitQuantityModel&quot;))
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Unit&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;Unit&quot;)) ? dic[&quot;Unit&quot;] : 60, IsEditable: true, columnType: &quot;DropDownList&quot;, dataSource: hdnData));
            //For MTO, its hidden
            if (!components.Contains(&quot;UnitQuantityModel&quot;))
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Quantity&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;Quantity&quot;))
                        ? dic[&quot;Quantity&quot;]
                        : 100, true, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, true));

            if ((components.Contains(&quot;ItemMargin&quot;) &amp;&amp; components.Contains(&quot;ItemDiscount&quot;)))
                tempHGridColumns.Add(HierarchicalGridColumn.AddColumn(&quot;BaseUnitCost&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;BaseUnitCost&quot;))
                        ? dic[&quot;BaseUnitCost&quot;]
                        : 120, true,
                    LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL) + &quot;&quot; +
                    AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE, true, null));
            //For MTO, its hidden
            else if (!components.Contains(&quot;UnitQuantityModel&quot;))
                tempHGridColumns.Add(HierarchicalGridColumn.AddColumn(&quot;BaseUnitCost&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;BaseUnitCost&quot;))
                        ? dic[&quot;BaseUnitCost&quot;]
                        : 120, true, LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL) + &quot; &quot; +
                                     AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE, true, &quot;Unit Price&quot;));
            if (components.Contains(&quot;ItemUnitCost&quot;))
                tempHGridColumns.Add(HierarchicalGridColumn.AddColumn(&quot;UnitCost&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;UnitCost&quot;))
                        ? dic[&quot;UnitCost&quot;]
                        : 120, false, LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL) + &quot;&quot; +
                                      AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE, true));
            if (components.Contains(&quot;ItemUnitPrice&quot;))
                tempHGridColumns.Add(HierarchicalGridColumn.AddColumn(&quot;UnitPrice&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;UnitPrice&quot;))
                        ? dic[&quot;UnitPrice&quot;]
                        : 120, false, LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL) + &quot; &quot; +
                                      AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE, true));
            if (components.Contains(&quot;ItemNumber&quot;))
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Number&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;Number&quot;)) ? dic[&quot;Number&quot;] : 100,
                    false, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, true));
            if (components.Contains(&quot;ItemDimension1&quot;))
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Dimension1&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;Dimension1&quot;))
                        ? dic[&quot;Dimension1&quot;]
                        : 100, false, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, true,
                    AMP3ApplicationSettings.Instance.Dim1Title));
            if (components.Contains(&quot;ItemDimension2&quot;))
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Dimension2&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;Dimension2&quot;))
                        ? dic[&quot;Dimension2&quot;]
                        : 100, false, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, true,
                    AMP3ApplicationSettings.Instance.Dim2Title));
            if (components.Contains(&quot;ItemDimension3&quot;))
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Dimension3&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;Dimension3&quot;))
                        ? dic[&quot;Dimension3&quot;]
                        : 100, false, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, true,
                    AMP3ApplicationSettings.Instance.Dim3Title));

            string context = Request[&quot;Context&quot;];
            context = context.Equals(&quot;CHNGORD&quot;)
                ? &quot;CONTMGT&quot;
                : (context.Equals(&quot;BDGTREV&quot;) || context.Equals(&quot;CURBDGT&quot;) || context.Equals(&quot;BDGTESI&quot;)) ? &quot;BDGTEST&quot; : (context.Equals(&quot;ESTMADD&quot;) ? &quot;ESTMATE&quot; : context);

            List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_FNDMGMT);
            if (ModuleComponents != null &amp;&amp; ModuleComponents.Contains(&quot;FUND&quot; + context))
            {
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;RuleName&quot;,
                    (IsSaved &amp;&amp; dic.ContainsKey(&quot;RuleName&quot;))
                        ? dic[&quot;RuleName&quot;]
                        : 100, false, null, false, &quot;Fund Rule&quot;)); //&quot;Rule Name&quot;));
            }

            //Add Dynamic columns...
            AddDynamicColumns(tempHGridColumns, IsSaved, dic);
            return tempHGridColumns;
        }

        protected void AddDynamicColumns(HierarchicalGridColumns tempHGridColumns, bool IsSaved,
            Dictionary&lt;string, int&gt; dic, int columnBelongsTo = 2)
        {
            DataSet dsDynColumns = DynamicColumnsManager.Instance.GetDynamicColumns(Request[&quot;context&quot;],
                &quot;BrixItemListPage&quot;);
            if (dsDynColumns != null &amp;&amp; dsDynColumns.Tables.Count &gt; 0 &amp;&amp; dsDynColumns.Tables[0].Rows.Count &gt; 0)
            {
                foreach (DataRow dr in dsDynColumns.Tables[0].Rows)
                {
                    String ExpressionName = Convert.ToString(dr[&quot;ExpressionName&quot;]);
                    String ColumnName = Convert.ToString(dr[&quot;DisplayName&quot;]);
                    var tempCol = new HierarchicalGridColumn(ExpressionName,
                        (IsSaved &amp;&amp; dic.ContainsKey(ColumnName))
                            ? dic[ColumnName]
                            : 100, false, columnBelongsTo);
                    tempCol.Caption = ColumnName;
                    tempHGridColumns.Add(tempCol);
                }
            }
        }

        public Dictionary&lt;string, int&gt; GetGridColumnWidthDictionary(string context)
        {
            var ud = (UserDetail)HttpContext.Current.Session[&quot;UserDetail&quot;];
            string customSettings = CoreDatabaseHelper.GetControlSettings(ud.UID, &quot;HGrid_&quot; + context);

            var dic = new Dictionary&lt;string, int&gt;();

            if (!string.IsNullOrEmpty(customSettings))
            {
                string[] values = customSettings.Split(&quot;;&quot;.ToCharArray());
                string[] tempHolder;
                foreach (string str in values)
                {
                    tempHolder = str.Split(&quot;=&quot;.ToCharArray());
                    dic.Add(tempHolder[0], Int32.Parse(tempHolder[1], CultureInfo.CurrentCulture));
                }
            }

            return dic;
        }

        public virtual HierarchicalGridColumns HGridItemSummaryDetails()
        {
            var tempHGridColumns = new HierarchicalGridColumns();
            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Total Amount&quot;, 100,
                LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL) +
                //For showing Curreny Symbol like INR but not Rs
                &quot; &quot; + AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, false));

            List&lt;string&gt; components =
                ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_PROJECT);
            if (!components.Contains(&quot;TotalCostValue&quot;)) //Hide the Total Cost in Project Works
            {
                tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Total Cost&quot;, 100,
                    LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL) +
                    //For showing Curreny Symbol like INR but not Rs
                    &quot; &quot; + AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, false));
            }

            return tempHGridColumns;
        }

        public override void HandleNew()
        {
            HttpContext.Current.Server.Transfer(
                string.Format(CultureInfo.CurrentCulture, &quot;BrixItemPage.aspx?{0}&quot;, Request.QueryString), false);
        }

        public virtual void HandleNew(int id)
        {
            string queryString = string.Empty;
            if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                queryString = string.Format(CultureInfo.CurrentCulture, &quot;&amp;ProjectEstimateID={0}&quot;,
                    Request[&quot;ProjectEstimateID&quot;]);

            Response.Redirect(string.Format(CultureInfo.CurrentCulture,
                &quot;BrixItemPage.aspx?Context={0}&amp;ParentID={1}&amp;PID={2}&amp;ContainerID={3}{4}&amp;nt=1&quot;,
                ModuleId, parentID, Request[&quot;PID&quot;], id, queryString), false);
        }

        public override void HandleEdit()
        {
            throw new Exception(&quot;The method or operation is not implemented.&quot;);
        }

        public virtual void HandleEdit(ItemTypes type, int id)
        {
            string queryString = string.Empty;
            

            if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                queryString = string.Format(CultureInfo.CurrentCulture, &quot;&amp;ProjectEstimateID={0}&quot;, Request[&quot;ProjectEstimateID&quot;]);

            if (type == ItemTypes.Item)
                HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                    &quot;BrixItemPage.aspx?Context={0}&amp;ItemID={1}&amp;Mode={2}&amp;ParentID={3}&amp;PID={4}{5}&quot;,
                    ModuleId, id, Convert.ToInt32(ModeTypes.Edit, CultureInfo.CurrentCulture), parentID, Request[&quot;PID&quot;], queryString), false);
            else
                HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                    &quot;BrixItemContainer.aspx?Context={0}&amp;ContainerID={1}&amp;Mode={2}&amp;ParentID={3}&amp;PID={4}{5}&quot;,
                    ModuleId, id, Convert.ToInt32(ModeTypes.Edit, CultureInfo.CurrentCulture), parentID, Request[&quot;PID&quot;], queryString), false);
        }

        public virtual void HandleView(ItemTypes type, int id)
        {
            string queryString = string.Empty;
            if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                queryString = string.Format(CultureInfo.CurrentCulture, &quot;&amp;ProjectEstimateID={0}&quot;,
                    Request[&quot;ProjectEstimateID&quot;]);
            if (type == ItemTypes.Item)
                HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                    &quot;BrixItemPage.aspx?Context={0}&amp;ItemID={1}&amp;Mode={2}&amp;ParentID={3}&amp;PID={4}{5}&quot;,
                    ModuleId, id,
                    Convert.ToInt32(ModeTypes.View, CultureInfo.CurrentCulture), parentID,
                    Request[&quot;PID&quot;], queryString), false);
            else
                HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                    &quot;BrixItemContainer.aspx?Context={0}&amp;ContainerID={1}&amp;Mode={2}&amp;ParentID={3}&amp;PID={4}{5}&quot;,
                    ModuleId, id,
                    Convert.ToInt32(ModeTypes.View, CultureInfo.CurrentCulture), parentID,
                    Request[&quot;PID&quot;], queryString), false);
        }

        public virtual void HandleDelete(ItemTypes type, string ids)
        {
            if (type == ItemTypes.Item)
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(StoredProcedure.usp_CORITEMDeleteItems,
                    null, ids, null);
            else
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    StoredProcedure.usp_CORITEMDeleteContainer, null, ids);
        }

        public virtual void HandleAssociate(string containerids, string ids, int? bdgtItem)
        {
            var dic = new Dictionary&lt;string, object&gt;();
            dic[&quot;Output&quot;] = null;
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(StoredProcedure.usp_CORITEMAssociateItems,
                    dic, containerids, ids, null, bdgtItem);
            string result = dic[&quot;Output&quot;].ToString2();
            if (result != &quot;&quot;)
                throw new Exception(result);

        }

        public virtual void HandleAddMultiple(int id)
        {
            HttpContext.Current.Server.Transfer(
                string.Format(CultureInfo.CurrentCulture,
                    &quot;~/Common/AddStandardItems.aspx?Context={0}&amp;PID={1}&amp;ParentID={2}&amp;ContainerID={3}&quot;,
                    Request[&quot;context&quot;], Request[&quot;PID&quot;], Request[&quot;ParentID&quot;], id), false);
        }

        public virtual void HandleNewContainer(int id)
        {
            HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                &quot;BrixItemContainer.aspx?Context={0}&amp;Mode={1}&amp;ParentID={2}&amp;PID={3}&amp;ContainerID={4}&quot;,
                ModuleId, ModeTypes.New.ToInt32_2(), parentID, Request[&quot;PID&quot;],
                (id == 0 ? -1 : id)), false);
        }

        public virtual string GetRedirectUrlForSubItemControl(int itemId, string referenceItemType)
        {
            string redirectUrl =
                &quot;~/Common/BrixItemPage.aspx?Context={0}&amp;ItemID={1}&amp;ParentID={2}&amp;PID={3}&amp;DisplayType=SI&amp;Mode={4}&quot;.Format2
                    (ModuleId, itemId, ParentID, Request[&quot;PID&quot;], (int)ModeTypes.Edit);
            if (!string.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                redirectUrl = &quot;{0}&amp;ContractID={1}&quot;.Format2(redirectUrl, Request[&quot;ContractID&quot;]);
            if (referenceItemType.Equals(&quot;M&quot;)
                &amp;&amp; (ModuleId.Equals(&quot;CHNGORD&quot;) || ModuleId.Equals(&quot;BDGTREVs&quot;)))
            {
                redirectUrl = &quot;{0}&amp;COType=M&quot;.Format2(redirectUrl);
            }

            if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                redirectUrl = &quot;{0}&amp;ProjectEstimateID={1}&quot;.Format2(redirectUrl, Request[&quot;ProjectEstimateID&quot;]);
            return (HttpContext.Current.Handler as Page).ResolveUrl(redirectUrl);
        }

        public virtual string GetRedirectUrlForRateAnalysisControl(int itemId, string referenceItemType)
        {
            string redirectUrl =
                &quot;~/Common/BrixItemPage.aspx?Context={0}&amp;ItemID={1}&amp;ParentID={2}&amp;PID={3}&amp;DisplayType=RA&amp;Mode={4}&quot;.Format2
                    (ModuleId, itemId, ParentID, Request[&quot;PID&quot;], (int)ModeTypes.Edit);
            if (!string.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                redirectUrl = &quot;{0}&amp;ContractID={1}&quot;.Format2(redirectUrl, Request[&quot;ContractID&quot;]);
            if (referenceItemType.Equals(&quot;M&quot;)
                &amp;&amp; (ModuleId.Equals(&quot;CHNGORD&quot;) || ModuleId.Equals(&quot;BDGTREV&quot;)))
            {
                redirectUrl = &quot;{0}&amp;COType=M&quot;.Format2(redirectUrl);
            }

            if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                redirectUrl = &quot;{0}&amp;ProjectEstimateID={1}&quot;.Format2(redirectUrl, Request[&quot;ProjectEstimateID&quot;]);
            return redirectUrl;
        }

        public virtual void HandleMenuItems(string eventString, UltraWebGridExcelExporter expGrid, string ids)
        {
            string retVal = HandleMenuItem(eventString);
            if (!IsMenuClickHandled)
            {
                if (eventString == &quot;Excel Export (xls)&quot; || eventString == &quot;Excel Export (xlsx)&quot;)
                {
                    ExportExcel(eventString, expGrid);
                }
                else if (eventString == ExcelHelper.EXCEL_TEMPLATE_WITH_DATA || eventString == ExcelHelper.EXCEL_TEMPLATE_WITH_DATA_XLSX)
                {
                    ExportExcel(eventString, expGrid, true);
                }
                else if (eventString == ExcelHelper.EXCEL_TEMPLATE || eventString == ExcelHelper.EXCEL_TEMPLATE_XLSX)
                {
                    ExportExcelTemplate(eventString, expGrid);
                }
                else if (eventString.Equals(&quot;New &quot; + LocalizationManager.GetString(&quot;Container&quot;)))
                {
                    if (ids == String.Empty)
                        ids = &quot;0&quot;;
                    HandleNewContainer(ids.ToInt32_2());
                }
                else if (eventString.Equals(&quot;Add CO &quot; + GlobalizationUtility.SetResource(&quot;Item&quot;, false)))
                {
                    HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                        &quot;BrixItemPage.aspx?Context={0}&amp;ParentID={1}&amp;PID={2}&amp;ContractID={3}&amp;ContainerID={4}&amp;COType={5}&quot;,
                        ModuleId, parentID, Request[&quot;PID&quot;], Request[&quot;ContractID&quot;], ids, &quot;N&quot;), false);
                }
                else if (eventString.Equals(&quot;Add Existing Item&quot;))
                {
                    string queryString = string.Empty;
                    if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                        queryString = string.Format(CultureInfo.CurrentCulture, &quot;&amp;ProjectEstimateID={0}&quot;,
                            Request[&quot;ProjectEstimateID&quot;]);
                    if (ids == string.Empty)
                        ids = &quot;0&quot;;
                    HttpContext.Current.Server.Transfer(
                        string.Format(CultureInfo.CurrentCulture,
                            &quot;~/Common/BrixItemPage.aspx?Context={0}&amp;PID={1}&amp;ParentID={2}&amp;AddExistingItem={3}{4}&amp;ContainerID={5}&quot;,
                            &quot;ESTMADD&quot;, Request[&quot;PID&quot;], Request[&quot;ParentID&quot;], &quot;Y&quot;, queryString, ids), false);
                }
                else if (eventString.Equals(&quot;Add Multiple&quot;))
                {
                    if (ids == String.Empty)
                        ids = &quot;0&quot;;
                    else if (ids.Split(&#39;,&#39;).Length &gt; 1)
                    {
                        throw new Exception(&quot;Please select single container.&quot;);
                    }
                    HandleAddMultiple(ids.ToInt32_2());
                }
                else if (eventString.Equals(ItemNameAbbr + &quot; List Report&quot;))
                {
                    SetHierarchicalGridState();
                    HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                        &quot;~/Common/BrixReportPage.aspx?Context=ITMLIST&amp;Code={0}&amp;ParentID={1}&amp;PID={2}&amp;MODID=ITMLIST&amp;ParentModuleID={3}&quot;,
                        ModuleId, ParentID, Request[&quot;PID&quot;], ModuleId), false);
                    ;
                }
                else if (eventString.ToLower2().Equals(&quot;reorder&quot;))
                {
                    string queryString = string.Empty;
                    if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                        queryString = string.Format(CultureInfo.CurrentCulture, &quot;&amp;ProjectEstimateID={0}&quot;,
                            Request[&quot;ProjectEstimateID&quot;]);
                    HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                        &quot;BrixItemContainer.aspx?Context={0}&amp;ParentID={1}&amp;IsSc=1&amp;PID={2}{3}&quot;,
                        ModuleId, parentID, Request[&quot;PID&quot;], queryString), false);
                }
                else if (eventString.ToUpper() == &quot;Refresh Line Number&quot;.ToUpper())
                {
                    ItemManager.Instance.RefreshLineNumbers(ModuleId, ParentID);
                    EnableSave = false;
                    isMenuClickHandled = true;
                }
            }
            else
            {
                if (!String.IsNullOrEmpty(retVal))
                    throw new Exception(retVal);
            }
           
        }

        private void CreateItemDTOFromHttpRequest()
        {
            DataSet ds =
                ItemManager.Instance.GetWPforBudgetItems(
                    Int32.Parse(Request.QueryString[&quot;PID&quot;], CultureInfo.CurrentCulture),
                    Int32.Parse(Request.QueryString[&quot;ParentID&quot;], CultureInfo.CurrentCulture));
            string context = Request[&quot;Context&quot;].Trim();
            var DTO = new Item();

            if (ds.Tables.Count &gt; 1 &amp;&amp; ds.Tables[0].Rows.Count &gt; 0 &amp;&amp; ds.Tables[1].Rows.Count &gt; 0)
            {
                for (int i = 0; i &lt; ds.Tables[0].Rows.Count; i++)
                {
                    DTO.ItemID = null;
                    //DTO.AccountingCode = null;
                    DTO.Description = Convert.ToString(ds.Tables[0].Rows[i][&quot;Description&quot;]);
                    DTO.StandardItemNo = Convert.ToString(ds.Tables[0].Rows[i][&quot;Name&quot;]);
                    DTO.Notes = Convert.ToString(ds.Tables[0].Rows[i][&quot;Comment&quot;]);
                    DTO.UnitCost = Convert.ToDecimal(ds.Tables[0].Rows[i][&quot;EstimatedCost&quot;]);
                    DTO.UnitPrice = Convert.ToDecimal(ds.Tables[0].Rows[i][&quot;EstimatedCost&quot;]);
                    DTO.CreatedBy = UserDetail.GetCurrentUserDetail().UID;
                    DTO.BaseUnitCost = Convert.ToDecimal(ds.Tables[0].Rows[i][&quot;EstimatedCost&quot;]);
                    DTO.Quantity = 1;

                    DTO.ParentInstanceID = Int32.Parse(Request.QueryString[&quot;ParentID&quot;], CultureInfo.CurrentCulture);
                    DTO.ModuleID = context;
                    DTO.Notes = Convert.ToString(ds.Tables[0].Rows[i][&quot;Comment&quot;]);
                    DTO.UnitID = Convert.ToInt32(ds.Tables[1].Rows[0][&quot;UnitId&quot;]);
                    DTO.ActivityCount = 0;
                    // DTO.AlternateID = null;
                    //DTO.ContainerID = 1;
                    DTO.Unit = &quot;LS&quot;;
                    // DTO.AccountingCode = &quot;&quot;;
                    // start To do
                    //if (hdnReferenceItemID.Value.Length &gt; 0)
                    //    DTO.ReferenceItemID = Convert.ToInt32(hdnReferenceItemID.Value, CultureInfo.CurrentCulture);

                    DTO.ContainerID = Convert.ToInt32(ds.Tables[2].Rows[0][&quot;ContainerID&quot;]);
                    DTO.GroupID = Convert.ToInt32(ds.Tables[4].Rows[0][&quot;GroupID&quot;]);
                    DTO.GroupName = Convert.ToString(ds.Tables[4].Rows[0][&quot;GroupName&quot;]);
                    DTO.Margin = 0;
                    DTO.Discount = 0;
                    DTO.OverheadCost = 0;
                    //End To do
                    Item ObjItemDetails = DTO;
                    ItemManager.Instance.SaveItemDetails(ObjItemDetails);
                }
            }
        }

        protected void SetHierarchicalGridState()
        {
            HierarchicalGridState hGridState;
            if (((Page)HttpContext.Current.Handler).Session[&quot;HGridState_&quot; + Request[&quot;Context&quot;]] != null)
                hGridState =
                    (HierarchicalGridState)
                        ((Page)HttpContext.Current.Handler).Session[&quot;HGridState_&quot; + Request[&quot;Context&quot;]];
            // GET THE SAME SESSION VARIABLE
            else
                hGridState = new HierarchicalGridState();


            hGridState.ExpandedContianers = hGrid.expandedContainers;
            hGridState.ExpandedItems = hGrid.expandedItems;
            hGridState.ExpandedSubItems = hGrid.expandedSubItems;

            if (((Page)HttpContext.Current.Handler).Session[&quot;HGridState_&quot; + Request[&quot;Context&quot;]] == null)
                // IF IT DOESN&#39;T EXIST IN THE SESSION ASSIGN IT.
                ((Page)HttpContext.Current.Handler).Session[&quot;HGridState_&quot; + Request[&quot;Context&quot;]] = hGridState;
        }

        private void ExportExcelTemplate(string eventString, UltraWebGridExcelExporter expGrid)
        {
            DataSet ds = GetSchema();
            ds.Tables[0].TableName = IMPROT_EXPORT_SHEET_NAME;
            DataTable moduleDetials = Aurigo.AMP3.ModuleManagementDAC.ModuleManagementComponent.Instance.GetModule(Request.QueryString[&quot;Context&quot;]);
            string fileName = (Request.QueryString[&quot;Context&quot;] == &quot;ESTMATE&quot;) ? &quot;Bid Estimate &quot; + ItemNameAbbr + &quot;s&quot; : ((moduleDetials.Rows.Count != 0) ? moduleDetials.Rows[0][&quot;ModuleName&quot;].ToString2() + &quot; &quot; + ItemNameAbbr + &quot;s&quot; : Request.QueryString[&quot;Context&quot;] + parentID + &quot;_&quot; + ItemNameAbbr + &quot;s&quot;);
            ds.DataSetName = fileName;  //ItemNameAbbr;
            LocalizeExportData(ds, GetSchema(), false);
            ExcelExportEntity excelExportEntity = new ExcelExportEntity(ds);
            FormatExcel(eventString, ref excelExportEntity, ds);
            ExcelHelper.ExportToExcel(eventString, excelExportEntity, 0, ImportItems.RESOURCE_TYPE_COL_NAME, ImportItems.ItemTypes.ToArray(), ExportFileDownloadTokenID, ExportFileDownloadTokenValue);
        }

        private void ExportExcel(string eventString, UltraWebGridExcelExporter expGrid, bool isTemplateWithData = false)
        {
            DataSet dataset = (DataSet)GetExportList(&quot;Excel&quot;);

            if (!isTemplateWithData &amp;&amp; dataset.Tables[0].Columns.Contains(ImportItems.INTERNAL_ID_COl_NAME))
            {
                dataset.Tables[0].Columns.Remove(ImportItems.INTERNAL_ID_COl_NAME);
            }

            DataTable moduleDetials = Aurigo.AMP3.ModuleManagementDAC.ModuleManagementComponent.Instance.GetModule(Request.QueryString[&quot;Context&quot;]);
            string fileName = (Request.QueryString[&quot;Context&quot;] == &quot;ESTMATE&quot;) ? &quot;Bid Estimate &quot; + ItemNameAbbr + &quot;s&quot; : ((moduleDetials.Rows.Count != 0) ? moduleDetials.Rows[0][&quot;ModuleName&quot;].ToString2() + &quot; &quot; + ItemNameAbbr + &quot;s&quot; : Request.QueryString[&quot;Context&quot;] + parentID + &quot;_&quot; + ItemNameAbbr + &quot;s&quot;);
            dataset.DataSetName = fileName;
            ExcelExportEntity excelExportEntity = new ExcelExportEntity(dataset);
            FormatExcel(eventString, ref excelExportEntity, dataset);
            ExcelHelper.ExportToExcel(eventString, excelExportEntity, 0, ImportItems.RESOURCE_TYPE_COL_NAME, ImportItems.ItemTypes.ToArray(), ExportFileDownloadTokenID, ExportFileDownloadTokenValue);
        }

        private void FormatExcel(string eventString, ref ExcelExportEntity excelExportEntity, DataSet ds)
        {
            IWorkbook workbook = ExcelHelper.CreateWorkBook(eventString);
            ICellStyle style = workbook.CreateCellStyle();
            IDataFormat format = workbook.CreateDataFormat();
            excelExportEntity.ColumnStyleByTableNameAndSheetName =
                new Dictionary&lt;string, Dictionary&lt;string, ICellStyle&gt;&gt;();
            Dictionary&lt;string, ICellStyle&gt; columnStyleByColumnName = new Dictionary&lt;string, ICellStyle&gt;();
            style.DataFormat = format.GetFormat(AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE);
            columnStyleByColumnName.Add(&quot;Unit Cost&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY);
            columnStyleByColumnName.Add(&quot;Quantity&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
            columnStyleByColumnName.Add(&quot;Rate Per Unit&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(&quot;###,###,##0.00&quot;);
            columnStyleByColumnName.Add(&quot;Number&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(&quot;###,###,##0.00&quot;);
            columnStyleByColumnName.Add(&quot;Dimension 1&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(&quot;###,###,##0.00&quot;);
            columnStyleByColumnName.Add(&quot;Dimension 2&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(&quot;###,###,##0.00&quot;);
            columnStyleByColumnName.Add(&quot;Dimension 3&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE);
            columnStyleByColumnName.Add(&quot;Base Cost&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE);
            columnStyleByColumnName.Add(&quot;Discount&quot;, style);

            style = workbook.CreateCellStyle();
            style.DataFormat = format.GetFormat(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE);
            columnStyleByColumnName.Add(&quot;Margin&quot;, style);

            foreach (DataTable dt in ds.Tables)
            {
                excelExportEntity.ColumnStyleByTableNameAndSheetName.Add(dt.TableName, columnStyleByColumnName);
            }
        }

        protected void ExportGridData(DataTable dt, string sheetName, Workbook book, UltraWebGrid grdTemp,
            UltraWebGridExcelExporter expGrid)
        {
            grdTemp.Rows.Clear();
            grdTemp.Columns.Clear();
            if (dt != null)
            {
                if (dt.Rows.Count == 0)
                {
                    dt.Rows.Add(dt.NewRow());
                }
                grdTemp.DataSource = dt;
                grdTemp.DataBind();
                if (dt.Columns.Contains(&quot;Unit Cost&quot;))
                    grdTemp.Columns.FromKey(&quot;Unit Cost&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                if (dt.Columns.Contains(&quot;Quantity&quot;))
                    grdTemp.Columns.FromKey(&quot;Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                if (dt.Columns.Contains(&quot;Rate Per Unit&quot;))
                    grdTemp.Columns.FromKey(&quot;Rate Per Unit&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                if (dt.Columns.Contains(&quot;Number&quot;))
                    grdTemp.Columns.FromKey(&quot;Number&quot;).Format = &quot;###,###,##0.00&quot;;
                if (dt.Columns.Contains(&quot;Number&quot;))
                    grdTemp.Columns.FromKey(&quot;Number&quot;).Format = &quot;###,###,##0.00&quot;;
                if (dt.Columns.Contains(&quot;Dimension 1&quot;))
                    grdTemp.Columns.FromKey(&quot;Dimension 1&quot;).Format = &quot;###,###,##0.00&quot;;
                if (dt.Columns.Contains(&quot;Dimension 2&quot;))
                    grdTemp.Columns.FromKey(&quot;Dimension 2&quot;).Format = &quot;###,###,##0.00&quot;;
                if (dt.Columns.Contains(&quot;Dimension 3&quot;))
                    grdTemp.Columns.FromKey(&quot;Dimension 3&quot;).Format = &quot;###,###,##0.00&quot;;
                if (dt.Columns.Contains(&quot;Base Cost&quot;))
                    grdTemp.Columns.FromKey(&quot;Base Cost&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                if (dt.Columns.Contains(&quot;Discount&quot;))
                    grdTemp.Columns.FromKey(&quot;Discount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE;
                if (dt.Columns.Contains(&quot;Margin&quot;))
                    grdTemp.Columns.FromKey(&quot;Margin&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE;
            }
            book.Worksheets.Add(sheetName);
            expGrid.Export(grdTemp, book.Worksheets[sheetName]);

            //TO MAKE CELL FORMAT OF SIZE , COLOR AND CONFIGURATION TO &#39;TEXT&#39;
            int SizeIndex, ColorIndex, ConfigurationIndex;
            SizeIndex = grdTemp.Columns.FromKey(&quot;Size&quot;) != null ? grdTemp.Columns.FromKey(&quot;Size&quot;).Index : -1;
            ColorIndex = grdTemp.Columns.FromKey(&quot;Color&quot;) != null ? grdTemp.Columns.FromKey(&quot;Color&quot;).Index : -1;
            ConfigurationIndex = grdTemp.Columns.FromKey(&quot;Configuration&quot;) != null
                ? grdTemp.Columns.FromKey(&quot;Configuration&quot;).Index
                : -1;
            if (sheetName.Equals(&quot;Materials&quot;))
            {
                if (SizeIndex &gt; 0)
                    book.Worksheets[sheetName].Columns[SizeIndex].CellFormat.FormatString = &quot;@&quot;;
                if (ColorIndex &gt; 0)
                    book.Worksheets[sheetName].Columns[ColorIndex].CellFormat.FormatString = &quot;@&quot;;
                if (ConfigurationIndex &gt; 0)
                    book.Worksheets[sheetName].Columns[ConfigurationIndex].CellFormat.FormatString = &quot;@&quot;;
            }
        }

        public virtual int UpdateItems(string xmlArgument)
        {
            return
                int.Parse(
                    ComponentHelper.Instance.ExecuteScalar(StoredProcedure.usp_CORITEMUpdateItems, null, xmlArgument).
                        ToString2(), CultureInfo.CurrentCulture);
        }

        public override void HandleView()
        {
            throw new Exception(&quot;The method or operation is not implemented.&quot;);
        }

        public virtual void SetUIDetails(ItemListModel itemListModel)
        {
            CreateDateColumn = &quot;CreatedOn&quot;;
            InstanceIDColumn = &quot;ParentInstanceID&quot;;
            DisableSave = true;
        }

        public virtual void GetEISData(RegisteredEIS registeredEIS)
        {
        }

        public override string SetSessionValuesforReport()
        {
            string pdfA = HttpContext.Current.Session[&quot;expandedContainers&quot;].ToString();
            string pdfB = HttpContext.Current.Session[&quot;expandAll&quot;] != null
                ? HttpContext.Current.Session[&quot;expandAll&quot;].ToString()
                : &quot;&quot;;
            return Request.Url.AbsoluteUri.Replace(&quot;Page.aspx&quot;, &quot;ReportPage.aspx&quot;) + &quot;&amp;pdfA=&quot; + pdfA + &quot;&amp;pdfB=&quot; + pdfB;
        }

        public override void OnInit()
        {
            base.OnInit();
        }

        public virtual void AfterSave(ItemListModel itemListModel)
        {
        }

        #endregion

        public virtual void CustomUnlock(ToolBar MainToolBar)
        {
        }

        public virtual void CustomDisplay(ToolBar MainToolBar)
        {
        }

        #region Abstract Methods

        public abstract string SkinID { get; }
        public abstract DataSet GetSchema();

        #endregion

        public virtual void CustomizeItemPickerColumns(
            ref List&lt;Brix.Platform.BusinessLayer.UserControls.PickerColumnDetails&gt; lst)
        {
        }
    }

    public enum ItemTypes
    {
        Item,
        Container
    };

    public enum ModifyingExisting
    {
        None,
        Edit,
        Cancel
    };
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[36,9,36,89,1],[51,9,51,10,1],[52,13,52,40,1],[53,13,53,14,1],[54,17,54,53,1],[55,17,55,61,1],[56,13,56,14,1],[57,13,57,43,1],[58,13,58,14,1],[59,17,59,88,1],[60,13,60,14,1],[61,9,61,10,1],[64,9,64,10,0],[65,13,65,59,0],[66,9,66,10,0],[69,9,69,10,1],[70,13,77,100,1],[78,13,78,14,1],[79,17,79,89,1],[82,13,82,14,1],[83,17,83,120,1],[85,9,85,10,1],[93,13,93,14,0],[94,17,96,28,0],[97,13,97,14,0],[103,13,103,14,1],[104,17,104,29,1],[105,13,105,14,1],[110,17,110,18,0],[110,19,110,34,0],[110,35,110,36,0],[115,9,115,51,1],[116,9,116,50,1],[117,9,117,51,1],[118,9,118,47,1],[119,9,119,58,1],[121,9,121,65,1],[123,9,123,60,1],[127,13,127,14,1],[128,17,128,52,1],[129,21,129,115,1],[130,17,130,47,1],[131,13,131,14,1],[135,17,135,18,1],[135,19,135,35,1],[135,36,135,37,1],[141,13,141,14,1],[142,17,143,28,1],[144,17,144,110,1],[145,17,145,28,1],[146,13,146,14,1],[151,17,151,18,1],[151,19,151,59,1],[151,60,151,61,1],[152,17,152,18,0],[152,19,152,60,0],[152,61,152,62,0],[157,17,157,18,1],[157,19,157,45,1],[157,46,157,47,1],[162,17,162,18,1],[162,19,162,46,1],[162,47,162,48,1],[167,17,167,18,1],[167,19,167,46,1],[167,47,167,48,1],[170,39,170,43,0],[170,44,170,48,1],[171,44,171,48,0],[171,49,171,53,1],[172,42,172,46,0],[172,47,172,51,1],[174,45,174,49,0],[174,50,174,54,1],[175,48,175,52,0],[175,53,175,57,1],[176,50,176,54,0],[176,55,176,59,1],[178,38,178,42,1],[178,43,178,47,1],[180,9,180,45,1],[184,17,184,18,0],[184,19,184,39,0],[184,40,184,41,0],[185,17,185,18,1],[185,19,185,40,1],[185,41,185,42,1],[188,44,188,48,1],[188,49,188,53,0],[190,53,190,57,1],[190,58,190,62,0],[192,41,192,45,1],[192,46,192,50,1],[194,9,194,43,1],[198,17,198,18,1],[198,19,198,38,1],[198,39,198,40,1],[199,17,199,18,1],[199,19,199,39,1],[199,40,199,41,1],[202,9,202,42,1],[206,17,206,18,1],[206,19,206,37,1],[206,38,206,39,1],[207,17,207,18,1],[207,19,207,38,1],[207,39,207,40,1],[214,38,214,42,1],[214,43,214,47,0],[219,13,219,14,1],[220,17,220,62,1],[221,17,221,64,1],[221,64,221,89,1],[221,89,221,91,1],[221,17,221,91,1],[222,17,222,42,1],[223,21,223,65,1],[224,17,224,62,1],[224,62,224,86,1],[224,86,224,88,1],[224,17,224,88,1],[225,17,225,40,1],[226,21,226,62,0],[228,17,228,95,1],[229,17,229,18,1],[231,21,231,87,1],[231,87,231,103,1],[231,103,231,105,1],[231,21,231,105,1],[232,21,232,43,1],[233,25,233,62,1],[235,21,235,119,1],[236,21,236,123,1],[237,21,237,44,1],[238,25,239,64,1],[240,21,240,45,1],[241,25,243,64,1],[244,21,244,54,1],[245,17,245,18,1],[247,22,247,61,1],[248,17,248,18,1],[249,21,249,87,1],[249,87,249,106,1],[249,106,249,108,1],[249,21,249,108,1],[250,21,250,43,1],[251,25,252,64,0],[253,17,253,18,1],[254,22,254,46,1],[255,21,256,60,0],[258,17,258,33,1],[259,17,259,18,1],[260,21,261,61,1],[262,17,262,18,1],[264,17,264,55,1],[265,17,265,18,1],[266,21,266,55,1],[267,25,267,57,0],[268,17,268,18,1],[270,17,270,18,1],[271,21,271,54,1],[272,25,272,60,0],[273,17,273,18,1],[275,17,275,34,1],[276,21,277,60,1],[281,17,281,115,1],[283,17,283,116,1],[284,17,284,36,1],[285,21,286,60,1],[287,17,288,55,1],[289,17,289,122,1],[290,21,291,60,1],[292,17,292,86,1],[293,21,294,60,0],[295,17,295,42,1],[296,21,297,84,1],[298,17,299,62,1],[300,21,301,60,1],[302,17,302,42,1],[303,21,304,60,0],[305,17,305,41,1],[306,21,307,60,0],[308,17,308,40,1],[309,21,310,60,0],[311,17,311,41,1],[312,21,313,60,0],[315,17,316,70,1],[317,17,317,18,1],[318,21,318,120,1],[320,21,321,57,1],[322,21,322,66,1],[324,21,325,57,1],[326,21,326,66,1],[328,21,328,59,1],[329,25,329,60,1],[331,17,331,18,1],[347,17,347,48,1],[348,21,348,49,1],[349,17,349,78,1],[350,21,350,98,1],[352,17,352,53,1],[353,17,353,18,1],[354,21,354,53,1],[355,25,355,55,0],[356,17,356,18,1],[358,17,358,18,0],[359,21,359,52,0],[360,25,360,52,0],[361,17,361,18,0],[365,17,365,35,1],[366,13,366,14,1],[369,45,369,49,1],[369,50,369,54,1],[371,42,371,46,0],[371,47,371,51,0],[378,9,378,10,1],[379,13,379,46,1],[380,13,380,43,1],[381,13,381,51,1],[382,13,382,46,1],[383,13,383,48,1],[384,13,384,46,1],[385,13,385,51,1],[387,13,387,49,1],[388,13,388,46,1],[389,13,389,48,1],[390,13,390,52,1],[391,13,391,50,1],[392,9,392,10,1],[395,9,395,10,1],[396,13,396,49,1],[397,13,397,65,1],[398,13,398,76,1],[399,9,399,10,1],[403,9,403,10,1],[404,13,405,55,1],[406,13,406,14,0],[407,17,407,29,0],[410,13,410,97,1],[411,13,411,61,1],[413,13,413,33,1],[414,13,414,14,1],[415,17,415,75,1],[416,13,416,14,1],[417,13,417,41,1],[418,13,418,43,1],[419,13,419,77,1],[420,13,420,86,1],[421,13,421,58,1],[422,13,422,39,1],[423,13,423,38,1],[425,13,425,30,1],[426,9,426,10,1],[430,9,430,10,0],[431,13,432,55,0],[433,13,433,14,0],[434,17,434,29,0],[437,13,437,97,0],[438,13,438,61,0],[440,13,440,51,0],[442,13,442,41,0],[443,13,443,43,0],[444,13,444,77,0],[445,13,445,86,0],[446,13,446,58,0],[447,13,447,39,0],[448,13,448,38,0],[450,13,450,30,0],[451,9,451,10,0],[454,9,454,10,1],[455,13,455,25,1],[456,13,456,152,1],[458,13,458,31,1],[458,32,458,71,1],[459,13,459,23,1],[460,9,460,10,1],[463,9,463,10,1],[464,13,464,51,1],[466,13,468,27,1],[469,9,469,10,1],[472,9,472,10,0],[473,13,473,25,0],[474,13,475,48,0],[477,13,477,31,0],[477,32,477,71,0],[478,13,478,23,0],[479,9,479,10,0],[482,9,482,10,0],[483,13,486,44,0],[487,9,487,10,0],[490,9,490,10,1],[491,13,491,170,1],[492,9,492,10,1],[495,9,495,10,1],[496,13,499,39,1],[500,9,500,10,1],[503,9,503,10,1],[504,13,504,166,1],[505,9,505,10,1],[508,9,508,10,0],[509,9,509,10,0],[512,9,512,10,1],[513,9,513,10,1],[516,9,516,10,1],[517,13,517,86,1],[518,9,518,10,1],[525,9,525,10,1],[526,13,526,51,1],[527,13,527,14,1],[528,17,528,49,1],[529,17,529,45,1],[530,17,533,55,1],[534,17,534,18,1],[535,21,535,56,1],[536,21,536,64,1],[537,21,537,43,1],[538,21,538,48,1],[539,17,539,18,1],[540,13,540,14,1],[541,9,541,10,1],[544,9,544,10,1],[545,13,545,55,1],[546,13,546,45,1],[550,13,550,35,1],[552,13,552,29,1],[553,13,553,14,1],[554,17,554,163,1],[555,17,555,24,1],[555,26,555,37,1],[555,38,555,40,1],[555,41,555,45,1],[556,17,556,18,1],[557,21,557,45,1],[558,21,558,103,1],[559,17,559,18,1],[561,17,561,190,1],[562,17,562,24,1],[562,26,562,37,1],[562,38,562,40,1],[562,41,562,45,1],[563,17,563,18,1],[564,21,564,45,1],[565,21,565,102,1],[566,17,566,18,1],[567,13,567,14,1],[569,13,569,14,1],[570,17,570,189,1],[571,17,571,24,1],[571,26,571,37,0],[571,38,571,40,1],[571,41,571,45,1],[572,17,572,18,0],[573,21,573,45,0],[574,17,574,18,0],[576,17,579,94,1],[580,17,580,24,1],[580,26,580,37,0],[580,38,580,40,1],[580,41,580,45,1],[581,17,581,18,0],[582,21,582,45,0],[583,17,583,18,0],[584,13,584,14,1],[585,9,585,10,1],[587,9,587,55,1],[591,13,591,14,1],[592,17,592,48,1],[593,21,593,150,1],[595,17,595,43,1],[596,13,596,14,1],[600,9,600,10,0],[601,13,601,81,0],[602,13,603,64,0],[605,13,605,32,0],[607,13,607,47,0],[609,13,609,109,0],[610,13,610,86,0],[611,13,611,14,0],[612,17,612,109,0],[614,17,614,56,0],[615,21,615,65,0],[616,25,616,63,0],[617,17,617,58,0],[618,21,618,67,0],[619,25,619,65,0],[621,17,621,67,0],[623,17,623,59,0],[624,21,624,101,0],[625,17,625,69,0],[626,21,626,123,0],[627,17,627,71,0],[628,21,629,84,0],[630,17,630,64,0],[631,21,632,84,0],[633,17,633,62,0],[634,21,634,78,0],[636,17,636,70,0],[637,21,637,68,0],[639,17,639,59,0],[640,21,640,57,0],[642,17,642,60,0],[643,21,643,58,0],[645,17,645,68,0],[646,21,646,66,0],[669,17,669,54,0],[670,17,670,32,0],[671,17,671,18,0],[672,26,672,35,0],[672,37,672,68,0],[672,70,672,73,0],[673,21,673,22,0],[675,25,675,72,0],[676,25,676,32,0],[676,34,676,46,0],[676,47,676,49,0],[676,50,676,70,0],[677,25,677,26,0],[678,29,678,90,0],[679,33,679,64,0],[680,25,680,26,0],[682,25,682,32,0],[682,34,682,45,0],[682,46,682,48,0],[682,49,682,61,0],[683,29,683,63,0],[684,21,684,22,0],[685,17,685,18,0],[687,17,687,39,0],[692,17,692,90,0],[693,17,693,18,0],[694,21,694,121,0],[695,21,695,39,0],[696,21,696,22,0],[697,25,697,117,0],[698,25,698,56,0],[699,25,699,43,0],[700,21,700,22,0],[701,17,701,18,0],[703,17,703,56,0],[704,13,704,14,0],[706,13,706,23,0],[707,9,707,10,0],[710,9,710,10,0],[711,13,711,56,0],[712,13,712,14,0],[713,17,713,113,0],[714,17,714,18,0],[715,26,715,35,0],[715,37,715,54,0],[715,56,715,59,0],[716,21,716,22,0],[717,25,717,74,0],[718,25,718,26,0],[719,29,719,101,0],[720,29,720,116,0],[721,29,721,113,0],[722,25,722,26,0],[723,21,723,22,0],[724,17,724,18,0],[725,13,725,14,0],[727,9,727,10,0],[730,9,730,10,0],[731,13,731,56,0],[732,13,732,68,0],[733,13,733,14,0],[734,22,734,31,0],[734,33,734,50,0],[734,52,734,55,0],[735,17,735,18,0],[737,21,737,87,0],[738,21,738,103,0],[739,21,739,22,0],[740,25,740,97,0],[741,25,741,112,0],[742,25,742,94,0],[743,21,743,22,0],[745,17,745,18,0],[746,13,746,14,0],[747,13,747,26,0],[749,9,749,10,0],[752,9,752,10,0],[753,13,753,50,0],[754,13,754,47,0],[755,13,756,29,0],[756,29,757,32,0],[757,32,757,112,0],[757,112,757,120,0],[757,120,757,159,0],[757,159,758,40,0],[756,29,758,40,0],[758,40,759,40,0],[759,40,759,63,0],[759,63,760,36,0],[760,36,760,92,0],[760,92,760,93,0],[755,13,760,93,0],[762,13,762,20,0],[762,22,762,36,0],[762,37,762,39,0],[762,40,762,50,0],[763,17,763,70,0],[765,13,765,50,0],[766,13,766,50,0],[768,13,768,20,0],[768,22,768,36,0],[768,37,768,39,0],[768,40,768,58,0],[769,17,769,70,0],[771,13,771,20,0],[771,22,771,29,0],[771,30,771,32,0],[771,33,771,42,0],[772,13,772,14,0],[773,17,773,48,0],[774,17,774,24,0],[774,26,774,40,0],[774,41,774,43,0],[774,44,774,54,0],[775,21,775,69,0],[776,17,776,24,0],[776,26,776,40,0],[776,41,776,43,0],[776,44,776,62,0],[777,21,777,69,0],[779,17,779,43,0],[780,13,780,14,0],[781,13,781,29,0],[782,9,782,10,0],[785,9,785,10,1],[786,13,786,36,1],[787,13,787,14,1],[788,17,788,168,1],[789,17,789,18,1],[790,21,790,28,1],[790,30,790,41,1],[790,42,790,44,1],[790,45,790,85,1],[791,21,791,22,1],[792,25,792,100,1],[793,25,793,26,1],[794,29,794,149,1],[795,25,795,26,1],[796,21,796,22,1],[797,17,797,18,1],[798,13,798,14,1],[800,13,801,111,1],[802,13,802,14,1],[803,17,803,24,1],[803,26,803,38,1],[803,39,803,41,1],[803,42,803,85,1],[804,17,804,18,1],[805,21,805,108,1],[806,21,806,22,1],[807,25,807,116,1],[808,25,808,95,1],[809,25,809,26,1],[810,29,810,56,1],[811,29,811,99,1],[812,29,812,30,0],[813,33,813,43,0],[814,33,814,113,0],[815,33,815,34,0],[816,37,816,41,0],[817,37,817,69,0],[818,33,818,34,0],[819,29,819,30,0],[820,29,820,63,1],[821,25,821,26,1],[823,21,823,22,1],[824,17,824,18,1],[825,13,825,14,1],[826,9,826,10,1],[832,9,832,10,0],[833,13,833,75,0],[834,17,834,73,0],[835,13,835,79,0],[836,17,836,77,0],[837,13,837,72,0],[838,17,838,70,0],[839,13,839,80,0],[840,17,840,78,0],[850,9,850,10,0],[854,9,854,10,1],[855,13,855,23,1],[856,13,858,62,1],[859,13,859,37,1],[862,21,862,27,0],[864,21,864,58,1],[865,21,865,54,1],[866,21,866,60,1],[867,21,867,62,1],[868,21,868,111,1],[869,21,869,22,0],[870,25,870,32,0],[870,34,870,44,0],[870,45,870,47,0],[870,48,870,71,0],[871,25,871,26,0],[872,29,875,57,0],[876,29,876,60,0],[877,33,877,86,0],[878,25,878,26,0],[879,21,879,22,0],[880,21,880,27,1],[882,13,882,23,1],[883,9,883,10,1],[885,9,885,75,1],[890,13,890,14,1],[891,17,891,48,1],[892,13,892,14,1],[896,9,896,10,1],[897,13,897,105,1],[900,13,900,76,1],[901,13,901,114,1],[902,13,902,66,1],[903,13,903,34,1],[904,13,904,53,1],[906,13,906,121,1],[907,13,907,76,1],[908,13,908,97,1],[910,13,910,20,1],[910,22,910,33,1],[910,34,910,36,1],[910,37,910,58,1],[911,13,911,14,1],[912,17,912,61,1],[913,17,913,24,1],[913,26,913,40,1],[913,41,913,43,1],[913,44,913,68,1],[914,17,914,18,1],[915,21,915,60,1],[916,17,916,18,1],[917,17,917,41,1],[918,13,918,14,1],[919,13,919,61,1],[921,13,921,55,1],[922,13,922,14,1],[923,17,923,75,1],[925,17,925,24,1],[925,26,925,36,1],[925,37,925,39,1],[925,40,925,46,1],[926,17,926,18,1],[927,21,927,63,1],[928,21,928,57,1],[929,25,929,104,1],[930,17,930,18,1],[931,17,931,32,1],[932,13,932,14,1],[934,13,936,23,1],[937,13,938,80,1],[940,13,944,68,1],[946,13,946,49,1],[947,17,950,72,1],[952,13,954,75,1],[956,13,957,70,1],[958,13,958,14,1],[959,17,961,43,1],[962,13,962,14,1],[965,13,965,59,1],[966,17,968,41,1],[970,13,970,59,1],[971,17,972,146,1],[974,13,974,59,1],[975,17,978,95,1],[980,13,980,92,1],[981,17,986,86,0],[988,18,988,64,1],[989,17,993,111,1],[994,13,994,53,1],[995,17,999,98,0],[1000,13,1000,54,1],[1001,17,1005,98,0],[1006,13,1006,51,1],[1007,17,1009,85,0],[1010,13,1010,55,1],[1011,17,1015,66,0],[1016,13,1016,55,1],[1017,17,1021,66,0],[1022,13,1022,55,1],[1023,17,1027,66,0],[1029,13,1029,49,1],[1030,13,1032,169,1],[1034,13,1034,114,1],[1035,13,1035,89,1],[1036,13,1036,14,1],[1037,17,1040,66,1],[1041,13,1041,14,1],[1044,13,1044,63,1],[1045,13,1045,37,1],[1046,9,1046,10,1],[1050,9,1050,10,1],[1051,13,1052,37,1],[1053,13,1053,112,1],[1054,13,1054,14,0],[1055,17,1055,24,0],[1055,26,1055,36,0],[1055,37,1055,39,0],[1055,40,1055,67,0],[1056,17,1056,18,0],[1057,21,1057,84,0],[1058,21,1058,77,0],[1059,21,1062,60,0],[1063,21,1063,50,0],[1064,21,1064,51,0],[1065,17,1065,18,0],[1066,13,1066,14,0],[1067,9,1067,10,1],[1070,9,1070,10,1],[1071,13,1071,76,1],[1072,13,1072,103,1],[1074,13,1074,53,1],[1076,13,1076,55,1],[1077,13,1077,14,0],[1078,17,1078,75,0],[1080,17,1080,24,0],[1080,26,1080,36,0],[1080,37,1080,39,0],[1080,40,1080,46,0],[1081,17,1081,18,0],[1082,21,1082,63,0],[1083,21,1083,100,0],[1084,17,1084,18,0],[1085,13,1085,14,0],[1087,13,1087,24,1],[1088,9,1088,10,1],[1091,9,1091,10,1],[1092,13,1092,66,1],[1093,13,1096,79,1],[1098,13,1099,105,1],[1100,13,1100,56,1],[1101,13,1101,14,0],[1102,17,1105,83,0],[1106,13,1106,14,0],[1108,13,1108,37,1],[1109,9,1109,10,1],[1112,9,1112,10,0],[1113,13,1114,113,0],[1115,9,1115,10,0],[1118,9,1118,10,1],[1119,13,1119,47,1],[1120,13,1120,69,1],[1121,17,1122,51,0],[1124,13,1126,78,1],[1127,9,1127,10,1],[1130,9,1130,10,0],[1131,13,1131,80,0],[1135,9,1135,10,0],[1136,13,1136,47,0],[1139,13,1139,69,0],[1140,17,1140,129,0],[1142,13,1142,40,0],[1143,17,1145,143,0],[1147,17,1149,143,0],[1150,9,1150,10,0],[1153,9,1153,10,1],[1154,13,1154,47,1],[1155,13,1155,69,1],[1156,17,1157,51,0],[1158,13,1158,40,1],[1159,17,1163,58,1],[1165,17,1169,58,0],[1170,9,1170,10,0],[1173,9,1173,10,1],[1174,13,1174,40,1],[1175,17,1176,38,1],[1178,17,1179,76,1],[1180,9,1180,10,1],[1183,9,1183,10,0],[1184,13,1184,56,0],[1185,13,1185,34,0],[1186,13,1187,61,0],[1188,13,1188,55,0],[1189,13,1189,30,0],[1190,17,1190,45,0],[1192,9,1192,10,0],[1195,9,1195,10,1],[1196,13,1199,90,1],[1200,9,1200,10,0],[1203,9,1203,10,1],[1204,13,1207,46,1],[1208,9,1208,10,0],[1211,9,1211,10,0],[1212,13,1214,87,0],[1215,13,1215,62,0],[1216,17,1216,96,0],[1217,13,1218,80,0],[1219,13,1219,14,0],[1220,17,1220,67,0],[1221,13,1221,14,0],[1223,13,1223,69,0],[1224,17,1224,110,0],[1225,13,1225,82,0],[1226,9,1226,10,0],[1229,9,1229,10,0],[1230,13,1232,87,0],[1233,13,1233,62,0],[1234,17,1234,96,0],[1235,13,1236,79,0],[1237,13,1237,14,0],[1238,17,1238,67,0],[1239,13,1239,14,0],[1241,13,1241,69,0],[1242,17,1242,110,0],[1243,13,1243,32,0],[1244,9,1244,10,0],[1247,9,1247,10,1],[1248,13,1248,57,1],[1249,13,1249,37,1],[1250,13,1250,14,1],[1251,17,1251,97,1],[1252,17,1252,18,1],[1253,21,1253,55,1],[1254,17,1254,18,1],[1255,22,1255,138,1],[1256,17,1256,18,0],[1257,21,1257,61,0],[1258,17,1258,18,0],[1259,22,1259,118,1],[1260,17,1260,18,0],[1261,21,1261,63,0],[1262,17,1262,18,0],[1263,22,1263,98,1],[1264,17,1264,18,1],[1265,21,1265,45,1],[1266,25,1266,35,0],[1267,21,1267,57,1],[1268,17,1268,18,1],[1269,22,1269,106,1],[1270,17,1270,18,1],[1271,21,1273,102,1],[1274,17,1274,18,0],[1275,22,1275,66,1],[1276,17,1276,18,0],[1277,21,1277,55,0],[1278,21,1278,77,0],[1279,25,1280,59,0],[1281,21,1281,45,0],[1282,25,1282,35,0],[1283,21,1286,108,0],[1287,17,1287,18,0],[1288,22,1288,61,1],[1289,17,1289,18,1],[1290,21,1290,45,1],[1291,25,1291,35,1],[1292,26,1292,56,0],[1293,21,1293,22,0],[1294,25,1294,80,0],[1296,21,1296,56,1],[1297,17,1297,18,1],[1298,22,1298,76,1],[1299,17,1299,18,0],[1300,21,1300,48,0],[1301,21,1303,79,0],[1304,21,1304,22,0],[1305,17,1305,18,0],[1306,22,1306,67,1],[1307,17,1307,18,0],[1308,21,1308,55,0],[1309,21,1309,77,0],[1310,25,1311,59,0],[1312,21,1314,82,0],[1315,17,1315,18,0],[1316,22,1316,83,1],[1317,17,1317,18,0],[1318,21,1318,81,0],[1319,21,1319,40,0],[1320,21,1320,47,0],[1321,17,1321,18,0],[1322,13,1322,14,1],[1324,13,1324,14,0],[1325,17,1325,51,0],[1326,21,1326,49,0],[1327,13,1327,14,0],[1329,9,1329,10,1],[1332,9,1332,10,0],[1333,13,1336,95,0],[1337,13,1337,56,0],[1338,13,1338,34,0],[1340,13,1340,99,0],[1341,13,1341,14,0],[1342,22,1342,31,0],[1342,33,1342,60,0],[1342,62,1342,65,0],[1343,17,1343,18,0],[1344,21,1344,39,0],[1346,21,1346,93,0],[1347,21,1347,89,0],[1348,21,1348,83,0],[1349,21,1349,93,0],[1350,21,1350,94,0],[1351,21,1351,75,0],[1352,21,1352,97,0],[1353,21,1353,38,0],[1355,21,1355,117,0],[1356,21,1356,44,0],[1357,21,1357,83,0],[1358,21,1358,82,0],[1359,21,1359,43,0],[1362,21,1362,37,0],[1368,21,1368,92,0],[1369,21,1369,84,0],[1370,21,1370,89,0],[1371,21,1371,36,0],[1372,21,1372,38,0],[1373,21,1373,42,0],[1375,21,1375,47,0],[1376,21,1376,74,0],[1377,17,1377,18,0],[1378,13,1378,14,0],[1379,9,1379,10,0],[1382,9,1382,10,0],[1384,13,1384,105,0],[1385,17,1387,105,0],[1390,17,1390,58,0],[1393,13,1393,70,0],[1394,13,1394,60,0],[1395,13,1395,66,0],[1397,13,1397,105,0],[1399,17,1399,110,0],[1400,9,1400,10,0],[1403,9,1403,10,0],[1404,13,1404,38,0],[1405,13,1405,63,0],[1406,13,1406,148,0],[1407,13,1407,300,0],[1408,13,1408,39,0],[1409,13,1409,56,0],[1410,13,1410,77,0],[1411,13,1411,65,0],[1412,13,1412,200,0],[1413,9,1413,10,0],[1416,9,1416,10,1],[1417,13,1417,63,1],[1419,13,1419,109,1],[1420,13,1420,14,1],[1421,17,1421,84,1],[1422,13,1422,14,1],[1424,13,1424,148,1],[1425,13,1425,300,1],[1426,13,1426,44,1],[1427,13,1427,82,1],[1428,13,1428,70,1],[1429,13,1429,200,1],[1430,9,1430,10,1],[1433,9,1433,10,1],[1434,13,1434,74,1],[1435,13,1435,59,1],[1436,13,1436,62,1],[1437,13,1438,74,1],[1439,13,1439,107,1],[1440,13,1440,101,1],[1441,13,1441,61,1],[1443,13,1443,48,1],[1444,13,1444,99,1],[1445,13,1445,60,1],[1447,13,1447,48,1],[1448,13,1448,97,1],[1449,13,1449,65,1],[1451,13,1451,48,1],[1452,13,1452,67,1],[1453,13,1453,58,1],[1455,13,1455,48,1],[1456,13,1456,67,1],[1457,13,1457,63,1],[1459,13,1459,48,1],[1460,13,1460,67,1],[1461,13,1461,63,1],[1463,13,1463,48,1],[1464,13,1464,67,1],[1465,13,1465,63,1],[1467,13,1467,48,1],[1468,13,1468,101,1],[1469,13,1469,61,1],[1471,13,1471,48,1],[1472,13,1472,101,1],[1473,13,1473,60,1],[1475,13,1475,48,1],[1476,13,1476,101,1],[1477,13,1477,58,1],[1479,13,1479,20,1],[1479,22,1479,34,1],[1479,35,1479,37,1],[1479,38,1479,47,1],[1480,13,1480,14,1],[1481,17,1481,113,1],[1482,13,1482,14,1],[1483,9,1483,10,1],[1487,9,1487,10,0],[1488,13,1488,34,0],[1489,13,1489,37,0],[1490,13,1490,28,0],[1491,13,1491,14,0],[1492,17,1492,40,0],[1493,17,1493,18,0],[1494,21,1494,46,0],[1495,17,1495,18,0],[1496,17,1496,41,0],[1497,17,1497,36,0],[1498,17,1498,54,0],[1499,21,1499,118,0],[1500,17,1500,53,0],[1501,21,1501,115,0],[1502,17,1502,58,0],[1503,21,1503,118,0],[1504,17,1504,51,0],[1505,21,1505,81,0],[1506,17,1506,51,0],[1507,21,1507,81,0],[1508,17,1508,56,0],[1509,21,1509,86,0],[1510,17,1510,56,0],[1511,21,1511,86,0],[1512,17,1512,56,0],[1513,21,1513,86,0],[1514,17,1514,54,0],[1515,21,1515,118,0],[1516,17,1516,53,0],[1517,21,1517,117,0],[1518,17,1518,51,0],[1519,21,1519,115,0],[1520,13,1520,14,0],[1521,13,1521,44,0],[1522,13,1522,65,0],[1526,13,1526,110,0],[1527,13,1527,113,0],[1528,13,1530,22,0],[1531,13,1531,47,0],[1532,13,1532,14,0],[1533,17,1533,35,0],[1534,21,1534,97,0],[1535,17,1535,36,0],[1536,21,1536,98,0],[1537,17,1537,44,0],[1538,21,1538,106,0],[1539,13,1539,14,0],[1540,9,1540,10,0],[1543,9,1543,10,1],[1544,13,1547,66,1],[1548,9,1548,10,1],[1551,9,1551,10,0],[1552,13,1552,80,0],[1556,9,1556,10,0],[1557,13,1557,44,0],[1558,13,1558,51,0],[1559,13,1559,32,0],[1560,9,1560,10,0],[1563,9,1563,10,0],[1564,9,1564,10,0],[1567,9,1567,10,0],[1568,13,1568,88,0],[1569,13,1571,22,0],[1572,13,1572,120,0],[1573,9,1573,10,0],[1576,9,1576,10,1],[1577,13,1577,27,1],[1578,9,1578,10,1],[1581,9,1581,10,1],[1582,9,1582,10,1],[1587,9,1587,10,0],[1588,9,1588,10,0],[1591,9,1591,10,0],[1592,9,1592,10,0],[1603,9,1603,10,1],[1604,9,1604,10,1]]);
    </script>
  </body>
</html>