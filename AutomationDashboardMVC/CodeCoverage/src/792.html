<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\UserControls\GenericPickerControl.ascx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Web.Configuration;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;
using Telerik.Web.UI;
using System.Web;

namespace Aurigo.AMP3.Core.UserControls
{
    [Description(&quot;Generic Control&quot;)]
    public partial class GenericPickerControl : UserControl
    {
        protected ToolBar MainToolBar;
        protected ModalPopupExtender PopupExtender;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid GridMain;

        #region String Constants

        private const string VWSTATE_DEF_SEL = &quot;DefaultSelections&quot;;

        #endregion

        #region &quot;Class Variables&quot;

        #region Delegates

        public delegate void DelegateBindData(
            string Filter, string SortOrder, out DataSet DsResult, ref int CurrentPage, int PageSize, out int PageCount);

        public delegate void ItemSelectedEventHandler(object sender, ItemSelectedEventArgs e);

        #endregion

        private DataTable dtSelectedItems;

        private StateManagementBase pageState;

        [Browsable(true)]
        public event EventHandler BackClicked;

        public event DelegateBindData BindData;

        [Browsable(true)]
        public event ItemSelectedEventHandler ItemSelected;

        #endregion

        #region Properties

        private DataTable ColumnInfo;
        [Browsable(true)] public DataSourceType DataSourceCommandType = DataSourceType.Table;

        private DataTable ImageInfo;
        private int PageCount;
        public bool ShowToolBar;
        private String _GridNoDataMessage = &quot;No Data to display.&quot;;


        private bool defaultVisibility = true;
        private int pageSize = 19;

        [Browsable(true)]
        public bool IsRecordsExists { get; set; }

        /// &lt;summary&gt;
        /// Setting True/False will display/hide all the columns. Default value is True.
        /// &lt;/summary&gt;
        [Browsable(true)]
        public bool DefaultColumnVisibility
        {
            get { return defaultVisibility; }
            set { defaultVisibility = value; }
        }

        /// &lt;summary&gt;
        /// Set the datasource for the control.
        /// &lt;/summary&gt;
        [Browsable(true)]
        public string TableOrViewName { get; set; }

        /// &lt;summary&gt;
        /// The default top level filter applied to the table or view.
        /// &lt;/summary&gt;
        [Browsable(false)]
        public Dictionary&lt;string, string&gt; DataSourceFilter { get; set; }

        [Browsable(true)]
        public bool EnableMultipleSelect { get; set; }

        [Browsable(true)]
        /// &lt;summary&gt;
        /// Get,Set the Statemanagement context variable.
        /// &lt;/summary&gt;
        public string StateMgmtContext
        {
            get { return hdnContext.Value; }
            set { hdnContext.Value = value.ToString2(); }
        }

        private int PageSize
        {
            get { return pageSize; }
            set { pageSize = value; }
        }

        public BrixFilter[] Filters { get; set; }

        /// &lt;summary&gt;
        /// Default Sort column for the Table or View.
        /// &lt;/summary&gt;
        public string DefaultSortColumn { get; set; }

        [Browsable(true)]
        public bool IsFilterXml { get; set; }

        [Browsable(true)]
        public bool DisplayFilter { get; set; }

        [Browsable(true)]
        public string Currency { get; set; }

        [Browsable(true)]
        /// &lt;summary&gt;
        /// Set No Data Text to the grid if the grid is empty.
        /// &lt;/summary&gt;
        public string GridNoDataMessage
        {
            get { return _GridNoDataMessage; }
            set { _GridNoDataMessage = value; }
        }

        //A new property added to the generic picker. If the original tool bar of the page has to be displayed then set this to true. 
        //By default it is set to false.

        #endregion

        #region Initialization

        protected override void OnInit(EventArgs e)
        {
            CreateToolBarMenu();
            (grdPager as PagerControl).ItemClicked += grdPager_ItemClicked;
            grdPager.EnableViewState = true;

            btnDone.Click += btnDone_Click;
            btnDone.OnClientClick = &quot;return checkNull(&#39;&quot; + GridMain.ClientID + &quot;&#39;);&quot;;
            btnGenericPickerCancel.Click += btnGenericPickerCancel_Click;

            ModelHelper.SetColumnAndImageInfo(ref ColumnInfo, ref ImageInfo);

            GridMain.DisplayLayout.ClientSideEvents.DblClickHandler = &quot;DblClick_GridMain_&quot; + ClientID;

            base.OnInit(e);
        }


        /// &lt;summary&gt;
        /// Warning:This Method Should be called after the control is loaded.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;tableOrViewName&quot;&gt;&lt;/param&gt;       
        public void ChangeTableOrViewAndBind(string tableOrViewName)
        {
            if (Visible)
            {
                CustomiseToolbar();
                TableOrViewName = tableOrViewName;
                (grdPager as PagerControl).Set_Page(1, 1);
                StateMgmtAndFilter();
                BindGrid();
            }
        }

        protected override void OnLoad(EventArgs e)
        {
            if (Visible)
            {
                StateMgmtAndFilter();

                if (!Page.IsPostBack)
                {
                    (grdPager as PagerControl).Set_Page(1, 1);
                    if (!string.IsNullOrEmpty(pageState.SortKey))
                        ApplySort(pageState.SortKey, false);
                    else
                        BindGrid();
                }
                CustomiseToolbar();
            }
            ScriptManager.RegisterClientScriptBlock(btnGhostFilter, btnGhostFilter.GetType(),
                &quot;DblClick_GridMain&quot; + ClientID,
                &quot; function DblClick_GridMain_&quot; + ClientID + &quot;() { $(&#39;#&quot; + hdnIsDblClick.ClientID +
                &quot;&#39;).val(&#39;true&#39;); $(&#39;#&quot; + btnDone.ClientID + &quot;&#39;).click(); }&quot;, true);
            base.OnLoad(e);
        }

        private void CustomiseToolbar()
        {
            //PopupExtender.AddNewPopup(aspPnlFilter.ClientID, MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID,
            //                              btnCancel.ClientID, 300, 400);
            string script = PopupExtender.GetScript(aspPnlFilter.ClientID,
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID,
                btnCancel.ClientID, 300, 400, &quot;Filter&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, true);
            ScriptManager.RegisterStartupScript(btnGhostFilter, btnGhostFilter.GetType(), &quot;ShowHideFilterButtons&quot;,
                script, true);

            string script1 = PopupExtender.GetScript(aspPnlFilter.ClientID,
                MainToolBar.GetMenuReference(&quot;lnkFilter_SplitButton&quot;).ClientID,
                btnCancel.ClientID, 300, 400, &quot;Filter&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, true);
            ScriptManager.RegisterStartupScript(btnGhostFilter, btnGhostFilter.GetType(), &quot;ShowHideFilterButtons1&quot;,
                script1, true);

            btnFilter.OnClientClick = &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID + &quot;&#39;).click(); applyFilter(&#39;&quot; +
                                      btnGhostFilter.ClientID + &quot;&#39;, &#39;&quot; +
                                      MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                      MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);return false;&quot;;
            btnReset.Attributes.Add(&quot;onClick&quot;,
                &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID +
                &quot;&#39;).click();return resetFilters(&#39;&quot; + btnGhostFilter.ClientID + &quot;&#39;, &#39;&quot; +
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);&quot;);
            if (!DisplayFilter)
            {
                MainToolBar.GetMenuReference(&quot;lnkFilter_SplitButton&quot;).Hide();
                //MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            }
            else
                ScriptManager.RegisterArrayDeclaration(tblFilter, &quot;FilterFields&quot;,
                    ModelHelper.GetFilterHtml(tblFilter, Filters));

            if (MainToolBar.GetMenuReference(&quot;lnkFilter&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).AddAttribute(&quot;style&quot;, &quot;display:none&quot;);
            }

            MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).OnClientClick = &quot;return resetFilters(&#39;&quot; +
                                                                         btnGhostFilter.ClientID + &quot;&#39;, &#39;&quot; +
                                                                         MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).
                                                                             ClientID + &quot;&#39;, &#39;&quot; +
                                                                         MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).
                                                                             ClientID + &quot;&#39;);&quot;;
            ScriptManager.RegisterClientScriptBlock(btnGhostFilter, btnGhostFilter.GetType(), &quot;showHideFilterButtons&quot;,
                &quot;if (document.getElementById(&#39;&quot; +
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID +
                &quot;&#39;) != null) showHideFilterButtons(&#39;&quot; +
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);&quot;, true);
            ScriptManager.RegisterClientScriptBlock(btnGhostFilter, btnGhostFilter.GetType(), &quot;&quot;,
                &quot;function DblClick() { document.getElementById(&#39;&quot; +
                MainToolBar.GetMenuReference(&quot;lnkDone&quot;).ClientID + &quot;&#39;).click(); }&quot;,
                true);
        }

        private void SetDefaultVisibility()
        {
            foreach (UltraGridColumn col in GridMain.Columns)
            {
                if (col.Key == &quot;Multi&quot;)
                    continue;
                bool colExists = false;
                foreach (DataRow dr in ColumnInfo.Rows)
                {
                    if (String.Equals(col.Key, dr[&quot;key&quot;].ToString2()))
                    {
                        colExists = true;
                        break;
                    }
                }
                if (!colExists)
                {
                    ModifyColumnProperties(col.Key, !DefaultColumnVisibility, null, null, null, false);
                }

                col.HTMLEncodeContent = true;
            }
        }

        public void ModifyColumnProperties(string key, bool hide,
            int? position, string format, string columnWidth, bool allowUpdate)
        {
            ModelHelper.ModifyColumnProperties(key, hide, position, format, columnWidth, allowUpdate, ColumnInfo);
        }

        public void ModifyColumnProperties(string key, bool hide,
            int? position, string format, string columnWidth, bool allowUpdate,
            string Caption)
        {
            ModelHelper.ModifyColumnProperties(key, hide, position, format, columnWidth, allowUpdate, Caption,
                ColumnInfo);
        }

        protected override void OnPreRender(EventArgs e)
        {
            SetDefaultVisibility();
            ModelHelper.SetColumnAttributes(GridMain, ColumnInfo);

            if (!ShowToolBar)
            {
                MasterPage obj = Page.Master;
                if (Page.Master.Master != null)
                    obj = Page.Master.Master;
                if (obj != null &amp;&amp; obj.FindControl(&quot;ToolbarRow&quot;) != null)
                    (obj.FindControl(&quot;ToolbarRow&quot;) as Literal).Text = &quot;&lt;tr style=&#39;display:none&#39;&gt;&quot;;
            }

            base.OnPreRender(e);
        }

        private void StateMgmtAndFilter()
        {
            bool stateMgmt = WebConfigurationManager.AppSettings[&quot;StateMgmtGlobal&quot;].ToBoolean2();

            pageState = UIHelper.GetModuleFromStateBag(StateMgmtContext, Context) as StateManagementBase;

            if (pageState == null)
            {
                pageState = new StateManagementBase(StateMgmtContext);
                UIHelper.UpdateModuleStateBag(StateMgmtContext, pageState, Context);
                pageState.ClearFilters(tblFilter);
                //if (MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;) != null)
                //    MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).Attributes.Add(&quot;style&quot;, &quot;display:none&quot;);
            }
            else
            {
                if (pageState.FilterCriterionType == StateManagementBase.FilterType.Xml &amp;&amp;
                    !string.IsNullOrEmpty(pageState.FilterCriterion))
                {
                    pageState.RestoreFilterState(tblFilter, pageState.FilterCriterion);
                    //if (MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;) != null)
                    //    MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).Attributes.Add(&quot;style&quot;, &quot;display:block&quot;);
                }
                else
                {
                    pageState.ClearFilters(tblFilter);
                    //if (MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;) != null)
                    //    MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).Attributes.Add(&quot;style&quot;, &quot;display:none&quot;);
                }
            }
        }

        #endregion

        #region Grid

        protected void BindGrid()
        {
            int CurrentPage = ((HtmlInputHidden)grdPager.FindControl(&quot;currentPage&quot;)).Value.Parse2();
            //pageState.SortOrder = string.IsNullOrEmpty(pageState.SortKey) ? DefaultSortColumn + &quot; ASC&quot; : pageState.SortOrder;
            pageState.SortKey = string.IsNullOrEmpty(pageState.SortKey) ? DefaultSortColumn : pageState.SortKey;
            //Table or View, filter Parameters, CurrentPage, PageSize

            DataSet ds = new BrixDataSet();

            if (DataSourceCommandType == DataSourceType.StoredProcedure)
            {
                if (BindData != null)
                    BindData(pageState.FilterCriterion,
                        UIHelper.GetSortOrder(pageState.SortKey, pageState.SortOrder),
                        out ds, ref CurrentPage, pageSize, out PageCount);
            }
            else
            {
                ds = CoreDatabaseHelper.GetODSData(TableOrViewName, PageSize,
                    UIHelper.GetSortOrder(pageState.SortKey, pageState.SortOrder),
                    pageState.FilterCriterion, IsFilterXml, ref CurrentPage, out PageCount, DataSourceFilter, null, null,
                    null);
            }
            if (ds != null &amp;&amp; ds.Tables.Count &gt; 0 &amp;&amp; ds.Tables[0].Rows.Count &gt; 0)
            {
                IsRecordsExists = ds.Tables[0].Rows.Count &gt; 0;
                if (GridMain.Columns.Count &gt; 1)
                {
                    GridMain.DataSource = null;
                    GridMain.DataBind();
                }
                GridMain.DataSource = ds.Tables[0];
                GridMain.DataBind();
                if (ViewState[StateMgmtContext] == null)
                {
                    dtSelectedItems = ds.Tables[0].Clone();
                    ViewState[StateMgmtContext] = dtSelectedItems;
                    ViewState[VWSTATE_DEF_SEL] = dtSelectedItems;
                }
                else //restore selections
                {
                    dtSelectedItems = (DataTable)ViewState[StateMgmtContext];
                    RestoreSelections(ds.Tables[0], dtSelectedItems);
                }
                string modulecurrency = &quot;&quot;;
                if (string.IsNullOrEmpty(Currency))
                    modulecurrency = LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL);
                else
                    modulecurrency = Currency;

                if (GridMain.Columns.Exists(&quot;RowNum&quot;))
                    GridMain.Columns.FromKey(&quot;RowNum&quot;).Hidden = true;
                if (GridMain.Columns.Exists(&quot;ID&quot;))
                    GridMain.Columns.FromKey(&quot;ID&quot;).Hidden = true;
               
                if (GridMain.Columns.Exists(&quot;Rate&quot;))
                {
                    GridMain.Columns.FromKey(&quot;Rate&quot;).Header.Caption = &quot;Rate In &quot; + modulecurrency;
                    GridMain.Columns.FromKey(&quot;Rate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                }
                if (GridMain.Columns.Exists(&quot;ParentResItemID&quot;))
                    GridMain.Columns.FromKey(&quot;ParentResItemID&quot;).Header.Caption = &quot;Resource ID&quot;;
                if (GridMain.Columns.Exists(&quot;ResItemID&quot;))
                    GridMain.Columns.FromKey(&quot;ResItemID&quot;).Header.Caption = &quot;Resource ID&quot;;
                GridMain.Columns.FromKey(&quot;Multi&quot;).Hidden = !EnableMultipleSelect;
                if (EnableMultipleSelect)
                {
                    TemplatedColumn col = GridMain.Columns.FromKey(&quot;Multi&quot;) as TemplatedColumn;
                    HtmlInputCheckBox chk = col.HeaderItem.FindControl(&quot;CheckAll&quot;) as HtmlInputCheckBox;
                    if (chk != null)
                        chk.Attributes.Add(&quot;onclick&quot;, &quot;SelAll(&#39;&quot; + GridMain.ClientID + &quot;&#39;)&quot;);
                    else
                        (((Control)(col.HeaderItem)).Controls[0] as LiteralControl).Text =
                            &quot;&lt;input type=&#39;checkbox&#39; id=&#39;CheckAll&#39; value=&#39;off&#39; onclick=&#39;SelAll(\&quot;&quot; + GridMain.ClientID +
                            &quot;\&quot;)&#39;/&gt;&quot;;
                }
            }
            else
            {
                GridMain.Columns.Clear();
                GridMain.DisplayLayout.NoDataMessage = GridNoDataMessage;
            }

            (grdPager as PagerControl).Set_Page(CurrentPage, PageCount);

            GridMain.DisplayLayout.FrameStyle.Height = Unit.Pixel(300);

            pageState.MaintainState(pageState.PageIndex, pageState.SortKey, pageState.SortOrder,
                pageState.FilterCriterion);
        }

        private void RestoreSelections(DataTable GridTable, DataTable selectedTable)
        {
            if (!EnableMultipleSelect)
                return;
            int count = 0;
            foreach (DataRow sDr in GridTable.Rows)
            {
                foreach (DataRow selDr in selectedTable.Rows)
                {
                    if (RowCompare(sDr, selDr, selectedTable.Columns.Count))
                    {
                        GridMain.DisplayLayout.Rows[count].Cells.FromKey(&quot;Multi&quot;).Value = true;
                    }
                }
                count++;
            }
        }

        protected void GridMain_DblClick(object sender, ClickEventArgs e)
        {
            try
            {
                UltraGridRow selRow = ((e == null) ? GridMain.DisplayLayout.ActiveRow : e.Row);

                if (selRow == null)
                    throw new Exception(&quot;Please select a record.&quot;);

                dtSelectedItems = (DataTable)ViewState[StateMgmtContext];
                dtSelectedItems.Rows.Clear();
                DataRow dr = dtSelectedItems.NewRow();
                foreach (UltraGridCell cell in selRow.Cells)
                {
                    if (dtSelectedItems.Columns.Contains(cell.Key))
                        dr[cell.Key] = cell.Value ?? DBNull.Value;
                }

                dtSelectedItems.Rows.Add(dr);
                var ie = new ItemSelectedEventArgs(dtSelectedItems);

                if (ItemSelected != null)
                    ItemSelected(this, ie);

                hdnIsDblClick.Value = false.ToString2();
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                   HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                   &quot;ShowError(&#39;&quot; + ex.Message.Replace(&quot;&#39;&quot;, &quot;\\&#39;&quot;).Replace(&quot;\r\n&quot;, &quot;\\n&quot;) + &quot;&#39;);&quot;, true);
            }
        }

        protected void OnMultipleDataSelected()
        {
            try
            {
                if (ViewState[StateMgmtContext] != null)
                {
                    dtSelectedItems = (DataTable)ViewState[StateMgmtContext];
                    if (dtSelectedItems.Rows.Count == 0)
                    {
                        throw new Exception(&quot;Please select at least one record.&quot;);
                    }
                    var ie = new ItemSelectedEventArgs(dtSelectedItems);
                    if (ItemSelected != null)
                    {
                        ItemSelected(this, ie);
                    }
                }
            }
            catch (Exception ex)
            {
                ScriptManager.RegisterClientScriptBlock(aspPnlFilter, aspPnlFilter.GetType(), &quot;ErrMsg&quot;,
                    &quot;ShowError(&#39;&quot; + ex.Message.Replace(&quot;&#39;&quot;, &quot;\\&#39;&quot;).Replace(&quot;\r\n&quot;, &quot;\\n&quot;) + &quot;&#39;);&quot;, true);
            }
        }

        protected void grdPager_ItemClicked(object sender, ItemClickEventArgs e)
        {
            PreserveSelections();
            BindGrid();
            GridMain.DisplayLayout.Pager.CurrentPageIndex = 1;
        }

        #endregion

        #region Filter/Sort

        protected void GridMain_SortColumn(object sender, SortColumnEventArgs e)
        {
            ApplySort(GridMain.Columns[e.ColumnNo].Key, true);
        }

        protected void ApplySort(string sortKey, bool changeIndicator)
        {
            GridSortOrder sortOrder = GridSortOrder.Ascending;
            if (!string.IsNullOrEmpty(sortKey))
            {
                if (pageState.SortOrder != GridSortOrder.None &amp;&amp; !changeIndicator &amp;&amp; sortKey == pageState.SortKey)
                    sortOrder = pageState.SortOrder;
                else if (pageState.SortOrder != GridSortOrder.None &amp;&amp; changeIndicator &amp;&amp; sortKey == pageState.SortKey)
                    sortOrder = (pageState.SortOrder == GridSortOrder.Ascending)
                        ? GridSortOrder.Descending
                        : GridSortOrder.Ascending;
                pageState.SortKey = sortKey;
                pageState.SortOrder = sortOrder;
            }
            BindGrid();
            foreach (UltraGridColumn uwgcol in GridMain.DisplayLayout.Bands[0].Columns)
                if (uwgcol.SortIndicator != SortIndicator.None)
                    uwgcol.SortIndicator = SortIndicator.None;

            if (GridMain.Columns.Exists(sortKey))
                GridMain.Bands[0].Columns.FromKey(sortKey).SortIndicator = (sortOrder == GridSortOrder.Ascending)
                    ? SortIndicator.Ascending
                    : (sortOrder == GridSortOrder.Descending ? SortIndicator.Descending : SortIndicator.None);
        }

        protected void btnGhostFilter_Click(object sender, EventArgs e)
        {
            try
            {
                ApplyFilter();
            }
            catch (Exception ex)
            {
                ScriptManager.RegisterClientScriptBlock(btnGhostFilter, btnGhostFilter.GetType(), &quot;ShowAlert&quot;,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        private void ApplyFilter()
        {
            pageState.FilterCriterion =
                ModelHelper.GetFilterXML(tblFilter.UniqueID.Remove(tblFilter.UniqueID.Length - 9), Request, Filters);
            ((HtmlInputHidden)grdPager.FindControl(&quot;currentPage&quot;)).Value = &quot;1&quot;;
            BindGrid();
        }

        #endregion

        #region Utility Functions

        private bool TableContainsRow(DataTable SelectedTable, DataRow compareRow, out int RowID)
        {
            if (SelectedTable != null &amp;&amp; SelectedTable.Rows.Count &gt; 0)
            {
                int i = 0;
                foreach (DataRow dtRow in SelectedTable.Rows)
                {
                    if (RowCompare(dtRow, compareRow, SelectedTable.Columns.Count))
                    {
                        RowID = i;
                        return true;
                    }
                    i++;
                }
            }
            RowID = -1;
            return false;
        }

        private bool RowCompare(DataRow FirstRow, DataRow SecondRow, int ColumnCount)
        {
            try
            {
                for (int i = 0; i &lt; ColumnCount; i++)
                {
                    if (FirstRow[i] != DBNull.Value &amp;&amp; SecondRow[i] != DBNull.Value)
                    {
                        if (!FirstRow[i].Equals(SecondRow[i]))
                        {
                            return false;
                        }
                    }
                    else if (FirstRow[i] == DBNull.Value &amp;&amp; SecondRow[i] == DBNull.Value)
                        continue;
                    else
                        return false;
                }
                return true;
            }
            catch
            {
                return false;
            }
        }

        protected void PreserveSelections()
        {
            if (!EnableMultipleSelect)
                return;

            if (ViewState[StateMgmtContext] != null)
            {
                dtSelectedItems = (DataTable)ViewState[StateMgmtContext];

                foreach (UltraGridRow row in GridMain.DisplayLayout.Rows)
                {
                    DataRow dr = dtSelectedItems.NewRow();
                    foreach (UltraGridCell cell in row.Cells)
                    {
                        if (dtSelectedItems.Columns.Contains(cell.Key))
                            dr[cell.Key] = cell.Value ?? DBNull.Value;
                    }
                    int RowID = 0;
                    if (TableContainsRow(dtSelectedItems, dr, out RowID))
                    {
                        if (row.Cells.FromKey(&quot;Multi&quot;).Value.ToString2() == &quot;false&quot;)
                            dtSelectedItems.Rows.RemoveAt(RowID);
                    }
                    else
                    {
                        if (row.Cells.FromKey(&quot;Multi&quot;).Value.ToString2() == &quot;true&quot;)
                            dtSelectedItems.Rows.Add(dr);
                    }
                }
                ViewState[StateMgmtContext] = dtSelectedItems;
            }
        }

        #endregion

        #region Done/Cancel events

        protected void btnDone_Click(object sender, EventArgs e)
        {
            if (!EnableMultipleSelect || hdnIsDblClick.Value.Equals(&quot;true&quot;))
                GridMain_DblClick(sender, null);
            else
            {
                PreserveSelections();
                OnMultipleDataSelected();
            }

            //Remove the selections from ViewState
            ViewState[StateMgmtContext] = (ViewState[VWSTATE_DEF_SEL] == null)
                ? null
                : ((DataTable)ViewState[VWSTATE_DEF_SEL]).Clone();
        }

        protected virtual void OnBackClicked(EventArgs e)
        {
            if (BackClicked != null)
                BackClicked(this, e);

            //Remove the selections from ViewState
            ViewState[StateMgmtContext] = (ViewState[VWSTATE_DEF_SEL] == null)
                ? null
                : ((DataTable)ViewState[VWSTATE_DEF_SEL]).Clone();
        }

        private void btnGenericPickerCancel_Click(object sender, EventArgs e)
        {
            OnBackClicked(e);
        }

        #endregion

        protected void CreateToolBarMenu()
        {
            var menuGroups = new List&lt;MenuGroup&gt;();
            MenuGroup generalGroup = new MenuGroup(&quot;General&quot;);
            generalGroup.AddMenu(new LargeButton(&quot;lnkDone&quot;, &quot;Done&quot;, &quot;Icn_Done.png&quot;));
            generalGroup.AddMenu(new LargeButton(&quot;lnkBack&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;));

            SplitButton btnFilter = new SplitButton(&quot;lnkFilter_SplitButton&quot;, &quot;Filter&quot;, &quot;Icn_Filter.png&quot;);
            btnFilter.AddSubMenu(new TextIcon(&quot;lnkFilter&quot;, &quot;Filter&quot;, &quot;Icn_Filter.png&quot;));
            btnFilter.AddSubMenu(new TextIcon(&quot;lnkFilterClr&quot;, &quot;Remove Filter&quot;, &quot;Icn_Filterremove_16.png&quot;));

            generalGroup.AddMenu(btnFilter);
            menuGroups.Add(generalGroup);
            MainToolBar.CreateToolBar(menuGroups);

            if (MainToolBar.GetMenuReference(&quot;lnkDone&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkDone&quot;).Click += btnDone_Click;
                MainToolBar.GetMenuReference(&quot;lnkDone&quot;).OnClientClick = &quot;return checkNull(&#39;&quot; + GridMain.ClientID + &quot;&#39;);&quot;;
            }
            if (MainToolBar.GetMenuReference(&quot;lnkBack&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).Click += btnGenericPickerCancel_Click;
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).CausesValidation = false;
            }
        }
    }

    public class ItemSelectedEventArgs : EventArgs
    {
        public ItemSelectedEventArgs(DataTable values)
        {
            SelectedItems = values;
        }

        public DataTable SelectedItems { get; private set; }
    }

    public enum DataSourceType
    {
        Table,
        View,
        Funtion,
        StoredProcedure
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[59,27,59,94,1],[64,9,64,67,1],[67,9,67,47,1],[68,9,68,35,1],[71,39,71,43,0],[71,44,71,48,1],[79,17,79,18,1],[79,19,79,44,1],[79,45,79,46,1],[80,17,80,18,0],[80,19,80,45,0],[80,46,80,47,0],[87,41,87,45,1],[87,46,87,50,1],[93,62,93,66,1],[93,67,93,71,0],[96,44,96,48,1],[96,49,96,53,1],[104,17,104,18,1],[104,19,104,43,1],[104,44,104,45,1],[105,17,105,18,1],[105,19,105,56,1],[105,57,105,58,1],[110,17,110,18,1],[110,19,110,35,1],[110,36,110,37,1],[111,17,111,18,0],[111,19,111,36,0],[111,37,111,38,0],[114,39,114,43,1],[114,44,114,48,1],[119,43,119,47,1],[119,48,119,52,1],[122,35,122,39,1],[122,40,122,44,1],[125,37,125,41,1],[125,42,125,46,1],[128,34,128,38,1],[128,39,128,43,1],[136,17,136,18,1],[136,19,136,45,1],[136,46,136,47,1],[137,17,137,18,0],[137,19,137,46,0],[137,47,137,48,0],[148,9,148,10,1],[149,13,149,33,1],[150,13,150,76,1],[151,13,151,45,1],[153,13,153,44,1],[154,13,154,86,1],[155,13,155,74,1],[157,13,157,78,1],[159,13,159,103,1],[161,13,161,28,1],[162,9,162,10,1],[170,9,170,10,1],[171,13,171,25,1],[172,13,172,14,1],[173,17,173,36,1],[174,17,174,51,1],[175,17,175,59,1],[176,17,176,38,1],[177,17,177,28,1],[178,13,178,14,1],[179,9,179,10,1],[182,9,182,10,1],[183,13,183,25,1],[184,13,184,14,1],[185,17,185,38,1],[187,17,187,38,1],[188,17,188,18,0],[189,21,189,63,0],[190,21,190,66,0],[191,25,191,61,0],[193,25,193,36,0],[194,17,194,18,0],[195,17,195,36,1],[196,13,196,14,1],[197,13,200,84,1],[201,13,201,28,1],[202,9,202,10,1],[205,9,205,10,1],[208,13,210,75,1],[211,13,212,31,1],[214,13,216,75,1],[217,13,218,32,1],[220,13,223,114,1],[224,13,228,80,1],[229,13,229,32,1],[230,13,230,14,0],[231,17,231,78,0],[233,13,233,14,0],[235,17,236,68,1],[238,13,238,67,1],[239,13,239,14,1],[240,17,240,97,1],[241,13,241,14,1],[243,13,248,95,1],[249,13,254,86,1],[255,13,258,23,1],[259,9,259,10,1],[262,9,262,10,1],[263,13,263,20,1],[263,22,263,41,1],[263,42,263,44,1],[263,45,263,61,1],[264,13,264,14,1],[265,17,265,40,1],[266,21,266,30,1],[267,17,267,40,1],[268,17,268,24,1],[268,26,268,36,1],[268,37,268,39,1],[268,40,268,55,1],[269,17,269,18,1],[270,21,270,71,1],[271,21,271,22,1],[272,25,272,42,1],[273,25,273,31,1],[275,17,275,18,1],[276,17,276,32,1],[277,17,277,18,1],[278,21,278,104,1],[279,17,279,18,1],[281,17,281,46,1],[282,13,282,14,1],[283,9,283,10,1],[287,9,287,10,1],[288,13,288,115,1],[289,9,289,10,1],[294,9,294,10,1],[295,13,296,29,1],[297,9,297,10,1],[300,9,300,10,1],[301,13,301,36,1],[302,13,302,67,1],[304,13,304,30,1],[305,13,305,14,1],[306,17,306,46,1],[307,17,307,48,1],[308,21,308,46,0],[309,17,309,74,1],[310,21,310,99,0],[311,13,311,14,1],[313,13,313,33,1],[314,9,314,10,1],[317,9,317,10,1],[318,13,318,98,1],[320,13,320,106,1],[322,13,322,35,1],[323,13,323,14,1],[324,17,324,71,1],[325,17,325,85,1],[326,17,326,51,1],[329,13,329,14,1],[331,13,331,14,1],[332,17,333,70,1],[334,17,334,18,1],[335,21,335,88,1],[338,17,338,18,1],[340,17,340,18,1],[341,21,341,55,1],[344,17,344,18,1],[345,13,345,14,1],[346,9,346,10,1],[353,9,353,10,1],[354,13,354,101,1],[356,13,356,113,1],[359,13,359,44,1],[361,13,361,73,1],[362,13,362,14,1],[363,17,363,38,1],[364,21,366,75,1],[367,13,367,14,1],[369,13,369,14,1],[370,17,373,27,1],[374,13,374,14,1],[375,13,375,82,1],[376,13,376,14,1],[377,17,377,63,1],[378,17,378,48,1],[379,17,379,18,1],[380,21,380,48,1],[381,21,381,41,1],[382,17,382,18,1],[383,17,383,52,1],[384,17,384,37,1],[385,17,385,57,1],[386,17,386,18,1],[387,21,387,60,1],[388,21,388,67,1],[389,21,389,66,1],[390,17,390,18,1],[392,17,392,18,1],[393,21,393,78,1],[394,21,394,70,1],[395,17,395,18,1],[396,17,396,44,1],[397,17,397,52,1],[398,21,398,102,1],[400,21,400,47,0],[402,17,402,55,1],[403,21,403,70,1],[404,17,404,51,1],[405,21,405,66,1],[407,17,407,53,1],[408,17,408,18,1],[409,21,409,99,1],[410,21,410,114,1],[411,17,411,18,1],[412,17,412,64,1],[413,21,413,96,0],[414,17,414,58,1],[415,21,415,90,1],[416,17,416,82,1],[417,17,417,42,1],[418,17,418,18,0],[419,21,419,96,0],[420,21,420,105,0],[421,21,421,37,0],[422,25,422,94,0],[424,25,426,38,0],[427,17,427,18,0],[428,13,428,14,1],[430,13,430,14,1],[431,17,431,42,1],[432,17,432,74,1],[433,13,433,14,1],[435,13,435,73,1],[437,13,437,72,1],[439,13,440,44,1],[441,9,441,10,1],[444,9,444,10,1],[445,13,445,39,1],[446,17,446,24,1],[447,13,447,27,0],[448,13,448,20,0],[448,22,448,33,0],[448,34,448,36,0],[448,37,448,51,0],[449,13,449,14,0],[450,17,450,24,0],[450,26,450,39,0],[450,40,450,42,0],[450,43,450,61,0],[451,17,451,18,0],[452,21,452,77,0],[453,21,453,22,0],[454,25,454,96,0],[455,21,455,22,0],[456,17,456,18,0],[457,17,457,25,0],[458,13,458,14,0],[459,9,459,10,1],[462,9,462,10,1],[464,13,464,14,1],[465,17,465,96,1],[467,17,467,36,1],[468,21,468,68,1],[470,17,470,74,1],[471,17,471,46,1],[472,17,472,55,1],[473,17,473,24,1],[473,26,473,44,1],[473,45,473,47,1],[473,48,473,60,1],[474,17,474,18,1],[475,21,475,68,1],[476,25,476,67,1],[477,17,477,18,1],[479,17,479,46,1],[480,17,480,69,1],[482,17,482,42,1],[483,21,483,44,1],[485,17,485,57,1],[486,13,486,14,1],[487,13,487,33,1],[488,13,488,14,1],[489,17,491,105,1],[492,13,492,14,1],[493,9,493,10,1],[496,9,496,10,0],[498,13,498,14,0],[499,17,499,57,0],[500,17,500,18,0],[501,21,501,78,0],[502,21,502,57,0],[503,21,503,22,0],[504,25,504,83,0],[506,21,506,73,0],[507,21,507,46,0],[508,21,508,22,0],[509,25,509,48,0],[510,21,510,22,0],[511,17,511,18,0],[512,13,512,14,0],[513,13,513,33,0],[514,13,514,14,0],[515,17,516,106,0],[517,13,517,14,0],[518,9,518,10,0],[521,9,521,10,0],[522,13,522,34,0],[523,13,523,24,0],[524,13,524,63,0],[525,9,525,10,0],[532,9,532,10,0],[533,13,533,63,0],[534,9,534,10,0],[537,9,537,10,0],[538,13,538,63,0],[539,13,539,48,0],[540,13,540,14,0],[541,17,541,115,0],[542,21,542,53,0],[543,22,543,119,0],[544,21,546,51,0],[547,17,547,45,0],[548,17,548,49,0],[549,13,549,14,0],[550,13,550,24,0],[551,13,551,20,0],[551,22,551,44,0],[551,45,551,47,0],[551,48,551,87,0],[552,17,552,64,0],[553,21,553,63,0],[555,13,555,50,0],[556,17,558,111,0],[559,9,559,10,0],[562,9,562,10,1],[564,13,564,14,1],[565,17,565,31,1],[566,13,566,14,1],[567,13,567,33,0],[568,13,568,14,0],[569,17,570,63,0],[571,13,571,14,0],[572,9,572,10,1],[575,9,575,10,1],[576,13,577,118,1],[578,13,578,80,1],[579,13,579,24,1],[580,9,580,10,1],[587,9,587,10,0],[588,13,588,71,0],[589,13,589,14,0],[590,17,590,27,0],[591,17,591,24,0],[591,26,591,39,0],[591,40,591,42,0],[591,43,591,61,0],[592,17,592,18,0],[593,21,593,84,0],[594,21,594,22,0],[595,25,595,35,0],[596,25,596,37,0],[598,21,598,25,0],[599,17,599,18,0],[600,13,600,14,0],[601,13,601,24,0],[602,13,602,26,0],[603,9,603,10,0],[606,9,606,10,0],[608,13,608,14,0],[609,22,609,31,0],[609,33,609,48,0],[609,50,609,53,0],[610,17,610,18,0],[611,21,611,85,0],[612,21,612,22,0],[613,25,613,63,0],[614,25,614,26,0],[615,29,615,42,0],[617,21,617,22,0],[618,26,618,90,0],[619,25,619,34,0],[621,25,621,38,0],[622,17,622,18,0],[623,17,623,29,0],[625,13,625,18,0],[626,13,626,14,0],[627,17,627,30,0],[629,9,629,10,0],[632,9,632,10,0],[633,13,633,39,0],[634,17,634,24,0],[636,13,636,53,0],[637,13,637,14,0],[638,17,638,74,0],[640,17,640,24,0],[640,26,640,42,0],[640,43,640,45,0],[640,46,640,73,0],[641,17,641,18,0],[642,21,642,59,0],[643,21,643,28,0],[643,30,643,48,0],[643,49,643,51,0],[643,52,643,61,0],[644,21,644,22,0],[645,25,645,72,0],[646,29,646,71,0],[647,21,647,22,0],[648,21,648,35,0],[649,21,649,74,0],[650,21,650,22,0],[651,25,651,85,0],[652,29,652,66,0],[653,21,653,22,0],[655,21,655,22,0],[656,25,656,84,0],[657,29,657,58,0],[658,21,658,22,0],[659,17,659,18,0],[660,17,660,63,0],[661,13,661,14,0],[662,9,662,10,0],[669,9,669,10,1],[670,13,670,77,1],[671,17,671,49,1],[673,13,673,14,0],[674,17,674,38,0],[675,17,675,42,0],[676,13,676,14,0],[679,13,681,67,1],[682,9,682,10,1],[685,9,685,10,1],[686,13,686,37,1],[687,17,687,38,1],[690,13,692,67,1],[693,9,693,10,1],[696,9,696,10,1],[697,13,697,30,1],[698,9,698,10,1],[703,9,703,10,1],[704,13,704,52,1],[705,13,705,63,1],[706,13,706,86,1],[707,13,707,86,1],[709,13,709,106,1],[710,13,710,89,1],[711,13,711,108,1],[713,13,713,45,1],[714,13,714,42,1],[715,13,715,51,1],[717,13,717,65,1],[718,13,718,14,1],[719,17,719,80,1],[720,17,720,122,1],[721,13,721,14,1],[722,13,722,65,1],[723,13,723,14,1],[724,17,724,95,1],[725,17,725,82,1],[726,13,726,14,1],[727,9,727,10,1],[732,9,732,55,1],[733,9,733,10,1],[734,13,734,36,1],[735,9,735,10,1],[737,42,737,46,1],[737,47,737,59,1]]);
    </script>
  </body>
</html>