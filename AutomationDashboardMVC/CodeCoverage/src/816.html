<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\BL\ReportManager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Linq;
using System.IO;
using System.Linq;
using System.Text;
using System.Web;
using System.Xml;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.ModuleManagementDAC;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.Brix.Platform.BusinessLayer.DTO;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.ReportServerHelper;
using Aurigo.Common.Utility;

namespace Aurigo.AMP3.Core.BusinessLayer.BL
{
    public class ReportManager : SingletonManagerBase&lt;ReportManager&gt;
    {
        private ReportManager()
        {
        }

        private string ReportServerUrl = string.Empty;

        #region Read all the Uploadable Reports into the Module DTO if exists

        public List&lt;ReportDetails&gt; GetReportDetailsFromXml(string xmlfile, ref List&lt;ModuleUploadResult&gt; status,
            int userid, bool IsErrorShowAsWarning = false)
        {
            var xReportDoc = new XmlDocument();
            xReportDoc.Load(xmlfile);
            XmlNode node = xReportDoc.FirstChild.ParentNode;
            return GetReportDetailsFromXml(node, ref status, userid, IsErrorShowAsWarning);
        }

        public List&lt;ReportDetails&gt; GetReportDetailsFromXml(XmlNode node, ref List&lt;ModuleUploadResult&gt; status,
            int currentuserid, bool IsErrorShowAsWarning = false)
        {
            var reportDetails = new List&lt;ReportDetails&gt;();
            ModuleUploadResultType eType = IsErrorShowAsWarning
                ? ModuleUploadResultType.Warning
                : ModuleUploadResultType.Error;
            XmlNodeList rptsNode = node.SelectNodes(&quot;reports&quot;);
            if (rptsNode.Count &gt; 0 &amp;&amp; rptsNode[0].SelectNodes(&quot;report&quot;).Count &gt; 0)
            {
                foreach (XmlNode xNode in rptsNode[0].SelectNodes(&quot;report&quot;))
                {
                    var newReport = new ReportDetails();
                    newReport.Name = xNode.Attributes[&quot;name&quot;].InnerText;
                    newReport.ParentModuleID = (xNode.Attributes[&quot;parentModuleId&quot;] == null)
                        ? null
                        : xNode.Attributes[&quot;parentModuleId&quot;].InnerText;
                    newReport.ModuleId = xNode.Attributes[&quot;moduleId&quot;].InnerText;
                    newReport.Description = (xNode.Attributes[&quot;description&quot;] == null)
                        ? null
                        : xNode.Attributes[&quot;description&quot;].InnerText.ParseExpression
                            (innerMostExpression =&gt;
                            {
                                if (innerMostExpression.StartsWith(&quot;_LOC:&quot;))
                                    return LocalizationManager.GetString(innerMostExpression.Substring(&quot;_LOC:&quot;.Length));
                                else
                                    return innerMostExpression;
                            }, &#39;{&#39;, &#39;}&#39;);
                    newReport.FileName = (xNode.Attributes[&quot;fileName&quot;] == null)
                        ? null
                        : xNode.Attributes[&quot;fileName&quot;].InnerText;
                    if (xNode.Attributes[&quot;isActive&quot;] != null)
                        newReport.IsActive = xNode.Attributes[&quot;isActive&quot;].InnerText.ToBoolean2();
                    newReport.UploadedDate = DateTime.UtcNow;
                    newReport.UploadedBy = currentuserid;
                    newReport.ModelType = xNode.Attributes[&quot;modelType&quot;].InnerText;
                    //string reportModelType = xNode.Attributes[&quot;modelType&quot;].InnerText;
                    newReport.ParentContext = xNode.Attributes[&quot;parentContext&quot;].InnerText;
                    newReport.ParentModuleID = newReport.ParentModuleID ?? newReport.ParentContext;
                    newReport.Context = xNode.Attributes[&quot;context&quot;].InnerText;
                    newReport.Category = (xNode.Attributes[&quot;category&quot;] == null)
                        ? null
                        : xNode.Attributes[&quot;category&quot;].InnerText;
                    newReport.ReportType = xNode.Attributes[&quot;reportType&quot;].InnerText;
                    newReport.Code = (xNode.Attributes[&quot;code&quot;] == null) ? null : xNode.Attributes[&quot;code&quot;].InnerText;
                    newReport.QueryStringParameters = (xNode.Attributes[&quot;queryStringParameters&quot;] == null)
                        ? null
                        : xNode.Attributes[&quot;queryStringParameters&quot;].InnerText;
                    newReport.GridParameters = (xNode.Attributes[&quot;gridParameters&quot;] == null)
                        ? null
                        : xNode.Attributes[&quot;gridParameters&quot;].InnerText;
                    newReport.SelectRecord = (xNode.Attributes[&quot;SelectRecord&quot;] == null)
                        ? 10
                        : xNode.Attributes[&quot;SelectRecord&quot;].InnerText.ToInt32_2();

                    reportDetails.Add(newReport);
                }
            }
            return reportDetails;
        }

        #endregion Read all the Uploadable Reports into the Module DTO if exists

        public void UploadXMLReports(List&lt;ReportDetails&gt; reportDetails, ref List&lt;ModuleUploadResult&gt; status, string db,
            int userId, string directory, bool? isSSRSconfigured)
        {
            #region Adding Report Details to the ReportsDetails Table

            ModuleUploadResultType eType = ModuleUploadResultType.Warning;
            foreach (ReportDetails newReport in reportDetails)
            {
                bool isReportDeployed = false;
                lock (Instance)
                {
                    isReportDeployed = (Instance.AddModule(newReport, userId, db) &gt;= 0);
                    if (!string.IsNullOrEmpty(directory))
                    {
                        DirectoryInfo di = new DirectoryInfo(directory);
                        if (di != null &amp;&amp; newReport.ReportType.Equals(ReportHostType.sql.ToString2()))
                        {
                            foreach (
                                FileInfo rptFile in
                                    di.GetFiles(newReport.FileName ?? newReport.Name, SearchOption.AllDirectories))
                            {
                                if (isSSRSconfigured.HasValue &amp;&amp; isSSRSconfigured.Value)
                                {
                                    ReportHelper.Instance.RptServer.UploadReport(rptFile.FullName, newReport.Name);
                                    status.Add(
                                        new ModuleUploadResult(
                                            string.Format(&quot;Report &#39;{0}&#39; uploaded successfully at {1}.&quot;,
                                                rptFile.Name, DateTime.UtcNow.ToString(&quot;HH:mm:ss tt&quot;))));
                                }
                                else
                                {
                                    status.Add(
                                        new ModuleUploadResult(
                                            string.Format(
                                                &quot;Reporting Services is not configured correctly. Report &#39;{0}&#39; upload failed.\n&quot;,
                                                rptFile.Name), eType));
                                }
                            }
                        }
                    }
                    if (newReport.IsActive)
                    {
                        if (!isReportDeployed)
                            status.Add(
                                new ModuleUploadResult(
                                    string.Format(&quot;Failed to add report &#39;{0}&#39; {1}.\n&quot;, newReport.Name,
                                        (string.IsNullOrEmpty(db) ? &quot;&quot; : &quot; on database &quot; + db)),
                                    ModuleUploadResultType.Error));
                        else
                            status.Add(
                                new ModuleUploadResult(string.Format(&quot;Report &#39;{0}&#39; added successfully {1} at {2}.\n&quot;,
                                    newReport.Name, (string.IsNullOrEmpty(db) ? &quot;&quot; : &quot; on database &quot; + db),
                                    DateTime.UtcNow.ToString(&quot;HH:mm:ss tt&quot;))));
                    }
                }
            }

            #endregion Adding Report Details to the ReportsDetails Table
        }

        internal int AddModule(ReportDetails report, int currentuserid, string companyCode)
        {
            int rtnValue;

            if (!string.IsNullOrEmpty(report.ModuleId))
            {
                try
                {
                    if (CoreDatabaseHelper.GetModuleDetails(report.ModuleId) != null)
                    {
                        using (var context = new DataContext(ConnectionHelper.GetConnectionString(companyCode)))
                        {
                            Table&lt;ReportDetails&gt; rptTable = context.GetTable&lt;ReportDetails&gt;();

                            ReportDetails existingReport = (from r in rptTable
                                                            where
                                                                r.Context == report.Context &amp;&amp;
                                                                r.ReportType == report.ReportType
                                                                &amp;&amp; r.ParentContext == report.ParentContext &amp;&amp;
                                                                ((r.Code == report.Code == null) ||
                                                                 r.Code == report.Code)
                                                            select r).FirstOrDefault();
                            if (existingReport == null)
                                rptTable.InsertOnSubmit(report);
                            else
                            {
                                existingReport.Name = report.Name;
                                existingReport.Description = report.Description;
                                existingReport.FileName = report.FileName;
                                existingReport.Category = report.Category;
                                existingReport.ModuleId = report.ModuleId;
                                existingReport.ParentModuleID = report.ParentModuleID;
                                existingReport.IsActive = report.IsActive;
                                existingReport.ModelType = report.ModelType;
                                existingReport.QueryStringParameters = report.QueryStringParameters;
                                existingReport.GridParameters = report.GridParameters;
                                existingReport.UploadedBy = currentuserid;
                                existingReport.UploadedDate = DateTime.UtcNow;
                                existingReport.SelectRecord = report.SelectRecord;
                            }

                            try
                            {
                                context.SubmitChanges();
                            }
                            catch (Exception e)
                            {
                                Logger.Log(Aurigo.AMP3.Resources.MessageResources.Enumerations.LogType.Error, e.Message + e.StackTrace, &quot;ReportManager&quot;);
                                return 0;
                            }

                            rtnValue = 1;
                        }

                        //Adding report as a feature in the parent module for permissioning.
                        if (!string.IsNullOrEmpty(report.ModuleId) &amp;&amp; !string.IsNullOrEmpty(report.Context)
                            &amp;&amp; !string.IsNullOrEmpty(report.Name))
                        {
                            string featureCode = report.Context;

                            if (report.ReportType.ToLower2().Equals(ReportHostType.dda.ToString2()))
                                featureCode += &quot;Report&quot; + (string.IsNullOrEmpty(report.Code) ? string.Empty : &quot;-&quot; + report.Code);

                            if (report.ModuleId.Equals(&quot;LIBRARY&quot;, StringComparison.InvariantCultureIgnoreCase))
                                ModuleManagementComponent.Instance.AddModuleFeature(report.ParentContext, featureCode, report.Description ?? report.Name, companyCode);
                            else
                                ModuleManagementComponent.Instance.AddModuleFeature(report.ModuleId, featureCode, report.Description ?? report.Name, companyCode);

                            if (report.ModelType.Contains(ModelType.Gallery.ToString2()))
                            {
                                ModuleManagementComponent.Instance.AddModuleFeature(report.ParentModuleID, featureCode, report.Description ?? report.Name, companyCode);
                                ModuleManagementComponent.Instance.AddModuleFeature(report.ModuleId, &quot;ReportGallery&quot;, &quot;View Report Gallery&quot;, companyCode);
                            }
                        }
                        return rtnValue;
                    }

                    Logger.Log(Aurigo.AMP3.Resources.MessageResources.Enumerations.LogType.Error, &quot;Module details not found in MODMGMTModules (&quot; + report.ModuleId + &quot;)&quot;, &quot;ReportManager&quot;);
                    return -2;
                }
                catch (Exception e)
                {
                    Logger.Log(Aurigo.AMP3.Resources.MessageResources.Enumerations.LogType.Error, e.Message + e.StackTrace, &quot;ReportManager&quot;);
                    return -2;
                }
            }

            Logger.Log(Aurigo.AMP3.Resources.MessageResources.Enumerations.LogType.Error, &quot;ModuleID is empty.&quot;, &quot;ReportManager&quot;);
            return -2;
        }

        public Dictionary&lt;string, string&gt; GetSettings()
        {
            var retDic = new Dictionary&lt;string, object&gt;();
            DataSet dsSettings = ComponentHelper.Instance.ExecuteDataSet(StoredProcedure.usp_RPTMGMTGetSettings, retDic,
                null);
            var settingsDic = new Dictionary&lt;string, string&gt;();
            if (dsSettings.Tables.Count &gt; 0)
            {
                settingsDic = GetDictionaryFromTable(dsSettings.Tables[0], &quot;SettingName&quot;, &quot;SettingValue&quot;);
                if (settingsDic.Count &gt; 0 &amp;&amp; settingsDic.ContainsKey(&quot;UserPassword&quot;) &amp;&amp;
                    EncryptDecryptPassword.EncryptDecryptPassword.Instance.IsBase64(settingsDic[&quot;UserPassword&quot;]))
                    settingsDic[&quot;UserPassword&quot;] =
                        EncryptDecryptPassword.EncryptDecryptPassword.Instance.DecryptPassword(
                            settingsDic[&quot;UserPassword&quot;]);
            }

            return (settingsDic);
        }

        public Dictionary&lt;string, string&gt; GetSettingsOn(string connString)
        {
            var retDic = new Dictionary&lt;string, object&gt;();
            DataSet dsSettings = ComponentHelper.Instance.ExecuteDataSetOn(connString,
                StoredProcedure.usp_RPTMGMTGetSettings, retDic, null);
            var settingsDic = new Dictionary&lt;string, string&gt;();
            if (dsSettings.Tables.Count &gt; 0)
            {
                settingsDic = GetDictionaryFromTable(dsSettings.Tables[0], &quot;SettingName&quot;, &quot;SettingValue&quot;);
                if (settingsDic.Count &gt; 0 &amp;&amp; settingsDic.ContainsKey(&quot;UserPassword&quot;) &amp;&amp;
                    EncryptDecryptPassword.EncryptDecryptPassword.Instance.IsBase64(settingsDic[&quot;UserPassword&quot;]))
                    settingsDic[&quot;UserPassword&quot;] =
                        EncryptDecryptPassword.EncryptDecryptPassword.Instance.DecryptPassword(
                            settingsDic[&quot;UserPassword&quot;]);
            }

            return (settingsDic);
        }

        public void SaveReportSettings(Dictionary&lt;string, string&gt; rptSetting)
        {
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(StoredProcedure.usp_RPTMGMTDeleteSettings,
                null);

            foreach (var kvp in rptSetting)
            {
                if (kvp.Key.ToUpper() == &quot;USERPASSWORD&quot;)
                {
                    if (EncryptDecryptPassword.EncryptDecryptPassword.Instance.IsBase64(kvp.Value))
                        ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                            StoredProcedure.usp_RPTMGMTInsertSettings, null, kvp.Key, kvp.Value);
                    else
                        ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                            StoredProcedure.usp_RPTMGMTInsertSettings, null, kvp.Key,
                            EncryptDecryptPassword.EncryptDecryptPassword.Instance.EncryptPassword(kvp.Value));
                }
                else
                    ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                        StoredProcedure.usp_RPTMGMTInsertSettings, null, kvp.Key, kvp.Value);
            }
        }

        public void SaveReportSettingsOn(string connectionString, Dictionary&lt;string, string&gt; rptSetting)
        {
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParametersOn(connectionString,
                StoredProcedure.usp_RPTMGMTDeleteSettings, null);

            foreach (var kvp in rptSetting)
            {
                if (kvp.Key.ToUpper() == &quot;USERPASSWORD&quot;)
                {
                    if (EncryptDecryptPassword.EncryptDecryptPassword.Instance.IsBase64(kvp.Value))
                        ComponentHelper.Instance.ExecuteNonQueryWithVariableParametersOn(connectionString,
                            StoredProcedure.usp_RPTMGMTInsertSettings, null, kvp.Key, kvp.Value);
                    else
                        ComponentHelper.Instance.ExecuteNonQueryWithVariableParametersOn(connectionString,
                            StoredProcedure.usp_RPTMGMTInsertSettings, null, kvp.Key,
                            EncryptDecryptPassword.EncryptDecryptPassword.Instance.EncryptPassword(kvp.Value));
                }
                else
                    ComponentHelper.Instance.ExecuteNonQueryWithVariableParametersOn(connectionString,
                        StoredProcedure.usp_RPTMGMTInsertSettings, null, kvp.Key, kvp.Value);
            }
        }

        public Dictionary&lt;string, string&gt; GetDictionaryFromTable(DataTable dt, string keyColumnName,
            string valueColumnName)
        {
            var appSettings = new Dictionary&lt;string, string&gt;();

            if (dt.Columns.Contains(keyColumnName) &amp;&amp; dt.Columns.Contains(valueColumnName))
            {
                foreach (DataRow dr in dt.Rows)
                {
                    appSettings[dr[keyColumnName].ToString()] = dr[valueColumnName].ToString();
                }
            }
            return appSettings;
        }

        public string GetBaseReportServer()
        {
            if (string.IsNullOrEmpty(ReportServerUrl))
            {
                Dictionary&lt;string, string&gt; setting = GetSettings();
                if (setting.ContainsKey(&quot;BaseURL&quot;))
                    ReportServerUrl = setting[&quot;BaseURL&quot;];
            }
            return ReportServerUrl;
        }

        public void GetReportGalleryXml(TNode parentNode, string moduleId, int pid, int parentId)
        {
            string rptUrl = GetReportGalleryUrl(moduleId, pid, parentId);
            if (!string.IsNullOrEmpty(rptUrl))
            {
                parentNode.Nodes.Add(new TNode(&quot;Reports&quot;, rptUrl));
            }
        }

        public string GetReportGalleryUrl(string moduleId, int pid, int parentId)
        {
            string connectionString = ConnectionHelper.GetConnectionString();

            var dc = new DataContext(connectionString);
            Table&lt;ReportDetails&gt; tblReports = dc.GetTable&lt;ReportDetails&gt;();

            IEnumerable&lt;ReportDetails&gt; reports = from m in tblReports
                                                 where
                                                     m.ModelType.ToLower().Contains(
                                                         Enum.GetName(typeof(ModelType), ModelType.Gallery).ToLower())
                                                     &amp;&amp; m.IsActive &amp;&amp; m.ParentContext.ToLower() == moduleId.ToLower()
                                                 orderby m.Category
                                                 select m;
            ReportDetails report = reports.Where(HasPermission).FirstOrDefault();
            if (report != null)
            {
                if (pid &gt; 0)
                    return string.Format(&quot;~/Common/BrixReportGallery.aspx?Context={0}&amp;PID={1}&amp;ParentID={2}&quot;, moduleId,
                        pid, parentId);
                else if (parentId &gt; 0)
                    return string.Format(&quot;~/Common/BrixReportGallery.aspx?Context={0}&amp;ParentID={1}&quot;, moduleId, parentId);
                else
                    return string.Format(&quot;~/Common/BrixReportGallery.aspx?Context={0}&quot;, moduleId);
            }
            return string.Empty;
        }

        public string GetReportPageUrl(ReportDetails report, ReportGalleryModel galleryModel)
        {
            var postBackUrl = new StringBuilder();
            postBackUrl.Append((report.ReportType.ToLower().Equals(ReportHostType.dda.ToString()))
                ? @&quot;BrixReportpage.aspx?&quot;
                : @&quot;BrixListReportPage.aspx?ModuleID=&quot; + report.ModuleId + &quot;&amp;&quot;);

            postBackUrl.Append(&quot;PID=&quot; + galleryModel.ProjectID + &quot;&amp;ParentID=&quot; + galleryModel.ParentID + &quot;&amp;ContractID=&quot; +
                               galleryModel.ParentID + &quot;&amp;Context=&quot; + report.Context);

            if (!string.IsNullOrEmpty(report.ParentModuleID))
                postBackUrl.Append(&quot;&amp;ParentContext=&quot; + report.ParentContext);

            postBackUrl.Append(&quot;&amp;ParentModuleID=&quot; + (report.ParentModuleID ?? report.ParentContext));

            postBackUrl.Append(&quot;&amp;ModelType=&quot; + ModelType.Gallery);

            if (!string.IsNullOrEmpty(report.Code))
                postBackUrl.Append(&quot;&amp;Code=&quot; + report.Code);

            return postBackUrl.ToString();
        }

        public string GetReportPageUrl&lt;T&gt;(ReportDetails report, HttpRequest Request, T row)
        {
            var postBackUrl = new StringBuilder();
            postBackUrl.Append((report.ReportType.ToLower().Equals(ReportHostType.dda.ToString()))
                ? @&quot;BrixReportpage.aspx?&quot;
                : @&quot;BrixListReportPage.aspx?ModuleID=&quot; + report.ModuleId + &quot;&amp;&quot;);

            postBackUrl.Append(&quot;&amp;ModelType=&quot; + ModelType.List);
            postBackUrl.Append(&quot;&amp;Context=&quot; + report.Context);

            if (!string.IsNullOrWhiteSpace(report.QueryStringParameters))
            {
                foreach (string qParam in report.QueryStringParameters.Split(&#39;,&#39;))
                {
                    if (!string.IsNullOrEmpty(Request[qParam]))
                        postBackUrl.Append(&quot;&amp;&quot; + qParam + &quot;=&quot; + Request[qParam]);
                }
            }

            if (!string.IsNullOrWhiteSpace(report.GridParameters) &amp;&amp; row != null)
            {
                foreach (string gParam in report.GridParameters.Split(&#39;;&#39;))
                {
                    if (MWGrid.ColumnExists(row, gParam.Split(&#39;,&#39;)[0]))
                    {
                        postBackUrl.Append(&quot;&amp;&quot; + gParam.Split(&#39;,&#39;)[1] + &quot;=&quot; +
                                           MWGrid.GetCellValue(row, gParam.Split(&#39;,&#39;)[0]));
                    }
                }
            }

            if (!string.IsNullOrEmpty(report.ParentModuleID))
                postBackUrl.Append(&quot;&amp;ParentContext=&quot; + report.ParentContext);

            postBackUrl.Append(&quot;&amp;ParentModuleID=&quot; + (report.ParentModuleID ?? report.ParentContext));

            if (!string.IsNullOrEmpty(report.Code))
                postBackUrl.Append(&quot;&amp;Code=&quot; + report.Code);

            return postBackUrl.ToString();
        }

        private bool HasPermission(ReportDetails report)
        {
            //return ModuleManager.Instance.GetPermissionByRole(report.ModuleId, UserDetail.GetCurrentUserDetail().RID).Contains(&quot;ReportGallery&quot;);
            return true;
        }

        public void CreateSubscription(string reportPath, DeliveryType type, object settings, string description,
            string eventType, SCHDefination defination, ParameterValue[] paraValues)
        {
            string SubscriptionID = ReportHelper.Instance.CreateSubscription(reportPath, type, settings, description,
                eventType, defination,
                ReportManager.Instance.GetSettingsOn(
                    ConnectionHelper.GetConnectionString(ConnectionHelper.GetCurrentCompany())), paraValues);
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                StoredProcedure.usp_RPTMGMTInsertReportSubscription, null, SubscriptionID, reportPath, DateTime.UtcNow,
                UserDetail.GetCurrentUserDetail().UID, GetDeliveryType(type), GetScheduleDetails(defination));
        }

        private string GetScheduleDetails(SCHDefination defination)
        {
            StringBuilder sd = new StringBuilder();

            if (defination.scheduleType != ScheduleType.Hourly)
                sd.AppendFormat(&quot;At {0}:{1}&quot;, defination.StartTimeHours, defination.StartTimeMinutes);
            switch (defination.scheduleType)
            {
                case ScheduleType.Daily:
                    if (defination.DaysInterval == 1)
                        sd.Append(&quot; every day&quot;);
                    else
                        sd.AppendFormat(&quot; every {0} day(s)&quot;, defination.DaysInterval);
                    break;

                case ScheduleType.DailyDOW:
                    sd.AppendFormat(&quot; every {0} of every week&quot;, GetDayOfWeeks(defination.DayOfWeeksSelector));
                    break;

                case ScheduleType.DailyWeekDays:
                    sd.Append(&quot; every Mon, Tue, Wed, Thu, Fri of every week&quot;);
                    break;

                case ScheduleType.Hourly:
                    sd.AppendFormat(&quot;Every {0} hour(s) and {1} minute(s)&quot;, defination.Hours, defination.Minutes);
                    break;

                case ScheduleType.MonthlyDays:
                    sd.AppendFormat(&quot; on day(s) {0} of {1}&quot;, defination.MonthCalendarDays,
                        GetMonths(defination.MonthSelector));
                    break;

                case ScheduleType.MonthlyDOW:
                    sd.AppendFormat(&quot; on the {0} {1} of {2}&quot;, GetWeekOfMonth(defination.WeekOfMonth),
                        GetDayOfWeeks(defination.DayOfWeeksSelector), GetMonths(defination.MonthSelector));
                    break;

                case ScheduleType.Once:
                    break;

                case ScheduleType.WeeklyDOW:
                    sd.AppendFormat(&quot; every {0} of every {0} weeks&quot;, GetDayOfWeeks(defination.DayOfWeeksSelector),
                        defination.WeekInterval);
                    break;
            }
            sd.AppendFormat(&quot;, starting {0}&quot;, defination.StartDate.ToString_WithFormatDateTime());
            if (defination.EndDate &gt;= MWDateTimeHelper.MWToday)
                sd.AppendFormat(&quot; and ending {0}&quot;, defination.EndDate.ToString_WithFormatDate());
            return sd.ToString();
        }

        private string GetWeekOfMonth(string weekOfMonth)
        {
            string weekOfmon = &quot;first&quot;;
            switch (weekOfMonth)
            {
                case &quot;SecondWeek&quot;:
                    weekOfmon = &quot;second&quot;;
                    break;

                case &quot;ThirdWeek&quot;:
                    weekOfmon = &quot;third&quot;;
                    break;

                case &quot;FourthWeek&quot;:
                    weekOfmon = &quot;fourth&quot;;
                    break;

                case &quot;LastWeek&quot;:
                    weekOfmon = &quot;last&quot;;
                    break;
            }
            return weekOfmon;
        }

        private object GetMonths(Dictionary&lt;Months, bool&gt; months)
        {
            StringBuilder month = new StringBuilder();
            int cnt = 0;
            foreach (KeyValuePair&lt;Months, bool&gt; mn in months)
            {
                if (mn.Value)
                {
                    cnt++;
                    switch (mn.Key)
                    {
                        case Months.January:
                            month.AppendFormat(&quot;, Jan&quot;);
                            break;

                        case Months.February:
                            month.AppendFormat(&quot;, Feb&quot;);
                            break;

                        case Months.March:
                            month.AppendFormat(&quot;, Mar&quot;);
                            break;

                        case Months.April:
                            month.AppendFormat(&quot;, Apr&quot;);
                            break;

                        case Months.May:
                            month.AppendFormat(&quot;, May&quot;);
                            break;

                        case Months.June:
                            month.AppendFormat(&quot;, Jun&quot;);
                            break;

                        case Months.July:
                            month.AppendFormat(&quot;, Jul&quot;);
                            break;

                        case Months.August:
                            month.AppendFormat(&quot;, Aug&quot;);
                            break;

                        case Months.September:
                            month.AppendFormat(&quot;, Sep&quot;);
                            break;

                        case Months.October:
                            month.AppendFormat(&quot;, Oct&quot;);
                            break;

                        case Months.November:
                            month.AppendFormat(&quot;, Nov&quot;);
                            break;

                        case Months.December:
                            month.AppendFormat(&quot;, Dec&quot;);
                            break;
                    }
                }
            }

            return (cnt == 12 ? &quot;every month&quot; : month.ToString().Trim(&#39;,&#39;).Trim());
        }

        private string GetDayOfWeeks(Dictionary&lt;WeekDays, bool&gt; weeks)
        {
            StringBuilder dayweeks = new StringBuilder();
            foreach (KeyValuePair&lt;WeekDays, bool&gt; wk in weeks)
            {
                if (wk.Value)
                {
                    switch (wk.Key)
                    {
                        case WeekDays.Sunday:
                            dayweeks.AppendFormat(&quot;, Sun&quot;);
                            break;

                        case WeekDays.Monday:
                            dayweeks.AppendFormat(&quot;, Mon&quot;);
                            break;

                        case WeekDays.Tuesday:
                            dayweeks.AppendFormat(&quot;, Tue&quot;);
                            break;

                        case WeekDays.Wednesday:
                            dayweeks.AppendFormat(&quot;, Wed&quot;);
                            break;

                        case WeekDays.Thursday:
                            dayweeks.AppendFormat(&quot;, Thu&quot;);
                            break;

                        case WeekDays.Friday:
                            dayweeks.AppendFormat(&quot;, Fri&quot;);
                            break;

                        case WeekDays.Saturday:
                            dayweeks.AppendFormat(&quot;, Sat&quot;);
                            break;
                    }
                }
            }
            return dayweeks.ToString().Trim(&#39;,&#39;).Trim();
        }

        private string GetDeliveryType(DeliveryType type)
        {
            switch (type)
            {
                case DeliveryType.ReportServerEmail:
                    return &quot;Email&quot;;

                case DeliveryType.WindowFileShare:
                    return &quot;File Share&quot;;

                default:
                    return &quot;Other&quot;;
            }
        }

        /// &lt;summary&gt;
        /// Extension   Description
        /// 1. XML      Renders a report in XML. The report opens in a browser. Additional transformations applied to this XML output may be a cost effective way of avoiding developing your own rendering extension.
        /// 2. CSV      Renders a report in comma-delimited format. The report opens in a viewing tool associated with CSV file formats.
        /// 3. IMAGE    Renders a report in a page-oriented format. The format is shown as TIFF in the Export drop-down of the report toolbar.
        /// 4. PDF      Renders a report in the Adobe Acrobat Reader. The format is shown as Acrobat (PDF) File in the Export drop-down of the report toolbar.
        /// 5. EXCEL    Renders a report in Microsoft Excel.
        /// 6. WORD     Render a report in Microsoft Word.
        /// 7. HTML 4.0 (part of the HTML rendering extension) HTML is the format used to initially render the report. If your browser support HTML 4.0, that is the format that is used. Otherwise, HTML 3.2 is used.
        /// 8. MHTML    (part of the HTML rendering extension) Renders a report in MHTML. The report opens in Internet Explorer. The format is shown as Web Archive in the Export drop-down of the report toolbar.
        /// 9. NULL     Does not render a report to a specific format. This rendering extension is useful for placing reports in cache. Null rendering should be used in conjunction with a scheduled execution or delivery.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;keyValuePair&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;report&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;fileName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;format&quot;&gt;&lt;/param&gt;
        public void RenderReportWithFormat(Dictionary&lt;string, string&gt; keyValuePair, string report, string fileName,
            string format)
        {
            if (ReportHelper.Instance.RptServer == null)
                ReportHelper.Instance.Connect(GetSettings());
            ReportHelper.Instance.RenderReportWithFormat(keyValuePair, report, fileName, format);
        }

        public void DeleteSubscription(string SubscriptionID)
        {
            var rs = GetSettings();
            if (ReportHelper.Instance.RptServer == null)
                ReportHelper.Instance.Connect(rs);
            ReportHelper.Instance.DeleteSubscription(SubscriptionID, rs);
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                StoredProcedure.usp_RPTMGMTDeleteReportSubscription, null, SubscriptionID);
        }

        public List&lt;ReportParameterDetails&gt; GetReportParameters(string reportName)
        {
            Dictionary&lt;string, string&gt; settings = GetSettings();

            if (settings.ContainsKey(&quot;Folder&quot;))
            {
                reportName = &quot;/&quot; + settings[&quot;Folder&quot;] + &quot;/&quot; + reportName;
            }
            return ReportHelper.Instance.GetReportParameters(reportName, settings);
        }
    }

    //[Context(Name = &quot;RPTMGMT&quot;)]
    //public class UserBreadCrumb : BreadCrumbBase
    //{
    //    public override string Title { get { return &quot;Administration&quot;; } }

    //    public override string URL { get { return &quot;#&quot;; } }

    //    public override BreadCrumbBase parent
    //    {
    //        get
    //        {
    //            return new RootBreadCrumb();
    //        }
    //    }
    //}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,32,1],[29,9,29,10,1],[30,9,30,10,1],[32,9,32,55,1],[38,9,38,10,1],[39,13,39,48,1],[40,13,40,38,1],[41,13,41,61,1],[42,13,42,92,1],[43,9,43,10,1],[47,9,47,10,1],[48,13,48,59,1],[49,13,51,48,1],[52,13,52,64,1],[53,13,53,83,1],[54,13,54,14,1],[55,17,55,24,1],[55,26,55,39,1],[55,40,55,42,1],[55,43,55,76,1],[56,17,56,18,1],[57,21,57,57,1],[58,21,58,73,1],[59,21,61,72,1],[62,21,62,81,1],[63,21,67,29,1],[67,29,67,30,0],[67,30,68,33,1],[68,33,68,77,0],[68,77,69,37,1],[69,37,69,121,0],[69,121,71,37,1],[71,37,71,64,0],[71,64,72,29,1],[72,29,72,30,0],[72,30,72,42,1],[63,21,72,42,1],[73,21,75,66,1],[76,21,76,62,1],[77,25,77,98,1],[78,21,78,62,1],[79,21,79,58,1],[80,21,80,83,1],[82,21,82,91,1],[83,21,83,100,1],[84,21,84,79,1],[85,21,87,66,1],[88,21,88,85,1],[89,21,89,117,1],[90,21,92,79,1],[93,21,95,72,1],[96,21,98,82,1],[100,21,100,50,1],[101,17,101,18,1],[102,13,102,14,1],[103,13,103,34,1],[104,9,104,10,1],[110,9,110,10,1],[113,13,113,75,1],[114,13,114,20,1],[114,22,114,45,1],[114,46,114,48,1],[114,49,114,62,1],[115,13,115,14,1],[116,17,116,47,1],[117,17,117,32,1],[118,17,118,18,1],[119,21,119,89,1],[120,21,120,58,1],[121,21,121,22,0],[122,25,122,73,0],[123,25,123,103,0],[124,25,124,26,0],[125,29,125,36,0],[126,33,126,49,0],[126,50,126,52,0],[127,37,127,115,0],[128,29,128,30,0],[129,33,129,89,0],[130,33,130,34,0],[131,37,131,116,0],[132,37,135,106,0],[136,33,136,34,0],[138,33,138,34,0],[139,37,143,72,0],[144,33,144,34,0],[145,29,145,30,0],[146,25,146,26,0],[147,21,147,22,0],[148,21,148,44,1],[149,21,149,22,1],[150,25,150,47,1],[151,29,155,68,0],[157,29,160,80,1],[161,21,161,22,1],[162,17,162,18,1],[163,13,163,14,1],[166,9,166,10,1],[169,9,169,10,1],[172,13,172,56,1],[173,13,173,14,1],[175,17,175,18,1],[176,21,176,86,1],[177,21,177,22,1],[178,32,178,112,1],[179,25,179,26,1],[180,29,180,95,1],[182,29,189,88,1],[190,29,190,56,1],[191,33,191,65,0],[193,29,193,30,1],[194,33,194,67,1],[195,33,195,81,1],[196,33,196,75,1],[197,33,197,75,1],[198,33,198,75,1],[199,33,199,87,1],[200,33,200,75,1],[201,33,201,77,1],[202,33,202,101,1],[203,33,203,87,1],[204,33,204,75,1],[205,33,205,79,1],[206,33,206,83,1],[207,29,207,30,1],[210,29,210,30,1],[211,33,211,57,1],[212,29,212,30,1],[213,29,213,48,0],[214,29,214,30,0],[215,33,215,154,0],[216,33,216,42,0],[219,29,219,42,1],[220,25,220,26,1],[223,25,224,67,1],[225,25,225,26,1],[226,29,226,65,1],[228,29,228,101,1],[229,33,229,130,0],[231,29,231,112,1],[232,33,232,168,0],[234,33,234,163,1],[236,29,236,90,1],[237,29,237,30,1],[238,33,238,169,1],[239,33,239,155,1],[240,29,240,30,1],[241,25,241,26,1],[242,25,242,41,1],[245,21,245,188,0],[246,21,246,31,0],[248,17,248,36,0],[249,17,249,18,0],[250,21,250,142,0],[251,21,251,31,0],[255,13,255,130,0],[256,13,256,23,0],[257,9,257,10,1],[260,9,260,10,1],[261,13,261,59,1],[262,13,263,23,1],[264,13,264,64,1],[265,13,265,45,1],[266,13,266,14,1],[267,17,267,107,1],[268,17,269,114,1],[270,21,272,58,1],[273,13,273,14,1],[275,13,275,34,1],[276,9,276,10,1],[279,9,279,10,1],[280,13,280,59,1],[281,13,282,71,1],[283,13,283,64,1],[284,13,284,45,1],[285,13,285,14,1],[286,17,286,107,1],[287,17,288,114,1],[289,21,291,58,1],[292,13,292,14,1],[294,13,294,34,1],[295,9,295,10,1],[298,9,298,10,0],[299,13,300,23,0],[302,13,302,20,0],[302,22,302,29,0],[302,30,302,32,0],[302,33,302,43,0],[303,13,303,14,0],[304,17,304,57,0],[305,17,305,18,0],[306,21,306,100,0],[307,25,308,98,0],[310,25,312,112,0],[313,17,313,18,0],[315,21,316,94,0],[317,13,317,14,0],[318,9,318,10,0],[321,9,321,10,0],[322,13,323,66,0],[325,13,325,20,0],[325,22,325,29,0],[325,30,325,32,0],[325,33,325,43,0],[326,13,326,14,0],[327,17,327,57,0],[328,17,328,18,0],[329,21,329,100,0],[330,25,331,98,0],[333,25,335,112,0],[336,17,336,18,0],[338,21,339,94,0],[340,13,340,14,0],[341,9,341,10,0],[345,9,345,10,1],[346,13,346,64,1],[348,13,348,92,1],[349,13,349,14,1],[350,17,350,24,1],[350,26,350,36,1],[350,37,350,39,1],[350,40,350,47,1],[351,17,351,18,1],[352,21,352,96,1],[353,17,353,18,1],[354,13,354,14,1],[355,13,355,32,1],[356,9,356,10,1],[359,9,359,10,0],[360,13,360,55,0],[361,13,361,14,0],[362,17,362,68,0],[363,17,363,52,0],[364,21,364,58,0],[365,13,365,14,0],[366,13,366,36,0],[367,9,367,10,0],[370,9,370,10,1],[371,13,371,74,1],[372,13,372,47,1],[373,13,373,14,1],[374,17,374,68,1],[375,13,375,14,1],[376,9,376,10,1],[379,9,379,10,1],[380,13,380,78,1],[382,13,382,56,1],[383,13,383,76,1],[385,13,391,59,1],[392,13,392,82,1],[393,13,393,32,1],[394,13,394,14,1],[395,17,395,29,1],[396,21,397,40,1],[398,22,398,39,1],[399,21,399,122,0],[401,21,401,99,1],[403,13,403,33,1],[404,9,404,10,1],[407,9,407,10,1],[408,13,408,51,1],[409,13,411,81,1],[413,13,414,86,1],[416,13,416,62,1],[417,17,417,78,1],[419,13,419,102,1],[421,13,421,67,1],[423,13,423,52,1],[424,17,424,60,0],[426,13,426,43,1],[427,9,427,10,1],[430,9,430,10,0],[431,13,431,51,0],[432,13,434,81,0],[436,13,436,64,0],[437,13,437,62,0],[439,13,439,74,0],[440,13,440,14,0],[441,17,441,24,0],[441,26,441,39,0],[441,40,441,42,0],[441,43,441,82,0],[442,17,442,18,0],[443,21,443,64,0],[444,25,444,82,0],[445,17,445,18,0],[446,13,446,14,0],[448,13,448,82,0],[449,13,449,14,0],[450,17,450,24,0],[450,26,450,39,0],[450,40,450,42,0],[450,43,450,75,0],[451,17,451,18,0],[452,21,452,72,0],[453,21,453,22,0],[454,25,455,92,0],[456,21,456,22,0],[457,17,457,18,0],[458,13,458,14,0],[460,13,460,62,0],[461,17,461,78,0],[463,13,463,102,0],[465,13,465,52,0],[466,17,466,60,0],[468,13,468,43,0],[469,9,469,10,0],[472,9,472,10,1],[474,13,474,25,1],[475,9,475,10,1],[479,9,479,10,0],[480,13,483,110,0],[484,13,486,111,0],[487,9,487,10,0],[490,9,490,10,0],[491,13,491,52,0],[493,13,493,64,0],[494,17,494,103,0],[495,13,495,45,0],[498,21,498,54,0],[499,25,499,49,0],[501,25,501,87,0],[502,21,502,27,0],[505,21,505,111,0],[506,21,506,27,0],[509,21,509,79,0],[510,21,510,27,0],[513,21,513,114,0],[514,21,514,27,0],[517,21,518,62,0],[519,21,519,27,0],[522,21,523,108,0],[524,21,524,27,0],[527,21,527,27,0],[530,21,531,50,0],[532,21,532,27,0],[534,13,534,99,0],[535,13,535,64,0],[536,17,536,98,0],[537,13,537,34,0],[538,9,538,10,0],[541,9,541,10,0],[542,13,542,40,0],[543,13,543,33,0],[546,21,546,42,0],[547,21,547,27,0],[550,21,550,41,0],[551,21,551,27,0],[554,21,554,42,0],[555,21,555,27,0],[558,21,558,40,0],[559,21,559,27,0],[561,13,561,30,0],[562,9,562,10,0],[565,9,565,10,0],[566,13,566,55,0],[567,13,567,25,0],[568,13,568,20,0],[568,22,568,51,0],[568,52,568,54,0],[568,55,568,61,0],[569,13,569,14,0],[570,17,570,30,0],[571,17,571,18,0],[572,21,572,27,0],[573,21,573,36,0],[576,29,576,57,0],[577,29,577,35,0],[580,29,580,57,0],[581,29,581,35,0],[584,29,584,57,0],[585,29,585,35,0],[588,29,588,57,0],[589,29,589,35,0],[592,29,592,57,0],[593,29,593,35,0],[596,29,596,57,0],[597,29,597,35,0],[600,29,600,57,0],[601,29,601,35,0],[604,29,604,57,0],[605,29,605,35,0],[608,29,608,57,0],[609,29,609,35,0],[612,29,612,57,0],[613,29,613,35,0],[616,29,616,57,0],[617,29,617,35,0],[620,29,620,57,0],[621,29,621,35,0],[623,17,623,18,0],[624,13,624,14,0],[626,13,626,84,0],[627,9,627,10,0],[630,9,630,10,0],[631,13,631,58,0],[632,13,632,20,0],[632,22,632,53,0],[632,54,632,56,0],[632,57,632,62,0],[633,13,633,14,0],[634,17,634,30,0],[635,17,635,18,0],[636,21,636,36,0],[639,29,639,60,0],[640,29,640,35,0],[643,29,643,60,0],[644,29,644,35,0],[647,29,647,60,0],[648,29,648,35,0],[651,29,651,60,0],[652,29,652,35,0],[655,29,655,60,0],[656,29,656,35,0],[659,29,659,60,0],[660,29,660,35,0],[663,29,663,60,0],[664,29,664,35,0],[666,17,666,18,0],[667,13,667,14,0],[668,13,668,57,0],[669,9,669,10,0],[672,9,672,10,0],[673,13,673,26,0],[676,21,676,36,0],[679,21,679,41,0],[682,21,682,36,0],[684,9,684,10,0],[704,9,704,10,0],[705,13,705,57,0],[706,17,706,62,0],[707,13,707,98,0],[708,9,708,10,0],[711,9,711,10,0],[712,13,712,36,0],[713,13,713,57,0],[714,17,714,51,0],[715,13,715,74,0],[716,13,717,92,0],[718,9,718,10,0],[721,9,721,10,0],[722,13,722,65,0],[724,13,724,48,0],[725,13,725,14,0],[726,17,726,74,0],[727,13,727,14,0],[728,13,728,84,0],[729,9,729,10,0]]);
    </script>
  </body>
</html>