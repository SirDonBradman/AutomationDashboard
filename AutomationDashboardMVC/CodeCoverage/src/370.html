<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Work Order\ViewWO.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.AMP3.WORKORDBL;
using Aurigo.AMP3.WORKORDDTO;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;
using System.Web.UI;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.AMP3.WORKORDUI
{
    public partial class ViewWO : BrixPageBase
    {
        protected UltraWebGrid uwgQuotItems, uwgQuotations, uwgPrepaymentTypes, uwgWOItems;
        protected global::System.Web.UI.HtmlControls.HtmlTableRow trExtReference;       
        private int _ContractID;
        private int _WorkOrderID;
        public string WorkOrderType { get; set; }

        /// &lt;summary&gt;
        /// attachments control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::Aurigo.AMP3.Core.UserControls.AttachmentsControl attachments;

        protected override void OnInit(EventArgs e)
        {
            WorkOrderDTO WODTO =
                WORKORDManager.Instance.GetWorkOrderDetails(Request.QueryString[WOConstants.QRY_WORKORDERID].ToInt32_2());
            if (WODTO != null)
            {
                WorkOrderType = WODTO.WorkOrderType;
                if (WorkOrderType.Equals(&quot;A&quot;))
                    Response.Redirect(
                        string.Format(CultureInfo.CurrentCulture,
                                      &quot;~/Modules/WORKORD/ViewACTIWO.aspx?&quot; + Constants.QRY_PROJECTID + &quot;=&quot; +
                                      (Request.QueryString[Constants.QRY_PROJECTID] ?? string.Empty) + &quot;&amp;&quot; +
                                      WOConstants.QRY_CONTRACTID + &quot;=&quot; +
                                      (Request.QueryString[WOConstants.QRY_CONTRACTID] ?? string.Empty) +
                                      &quot;&amp;WOID={0}&amp;ParentContext=CONTMGT&quot;, WODTO.WorkOrderID), false);
            }
            else
                WorkOrderType = string.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? &quot;W&quot; : Request[&quot;WOType&quot;];
            uwgWOItems.InitializeRow += uwgWOItems_InitializeRow;
            base.OnInit(e);
        }

        protected void uwgWOItems_InitializeRow(object sender, RowEventArgs e)
        {
            if (e.Row.Cells.Exists(&quot;IsShortClose&quot;) &amp;&amp; e.Row.Cells.FromKey(&quot;IsShortClose&quot;).Value.ToBoolean2())
            {
                e.Row.Style.BackColor = Color.LightGray;
            }
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            EnsureChildControls();
            UIHelper.DisableRoleSelection(Page);
            _ContractID = Request.QueryString[WOConstants.QRY_CONTRACTID].ToInt32_2();

            _WorkOrderID = Request.QueryString[WOConstants.QRY_WORKORDERID].ToInt32_2();
            txtId.Value = _WorkOrderID.ToString2();

            var featurelist = (List&lt;string&gt;) Context.Items[Constants.MODULE_PERMISSIONS];
            // lnkEdit.Enabled = featurelist.Contains(WOConstants.MODFEAT_EDIT);
            if (!featurelist.Contains(WOConstants.MODFEAT_VIEW))
            {
                string redurl;
                redurl = (Request[&quot;ES&quot;] != null)
                             ? &quot;~/Modules/ENTPRSE/CustomSearch.aspx&quot;
                             : &quot;~/Common/BrixListPage.aspx?context=WORKORD&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] +
                               &quot;&amp;ContractID=&quot; + Request[&quot;ContractID&quot;] + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;];
                UIHelper.RedirectURL(&quot;Do not have permissions to View Work Order.&quot;, redurl, null, Context);
                //    lnkPrint.Enabled = false;
                return;
            }

            if (WorkOrderType.Equals(&quot;E&quot;))
            {
                PageTitle = &quot;View Equipment Hire Order&quot;;
                trWithEquipment.Style.Value = trWithLabour.Style.Value = trWithMaterial.Style.Value = &quot;display:none&quot;;
            }

            List&lt;string&gt; coreComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
            if (!coreComponents.Contains(&quot;RateAnalysis&quot;))
            {
                trWithEquipment.Style.Value = trWithLabour.Style.Value = trWithMaterial.Style.Value = &quot;display:none&quot;;
            }

            //Load Work Order Details here
            if (!IsPostBack)
            {
                LoadWorkOrderInstanceDetails();
                hdnVisibleTab.Value = WOConstants.TAB_WO;
                if (!string.IsNullOrEmpty(Request[&quot;Tab&quot;]) &amp;&amp; Request[&quot;Tab&quot;] == WOConstants.TAB_QUOT)
                {
                    hdnVisibleTab.Value = WOConstants.TAB_QUOT;
                    Page.ClientScript.RegisterStartupScript(GetType(), &quot;S&quot;,
                                                           @&quot;showPane(document.getElementById(document.getElementById(&#39;&quot; +
                                                           hdnVisibleTab.ClientID + &quot;&#39;).value), true);&quot;, true);
                }

                attachments.InstanceID = _WorkOrderID.ToString2();
                attachments.SrcType = WOConstants.MODULE_NAME;
                attachments.ReadOnly = true;
            }
            tdSummary.InnerText = WorkOrderType.Equals(&quot;E&quot;) ? &quot;Summary of Equipments :&quot; : &quot;Summary of Quantities :&quot;;
            SetLabelsBasedOnWOType();

            litCurrency.Text = LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2());
        }

        private bool OnlyCustomerWONo
        {
            get
            {
                if (ViewState[&quot;OnlyCustomerWONo&quot;] == null)
                    ViewState[&quot;OnlyCustomerWONo&quot;] = (ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CONTMGT).Contains(&quot;OnlyCustomerWONo&quot;));
                return ViewState[&quot;OnlyCustomerWONo&quot;].ToBoolean2();
            }
        }

        private void SetLabelsBasedOnWOType()
        {
            string WOType = (WorkOrderType == &quot;E&quot; ? &quot;Hire&quot; : &quot;Work&quot;);
            lblOrderNo.Text = WOType + &quot; Order Number : &quot;;
            lblReqBy.Text = WOType + &quot; Order Requested By : &quot;;
            lblDate.Text = WOType + &quot; Order Date : &quot;;
            if (OnlyCustomerWONo)
                trExtReference.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
        }

        private void LoadWorkOrderInstanceDetails()
        {
            WorkOrderDTO WODTO =
                WORKORDManager.Instance.GetWorkOrderDetails(Request.QueryString[WOConstants.QRY_WORKORDERID].ToInt32_2());
            if (WODTO == null)
            {
                Page.ClientScript.RegisterStartupScript(GetType(), &quot;Instance deleted.&quot;,
                                                        &quot;&lt;script&gt; alert(&#39;The Work Order instance has been deleted.&#39;); document.location=&#39;&quot; +
                                                        &quot;~/Common/BrixListPage.aspx?context=WORKORD&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&quot;
                                                            .Format2(UIHelper.UrlEncode(Request[WOConstants.QRY_PROJECTID]),
                                                                     UIHelper.UrlEncode(_ContractID.ToString2())) + &quot;&#39;;&lt;/script&gt;&quot;);


                return;
            }

            lblWONO.Text = OnlyCustomerWONo ? WODTO.WorkOrderNo : WODTO.SystemWONo;
            lblExtReferenceVal.Text = WODTO.ExtReference;
            lblWOReqBy.Text = WODTO.WorkOrderRequestedBy;

            lblWODate.Text = WODTO.WorkOrderDate.ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture);
            lblContractor.Text = WODTO.Contractor;
            txtDesc.Text = WODTO.Description;
            txtNotes.Text = WODTO.Notes;
            txtScope.Text = WODTO.ScopeOfWork;
            txtTaxPayerID.Text = WODTO.TaxPayerID;
            txtLicenseCity.Text = WODTO.LicenseCity;
            txtLicenseState.Text = WODTO.LicenseState;
            txtInsurance.Text = WODTO.Insurance;

            txtDesc.ReadOnly =
                txtNotes.ReadOnly =
                txtScope.ReadOnly = true;

            chkWithMaterial.Checked = WODTO.WithMaterial;
            chkEquipment.Checked = WODTO.WithEquipment;
            chkLabour.Checked = WODTO.WithLabour;

            chkEquipment.Enabled = chkWithMaterial.Enabled = chkLabour.Enabled = false;

            lblStartDate.Text = WODTO.StartDate.ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture);
            lblEndDate.Text = WODTO.EndDate.ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture);

            tdStatus.InnerText = ((WODTO.Status == WOConstants.STAGE_DRAFT)
                                      ? &quot;Draft&quot;
                                      : ((WODTO.Status == WOConstants.STAGE_APPROVED)
                                             ? &quot;Approved&quot;
                                             : ((WODTO.Status == WOConstants.STAGE_ISSUED)
                                                    ? &quot;Issued&quot;
                                                    : ((WODTO.Status == WOConstants.STAGE_DRAFT_AMENDMENT)
                                                           ? &quot;Draft Amendment&quot;
                                                           : ((WODTO.Status == WOConstants.STAGE_APPROVE_AMENDMENT)
                                                                  ? &quot;Approved Amendment&quot;
                                                                  : &quot;Closed&quot;)
                                                      ))));

            tdCreatedBy.InnerText = WODTO.CreatedBy;
            tdCreatedOn.InnerText = WODTO.CreatedOn.ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture);
            //remove the above after adding the attribute in td

            if (WODTO.Status &gt;= WOConstants.STAGE_APPROVED &amp;&amp; WODTO.Status != WOConstants.STAGE_DRAFT_AMENDMENT)
            {
                tdApprovedBy.InnerText = WODTO.ApprovedBy;
                tdApprovedOn.InnerText = WODTO.ApprovedOn.ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture);

                if (WODTO.Status &gt;= WOConstants.STAGE_ISSUED &amp;&amp; WODTO.Status != WOConstants.STAGE_APPROVE_AMENDMENT)
                {
                    tdIssuedBy.InnerText = WODTO.IssuedBy;
                    tdIssuedOn.InnerText = WODTO.IssuedOn.ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture);
                }
                else
                {
                    trIssuedBy.Visible = false;
                }
            }
            else
            {
                trApprovedBy.Visible = false;
                trIssuedBy.Visible = false;
            }

            //Loading Item details here
            uwgWOItems.DataSource = WODTO.WorkOrderItems.Tables[0];
            uwgWOItems.DataBind();
            SetWOGridColumns(WODTO);

            #region Loading Prepayment Rule, Prepayment Types and Retention details

            DataSet dsRRDetails = WORKORDManager.Instance.GetRecoveryRetentionDetails(&quot;WORKORD&quot;, _WorkOrderID);
            //Table[0] - Recovery Details
            //Table[1] - Associated Prepayment Details
            //Table[2] - Retention Details

            string mode = string.Empty;
            if (dsRRDetails.Tables[0].Rows.Count != 0 &amp;&amp; dsRRDetails.Tables[1].Rows.Count != 0)
            {
                #region Loading Prepayment Rule

                DataRow row = dsRRDetails.Tables[0].Rows[0];

                mode = ((row[&quot;Prepaymentmode&quot;].ToString2() == &quot;False&quot; || row[&quot;Prepaymentmode&quot;].ToString2() == &quot;0&quot;)
                            ? WOConstants.MODE_AMOUNT
                            : WOConstants.MODE_PERCENTAGE);
                lblMaxPercentage.Text =
                    ((row[&quot;Prepaymentmode&quot;].ToString2() == &quot;True&quot; || row[&quot;Prepaymentmode&quot;].ToString2() == &quot;0&quot;)
                         ? row[&quot;Value&quot;].ToString2()
                         : &quot;0&quot;).ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
                lblMaxAmount.Text =
                    ((row[&quot;Prepaymentmode&quot;].ToString2() == &quot;False&quot; || row[&quot;Prepaymentmode&quot;].ToString2() == &quot;1&quot;)
                         ? row[&quot;Value&quot;].ToString2()
                         : &quot;0&quot;).ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                lblPrepaymentRule.Text = row[&quot;RecoveryRuleName&quot;].ToString2();

                #endregion

                #region Loading Prepayment Types

                DataTable dtTypes = dsRRDetails.Tables[1];
                dtTypes.Columns.Add(WOConstants.HEADING_RV_IN_RAB);
                string format = (mode == WOConstants.MODE_PERCENTAGE
                                     ? AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE
                                     : AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                foreach (DataRow rw in dtTypes.Rows)
                {
                    rw[WOConstants.HEADING_RV_IN_RAB] =
                        CalculateRecoveryValueInEachRAB(rw[&quot;RecoveryValue&quot;].ToString2(),
                                                        rw[&quot;PrepaymentValue&quot;].ToString2(), mode).ToDecimal2().ToString(
                                                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                    ;
                    rw[WOConstants.HEADING_AMOUNT_PAID] =
                        rw[WOConstants.HEADING_AMOUNT_PAID].ToDecimal2().ToString(format, CultureInfo.CurrentCulture).
                            ToDecimal2();
                    rw[WOConstants.HEADING_RECOVERED_AMOUNT] =
                        rw[WOConstants.HEADING_RECOVERED_AMOUNT].ToDecimal2().ToString(format,
                                                                                       CultureInfo.CurrentCulture).
                            ToDecimal2();
                }
                dtTypes.AcceptChanges();
                uwgPrepaymentTypes.DataSource = dtTypes;
                uwgPrepaymentTypes.DataBind();

                FormatPrepaymentTypesGrid(mode);

                CalculateAmountOrPercentage(mode);

                #endregion
            }

            if (dsRRDetails.Tables[2].Rows.Count != 0)
            {
                #region Loading Retention Details

                DataRow row1 = dsRRDetails.Tables[2].Rows[0];

                mode = ((row1[&quot;RetentionCeilingMode&quot;].ToString2() == &quot;False&quot; ||
                         row1[&quot;RetentionCeilingMode&quot;].ToString2() == &quot;0&quot;)
                            ? WOConstants.MODE_AMOUNT
                            : WOConstants.MODE_PERCENTAGE);
                lblRetentnCeiling.Text = (mode == WOConstants.MODE_PERCENTAGE
                                              ? &quot;Retention Ceiling Percentage :&quot;
                                              : &quot;Retention Ceiling Amount in &quot; +
                                                LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT,
                                                                                      _ContractID.ToString2()) + &quot; :&quot;);
                lblRetentionPercentage.Text =
                    (row1[&quot;RetentionPercentage&quot;].ToString2() == &quot;&quot; ? &quot;0&quot; : row1[&quot;RetentionPercentage&quot;]).ToDecimal2().
                        ToString(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
                lblRetentionCeilng.Text =
                    (row1[&quot;RetentionCeilingValue&quot;].ToString2() == &quot;&quot; ? &quot;0&quot; : row1[&quot;RetentionCeilingValue&quot;]).ToDecimal2()
                        .ToString(
                            mode == WOConstants.MODE_PERCENTAGE ? AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE : AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                            CultureInfo.CurrentCulture);
                lblRetentionRule.Text = row1[&quot;RetentionRuleName&quot;].ToString2();

                #endregion
            }

            #endregion

            BindQuotationData();
            if ((WODTO.Status == WOConstants.STAGE_ISSUED ||
                 WOManager.Instance.IsWorkFlowInProgress(WODTO.WorkOrderID.ToInt32_2())) &amp;&amp;
                MainToolBar.GetMenuReference(&quot;lnkEdit&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Enabled = false;
        }

        private void SetWOGridColumns(WorkOrderDTO WODTO)
        {
            string currency = LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL);
            ColumnsCollection cols = uwgWOItems.Columns;
            if (WorkOrderType.Equals(&quot;E&quot;))
            {
                if (cols.Exists(&quot;EquipmentID&quot;))
                    cols.FromKey(&quot;EquipmentID&quot;).Hidden = true;

                if (cols.Exists(&quot;UnitID&quot;))
                    cols.FromKey(&quot;UnitID&quot;).Hidden = true;

                if (cols.Exists(&quot;Number&quot;))
                {
                    cols.FromKey(&quot;Number&quot;).Header.Caption = &quot;No. of Equipments Required&quot;;
                    cols.FromKey(&quot;Number&quot;).Format =
                        CoreDatabaseHelper.GetNumberFormat(
                            CoreDatabaseHelper.GetDigitsGrouping(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT), 0);
                    cols.FromKey(&quot;Number&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                }

                if (cols.Exists(&quot;Duration&quot;))
                {
                    cols.FromKey(&quot;Duration&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                    cols.FromKey(&quot;Duration&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                }
                if (cols.Exists(&quot;Quantity&quot;))
                {
                    cols.FromKey(&quot;Quantity&quot;).Header.Caption = &quot;Quantity&quot;;
                    cols.FromKey(&quot;Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                    cols.FromKey(&quot;Quantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    cols.FromKey(&quot;Quantity&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                }
                if (cols.Exists(&quot;EstimatedUnitCost&quot;))
                {
                    cols.FromKey(&quot;EstimatedUnitCost&quot;).Header.Caption = &quot;Estimated Rate (&quot; + currency + &quot;)&quot;;
                    cols.FromKey(&quot;EstimatedUnitCost&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                    cols.FromKey(&quot;EstimatedUnitCost&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    cols.FromKey(&quot;EstimatedUnitCost&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                }
                if (cols.Exists(&quot;EstimatedAmount&quot;))
                {
                    cols.FromKey(&quot;EstimatedAmount&quot;).Header.Caption = &quot;Estimated Amount in &quot; + currency;
                    cols.FromKey(&quot;EstimatedAmount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                    cols.FromKey(&quot;EstimatedAmount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    cols.FromKey(&quot;EstimatedAmount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                }
                if (cols.Exists(&quot;ActualUnitCost&quot;))
                {
                    cols.FromKey(&quot;ActualUnitCost&quot;).Header.Caption = &quot;WO Rate (&quot; + currency + &quot;)&quot;;
                    cols.FromKey(&quot;ActualUnitCost&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                    cols.FromKey(&quot;ActualUnitCost&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    cols.FromKey(&quot;ActualUnitCost&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                }
                if (cols.Exists(&quot;WorkOrderAmount&quot;))
                {
                    cols.FromKey(&quot;WorkOrderAmount&quot;).Header.Caption = &quot;Work Order Amount in &quot; + currency;
                    cols.FromKey(&quot;WorkOrderAmount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                    cols.FromKey(&quot;WorkOrderAmount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    cols.FromKey(&quot;WorkOrderAmount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                }
                if (WODTO.Status &lt; WOConstants.STAGE_ISSUED || WODTO.Status == WOConstants.STAGE_DRAFT_AMENDMENT ||
                    WODTO.Status == WOConstants.STAGE_APPROVE_AMENDMENT)
                {
                    if (cols.Exists(&quot;WorkOrderAmount&quot;)) cols.FromKey(&quot;WorkOrderAmount&quot;).Hidden = true;
                    if (cols.Exists(&quot;ActualUnitCost&quot;)) cols.FromKey(&quot;ActualUnitCost&quot;).Hidden = true;
                }
            }
            else
            {
                cols.FromKey(&quot;ItemID&quot;).Hidden = true;
                if (WODTO.Status &gt;= WOConstants.STAGE_ISSUED &amp;&amp; WODTO.Status != WOConstants.STAGE_DRAFT_AMENDMENT &amp;&amp;
                    WODTO.Status != WOConstants.STAGE_APPROVE_AMENDMENT)
                {
                    cols.FromKey(&quot;UnitPrice&quot;).Hidden = false;
                    cols.FromKey(&quot;UnitPrice&quot;).Header.Caption = &quot;WO Rate (&quot; + currency + &quot;)&quot;;
                    cols.FromKey(&quot;UnitPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                    cols.FromKey(&quot;UnitPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    cols.FromKey(&quot;UnitPrice&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;

                    //trTotalWOAmount.Visible = true;
                }
                else
                {
                    cols.FromKey(&quot;UnitPrice&quot;).Hidden = true;
                    //trTotalWOAmount.Visible = false;
                }


                cols.FromKey(&quot;StandardItemNo.&quot;).Header.Caption = &quot;Standard Item No.&quot;;
                cols.FromKey(&quot;LineNo&quot;).Header.Caption = &quot;Line No.&quot;;

                //cols.FromKey(&quot;AvailableQuantity&quot;).Header.Caption = &quot;Available Quantity&quot;;
                //cols.FromKey(&quot;AvailableQuantity&quot;).Format = Constants.FORMAT_QUANTITY;
                //cols.FromKey(&quot;AvailableQuantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                //cols.FromKey(&quot;AvailableQuantity&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;AvailableQuantity&quot;).Hidden = true;

                cols.FromKey(&quot;WOQuantity&quot;).Header.Caption = &quot;WO Quantity&quot;;
                cols.FromKey(&quot;WOQuantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                cols.FromKey(&quot;WOQuantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;WOQuantity&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;

                cols.FromKey(&quot;ContractUnitPrice&quot;).Header.Caption = &quot;Estimated Rate (&quot; + currency + &quot;)&quot;;
                cols.FromKey(&quot;ContractUnitPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                cols.FromKey(&quot;ContractUnitPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;ContractUnitPrice&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;

                cols.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                cols.FromKey(&quot;Amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Amount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;CompletedQuantity&quot;).Hidden = true;
            }
            if (cols.Exists(&quot;Posted Quantity/MBook Quantity&quot;))
                cols.FromKey(&quot;Posted Quantity/MBook Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            if (cols.Exists(&quot;BilledQuantity&quot;))
            {
                cols.FromKey(&quot;BilledQuantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                cols.FromKey(&quot;BilledQuantity&quot;).Header.Caption = &quot;Total Billed Quantity&quot;;
            }
            if (cols.Exists(&quot;CertifiedQuantity&quot;))
            {
                cols.FromKey(&quot;CertifiedQuantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                cols.FromKey(&quot;CertifiedQuantity&quot;).Header.Caption = &quot;Total Certified Quantity&quot;;
            }
            if (cols.Exists(&quot;IsShortClose&quot;)) cols.FromKey(&quot;IsShortClose&quot;).Hidden = true;

            uwgWOItems.Height = Unit.Pixel(175);

            lblWOAmount.Text = Convert.ToDecimal(WODTO.TotalAmount).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                             CultureInfo.CurrentCulture);

            //If no quotation is awarded, show the total quantity as the sum of estimated amount
            if (WorkOrderType == &quot;E&quot; &amp;&amp; lblWOAmount.Text.ToDecimal2() == 0 &amp;&amp; uwgWOItems.Rows.Count &gt; 0 &amp;&amp;
                cols.Exists(&quot;EstimatedAmount&quot;))
            {
                decimal woTotalAmount = 0;
                for (int i = 0; i &lt; uwgWOItems.Rows.Count; i++)
                {
                    woTotalAmount += uwgWOItems.Rows[i].Cells.FromKey(&quot;EstimatedAmount&quot;).Value.ToDecimal2();
                }
                lblWOAmount.Text = Convert.ToDecimal(woTotalAmount).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                             CultureInfo.CurrentCulture);
            }

            //If no quotation is awarded, show the total quantity as the sum of amount
            if (WorkOrderType == &quot;W&quot; &amp;&amp; lblWOAmount.Text.ToDecimal2() == 0 &amp;&amp; uwgWOItems.Rows.Count &gt; 0 &amp;&amp;
                cols.Exists(&quot;Amount&quot;))
            {
                decimal woTotalAmount = 0;
                for (int i = 0; i &lt; uwgWOItems.Rows.Count; i++)
                {
                    woTotalAmount += uwgWOItems.Rows[i].Cells.FromKey(&quot;Amount&quot;).Value.ToDecimal2();
                }
                lblWOAmount.Text = Convert.ToDecimal(woTotalAmount).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                             CultureInfo.CurrentCulture);
            }


            decimal woAmt = 0;

            if (WODTO.WorkOrderType == &quot;E&quot;)
            {
                foreach (DataRow rw in WODTO.WorkOrderItems.Tables[0].Rows)
                {
                    woAmt += rw[&quot;Duration&quot;].ToDecimal2()*rw[&quot;Number&quot;].ToDecimal2()*rw[&quot;Quantity&quot;].ToDecimal2();
                }
            }
            else
            {
                foreach (DataRow rw in WODTO.WorkOrderItems.Tables[0].Rows)
                {
                    woAmt += rw[&quot;WOQuantity&quot;].ToDecimal2()*rw[&quot;ContractUnitPrice&quot;].ToDecimal2();
                }
            }

            hdnTotalAmt.Value = (WODTO.TotalAmount == 0 ? woAmt : WODTO.TotalAmount).ToString2();
        }

        private void BindQuotationData()
        {
            DataSet dsQuotations = WORKORDManager.Instance.GetQuotations(_WorkOrderID);

            uwgQuotations.DisplayLayout.NoDataMessage = &quot;No items to display&quot;;

            uwgQuotations.Height = Unit.Pixel(100);
            uwgQuotations.DataSource = dsQuotations.Tables[0];
            uwgQuotations.DataBind();

            ColumnsCollection cols = uwgQuotations.Columns;
            cols.FromKey(&quot;QuotationID&quot;).Hidden = true;
            cols.FromKey(&quot;ContractorID&quot;).Hidden = true;


            cols.FromKey(&quot;TotalAmount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            cols.FromKey(&quot;TotalAmount&quot;).Header.Caption = &quot;Amount&quot;;

            cols.FromKey(&quot;Date&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;

            cols.FromKey(&quot;% Over Low Bid&quot;).Format =
                cols.FromKey(&quot;% Over Contract&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE;

            cols.FromKey(&quot;TotalAmount&quot;).CellStyle.HorizontalAlign =
                cols.FromKey(&quot;% Over Low Bid&quot;).CellStyle.HorizontalAlign =
                cols.FromKey(&quot;% Over Contract&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            cols.FromKey(&quot;TotalAmount&quot;).Header.SelectedStyle.HorizontalAlign =
                cols.FromKey(&quot;% Over Low Bid&quot;).Header.SelectedStyle.HorizontalAlign =
                cols.FromKey(&quot;% Over Contract&quot;).Header.SelectedStyle.HorizontalAlign = HorizontalAlign.Right;

            RowsCollection rows = uwgQuotations.Rows;
            for (int i = 0; i &lt; rows.Count; i++)
            {
                int status = rows[i].Cells.FromKey(&quot;Status&quot;).Value.ToInt32_2();
                rows[i].Cells.FromKey(&quot;Status&quot;).Style.BackgroundImage = (status == WOConstants.QUOTATION_STAGE_REJECTED)
                                                                            ? &quot;../../Images/toolbar/IcnUnapprove.gif&quot;
                                                                            : (status ==
                                                                               WOConstants.QUOTATION_STAGE_AWARDED)
                                                                                  ? &quot;../../Images/toolbar/IcnAward.gif&quot;
                                                                                  : null;

                rows[i].Cells.FromKey(&quot;Status&quot;).Style.Padding.Left = new Unit(&quot;16px&quot;, CultureInfo.CurrentCulture);
                rows[i].Cells.FromKey(&quot;Status&quot;).Style.CustomRules = &quot;background-repeat: no-repeat&quot;;
                rows[i].Cells.FromKey(&quot;Status&quot;).Value = (status == WOConstants.QUOTATION_STAGE_REJECTED)
                                                            ? &quot;Rejected&quot;
                                                            : (status == WOConstants.QUOTATION_STAGE_AWARDED)
                                                                  ? &quot;Awarded&quot;
                                                                  : &quot;Received&quot;;
            }
        }

        protected void lnkEdit_Click(object sender, EventArgs e)
        {
            if (MainToolBar.GetMenuReference(&quot;lnkEdit&quot;) != null &amp;&amp; MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Enabled)
            {
                WorkOrderDTO WODTO = WORKORDManager.Instance.GetWorkOrderDetails(_WorkOrderID);
                if (WODTO == null)
                {
                    lblErr.Text = &quot;The work order instance may have been deleted by another user.&quot;;
                    return;
                }

                string queryString = WorkOrderType.Equals(&quot;E&quot;) ? &quot;&amp;WOType=E&quot; : string.Empty;
                Response.Redirect(
                    &quot;NewWorkOrder.aspx?Type=E&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID={2}&amp;ParentContext=CONTMGT{3}&quot;.Format2(
                        Request[WOConstants.QRY_PROJECTID], Request[WOConstants.QRY_CONTRACTID],
                        Request[WOConstants.QRY_WORKORDERID], queryString), false);
            }
        }

        protected void btnBack_Click(object sender, EventArgs e)
        {
            Response.Redirect(
                &quot;~/Common/BrixListPage.aspx?context=WORKORD&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&quot;.Format2(
                    Request[WOConstants.QRY_PROJECTID], Request[WOConstants.QRY_CONTRACTID]), false);
        }

        protected void lnkView_Click(object sender, EventArgs e)
        {
            if (hdnQuotationID == null || string.IsNullOrEmpty(hdnQuotationID.Value))
                return;

            DataSet ds = WORKORDManager.Instance.GetQuotation(hdnQuotationID.Value.ToInt32_2(), _WorkOrderID);
            if (ds.Tables[0].Rows.Count == 0)
                return;

            DataRow dr = ds.Tables[0].Rows[0];
            lblQuotContractor.Text = dr[&quot;Contractor&quot;].ToString2();
            lblQuotDate.Text = dr[&quot;Date&quot;].ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture);
            lblQuotTotal.Text = dr[&quot;TotalAmount&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                        CultureInfo.CurrentCulture);
            txtQNotes.Text = dr[&quot;Notes&quot;].ToString2();

            uwgQuotItems.DataSource = ds.Tables[1];
            uwgQuotItems.DataBind();
            SetQuotationItemsGridColumns();
            trQuotTemplate.Style.Add(&quot;display&quot;, &quot;block&quot;);

            if ((dr[&quot;WOStatus&quot;].ToInt32_2() == WOConstants.STAGE_ISSUED ||
                 WOManager.Instance.IsWorkFlowInProgress(_WorkOrderID)) &amp;&amp;
                MainToolBar.GetMenuReference(&quot;lnkEdit&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Enabled = false;

            hdnVisibleTab.Value = WOConstants.TAB_QUOT;
        }

        protected void lnkPrint_Click(object sender, EventArgs e)
        {
            if (MainToolBar.GetMenuReference(&quot;lnkPrint&quot;) != null &amp;&amp; MainToolBar.GetMenuReference(&quot;lnkPrint&quot;).Enabled)
            {
                //Common/BrixReportPage.aspx?Context=WORKORD&amp;MODID=WORKORD&amp;ParentID=&quot; + cid + &quot;&amp;WOID=&quot;+id + &quot;&amp;code=WOR&amp;PID=&quot;
                if (WorkOrderType.Equals(&quot;E&quot;))
                    Response.Redirect(
                        &quot;~/Common/BrixReportPage.aspx?Context=HIREQUP&amp;MODID=WORKORD&amp;ParentID={0}&amp;WOID={1}&amp;code=WOR&amp;PID={2}&amp;ParentModuleID=CONTMGT&quot;
                            .Format2(_ContractID, _WorkOrderID, Request[&quot;PID&quot;]), false);
                else
                    Response.Redirect(
                        &quot;~/Common/BrixReportPage.aspx?Context=WORKORD&amp;MODID=WORKORD&amp;ParentID={0}&amp;WOID={1}&amp;code=WOR&amp;PID={2}&amp;ParentModuleID=CONTMGT&quot;
                            .Format2(_ContractID, _WorkOrderID, Request[&quot;PID&quot;]), false);
            }

            return;
        }

        private void SetQuotationItemsGridColumns()
        {
            uwgQuotItems.DisplayLayout.NoDataMessage = &quot;No items to display&quot;;
            uwgQuotItems.Height = Unit.Pixel(100);
            if (WorkOrderType.Equals(&quot;E&quot;))
            {
                uwgQuotItems.Columns.FromKey(&quot;EquipmentID&quot;).Hidden = true;

                uwgQuotItems.Columns.FromKey(&quot;Duration&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                uwgQuotItems.Columns.FromKey(&quot;Duration&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                uwgQuotItems.Columns.FromKey(&quot;Duration&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;

                uwgQuotItems.Columns.FromKey(&quot;Number&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                uwgQuotItems.Columns.FromKey(&quot;Number&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                uwgQuotItems.Columns.FromKey(&quot;Number&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                uwgQuotItems.Columns.FromKey(&quot;Number&quot;).Header.Caption = &quot;No. of Equipments Required&quot;;
            }
            else
            {
                uwgQuotItems.Columns.FromKey(&quot;ItemID&quot;).Hidden = true;
            }

            uwgQuotItems.Columns.FromKey(&quot;Quantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
            uwgQuotItems.Columns.FromKey(&quot;Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            uwgQuotItems.Columns.FromKey(&quot;Quantity&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;

            uwgQuotItems.Columns.FromKey(&quot;Amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
            uwgQuotItems.Columns.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            uwgQuotItems.Columns.FromKey(&quot;Amount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            var featurelist = (List&lt;string&gt;) Context.Items[Constants.MODULE_PERMISSIONS];

            if (featurelist.Contains(WOConstants.MODFEAT_EDIT))
                menus.Add(new BrixMenu(&quot;lnkEdit&quot;, &quot;Edit&quot;, &quot;Icn_Edit.png&quot;, 55));

            //removed the report from the view mode, it will be available only in the list page
            //if (featurelist.Contains(WOConstants.MODFEAT_VIEW))
            //    menus.Add(new BrixMenu(&quot;lnkPrint&quot;, &quot;Report&quot;, &quot;Icn_Reports.png&quot;, 55));

            menus.Add(new BrixMenu(&quot;lnkBack&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;, 55));
            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            var featurelist = (List&lt;string&gt;) Context.Items[Constants.MODULE_PERMISSIONS];
            if (MainToolBar.GetMenuReference(&quot;lnkEdit&quot;) != null)
            {
                if (!featurelist.Contains(WOConstants.MODFEAT_EDIT))
                    MainToolBar.DisableMenu(&quot;lnkEdit&quot;);
                MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Click += lnkEdit_Click;
            }

            if (MainToolBar.GetMenuReference(&quot;lnkPrint&quot;) != null)
            {
                if (!featurelist.Contains(WOConstants.MODFEAT_VIEW))
                    MainToolBar.DisableMenu(&quot;lnkPrint&quot;);
                MainToolBar.GetMenuReference(&quot;lnkPrint&quot;).Click += lnkPrint_Click;
            }

            if (MainToolBar.GetMenuReference(&quot;lnkBack&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).Click += btnBack_Click;
        }

        #region Prepayment rule and retention rule association

        private void FormatPrepaymentTypesGrid(string mode)
        {
            ColumnsCollection cols = uwgPrepaymentTypes.Columns;
            uwgPrepaymentTypes.Width = 500;

            if (cols.Exists(WOConstants.HEADING_SL_NO))
                cols.FromKey(WOConstants.HEADING_SL_NO).Width = 40;

            if (cols.Exists(WOConstants.HEADING_PREPAYMENTVALUE))
            {
                cols.FromKey(WOConstants.HEADING_PREPAYMENTVALUE).Header.Caption = (mode == WOConstants.MODE_AMOUNT
                                                                                        ? &quot;Pre-payment Amount&quot;
                                                                                        : &quot;Pre-payment Percentage&quot;);
                cols.FromKey(WOConstants.HEADING_PREPAYMENTVALUE).Width = 125;
                cols.FromKey(WOConstants.HEADING_PREPAYMENTVALUE).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_PREPAYMENTVALUE).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_PREPAYMENTVALUE).Header.Caption =
                    cols.FromKey(WOConstants.HEADING_PREPAYMENTVALUE).Header.Caption + &quot; &quot; +
                    (mode == WOConstants.MODE_PERCENTAGE
                         ? &quot;&quot;
                         : &quot; in &quot; +
                           LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2()));
            }
            if (cols.Exists(WOConstants.HEADING_RECOVERYVALUE))
            {
                cols.FromKey(WOConstants.HEADING_RECOVERYVALUE).Header.Caption = (mode == WOConstants.MODE_AMOUNT
                                                                                      ? &quot;Recovery Amount&quot;
                                                                                      : &quot;Recovery Percentage&quot;);
                cols.FromKey(WOConstants.HEADING_RECOVERYVALUE).Width = 125;
                cols.FromKey(WOConstants.HEADING_RECOVERYVALUE).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_RECOVERYVALUE).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_RECOVERYVALUE).Header.Caption =
                    cols.FromKey(WOConstants.HEADING_RECOVERYVALUE).Header.Caption + &quot; &quot; +
                    (mode == WOConstants.MODE_PERCENTAGE
                         ? &quot;&quot;
                         : &quot; in &quot; +
                           LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2()));
            }
            if (cols.Exists(WOConstants.HEADING_RABNO))
            {
                cols.FromKey(WOConstants.HEADING_RABNO).Header.Caption = &quot;From RA Bill&quot;;
                cols.FromKey(WOConstants.HEADING_RABNO).Width = 100;
            }
            if (cols.Exists(WOConstants.HEADING_RV_IN_RAB))
            {
                cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Width = 125;
                cols.FromKey(WOConstants.HEADING_RV_IN_RAB).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Header.Caption =
                    cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Header.Caption + &quot; &quot; + &quot; in &quot; +
                    LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2());
            }

            if (cols.Exists(WOConstants.HEADING_AMOUNT_PAID))
            {
                cols.FromKey(WOConstants.HEADING_AMOUNT_PAID).Width = 100;
                cols.FromKey(WOConstants.HEADING_AMOUNT_PAID).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_AMOUNT_PAID).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_AMOUNT_PAID).Header.Caption =
                    cols.FromKey(WOConstants.HEADING_AMOUNT_PAID).Header.Caption + &quot; &quot; + &quot; in &quot; +
                    LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2());
            }

            if (cols.Exists(WOConstants.HEADING_RECOVERED_AMOUNT))
            {
                cols.FromKey(WOConstants.HEADING_RECOVERED_AMOUNT).Width = 100;
                cols.FromKey(WOConstants.HEADING_RECOVERED_AMOUNT).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_RECOVERED_AMOUNT).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(WOConstants.HEADING_RECOVERED_AMOUNT).Header.Caption =
                    cols.FromKey(WOConstants.HEADING_RECOVERED_AMOUNT).Header.Caption + &quot; &quot; + &quot; in &quot; +
                    LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2());
            }

            if (cols.Exists(&quot;PrepaymentTypeID&quot;))
            {
                cols.FromKey(&quot;PrepaymentTypeID&quot;).Hidden = true;
                if (cols.Exists(WOConstants.HEADING_RV_IN_RAB))
                    cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Move(5);
            }
            else if (cols.Exists(WOConstants.HEADING_RV_IN_RAB))
                cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Move(4);

            if (cols.Exists(&quot;PrepaymentType&quot;))
            {
                cols.FromKey(&quot;PrepaymentType&quot;).Header.Caption = WOConstants.HEADING_PREPAYMENTNAME;
                cols.FromKey(&quot;PrepaymentType&quot;).Width = 125;
            }

            if (cols.Exists(WOConstants.HEADING_PREPAYMENTNAME))
            {
                cols.FromKey(WOConstants.HEADING_PREPAYMENTNAME).Header.Caption = WOConstants.HEADING_PREPAYMENTNAME;
                cols.FromKey(WOConstants.HEADING_PREPAYMENTNAME).Width = 125;
            }

            if (mode == WOConstants.MODE_PERCENTAGE)
            {
                //Percentage Based Prepayment rule
                if (cols.Exists(WOConstants.HEADING_RV_IN_RAB))
                {
                    cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Hidden = false;
                    cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                }

                if (cols.Exists(WOConstants.HEADING_PREPAYMENTVALUE))
                    cols.FromKey(WOConstants.HEADING_PREPAYMENTVALUE).Format = AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE;

                if (cols.Exists(WOConstants.HEADING_RECOVERYVALUE))
                    cols.FromKey(WOConstants.HEADING_RECOVERYVALUE).Format = AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE;
            }
            else if (mode == WOConstants.MODE_AMOUNT)
            {
                //Amount Based Prepayment rule
                if (cols.Exists(WOConstants.HEADING_RV_IN_RAB))
                    cols.FromKey(WOConstants.HEADING_RV_IN_RAB).Hidden = true;

                if (cols.Exists(WOConstants.HEADING_PREPAYMENTVALUE))
                    cols.FromKey(WOConstants.HEADING_PREPAYMENTVALUE).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;

                if (cols.Exists(WOConstants.HEADING_RECOVERYVALUE))
                    cols.FromKey(WOConstants.HEADING_RECOVERYVALUE).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            }

            uwgPrepaymentTypes.DisplayLayout.AllowSortingDefault = AllowSorting.OnClient;
        }

        private decimal CalculateRecoveryValueInEachRAB(string RecoveryValue, string prepaymentValue, string mode)
        {
            string woAmt = hdnTotalAmt.Value;
            decimal rabRecoveryValue = 0;

            if (mode == WOConstants.MODE_PERCENTAGE)
            {
                decimal prepaymentAmt = decimal.Parse(prepaymentValue)/100*decimal.Parse(woAmt);
                rabRecoveryValue = (decimal.Parse(RecoveryValue)/100*prepaymentAmt);
            }
            return rabRecoveryValue;
        }

        private void CalculateAmountOrPercentage(string mode)
        {
            try
            {
                if (uwgWOItems.Rows.Count &gt; 0)
                {
                    if (mode == WOConstants.MODE_PERCENTAGE)
                        lblMaxAmount.Text =
                            (decimal.Parse(lblMaxPercentage.Text)/100*decimal.Parse(hdnTotalAmt.Value)).ToDecimal2().
                                ToString(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
                    else
                        lblMaxPercentage.Text =
                            (decimal.Parse(lblMaxAmount.Text)/decimal.Parse(hdnTotalAmt.Value)*100).ToDecimal2().
                                ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                }
            }
            catch
            {
            }
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,39,27,43,0],[27,44,27,48,0],[39,9,39,10,0],[40,13,41,123,0],[42,13,42,31,0],[43,13,43,14,0],[44,17,44,53,0],[45,17,45,47,0],[46,21,52,101,0],[53,13,53,14,0],[55,17,55,99,0],[56,13,56,66,0],[57,13,57,28,0],[58,9,58,10,0],[61,9,61,10,0],[62,13,62,110,0],[63,13,63,14,0],[64,17,64,57,0],[65,13,65,14,0],[66,9,66,10,0],[69,9,69,10,0],[70,13,70,35,0],[71,13,71,49,0],[72,13,72,87,0],[74,13,74,89,0],[75,13,75,52,0],[77,13,77,90,0],[79,13,79,65,0],[80,13,80,14,0],[82,17,85,110,0],[86,17,86,108,0],[88,17,88,24,0],[91,13,91,43,0],[92,13,92,14,0],[93,17,93,57,0],[94,17,94,118,0],[95,13,95,14,0],[97,13,97,109,0],[98,13,98,58,0],[99,13,99,14,0],[100,17,100,118,0],[101,13,101,14,0],[104,13,104,29,0],[105,13,105,14,0],[106,17,106,48,0],[107,17,107,58,0],[108,17,108,101,0],[109,17,109,18,0],[110,21,110,64,0],[111,21,113,112,0],[114,17,114,18,0],[116,17,116,67,0],[117,17,117,63,0],[118,17,118,45,0],[119,13,119,14,0],[120,13,120,117,0],[121,13,121,38,0],[123,13,123,120,0],[124,9,124,10,0],[129,13,129,14,0],[130,17,130,59,0],[131,21,131,153,0],[132,17,132,67,0],[133,13,133,14,0],[137,9,137,10,0],[138,13,138,70,0],[139,13,139,59,0],[140,13,140,63,0],[141,13,141,54,0],[142,13,142,34,0],[143,17,143,79,0],[144,9,144,10,0],[147,9,147,10,0],[148,13,149,123,0],[150,13,150,31,0],[151,13,151,14,0],[152,17,156,132,0],[159,17,159,24,0],[162,13,162,84,0],[163,13,163,58,0],[164,13,164,58,0],[166,13,166,133,0],[167,13,167,51,0],[168,13,168,46,0],[169,13,169,41,0],[170,13,170,47,0],[171,13,171,51,0],[172,13,172,53,0],[173,13,173,55,0],[174,13,174,49,0],[176,13,178,42,0],[180,13,180,58,0],[181,13,181,56,0],[182,13,182,50,0],[184,13,184,88,0],[186,13,186,132,0],[187,13,187,128,0],[189,13,200,60,0],[202,13,202,53,0],[203,13,203,136,0],[206,13,206,113,0],[207,13,207,14,0],[208,17,208,59,0],[209,17,209,142,0],[211,17,211,117,0],[212,17,212,18,0],[213,21,213,59,0],[214,21,214,142,0],[215,17,215,18,0],[217,17,217,18,0],[218,21,218,48,0],[219,17,219,18,0],[220,13,220,14,0],[222,13,222,14,0],[223,17,223,46,0],[224,17,224,44,0],[225,13,225,14,0],[228,13,228,68,0],[229,13,229,35,0],[230,13,230,37,0],[234,13,234,112,0],[239,13,239,40,0],[240,13,240,96,0],[241,13,241,14,0],[244,17,244,61,0],[246,17,248,60,0],[249,17,252,135,0],[253,17,256,131,0],[257,17,257,78,0],[263,17,263,59,0],[264,17,264,68,0],[265,17,267,88,0],[268,17,268,24,0],[268,26,268,36,0],[268,37,268,39,0],[268,40,268,52,0],[269,17,269,18,0],[270,21,273,137,0],[274,21,274,22,0],[275,21,277,42,0],[278,21,281,42,0],[282,17,282,18,0],[283,17,283,41,0],[284,17,284,57,0],[285,17,285,47,0],[287,17,287,49,0],[289,17,289,51,0],[292,13,292,14,0],[294,13,294,55,0],[295,13,295,14,0],[298,17,298,62,0],[300,17,303,60,0],[304,17,308,120,0],[309,17,311,114,0],[312,17,316,57,0],[317,17,317,79,0],[320,13,320,14,0],[324,13,324,33,0],[325,13,327,65,0],[328,17,328,73,0],[329,9,329,10,0],[332,9,332,10,0],[333,13,333,95,0],[334,13,334,57,0],[335,13,335,43,0],[336,13,336,14,0],[337,17,337,48,0],[338,21,338,63,0],[340,17,340,43,0],[341,21,341,58,0],[343,17,343,43,0],[344,17,344,18,0],[345,21,345,90,0],[346,21,348,118,0],[349,21,349,94,0],[350,17,350,18,0],[352,17,352,45,0],[353,17,353,18,0],[354,21,354,104,0],[355,21,355,96,0],[356,17,356,18,0],[357,17,357,45,0],[358,17,358,18,0],[359,21,359,74,0],[360,21,360,104,0],[361,21,361,96,0],[362,21,362,99,0],[363,17,363,18,0],[364,17,364,54,0],[365,17,365,18,0],[366,21,366,108,0],[367,21,367,115,0],[368,21,368,105,0],[369,21,369,108,0],[370,17,370,18,0],[371,17,371,52,0],[372,17,372,18,0],[373,21,373,104,0],[374,21,374,109,0],[375,21,375,103,0],[376,21,376,106,0],[377,17,377,18,0],[378,17,378,51,0],[379,17,379,18,0],[380,21,380,98,0],[381,21,381,112,0],[382,21,382,102,0],[383,21,383,105,0],[384,17,384,18,0],[385,17,385,52,0],[386,17,386,18,0],[387,21,387,105,0],[388,21,388,109,0],[389,21,389,103,0],[390,21,390,106,0],[391,17,391,18,0],[392,17,393,73,0],[394,17,394,18,0],[395,21,395,56,0],[395,57,395,103,0],[396,21,396,55,0],[396,56,396,101,0],[397,17,397,18,0],[398,13,398,14,0],[400,13,400,14,0],[401,17,401,54,0],[402,17,403,73,0],[404,17,404,18,0],[405,21,405,62,0],[406,21,406,93,0],[407,21,407,107,0],[408,21,408,97,0],[409,21,409,100,0],[412,17,412,18,0],[414,17,414,18,0],[415,21,415,61,0],[417,17,417,18,0],[420,17,420,86,0],[421,17,421,68,0],[427,17,427,65,0],[429,17,429,75,0],[430,17,430,102,0],[431,17,431,94,0],[432,17,432,97,0],[434,17,434,104,0],[435,17,435,111,0],[436,17,436,101,0],[437,17,437,104,0],[439,17,439,96,0],[440,17,440,90,0],[441,17,441,93,0],[442,17,442,65,0],[443,13,443,14,0],[444,13,444,63,0],[445,17,445,122,0],[446,13,446,47,0],[447,13,447,14,0],[448,17,448,106,0],[449,17,449,89,0],[450,13,450,14,0],[451,13,451,50,0],[452,13,452,14,0],[453,17,453,109,0],[454,17,454,95,0],[455,13,455,14,0],[456,13,456,45,0],[456,46,456,89,0],[458,13,458,49,0],[460,13,461,106,0],[464,13,465,48,0],[466,13,466,14,0],[467,17,467,43,0],[468,22,468,31,0],[468,33,468,58,0],[468,60,468,63,0],[469,17,469,18,0],[470,21,470,109,0],[471,17,471,18,0],[472,17,473,106,0],[474,13,474,14,0],[477,13,478,39,0],[479,13,479,14,0],[480,17,480,43,0],[481,22,481,31,0],[481,33,481,58,0],[481,60,481,63,0],[482,17,482,18,0],[483,21,483,100,0],[484,17,484,18,0],[485,17,486,106,0],[487,13,487,14,0],[490,13,490,31,0],[492,13,492,44,0],[493,13,493,14,0],[494,17,494,24,0],[494,26,494,36,0],[494,37,494,39,0],[494,40,494,75,0],[495,17,495,18,0],[496,21,496,112,0],[497,17,497,18,0],[498,13,498,14,0],[500,13,500,14,0],[501,17,501,24,0],[501,26,501,36,0],[501,37,501,39,0],[501,40,501,75,0],[502,17,502,18,0],[503,21,503,97,0],[504,17,504,18,0],[505,13,505,14,0],[507,13,507,98,0],[508,9,508,10,0],[511,9,511,10,0],[512,13,512,88,0],[514,13,514,79,0],[516,13,516,52,0],[517,13,517,63,0],[518,13,518,38,0],[520,13,520,60,0],[521,13,521,55,0],[522,13,522,56,0],[525,13,525,97,0],[526,13,526,67,0],[528,13,528,88,0],[530,13,531,109,0],[533,13,535,99,0],[537,13,539,110,0],[541,13,541,54,0],[542,18,542,27,0],[542,29,542,43,0],[542,45,542,48,0],[543,13,543,14,0],[544,17,544,80,0],[545,17,550,90,0],[552,17,552,115,0],[553,17,553,100,0],[554,17,558,80,0],[559,13,559,14,0],[560,9,560,10,0],[563,9,563,10,0],[564,13,564,116,0],[565,13,565,14,0],[566,17,566,96,0],[567,17,567,35,0],[568,17,568,18,0],[569,21,569,100,0],[570,21,570,28,0],[573,17,573,93,0],[574,17,577,84,0],[578,13,578,14,0],[579,9,579,10,0],[582,9,582,10,0],[583,13,585,102,0],[586,9,586,10,0],[589,9,589,10,0],[590,13,590,86,0],[591,17,591,24,0],[593,13,593,111,0],[594,13,594,46,0],[595,17,595,24,0],[597,13,597,47,0],[598,13,598,67,0],[599,13,599,149,0],[600,13,601,101,0],[602,13,602,54,0],[604,13,604,52,0],[605,13,605,37,0],[606,13,606,44,0],[607,13,607,58,0],[609,13,611,65,0],[612,17,612,73,0],[614,13,614,56,0],[615,9,615,10,0],[618,9,618,10,0],[619,13,619,118,0],[620,13,620,14,0],[622,17,622,47,0],[623,21,625,89,0],[627,21,629,89,0],[630,13,630,14,0],[632,13,632,20,0],[633,9,633,10,0],[636,9,636,10,0],[637,13,637,78,0],[638,13,638,51,0],[639,13,639,43,0],[640,13,640,14,0],[641,17,641,75,0],[643,17,643,108,0],[644,17,644,116,0],[645,17,645,111,0],[647,17,647,106,0],[648,17,648,114,0],[649,17,649,109,0],[650,17,650,102,0],[651,13,651,14,0],[653,13,653,14,0],[654,17,654,70,0],[655,13,655,14,0],[657,13,657,104,0],[658,13,658,112,0],[659,13,659,107,0],[661,13,661,102,0],[662,13,662,108,0],[663,13,663,105,0],[664,9,664,10,0],[667,9,667,10,0],[668,13,668,41,0],[669,13,669,90,0],[671,13,671,64,0],[672,17,672,80,0],[678,13,678,76,0],[679,13,679,44,0],[680,9,680,10,0],[683,9,683,10,0],[684,13,684,90,0],[685,13,685,65,0],[686,13,686,14,0],[687,17,687,69,0],[688,21,688,56,0],[689,17,689,80,0],[690,13,690,14,0],[692,13,692,66,0],[693,13,693,14,0],[694,17,694,69,0],[695,21,695,57,0],[696,17,696,82,0],[697,13,697,14,0],[699,13,699,65,0],[700,17,700,80,0],[701,9,701,10,0],[706,9,706,10,0],[707,13,707,65,0],[708,13,708,44,0],[710,13,710,56,0],[711,17,711,68,0],[713,13,713,66,0],[714,13,714,14,0],[715,17,717,117,0],[718,17,718,79,0],[719,17,719,117,0],[720,17,720,120,0],[721,17,726,117,0],[727,13,727,14,0],[728,13,728,64,0],[729,13,729,14,0],[730,17,732,112,0],[733,17,733,77,0],[734,17,734,115,0],[735,17,735,118,0],[736,17,741,117,0],[742,13,742,14,0],[743,13,743,56,0],[744,13,744,14,0],[745,17,745,89,0],[746,17,746,69,0],[747,13,747,14,0],[748,13,748,60,0],[749,13,749,14,0],[750,17,750,73,0],[751,17,751,111,0],[752,17,752,114,0],[753,17,755,109,0],[756,13,756,14,0],[758,13,758,62,0],[759,13,759,14,0],[760,17,760,75,0],[761,17,761,113,0],[762,17,762,116,0],[763,17,765,109,0],[766,13,766,14,0],[768,13,768,67,0],[769,13,769,14,0],[770,17,770,80,0],[771,17,771,118,0],[772,17,772,121,0],[773,17,775,109,0],[776,13,776,14,0],[778,13,778,49,0],[779,13,779,14,0],[780,17,780,64,0],[781,17,781,64,0],[782,21,782,73,0],[783,13,783,14,0],[784,18,784,65,0],[785,17,785,69,0],[787,13,787,47,0],[788,13,788,14,0],[789,17,789,100,0],[790,17,790,60,0],[791,13,791,14,0],[793,13,793,65,0],[794,13,794,14,0],[795,17,795,118,0],[796,17,796,78,0],[797,13,797,14,0],[799,13,799,53,0],[800,13,800,14,0],[802,17,802,64,0],[803,17,803,18,0],[804,21,804,80,0],[805,21,805,121,0],[806,17,806,18,0],[808,17,808,70,0],[809,21,809,131,0],[811,17,811,68,0],[812,21,812,129,0],[813,13,813,14,0],[814,18,814,54,0],[815,13,815,14,0],[817,17,817,64,0],[818,21,818,79,0],[820,17,820,70,0],[821,21,821,127,0],[823,17,823,68,0],[824,21,824,125,0],[825,13,825,14,0],[827,13,827,90,0],[828,9,828,10,0],[831,9,831,10,0],[832,13,832,46,0],[833,13,833,42,0],[835,13,835,53,0],[836,13,836,14,0],[837,17,837,97,0],[838,17,838,85,0],[839,13,839,14,0],[840,13,840,37,0],[841,9,841,10,0],[844,9,844,10,0],[846,13,846,14,0],[847,17,847,47,0],[848,17,848,18,0],[849,21,849,61,0],[850,25,852,122,0],[854,25,856,118,0],[857,17,857,18,0],[858,13,858,14,0],[859,13,859,18,0],[860,13,860,14,0],[861,13,861,14,0],[862,9,862,10,0]]);
    </script>
  </body>
</html>