<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\RFI\ConcreteModels\RFIListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.IO;
using System.Web;
using System.Web.UI;
using System.Xml;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.Brix.Constructon.RFI;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.WebUI.UltraWebGrid;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Platform.BusinessLayer.DTO;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.Brix.Construction.ContractManager.RFI
{
    [ListModelContext(Name = &quot;CONTRFI&quot;, Table = &quot;CONTRFIListView&quot;)]
    public class RFIListModel : ListModel, IWorkflowEnabledList
    {
        public override string QueryStringName
        {
            get { return &quot;ID&quot;; }
        }

        public override MenuArray Menus
        {
            get
            {
                MenuArray m = base.Menus;

                //int idx = 0, j = 1;
                //foreach (BrixMenu BMenu in m)
                //{
                //    if (BMenu.Id == &quot;lnkApprove&quot; &amp;&amp; BMenu.Name == &quot;Approve&quot;)
                //        j = idx + 1;
                //    ++idx;
                //}
                //BrixMenu mi = new BrixMenu(&quot;lnkSubmit&quot;, &quot;Submit&quot;, &quot;Icn_Approve.png&quot;);
                //if (j == 1)
                //{
                //    j = m.Count;
                //}
                //m.Insert(j-1, mi);
                //mi = new BrixMenu(&quot;lnkReject&quot;, &quot;Reject&quot;, &quot;Icn_Approve.png&quot;);
                //m.Insert(j, mi);
                return m;
            }
        }

        public override string ModuleId
        {
            get { return &quot;CONTRFI&quot;; }
        }

        private string ContractID { get; set; }

        private string RFIID { get; set; }

        private string ModuleID { get; set; }

        private string PID { get; set; }

        private bool HasApprovalWorkFlow
        {
            get
            {
                return
                    File.Exists(
                        ((Page)HttpContext.Current.Handler).Server.MapPath(@&quot;~/Modules/WORKFLW/&quot; + ModuleId + &quot;.xml&quot;));
            }
        }

        public override string[] DataSourceFilters
        {
            get { return new[] { &quot;ContractID&quot; }; }
        }

        public override string ParentIDKey
        {
            get { return &quot;ContractID&quot;; }
        }

        #region IWorkflowEnabledList Members

        public string FormName
        {
            get { return &quot;XRFIFRM&quot;; }
        }

        public string ListPrimaryKey
        {
            get { return &quot;ID&quot;; }
        }

        int IWorkflowEnabledList.PID
        {
            get { return Request[&quot;PID&quot;].ToInt32_2(); }
        }

        public int ParentModuleId
        {
            get { return Request[&quot;ContractID&quot;].ToInt32_2(); }
        }
        #endregion

        public override List&lt;MenuGroup&gt; MenuGroups
        {
            get
            {
                List&lt;MenuGroup&gt; menuGroups = base.MenuGroups;

                List&lt;string&gt; permissions = Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetPermissionByUserOrRole(&quot;CONTRFI&quot;, UserDetail.GetCurrentUserDetail().UID,
                    UserDetail.GetCurrentUserDetail().RID, PID.ToInt32_2());
                if (permissions.Contains(&quot;Settings&quot;))
                {
                    MenuGroup rfiDetails = new MenuGroup(&quot;Settings&quot;);
                    rfiDetails.AddMenu(new TextIcon(&quot;lnkRFISettings&quot;, &quot;Settings&quot;, &quot;Icn_Settings_16.png&quot;));

                    if (rfiDetails.Menus.Count &gt; 0)
                        menuGroups.Add(rfiDetails);
                }
                return menuGroups;
            }
        }

        public override void ApplyToolBarCustomisation(ToolBar toolBarArg)
        {
            base.ApplyToolBarCustomisation(toolBarArg);
            if (HttpContext.Current.Items.Contains(Constants.MODULE_PERMISSIONS))
            {
                var permissions = (HttpContext.Current.Items[Constants.MODULE_PERMISSIONS] as List&lt;string&gt;);

                if (toolBarArg.GetMenuReference(&quot;lnkNew&quot;) != null)
                    toolBarArg.GetMenuReference(&quot;lnkNew&quot;).Enabled = permissions.Contains(&quot;Create&quot;) &amp;&amp; BL.Instance.GetLockStatus(Convert.ToInt32(Request[&quot;ContractID&quot;]));
                if (toolBarArg.GetMenuReference(&quot;lnkEdit&quot;) != null)
                    toolBarArg.GetMenuReference(&quot;lnkEdit&quot;).Enabled = permissions.Contains(&quot;Edit&quot;) &amp;&amp; BL.Instance.GetLockStatus(Convert.ToInt32(Request[&quot;ContractID&quot;]));
                if (toolBarArg.GetMenuReference(&quot;lnkView&quot;) != null)
                    toolBarArg.GetMenuReference(&quot;lnkView&quot;).Enabled = permissions.Contains(&quot;View&quot;);
                if (toolBarArg.GetMenuReference(&quot;lnkDelete&quot;) != null)
                    toolBarArg.GetMenuReference(&quot;lnkDelete&quot;).Enabled = permissions.Contains(&quot;Delete&quot;) &amp;&amp; BL.Instance.GetLockStatus(Convert.ToInt32(Request[&quot;ContractID&quot;]));
                if (toolBarArg.GetMenuReference(&quot;lnkReport&quot;) != null)
                    toolBarArg.GetMenuReference(&quot;lnkReport&quot;).Enabled = permissions.Contains(&quot;Report&quot;);


                //if (toolBarArg.GetMenuReference(&quot;lnkSubmit&quot;) != null)
                //{
                //    //toolBarArg.GetMenuReference(&quot;lnkSubmit&quot;).Enabled = permissions.Contains(&quot;Submit&quot;);
                //    //toolBarArg.AddAttributeToMenu(&quot;lnkSubmit&quot;, &quot;onClick&quot;, &quot;return lnkValidation(&#39;&quot; + Convert.ToInt32(ValidateSelection.OneItem, CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; + brixGrid.ClientID + &quot;&#39;, &#39;&quot; + QueryStringName + &quot;&#39;);&quot;);
                //}
                //if (toolBarArg.GetMenuReference(&quot;lnkApprove&quot;) != null)
                //toolBarArg.GetMenuReference(&quot;lnkApprove&quot;).Enabled = permissions.Contains(&quot;Approve&quot;);
                //toolBarArg.GetMenuReference(&quot;lnkReject&quot;).Enabled = permissions.Contains(&quot;Reject&quot;);
                //toolBarArg.AddAttributeToMenu(&quot;lnkReject&quot;, &quot;onClick&quot;, &quot;return lnkValidation(&#39;&quot; + Convert.ToInt32(ValidateSelection.OneItem, CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; + brixGrid.ClientID + &quot;&#39;, &#39;&quot; + QueryStringName + &quot;&#39;);&quot;);
            }
        }

        public override void OnInit()
        {
            if (layout != null &amp;&amp; layout.Reports.Count &gt; 0)
            {
                foreach (ReportDetails report in layout.Reports)
                {
                    if (report.Context == &quot;RFIRPT&quot;)
                        report.Description = LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; report&quot;;
                }
            }
            base.OnInit();
        }

        public override void HandleEdit()
        {
            if (mwGrid != null)
            {
                var selectedDataItem = MWGrid.GetSelectedRow(mwGrid);
                if (selectedDataItem != null)
                {
                    //if (selectedRow.Cells.FromKey(&quot;Status&quot;).Value.Equals(&quot;Approved&quot;))
                    //{

                    //    throw new Exception(&quot;Approved RFI cannot be edited. Request Denied.&quot;);

                    //}
                    if (MWGrid.GetCellValue(selectedDataItem, &quot;Status&quot;).Equals(&quot;Rejected&quot;))
                    {
                        throw new Exception(&quot;Rejected &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; cannot be edited. Request Denied.&quot;);
                    }

                    RFIID = MWGrid.GetCellValue(selectedDataItem, QueryStringName);
                    ContractID = Request[&quot;ContractID&quot;];
                    PID = Request[&quot;PID&quot;];
                    ModuleID = &quot;CONTRFI&quot;;

                    Response.Redirect(
                        string.Format(
                            &quot;~/Modules/CONTRFI/NewRFI.aspx?PID={0}&amp;ParentID={1}&amp;Mode={2}&amp;InstanceID={3}&amp;ParentContext=CONTMGT&quot;,
                            PID, ContractID, &quot;Edit&quot;, RFIID), false);
                }
            }
        }

        public override string NewURL
        {
            get
            {
                ContractID = Request[&quot;ContractID&quot;];
                PID = Request[&quot;PID&quot;];
                ModuleID = &quot;CONTRFI&quot;;
                return string.Format(&quot;~/Modules/CONTRFI/NewRFI.aspx?PID={0}&amp;ParentID={1}&amp;Mode={2}&amp;ParentContext=CONTMGT&quot;, PID, ContractID, &quot;New&quot;);
            }
        }

        public override void HandleNew()
        {
            Response.Redirect(NewURL, false);
        }

        public override void HandleView()
        {
            if (mwGrid != null)
            {
                var selectedDataItem = MWGrid.GetSelectedRow(mwGrid);
                if (selectedDataItem != null)
                {
                    RFIID = MWGrid.GetCellValue(selectedDataItem, QueryStringName);
                    ContractID = Request[&quot;ContractID&quot;];
                    PID = Request[&quot;PID&quot;];
                    ModuleID = &quot;CONTRFI&quot;;

                    Response.Redirect(
                        string.Format(
                            &quot;~/Modules/CONTRFI/NewRFI.aspx?PID={0}&amp;ParentID={1}&amp;Mode={2}&amp;InstanceID={3}&amp;ParentContext=CONTMGT&quot;,
                            PID, ContractID, &quot;View&quot;, RFIID), false);
                }
            }
        }

        public override MenuHandlerStatus HandleApprove()
        {
            string msg = string.Empty;
            if (mwGrid != null)
            {
                var selectedDataItem = MWGrid.GetSelectedRow(mwGrid);
                if (selectedDataItem != null)
                {
                    RFIID = MWGrid.GetCellValue(selectedDataItem, QueryStringName);
                    ContractID = Request[&quot;ContractID&quot;];
                    PID = Request[&quot;PID&quot;];
                    ModuleID = &quot;CONTRFI&quot;;
                    if (!string.IsNullOrEmpty(RFIID))
                    {
                        //msg = RequestForInformationBL.Instance.UpdateStatus(RFIID.ToInt32_2(), RequestForInformationBL.RFIStatus.Approved.ToString2(),
                        //    UserDetail.GetCurrentUserDetail().UID, UserDetail.GetCurrentUserDetail().RID, String.IsNullOrEmpty(ApproveDate) ? DateTime.UtcNow : Convert.ToDateTime(ApproveDate));

                        RequestForInformationBL.Instance.AddDeductions(RFIID.ToInt32_2());
                        RequestForInformationBL.Instance.GetPEIDs(RFIID.ToInt32_2());
                    }
                }
            }
            return MenuHandlerStatus.GetSuccessObject(msg);
        }

        public override int HandleDelete()
        {
            string status = GetStatus();

            if (status == RFIStatus.Draft.ToString() || status == RFIStatus.Complete.ToString())
            {
                string selectedIds = FilterIdsToDeleteBasedOnWFDefinitions(FormName, PID.ToString2(), Request.QueryString[&quot;ContractID&quot;], GetSelectedIds());
                int returnValue = RequestForInformationBL.Instance.CUDRFIDetails(string.Empty, string.Empty,
                                                                                 GetSelectedRowXML(GetSelectedIds()),
                                                                                 null, null, &quot;D&quot;);
                ForceDeleteWorkflowsForThisForm(selectedIds, FormName);
                return returnValue;
            }
            else
            {
                throw new Exception(&quot;Only &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; record with Draft or Complete status will be able to delete.&quot;);
            }
        }

        private string GetSelectedRowXML(string str)
        {
            string returnValue = String.Empty;
            string[] collection = str.Split(&quot;,&quot;.ToCharArray());

            using (var sWr = new StringWriter())
            {
                using (var xWr = new XmlTextWriter(sWr))
                {
                    xWr.WriteStartElement(&quot;IDCollection&quot;);
                    foreach (string s in collection)
                    {
                        xWr.WriteStartElement(&quot;ID&quot;);
                        xWr.WriteElementString(&quot;RFIID&quot;, s);
                        xWr.WriteEndElement(); // End of ID
                    }
                    xWr.WriteEndElement(); // End of IDCollection

                    xWr.Flush();

                    returnValue = sWr.ToString();
                }
            }

            return returnValue;
        }

        public override string HandleMenuItem(string eventString)
        {
            if (mwGrid != null)
            {
                var selectedDataItem = MWGrid.GetSelectedRow(mwGrid);
                if (selectedDataItem != null)
                {
                    RFIID = MWGrid.GetCellValue(selectedDataItem, QueryStringName);
                }
            }
            string rfireport = LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;).ToString() + &quot; report&quot;;
            if (eventString.ToLower() == rfireport.ToLower())
                eventString = &quot;rfi report&quot;;

            switch (eventString.ToLower2())
            {
                //case &quot;unapprove&quot;:
                //case &quot;undo approve&quot;:
                //    string desiredStatus = HasApprovalWorkFlow ? RFIStatus.Approved.ToString2() : RFIStatus.Submitted.ToString2();
                //    RequestForInformationBL.Instance.UpdateStatus(RFIID.ToInt32_2(), desiredStatus, UserDetail.GetCurrentUserDetail().UID, UserDetail.GetCurrentUserDetail().RID, DateTime.UtcNow);
                //    break;
                case &quot;submit&quot;:
                    if (GetStatus() == RFIStatus.Complete.ToString2())
                        Response.Redirect(
                            string.Format(CultureInfo.CurrentCulture,
                                          &quot;~/Modules/CONTRFI/NewRFI.aspx?PID={0}&amp;ParentID={1}&amp;InstanceID={2}&amp;Mode=Edit&amp;Action={3}&amp;ParentContext=CONTMGT&quot;,
                                          Request[Constants.QRY_PROJECTID], Request[&quot;ContractID&quot;], RFIID,
                                          RFIStatus.Submitted), false);
                    else
                        ScriptManager.RegisterStartupScript(mwGrid.Page, mwGrid.Page.GetType(),
                                                            &quot;SubmittedValidation&quot;,
                                                            &quot;ShowError(&#39;Only &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; record with Complete status will be able to Submit.&#39;);&quot;,
                                                            true);
                    break;
                case &quot;reject&quot;:
                    if (GetStatus() == RFIStatus.Submitted.ToString2())
                        Response.Redirect(
                            string.Format(CultureInfo.CurrentCulture,
                                          &quot;~/Modules/CONTRFI/NewRFI.aspx?PID={0}&amp;ParentID={1}&amp;InstanceID={2}&amp;Mode=Edit&amp;Action={3}&amp;ParentContext=CONTMGT&quot;,
                                          Request[Constants.QRY_PROJECTID], Request[&quot;ContractID&quot;], RFIID,
                                          RFIStatus.Rejected), false);
                    else
                        ScriptManager.RegisterStartupScript(mwGrid.Page, mwGrid.Page.GetType(), &quot;RejectValidation&quot;,
                                                            &quot;ShowError(&#39;Only &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; record with Submitted status will be able to Reject.&#39;);&quot;,
                                                            true);
                    break;
                case &quot;approve&quot;:
                    if (GetStatus() == RFIStatus.Submitted.ToString2())
                        Response.Redirect(
                            string.Format(CultureInfo.CurrentCulture,
                                          &quot;~/Modules/CONTRFI/NewRFI.aspx?PID={0}&amp;ParentID={1}&amp;InstanceID={2}&amp;Mode=Edit&amp;Action={3}&amp;ParentContext=CONTMGT&quot;,
                                          Request[Constants.QRY_PROJECTID], Request[&quot;ContractID&quot;], RFIID,
                                          RFIStatus.Approved), false);
                    else
                        ScriptManager.RegisterStartupScript(mwGrid.Page, mwGrid.Page.GetType(), &quot;ApproveValidation&quot;,
                                                            &quot;ShowError(&#39;Only &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; record with Submitted status will be able to Approve.&#39;);&quot;,
                                                            true);
                    break;
                case &quot;rfi report&quot;:
                    isMenuClickHandled = true;
                    if (string.IsNullOrEmpty(RFIID))
                        throw new Exception(&quot;Please select a record.&quot;);
                    else
                    {
                        //Dictionary&lt;string, object&gt; retDic = new Dictionary&lt;string, object&gt;();
                        //int retVal = 0;
                        //DataSet reportDS = ComponentHelper.Instance.ExecuteDataSet(ContractManagerStoredProcedure.usp_RPTMGMTGetReports,
                        //    retDic, null, null, null, null, null, null, null, null, &quot;CONTRFI&quot;, null, null);
                        //if (retDic.ContainsKey(&quot;Result&quot;) &amp;&amp; Int32.TryParse(retDic[&quot;Result&quot;].ToString2(), out retVal))
                        //{
                        //    if (retVal &gt;= 0)
                        //    {
                        //        DataRow reportList = reportDS.Tables[0].Rows[0];
                        //        ReportDetails report = new ReportDetails(reportList);
                        //        System.Web.HttpContext.Current.Session.Add(&quot;reportDTO&quot;, report);
                        string queryString = &quot;Context=RFIRPT&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ContractID=&quot; +
                                             Request[&quot;ContractID&quot;] + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;] + &quot;&amp;InstanceID=&quot; + RFIID + &quot;&amp;ModuleID=CONTRFI&quot;;
                        Response.Redirect(&quot;~/Common/BrixListReportPage.aspx?&quot; + queryString, false);
                        //    }
                        //}
                    }
                    break;

                case &quot;settings&quot;:
                    Response.Redirect(string.Format(&quot;~/Modules/CONTRFI/RFISettings.aspx?Context={0}&amp;PID={1}&amp;ContractID={2}&amp;ParentID={3}&quot;,
                    Request[&quot;Context&quot;],
                    Request[&quot;PID&quot;],
                    Request[&quot;ContractID&quot;],
                    Request[&quot;ParentID&quot;]), true);
                    break;


                default:
                    return base.HandleMenuItem(eventString);
            }
            return string.Empty;
        }

        private string GetStatus()
        {
            return (MWGrid.GetSelectedRow(mwGrid) != null)
                       ? (MWGrid.ColumnExists(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;)
                              ? MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).ToString2()
                              : &quot;&quot;)
                       : &quot;&quot;;
        }

        public override void SetUIDetails()
        {
            Header = LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; List&quot;;
            //Header = &quot;Request For Payment List&quot;;

            ModifyColumnProperties(&quot;Multi&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ContractID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Status&quot;, false, null, null, null, false);
            ModifyColumnProperties(&quot;SubmittedDate&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;SubmittedDesignation&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;SubmittedBy&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ApprovedDesignation&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ApprovedBy&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;CreatedBy&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Location&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Area&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;DrawingNumber&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RevisionNumber&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Address&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;KindAttention&quot;, true, null, null, null, false);

            ModifyColumnProperties(&quot;CreatedDate&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;Created Date&quot;);
            ModifyColumnProperties(&quot;RFIDate&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Date&quot;);
            ModifyColumnProperties(&quot;InspectionDate&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;Inspection Date&quot;);
            ModifyColumnProperties(&quot;ApprovedDate&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;Approved Date&quot;);
            ModifyColumnProperties(&quot;InspectionTime&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;JobNumber&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Created&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RFINumber&quot;, true, null, null, null, false, LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Number&quot;);
            ModifyColumnProperties(&quot;RefNumber&quot;, false, null, null, null, false, &quot;Ref Number&quot;);
            ModifyColumnProperties(&quot;RFI Number&quot;, false, null, null, null, false, LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Number&quot;);

            if (Request != null)
            {
                EnableNew =
                    EnableEdit = EnableDelete = BL.Instance.GetLockStatus(Convert.ToInt32(Request[&quot;ContractID&quot;]));
            }

            //            DisplayApprove = 
            DisplayApplyFilter = true;
            DisplayReport = false;
            //TODO:Merge - new workflow
            // DisplayWorkFlow = HasApprovalWorkFlow;

            instanceIDColumn = &quot;ID&quot;;
            createDateColumn = &quot;SubmittedDate&quot;;
        }

        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int CurrentPage,
                                        out int count)
        {
            DataSet gridData = base.GetList(pageSize, sortOrder, filter, ref CurrentPage, out count);
            //string selectedIds = GetSelectedIds();
            //if (!string.IsNullOrEmpty(selectedIds) &amp;&amp; selectedIds.Split(&#39;,&#39;).Length &lt; 2)
            //{
            //    int instanceId = selectedIds.ToInt32_2();
            //    string status = UpdateRecordStatus(instanceId);
            //    if (!string.IsNullOrEmpty(status))
            //        gridData.Tables[0].Select(QueryStringName + &quot; = &quot; + instanceId)[0][&quot;Status&quot;] = status;
            //}
            return gridData;
        }

        //private string UpdateRecordStatus(int instanceId)
        //{
        //    if (HasApprovalWorkFlow)
        //    {
        //        WFitem item = new WFitem(instanceId, this.ModuleId, null, null);
        //        DataTable dt = new WorkflowFactory(null, null).GetWorkflowUsersHistory(item.Id, instanceId, this.ModuleId);
        //        int stageCompleted = dt.Select(&quot;Completed = true&quot;).Length;
        //        string status = RequestForInformationBL.RFIStatus.Approved.ToString2();
        //        if (stageCompleted == dt.Rows.Count)
        //        {

        //            RequestForInformationBL.Instance.UpdateStatus(instanceId, status, UserDetail.GetCurrentUserDetail().UID,
        //                UserDetail.GetCurrentUserDetail().RID, DateTime.UtcNow);
        //            return status;
        //        }
        //    }
        //    return string.Empty;
        //}

        public override bool PerformServerValidation(string key)
        {
            if (MWGrid.GetSelectedRow(mwGrid) != null)
            {
                if (key.Equals(&quot;ReOpen&quot;) &amp;&amp; MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Approved&quot;))
                    throw new Exception(&quot;Approved &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; cannot be reopened.&quot;);
                if (MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Approved&quot;))
                {
                    if (key.Equals(&quot;Approve&quot;))
                        throw new Exception(&quot;Selected &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; is already Approved.&quot;);
                }
                else if (MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Rejected&quot;) &amp;&amp; key.Equals(&quot;Reject&quot;))
                {
                    throw new Exception(&quot;Selected &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; is already Rejected&quot;);
                }
                if (key.Equals(&quot;Approve&quot;))
                {
                    if (!MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Submitted&quot;))
                    {
                        throw new Exception(&quot;Only &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; record with Submit status will be able to Approve&quot;);
                    }
                    DataSet dsRFI =
                        RequestForInformationBL.Instance.GetRFIDetails(
                            Convert.ToInt32(MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Id&quot;)));
                    DataRow detailRow = dsRFI.Tables[0].Rows[0];
                    if (detailRow != null)
                    {
                        if (String.IsNullOrEmpty(detailRow[&quot;ApprovedDesignation&quot;].ToString2()) ||
                            detailRow[&quot;ApprovedDesignation&quot;].Equals(DBNull.Value)
                            || String.IsNullOrEmpty(detailRow[&quot;Approved By&quot;].ToString2()) ||
                            detailRow[&quot;Approved By&quot;].Equals(DBNull.Value)
                            || String.IsNullOrEmpty(detailRow[&quot;ReceivedBy&quot;].ToString2()) ||
                            detailRow[&quot;ReceivedBy&quot;].Equals(DBNull.Value)
                            || String.IsNullOrEmpty(detailRow[&quot;ReceivedDate&quot;].ToString2()) ||
                            detailRow[&quot;ReceivedDate&quot;].Equals(DBNull.Value)
                            || String.IsNullOrEmpty(detailRow[&quot;ReceivedTime&quot;].ToString2()) ||
                            detailRow[&quot;ReceivedTime&quot;].Equals(DBNull.Value)
                            || String.IsNullOrEmpty(detailRow[&quot;ApprovedOwner&quot;].ToString2()) ||
                            detailRow[&quot;ApprovedOwner&quot;].Equals(DBNull.Value))
                        {
                            throw new Exception(&quot;Please Enter Client details before Approving.&quot;);
                        }
                    }
                    else
                    {
                        throw new Exception(&quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Can not be Approved&quot;);
                    }
                    if (dsRFI.Tables.Count &gt; 1)
                    {
                        if (dsRFI.Tables[1].Select(&quot;[MB Quantity] IS NULL&quot;).Length &gt; 0)
                        {
                            throw new Exception(&quot;&quot; + LocalizationManager.GetString(&quot;LOC_MeasurementBook&quot;) + &quot; Quantity is not entered for one or more line items. Request denied.&quot;);
                        }
                        if (dsRFI.Tables[1].Select(&quot;[Certified Quantity]  IS NULL&quot;).Length &gt; 0)
                        {
                            throw new Exception(
                                &quot;Certified quantity is not entered for one or more line items. Request denied.&quot;);
                        }
                    }
                    else
                    {
                        throw new Exception(&quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Can not be Approved&quot;);
                    }
                }
                else if (key.Equals(&quot;Reject&quot;))
                {
                    if (!MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Submitted&quot;))
                    {
                        throw new Exception(&quot;Only &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; record with Submit status will be able to Reject&quot;);
                    }
                    DataRow detailRow =
                        RequestForInformationBL.Instance.GetRFIDetails(
                            Convert.ToInt32(MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Id&quot;))).Tables[0].Rows[0];
                    if (detailRow != null)
                    {
                        if (detailRow[&quot;Approved By&quot;].Equals(DBNull.Value) ||
                            detailRow[&quot;ApprovedDate&quot;].Equals(DBNull.Value) ||
                            detailRow[&quot;ReceivedBy&quot;].Equals(DBNull.Value) ||
                            detailRow[&quot;ReceivedDate&quot;].Equals(DBNull.Value) ||
                            detailRow[&quot;ReceivedTime&quot;].Equals(DBNull.Value) ||
                            detailRow[&quot;ApprovedOwner&quot;].Equals(DBNull.Value))
                        {
                            throw new Exception(&quot;Please Enter Client details before Rejecting.&quot;);
                        }
                    }
                    else
                    {
                        throw new Exception(&quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Can not be Rejected&quot;);
                    }
                }
            }

            return true;
        }

        public override BrixFilter[] GetApplyFilterLabels()
        {
            var filters = new BrixFilter[5];

            // Todo: Need to implement RFI number filtering fully
            filters[0] = new BrixFilter();
            filters[0].Title = LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Number&quot;;
            filters[0].Name = &quot;RFINumber&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[4] = new BrixFilter();
            filters[4].Title = &quot;Ref No.&quot;;
            filters[4].Name = &quot;RefNumber&quot;;
            filters[4].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Status&quot;;
            filters[1].Name = &quot;Status&quot;;
            filters[1].FilterType = BrixFilter.Type.Combo;
            filters[1].Values = new Dictionary&lt;string, string&gt;();
            filters[1].Values[&quot;Draft&quot;] = RFIStatus.Draft.ToString2();
            filters[1].Values[&quot;Complete&quot;] = RFIStatus.Complete.ToString2();
            filters[1].Values[&quot;Submitted&quot;] = RFIStatus.Submitted.ToString2();
            filters[1].Values[&quot;Approved&quot;] = RFIStatus.Approved.ToString2();
            filters[1].Values[&quot;Rejected&quot;] = RFIStatus.Rejected.ToString2();
            filters[1].DataSource = new DataTable();

            filters[2] = new BrixFilter();
            filters[2].Title = LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Date.&quot;;
            filters[2].Name = &quot;RFIDate&quot;;
            filters[2].FilterType = BrixFilter.Type.Date;


            filters[3] = new BrixFilter();
            filters[3].Title = &quot;Created By&quot;;
            filters[3].Name = &quot;Created&quot;;
            filters[3].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        public override string GetEditPageURL(string pID, string parentID, string instanceID, string context)
        {
            return
                string.Format(
                    &quot;~/Modules/CONTRFI/NewRFI.aspx?Mode=Edit&amp;PID={0}&amp;ParentID={1}&amp;InstanceID={2}&amp;ParentContext=CONTMGT&quot;,
                    pID, parentID, instanceID);
        }

        public override string GetViewPageURL(string pID, string parentID, string instanceID, string context)
        {
            return
                string.Format(
                    &quot;~/Modules/CONTRFI/NewRFI.aspx?Mode=View&amp;PID={0}&amp;ParentID={1}&amp;InstanceID={2}&amp;ParentContext=CONTMGT&quot;,
                    pID, parentID, instanceID);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,17,28,18,0],[28,19,28,31,0],[28,32,28,33,0],[34,13,34,14,0],[35,17,35,42,0],[52,17,52,26,0],[53,13,53,14,0],[58,17,58,18,0],[58,19,58,36,0],[58,37,58,38,0],[61,37,61,41,0],[61,42,61,46,0],[63,32,63,36,0],[63,37,63,41,0],[65,35,65,39,0],[65,40,65,44,0],[67,30,67,34,0],[67,35,67,39,0],[72,13,72,14,0],[73,17,75,120,0],[76,13,76,14,0],[81,17,81,18,0],[81,19,81,49,0],[81,50,81,51,0],[86,17,86,18,0],[86,19,86,39,0],[86,40,86,41,0],[93,17,93,18,0],[93,19,93,36,0],[93,37,93,38,0],[98,17,98,18,0],[98,19,98,31,0],[98,32,98,33,0],[103,17,103,18,0],[103,19,103,53,0],[103,54,103,55,0],[108,17,108,18,0],[108,19,108,60,0],[108,61,108,62,0],[115,13,115,14,0],[116,17,116,62,0],[118,17,119,77,0],[120,17,120,54,0],[121,17,121,18,0],[122,21,122,70,0],[123,21,123,107,0],[125,21,125,52,0],[126,25,126,52,0],[127,17,127,18,0],[128,17,128,35,0],[129,13,129,14,0],[133,9,133,10,0],[134,13,134,56,0],[135,13,135,82,0],[136,13,136,14,0],[137,17,137,109,0],[139,17,139,67,0],[140,21,140,169,0],[141,17,141,68,0],[142,21,142,168,0],[143,17,143,68,0],[144,21,144,99,0],[145,17,145,70,0],[146,21,146,172,0],[147,17,147,70,0],[148,21,148,103,0],[160,13,160,14,0],[161,9,161,10,0],[164,9,164,10,0],[165,13,165,60,0],[166,13,166,14,0],[167,17,167,24,0],[167,26,167,46,0],[167,47,167,49,0],[167,50,167,64,0],[168,17,168,18,0],[169,21,169,52,0],[170,25,170,116,0],[171,17,171,18,0],[172,13,172,14,0],[173,13,173,27,0],[174,9,174,10,0],[177,9,177,10,0],[178,13,178,32,0],[179,13,179,14,0],[180,17,180,70,0],[181,17,181,46,0],[182,17,182,18,0],[189,21,189,92,0],[190,21,190,22,0],[191,25,191,157,0],[194,21,194,84,0],[195,21,195,56,0],[196,21,196,42,0],[197,21,197,42,0],[199,21,202,69,0],[203,17,203,18,0],[204,13,204,14,0],[205,9,205,10,0],[210,13,210,14,0],[211,17,211,52,0],[212,17,212,38,0],[213,17,213,38,0],[214,17,214,147,0],[215,13,215,14,0],[219,9,219,10,0],[220,13,220,46,0],[221,9,221,10,0],[224,9,224,10,0],[225,13,225,32,0],[226,13,226,14,0],[227,17,227,70,0],[228,17,228,46,0],[229,17,229,18,0],[230,21,230,84,0],[231,21,231,56,0],[232,21,232,42,0],[233,21,233,42,0],[235,21,238,69,0],[239,17,239,18,0],[240,13,240,14,0],[241,9,241,10,0],[244,9,244,10,0],[245,13,245,39,0],[246,13,246,32,0],[247,13,247,14,0],[248,17,248,70,0],[249,17,249,46,0],[250,17,250,18,0],[251,21,251,84,0],[252,21,252,56,0],[253,21,253,42,0],[254,21,254,42,0],[255,21,255,54,0],[256,21,256,22,0],[260,25,260,91,0],[261,25,261,86,0],[262,21,262,22,0],[263,17,263,18,0],[264,13,264,14,0],[265,13,265,60,0],[266,9,266,10,0],[269,9,269,10,0],[270,13,270,41,0],[272,13,272,97,0],[273,13,273,14,0],[274,17,274,156,0],[275,17,277,99,0],[278,17,278,72,0],[279,17,279,36,0],[282,13,282,14,0],[283,17,283,172,0],[285,9,285,10,0],[288,9,288,10,0],[289,13,289,47,0],[290,13,290,64,0],[292,20,292,48,0],[293,13,293,14,0],[294,24,294,56,0],[295,17,295,18,0],[296,21,296,59,0],[297,21,297,28,0],[297,30,297,38,0],[297,39,297,41,0],[297,42,297,52,0],[298,21,298,22,0],[299,25,299,53,0],[300,25,300,60,0],[301,25,301,47,0],[302,21,302,22,0],[303,21,303,43,0],[305,21,305,33,0],[307,21,307,50,0],[308,17,308,18,0],[309,13,309,14,0],[311,13,311,32,0],[312,9,312,10,0],[315,9,315,10,0],[316,13,316,32,0],[317,13,317,14,0],[318,17,318,70,0],[319,17,319,46,0],[320,17,320,18,0],[321,21,321,84,0],[322,17,322,18,0],[323,13,323,14,0],[324,13,324,113,0],[325,13,325,62,0],[326,17,326,44,0],[328,13,328,44,0],[336,21,336,71,0],[337,25,341,72,0],[343,25,346,67,0],[347,21,347,27,0],[349,21,349,72,0],[350,25,354,71,0],[356,25,358,67,0],[359,21,359,27,0],[361,21,361,72,0],[362,25,366,71,0],[368,25,370,67,0],[371,21,371,27,0],[373,21,373,47,0],[374,21,374,53,0],[375,25,375,72,0],[377,21,377,22,0],[389,25,390,154,0],[391,25,391,101,0],[394,21,394,22,0],[395,21,395,27,0],[398,21,402,49,0],[403,21,403,27,0],[407,21,407,61,0],[409,13,409,33,0],[410,9,410,10,0],[413,9,413,10,0],[414,13,418,29,0],[419,9,419,10,0],[422,9,422,10,0],[423,13,423,90,0],[426,13,426,76,0],[427,13,427,77,0],[428,13,428,73,0],[429,13,429,81,0],[430,13,430,78,0],[431,13,431,84,0],[432,13,432,91,0],[433,13,433,82,0],[434,13,434,90,0],[435,13,435,81,0],[436,13,436,80,0],[437,13,437,79,0],[438,13,438,75,0],[439,13,439,84,0],[440,13,440,85,0],[441,13,441,78,0],[442,13,442,84,0],[444,13,444,139,0],[445,13,445,188,0],[446,13,446,145,0],[447,13,447,141,0],[448,13,448,85,0],[449,13,449,80,0],[450,13,450,78,0],[451,13,451,151,0],[452,13,452,95,0],[453,13,453,153,0],[455,13,455,33,0],[456,13,456,14,0],[457,17,458,115,0],[459,13,459,14,0],[462,13,462,39,0],[463,13,463,35,0],[467,13,467,37,0],[468,13,468,48,0],[469,9,469,10,0],[473,9,473,10,0],[474,13,474,102,0],[483,13,483,29,0],[484,9,484,10,0],[506,9,506,10,0],[507,13,507,55,0],[508,13,508,14,0],[509,17,509,125,0],[510,21,510,139,0],[511,17,511,101,0],[512,17,512,18,0],[513,21,513,47,0],[514,25,514,144,0],[515,17,515,18,0],[516,22,516,130,0],[517,17,517,18,0],[518,21,518,139,0],[520,17,520,43,0],[521,17,521,18,0],[522,21,522,107,0],[523,21,523,22,0],[524,25,524,169,0],[526,21,528,104,0],[529,21,529,65,0],[530,21,530,43,0],[531,21,531,22,0],[532,25,543,77,0],[544,25,544,26,0],[545,29,545,98,0],[547,21,547,22,0],[549,21,549,22,0],[550,25,550,134,0],[552,21,552,48,0],[553,21,553,22,0],[554,25,554,88,0],[555,25,555,26,0],[556,29,556,181,0],[558,25,558,96,0],[559,25,559,26,0],[560,29,561,114,0],[563,21,563,22,0],[565,21,565,22,0],[566,25,566,134,0],[568,17,568,18,0],[569,22,569,47,0],[570,17,570,18,0],[571,21,571,107,0],[572,21,572,22,0],[573,25,573,168,0],[575,21,577,122,0],[578,21,578,43,0],[579,21,579,22,0],[580,25,585,77,0],[586,25,586,26,0],[587,29,587,98,0],[589,21,589,22,0],[591,21,591,22,0],[592,25,592,134,0],[594,17,594,18,0],[595,13,595,14,0],[597,13,597,25,0],[598,9,598,10,0],[601,9,601,10,0],[602,13,602,45,0],[605,13,605,43,0],[606,13,606,102,0],[607,13,607,43,0],[608,13,608,58,0],[610,13,610,43,0],[611,13,611,42,0],[612,13,612,43,0],[613,13,613,58,0],[615,13,615,43,0],[616,13,616,41,0],[617,13,617,40,0],[618,13,618,59,0],[619,13,619,66,0],[620,13,620,70,0],[621,13,621,76,0],[622,13,622,78,0],[623,13,623,76,0],[624,13,624,76,0],[625,13,625,53,0],[627,13,627,43,0],[628,13,628,101,0],[629,13,629,41,0],[630,13,630,58,0],[633,13,633,43,0],[634,13,634,45,0],[635,13,635,41,0],[636,13,636,58,0],[638,13,638,28,0],[639,9,639,10,0],[642,9,642,10,0],[643,13,646,48,0],[647,9,647,10,0],[650,9,650,10,0],[651,13,654,48,0],[655,9,655,10,0]]);
    </script>
  </body>
</html>