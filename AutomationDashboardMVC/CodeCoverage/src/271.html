<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Quantity Planning\SubContractingDetails.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI.BL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;
using System.Collections.Generic;

namespace Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI
{
    public partial class SubContractingDetails : BrixPageBase
    {
        protected ModalPopupExtender PopupExtender;
        private int InstanceId { get; set; }

        private int ContractId { get; set; }

        private int BucketCount { get; set; }

        private int StartNo
        {
            get { return Convert.ToInt32(Session[&quot;SCStartNo&quot;]); }
            set { Session[&quot;SCStartNo&quot;] = value; }
        }

        private int EndNo
        {
            get { return Convert.ToInt32(Session[&quot;SCEndNo&quot;]); }
            set { Session[&quot;SCEndNo&quot;] = value; }
        }

        private int CurrentLowerLimit
        {
            get { return Convert.ToInt32(Session[&quot;SCCurrentLowerLimit&quot;]); }
            set { Session[&quot;SCCurrentLowerLimit&quot;] = value; }
        }

        private int CurrentUpperLimit
        {
            get { return Convert.ToInt32(Session[&quot;SCCurrentUpperLimit&quot;]); }
            set { Session[&quot;SCCurrentUpperLimit&quot;] = value; }
        }

        private DataSet ScheduleData
        {
            get { return (DataSet) Session[&quot;SCScheduleData&quot;]; }
            set { Session[&quot;SCScheduleData&quot;] = value; }
        }

        private DataTable CurrentSource
        {
            get { return (DataTable) Session[&quot;SCCurrentSource&quot;]; }
            set { Session[&quot;SCCurrentSource&quot;] = value; }
        }

        /// &lt;summary&gt;
        /// Gets the Project Mode : I-Integration, L-Live
        /// &lt;/summary&gt;
        private string ProjectMode
        {
            get
            {
                return (CacheManager.Instance.IsIntegrated(Request.QueryString[Constants.QRY_PROJECTID].ToInt32_2())
                            ? &quot;I&quot;
                            : &quot;L&quot;);
            }
        }

        protected override void CreateChildControls()
        {
            EnsureChildControls();
            CreateControlCollection();

            //var menus = new MenuArray();
            //if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)))
            //    menus.Add(new BrixMenu(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkPrevious&quot;, &quot;Previous Period&quot;, &quot;previous.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkNext&quot;, &quot;Next Period&quot;, &quot;next.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkFilter&quot;, &quot;Filter&quot;, &quot;IcnFilterApply.png&quot;, 70));
            //menus.Add(new BrixMenu(&quot;lnkFilterClr&quot;, &quot;Remove Filter&quot;, &quot;IcnFilterRem.png&quot;, 70));
            //CreateToolBarMenu(menus, null);
            List&lt;MenuGroup&gt; menuGroups = new List&lt;MenuGroup&gt;();
            MenuGroup generalGroup = new MenuGroup(&quot;General&quot;);
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)))
                if (AllowSave)
                generalGroup.AddMenu(new LargeButton(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;));
            generalGroup.AddMenu(new LargeButton(&quot;lnkCancel&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;));
            generalGroup.AddMenu(new TextIcon(&quot;lnkPrevious&quot;, &quot;Previous Period&quot;, &quot;Icn_Previous_16.png&quot;));
            generalGroup.AddMenu(new TextIcon(&quot;lnkNext&quot;, &quot;Next Period&quot;, &quot;Icn_Next_16.png&quot;));
            LargeButton btnFilter = new LargeButton(&quot;lnkFilter&quot;, &quot;Filter&quot;, &quot;Icn_Filter.png&quot;);
            btnFilter.AddSubMenu(new TextIcon(&quot;lnkFilterClr&quot;, &quot;Remove Filter&quot;, &quot;Icn_Filterremove_16.png&quot;));
            generalGroup.AddMenu(btnFilter);
            menuGroups.Add(generalGroup);

            CreateToolBarMenu(menuGroups, null);
            if (Request[&quot;Mode&quot;] != &quot;View&quot;)
             MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).OnClientClick = &quot;return CheckSave();&quot;;
            InitFilter();
            SetPopUpDetails();
            ClientScript.RegisterStartupScript(aspPnlFilter.GetType(), &quot;showHideFilterButtons&quot;,
                                               &quot;showHideFilterButtons(&#39;&quot; +
                                               MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                               MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);&quot;, true);

            if (!IsPostBack)
                FormatNavigatorButtons();
        }

        private void SetPopUpDetails()
        {
            //PopupExtender = (ModalPopupExtender)this.Master.FindControl(&quot;filterExtender&quot;);
            PopupExtender.Visible = true;
            //PopupExtender.AddNewPopup(aspPnl.ClientID, btnHelper.ClientID, btnActCancel);

            if (MainToolBar.GetMenuReference(&quot;lnkFilter&quot;) != null &amp;&amp;
                MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;) != null)
            {
                //MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).Style.Add(&quot;display&quot;, &quot;block&quot;);
                PopupExtender.AddNewPopup(aspPnlFilter.ClientID,
                                          ((Request[&quot;Mode&quot;] == &quot;View&quot;)
                                               ? MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID
                                               : btnGhostCheck.ClientID), btnCancel.ClientID, 300, 550);
                btnFilter.OnClientClick = &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID + &quot;&#39;).click();applyFilter(&#39;&quot; +
                                          btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                          MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                          MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);return false;&quot;;
                btnReset.Attributes.Add(&quot;onClick&quot;,
                                        &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID +
                                        &quot;&#39;).click();return resetFilters(&#39;&quot; + btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                        MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                        MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);&quot;);
                MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).OnClientClick = &quot;return resetFilters(&#39;&quot; +
                                                                             btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                                                             MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).
                                                                                 ClientID + &quot;&#39;, &#39;&quot; +
                                                                             MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;)
                                                                                 .ClientID + &quot;&#39;);&quot;;
            }
            // PopupExtender.Title = ((Request[hdnPickerClicked.ClientID] ?? &quot;R&quot;).Equals(&quot;P&quot;)) ? &quot;Filter&quot; : &quot;Activities&quot;;
        }


        private void InitFilter()
        {
            ClientScript.RegisterArrayDeclaration(&quot;FilterFields&quot;,
                                                  ModelHelper.GetFilterHtml(tblFilter, GetApplyFilterLabels()));
        }

        public BrixFilter[] GetApplyFilterLabels()
        {
            var filters = new BrixFilter[2];
            filters[0] = new BrixFilter();
            filters[0].Name = &quot;ResItemID&quot;;
            filters[0].Title = &quot;ResourceID&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        protected void btnFilterGhost_Click(object sender, EventArgs e)
        {
            string filter = ModelHelper.GetFilterXML(tblFilter.UniqueID.Remove(tblFilter.UniqueID.Length - 9), Request,
                                                     GetApplyFilterLabels());
            FetchAndBindData(filter);
            FormatNavigatorButtons();
        }

        private void FormatNavigatorButtons()
        {
            if (CurrentLowerLimit + BucketCount &gt; EndNo)
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            else if (CurrentLowerLimit == StartNo &amp;&amp; (BucketCount &gt; 0 &amp;&amp; EndNo &gt; (CurrentLowerLimit + BucketCount)))
                MainToolBar.ShowMenu(&quot;lnkNext&quot;);

            if (CurrentUpperLimit - BucketCount &lt; StartNo)
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
        }

        protected override void CustomizeToolBar()
        {
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)))
            {
                if (MainToolBar.GetMenuReference(&quot;lnkSave&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += btnSave_Click;             
            }
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += btnCancel_Click;
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;

            MainToolBar.GetMenuReference(&quot;lnkNext&quot;).Click += btnFwdGhost_Click;
            MainToolBar.GetMenuReference(&quot;lnkNext&quot;).OnClientClick = &quot;return SaveAndProceed(&#39;1&#39;);&quot;;

            MainToolBar.GetMenuReference(&quot;lnkPrevious&quot;).Click += btnBwdGhost_Click;
            MainToolBar.GetMenuReference(&quot;lnkPrevious&quot;).OnClientClick = &quot;return SaveAndProceed(&#39;2&#39;);&quot;;
        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);
            hdnAmountDecimalFields.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT).ToString2();
            uwgSubContracting.InitializeRow += uwgSubContracting_InitializeRow;
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            InstanceId = string.IsNullOrEmpty(Request[&quot;InstanceId&quot;]) ? 0 : Request[&quot;InstanceId&quot;].ToInt32_2();
            ContractId = Request[&quot;ParentID&quot;].ToInt32_2();

            //TODO: Obtain bucket count from the user
            BucketCount = 5;

            if (!IsPostBack)
            {
                FetchAndBindData(string.Empty);
            }
            else
                FormatNavigatorButtons();
        }

        private void FetchAndBindData(string filter)
        {
            ScheduleData = QuantityPlanningManager.Instance.GetSubContractingScheduleData(InstanceId, ContractId, filter);
            AppendScheduleInfo();
            FormCurrentSource(ScheduleData.Tables[0]);
            int rowCount = ScheduleData.Tables[1].Rows.Count;
            StartNo = CurrentLowerLimit = ScheduleData.Tables[1].Rows[0][&quot;Number&quot;].ToInt32_2();
            EndNo = ScheduleData.Tables[1].Rows[rowCount - 1][&quot;Number&quot;].ToInt32_2();
            if (CurrentLowerLimit + BucketCount &gt; EndNo)
            {
                CurrentUpperLimit = EndNo;
            }
            else CurrentUpperLimit = CurrentLowerLimit + (BucketCount - 1);

            if (InstanceId &gt; 0)
            {
                DataSet planningDetails = null;
                planningDetails = QuantityPlanningManager.Instance.GetQtyPlanningDetails(ContractId, Constants.MODID_CONTMGT, InstanceId);

                if (planningDetails != null &amp;&amp; planningDetails.Tables.Count &gt; 0 &amp;&amp;
                    planningDetails.Tables[0].Rows.Count &gt; 0)
                {
                    DataRow dr = planningDetails.Tables[0].Rows[0];
                    ViewState[&quot;QPStatus&quot;] = dr[&quot;Status&quot;].ToString();
                }
            }
            LoadSubContractingData();
        }

        private void AppendScheduleInfo()
        {
            DataTable scheduleInfo = ScheduleData.Tables[2];
            int tempScheduleID;
            foreach (DataColumn scheduleID in scheduleInfo.Columns)
                if (Int32.TryParse(scheduleID.ColumnName, out tempScheduleID))
                    ScheduleData.Tables[0].Columns.Add(tempScheduleID.ToString2());
            int resourceDetailId;
            foreach (DataRow resourceInfo in ScheduleData.Tables[0].Select())
            {
                resourceDetailId = resourceInfo[&quot;ResourceDetailID&quot;].ToInt32_2();
                DataRow[] resourceScheduleInfo = scheduleInfo.Select(&quot;SchItemID = &#39;&quot; + resourceDetailId + &quot;&#39;&quot;);
                if (resourceScheduleInfo.Length &gt; 0)
                {
                    foreach (DataColumn scheduleID in scheduleInfo.Columns)
                    {
                        if (Int32.TryParse(scheduleID.ColumnName, out tempScheduleID))
                        {
                            resourceInfo[tempScheduleID.ToString2()] =
                                resourceScheduleInfo[0][tempScheduleID.ToString2()];
                        }
                    }
                }
            }
        }

        protected void btnFwdGhost_Click(object sender, EventArgs e)
        {
            SaveEditedItems();
            CurrentLowerLimit += BucketCount;
            if (CurrentUpperLimit + BucketCount &gt; EndNo) CurrentUpperLimit = EndNo;
            else CurrentUpperLimit += BucketCount;
            if (CurrentLowerLimit &gt; StartNo)
            {
                HideMenu(&quot;lnkPrevious&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
            }
            if (CurrentUpperLimit &lt; EndNo)
            {
                HideMenu(&quot;lnkNext&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            }

            LoadSubContractingData();
        }

        protected void btnBwdGhost_Click(object sender, EventArgs e)
        {
            SaveEditedItems();
            CurrentUpperLimit = CurrentLowerLimit - 1;
            CurrentLowerLimit -= BucketCount;
            if (CurrentLowerLimit &gt; StartNo)
            {
                HideMenu(&quot;lnkPrevious&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
            }
            if (CurrentUpperLimit &lt; EndNo)
            {
                HideMenu(&quot;lnkNext&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            }

            LoadSubContractingData();
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            SaveEditedItems();
            int scheduleId;
            decimal quantity;
            var sb = new StringBuilder();
            sb.Append(&quot;&lt;Schedules&gt;&quot;);
            foreach (DataRow resource in ScheduleData.Tables[0].Select())
            {
                foreach (DataColumn scheduleData in resource.Table.Columns)
                {
                    if (int.TryParse(scheduleData.ColumnName, out scheduleId))
                    {
                        if (decimal.TryParse(resource[scheduleData].ToString2(), out quantity))
                        {
                            sb.Append(&quot;&lt;Schedule&gt;&quot;);
                            sb.AppendFormat(
                                &quot;&lt;ResourceDetailID&gt;{0}&lt;/ResourceDetailID&gt;&lt;ScheduleID&gt;{1}&lt;/ScheduleID&gt;&lt;Quantity&gt;{2}&lt;/Quantity&gt;&quot;,
                                resource[&quot;ResourceDetailID&quot;], scheduleId, quantity);
                            sb.Append(&quot;&lt;/Schedule&gt;&quot;);
                        }
                    }
                }
            }
            sb.Append(&quot;&lt;/Schedules&gt;&quot;);
            string xmlArgument = sb.ToString2();
            int result = 0;
            if (
                int.TryParse(
                    QuantityPlanningManager.Instance.SaveSubContractingDetails(InstanceId, xmlArgument).ToString2(),
                    out result))
            {
                if (result == 1)
                    ClientScript.RegisterStartupScript(GetType(), &quot;alertMessage&quot;, &quot;ShowSuccess(&#39;Saved successfully.&#39;);&quot;, true);
                else
                    ClientScript.RegisterStartupScript(GetType(), &quot;alertMessage&quot;,
                                                       &quot;ShowError(&#39;The save was unsuccessful due to some unknown reason. Please try again.&#39;);&quot;,
                                                       true);
            }
            FetchAndBindData(string.Empty);
            FormatNavigatorButtons();
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            Response.Redirect(
                string.Format(
                    &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?PID={0}&amp;ParentID={1}&amp;QPID={2}&amp;Mode={3}&amp;Context=QTYPLAN&quot;,
                    Request[&quot;PID&quot;], ContractId, InstanceId, Request[&quot;Mode&quot;]));
        }

        private void LoadSubContractingData()
        {
            uwgSubContracting.DataSource = GetCurrentDataSource(ScheduleData.Tables[0]);
            try
            {
                uwgSubContracting.DataBind();
            }
            catch
            {
            }
            SetSubContractingGridColumnProperties();
        }

        private void FormCurrentSource(DataTable scheduleData)
        {
            CurrentSource = new DataTable();
            string hiddenColumns = &quot;ModuleID,ParentInstanceID,SchItemID,ItemID&quot;;

            int tempScheduleId;
            foreach (DataColumn col in scheduleData.Columns)
            {
                if (!hiddenColumns.Split(&#39;,&#39;).Contains(col.ColumnName) &amp;&amp;
                    !int.TryParse(col.ColumnName, out tempScheduleId))
                    CurrentSource.Columns.Add(col.ColumnName);
            }
            CurrentSource.Columns.Add(&quot;IsEdited&quot;);
            CurrentSource.AcceptChanges();

            string fixedColumns = &quot;ResourceDetailID,LineNo,StandardItemNo,ItemDesc,ResItemID,Description,Unit,Rate&quot;;
            foreach (DataRow dr in scheduleData.Select())
            {
                DataRow newRow = CurrentSource.NewRow();
                foreach (string colName in fixedColumns.Split(&#39;,&#39;))
                    newRow[colName] = dr[colName];
                newRow[&quot;ResQuantity&quot;] = dr[&quot;ResQuantity&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                CultureInfo.CurrentCulture);
                newRow[&quot;TotalCost&quot;] = dr[&quot;TotalCost&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                            CultureInfo.CurrentCulture);
                newRow[&quot;RemainingQty&quot;] = dr[&quot;RemainingQty&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                  CultureInfo.CurrentCulture);
                newRow[&quot;IsEdited&quot;] = false;
                CurrentSource.Rows.Add(newRow);
            }
        }

        private DataTable GetCurrentDataSource(DataTable scheduleData)
        {
            int tempScheduleId;
            DataColumn currentCol;
            for (int colCount = CurrentSource.Columns.Count - 1; colCount &gt;= 0; colCount--)
            {
                if (int.TryParse(CurrentSource.Columns[colCount].ColumnName, out tempScheduleId))
                {
                    currentCol = CurrentSource.Columns[colCount];
                    CurrentSource.Columns.Remove(currentCol);
                    if (CurrentSource.Columns.Contains(currentCol.ColumnName + &quot;_Cost&quot;))
                        CurrentSource.Columns.Remove(currentCol.ColumnName + &quot;_Cost&quot;);
                }
            }

            for (int colNo = CurrentLowerLimit; colNo &lt;= CurrentUpperLimit; colNo++)
            {
                CurrentSource.Columns.Add(colNo.ToString2());
                CurrentSource.Columns.Add(colNo.ToString2() + &quot;_Cost&quot;);
            }
            CurrentSource.AcceptChanges();

            decimal tempQuantity;
            foreach (DataRow dr in scheduleData.Select())
            {
                DataRow correspondingRow =
                    CurrentSource.Select(&quot;ResourceDetailID = &#39;&quot; + dr[&quot;ResourceDetailID&quot;] + &quot;&#39;&quot;)[0];
                for (int colNo = CurrentLowerLimit; colNo &lt;= CurrentUpperLimit; colNo++)
                {
                    correspondingRow[colNo.ToString2()] = dr[colNo.ToString2()];
                    if (decimal.TryParse(dr[colNo.ToString2()].ToString2(), out tempQuantity))
                        correspondingRow[colNo.ToString2() + &quot;_Cost&quot;] =
                            (tempQuantity * dr[&quot;Rate&quot;].ToDecimal2()).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                            CultureInfo.CurrentCulture);
                }
                correspondingRow[&quot;RemainingQty&quot;] = dr[&quot;RemainingQty&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                            CultureInfo.CurrentCulture);
                correspondingRow[&quot;IsEdited&quot;] = false;
            }

            return CurrentSource;
        }

        private void SetSubContractingGridColumnProperties()
        {
            uwgSubContracting.DisplayLayout.Bands[0].HeaderLayout.Reset();
            foreach (UltraGridColumn col in uwgSubContracting.Columns)
            {
                int scheduleId;
                if (int.TryParse(col.Key, out scheduleId))
                {
                    if (scheduleId &gt;= CurrentLowerLimit &amp;&amp; scheduleId &lt;= CurrentUpperLimit)
                    {
                        var ch = new ColumnHeader(true);
                        ch.Caption = GetColumnHeader(scheduleId);
                        ch.Style.HorizontalAlign = HorizontalAlign.Center;
                        ch.RowLayoutColumnInfo.OriginY = 0;
                        ch.RowLayoutColumnInfo.OriginX = col.Header.RowLayoutColumnInfo.OriginX;
                        ch.RowLayoutColumnInfo.SpanX = 2;
                        ch.RowLayoutColumnInfo.SpanY = 1;
                        ch.Key = col.Key + &quot;_G&quot;;

                        uwgSubContracting.DisplayLayout.Bands[0].HeaderLayout.Add(ch);

                        col.Header.RowLayoutColumnInfo.OriginY = 1;
                        col.Header.Caption = &quot;Quantity&quot;;
                        col.Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                        //If there is no mode or the mode is View then the user should not able to modify the grid column values as well as 
                        //the background color will be transparent
                        if ((Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)) ||
                            (!string.IsNullOrEmpty(ViewState[&quot;QPStatus&quot;].ToString2()) &amp;&amp;
                             ViewState[&quot;QPStatus&quot;].ToString2().Equals(&quot;approved&quot;,
                                                                      StringComparison.CurrentCultureIgnoreCase)))
                        {
                            col.AllowUpdate = AllowUpdate.No;
                            col.CellStyle.BackColor = Color.Transparent;
                        }
                        else
                        {
                            col.AllowUpdate = AllowUpdate.Yes;
                            col.CellStyle.BackColor = Color.Yellow;
                        }
                        col.Hidden = false;
                        col.EditorControlID = &quot;wneCell&quot;;
                        col.Type = ColumnType.Custom;
                        col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    }
                    else
                        col.Hidden = true;
                }
                else if (col.Key.Contains(&quot;_Cost&quot;))
                {
                    col.Header.Caption = &quot;Cost&quot;;
                    col.Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                    col.Hidden = false;
                    col.CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    col.Header.RowLayoutColumnInfo.OriginY = 1;
                }
                else
                {
                    col.Header.RowLayoutColumnInfo.OriginY = 0;
                    col.Header.RowLayoutColumnInfo.SpanY = 2;
                }
            }

            if (uwgSubContracting.Columns.Exists(&quot;ResourceDetailID&quot;))
                uwgSubContracting.Columns.FromKey(&quot;ResourceDetailID&quot;).Hidden = true;
            if (uwgSubContracting.Columns.Exists(&quot;ItemID&quot;)) uwgSubContracting.Columns.FromKey(&quot;ItemID&quot;).Hidden = true;
            if (uwgSubContracting.Columns.Exists(&quot;IsEdited&quot;))
                uwgSubContracting.Columns.FromKey(&quot;IsEdited&quot;).Hidden = true;
            if (uwgSubContracting.Columns.Exists(&quot;ResQuantity&quot;))
            {
                uwgSubContracting.Columns.FromKey(&quot;ResQuantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                uwgSubContracting.Columns.FromKey(&quot;ResQuantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                uwgSubContracting.Columns.FromKey(&quot;ResQuantity&quot;).Header.Caption = &quot;Quantity&quot;;
            }
            if (uwgSubContracting.Columns.Exists(&quot;TotalCost&quot;))
            {
                uwgSubContracting.Columns.FromKey(&quot;TotalCost&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                uwgSubContracting.Columns.FromKey(&quot;TotalCost&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                uwgSubContracting.Columns.FromKey(&quot;TotalCost&quot;).Header.Caption = &quot;Total Cost in &quot; +
                                                                                LocalizationManager.GetString(
                                                                                    KeyConstants.LOC_CURRENCY_SYMBOL);
            }
            if (uwgSubContracting.Columns.Exists(&quot;RemainingQty&quot;))
            {
                uwgSubContracting.Columns.FromKey(&quot;RemainingQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                uwgSubContracting.Columns.FromKey(&quot;RemainingQty&quot;).Header.Caption = &quot;Remaining Quantity&quot;;
                uwgSubContracting.Columns.FromKey(&quot;RemainingQty&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
            }
            if (uwgSubContracting.Columns.Exists(&quot;Rate&quot;))
            {
                uwgSubContracting.Columns.FromKey(&quot;Rate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                uwgSubContracting.Columns.FromKey(&quot;Rate&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
            }
            if (uwgSubContracting.Columns.Exists(&quot;ResItemID&quot;))
                uwgSubContracting.Columns.FromKey(&quot;ResItemID&quot;).Header.Caption = &quot;Resource ID&quot;;
            if (uwgSubContracting.Columns.Exists(&quot;StandradItemNo&quot;))
                uwgSubContracting.Columns.FromKey(&quot;StandradItemNo&quot;).Header.Caption = PayItemNo;
            if (uwgSubContracting.Columns.Exists(&quot;ItemDesc&quot;))
                uwgSubContracting.Columns.FromKey(&quot;ItemDesc&quot;).Header.Caption = ItemNameAbbr + &quot; Description&quot;;
            if (uwgSubContracting.Columns.Exists(&quot;LineNo&quot;))
                uwgSubContracting.Columns.FromKey(&quot;LineNo&quot;).Header.Caption = &quot;Line No.&quot;;
        }

        private string GetColumnHeader(int number)
        {
            DataRow currentRow = ScheduleData.Tables[1].Select(&quot;Number = &#39;&quot; + number + &quot;&#39;&quot;)[0];
            DateTime dateColName;
            if (ScheduleData.Tables[1].Columns.Contains(&quot;Name&quot;))
            {
                if (currentRow[&quot;PeriodBasis&quot;].ToString2().Equals(&quot;2&quot;) &amp;&amp;
                    DateTime.TryParse(currentRow[&quot;Name&quot;].ToString2(), out dateColName))
                    return dateColName.ToMWDateTimeString_FormatDate();
                else
                    return currentRow[&quot;Name&quot;].ToString2();
            }
            else
                return @&quot;Week &quot; + (number - StartNo + 1) + &quot;: &quot; +
                       currentRow[&quot;StartDate&quot;].ToMWDateTimeString_FormatDate()
                       + &quot; - &quot; + currentRow[&quot;EndDate&quot;].ToMWDateTimeString_FormatDate();
        }

        private void SaveEditedItems()
        {
            int tempScheduleId, resourceDetailId;
            decimal quantity, difference = 0, newValue;

            foreach (UltraGridRow editedRow in uwgSubContracting.Rows)
            {
                difference = 0;
                if (editedRow.Cells.FromKey(&quot;IsEdited&quot;).Value.Equals(&quot;true&quot;))
                {
                    resourceDetailId = editedRow.Cells.FromKey(&quot;ResourceDetailID&quot;).Value.ToInt32_2();
                    DataRow resource = ScheduleData.Tables[0].Select(&quot;ResourceDetailID = &#39;&quot; + resourceDetailId + &quot;&#39;&quot;)[0];
                    foreach (DataColumn scheduleCol in CurrentSource.Columns)
                    {
                        if (int.TryParse(scheduleCol.ColumnName, out tempScheduleId))
                        {
                            newValue =
                                decimal.TryParse(editedRow.Cells.FromKey(scheduleCol.ColumnName).Value.ToString2(),
                                                 out quantity)
                                    ? quantity
                                    : 0;
                            difference += newValue -
                                          (decimal.TryParse(resource[scheduleCol.ColumnName].ToString2(), out quantity)
                                               ? quantity
                                               : 0);
                            resource[scheduleCol.ColumnName] = (newValue == 0
                                                                    ? DBNull.Value
                                                                    : editedRow.Cells.FromKey(scheduleCol.ColumnName).
                                                                          Value);
                        }
                    }
                    resource[&quot;RemainingQty&quot;] = editedRow.Cells.FromKey(&quot;RemainingQty&quot;).Value.ToDecimal2() - difference;
                }
            }
        }

        private void uwgSubContracting_InitializeRow(object sender, RowEventArgs e)
        {
            int tempScheduleId;
            foreach (UltraGridCell cell in e.Row.Cells)
            {
                if (cell.Key.Contains(&quot;_Cost&quot;))
                    cell.Column.Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                if (int.TryParse(cell.Key, out tempScheduleId))
                {
                    if (e.Row.Cells.FromKey(cell.Key).Value == null)
                        e.Row.Cells.FromKey(cell.Key + &quot;_Cost&quot;).Value = &quot;&quot;;
                }
            }
        }

        private void HideMenu(string buttonID, bool bUnHide)
        {
            if (bUnHide) MainToolBar.ShowMenu(buttonID);
            else MainToolBar.HideMenu(buttonID);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,34,23,38,0],[23,39,23,43,0],[25,34,25,38,0],[25,39,25,43,0],[27,35,27,39,0],[27,40,27,44,0],[31,17,31,18,0],[31,19,31,64,0],[31,65,31,66,0],[32,17,32,18,0],[32,19,32,48,0],[32,49,32,50,0],[37,17,37,18,0],[37,19,37,62,0],[37,63,37,64,0],[38,17,38,18,0],[38,19,38,46,0],[38,47,38,48,0],[43,17,43,18,0],[43,19,43,74,0],[43,75,43,76,0],[44,17,44,18,0],[44,19,44,58,0],[44,59,44,60,0],[49,17,49,18,0],[49,19,49,74,0],[49,75,49,76,0],[50,17,50,18,0],[50,19,50,58,0],[50,59,50,60,0],[55,17,55,18,0],[55,19,55,62,0],[55,63,55,64,0],[56,17,56,18,0],[56,19,56,53,0],[56,54,56,55,0],[61,17,61,18,0],[61,19,61,65,0],[61,66,61,67,0],[62,17,62,18,0],[62,19,62,54,0],[62,55,62,56,0],[71,13,71,14,0],[72,17,74,36,0],[75,13,75,14,0],[79,9,79,10,0],[80,13,80,35,0],[81,13,81,39,0],[92,13,92,64,0],[93,13,93,63,0],[94,13,94,78,0],[95,17,95,31,0],[96,17,96,90,0],[97,13,97,88,0],[98,13,98,105,0],[99,13,99,93,0],[100,13,100,94,0],[101,13,101,108,0],[102,13,102,45,0],[103,13,103,42,0],[105,13,105,49,0],[106,13,106,43,0],[107,14,107,94,0],[108,13,108,26,0],[109,13,109,31,0],[110,13,113,117,0],[115,13,115,29,0],[116,17,116,42,0],[117,9,117,10,0],[120,9,120,10,0],[122,13,122,42,0],[125,13,126,70,0],[127,13,127,14,0],[129,17,132,105,0],[133,17,136,118,0],[137,17,141,104,0],[142,17,147,100,0],[148,13,148,14,0],[150,9,150,10,0],[154,9,154,10,0],[155,13,156,113,0],[157,9,157,10,0],[160,9,160,10,0],[161,13,161,45,0],[162,13,162,43,0],[163,13,163,43,0],[164,13,164,45,0],[165,13,165,58,0],[167,13,167,43,0],[168,13,168,64,0],[169,13,169,58,0],[171,13,171,28,0],[172,9,172,10,0],[175,9,175,10,0],[176,13,177,78,0],[178,13,178,38,0],[179,13,179,38,0],[180,9,180,10,0],[183,9,183,10,0],[184,13,184,57,0],[185,17,185,49,0],[186,18,186,117,0],[187,17,187,49,0],[189,13,189,59,0],[190,17,190,53,0],[191,9,191,10,0],[194,9,194,10,0],[195,13,195,78,0],[196,13,196,14,0],[197,17,197,69,0],[198,17,198,80,0],[199,13,199,14,0],[200,13,200,80,0],[201,13,201,80,0],[203,13,203,80,0],[204,13,204,99,0],[206,13,206,84,0],[207,13,207,103,0],[208,9,208,10,0],[211,9,211,10,0],[212,13,212,28,0],[213,13,213,145,0],[214,13,214,80,0],[215,9,215,10,0],[218,9,218,10,0],[219,13,219,110,0],[220,13,220,58,0],[223,13,223,29,0],[225,13,225,29,0],[226,13,226,14,0],[227,17,227,48,0],[228,13,228,14,0],[230,17,230,42,0],[231,9,231,10,0],[234,9,234,10,0],[235,13,235,123,0],[236,13,236,34,0],[237,13,237,55,0],[238,13,238,62,0],[239,13,239,96,0],[240,13,240,85,0],[241,13,241,57,0],[242,13,242,14,0],[243,17,243,43,0],[244,13,244,14,0],[245,18,245,76,0],[247,13,247,32,0],[248,13,248,14,0],[249,17,249,48,0],[250,17,250,139,0],[252,17,253,62,0],[254,17,254,18,0],[255,21,255,68,0],[256,21,256,69,0],[257,17,257,18,0],[258,13,258,14,0],[259,13,259,38,0],[260,9,260,10,0],[263,9,263,10,0],[264,13,264,61,0],[266,13,266,20,0],[266,22,266,43,0],[266,44,266,46,0],[266,47,266,67,0],[267,17,267,79,0],[268,21,268,84,0],[270,13,270,20,0],[270,22,270,42,0],[270,43,270,45,0],[270,46,270,77,0],[271,13,271,14,0],[272,17,272,81,0],[273,17,273,112,0],[274,17,274,53,0],[275,17,275,18,0],[276,21,276,28,0],[276,30,276,51,0],[276,52,276,54,0],[276,55,276,75,0],[277,21,277,22,0],[278,25,278,87,0],[279,25,279,26,0],[280,29,281,85,0],[282,25,282,26,0],[283,21,283,22,0],[284,17,284,18,0],[285,13,285,14,0],[286,9,286,10,0],[289,9,289,10,0],[290,13,290,31,0],[291,13,291,46,0],[292,13,292,57,0],[292,58,292,84,0],[293,18,293,51,0],[294,13,294,45,0],[295,13,295,14,0],[296,17,296,47,0],[297,13,297,14,0],[299,13,299,14,0],[300,17,300,53,0],[301,13,301,14,0],[302,13,302,43,0],[303,13,303,14,0],[304,17,304,43,0],[305,13,305,14,0],[307,13,307,14,0],[308,17,308,49,0],[309,13,309,14,0],[311,13,311,38,0],[312,9,312,10,0],[315,9,315,10,0],[316,13,316,31,0],[317,13,317,55,0],[318,13,318,46,0],[319,13,319,45,0],[320,13,320,14,0],[321,17,321,47,0],[322,13,322,14,0],[324,13,324,14,0],[325,17,325,53,0],[326,13,326,14,0],[327,13,327,43,0],[328,13,328,14,0],[329,17,329,43,0],[330,13,330,14,0],[332,13,332,14,0],[333,17,333,49,0],[334,13,334,14,0],[336,13,336,38,0],[337,9,337,10,0],[340,9,340,10,0],[341,13,341,31,0],[344,13,344,42,0],[345,13,345,38,0],[346,13,346,20,0],[346,22,346,38,0],[346,39,346,41,0],[346,42,346,73,0],[347,13,347,14,0],[348,17,348,24,0],[348,26,348,49,0],[348,50,348,52,0],[348,53,348,75,0],[349,17,349,18,0],[350,21,350,79,0],[351,21,351,22,0],[352,25,352,96,0],[353,25,353,26,0],[354,29,354,53,0],[355,29,357,85,0],[358,29,358,54,0],[359,25,359,26,0],[360,21,360,22,0],[361,17,361,18,0],[362,13,362,14,0],[363,13,363,39,0],[364,13,364,49,0],[365,13,365,28,0],[366,13,369,33,0],[370,13,370,14,0],[371,17,371,33,0],[372,21,372,128,0],[374,21,376,62,0],[377,13,377,14,0],[378,13,378,44,0],[379,13,379,38,0],[380,9,380,10,0],[383,9,383,10,0],[384,13,387,79,0],[388,9,388,10,0],[391,9,391,10,0],[392,13,392,89,0],[394,13,394,14,0],[395,17,395,46,0],[396,13,396,14,0],[397,13,397,18,0],[398,13,398,14,0],[399,13,399,14,0],[400,13,400,53,0],[401,9,401,10,0],[404,9,404,10,0],[405,13,405,45,0],[406,13,406,81,0],[409,13,409,20,0],[409,22,409,36,0],[409,37,409,39,0],[409,40,409,60,0],[410,13,410,14,0],[411,17,412,71,0],[413,21,413,63,0],[414,13,414,14,0],[415,13,415,51,0],[416,13,416,43,0],[418,13,418,117,0],[419,13,419,20,0],[419,22,419,32,0],[419,33,419,35,0],[419,36,419,57,0],[420,13,420,14,0],[421,17,421,57,0],[422,17,422,24,0],[422,26,422,40,0],[422,41,422,43,0],[422,44,422,67,0],[423,21,423,51,0],[424,17,425,109,0],[426,17,427,105,0],[428,17,429,111,0],[430,17,430,44,0],[431,17,431,48,0],[432,13,432,14,0],[433,9,433,10,0],[436,9,436,10,0],[439,18,439,64,0],[439,66,439,79,0],[439,81,439,91,0],[440,13,440,14,0],[441,17,441,98,0],[442,17,442,18,0],[443,21,443,66,0],[444,21,444,62,0],[445,21,445,89,0],[446,25,446,87,0],[447,17,447,18,0],[448,13,448,14,0],[450,18,450,47,0],[450,49,450,75,0],[450,77,450,84,0],[451,13,451,14,0],[452,17,452,62,0],[453,17,453,72,0],[454,13,454,14,0],[455,13,455,43,0],[458,13,458,20,0],[458,22,458,32,0],[458,33,458,35,0],[458,36,458,57,0],[459,13,459,14,0],[460,17,461,100,0],[462,22,462,51,0],[462,53,462,79,0],[462,81,462,88,0],[463,17,463,18,0],[464,21,464,81,0],[465,21,465,95,0],[466,25,468,105,0],[469,17,469,18,0],[470,17,471,121,0],[472,17,472,54,0],[473,13,473,14,0],[475,13,475,34,0],[476,9,476,10,0],[479,9,479,10,0],[480,13,480,75,0],[481,13,481,20,0],[481,22,481,41,0],[481,42,481,44,0],[481,45,481,70,0],[482,13,482,14,0],[484,17,484,59,0],[485,17,485,18,0],[486,21,486,92,0],[487,21,487,22,0],[488,25,488,57,0],[489,25,489,66,0],[490,25,490,75,0],[491,25,491,60,0],[492,25,492,97,0],[493,25,493,58,0],[494,25,494,58,0],[495,25,495,49,0],[497,25,497,87,0],[499,25,499,68,0],[500,25,500,57,0],[501,25,501,87,0],[504,25,507,115,0],[508,25,508,26,0],[509,29,509,62,0],[510,29,510,73,0],[511,25,511,26,0],[513,25,513,26,0],[514,29,514,63,0],[515,29,515,68,0],[516,25,516,26,0],[517,25,517,44,0],[518,25,518,57,0],[519,25,519,54,0],[520,25,520,79,0],[521,21,521,22,0],[523,25,523,43,0],[524,17,524,18,0],[525,22,525,52,0],[526,17,526,18,0],[527,21,527,49,0],[528,21,528,81,0],[529,21,529,40,0],[530,21,530,75,0],[531,21,531,64,0],[532,17,532,18,0],[534,17,534,18,0],[535,21,535,64,0],[536,21,536,62,0],[537,17,537,18,0],[538,13,538,14,0],[540,13,540,70,0],[541,17,541,85,0],[542,13,542,60,0],[542,61,542,119,0],[543,13,543,62,0],[544,17,544,77,0],[545,13,545,65,0],[546,13,546,14,0],[547,17,547,124,0],[548,17,548,116,0],[549,17,549,94,0],[550,13,550,14,0],[551,13,551,63,0],[552,13,552,14,0],[553,17,553,120,0],[554,17,554,114,0],[555,17,557,119,0],[558,13,558,14,0],[559,13,559,66,0],[560,13,560,14,0],[561,17,561,125,0],[562,17,562,105,0],[563,17,563,117,0],[564,13,564,14,0],[565,13,565,58,0],[566,13,566,14,0],[567,17,567,119,0],[568,17,568,109,0],[569,13,569,14,0],[570,13,570,63,0],[571,17,571,95,0],[572,13,572,68,0],[573,17,573,96,0],[574,13,574,62,0],[575,17,575,110,0],[576,13,576,60,0],[577,17,577,89,0],[578,9,578,10,0],[581,9,581,10,0],[582,13,582,96,0],[584,13,584,65,0],[585,13,585,14,0],[586,17,587,88,0],[588,21,588,72,0],[590,21,590,59,0],[593,17,595,88,0],[596,9,596,10,0],[599,9,599,10,0],[601,31,601,45,0],[603,13,603,20,0],[603,22,603,44,0],[603,45,603,47,0],[603,48,603,70,0],[604,13,604,14,0],[605,17,605,32,0],[606,17,606,78,0],[607,17,607,18,0],[608,21,608,102,0],[609,21,609,122,0],[610,21,610,28,0],[610,30,610,52,0],[610,53,610,55,0],[610,56,610,77,0],[611,21,611,22,0],[612,25,612,86,0],[613,25,613,26,0],[614,29,618,41,0],[619,29,622,53,0],[623,29,626,82,0],[627,25,627,26,0],[628,21,628,22,0],[629,21,629,120,0],[630,17,630,18,0],[631,13,631,14,0],[632,9,632,10,0],[635,9,635,10,0],[637,13,637,20,0],[637,22,637,40,0],[637,41,637,43,0],[637,44,637,55,0],[638,13,638,14,0],[639,17,639,48,0],[640,21,640,89,0],[641,17,641,64,0],[642,17,642,18,0],[643,21,643,69,0],[644,25,644,76,0],[645,17,645,18,0],[646,13,646,14,0],[647,9,647,10,0],[650,9,650,10,0],[651,13,651,25,0],[651,26,651,57,0],[652,18,652,49,0],[653,9,653,10,0]]);
    </script>
  </body>
</html>