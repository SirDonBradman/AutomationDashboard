<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Daily Work Report India\BL\DWRManager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.IO;
using System.Web;
using System.Web.Configuration;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ContmgtDTO;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Construction.ContractManager.BusinessLayer.BL;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using DataDynamics.ActiveReports;
using DataDynamics.ActiveReports.DataSources;
using DataDynamics.ActiveReports.Export.Pdf;
using Image = System.Drawing.Image;
using System.Xml;
using Aurigo.AMP3.UserManagementBL;
using System.Globalization;
using System.Collections;
using Aurigo.AMP3.DocumentManagementBL;
using Aurigo.AMP3.LinksBL;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.AMP3.ContractManager.BusinessLayer
{
    public class DWRManager : IModuleInstances, ISubmit
    {
        private static volatile Dictionary&lt;string, DWRManager&gt; _Inst = null;
        private static readonly object _oSync = new object();
        public DWRManager() { }
        public static DWRManager Instance
        {
            get
            {
                lock (_oSync)
                {
                    if (_Inst == null) _Inst = new Dictionary&lt;string, DWRManager&gt;();
                    string currentCompany = ConnectionHelper.GetCurrentCompany();
                    if (!_Inst.ContainsKey(currentCompany))
                        _Inst.Add(currentCompany, new DWRManager());

                    return _Inst[currentCompany];
                }
            }
        }

        #region IModuleInstances Members
        public string GetModuleInstances(string parentID, string parentModuleID)
        {
            return &quot;SELECT dwrid FROM contmgtdwrmain WHERE contractid = &quot; + parentID;
        }
        #endregion

        public int SaveDWRDetails(ContractManager.DTO.DWR dwrDetails)
        {
            var dic = new Dictionary&lt;string, object&gt;();
            dic[&quot;DWRID&quot;] = dwrDetails.DWRID;
            ComponentHelper.Instance.ExecuteNonQuery(DailyWorkReportStoredProcedure.usp_CONTDWRCUDWRDetails, dic,
                                                     dwrDetails);
            int DWRID;
            int.TryParse(dic[&quot;DWRID&quot;].ToString(), out DWRID);
            return DWRID;
        }

        //TODO: Make it obselate
        public DWRDTO.DTO GetDWRDetails_Old(int DWRID)
        {
            return DWRDAC.DAC.Instance.GetDWRDetails(DWRID);
        }

        public int DeleteDWR(string DWRIDList)
        {
            return
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    DailyWorkReportStoredProcedure.usp_CONTDWRDeleteDWRs, null, DWRIDList);
        }

        public int ApproveDWR(string DWRIDList, int ApprovedBy)
        {
            var dic = new Dictionary&lt;string, object&gt;();
            dic[&quot;OUTPUT&quot;] = 0;
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                DailyWorkReportStoredProcedure.usp_CONTDWRUpdateDWRStatus, dic, DWRIDList, &#39;A&#39;, ApprovedBy);
            int output;
            int.TryParse(dic[&quot;OUTPUT&quot;].ToString(), out output);
            return output;
        }

        public int UnApproveDWR(string DWRIDList, int UnApprovedBy)
        {
            return
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    DailyWorkReportStoredProcedure.usp_CONTDWRUpdateDWRStatus, null, DWRIDList, &#39;D&#39;, UnApprovedBy);
        }

        public int UpdateDWRStatus(string DWRIDList, string status, int UpdatedBy)
        {
            var dic = new Dictionary&lt;string, object&gt;();
            dic[&quot;OUTPUT&quot;] = 0;
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                DailyWorkReportStoredProcedure.usp_CONTMGTDWRUpdateStatus, dic, DWRIDList, status, UpdatedBy);
            int DWRID;
            int.TryParse(dic[&quot;OUTPUT&quot;].ToString(), out DWRID);
            return DWRID;
        }

        public int DeleteDWR(string MultiDWRID, int contractID)
        {
            var dic = new Dictionary&lt;string, object&gt;();
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                DailyWorkReportStoredProcedure.usp_CONTMGTDWRDeleteDWR, dic, MultiDWRID, contractID);

            int DWRID;
            int.TryParse(dic[&quot;Output&quot;].ToString(), out DWRID);
            return DWRID;
        }

        public int GetDWRListCount(string ContractNo, string filterSearch)
        {
            return DWRDAC.DAC.Instance.GetDWRListCount(ContractNo, filterSearch);
        }

        public DataSet GetDWRList(string ContractNo, object startRowIdx, object maxRows, string sortOrder,
                                  string filterSearch)
        {
            return DWRDAC.DAC.Instance.GetDWRList(ContractNo, startRowIdx, maxRows, sortOrder, filterSearch);
        }

        public DataTable GetContractAttributes(string ContractID, int projectID)
        {
            DataTable dtCont = DWRDAC.DAC.Instance.GetContractors(ContractID.ToInt32_2());
            return dtCont;
        }

        public ContmgtDTO.DTO GetContractDetails(string ContractID)
        {
            ContmgtDTO.DTO dto = BL.Instance.GetContract(ContractID.ToInt32_2(), FetchSet.All);
            return dto;
        }

        public MemoryStream GetPDF(int dprId, string path, string logoFilePath, String REQ)
        {
            var pdf = new PdfExport();
            var rpt = new ActiveReport();

            var subRptEqp = new ActiveReport();
            XmlReader XReader = XmlReader.Create(System.Web.HttpContext.Current.Server.MapPath(&quot;.&quot;) + &quot;\\DWREquipment.rpx&quot;);
            subRptEqp.LoadLayout(XReader);

            var subRptPer = new ActiveReport();
            XmlReader XmReader = XmlReader.Create(System.Web.HttpContext.Current.Server.MapPath(&quot;.&quot;) + &quot;\\DWRPersonnel.rpx&quot;);
            subRptPer.LoadLayout(XmReader);

            ((Label)subRptPer.Sections[&quot;GroupHeader1&quot;].Controls[&quot;Label13&quot;]).Text =
                LocalizationManager.GetString(KeyConstants.LOC_ICA_MANPOWER).ToUpper2();
            ((Label)subRptEqp.Sections[&quot;GroupHeader1&quot;].Controls[&quot;Label12&quot;]).Text =
                LocalizationManager.GetString(KeyConstants.LOC_ICA_EQUIPMENT).ToUpper2();

            var subRptCont = new ActiveReport();
            XmlReader XmmReader = XmlReader.Create(System.Web.HttpContext.Current.Server.MapPath(&quot;.&quot;) + &quot;\\DWRContractors.rpx&quot;);
            subRptCont.LoadLayout(XmmReader);


            var strm = new MemoryStream();
            XmlReader Reader = XmlReader.Create(System.Web.HttpContext.Current.Server.MapPath(&quot;.&quot;) + &quot;\\DWRReport.rpx&quot;);
            rpt.LoadLayout(Reader);
            rpt.PageSettings.Margins.Top = 0.5F;
            rpt.PageSettings.Margins.Left = 0.5F;
            rpt.PageSettings.Margins.Bottom = 0.5F;
            rpt.PageSettings.Margins.Right = 0.5F;
            rpt.PrintWidth = 7.5F;

            var ds = ((SqlDBDataSource)(rpt.DataSource));
            ds.ConnectionString = ConnectionHelper.GetConnectionString();

            var dsEq = ((SqlDBDataSource)(subRptEqp.DataSource));
            dsEq.ConnectionString = ConnectionHelper.GetConnectionString();

            var dsPer = ((SqlDBDataSource)(subRptPer.DataSource));
            dsPer.ConnectionString = ConnectionHelper.GetConnectionString();

            var dsCont = ((SqlDBDataSource)(subRptCont.DataSource));
            dsCont.ConnectionString = ConnectionHelper.GetConnectionString();


            if (File.Exists(logoFilePath))
            {
                Image logoImage = new Bitmap(logoFilePath);
                var pic = ((Picture)rpt.Sections[&quot;ReportHeader&quot;].Controls[&quot;rptLogo&quot;]);
                pic.Image = logoImage;
                if (logoImage.Height &gt; pic.Height * 100 ||
                    logoImage.Width &gt; pic.Width * 100)

                    pic.SizeMode = SizeModes.Zoom;
            }
            ((SubReport)rpt.Sections[&quot;GrpContractorStats&quot;].Controls[&quot;subRptEquipment&quot;]).Report = subRptEqp;
            ((SubReport)rpt.Sections[&quot;GrpContractorStats&quot;].Controls[&quot;subRptPersonnel&quot;]).Report = subRptPer;
            ((SubReport)rpt.Sections[&quot;GrpContractorStats&quot;].Controls[&quot;subRptContractors&quot;]).Report = subRptCont;

            rpt.Parameters[&quot;@dwrID&quot;].Value =
                subRptEqp.Parameters[&quot;@dwrID&quot;].Value =
                subRptPer.Parameters[&quot;@dwrID&quot;].Value = subRptCont.Parameters[&quot;@dwrID&quot;].Value = dprId.ToString2();
            subRptEqp.ShowParameterUI = subRptCont.ShowParameterUI = subRptPer.ShowParameterUI = false;
            rpt.ShowParameterUI = false;

            rpt.DataSource = ds;


            string strSign = GetSigFromDB(dprId);
            if (!string.IsNullOrEmpty(strSign))
            {
                Image sigImg = GetSignatureImage(strSign);
                if (sigImg != null)
                    ((Picture)rpt.Sections[&quot;ReportFooter&quot;].Controls[&quot;picSignature&quot;]).Image = sigImg;
            }
            rpt.Run();

            pdf.Export(rpt.Document, strm);
            return strm;
        }

        private string GetSigFromDB(int dprId)
        {
            return DWRDAC.DAC.Instance.GetSigFromDB(dprId);
        }

        public DataTable GetPostings(string ContractID, int DWRID)
        {
            return DWRDAC.DAC.Instance.GetPostings(ContractID.ToInt32_2(), DWRID);
        }

        private Bitmap GetSignatureImage(string Signature)
        {
            Bitmap image = null;
            try
            {
                if (!string.IsNullOrEmpty(Signature))
                {
                    string[] data = Signature.Split(&#39;,&#39;);
                    int count = ((data.Length - 1) / 3).ToInt32_2();
                    var x = new int[count];
                    var y = new int[count];
                    var z = new int[count];
                    int width = 0;
                    int height = 0;

                    for (int i = 0; i &lt; count; i++)
                    {
                        x[i] = data[i * 3].ToInt32_2();
                        if (width &lt; x[i])
                            width = x[i];
                        y[i] = data[i * 3 + 1].ToInt32_2();
                        if (height &lt; y[i])
                            height = y[i];
                        z[i] = data[i * 3 + 2].ToInt32_2();
                    }

                    width += 1;
                    height += 1;
                    image = new Bitmap(width, height);
                    var p = new GraphicsPath();
                    Graphics g = Graphics.FromImage(image);
                    g.FillRectangle(Brushes.White, new Rectangle(0, 0, width, height));
                    for (int i = 0; i &lt; count - 1; i++)
                    {
                        if (z[i] == 0)
                        {
                            if (z[i + 1] == 0)
                            {
                                p.AddLine(x[i], y[i], x[i + 1], y[i + 1]);
                                g.DrawPath(Pens.Black, p);
                                p = new GraphicsPath();
                            }
                        }
                    }
                }
            }
            catch (Exception Imgerr)
            {
                Console.WriteLine(&quot;Error creating Signature BLOG:&quot; + Imgerr.Message);
            }
            return image;
        }

        internal string GetUnApprovedPostingsForDWR(string dwrList)
        {
            return DWRDAC.DAC.Instance.GetUnApprovedPostingsForDWR(dwrList);
        }

        internal DataSet GetWorkingConditions()
        {
            DataSet ds = DWRDAC.DAC.Instance.GetWorkingConditions();

            if (ds.Tables.Count &gt;= 5)
            {
                ds.Tables[0].TableName = &quot;Rain&quot;;
                ds.Tables[1].TableName = &quot;Skies&quot;;
                ds.Tables[2].TableName = &quot;Soil&quot;;
                ds.Tables[3].TableName = &quot;Wind&quot;;
                ds.Tables[4].TableName = &quot;Working Conditions&quot;;
            }

            return ds;
        }

        public int CopyDWR(int dwrId, int UID)
        {
            return DWRDAC.DAC.Instance.CopyDWR(dwrId, UID);

        }

        #region ISubmit Members

        SyncStatus ISubmit.SubmitXmlData(string xmlData)
        {
            SyncStatus syncStatus = new SyncStatus();
            try
            {
                XmlDocument xDoc = new XmlDocument();
                xDoc.LoadXml(xmlData);

                string createdBy = string.Empty;
                XmlNode node;

                ContractManager.DTO.DWR myDwr = new ContractManager.DTO.DWR();

                if ((node = xDoc.SelectSingleNode(&quot;/formData&quot;)) != null)
                {
                    node = node.Attributes.GetNamedItem(&quot;CreatedBy&quot;);
                    if (node != null)
                        createdBy = node.Value;
                }
                int userID = UserManager.Instance.GetUID(createdBy);
                string userName = UserManager.Instance.GetUserName(userID);
                myDwr.ProjectName = &quot;&quot;;
                myDwr.BundleNo = &quot;&quot;;
                //myDwr.HighWay = &quot;&quot;;
                myDwr.ContractNo = &quot;&quot;;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractID&quot;)) != null)
                    myDwr.ContractID = Convert.ToInt32(node.InnerText);
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractNo&quot;)) != null)
                    myDwr.ContractNo = node.InnerText;
                //myDwr.FederalAidNo = &quot;&quot;;
                myDwr.Contractor = &quot;&quot;;
                DataTable dTable = BL.Instance.GetContractors(myDwr.ContractID);
                if (dTable.Rows.Count &gt; 0)
                {
                    DataRow[] rows = dTable.Select(&quot;CType = &#39;P&#39;&quot;);
                    if (rows.Length &gt; 0)
                    {
                        myDwr.Contractor = rows[0][&quot;Contact&quot;].ToString2();
                        myDwr.DWRContractorID = rows[0][&quot;ContractorID&quot;].ToInt32_2();
                        myDwr.ContractorValueType = rows[0][&quot;ValueandType&quot;].ToString2();
                    }
                }
                myDwr.Location = &quot;&quot;;
                //myDwr.LocationType = &quot;&quot;;
                //if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ReportNo&quot;)) != null)
                //    myDwr.ReportNo = node.InnerText;
                //if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/PreparedBy&quot;)) != null)
                //{
                //    myDwr.PreparedBy = node.InnerText;
                //    myDwr.UserID = node.InnerText;
                //    myDwr.UID = userID;
                //}
                //if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Comments&quot;)) != null)
                //    myDwr.ReviewComments = node.InnerText;
                int tempId;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Inspector&quot;)) != null &amp;&amp; int.TryParse(node.InnerText, out tempId))
                    myDwr.SiteSupervisorID = tempId;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/InspectorName&quot;)) != null)
                    myDwr.SiteSupervisor = node.InnerText;
                //if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Other&quot;)) != null)
                //    myDwr.Other = node.InnerText;

                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/WorkDate&quot;)) != null)
                    myDwr.WorkDate = Convert.ToDateTime(node.InnerText, CultureInfo.InstalledUICulture);
                //myDwr.CertNo = &quot;&quot;;
                //myDwr.Shift = &quot;&quot;;
                //myDwr.Day = &quot;&quot;;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/LowTemp&quot;)) != null)
                    myDwr.LowTemperature = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/HighTemp&quot;)) != null)
                    myDwr.HighTemperature = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Wind&quot;)) != null)
                    myDwr.Wind = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Sky&quot;)) != null)
                    myDwr.Weather = node.InnerText;
                //if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Precipitation&quot;)) != null)
                //    myDwr.Precipitation = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Notes&quot;)) != null)
                    myDwr.MaterialTestingNotes = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Comments&quot;)) != null)
                    myDwr.Notes = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Rain&quot;)) != null)
                    myDwr.Rain = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Soil&quot;)) != null)
                    myDwr.Soil = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/WorkingConditions&quot;)) != null)
                    myDwr.WorkingConditions = node.InnerText;
                myDwr.CreatedBy = userID;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/PName&quot;)) != null)
                    myDwr.ProjectName = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractNo&quot;)) != null)
                    myDwr.ContractNo = node.InnerText;
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractorHours&quot;)) != null)
                {
                    DataSet ds = new DataSet(&quot;ContractorHours&quot;);
                    DataTable ctTab = new DataTable(&quot;Contractors&quot;);
                    ctTab.Columns.AddRange(new DataColumn[]
                                           {
                                               new DataColumn(&quot;Contractor&quot;),
                                               new DataColumn(&quot;WorkHours&quot;)
                                           });
                    ds.Tables.Add(ctTab);
                    StringReader sReader = new StringReader(node.OuterXml);
                    ds.ReadXml(sReader, XmlReadMode.IgnoreSchema);
                    myDwr.DSContractors = ds;
                }
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractorEquipment&quot;)) != null)
                {
                    DataSet ds = new DataSet(&quot;ContractorEquipment&quot;);
                    //equipment
                    DataTable eqTab = new DataTable(&quot;EquipmentTable&quot;);
                    eqTab.Columns.AddRange(new DataColumn[]
                                           {
                                               new DataColumn(&quot;Contractor&quot;),
                                               new DataColumn(&quot;Equipment&quot;),
                                               new DataColumn(&quot;Quantity&quot;),
                                               new DataColumn(&quot;WorkHours&quot;),
                                               new DataColumn(&quot;Type&quot;)
                                           });

                    ds.Tables.Add(eqTab);
                    StringReader sReader = new StringReader(node.OuterXml);
                    ds.ReadXml(sReader, XmlReadMode.IgnoreSchema);
                    myDwr.DSEquipment = ds;
                }
                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractorPersonnel&quot;)) != null)
                {
                    DataSet ds = new DataSet(&quot;ContractorPersonnel&quot;);
                    //equipment
                    DataTable perTab = new DataTable(&quot;PersonnelTable&quot;);
                    perTab.Columns.AddRange(new DataColumn[]
                                           {
                                               new DataColumn(&quot;Contractor&quot;),
                                               new DataColumn(&quot;Personnel&quot;),
                                               new DataColumn(&quot;Number&quot;),
                                               new DataColumn(&quot;WorkHours&quot;),
                                               new DataColumn(&quot;Type&quot;)
                                           });
                    ds.Tables.Add(perTab);
                    StringReader sReader = new StringReader(node.OuterXml);
                    ds.ReadXml(sReader, XmlReadMode.IgnoreSchema);
                    myDwr.DSPersonnel = ds;
                }

                //myDwr.DSCRemarks = &quot;&quot;;
                //myDwr.DSCTrafficControl = &quot;&quot;;
                //myDwr.DSCMaterialsRejected = &quot;&quot;;
                //myDwr.DSCEquipment = &quot;&quot;;
                //myDwr.DSCEffectOnWork = &quot;&quot;;
                //myDwr.DSCProjectVisitors = &quot;&quot;;

                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ReportStatus&quot;)) != null)
                    myDwr.Status = node.InnerText;

                //DataSet ds_equipment = new DataSet();
                //DataSet ds_bridgeHours = new DataSet();
                //DataSet ds_activities = new DataSet();
                //DataSet ds_contractrs = new DataSet();

                //GetDataSets(ds_equipment, ds_bridgeHours, ds_activities, ds_contractrs);            
                //myDwr.DSBridgeHours = ds_bridgeHours;
                //myDwr.DSActivities = ds_activities;

                //if (xDoc.SelectSingleNode(&quot;/formData/Report/Attachments/Attachment&quot;) != null)
                //    myDwr.hasAttachments = true;

                if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/PreparedSignature&quot;)) != null)
                    myDwr.Signature = node.InnerText;

                //myDwr.DPRID = 0;
                myDwr.CreatedDate = DateTime.UtcNow;
                int dwrid = SaveDWRDetails(myDwr);
                if (dwrid &gt; 0)
                {
                    try
                    {
                        //object pid = ComponentHelper.Instance.ExecuteScalar(string.Format(&quot;select ProjectID from CONTMGTMaster where id={0}&quot;, myDwr.ContractID));
                        object pid = string.Format(ComponentHelper.Instance.ExecuteScalar(DailyWorkReportStoredProcedure.usp_CONTDWRGetSubmitXmlSelectedData, null, myDwr.ContractID).ToString2());
                        BrixWorkflowManager.Instance.CreateWorkflowForClient(&quot;CONTDWR&quot;, pid.ToString(), myDwr.ContractID.ToString(), dwrid.ToString());
                    }
                    catch { }
                    //DWR Extension ( Table Name: DWRExtension, ModuleID: DWREXTN)
                    //BrixFormModel model = BrixFormModel.GetInstance(&quot;DWREXTN&quot;, &quot;DWREXTN&quot;, HttpContext.Current.Request, HttpContext.Current.Response, &quot;Control&quot;);
                    //if (model != null)
                    //{
                    //string query = string.Format(&quot;insert into DWRExtension (DWRID,SECTION,InPlace,NeedsMaintenance,MaintenanceNotes,REVIEWCOMMENTS) VALUES ({0},{1},&#39;{2}&#39;,&#39;{3}&#39;,&#39;{4}&#39;,&#39;{5}&#39;); select scope_identity();&quot;,
                    //string query = string.Format(&quot;update CONTMGTDWRMain set InPlace=&#39;{1}&#39;,NeedsMaintenance=&#39;{2}&#39;,MaintenanceNotes=&#39;{3}&#39;,REVIEWCOMMENTS=&#39;{4}&#39; where DWRID = {0};&quot;,
                    //dwrid, //DWRID
                    //    //GetStringFromXml(xDoc, &quot;/formData/Report/Section&quot;), //SECTION
                    //GetStringFromXml(xDoc, &quot;/formData/Report/InPlace&quot;), //InPlace
                    //GetStringFromXml(xDoc, &quot;/formData/Report/Maintenance&quot;), //NeedsMaintenance
                    //GetStringFromXml(xDoc, &quot;/formData/Report/MaintenanceNotes&quot;), //MaintenanceNotes
                    //GetStringFromXml(xDoc, &quot;/formData/Report/AdditionalComments&quot;)); //REVIEWCOMMENTS
                    //ComponentHelper.Instance.ExecuteNonQuery(query);

                    ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(DailyWorkReportStoredProcedure.usp_CONTDWRUpdateDWRMaintenanceDetails, null, dwrid,
                    GetStringFromXml(xDoc, &quot;/formData/Report/InPlace&quot;), //InPlace
                    GetStringFromXml(xDoc, &quot;/formData/Report/Maintenance&quot;), //NeedsMaintenance
                    GetStringFromXml(xDoc, &quot;/formData/Report/MaintenanceNotes&quot;), //MaintenanceNotes
                    GetStringFromXml(xDoc, &quot;/formData/Report/AdditionalComments&quot;)); //REVIEWCOMMENTS);

                    if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractorHours&quot;)) != null)
                    {
                        DateTime workDate = DateTime.UtcNow;
                        if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/WorkDate&quot;)) != null)
                            workDate = Convert.ToDateTime(node.InnerText, CultureInfo.InstalledUICulture);

                        foreach (XmlNode xmlNode in node.SelectNodes(&quot;ContractorsTable&quot;))
                        {
                            XmlNode startTime = xmlNode.SelectSingleNode(&quot;StartTime&quot;);
                            XmlNode endTime = xmlNode.SelectSingleNode(&quot;EndTime&quot;);
                            XmlNode contractorID = xmlNode.SelectSingleNode(&quot;ContractorID&quot;);

                            DateTime startDateTime = workDate, endDateTime = workDate;
                            int hours = 0, minutes = 0;

                            if (!string.IsNullOrEmpty(startTime.InnerText))
                            {
                                hours = startTime.InnerText.Split(&quot;:&quot;.ToCharArray())[0].ToInt32_2();
                                minutes = startTime.InnerText.Split(&quot;:&quot;.ToCharArray())[1].ToInt32_2();
                                startDateTime = workDate.AddHours(hours).AddMinutes(minutes);
                            }

                            if (!string.IsNullOrEmpty(endTime.InnerText))
                            {
                                hours = endTime.InnerText.Split(&quot;:&quot;.ToCharArray())[0].ToInt32_2();
                                minutes = endTime.InnerText.Split(&quot;:&quot;.ToCharArray())[1].ToInt32_2();
                                endDateTime = workDate.AddHours(hours).AddMinutes(minutes);
                            }

                            //query = string.Format(&quot;insert into DWRContractorTimings (FKDWRID,Contractor,StartTime,EndTime) VALUES ({0},{1},&#39;{2}&#39;,&#39;{3}&#39;)&quot;, dwrid, contractorID.InnerText, startTime.InnerText, endTime.InnerText);
                            //ComponentHelper.Instance.ExecuteNonQuery(query);
                            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(DailyWorkReportStoredProcedure.usp_CONTDWRInsertDWRContractorTimings, null, 
                                dwrid, contractorID.InnerText, startDateTime.ToDateTimeString_ForDatabaseOpenXml(), endDateTime.ToDateTimeString_ForDatabaseOpenXml());
                        }
                    }
                    if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractorEquipment&quot;)) != null)
                    {
                        foreach (XmlNode xmlNode in node.SelectNodes(&quot;EquipmentTable&quot;))
                        {
                            int activeFlag;
                            //XmlNode equipment = xmlNode.SelectSingleNode(&quot;Equipment&quot;);
                            XmlNode quantity = xmlNode.SelectSingleNode(&quot;Quantity&quot;);
                            XmlNode active = xmlNode.SelectSingleNode(&quot;Active&quot;);
                            XmlNode contractorID = xmlNode.SelectSingleNode(&quot;ContractorID&quot;);
                            XmlNode eqpType = xmlNode.SelectSingleNode(&quot;EquipmentID&quot;);
                            if (active.InnerText == &quot;Active&quot;)
                                activeFlag = 0;
                            else
                                activeFlag = 1;
                            //query = string.Format(&quot;insert into CONTDWREquipments (FKDWRID,EqpContractor,EqpType,EqpQuantity,IsActive) VALUES ({0},{1},&#39;{2}&#39;,{3},{4})&quot;, dwrid, contractorID.InnerText, eqpType.InnerText, quantity.InnerText, active.InnerText == &quot;Active&quot; ? 0 : 1);
                            //ComponentHelper.Instance.ExecuteNonQuery(query);
                            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(DailyWorkReportStoredProcedure.usp_CONTDWRInsertDWREquipments, null, dwrid, contractorID.InnerText, eqpType.InnerText, quantity.InnerText, activeFlag);
                        }
                    }
                    if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/ContractorPersonnel&quot;)) != null)
                    {
                        foreach (XmlNode xmlNode in node.SelectNodes(&quot;PersonnelTable&quot;))
                        {
                            //XmlNode personnel = xmlNode.SelectSingleNode(&quot;Personnel&quot;);
                            XmlNode quantity = xmlNode.SelectSingleNode(&quot;Quantity&quot;);
                            XmlNode contractorID = xmlNode.SelectSingleNode(&quot;ContractorID&quot;);
                            XmlNode labType = xmlNode.SelectSingleNode(&quot;PersonnelID&quot;);
                            //query = string.Format(&quot;insert into CONTDWRLabours (FKDWRID,LabContractor,LabType,LabQuantity) VALUES ({0},{1},&#39;{2}&#39;,{3})&quot;, dwrid, contractorID.InnerText, labType.InnerText, quantity.InnerText);
                            //ComponentHelper.Instance.ExecuteNonQuery(query);
                            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(DailyWorkReportStoredProcedure.usp_CONTDWRInsertDWRLabours, null, dwrid, contractorID.InnerText, labType.InnerText, quantity.InnerText);
                        }
                    }
                    //}

                    if ((node = xDoc.SelectSingleNode(&quot;/formData/Report/Attachments&quot;)) != null)
                    {
                        IEnumerator attachmentEn = node.GetEnumerator();
                        while (attachmentEn.MoveNext())
                        {
                            XmlNode attachmentNode = attachmentEn.Current as XmlNode;
                            if (attachmentNode != null)
                            {
                                if (!attachmentNode.Name.Equals(&quot;Attachment&quot;)) continue;
                                XmlNode fNameNode = attachmentNode.Attributes.GetNamedItem(&quot;FileName&quot;);
                                XmlNode fDescNode = attachmentNode.Attributes.GetNamedItem(&quot;FileDescription&quot;);
                                string filename = Path.GetFileName(fNameNode.Value);
                                string desc = (fDescNode != null) ? fDescNode.Value : string.Empty;

                                int folderid = DocumentManager.Instance.GetParentFolderIdForModule(dwrid.ToString(), &quot;CONTDWR&quot;, &quot;CONTMGT&quot;, myDwr.ContractID);
                                int docid = DocumentManager.Instance.SaveDocument(folderid, filename,
                                    Convert.FromBase64String(attachmentNode.InnerXml), userID, userName, MWDateTimeHelper.MWToday, desc, null, false, Convert.ToString(dwrid), &quot;CONTDWR&quot;);
                                if (docid &gt; 0)
                                    LinksManager.Instance.AddLinks(filename, Convert.ToString(dwrid), &quot;CONTDWR&quot;,
                                        Convert.ToString(docid), &quot;DOCMGMT&quot;, userName, string.Empty, desc);
                            }
                        }
                    }
                    syncStatus.Status = true;
                }
                else
                {
                    syncStatus.StatusMessage = &quot;Save DWR details failed.&quot;;
                    syncStatus.Status = false;
                }
            }
            catch (Exception ex)
            {
                Logging.Logger.Log(Enumerations.LogType.Error, ex.StackTrace, &quot;CONTDWR&quot;);
                syncStatus.StatusMessage = ex.Message;
                syncStatus.Status = false;
            }
            return syncStatus;
        }

        private string GetStringFromXml(XmlDocument xDoc, string path)
        {
            XmlNode node = xDoc.SelectSingleNode(path);
            return (node != null) ? node.InnerText.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) : &quot;&quot;;
        }

        ///// &lt;summary&gt;
        ///// Get the Bitmap image of the signature
        ///// &lt;/summary&gt;
        ///// &lt;param name=&quot;Signature&quot;&gt;Signature&lt;/param&gt;
        ///// &lt;returns&gt;Bitmap Image&lt;/returns&gt;
        //public Bitmap GetSignatureImage(string Signature)
        //{
        //    Bitmap image = null;
        //    try
        //    {
        //        if (!string.IsNullOrEmpty(Signature))
        //        {
        //            string[] data = Signature.Split(&#39;,&#39;);
        //            int count = Convert.ToInt32((data.Length - 1) / 3);
        //            int[] x = new int[count];
        //            int[] y = new int[count];
        //            int[] z = new int[count];
        //            int width = 0;
        //            int height = 0;

        //            for (int i = 0; i &lt; count; i++)
        //            {
        //                x[i] = Convert.ToInt32(data[i * 3]);
        //                if (width &lt; x[i])
        //                    width = x[i];
        //                y[i] = Convert.ToInt32(data[i * 3 + 1]);
        //                if (height &lt; y[i])
        //                    height = y[i];
        //                z[i] = Convert.ToInt32(data[i * 3 + 2]);
        //            }

        //            width += 1;
        //            height += 1;
        //            image = new Bitmap(width, height);
        //            GraphicsPath p = new GraphicsPath();
        //            Graphics g = Graphics.FromImage(image);
        //            g.FillRectangle(Brushes.White, new Rectangle(0, 0, width, height));
        //            for (int i = 0; i &lt; count - 1; i++)
        //            {
        //                if (z[i] == 0)
        //                {
        //                    if (z[i + 1] == 0)
        //                    {
        //                        p.AddLine(x[i], y[i], x[i + 1], y[i + 1]);
        //                        g.DrawPath(Pens.Black, p);
        //                        p = new GraphicsPath();
        //                    }
        //                }
        //            }
        //        }
        //    }
        //    catch (Exception Imgerr)
        //    {
        //        Console.WriteLine(&quot;Error creating Signature BLOG:&quot; + Imgerr.Message);
        //    }
        //    return image;
        //}

        #endregion
    }

    [Context(Name = &quot;CONTDWR&quot;)]
    public class COBreadCrumb : ContractBreadCrumb
    {
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[34,9,34,77,1],[35,9,35,62,1],[36,9,36,28,1],[36,29,36,30,1],[36,31,36,32,1],[40,13,40,14,1],[41,17,41,30,1],[42,17,42,18,1],[43,21,43,39,1],[43,40,43,85,1],[44,21,44,82,1],[45,21,45,60,1],[46,25,46,69,1],[48,21,48,50,1],[50,13,50,14,1],[55,9,55,10,0],[56,13,56,86,0],[57,9,57,10,0],[61,9,61,10,0],[62,13,62,56,0],[63,13,63,45,0],[64,13,65,66,0],[67,13,67,62,0],[68,13,68,26,0],[69,9,69,10,0],[73,9,73,10,0],[74,13,74,61,0],[75,9,75,10,0],[78,9,78,10,0],[79,13,81,92,0],[82,9,82,10,0],[85,9,85,10,1],[86,13,86,56,1],[87,13,87,31,1],[88,13,89,109,1],[91,13,91,64,1],[92,13,92,27,1],[93,9,93,10,1],[96,9,96,10,1],[97,13,99,116,1],[100,9,100,10,1],[103,9,103,10,1],[104,13,104,56,1],[105,13,105,31,1],[106,13,107,111,1],[109,13,109,63,1],[110,13,110,26,1],[111,9,111,10,1],[114,9,114,10,0],[115,13,115,56,0],[116,13,117,102,0],[120,13,120,63,0],[121,13,121,26,0],[122,9,122,10,0],[125,9,125,10,0],[126,13,126,82,0],[127,9,127,10,0],[131,9,131,10,0],[132,13,132,110,0],[133,9,133,10,0],[136,9,136,10,0],[137,13,137,91,0],[138,13,138,27,0],[139,9,139,10,0],[142,9,142,10,0],[143,13,143,96,0],[144,13,144,24,0],[145,9,145,10,0],[148,9,148,10,0],[149,13,149,39,0],[150,13,150,42,0],[152,13,152,48,0],[153,13,153,125,0],[154,13,154,43,0],[156,13,156,48,0],[157,13,157,126,0],[158,13,158,44,0],[160,13,161,89,0],[162,13,163,90,0],[165,13,165,49,0],[166,13,166,129,0],[167,13,167,46,0],[170,13,170,43,0],[171,13,171,121,0],[172,13,172,36,0],[173,13,173,49,0],[174,13,174,50,0],[175,13,175,52,0],[176,13,176,51,0],[177,13,177,35,0],[179,13,179,58,0],[180,13,180,74,0],[182,13,182,66,0],[183,13,183,76,0],[185,13,185,67,0],[186,13,186,77,0],[188,13,188,69,0],[189,13,189,78,0],[192,13,192,43,0],[193,13,193,14,0],[194,17,194,60,0],[195,17,195,87,0],[196,17,196,39,0],[197,17,198,55,0],[200,21,200,51,0],[201,13,201,14,0],[202,13,202,108,0],[203,13,203,108,0],[204,13,204,111,0],[206,13,208,114,0],[209,13,209,104,0],[210,13,210,41,0],[212,13,212,33,0],[215,13,215,50,0],[216,13,216,48,0],[217,13,217,14,0],[218,17,218,59,0],[219,17,219,36,0],[220,21,220,101,0],[221,13,221,14,0],[222,13,222,23,0],[224,13,224,44,0],[225,13,225,25,0],[226,9,226,10,0],[229,9,229,10,0],[230,13,230,60,0],[231,9,231,10,0],[234,9,234,10,0],[235,13,235,83,0],[236,9,236,10,0],[239,9,239,10,0],[240,13,240,33,0],[242,13,242,14,0],[243,17,243,54,0],[244,17,244,18,0],[245,21,245,58,0],[246,21,246,69,0],[247,21,247,44,0],[248,21,248,44,0],[249,21,249,44,0],[250,21,250,35,0],[251,21,251,36,0],[253,26,253,35,0],[253,37,253,46,0],[253,48,253,51,0],[254,21,254,22,0],[255,25,255,56,0],[256,25,256,42,0],[257,29,257,42,0],[258,25,258,60,0],[259,25,259,43,0],[260,29,260,43,0],[261,25,261,60,0],[262,21,262,22,0],[264,21,264,32,0],[265,21,265,33,0],[266,21,266,55,0],[267,21,267,48,0],[268,21,268,60,0],[269,21,269,88,0],[270,26,270,35,0],[270,37,270,50,0],[270,52,270,55,0],[271,21,271,22,0],[272,25,272,39,0],[273,25,273,26,0],[274,29,274,47,0],[275,29,275,30,0],[276,33,276,75,0],[277,33,277,59,0],[278,33,278,56,0],[279,29,279,30,0],[280,25,280,26,0],[281,21,281,22,0],[282,17,282,18,0],[283,13,283,14,0],[284,13,284,37,0],[285,13,285,14,0],[286,17,286,86,0],[287,13,287,14,0],[288,13,288,26,0],[289,9,289,10,0],[292,9,292,10,0],[293,13,293,77,0],[294,9,294,10,0],[297,9,297,10,0],[298,13,298,69,0],[300,13,300,38,0],[301,13,301,14,0],[302,17,302,49,0],[303,17,303,50,0],[304,17,304,49,0],[305,17,305,49,0],[306,17,306,63,0],[307,13,307,14,0],[309,13,309,23,0],[310,9,310,10,0],[313,9,313,10,0],[314,13,314,60,0],[316,9,316,10,0],[321,9,321,10,0],[322,13,322,54,0],[324,13,324,14,0],[325,17,325,54,0],[326,17,326,39,0],[328,17,328,49,0],[331,17,331,79,0],[333,17,333,73,0],[334,17,334,18,0],[335,21,335,70,0],[336,21,336,38,0],[337,25,337,48,0],[338,17,338,18,0],[339,17,339,69,0],[340,17,340,76,0],[341,17,341,40,0],[342,17,342,37,0],[344,17,344,39,0],[345,17,345,91,0],[346,21,346,72,0],[347,17,347,91,0],[348,21,348,55,0],[350,17,350,39,0],[351,17,351,81,0],[352,17,352,43,0],[353,17,353,18,0],[354,21,354,67,0],[355,21,355,41,0],[356,21,356,22,0],[357,25,357,75,0],[358,25,358,85,0],[359,25,359,89,0],[360,21,360,22,0],[361,17,361,18,0],[362,17,362,37,0],[375,17,375,134,0],[376,21,376,53,0],[377,17,377,94,0],[378,21,378,59,0],[382,17,382,89,0],[383,21,383,105,0],[387,17,387,88,0],[388,21,388,59,0],[389,17,389,89,0],[390,21,390,60,0],[391,17,391,85,0],[392,21,392,49,0],[393,17,393,84,0],[394,21,394,52,0],[397,17,397,86,0],[398,21,398,65,0],[399,17,399,89,0],[400,21,400,50,0],[401,17,401,85,0],[402,21,402,49,0],[403,17,403,85,0],[404,21,404,49,0],[405,17,405,98,0],[406,21,406,62,0],[407,17,407,42,0],[408,17,408,86,0],[409,21,409,56,0],[410,17,410,91,0],[411,21,411,55,0],[412,17,412,96,0],[413,17,413,18,0],[414,21,414,65,0],[415,21,415,68,0],[416,21,420,47,0],[421,21,421,42,0],[422,21,422,76,0],[423,21,423,67,0],[424,21,424,46,0],[425,17,425,18,0],[426,17,426,100,0],[427,17,427,18,0],[428,21,428,69,0],[430,21,430,71,0],[431,21,438,47,0],[440,21,440,42,0],[441,21,441,76,0],[442,21,442,67,0],[443,21,443,44,0],[444,17,444,18,0],[445,17,445,100,0],[446,17,446,18,0],[447,21,447,69,0],[449,21,449,72,0],[450,21,457,47,0],[458,21,458,43,0],[459,21,459,76,0],[460,21,460,67,0],[461,21,461,44,0],[462,17,462,18,0],[471,17,471,93,0],[472,21,472,51,0],[486,17,486,98,0],[487,21,487,54,0],[490,17,490,53,0],[491,17,491,51,0],[492,17,492,31,0],[493,17,493,18,0],[495,21,495,22,0],[497,25,497,196,0],[498,25,498,152,0],[499,21,499,22,0],[500,21,500,26,0],[500,27,500,28,0],[500,29,500,30,0],[515,21,519,84,0],[521,21,521,100,0],[522,21,522,22,0],[523,25,523,61,0],[524,25,524,97,0],[525,29,525,107,0],[527,25,527,32,0],[527,34,527,49,0],[527,50,527,52,0],[527,53,527,89,0],[528,25,528,26,0],[529,29,529,87,0],[530,29,530,83,0],[531,29,531,93,0],[533,29,533,62,0],[533,64,533,86,0],[534,29,534,42,0],[534,44,534,55,0],[536,29,536,76,0],[537,29,537,30,0],[538,33,538,101,0],[539,33,539,103,0],[540,33,540,94,0],[541,29,541,30,0],[543,29,543,74,0],[544,29,544,30,0],[545,33,545,99,0],[546,33,546,101,0],[547,33,547,92,0],[548,29,548,30,0],[552,29,553,168,0],[554,25,554,26,0],[555,21,555,22,0],[556,21,556,104,0],[557,21,557,22,0],[558,25,558,32,0],[558,34,558,49,0],[558,50,558,52,0],[558,53,558,87,0],[559,25,559,26,0],[562,29,562,85,0],[563,29,563,81,0],[564,29,564,93,0],[565,29,565,87,0],[566,29,566,62,0],[567,33,567,48,0],[569,33,569,48,0],[572,29,572,243,0],[573,25,573,26,0],[574,21,574,22,0],[575,21,575,104,0],[576,21,576,22,0],[577,25,577,32,0],[577,34,577,49,0],[577,50,577,52,0],[577,53,577,87,0],[578,25,578,26,0],[580,29,580,85,0],[581,29,581,93,0],[582,29,582,87,0],[585,29,585,228,0],[586,25,586,26,0],[587,21,587,22,0],[590,21,590,96,0],[591,21,591,22,0],[592,25,592,73,0],[593,25,593,56,0],[594,25,594,26,0],[595,29,595,86,0],[596,29,596,56,0],[597,29,597,30,0],[598,33,598,79,0],[598,80,598,89,0],[599,33,599,104,0],[600,33,600,111,0],[601,33,601,85,0],[602,33,602,100,0],[604,33,604,158,0],[605,33,606,187,0],[607,33,607,47,0],[608,37,609,107,0],[610,29,610,30,0],[611,25,611,26,0],[612,21,612,22,0],[613,21,613,46,0],[614,17,614,18,0],[616,17,616,18,0],[617,21,617,75,0],[618,21,618,47,0],[619,17,619,18,0],[620,13,620,14,0],[621,13,621,33,0],[622,13,622,14,0],[623,17,623,90,0],[624,17,624,55,0],[625,17,625,43,0],[626,13,626,14,0],[627,13,627,31,0],[628,9,628,10,0],[631,9,631,10,0],[632,13,632,56,0],[633,13,633,76,0],[634,9,634,10,0]]);
    </script>
  </body>
</html>