<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Common\BrixChecklist.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Web;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.BusinessLayer.DTO;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Infragistics.WebUI.UltraWebGrid;

namespace Aurigo.AMP3.Core.UI.Common
{
    public partial class BrixChecklist : BrixPageBase
    {
        private ChecklistModel checkListModel;

        private Mode mode = Mode.View;
        private List&lt;string&gt; strPermList;
        private List&lt;string&gt; permissionsForChecklist;

        protected override void OnPreInit(EventArgs e)
        {
            int projectID = 0;
            projectID = (String.IsNullOrEmpty(Request[&quot;PID&quot;])) ? 0 : Request[&quot;PID&quot;].ToInt32_2();

            ModuleId = (projectID == 0 &amp;&amp;
                        Request[&quot;Context&quot;].ToString2() == Constants.MODID_LANDMGT)
                ? Constants.MODID_LANDMGT
                : (projectID &gt; 0 &amp;&amp;
                   Request[&quot;Context&quot;].ToString2() == Constants.MODID_LANDMGT)
                    ? Constants.MODID_PROJECT
                    : Request[&quot;Context&quot;];

            checkListModel = ChecklistModel.GetInstance(Request, Response);
            ContextElement = ContextMenuManager.Instance.GetContextElement(checkListModel.GetType());
            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            ContextElementUGrid = uwgResource;
            base.OnInit(e);
        }

        public override int GetProjectIdFromInstanceId()
        {
            if (checkListModel == null)
            {
                checkListModel = ChecklistModel.GetInstance(Request, Response);
            }

            int parentID = -1;

            if (!String.IsNullOrEmpty(Request[&quot;ParentID&quot;]))
            {
                int.TryParse(Request[&quot;ParentID&quot;], out parentID);
            }

            return checkListModel.GetProjectIdFromInstanceId(parentID);
        }

        bool IsProposedProject
        {
            get
            {
                return (HttpContext.Current.Request == null ||
                        string.IsNullOrEmpty(HttpContext.Current.Request.QueryString[&quot;PP&quot;])
                    ? false
                    : (HttpContext.Current.Request.QueryString[&quot;PP&quot;] == &quot;1&quot;) ? true : false);
            }
        }

        string onAccessDeniedRedirectToURL = string.Empty;

        public override bool CheckAccess()
        {
            strPermList = (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS];

            string strModID = string.Empty;
            if (null != Request[&quot;Context&quot;])
                strModID = Request[&quot;Context&quot;];
            else
                strModID = string.Empty;

            if (strModID == &quot;PROJECT&quot;)
                strModID = &quot;CHKPRJL&quot;;
            else if (strModID == &quot;LANDMGT&quot;)
                strModID = &quot;CHKLANL&quot;;
            else if (strModID == &quot;CONTMGT&quot;)
                strModID = &quot;CHKCONL&quot;;
            else if (strModID == &quot;ESTMATE&quot;)
                strModID = &quot;CHKESTL&quot;;
            else
                strModID = string.Empty;

            permissionsForChecklist = ModuleManager.Instance.GetPermissionByUserOrRole(strModID,
                UserDetail.GetCurrentUserDetail().UID,
                UserDetail.GetCurrentUserDetail().RID, PID);

            if (!String.IsNullOrEmpty(Request[&quot;ParentID&quot;]))
            {
                if (!strPermList.Contains(&quot;View&quot;))
                {
                    onAccessDeniedRedirectToURL = ResolveUrl((IsProposedProject)
                            ? &quot;~/Common/BrixListPage.aspx?context=PROJECT&amp;PP=1&quot;
                            : &quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;);
                    return false;
                    //UIHelper.RedirectURL(
                    //    &quot;The current role does not have the required permissions to view this page.&quot;,
                    //    ResolveUrl((IsProposedProject)
                    //        ? &quot;~/Common/BrixListPage.aspx?context=PROJECT&amp;PP=1&quot;
                    //        : &quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;), null, Context);
                }
                if (!string.IsNullOrEmpty(strModID) &amp;&amp;
                    !(permissionsForChecklist.Contains(&quot;Checklist Create&quot;) ||
                      permissionsForChecklist.Contains(&quot;Checklist Edit&quot;) ||
                      permissionsForChecklist.Contains(&quot;Checklist Complete&quot;)))
                {
                    onAccessDeniedRedirectToURL = ResolveUrl((IsProposedProject)
                            ? &quot;~/Common/BrixListPage.aspx?context=PROJECT&amp;PP=1&quot;
                            : &quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;);
                    return false;
                    //UIHelper.RedirectURL(
                    //    &quot;The current role does not have the required permissions to view this page.&quot;,
                    //    ResolveUrl((IsProposedProject)
                    //        ? &quot;~/Common/BrixListPage.aspx?context=PROJECT&amp;PP=1&quot;
                    //        : &quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;), null, Context);
                }
            }
            return true;
        }

        public override void OnAccessDeniedRedirect()
        {
            if (!string.IsNullOrEmpty(onAccessDeniedRedirectToURL))
            {
                UIHelper.RedirectURL(
                        &quot;The current role does not have the required permissions to view this page.&quot;,
                        onAccessDeniedRedirectToURL, null, Context);
            }
            else
            {
                base.OnAccessDeniedRedirect();
            }
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            lblError.Text = string.Empty;
            UIHelper.DisableRoleSelection(Page);
            
            CheckForModulePermissions();

            if (!string.IsNullOrEmpty(Request[&quot;Mode&quot;]))
                mode = Request[&quot;Mode&quot;].Equals(Mode.New.ToString2())
                    ? Mode.New
                    : Request[&quot;Mode&quot;].Equals(Mode.Edit.ToString2()) ? Mode.Edit : Mode.View;

            ModuleID = Request[&quot;Context&quot;];
            PID = Request[&quot;PID&quot;].ToInt32_2();
            EnterpriseLM = String.IsNullOrEmpty(Request[&quot;ENTPRSE_LM&quot;])
                ? String.Empty
                : Request[&quot;ENTPRSE_LM&quot;].ToString2();
            LMID = String.IsNullOrEmpty(Request[&quot;LMID&quot;]) ? 0 : Request[&quot;LMID&quot;].ToInt32_2();

            if (ModuleID.Equals(&quot;WORKORD&quot;))
                PageTitle = &quot;Work Order - Checklists&quot;;

//            AssignInstanceID(ModuleID);
            // Signature changed due to refactoring
            AssignInstanceID();

            if (!Page.IsPostBack)
            {
                GetChecklists();
            }
        }

        #region &quot;Button Clicks&quot;

        protected override void CreateChildControls()
        {
            //var menus = new MenuArray();

            //menus.Add(new BrixMenu(&quot;lnkNew&quot;, &quot;New&quot;, &quot;Icn_New.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkEdit&quot;, &quot;Edit&quot;, &quot;IcnEdit.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkDelete&quot;, &quot;Delete&quot;, &quot;Icn_Delete.png&quot;, 55));

            //checkListModel.CustomMenu(menus);

            //menus.Add(new BrixMenu(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;));

            //if (Request[&quot;Context&quot;].Equals(&quot;WORKORD&quot;))
            //    menus.Add(new BrixMenu(&quot;lnkBack&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;));

            //CreateToolBarMenu(menus, null);
            var menuGroups = new List&lt;MenuGroup&gt;();
            checkListModel.CustomMenu(menuGroups);
            CreateToolBarMenu(menuGroups, null);
        }

        protected override void CustomizeToolBar()
        {
            MainToolBar.GetMenuReference(&quot;lnkNew&quot;).Click += lnkNew_Click;
            MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Click += lnkEdit_Click;
            MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).Click += btnCheckListDelete_Click;
            MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += btnMainSave_Click;

            MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).OnClientClick = &quot;return ValidateDelete(&#39;Delete&#39;);&quot;;
            MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).OnClientClick = &quot;return ValidateDelete(&#39;Edit&#39;);&quot;;
            MainToolBar.GetMenuReference(&quot;lnkSave&quot;).OnClientClick = &quot;return ValidateSave();&quot;;

            //The report link click events are added if the reports are present.
            if (MainToolBar.GetMenuReference(&quot;lnkReportChecklist&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkReportChecklist&quot;).Click += lnkReportChecklist_Click;
            if (MainToolBar.GetMenuReference(&quot;lnReportkChecklistPending&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnReportkChecklistPending&quot;).Click += lnReportkChecklistPending_Click;

            if (MainToolBar.GetMenuReference(&quot;lnkBack&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).Click += lnkBack_Click;

            strPermList = checkListModel.CustomMainToolBar(MainToolBar, Context, Request);

            string strModID = string.Empty;
            if (null != Request[&quot;Context&quot;])
                strModID = Request[&quot;Context&quot;];
            else
                strModID = string.Empty;

            if (strModID == &quot;PROJECT&quot;)
                strModID = &quot;CHKPRJL&quot;;
            else if (strModID == &quot;LANDMGT&quot;)
                strModID = &quot;CHKLANL&quot;;
            else if (strModID == &quot;CONTMGT&quot;)
                strModID = &quot;CHKCONL&quot;;
            else if (strModID == &quot;ESTMATE&quot;)
                strModID = &quot;CHKESTL&quot;;

            List&lt;string&gt; permissionsForChecklist = ModuleManager.Instance.GetPermissionByUserOrRole(strModID,
                UserDetail.GetCurrentUserDetail().UID,
                UserDetail.GetCurrentUserDetail().RID, PID);

            MainToolBar.GetMenuReference(&quot;lnkNew&quot;).Enabled = permissionsForChecklist.Contains(&quot;Checklist Create&quot;);
            MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Enabled = permissionsForChecklist.Contains(&quot;Checklist Edit&quot;);
            MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Enabled = (permissionsForChecklist.Contains(&quot;Checklist Complete&quot;) ||
                                                               permissionsForChecklist.Contains(&quot;Checklist Edit&quot;));

            if (!string.IsNullOrEmpty(Request[&quot;IsReadOnly&quot;]) &amp;&amp; Request[&quot;IsReadOnly&quot;].Equals(&quot;Y&quot;))
            {
                MainToolBar.GetMenuReference(&quot;lnkNew&quot;).Enabled =
                    MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Enabled =
                        MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).Enabled = false;
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Enabled = false;
            }
        }

        protected void lnkReportChecklist_Click(object sender, EventArgs e)
        {
            Response.Redirect(
                @&quot;~/Common/BrixReportPage.aspx?Context=GENCHKLIST&amp;Code=ALL&amp;MODID=CHECKLIST&amp;ParentID=&quot; + InstanceID.ToString2() + &quot;&amp;ModuleID=&quot; + Request[&quot;Context&quot;] + &quot;&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ContractID=&quot; + Request[&quot;ParentID&quot;] +
                &quot;&amp;ContextType=&quot; + Request[&quot;Context&quot;] + &quot;&amp;LMID=&quot; + Request[&quot;LMID&quot;] +
                (String.IsNullOrEmpty(Request[&quot;IsReadOnly&quot;]) ? String.Empty : &quot;&amp;IsReadOnly=&quot; + Request[&quot;IsReadOnly&quot;]), true);
        }

        protected void lnReportkChecklistPending_Click(object sender, EventArgs e)
        {
            Response.Redirect(
                @&quot;~/Common/BrixReportPage.aspx?Context=GENCHKLIST&amp;Code=PENDING&amp;MODID=CHECKLIST&amp;ParentID=&quot; + InstanceID.ToString2() + &quot;&amp;ModuleID=&quot; + Request[&quot;Context&quot;] + &quot;&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ContractID=&quot; + Request[&quot;ParentID&quot;] +
                &quot;&amp;ContextType=&quot; + Request[&quot;Context&quot;] +  &quot;&amp;LMID=&quot; + Request[&quot;LMID&quot;] +
                (String.IsNullOrEmpty(Request[&quot;IsReadOnly&quot;]) ? String.Empty : &quot;&amp;IsReadOnly=&quot; + Request[&quot;IsReadOnly&quot;]), true);
        }

        protected void lnkBack_Click(object sender, EventArgs e)
        {
            Response.Redirect(
                @&quot;~/Common/BrixListPage.aspx?context=WORKORD&amp;PID=&quot; + PID + &quot;&amp;ContractID=&quot; + Request[&quot;ContractID&quot;], true);
        }

        // Deletes the checklist
        protected void btnCheckListDelete_Click(object sender, EventArgs e)
        {
            try
            {
                DataTable dtTemp = GetGridData();

                string queryDelete = String.Empty;

                switch (hdnMode.Value)
                {
                    case &quot;C&quot;:
                        queryDelete = &quot;CheckListName=&#39;&quot; + hdnChkList.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
                        break;
                    case &quot;S&quot;:
                        queryDelete = &quot;CheckListName=&#39;&quot; + hdnChkList.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot; +
                                      &quot; AND StageName = &#39;&quot; + hdnStage.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
                        break;
                    case &quot;A&quot;:
                        queryDelete = &quot;CheckListName=&#39;&quot; + hdnChkList.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot; +
                                      &quot; AND StageName = &#39;&quot; + hdnStage.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot; +
                                      &quot; AND ActivityID = &quot; + hdnActivity.Value;
                        break;
                }

                if (hdnMode.Value == &quot;S&quot; || hdnMode.Value == &quot;A&quot;)
                {
                    string checkStageOrActivityCount = &quot;CheckListName=&#39;&quot; + hdnChkList.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;

                    DataRow[] drTemp = dtTemp.Select(checkStageOrActivityCount);

                    if (drTemp.Length == 1)
                    {
                        lblError.Text = (hdnMode.Value == &quot;S&quot;)
                            ? &quot;Checklist Should have a stage. Stage Cannot be deleted.&quot;
                            : &quot;Checklist should have an activity. Activity cannot be deleted.&quot;;
                        FormatChecklistGrid();
                        return;
                    }
                }

                DataRow[] dr = dtTemp.Select(queryDelete);

                int checklistID = 0;
                int stageID = 0;
                if (dr != null)
                {
                    checklistID = dr[0][COL_CHECKLISTID].ToInt32_2();
                    stageID = dr[0][COL_STAGEID].ToInt32_2();
                }

                foreach (DataRow row in dr)
                    dtTemp.Rows.Remove(row);

                if (dtTemp.Rows.Count == 0)
                    dtTemp = null;

                if (dtTemp != null)
                    uwgResource.DataSource = dtTemp.ToMWDateTime(); 
                else
                    uwgResource.DataSource = null;
                uwgResource.DataBind();

                if (dtTemp != null)
                    FormatChecklistGrid();

                MasterSave(checklistID, stageID);
            }
            catch (Exception ex)
            {
                Logger.Log(Enumerations.LogType.Error, ex.Message, MODULENAME);
                lblError.Text = ex.Message;
            }
        }

        // Saves the completed flag of the checklist
        protected void btnMainSave_Click(object sender, EventArgs e)
        {
            try
            {
                MasterSave(0, 0);
            }
            catch (Exception ex)
            {
                Logger.Log(Enumerations.LogType.Error, ex.Message, MODULENAME);
                lblError.Text = ex.Message;
            }
        }

        protected void lnkNew_Click(object sender, EventArgs e)
        {
            string url =
                &quot;~/Common/BrixNewChecklist.aspx?Context={0}&amp;PID={1}&amp;Mode=N&quot;.Format2(ModuleID, PID.ToString2()) +
                ModuleSpecificQueryString();
            Response.Redirect(
                url +
                (String.IsNullOrEmpty(Request[&quot;IsReadOnly&quot;]) ? String.Empty : &quot;&amp;IsReadOnly=&quot; + Request[&quot;IsReadOnly&quot;]) +
                (url.ToLower().Contains(&quot;contractid&quot;) || String.IsNullOrEmpty(Request[&quot;ContractID&quot;])
                    ? String.Empty
                    : &quot;&amp;ContractID=&quot; + Request[&quot;ContractID&quot;]), true);
        }

        protected void lnkEdit_Click(object sender, EventArgs e)
        {
            DataTable dtChecklistCollection = GetGridData();

            string query = String.Empty;
            switch (hdnMode.Value)
            {
                case &quot;S&quot;:
                case &quot;A&quot;:
                    query = COL_STAGENAME + &quot;=&#39;&quot; + hdnStage.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot; + &quot; AND &quot; + COL_CHECKLISTNAME +
                            &quot;=&#39;&quot; + hdnChkList.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
                    break;
                case &quot;C&quot;:
                    query = COL_CHECKLISTNAME + &quot;=&#39;&quot; + hdnChkList.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
                    break;
            }

            DataRow[] dr = dtChecklistCollection.Select(query);

            string checklistID = dr[0][COL_CHECKLISTID].ToString2();
            string url = &quot;~/Common/BrixNewChecklist.aspx?Context={0}&amp;PID={1}&amp;Mode=E&amp;ChecklistID={2}&quot;.Format2(ModuleID,
                PID.
                    ToString2
                    (),
                checklistID);
            url += ModuleSpecificQueryString();
            Response.Redirect(
                url +
                (String.IsNullOrEmpty(Request[&quot;IsReadOnly&quot;]) ? String.Empty : &quot;&amp;IsReadOnly=&quot; + Request[&quot;IsReadOnly&quot;]) +
                (url.ToLower().Contains(&quot;contractid&quot;) || String.IsNullOrEmpty(Request[&quot;ContractID&quot;])
                    ? String.Empty
                    : &quot;&amp;ContractID=&quot; + Request[&quot;ContractID&quot;]), true);
        }

        #endregion

        #region &quot;Functions&quot;

        private void FormatChecklistGrid()
        {
            uwgResource.DisplayLayout.AllowSortingDefault = AllowSorting.No;

            ColumnsCollection cols = uwgResource.Bands[0].Columns;

            cols.FromKey(COL_CHECKLISTNAME).IsGroupByColumn = true;
            cols.FromKey(COL_STAGENAME).IsGroupByColumn = true;

            cols.FromKey(COL_STAGEID).Hidden =
                cols.FromKey(COL_ACTIVITYID).Hidden =
                    cols.FromKey(COL_CHECKLISTID).Hidden =
                        cols.FromKey(COL_CHECKLISTENDDATE).Hidden =
                            cols.FromKey(COL_CHECKLISTSTARTDATE).Hidden =
                                cols.FromKey(COL_STAGEDESCRIPTION).Hidden =
                                    cols.FromKey(COL_CHECKLISTDESCRIPTION).Hidden = true;

            if (cols.Exists(COL_ATTACHMENTID))
                cols.FromKey(COL_ATTACHMENTID).Hidden = true;

            cols.FromKey(COL_NOTES).AllowUpdate = AllowUpdate.Yes;
            cols.FromKey(COL_COMPLETED).AllowUpdate = (permissionsForChecklist.Contains(&quot;Checklist Complete&quot;))
                ? AllowUpdate.Yes
                : AllowUpdate.No;
            cols.FromKey(COL_ESCALTION).AllowUpdate = AllowUpdate.Yes;

            cols.FromKey(COL_NOTES).FieldLen = 1000;

            cols.FromKey(COL_ACTIVITYSTARTDATE).Format =
                cols.FromKey(COL_ACTIVITYENDDATE).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;

            cols.FromKey(COL_ACTIVITYNAME).Header.Caption = &quot;Activity Name&quot;;
            cols.FromKey(COL_ACTIVITYSTARTDATE).Header.Caption = &quot;Start Date&quot;;
            cols.FromKey(COL_CHECKLISTENDDATE).Header.Caption = &quot;End Date&quot;;
            cols.FromKey(COL_ESCALTION).Header.Caption = &quot;Requires Escalation&quot;;
            if (cols.Exists(COL_COMPLETEDBY))
            {
                cols.FromKey(COL_COMPLETEDBY).Header.Caption = &quot;Completed By&quot;;
                cols.FromKey(COL_COMPLETEDBY).HTMLEncodeContent = true;
            }                
            if (cols.Exists(COL_OWNERNAME))
            {
                cols.FromKey(COL_OWNERNAME).Header.Caption = &quot;Owner&quot;;
                cols.FromKey(COL_OWNERNAME).HTMLEncodeContent = true;
            }                
            if (cols.Exists(COL_OWNERID))
                cols.FromKey(COL_OWNERID).Hidden = true;

            cols.FromKey(COL_ACTIVITYNAME).HTMLEncodeContent = true;
            
            
            cols.FromKey(COL_NOTES).HTMLEncodeContent = true;
            cols.FromKey(COL_STAGENAME).HTMLEncodeContent = true;
            cols.FromKey(COL_STAGEDESCRIPTION).HTMLEncodeContent = true;
            cols.FromKey(COL_CHECKLISTNAME).HTMLEncodeContent = true;
            cols.FromKey(COL_CHECKLISTDESCRIPTION).HTMLEncodeContent = true;
        }

        private DataTable GetGridData()
        {
            if (uwgResource.Rows.Count &gt; 0)
            {
                uwgResource.Bands[0].Columns.FromKey(&quot;StageName&quot;).IsGroupByColumn = false;
                uwgResource.Bands[0].Columns.FromKey(&quot;CheckListName&quot;).IsGroupByColumn = false;
            }

            DataTable dtTemp = DataTableWithSchema();

            DataRow row;
            if (uwgResource.Rows.Count &gt; 0)
            {
                UltraGridRowsEnumerator enParentRow = uwgResource.Bands[0].GetRowsEnumerator();

                while (enParentRow.MoveNext())
                {
                    CellsCollection cells = enParentRow.Current.Cells;

                    row = dtTemp.NewRow();

                    row[COL_CHECKLISTID] = cells.FromKey(COL_CHECKLISTID).Value.ToString2().ToInt32_2();
                    row[COL_CHECKLISTNAME] = cells.FromKey(COL_CHECKLISTNAME).Text;
                    row[COL_CHECKLISTDESCRIPTION] = cells.FromKey(COL_CHECKLISTDESCRIPTION).Value.ToString2();
                    row[COL_CHECKLISTSTARTDATE] = cells.FromKey(COL_CHECKLISTSTARTDATE).Value.ToString2();
                    row[COL_CHECKLISTENDDATE] = cells.FromKey(COL_CHECKLISTENDDATE).Value.ToString2();


                    row[COL_STAGEID] = cells.FromKey(COL_STAGEID).Value.ToString2().ToInt32_2();
                    row[COL_STAGENAME] = cells.FromKey(COL_STAGENAME).Value;

                    row[COL_ACTIVITYID] = cells.FromKey(COL_ACTIVITYID).Value.ToString2().ToInt32_2();
                    row[COL_ACTIVITYNAME] = cells.FromKey(COL_ACTIVITYNAME).Text;
                    row[COL_ACTIVITYSTARTDATE] = cells.FromKey(COL_ACTIVITYSTARTDATE).Text;
                    row[COL_ACTIVITYENDDATE] = cells.FromKey(COL_ACTIVITYENDDATE).Text;

                    row[COL_NOTES] = cells.FromKey(COL_NOTES).Text;
                    row[COL_COMPLETED] = cells.FromKey(COL_COMPLETED).Text.ToBoolean2();
                    row[COL_ESCALTION] = cells.FromKey(COL_ESCALTION).Text.ToBoolean2();
                    row[COL_ATTACHMENTS] = COL_ATTACHMENTS;
                    row[COL_ATTACHMENTID] = cells.FromKey(COL_ATTACHMENTID).Text;
                    row[COL_OWNERID] = cells.FromKey(COL_OWNERID).Value;

                    dtTemp.Rows.Add(row);
                }
            }

            return dtTemp;
        }

        private void GetChecklists()
        {
            DataTable dtTemp = ChecklistManager.Instance.GetChecklists(ModuleID, InstanceID).Tables[0];

            if (CHKPRJLComponents.Contains(&quot;OwnerNameDefault&quot;))
            {
                string UserName = UserDetail.GetCurrentUserDetail().UserName;

                foreach (DataRow d in dtTemp.Rows)
                {
                    d[&quot;OwnerName&quot;] = UserName;
                }
            }

            if (dtTemp.Rows.Count &gt; 0)
            {
                uwgResource.DataSource = dtTemp.ToMWDateTime();
                uwgResource.DataBind();

                FormatChecklistGrid();
            }
        }

        private void MasterSave(int checklistID, int stageID)
        {
            DataTable dtAllDetails = GetGridData();

            DataSet dsStagesAndActivities = new BrixDataSet();
            dsStagesAndActivities.Tables.Add(dtAllDetails);
            var checklistDTO = new ChecklistDTO();

            checklistDTO.ChecklistID = checklistID;
            checklistDTO.ChecklistName = String.Empty;
            checklistDTO.ChecklistDescription = String.Empty;
            checklistDTO.ChecklistStartDate = DateTime.UtcNow;
            checklistDTO.ChecklistEndDate = DateTime.UtcNow;
            checklistDTO.ModuleID = ModuleID;
            checklistDTO.ParentInstanceID = InstanceID;
            checklistDTO.ChecklistXML = dsStagesAndActivities.GetXml();
            checklistDTO.Mode = (checklistID == 0) ? &quot;A&quot; : &quot;M&quot;;

            checklistDTO.ActivitiesList = hdnActivitiesList.Value;
            checklistDTO.CompletedBy = UserDetail.GetCurrentUserDetail().FirstName + &quot; &quot; +
                                       UserDetail.GetCurrentUserDetail().MiddleName + &quot; &quot; +
                                       UserDetail.GetCurrentUserDetail().LastName;

            ChecklistManager.Instance.SaveChecklist(checklistDTO);

            GetChecklists();
        }

        private DataTable DataTableWithSchema()
        {
            DataTable dtTemp = new BrixDataTable();

            dtTemp.Columns.Add(COL_CHECKLISTID, Type.GetType(TYPE_INT));
            dtTemp.Columns.Add(COL_CHECKLISTNAME, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_CHECKLISTDESCRIPTION, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_CHECKLISTSTARTDATE, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_CHECKLISTENDDATE, Type.GetType(TYPE_STRING));

            dtTemp.Columns.Add(COL_STAGEID, Type.GetType(TYPE_INT));
            dtTemp.Columns.Add(COL_STAGENAME, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_STAGEDESCRIPTION, Type.GetType(TYPE_STRING));

            dtTemp.Columns.Add(COL_ACTIVITYID, Type.GetType(TYPE_INT));
            dtTemp.Columns.Add(COL_ACTIVITYNAME, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_NOTES, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_COMPLETED, Type.GetType(TYPE_BOOL));
            dtTemp.Columns.Add(COL_ESCALTION, Type.GetType(TYPE_BOOL));
            dtTemp.Columns.Add(COL_ATTACHMENTS, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_ATTACHMENTID, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_ACTIVITYSTARTDATE, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_ACTIVITYENDDATE, Type.GetType(TYPE_STRING));
            dtTemp.Columns.Add(COL_OWNERID, Type.GetType(TYPE_INT));

            return dtTemp;
        }

        //private void AssignInstanceID(string moduleID)
        private void AssignInstanceID()
        {
            // TODO
            // Add checklist concrete class for ContractManager
            InstanceID = checkListModel.GetInstanceID();
        }

        private string ModuleSpecificQueryString()
        {
            return checkListModel.ModuleSpecificQueryString();
        }

        #endregion

        #region &quot;Permission Check&quot;

        private void CheckForModulePermissions()
        {
            strPermList = checkListModel.GetModulePermissions(Context);
        }

        #endregion

        #region &quot;Grid Formatting&quot;

        // Functions to format the grids in the page
        protected void grdItemsList_InitializeGroupByRow(object sender, RowEventArgs e)
        {
            e.Row.Expanded = true;

            try
            {
                if (((GroupByRow)e.Row).Column.ToString2().Equals(&quot;CheckListName&quot;))
                {
                    ((GroupByRow)e.Row).Text = ((GroupByRow)e.Row).Value + &quot;( &quot;
                                               + e.Row.Rows.Count.ToString2() + &quot; Stage(s))&quot;;
                }
                else if (((GroupByRow)e.Row).Column.ToString2().Equals(&quot;StageName&quot;))
                {
                    ((GroupByRow)e.Row).Text = ((GroupByRow)e.Row).Value + &quot;( &quot;
                                               + e.Row.Rows.Count.ToString2() + &quot; (Activity/Activities))&quot;;
                }
            }
            catch
            {
                (e.Row).ShowExpand = false;
            }
        }

        protected void grdStagesAndActivities_InitializeGroupByRow(object sender, RowEventArgs e)
        {
            e.Row.Expanded = true;
        }

        protected void grdItemsList_InitializeRow(object sender, RowEventArgs e)
        {
            string queryString = &quot;ActivityID=&quot; + e.Row.Cells.FromKey(&quot;ActivityID&quot;).Value.ToString2();
            queryString += &quot;&amp;Context=&quot; + ModuleID;
            queryString += &quot;&amp;ATID=&quot; + e.Row.Cells.FromKey(&quot;AttachmentID&quot;).Value.ToString2();
            queryString += &quot;&amp;PID=&quot; + PID;
            queryString += &quot;&amp;&quot; + ModuleSpecificQueryString();

            e.Row.Cells.FromKey(&quot;Attachments&quot;).TargetURL = &quot;BrixChecklistAttachment.aspx?&quot; + queryString;

            e.Row.Cells.FromKey(&quot;Notes&quot;).Style.BackColor = Color.Yellow;
        }

        // Functions to format the grids in the page

        #endregion

        #region &quot;Constants&quot;

        private const string MODULENAME = &quot;CHKLIST&quot;;
        private const string COL_LINKINGID = &quot;LinkingID&quot;;

        private const string COL_STAGEID = &quot;StageID&quot;;
        private const string COL_CHECKLISTID = &quot;ChecklistID&quot;;
        private const string COL_ACTIVITYID = &quot;ActivityID&quot;;
        private const string COL_STAGENAME = &quot;StageName&quot;;
        private const string COL_ACTIVITYNAME = &quot;ActivityName&quot;;
        private const string COL_CHECKLISTNAME = &quot;ChecklistName&quot;;
        private const string COL_NOTES = &quot;Notes&quot;;
        private const string COL_ATTACHMENTS = &quot;Attachments&quot;;
        private const string COL_ATTACHMENTID = &quot;AttachmentID&quot;;
        private const string COL_COMPLETED = &quot;Completed&quot;;
        private const string COL_STAGEDESCRIPTION = &quot;StageDescription&quot;;
        private const string COL_CHECKLISTSTARTDATE = &quot;ChecklistStartDate&quot;;
        private const string COL_CHECKLISTENDDATE = &quot;ChecklistEndDate&quot;;
        private const string COL_CHECKLISTDESCRIPTION = &quot;ChecklistDescription&quot;;
        private const string COL_ACTIVITYSTARTDATE = &quot;StartDate&quot;;
        private const string COL_ACTIVITYENDDATE = &quot;EndDate&quot;;
        private const string COL_ESCALTION = &quot;Escalation&quot;;
        private const string COL_STARTDATE = &quot;StartDate&quot;;
        private const string COL_ENDDATE = &quot;EndDate&quot;;
        private const string COL_OWNERID = &quot;OwnerID&quot;;
        private const string COL_OWNERNAME = &quot;OwnerName&quot;;

        private const string TYPE_INT = &quot;System.Int32&quot;;
        private const string TYPE_STRING = &quot;System.String&quot;;
        private const string TYPE_BOOL = &quot;System.Boolean&quot;;
        private const string COL_COMPLETEDBY = &quot;CompletedBy&quot;;

        int TRADefaultOwnerNameModuleComponentsFlag = 0;

        #endregion

        #region &quot;Properties&quot;

        private string ModuleID { get; set; }
        private int PID { get; set; }
        private int InstanceID { get; set; }
        private string EnterpriseLM { get; set; }
        private int LMID { get; set; }

        List&lt;string&gt; _CHKPRJLComponents = null;

        private List&lt;string&gt; CHKPRJLComponents
        {
            get
            {
                if (_CHKPRJLComponents == null)
                    _CHKPRJLComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CHKPRJL);
                return _CHKPRJLComponents;
            }
        }

        #endregion

        #region Nested type: Mode

        private enum Mode
        {
            New = 0,
            Edit = 1,
            View = 2,
            Delete = 3
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,39,0],[31,9,31,10,0],[32,13,32,31,0],[33,13,33,97,0],[35,13,41,42,0],[43,13,43,76,0],[44,13,44,102,0],[45,13,45,31,0],[46,9,46,10,0],[49,9,49,10,0],[50,13,50,47,0],[51,13,51,28,0],[52,9,52,10,0],[55,9,55,10,0],[56,13,56,40,0],[57,13,57,14,0],[58,17,58,80,0],[59,13,59,14,0],[61,13,61,31,0],[63,13,63,60,0],[64,13,64,14,0],[65,17,65,65,0],[66,13,66,14,0],[68,13,68,72,0],[69,9,69,10,0],[74,13,74,14,0],[75,17,78,94,0],[79,13,79,14,0],[82,9,82,59,0],[85,9,85,10,0],[86,13,86,85,0],[88,13,88,44,0],[89,13,89,44,0],[90,17,90,47,0],[92,17,92,41,0],[94,13,94,39,0],[95,17,95,38,0],[96,18,96,44,0],[97,17,97,38,0],[98,18,98,44,0],[99,17,99,38,0],[100,18,100,44,0],[101,17,101,38,0],[103,17,103,41,0],[105,13,107,61,0],[109,13,109,60,0],[110,13,110,14,0],[111,17,111,51,0],[112,17,112,18,0],[113,21,115,77,0],[116,21,116,34,0],[123,17,126,79,0],[127,17,127,18,0],[128,21,130,77,0],[131,21,131,34,0],[138,13,138,14,0],[139,13,139,25,0],[140,9,140,10,0],[143,9,143,10,0],[144,13,144,68,0],[145,13,145,14,0],[146,17,148,69,0],[149,13,149,14,0],[151,13,151,14,0],[152,17,152,47,0],[153,13,153,14,0],[154,9,154,10,0],[157,9,157,10,0],[158,13,158,42,0],[159,13,159,49,0],[161,13,161,41,0],[163,13,163,56,0],[164,17,166,93,0],[168,13,168,43,0],[169,13,169,46,0],[170,13,172,53,0],[173,13,173,92,0],[175,13,175,44,0],[176,17,176,55,0],[180,13,180,32,0],[182,13,182,34,0],[183,13,183,14,0],[184,17,184,33,0],[185,13,185,14,0],[186,9,186,10,0],[191,9,191,10,0],[206,13,206,52,0],[207,13,207,51,0],[208,13,208,49,0],[209,9,209,10,0],[212,9,212,10,0],[213,13,213,74,0],[214,13,214,76,0],[215,13,215,89,0],[216,13,216,80,0],[218,13,218,106,0],[219,13,219,102,0],[220,13,220,94,0],[223,13,223,76,0],[224,17,224,102,0],[225,13,225,83,0],[226,17,226,116,0],[228,13,228,65,0],[229,17,229,80,0],[231,13,231,91,0],[233,13,233,44,0],[234,13,234,44,0],[235,17,235,47,0],[237,17,237,41,0],[239,13,239,39,0],[240,17,240,38,0],[241,18,241,44,0],[242,17,242,38,0],[243,18,243,44,0],[244,17,244,38,0],[245,18,245,44,0],[246,17,246,38,0],[248,13,250,61,0],[252,13,252,115,0],[253,13,253,114,0],[254,13,255,116,0],[257,13,257,99,0],[258,13,258,14,0],[259,17,261,83,0],[262,17,262,73,0],[263,13,263,14,0],[264,9,264,10,0],[267,9,267,10,0],[268,13,271,126,0],[272,9,272,10,0],[275,9,275,10,0],[276,13,279,126,0],[280,9,280,10,0],[283,9,283,10,0],[284,13,285,122,0],[286,9,286,10,0],[290,9,290,10,0],[292,13,292,14,0],[293,17,293,50,0],[295,17,295,51,0],[297,17,297,39,0],[300,25,300,101,0],[301,25,301,31,0],[303,25,304,102,0],[305,25,305,31,0],[307,25,309,80,0],[310,25,310,31,0],[313,17,313,66,0],[314,17,314,18,0],[315,21,315,118,0],[317,21,317,81,0],[319,21,319,44,0],[320,21,320,22,0],[321,25,323,96,0],[324,25,324,47,0],[325,25,325,32,0],[327,17,327,18,0],[329,17,329,59,0],[331,17,331,37,0],[332,17,332,33,0],[333,17,333,32,0],[334,17,334,18,0],[335,21,335,70,0],[336,21,336,62,0],[337,17,337,18,0],[339,17,339,24,0],[339,26,339,37,0],[339,38,339,40,0],[339,41,339,43,0],[340,21,340,45,0],[342,17,342,44,0],[343,21,343,35,0],[345,17,345,36,0],[346,21,346,68,0],[348,21,348,51,0],[349,17,349,40,0],[351,17,351,36,0],[352,21,352,43,0],[354,17,354,50,0],[355,13,355,14,0],[356,13,356,33,0],[357,13,357,14,0],[358,17,358,80,0],[359,17,359,44,0],[360,13,360,14,0],[361,9,361,10,0],[365,9,365,10,0],[367,13,367,14,0],[368,17,368,34,0],[369,13,369,14,0],[370,13,370,33,0],[371,13,371,14,0],[372,17,372,80,0],[373,17,373,44,0],[374,13,374,14,0],[375,9,375,10,0],[378,9,378,10,0],[379,13,381,45,0],[382,13,387,70,0],[388,9,388,10,0],[391,9,391,10,0],[392,13,392,61,0],[394,13,394,41,0],[395,13,395,35,0],[399,21,400,78,0],[401,21,401,27,0],[403,21,403,98,0],[404,21,404,27,0],[407,13,407,64,0],[409,13,409,69,0],[410,13,414,30,0],[415,13,415,48,0],[416,13,421,70,0],[422,9,422,10,0],[429,9,429,10,0],[430,13,430,77,0],[432,13,432,67,0],[434,13,434,68,0],[435,13,435,64,0],[437,13,443,90,0],[445,13,445,47,0],[446,17,446,62,0],[448,13,448,67,0],[449,13,451,34,0],[452,13,452,71,0],[454,13,454,53,0],[456,13,457,105,0],[459,13,459,77,0],[460,13,460,79,0],[461,13,461,76,0],[462,13,462,80,0],[463,13,463,46,0],[464,13,464,14,0],[465,17,465,79,0],[466,17,466,72,0],[467,13,467,14,0],[468,13,468,44,0],[469,13,469,14,0],[470,17,470,70,0],[471,17,471,70,0],[472,13,472,14,0],[473,13,473,42,0],[474,17,474,57,0],[476,13,476,69,0],[479,13,479,62,0],[480,13,480,66,0],[481,13,481,73,0],[482,13,482,70,0],[483,13,483,77,0],[484,9,484,10,0],[487,9,487,10,0],[488,13,488,44,0],[489,13,489,14,0],[490,17,490,91,0],[491,17,491,95,0],[492,13,492,14,0],[494,13,494,54,0],[497,13,497,44,0],[498,13,498,14,0],[499,17,499,96,0],[501,17,501,47,0],[502,17,502,18,0],[503,21,503,71,0],[505,21,505,43,0],[507,21,507,105,0],[508,21,508,84,0],[509,21,509,111,0],[510,21,510,107,0],[511,21,511,103,0],[514,21,514,97,0],[515,21,515,77,0],[517,21,517,103,0],[518,21,518,82,0],[519,21,519,92,0],[520,21,520,88,0],[522,21,522,68,0],[523,21,523,89,0],[524,21,524,89,0],[525,21,525,60,0],[526,21,526,82,0],[527,21,527,73,0],[529,21,529,42,0],[530,17,530,18,0],[531,13,531,14,0],[533,13,533,27,0],[534,9,534,10,0],[537,9,537,10,0],[538,13,538,104,0],[540,13,540,64,0],[541,13,541,14,0],[542,17,542,78,0],[544,17,544,24,0],[544,26,544,35,0],[544,36,544,38,0],[544,39,544,50,0],[545,17,545,18,0],[546,21,546,47,0],[547,17,547,18,0],[548,13,548,14,0],[550,13,550,39,0],[551,13,551,14,0],[552,17,552,64,0],[553,17,553,40,0],[555,17,555,39,0],[556,13,556,14,0],[557,9,557,10,0],[560,9,560,10,0],[561,13,561,52,0],[563,13,563,63,0],[564,13,564,60,0],[565,13,565,51,0],[567,13,567,52,0],[568,13,568,55,0],[569,13,569,62,0],[570,13,570,63,0],[571,13,571,61,0],[572,13,572,46,0],[573,13,573,56,0],[574,13,574,72,0],[575,13,575,64,0],[577,13,577,67,0],[578,13,580,83,0],[582,13,582,67,0],[584,13,584,29,0],[585,9,585,10,0],[588,9,588,10,0],[589,13,589,52,0],[591,13,591,73,0],[592,13,592,78,0],[593,13,593,85,0],[594,13,594,83,0],[595,13,595,81,0],[597,13,597,69,0],[598,13,598,74,0],[599,13,599,81,0],[601,13,601,72,0],[602,13,602,77,0],[603,13,603,70,0],[604,13,604,72,0],[605,13,605,72,0],[606,13,606,76,0],[607,13,607,77,0],[608,13,608,82,0],[609,13,609,80,0],[610,13,610,69,0],[612,13,612,27,0],[613,9,613,10,0],[617,9,617,10,0],[620,13,620,57,0],[621,9,621,10,0],[624,9,624,10,0],[625,13,625,63,0],[626,9,626,10,0],[633,9,633,10,0],[634,13,634,72,0],[635,9,635,10,0],[643,9,643,10,0],[644,13,644,35,0],[647,13,647,14,0],[648,17,648,84,0],[649,17,649,18,0],[650,21,651,94,0],[652,17,652,18,0],[653,22,653,85,0],[654,17,654,18,0],[655,21,656,107,0],[657,17,657,18,0],[658,13,658,14,0],[659,13,659,18,0],[660,13,660,14,0],[661,17,661,44,0],[662,13,662,14,0],[663,9,663,10,0],[666,9,666,10,0],[667,13,667,35,0],[668,9,668,10,0],[671,9,671,10,0],[672,13,672,102,0],[673,13,673,51,0],[674,13,674,93,0],[675,13,675,42,0],[676,13,676,62,0],[678,13,678,106,0],[680,13,680,73,0],[681,9,681,10,0],[719,9,719,57,0],[725,35,725,39,0],[725,40,725,44,0],[726,27,726,31,0],[726,32,726,36,0],[727,34,727,38,0],[727,39,727,43,0],[728,39,728,43,0],[728,44,728,48,0],[729,28,729,32,0],[729,33,729,37,0],[731,9,731,48,0],[736,13,736,14,0],[737,17,737,48,0],[738,21,738,111,0],[739,17,739,43,0],[740,13,740,14,0]]);
    </script>
  </body>
</html>