<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\Utility\ExcelHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.IO;
using System.Text;
using System.Web;
using System.Web.UI;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Logging;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using NPOI;
using NPOI.HPSF;
using NPOI.HSSF.UserModel;
using NPOI.SS.UserModel;
using NPOI.XSSF.UserModel;
using NPOI.SS.Util;

namespace Aurigo.Brix.Platform.BusinessLayer.Utility
{
    public class ExcelHelper
    {
        #region ExcelWriter xml format

        //Row limits older excel verion per sheet, the row limit for excel 2003 is 65536
        const int rowLimit = 65000;

        public const string EXCEL_TEMPLATE = &quot;Excel Template (xls)&quot;;
        public const string EXCEL_TEMPLATE_XLSX = &quot;Excel Template (xlsx)&quot;;
        public const string EXCEL_TEMPLATE_WITH_DATA = &quot;Excel Template With Data (xls)&quot;;
        public const string EXCEL_TEMPLATE_WITH_DATA_XLSX = &quot;Excel Template With Data (xlsx)&quot;;

        /// &lt;summary&gt;
        /// This function sets the template values required for the file to be generated as excel
        /// its in open excel format
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static string getWorkbookTemplate()
        {
            var sb = new StringBuilder(818);
            sb.AppendFormat(@&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot;?&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;&lt;?mso-application progid=&quot;&quot;Excel.Sheet&quot;&quot;?&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;&lt;Workbook xmlns=&quot;&quot;urn:schemas-microsoft-com:office:spreadsheet&quot;&quot;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot; xmlns:o=&quot;&quot;urn:schemas-microsoft-com:office:office&quot;&quot;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot; xmlns:x=&quot;&quot;urn:schemas-microsoft-com:office:excel&quot;&quot;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot; xmlns:ss=&quot;&quot;urn:schemas-microsoft-com:office:spreadsheet&quot;&quot;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot; xmlns:html=&quot;&quot;http://www.w3.org/TR/REC-html40&quot;&quot;&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot; &lt;Styles&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;  &lt;Style ss:ID=&quot;&quot;Default&quot;&quot; ss:Name=&quot;&quot;Normal&quot;&quot;&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;   &lt;Alignment ss:Vertical=&quot;&quot;Bottom&quot;&quot;/&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;   &lt;Borders/&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(
                @&quot;   &lt;Font ss:FontName=&quot;&quot;Calibri&quot;&quot; x:Family=&quot;&quot;Swiss&quot;&quot; ss:Size=&quot;&quot;11&quot;&quot; ss:Color=&quot;&quot;#000000&quot;&quot;/&gt;{0}&quot;,
                Environment.NewLine);
            sb.AppendFormat(@&quot;   &lt;Interior/&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;   &lt;NumberFormat/&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;   &lt;Protection/&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;  &lt;/Style&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;  &lt;Style ss:ID=&quot;&quot;s62&quot;&quot;&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(
                @&quot;   &lt;Font ss:FontName=&quot;&quot;Calibri&quot;&quot; x:Family=&quot;&quot;Swiss&quot;&quot; ss:Size=&quot;&quot;11&quot;&quot; ss:Color=&quot;&quot;#000000&quot;&quot;{0}&quot;,
                Environment.NewLine);
            sb.AppendFormat(@&quot;    ss:Bold=&quot;&quot;1&quot;&quot;/&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;  &lt;/Style&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;  &lt;Style ss:ID=&quot;&quot;s63&quot;&quot;&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;   &lt;NumberFormat ss:Format=&quot;&quot;Short Date&quot;&quot;/&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot;  &lt;/Style&gt;{0}&quot;, Environment.NewLine);
            sb.AppendFormat(@&quot; &lt;/Styles&gt;{0}&quot;, Environment.NewLine);
            sb.Append(@&quot;{0}\r\n&lt;/Workbook&gt;&quot;);
            return sb.ToString();
        }

        /// &lt;summary&gt;
        /// 
        /// Function replaces special characters to the xml format
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;input&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static string replaceXmlChar(string input)
        {
            input = input.Replace(&quot;&amp;&quot;, &quot;&amp;amp&quot;);
            input = input.Replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;);
            input = input.Replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;);
            input = input.Replace(&quot;\&quot;&quot;, &quot;&amp;quot;&quot;);
            input = input.Replace(&quot;&#39;&quot;, &quot;&amp;apos;&quot;);
            return input;
        }

        /// &lt;summary&gt;
        /// Formats the datatype based on the dataset,
        /// 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cellData&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static string getCell(Type type, object cellData)
        {
            var data = (cellData is DBNull) ? &quot;&quot; : cellData;
            if (type.Name.Contains(&quot;Int&quot;) || type.Name.Contains(&quot;Double&quot;) || type.Name.Contains(&quot;Decimal&quot;))
                return string.Format(&quot;&lt;Cell&gt;&lt;Data ss:Type=\&quot;Number\&quot;&gt;{0}&lt;/Data&gt;&lt;/Cell&gt;&quot;, data);
            if (type.Name.Contains(&quot;Date&quot;) &amp;&amp; data.ToString() != string.Empty)
            {
                return string.Format(&quot;&lt;Cell ss:StyleID=\&quot;s63\&quot;&gt;&lt;Data ss:Type=\&quot;DateTime\&quot;&gt;{0}&lt;/Data&gt;&lt;/Cell&gt;&quot;,
                    Convert.ToDateTime(data).ToString(&quot;yyyy-MM-dd&quot;));
            }
            return string.Format(&quot;&lt;Cell&gt;&lt;Data ss:Type=\&quot;String\&quot;&gt;{0}&lt;/Data&gt;&lt;/Cell&gt;&quot;, replaceXmlChar(data.ToString()));
        }

        /// &lt;summary&gt;
        /// gets each table from the dataset and writes as a single worksheet..
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;source&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static string getWorksheets(DataSet source)
        {
            var sw = new StringWriter();
            if (source == null || source.Tables.Count == 0)
            {
                sw.Write(
                    &quot;&lt;Worksheet ss:Name=\&quot;Sheet1\&quot;&gt;\r\n&lt;Table&gt;\r\n&lt;Row&gt;&lt;Cell&gt;&lt;Data ss:Type=\&quot;String\&quot;&gt;&lt;/Data&gt;&lt;/Cell&gt;&lt;/Row&gt;\r\n&lt;/Table&gt;\r\n&lt;/Worksheet&gt;&quot;);
                return sw.ToString();
            }
            foreach (DataTable dt in source.Tables)
            {
                if (dt.Rows.Count == 0)
                    sw.Write(&quot;&lt;Worksheet ss:Name=\&quot;&quot; + replaceXmlChar(dt.TableName) +
                             &quot;\&quot;&gt;\r\n&lt;Table&gt;\r\n&lt;Row&gt;&lt;Cell  ss:StyleID=\&quot;s62\&quot;&gt;&lt;Data ss:Type=\&quot;String\&quot;&gt;&lt;/Data&gt;&lt;/Cell&gt;&lt;/Row&gt;\r\n&lt;/Table&gt;\r\n&lt;/Worksheet&gt;&quot;);
                else
                {
                    //write each row data                
                    var sheetCount = 0;
                    for (int i = 0; i &lt; dt.Rows.Count; i++)
                    {
                        if ((i % rowLimit) == 0)
                        {
                            //add close tags for previous sheet of the same data table
                            if ((i / rowLimit) &gt; sheetCount)
                            {
                                sw.Write(&quot;\r\n&lt;/Table&gt;\r\n&lt;/Worksheet&gt;&quot;);
                                sheetCount = (i / rowLimit);
                            }
                            sw.Write(&quot;\r\n&lt;Worksheet ss:Name=\&quot;&quot; + replaceXmlChar(dt.TableName) +
                                     (((i / rowLimit) == 0) ? &quot;&quot; : Convert.ToString(i / rowLimit)) + &quot;\&quot;&gt;\r\n&lt;Table&gt;&quot;);
                            //write column name row
                            sw.Write(&quot;\r\n&lt;Row&gt;&quot;);
                            foreach (DataColumn dc in dt.Columns)
                                sw.Write(
                                    string.Format(
                                        &quot;&lt;Cell ss:StyleID=\&quot;s62\&quot;&gt;&lt;Data ss:Type=\&quot;String\&quot;&gt;{0}&lt;/Data&gt;&lt;/Cell&gt;&quot;,
                                        replaceXmlChar(dc.ColumnName)));
                            sw.Write(&quot;&lt;/Row&gt;&quot;);
                        }
                        sw.Write(&quot;\r\n&lt;Row&gt;&quot;);
                        foreach (DataColumn dc in dt.Columns)
                            sw.Write(getCell(dc.DataType, dt.Rows[i][dc.ColumnName]));
                        sw.Write(&quot;&lt;/Row&gt;&quot;);
                    }
                    sw.Write(&quot;\r\n&lt;/Table&gt;\r\n&lt;/Worksheet&gt;&quot;);
                }
            }

            return sw.ToString();
        }

        /// &lt;summary&gt;
        /// get excl sheet for datatable
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dtInput&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;filename&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetExcelXml(DataTable dtInput, string filename)
        {
            var excelTemplate = getWorkbookTemplate();
            var ds = new DataSet();
            ds.Tables.Add(dtInput.Copy());
            var worksheets = getWorksheets(ds);
            var excelXml = string.Format(excelTemplate, worksheets);
            return excelXml;
        }

        /// &lt;summary&gt;
        /// get excel sheet fro dataset
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dsInput&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;filename&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetExcelXml(DataSet dsInput, string filename)
        {
            var excelTemplate = getWorkbookTemplate();
            var worksheets = getWorksheets(dsInput);
            var excelXml = string.Format(excelTemplate, worksheets);
            return excelXml;
        }

        /// &lt;summary&gt;
        /// Converts the dataset to excel sheet
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dsInput&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;filename&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;response&quot;&gt;&lt;/param&gt;
        public static void ToExcel(DataSet dsInput, string filename, HttpResponse response)
        {
            var excelXml = GetExcelXml(dsInput, filename);
            response.Clear();
            response.AppendHeader(&quot;Content-Type&quot;, &quot;application/vnd.ms-excel&quot;);
            response.AppendHeader(&quot;Content-disposition&quot;, &quot;attachment; filename=&quot; + filename);
            response.Write(excelXml);
            response.Flush();
            response.End();
        }

        /// &lt;summary&gt;
        /// Converts the datatable to excel sheet
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dsInput&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;filename&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;response&quot;&gt;&lt;/param&gt;
        public static void ToExcel(DataTable dtInput, string filename, HttpResponse response)
        {
            var ds = new DataSet();
            ds.Tables.Add(dtInput.Copy());
            ToExcel(ds, filename, response);
        }

        #endregion

        static IWorkbook workbook = null;

        #region ExcelWriter binary format

        public static IWorkbook CreateWorkBook(string eventString)
        {
            IWorkbook Workbook = null;

            if (eventString == &quot;Excel Export (xls)&quot; || eventString == &quot;Excel Template Export (xls)&quot; ||
                 eventString == EXCEL_TEMPLATE || eventString == EXCEL_TEMPLATE_WITH_DATA ||
                eventString == &quot;Error Log&quot;)
            {
                Workbook = new HSSFWorkbook();
            }
            else if (eventString == &quot;Excel Export (xlsx)&quot; || eventString == &quot;Excel Template Export (xlsx)&quot; ||
                 eventString == EXCEL_TEMPLATE_XLSX || eventString == EXCEL_TEMPLATE_WITH_DATA_XLSX)
            {
                Workbook = new XSSFWorkbook();
            }
            return (Workbook);
        }

        static void InitializeWorkbook(string eventString, string excelFileName)
        {
            Page page = HttpContext.Current.Handler as Page;

            if (eventString == &quot;Excel Export (xls)&quot; || eventString == &quot;Excel Template Export (xls)&quot; ||
                eventString == EXCEL_TEMPLATE || eventString == EXCEL_TEMPLATE_WITH_DATA ||
                eventString == &quot;Error Log&quot;)
            {
                HSSFWorkbook hSSFWorkbook = new HSSFWorkbook();
                DocumentSummaryInformation dsi = PropertySetFactory.CreateDocumentSummaryInformation();
                dsi.Company = &quot;Aurigo Software Technologies&quot;;

                var summaryInfo = NPOI.HPSF.PropertySetFactory.CreateSummaryInformation();
                summaryInfo.Author = UserDetail.GetCurrentUserDetail().GetUserName();
                hSSFWorkbook.DocumentSummaryInformation = dsi;
                hSSFWorkbook.SummaryInformation = summaryInfo;
                page.Response.ContentType = &quot;application/vnd.ms-excel&quot;;
                page.Response.AddHeader(&quot;Content-Disposition&quot;,
                    string.Format(&quot;attachment;filename={0}&quot;, excelFileName + &quot;.xls&quot;));
                workbook = hSSFWorkbook;
            }
            else if (eventString == &quot;Excel Export (xlsx)&quot; || eventString == &quot;Excel Template Export (xlsx)&quot; ||
                  eventString == EXCEL_TEMPLATE_XLSX || eventString == EXCEL_TEMPLATE_WITH_DATA_XLSX)
            {
                XSSFWorkbook xSSFWorkbook = new XSSFWorkbook();
                POIXMLProperties props = xSSFWorkbook.GetProperties();
                props.ExtendedProperties.GetUnderlyingProperties().Company = &quot;Aurigo Software Technologies&quot;;
                props.CoreProperties.GetUnderlyingProperties()
                    .SetCreatorProperty(UserDetail.GetCurrentUserDetail().GetUserName());

                page.Response.ContentType =
                    &quot;application/application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;;
                page.Response.AddHeader(&quot;Content-Disposition&quot;,
                    string.Format(&quot;attachment;filename={0}&quot;, excelFileName + &quot;.xlsx&quot;));
                workbook = xSSFWorkbook;
            }
        }

        public static void ExportToExcel(string eventString, ExcelExportEntity excelExportEntity)
        {
            HttpResponse response = HttpContext.Current.Response;
            DataSet resultDataSet = FormatDataSet(excelExportEntity);
            response.Clear();
            //response.AppendCookie(new HttpCookie(&quot;fileDownloadToken&quot;, &quot;123&quot;));       

            InitializeWorkbook(eventString, excelExportEntity.ExcelDataSet.DataSetName);
            GenerateData(resultDataSet, excelExportEntity.ColumnStyleByTableNameAndSheetName, eventString);
            workbook.Write(response.OutputStream);
            response.Flush();
            response.SuppressContent = true;
            HttpContext.Current.ApplicationInstance.CompleteRequest();
        }

        public static void ExportToExcel(string eventString, ExcelExportEntity excelExportEntity, string fileDownloadTokenID = &quot;&quot;, string fileDownloadTokenValue = &quot;&quot;)
        {
            HttpResponse response = HttpContext.Current.Response;
            DataSet resultDataSet = FormatDataSet(excelExportEntity);
            

            InitializeWorkbook(eventString, excelExportEntity.ExcelDataSet.DataSetName);
            GenerateData(resultDataSet, excelExportEntity.ColumnStyleByTableNameAndSheetName, eventString);
            workbook.Write(response.OutputStream);
            response.Flush();
            response.SuppressContent = true;
            HttpContext.Current.ApplicationInstance.CompleteRequest();
        }



        public static void ExportToExcel(string eventString, ExcelExportEntity excelExportEntity, int sheetIndex, string columnName, string[] dropDownList)
        {
            ExportToExcelInternal(eventString, excelExportEntity, sheetIndex, columnName, dropDownList);
        }

        public static void ExportToExcel(string eventString, ExcelExportEntity excelExportEntity, int sheetIndex, string columnName, string[] dropDownList, string fileDownloadTokenID, string fileDownloadTokenValue)
        {
            ExportToExcelInternal(eventString, excelExportEntity, sheetIndex, columnName, dropDownList, fileDownloadTokenID, fileDownloadTokenValue);
        }

        private static void ExportToExcelInternal(string eventString, ExcelExportEntity excelExportEntity, int sheetIndex, string columnName, string[] dropDownList, string fileDownloadTokenID = null, string fileDownloadTokenValue = null)
        {
            HttpResponse response = HttpContext.Current.Response;
            DataSet resultDataSet = FormatDataSet(excelExportEntity);

            int colIndex = -1;
            int rowCount = -1;
            if (resultDataSet.Tables.Count &gt; sheetIndex &amp;&amp; resultDataSet.Tables[sheetIndex].Columns.Contains(columnName))
            {
                colIndex = resultDataSet.Tables[sheetIndex].Columns.IndexOf(columnName);
                rowCount = resultDataSet.Tables[sheetIndex].Rows.Count;
            }

            response.Clear();

            if (!string.IsNullOrEmpty(fileDownloadTokenID) &amp;&amp; !string.IsNullOrEmpty(fileDownloadTokenValue))
            {
                response.AppendCookie(new HttpCookie(fileDownloadTokenID, fileDownloadTokenValue));
            }

            InitializeWorkbook(eventString, excelExportEntity.ExcelDataSet.DataSetName);
            GenerateData(resultDataSet, excelExportEntity.ColumnStyleByTableNameAndSheetName, eventString);


            if (colIndex &gt;= 0)
            {
                if (eventString.EndsWith(&quot;(xlsx)&quot;))
                {
                    CellRangeAddressList addressList = new CellRangeAddressList(1, rowCount + 1000, colIndex, colIndex);
                    XSSFSheet sheet = (XSSFSheet)workbook.GetSheetAt(sheetIndex);
                    XSSFDataValidationHelper dvHelper = new XSSFDataValidationHelper(sheet);
                    XSSFDataValidationConstraint dvConstraint = (XSSFDataValidationConstraint)dvHelper.CreateExplicitListConstraint(dropDownList);
                    XSSFDataValidation dataValidation = (XSSFDataValidation)dvHelper.CreateValidation(dvConstraint, addressList);
                    dataValidation.SuppressDropDownArrow = true;
                    workbook.GetSheetAt(sheetIndex).AddValidationData(dataValidation);
                }
                else
                {
                    CellRangeAddressList addressList = new CellRangeAddressList(1, rowCount + 1000, colIndex, colIndex);
                    DVConstraint dvConstraint = DVConstraint.CreateExplicitListConstraint(dropDownList);
                    IDataValidation dataValidation = new HSSFDataValidation(addressList, dvConstraint);
                    dataValidation.SuppressDropDownArrow = false;
                    workbook.GetSheetAt(sheetIndex).AddValidationData(dataValidation);
                }

            }

            workbook.Write(response.OutputStream);
            response.Flush();
            response.SuppressContent = true;
            HttpContext.Current.ApplicationInstance.CompleteRequest();


        }

        static void GenerateData(DataSet workbookData, Dictionary&lt;string, Dictionary&lt;string, ICellStyle&gt;&gt; formatDetails, string eventString)
        {
            try
            {
                foreach (DataTable dataTable in workbookData.Tables)
                {
                    ISheet sheet = workbook.CreateSheet(dataTable.TableName);
                    ICellStyle[] styleArray = new ICellStyle[dataTable.Columns.Count];

                    Dictionary&lt;string, ICellStyle&gt; columnFormatDictionary = null;
                    if (formatDetails != null)
                    {
                        formatDetails.TryGetValue(dataTable.TableName, out columnFormatDictionary);
                    }

                    int colNo = 0;
                    sheet.CreateRow(0);
                    foreach (DataColumn colName in dataTable.Columns)
                    {
                        sheet.GetRow(0).CreateCell(colNo).SetCellValue(colName.Caption);

                        if (columnFormatDictionary != null &amp;&amp; columnFormatDictionary.ContainsKey(colName.ColumnName))
                        {
                            styleArray[colNo] = columnFormatDictionary[colName.ColumnName];
                        }
                        colNo++;
                    }

                    int rowNo = 1;

                    foreach (DataRow singleRow in dataTable.Rows)
                    {
                        colNo = 0;
                        IRow row = sheet.CreateRow(rowNo);
                        foreach (var col in singleRow.ItemArray)
                        {
                            ICell cell = row.CreateCell(colNo);
                            Type colType = col.GetType();

                            // Assigning format based on column name Amount, Quantity &amp; Unit
                            string colFormat = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                            string colName = singleRow.Table.Columns[colNo].ColumnName;
                            if (colName.ToLower().Contains(&quot;quantity&quot;))
                                colFormat = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                            else if (colName.ToLower().Contains(&quot;unit&quot;))
                                colFormat = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;

                            if (colType == typeof(decimal))
                            {
                                decimal d = (decimal)col;

                                // Hack: XLSX does not support data format whetheras XLS does. After setting data format also, value gets exported with more than 2 decimal places.
                                // Hence, Formatting data before exporting.
                                string formattedDecimal = d.ToString(colFormat);

                                double doubleValue = Convert.ToDouble(formattedDecimal);
                                cell.SetCellValue(doubleValue);
                                cell.CellStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat(colFormat);
                            }
                            else if (colType == typeof(double))
                            {
                                double doubleValue = Convert.ToDouble(col);

                                // Hack: XLSX does not support data format whetheras XLS does. After setting data format also, value gets exported with more than 2 decimal places.
                                // Hence, Formatting data before exporting.
                                string formattedDouble = doubleValue.ToString(colFormat);

                                cell.SetCellValue(doubleValue);
                                cell.CellStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat(colFormat);
                            }
                            else if (colType == typeof(Int32))
                            {
                                Int32 d = (Int32)col;
                                double doubleValue = Convert.ToDouble(d);
                                cell.SetCellValue(col.ToDouble2());
                                cell.CellStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat(&quot;#,##0&quot;);
                            }
                            else
                            {
                                cell.SetCellValue(col.ToString());
                            }


                            if (styleArray[colNo] != null)
                            {
                                if (colType != typeof(Int32))
                                    cell.CellStyle.CloneStyleFrom(styleArray[colNo]);
                                if (colType == typeof(decimal) || colType == typeof(double))
                                {
                                    cell.CellStyle.DataFormat = HSSFDataFormat.GetBuiltinFormat(colFormat);
                                }
                            }
                            colNo++;
                        }
                        rowNo++;
                    }
                }
            }
            catch (Exception e)
            {
                Logger.Log(AMP3.Resources.MessageResources.Enumerations.LogType.Error,
                    &quot;Error on GenerateData : &quot; + e.Message, Aurigo.AMP3.Common.Constants.MODID_CORE);
            }
        }


        public static DataSet FormatDataSet(ExcelExportEntity excelExportEntity)
        {
            DataSet resultDataSet = excelExportEntity.ExcelDataSet.Copy();

            if (resultDataSet != null &amp;&amp; resultDataSet.Tables.Count &gt; 0)
            {
                foreach (DataTable datatable in resultDataSet.Tables)
                {
                    if (excelExportEntity.HiddenColumnsByTableNameAndSheetName != null)
                    {
                        IList&lt;string&gt; hiddenColumns = null;
                        if (excelExportEntity.HiddenColumnsByTableNameAndSheetName.ContainsKey(datatable.TableName))
                        {
                            hiddenColumns = excelExportEntity.HiddenColumnsByTableNameAndSheetName[datatable.TableName];
                        }

                        if (hiddenColumns != null &amp;&amp; hiddenColumns.Count &gt; 0)
                        {
                            foreach (string column in hiddenColumns)
                            {
                                if (datatable.Columns.Contains(column))
                                {
                                    datatable.Columns.Remove(column);
                                }
                            }
                        }
                    }

                    if (excelExportEntity.ColumnPositionsByTableNameAndSheetName != null)
                    {
                        Dictionary&lt;string, int&gt; columnPositionByColumnName = null;
                        if (excelExportEntity.ColumnPositionsByTableNameAndSheetName.ContainsKey(datatable.TableName))
                        {
                            columnPositionByColumnName =
                                excelExportEntity.ColumnPositionsByTableNameAndSheetName[datatable.TableName];
                        }

                        if (columnPositionByColumnName != null &amp;&amp; columnPositionByColumnName.Count &gt; 0)
                        {
                            foreach (KeyValuePair&lt;string, int&gt; columnNameAndNumber in columnPositionByColumnName)
                            {
                                if (datatable.Columns.Contains(columnNameAndNumber.Key) &amp;&amp;
                                    columnNameAndNumber.Value &lt; datatable.Columns.Count)
                                {
                                    datatable.Columns[columnNameAndNumber.Key].SetOrdinal(columnNameAndNumber.Value);
                                }
                            }
                        }
                    }

                    if (excelExportEntity.NewColumnNamesByTableNameAndSheetName != null)
                    {
                        Dictionary&lt;string, string&gt; newColumnNamesByOldColumnNames = null;
                        if (excelExportEntity.NewColumnNamesByTableNameAndSheetName.ContainsKey(datatable.TableName))
                        {
                            newColumnNamesByOldColumnNames =
                                excelExportEntity.NewColumnNamesByTableNameAndSheetName[datatable.TableName];
                        }

                        if (newColumnNamesByOldColumnNames != null &amp;&amp; newColumnNamesByOldColumnNames.Count &gt; 0)
                        {
                            foreach (
                                KeyValuePair&lt;string, string&gt; oldColumnNameAndNewColumnName in
                                    newColumnNamesByOldColumnNames)
                            {
                                if (datatable.Columns.Contains(oldColumnNameAndNewColumnName.Key))
                                {
                                    datatable.Columns[oldColumnNameAndNewColumnName.Key].ColumnName =
                                        oldColumnNameAndNewColumnName.Value;
                                }
                                //rowNo++;
                            }
                        }
                    }
                }
            }
            return resultDataSet;
        }

        #endregion
    }


    /// &lt;summary&gt;
    /// This class contains all the properties which can be used to format the excel data 
    /// &lt;/summary&gt;
    public class ExcelExportEntity
    {
        private DataSet excelDataSet;

        public DataSet ExcelDataSet
        {
            get { return excelDataSet; }
            set { excelDataSet = value; }
        }


        private Dictionary&lt;string, IList&lt;string&gt;&gt; hiddenColumnsByTableNameAndSheetName = null;

        public Dictionary&lt;string, IList&lt;string&gt;&gt; HiddenColumnsByTableNameAndSheetName
        {
            get { return hiddenColumnsByTableNameAndSheetName; }
            set { hiddenColumnsByTableNameAndSheetName = value; }
        }

        private Dictionary&lt;string, Dictionary&lt;string, int&gt;&gt; columnPositionsByTableNameAndSheetName = null;

        public Dictionary&lt;string, Dictionary&lt;string, int&gt;&gt; ColumnPositionsByTableNameAndSheetName
        {
            get { return columnPositionsByTableNameAndSheetName; }
            set { columnPositionsByTableNameAndSheetName = value; }
        }

        private Dictionary&lt;string, Dictionary&lt;string, ICellStyle&gt;&gt; columnStyleByTableNameAndSheetName = null;

        public Dictionary&lt;string, Dictionary&lt;string, ICellStyle&gt;&gt; ColumnStyleByTableNameAndSheetName
        {
            get { return columnStyleByTableNameAndSheetName; }
            set { columnStyleByTableNameAndSheetName = value; }
        }

        ////create a entry of DocumentSummaryInformation
        //this is optional incase its not needed just set it to blank
        //DocumentSummaryInformation dsi = PropertySetFactory.CreateDocumentSummaryInformation();
        //dsi.Company = &quot;Aurigo Software Technologies&quot;;
        //hssfworkbook.DocumentSummaryInformation = dsi;

        private Dictionary&lt;string, Dictionary&lt;string, string&gt;&gt; newColumnNamesByTableNameAndSheetName = null;

        public Dictionary&lt;string, Dictionary&lt;string, string&gt;&gt; NewColumnNamesByTableNameAndSheetName
        {
            get { return newColumnNamesByTableNameAndSheetName; }
            set { newColumnNamesByTableNameAndSheetName = value; }
        }

        private Dictionary&lt;string, Dictionary&lt;string, string&gt;&gt; columnsToBeTotalled = null;

        public Dictionary&lt;string, Dictionary&lt;string, string&gt;&gt; ColumnsToBeTotalled
        {
            get { return columnsToBeTotalled; }
            set { columnsToBeTotalled = value; }
        }


        public ExcelExportEntity(DataSet dataset)
        {
            ExcelDataSet = dataset;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[39,9,39,10,0],[40,13,40,45,0],[41,13,41,81,0],[42,13,42,100,0],[43,13,43,122,0],[44,13,44,110,0],[45,13,45,109,0],[46,13,46,116,0],[47,13,47,106,0],[48,13,48,67,0],[49,13,49,104,0],[50,13,50,96,0],[51,13,51,71,0],[52,13,54,38,0],[55,13,55,72,0],[56,13,56,76,0],[57,13,57,74,0],[58,13,58,68,0],[59,13,59,81,0],[60,13,62,38,0],[63,13,63,77,0],[64,13,64,68,0],[65,13,65,81,0],[66,13,66,101,0],[67,13,67,68,0],[68,13,68,68,0],[69,13,69,46,0],[70,13,70,34,0],[71,9,71,10,0],[80,9,80,10,0],[81,13,81,48,0],[82,13,82,48,0],[83,13,83,48,0],[84,13,84,51,0],[85,13,85,50,0],[86,13,86,26,0],[87,9,87,10,0],[97,9,97,10,0],[98,13,98,61,0],[99,13,99,108,0],[100,17,100,96,0],[101,13,101,79,0],[102,13,102,14,0],[103,17,104,70,0],[106,13,106,119,0],[107,9,107,10,0],[115,9,115,10,0],[116,13,116,41,0],[117,13,117,60,0],[118,13,118,14,0],[119,17,120,154,0],[121,17,121,38,0],[123,13,123,20,0],[123,22,123,34,0],[123,35,123,37,0],[123,38,123,51,0],[124,13,124,14,0],[125,17,125,40,0],[126,21,127,156,0],[129,17,129,18,0],[131,21,131,40,0],[132,26,132,35,0],[132,37,132,54,0],[132,56,132,59,0],[133,21,133,22,0],[134,25,134,49,0],[135,25,135,26,0],[137,29,137,61,0],[138,29,138,30,0],[139,33,139,74,0],[140,33,140,61,0],[141,29,141,30,0],[142,29,143,120,0],[145,29,145,51,0],[146,29,146,36,0],[146,38,146,51,0],[146,52,146,54,0],[146,55,146,65,0],[147,33,150,73,0],[151,29,151,48,0],[152,25,152,26,0],[153,25,153,47,0],[154,25,154,32,0],[154,34,154,47,0],[154,48,154,50,0],[154,51,154,61,0],[155,29,155,87,0],[156,25,156,44,0],[157,21,157,22,0],[158,21,158,62,0],[159,17,159,18,0],[160,13,160,14,0],[162,13,162,34,0],[163,9,163,10,0],[172,9,172,10,0],[173,13,173,55,0],[174,13,174,36,0],[175,13,175,43,0],[176,13,176,48,0],[177,13,177,69,0],[178,13,178,29,0],[179,9,179,10,0],[188,9,188,10,0],[189,13,189,55,0],[190,13,190,53,0],[191,13,191,69,0],[192,13,192,29,0],[193,9,193,10,0],[202,9,202,10,0],[203,13,203,59,0],[204,13,204,30,0],[205,13,205,79,0],[206,13,206,94,0],[207,13,207,38,0],[208,13,208,30,0],[209,13,209,28,0],[210,9,210,10,0],[219,9,219,10,0],[220,13,220,36,0],[221,13,221,43,0],[222,13,222,45,0],[223,9,223,10,0],[227,9,227,42,1],[232,9,232,10,1],[233,13,233,39,1],[235,13,237,44,1],[238,13,238,14,1],[239,17,239,47,1],[240,13,240,14,1],[241,18,242,101,1],[243,13,243,14,1],[244,17,244,47,1],[245,13,245,14,1],[246,13,246,31,1],[247,9,247,10,1],[250,9,250,10,1],[251,13,251,61,1],[253,13,255,44,1],[256,13,256,14,1],[257,17,257,64,1],[258,17,258,104,1],[259,17,259,62,1],[261,17,261,91,1],[262,17,262,86,1],[263,17,263,63,1],[264,17,264,63,1],[265,17,265,72,1],[266,17,267,87,1],[268,17,268,41,1],[269,13,269,14,1],[270,18,271,102,1],[272,13,272,14,1],[273,17,273,64,1],[274,17,274,71,1],[275,17,275,109,1],[276,17,277,90,1],[279,17,280,101,1],[281,17,282,88,1],[283,17,283,41,1],[284,13,284,14,1],[285,9,285,10,1],[288,9,288,10,1],[289,13,289,66,1],[290,13,290,70,1],[291,13,291,30,1],[294,13,294,89,1],[295,13,295,108,1],[296,13,296,51,1],[297,13,297,30,1],[298,13,298,45,1],[299,13,299,71,1],[300,9,300,10,1],[303,9,303,10,1],[304,13,304,66,1],[305,13,305,70,1],[308,13,308,89,1],[309,13,309,108,1],[310,13,310,51,1],[311,13,311,30,1],[312,13,312,45,1],[313,13,313,71,1],[314,9,314,10,1],[319,9,319,10,0],[320,13,320,105,0],[321,9,321,10,0],[324,9,324,10,1],[325,13,325,150,1],[326,9,326,10,1],[329,9,329,10,1],[330,13,330,66,1],[331,13,331,70,1],[333,13,333,31,1],[334,13,334,31,1],[335,13,335,122,1],[336,13,336,14,1],[337,17,337,89,1],[338,17,338,72,1],[339,13,339,14,1],[341,13,341,30,1],[343,13,343,109,1],[344,13,344,14,1],[345,17,345,100,1],[346,13,346,14,1],[348,13,348,89,1],[349,13,349,108,1],[352,13,352,31,1],[353,13,353,14,1],[354,17,354,52,1],[355,17,355,18,1],[356,21,356,121,1],[357,21,357,82,1],[358,21,358,93,1],[359,21,359,147,1],[360,21,360,130,1],[361,21,361,65,1],[362,21,362,87,1],[363,17,363,18,1],[365,17,365,18,1],[366,21,366,121,1],[367,21,367,105,1],[368,21,368,104,1],[369,21,369,66,1],[370,21,370,87,1],[371,17,371,18,1],[373,13,373,14,1],[375,13,375,51,1],[376,13,376,30,1],[377,13,377,45,1],[378,13,378,71,1],[381,9,381,10,1],[384,9,384,10,1],[386,13,386,14,1],[387,17,387,24,1],[387,26,387,45,1],[387,46,387,48,1],[387,49,387,68,1],[388,17,388,18,1],[389,21,389,78,1],[390,21,390,87,1],[392,21,392,82,1],[393,21,393,47,1],[394,21,394,22,1],[395,25,395,100,1],[396,21,396,22,1],[398,21,398,35,1],[399,21,399,40,1],[400,21,400,28,1],[400,30,400,48,1],[400,49,400,51,1],[400,52,400,69,1],[401,21,401,22,1],[402,25,402,89,1],[404,25,404,118,1],[405,25,405,26,1],[406,29,406,92,1],[407,25,407,26,1],[408,25,408,33,1],[409,21,409,22,1],[411,21,411,35,1],[413,21,413,28,1],[413,30,413,47,1],[413,48,413,50,1],[413,51,413,65,1],[414,21,414,22,1],[415,25,415,35,1],[416,25,416,59,1],[417,25,417,32,1],[417,34,417,41,1],[417,42,417,44,1],[417,45,417,64,1],[418,25,418,26,1],[419,29,419,64,1],[420,29,420,58,1],[423,29,423,95,1],[424,29,424,88,1],[425,29,425,72,1],[426,33,426,94,1],[427,34,427,73,1],[428,33,428,96,1],[430,29,430,60,1],[431,29,431,30,1],[432,33,432,58,1],[436,33,436,81,1],[438,33,438,89,1],[439,33,439,64,1],[440,33,440,104,1],[441,29,441,30,1],[442,34,442,64,1],[443,29,443,30,0],[444,33,444,76,0],[448,33,448,90,0],[450,33,450,64,0],[451,33,451,104,0],[452,29,452,30,0],[453,34,453,63,1],[454,29,454,30,1],[455,33,455,54,1],[456,33,456,74,1],[457,33,457,68,1],[458,33,458,102,1],[459,29,459,30,1],[461,29,461,30,1],[462,33,462,67,1],[463,29,463,30,1],[466,29,466,59,1],[467,29,467,30,1],[468,33,468,62,1],[469,37,469,86,1],[470,33,470,93,1],[471,33,471,34,1],[472,37,472,108,1],[473,33,473,34,1],[474,29,474,30,1],[475,29,475,37,1],[476,25,476,26,1],[477,25,477,33,1],[478,21,478,22,1],[479,17,479,18,1],[480,13,480,14,1],[481,13,481,32,0],[482,13,482,14,0],[483,17,484,102,0],[485,13,485,14,0],[486,9,486,10,1],[490,9,490,10,1],[491,13,491,75,1],[493,13,493,73,1],[494,13,494,14,1],[495,17,495,24,1],[495,26,495,45,1],[495,46,495,48,1],[495,49,495,69,1],[496,17,496,18,1],[497,21,497,88,1],[498,21,498,22,0],[499,25,499,60,0],[500,25,500,117,0],[501,25,501,26,0],[502,29,502,121,0],[503,25,503,26,0],[505,25,505,78,0],[506,25,506,26,0],[507,29,507,36,0],[507,38,507,51,0],[507,52,507,54,0],[507,55,507,68,0],[508,29,508,30,0],[509,33,509,72,0],[510,33,510,34,0],[511,37,511,70,0],[512,33,512,34,0],[513,29,513,30,0],[514,25,514,26,0],[515,21,515,22,0],[517,21,517,90,1],[518,21,518,22,0],[519,25,519,83,0],[520,25,520,119,0],[521,25,521,26,0],[522,29,523,111,0],[524,25,524,26,0],[526,25,526,104,0],[527,25,527,26,0],[528,29,528,36,0],[528,38,528,83,0],[528,84,528,86,0],[528,87,528,113,0],[529,29,529,30,0],[530,33,531,89,0],[532,33,532,34,0],[533,37,533,118,0],[534,33,534,34,0],[535,29,535,30,0],[536,25,536,26,0],[537,21,537,22,0],[539,21,539,89,1],[540,21,540,22,0],[541,25,541,90,0],[542,25,542,118,0],[543,25,543,26,0],[544,29,545,110,0],[546,25,546,26,0],[548,25,548,112,0],[549,25,549,26,0],[550,29,550,36,0],[551,33,551,91,0],[551,92,551,94,0],[552,37,552,67,0],[553,29,553,30,0],[554,33,554,99,0],[555,33,555,34,0],[556,37,557,77,0],[558,33,558,34,0],[560,29,560,30,0],[561,25,561,26,0],[562,21,562,22,0],[563,17,563,18,1],[564,13,564,14,1],[565,13,565,34,1],[566,9,566,10,1],[581,17,581,18,1],[581,19,581,39,1],[581,40,581,41,1],[582,17,582,18,1],[582,19,582,40,1],[582,41,582,42,1],[586,9,586,95,1],[590,17,590,18,1],[590,19,590,63,1],[590,64,590,65,1],[591,17,591,18,0],[591,19,591,64,0],[591,65,591,66,0],[594,9,594,107,1],[598,17,598,18,1],[598,19,598,65,1],[598,66,598,67,1],[599,17,599,18,0],[599,19,599,66,0],[599,67,599,68,0],[602,9,602,110,1],[606,17,606,18,1],[606,19,606,61,1],[606,62,606,63,1],[607,17,607,18,1],[607,19,607,62,1],[607,63,607,64,1],[616,9,616,109,1],[620,17,620,18,1],[620,19,620,64,1],[620,65,620,66,1],[621,17,621,18,0],[621,19,621,65,0],[621,66,621,67,0],[624,9,624,91,1],[628,17,628,18,0],[628,19,628,46,0],[628,47,628,48,0],[629,17,629,18,0],[629,19,629,47,0],[629,48,629,49,0],[633,9,633,50,1],[634,9,634,10,1],[635,13,635,36,1],[636,9,636,10,1]]);
    </script>
  </body>
</html>