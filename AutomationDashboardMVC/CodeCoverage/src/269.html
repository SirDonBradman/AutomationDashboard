<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Quantity Planning\QuantityPlanningMain.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI.BL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using System.Collections.Generic;
using System.Web.UI.WebControls;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.Core.AbstractModels;
using System.Web;

namespace Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI
{
    public partial class QuantityPlanningMain : BrixPageBase
    {
        protected HierarchicalGrid HGrid;
        protected ModalPopupExtender PopupExtender;
        private string ParentContext;
        private ScheduleUpdationModel _scheduleUpdationModel = null;
        private int InstanceId { get; set; }

        private int ContractId { get; set; }

        private int BucketCount { get; set; }

        private int StartNo
        {
            get { return Convert.ToInt32(Session[&quot;QPStartNo&quot;]); }
            set { Session[&quot;QPStartNo&quot;] = value; }
        }

        private int EndNo
        {
            get { return Convert.ToInt32(Session[&quot;QPEndNo&quot;]); }
            set { Session[&quot;QPEndNo&quot;] = value; }
        }

        private int CurrentLowerLimit
        {
            get { return Convert.ToInt32(Session[&quot;QPCurrentLowerLimit&quot;]); }
            set { Session[&quot;QPCurrentLowerLimit&quot;] = value; }
        }

        private int CurrentUpperLimit
        {
            get { return Convert.ToInt32(Session[&quot;QPCurrentUpperLimit&quot;]); }
            set { Session[&quot;QPCurrentUpperLimit&quot;] = value; }
        }

        private DataSet ScheduleData
        {
            get { return Session[&quot;QPScheduleData&quot;] as DataSet; }
            set { Session[&quot;QPScheduleData&quot;] = value; }
        }

        /// &lt;summary&gt;
        /// Gets the Project Mode : I-Integration, L-Live
        /// &lt;/summary&gt;
        private string ProjectMode
        {
            get { return (CacheManager.Instance.IsIntegrated(Request[Constants.QRY_PROJECTID].ToInt32_2()) ? &quot;I&quot; : &quot;L&quot;); }
        }

        private string QPStatus
        {
            get
            {
                return ViewState[&quot;QPStatus&quot;]?.ToString2();
            }
        }

        private string ForecastParentModuleID
        {
            get
            {
                return Request[&quot;ParentModuleID&quot;];
            }
        }

        private ScheduleUpdationModel ScheduleUpdationModel
        {
            get
            {
                if (_scheduleUpdationModel == null)
                {
                    if (ForecastParentModuleID != null &amp;&amp; ForecastParentModuleID.IsEqualToAny(StringComparison.CurrentCultureIgnoreCase, new string[] { &quot;BDGTEST&quot;, &quot;BDGTREV&quot; }))
                        _scheduleUpdationModel = ScheduleUpdationModel.GetInstance(&quot;BDGTEST&quot;);
                    else
                        _scheduleUpdationModel = ScheduleUpdationModel.GetInstance(&quot;QTYPLAN&quot;);
                }

                return _scheduleUpdationModel;
            }
        }

        protected override void OnPreInit(EventArgs e)
        {
            ContextElement = &quot;Quantity Planning Item List&quot;;
            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            ContextElementHGrid = HGrid;

            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);

            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)))
                if (AllowSave)
                    PermissionsToCheck.Add(Constants.MODFEAT_EDIT);

            base.OnInit(e);
        }

        protected override void CreateChildControls()
        {
            EnsureChildControls();
            CreateControlCollection();

            //var menus = new MenuArray();
            //if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)))
            //    menus.Add(new BrixMenu(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkPrevious&quot;, &quot;Previous Period&quot;, &quot;previous.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkNext&quot;, &quot;Next Period&quot;, &quot;next.png&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkDirectCostDetails&quot;, &quot;Direct Cost&quot;, &quot;Icn_DirectCost.gif&quot;, 55));
            //menus.Add(new BrixMenu(&quot;lnkFilter&quot;, &quot;Filter&quot;, &quot;IcnFilterApply.png&quot;, 70));
            //menus.Add(new BrixMenu(&quot;lnkFilterClr&quot;, &quot;Remove Filter&quot;, &quot;IcnFilterRem.png&quot;, 70));

            //CreateToolBarMenu(menus, null)

            List&lt;MenuGroup&gt; menuGroups = new List&lt;MenuGroup&gt;();
            MenuGroup generalGroup = new MenuGroup(&quot;General&quot;);
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)))
                if (AllowSave)
                    generalGroup.AddMenu(new LargeButton(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;));
            generalGroup.AddMenu(new LargeButton(&quot;lnkCancel&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;));
            generalGroup.AddMenu(new TextIcon(&quot;lnkPrevious&quot;, &quot;Previous Period&quot;, &quot;Icn_Previous_16.png&quot;));
            generalGroup.AddMenu(new TextIcon(&quot;lnkNext&quot;, &quot;Next Period&quot;, &quot;Icn_Next_16.png&quot;));
            List&lt;string&gt; QTYPLANcomponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_QTYPLAN);
            if (!QTYPLANcomponents.Contains(&quot;HideQPDirectCostDetailsLink&quot;))
                generalGroup.AddMenu(new TextIcon(&quot;lnkDirectCostDetails&quot;, &quot;Direct Cost&quot;, &quot;Icn_Rateanalysis_16.png&quot;));

            SplitButton btnFilter = new SplitButton(&quot;lnkFilter_SplitButton&quot;, &quot;Filter&quot;, &quot;Icn_Filter.png&quot;);
            btnFilter.AddSubMenu(new TextIcon(&quot;lnkFilter&quot;, &quot;Filter&quot;, &quot;Icn_Filter.png&quot;));
            btnFilter.AddSubMenu(new TextIcon(&quot;lnkFilterClr&quot;, &quot;Remove Filter&quot;, &quot;Icn_Filterremove_16.png&quot;));

            generalGroup.AddMenu(btnFilter);
            menuGroups.Add(generalGroup);

            CreateToolBarMenu(menuGroups, null);

            if (Request[&quot;Mode&quot;] != &quot;View&quot;)
            {
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).OnClientClick = &quot;return CheckSave();&quot;;
                MainToolBar.GetMenuReference(&quot;lnkFilter_SplitButton&quot;).OnClientClick = &quot;return CheckSave();&quot;;
            }

            InitFilter();
            SetPopUpDetails();
            ClientScript.RegisterStartupScript(aspPnlFilter.GetType(), &quot;showHideFilterButtons&quot;,
                                               &quot;showHideFilterButtons(&#39;&quot; +
                                               MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                               MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);&quot;, true);

            if (!IsPostBack)
                FormatNavigatorButtons();
            base.CreateChildControls();
        }

        private void SetPopUpDetails()
        {
            //PopupExtender = (ModalPopupExtender)this.Master.FindControl(&quot;filterExtender&quot;);
            PopupExtender.Visible = true;
            //PopupExtender.AddNewPopup(aspPnl.ClientID, btnHelper.ClientID, btnActCancel);

            if (MainToolBar.GetMenuReference(&quot;lnkFilter&quot;) != null &amp;&amp;
                MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).AddAttribute(&quot;style&quot;, &quot;display:none&quot;);
                PopupExtender.AddNewPopup(aspPnlFilter.ClientID,
                                          ((Request[&quot;Mode&quot;] == &quot;View&quot;)
                                               ? MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID
                                               : btnGhostCheck.ClientID), btnCancel.ClientID, 300, 550);

                PopupExtender.AddNewPopup(aspPnlFilter.ClientID,
                                          MainToolBar.GetMenuReference(&quot;lnkFilter_SplitButton&quot;).ClientID,
                                          btnCancel.ClientID, 300, 550);


                btnFilter.OnClientClick = &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID + &quot;&#39;).click();applyFilter(&#39;&quot; +
                                          btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                          MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                          MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);return false;&quot;;
                btnReset.Attributes.Add(&quot;onClick&quot;,
                                        &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID +
                                        &quot;&#39;).click();return resetFilters(&#39;&quot; + btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                        MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).ClientID + &quot;&#39;, &#39;&quot; +
                                        MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).ClientID + &quot;&#39;);&quot;);
                MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;).OnClientClick = &quot;return resetFilters(&#39;&quot; +
                                                                             btnFilterGhost.ClientID + &quot;&#39;, &#39;&quot; +
                                                                             MainToolBar.GetMenuReference(&quot;lnkFilter&quot;).
                                                                                 ClientID + &quot;&#39;, &#39;&quot; +
                                                                             MainToolBar.GetMenuReference(&quot;lnkFilterClr&quot;)
                                                                                 .ClientID + &quot;&#39;);&quot;;
            }
            // PopupExtender.Title = ((Request[hdnPickerClicked.ClientID] ?? &quot;R&quot;).Equals(&quot;P&quot;)) ? &quot;Filter&quot; : &quot;Activities&quot;;
        }

        private void InitFilter()
        {
            ClientScript.RegisterArrayDeclaration(&quot;FilterFields&quot;,
                                                  ModelHelper.GetFilterHtml(tblFilter, GetApplyFilterLabels()));
        }

        public BrixFilter[] GetApplyFilterLabels()
        {
            var filters = new BrixFilter[2];
            filters[0] = new BrixFilter();
            filters[0].Name = &quot;StandardItemNo&quot;;
            filters[0].Title = &quot;Name&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        private void FormatNavigatorButtons()
        {
            if (CurrentLowerLimit + BucketCount &gt; EndNo)
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            if (CurrentUpperLimit - BucketCount &lt; StartNo)
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
        }

        protected override void CustomizeToolBar()
        {
            AMP3.Core.UserControls.Menu lnkSave = MainToolBar.GetMenuReference(&quot;lnkSave&quot;);
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)))
            {
                if (lnkSave != null)
                {
                    lnkSave.Click += btnSave_Click;
                    lnkSave.OnClientClick = &quot;return SaveAndProceed(&#39;3&#39;);&quot;;
                }
            }

            if (!string.IsNullOrEmpty(QPStatus) &amp;&amp; !int.Equals(QPStatus.ToInt32_2(), QuantityPlanningStatus.Draft.ToInt32_2()))
            {
                if (lnkSave != null)
                {
                    lnkSave.Visible = false;
                }
            }

            var lnkCancel = MainToolBar.GetMenuReference(&quot;lnkCancel&quot;);

            if (lnkCancel != null)
            {
                lnkCancel.Click += btnCancel_Click;
                lnkCancel.CausesValidation = false;
            }

            var lnkNext = MainToolBar.GetMenuReference(&quot;lnkNext&quot;);
            if (lnkNext != null)
            {
                lnkNext.Click += btnFwdGhost_Click;
                lnkNext.OnClientClick = &quot;return SaveAndProceed(&#39;1&#39;);&quot;;
            }

            var lnkPrevious = MainToolBar.GetMenuReference(&quot;lnkPrevious&quot;);
            if (lnkPrevious != null)
            {
                lnkPrevious.Click += btnBwdGhost_Click;
                lnkPrevious.OnClientClick = &quot;return SaveAndProceed(&#39;2&#39;);&quot;;
            }

            List&lt;string&gt; QTYPLANcomponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_QTYPLAN);
            if (!QTYPLANcomponents.Contains(&quot;HideQPDirectCostDetailsLink&quot;))
            {
                var lnkDirectCostDetails = MainToolBar.GetMenuReference(&quot;lnkDirectCostDetails&quot;);
                if (lnkDirectCostDetails != null)
                {
                    lnkDirectCostDetails.Click += DirectCost_Click;
                    lnkDirectCostDetails.OnClientClick = &quot;return SaveAndProceed(&#39;2&#39;);&quot;;
                }
            }

            var lnkFilter = MainToolBar.GetMenuReference(&quot;lnkFilter&quot;);
            if (lnkFilter != null)
            {
                lnkFilter.Click += btnFilterGhost_Click;
            }
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            string xmlArgument = ScheduleUpdationModel.GetScheduleXMLForSaving(ScheduleData, InstanceId, ContractId);
            int result = 0;
            if (int.TryParse(
                QuantityPlanningManager.Instance.SaveItemScheduleData(InstanceId, xmlArgument).ToString2(), out result))
            {
                if (result == 1)
                    ShowSuccess(&quot;Saved successfully.&quot;);
                else
                    ShowError(&quot;The save was unsuccessful due to some unknown reason. Please try again.&quot;);
            }

            FetchData(string.Empty);
            FormatNavigatorButtons();
            BindItemDetailsGrid(string.Empty);

            Response.Redirect(HttpContext.Current.Request.RawUrl);
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            if (!string.IsNullOrEmpty(Request[&quot;BackURL&quot;]))
                Response.Redirect(Common.Utility.SecurityHelpers.Decrypt_Simple(Request[&quot;BackURL&quot;]));

            Response.Redirect(
                string.Format(
                    &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?PID={0}&amp;ParentID={1}&amp;QPID={2}&amp;Mode={3}&amp;Context=QTYPLAN&amp;ParentModuleID={4}&quot;,
                    Request[&quot;PID&quot;], ContractId, InstanceId, Request[&quot;Mode&quot;], Request[&quot;ParentModuleID&quot;]));
        }
        private void DirectCost_Click(object sender, EventArgs e)
        {
            Response.Redirect(&quot;~/Modules/QTYPLAN/DirectCostDetails.aspx?PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ParentID=&quot; +
                              Request[&quot;ParentID&quot;] + &quot;&amp;InstanceID=&quot; + Request[&quot;InstanceID&quot;] + &quot;&amp;Mode=&quot; + Request[&quot;Mode&quot;] +
                              &quot;&amp;Context=QTYPLAN&quot;);
        }

        protected void btnFwdGhost_Click(object sender, EventArgs e)
        {
            CurrentLowerLimit += BucketCount;
            if (CurrentUpperLimit + BucketCount &gt; EndNo) CurrentUpperLimit = EndNo;
            else CurrentUpperLimit += BucketCount;
            if (CurrentLowerLimit &gt; StartNo)
            {
                HideMenu(&quot;lnkPrevious&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
            }
            if (CurrentUpperLimit &lt; EndNo)
            {
                HideMenu(&quot;lnkNext&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            }
            BindItemDetailsGrid(string.Empty);
        }

        protected void btnBwdGhost_Click(object sender, EventArgs e)
        {
            int newVal = CurrentLowerLimit - 1;
            if (newVal &lt;= EndNo &amp;&amp; newVal &gt;= StartNo) CurrentUpperLimit = CurrentLowerLimit - 1;
            newVal = CurrentLowerLimit - BucketCount;
            if (newVal &lt;= EndNo &amp;&amp; newVal &gt;= StartNo) CurrentLowerLimit -= BucketCount;
            if (CurrentLowerLimit &gt; StartNo)
            {
                HideMenu(&quot;lnkPrevious&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkPrevious&quot;);
            }
            if (CurrentUpperLimit &lt; EndNo)
            {
                HideMenu(&quot;lnkNext&quot;, true);
            }
            else
            {
                MainToolBar.HideMenu(&quot;lnkNext&quot;);
            }

            BindItemDetailsGrid(string.Empty);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            InstanceId = string.IsNullOrEmpty(Request[&quot;InstanceId&quot;]) ? 0 : Request[&quot;InstanceId&quot;].ToInt32_2();
            ContractId = Request[&quot;ParentID&quot;].ToInt32_2();
            PageTitle = ItemNameAbbr + &quot; Details&quot;;

            //TODO: Obtain bucket count from the user
            BucketCount = 5;

            if (!IsPostBack)
                FetchData(string.Empty);

            BindItemDetailsGrid(string.Empty);
            if (!ClientScript.IsStartupScriptRegistered(&quot;QP_HGrid_ActivateRow&quot;))
                ClientScript.RegisterStartupScript(Page.GetType(), &quot;QP_HGrid_ActivateRow&quot;,
                    &quot;$(\&quot;#topGridDiv\&quot;).bind(&#39;contextmenu&#39;,function(e){return ActivateRow(e);}); &quot;, true);
        }

        private void FetchData(string filter)
        {
            ScheduleData = ScheduleUpdationModel.GetItemDetailsforScheduling(InstanceId, ContractId, filter);
            AppendScheduleInfo();
            int rowCount = ScheduleData.Tables[3].Rows.Count;
            StartNo = CurrentLowerLimit = ScheduleData.Tables[3].Rows[0][&quot;Number&quot;].ToInt32_2();
            EndNo = ScheduleData.Tables[3].Rows[rowCount - 1][&quot;Number&quot;].ToInt32_2();
            if (CurrentLowerLimit + BucketCount &gt; EndNo)
            {
                CurrentUpperLimit = EndNo;
            }
            else CurrentUpperLimit = CurrentLowerLimit + (BucketCount - 1);

            if (InstanceId &gt; 0)
            {
                DataTable planningDetails = null;
                planningDetails = QuantityPlanningManager.Instance.GetQPDetails(InstanceId);

                if (planningDetails != null &amp;&amp; planningDetails.Rows.Count &gt; 0)
                {
                    DataRow[] dr = planningDetails.Select(&quot;QPID=&quot; + InstanceId);
                    ViewState[&quot;QPStatus&quot;] = dr[0][&quot;Status&quot;].ToString();
                }
            }
        }

        private void AppendScheduleInfo()
        {
            DataTable scheduleInfo = ScheduleData.Tables[4];
            int tempScheduleID;
            foreach (DataColumn scheduleID in scheduleInfo.Columns)
                if (Int32.TryParse(scheduleID.ColumnName, out tempScheduleID))
                    ScheduleData.Tables[1].Columns.Add(tempScheduleID.ToString2());
            int itemId;
            foreach (DataRow itemInfo in ScheduleData.Tables[1].Select())
            {
                itemId = itemInfo[&quot;ItemID&quot;].ToInt32_2();
                DataRow[] itemScheduleInfo = scheduleInfo.Select(&quot;SchItemID = &#39;&quot; + itemId + &quot;&#39;&quot;);
                if (itemScheduleInfo.Length &gt; 0)
                {
                    foreach (DataColumn scheduleID in scheduleInfo.Columns)
                    {
                        if (Int32.TryParse(scheduleID.ColumnName, out tempScheduleID))
                        {
                            itemInfo[tempScheduleID.ToString2()] = itemScheduleInfo[0][tempScheduleID.ToString2()];
                        }
                    }
                }
            }
        }

        private void BindItemDetailsGrid(string filter)
        {
            // filter = string.IsNullOrEmpty(filter) ? &quot;&lt;XMLRoot&gt;&lt;IsContractView&gt;1&lt;/IsContractView&gt;&lt;/XMLRoot&gt;&quot; : filter.Replace(&quot;&lt;/XMLRoot&gt;&quot;, &quot;&lt;IsContractView&gt;1&lt;/IsContractView&gt;&lt;/XMLRoot&gt;&quot;);
            if (ScheduleData == null)
            {
                string moduleID = &quot;QTYPLAN&quot;;
                ScheduleUpdationModel model = null;

                if (!String.IsNullOrEmpty(Request[&quot;ParentModuleId&quot;]))
                    moduleID = Request[&quot;ParentModuleId&quot;];
                if (moduleID.IsEqualToAny(StringComparison.CurrentCultureIgnoreCase, new string[] { &quot;BDGTEST&quot;, &quot;BDGTREV&quot; }))
                    model = ScheduleUpdationModel.GetInstance(&quot;BDGTEST&quot;);
                else
                    model = ScheduleUpdationModel.GetInstance(&quot;QTYPLAN&quot;);
                ScheduleData = model.GetItemDetailsforScheduling(InstanceId, ContractId, filter);
            }

            ScheduleData.Tables[0].TableName = &quot;Container&quot;;
            ScheduleData.Tables[1].TableName = &quot;Items&quot;;
            ScheduleData.Tables[2].TableName = &quot;ItemSummary&quot;;

            HGrid.ContainerTable = ScheduleData.Tables[&quot;Container&quot;];
            HGrid.ItemTable = ScheduleData.Tables[&quot;Items&quot;];
            HGrid.ItemSummaryTable = ScheduleData.Tables[&quot;ItemSummary&quot;];
            HGrid.ContainerIDColumn = &quot;ContainerID&quot;;
            HGrid.ParentContainerIDColumn = &quot;ParentContainerID&quot;;
            HGrid.ContainerNameColumn = &quot;ContainerName&quot;;
            HGrid.ItemIDColumn = &quot;ItemID&quot;;
            HGrid.ItemNameColumn = &quot;StandardItemNo&quot;;
            HGrid.ItemContainerIDColumn = &quot;ContainerID&quot;;

            HGrid.AmountColumn = AmountColumn();
            //If there is no mode or the mode is View then the user should not able to modify the grid column values
            if ((Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;View&quot;)) ||
                (!string.IsNullOrEmpty(QPStatus) &amp;&amp; !int.Equals(QPStatus.ToInt32_2(), QuantityPlanningStatus.Draft.ToInt32_2())))
            {
                HGrid.IsReadOnly = true;
            }
            else
                HGrid.IsCompleteReadOnly = HGrid.IsReadOnly = false;

            HGrid.Columns = HGridColumns(CurrentLowerLimit);
            HGrid.IsItemSummaryVisible = false;
            HGrid.disableGridSaveButton = true;

            HGrid.FetchActivities += HGrid_FetchActivities;
            HGrid.FetchSubItems += HGrid_FetchSubItems;
            HGrid.saveEditedItems += HGrid_saveEditedItems;
            HGrid.SaveControlSettings += HGrid_SaveControlSettings;
            HGrid.MoveForward += btnFwdGhost_Click;
            HGrid.MoveBackward += btnBwdGhost_Click;
            HGrid.PersistPlanningDatatoDatabase += btnSave_Click;
            HGrid.FindControl(&quot;ESI&quot;).EnableViewState = false;

            HGrid.Bind();
        }

        private void HGrid_SaveControlSettings(object sender, EventArgs e)
        {
            throw new NotImplementedException();
        }

        private void HGrid_saveEditedItems(object sender, ItemsArgs e)
        {
            foreach (var dic in e.Items)
            {
                string itemId = dic[&quot;ItemID&quot;];
                if (ScheduleData.Tables[1].Select(&quot;ItemID = &#39;&quot; + itemId + &quot;&#39;&quot;).Length &gt; 0)
                {
                    DataRow itemRow = ScheduleData.Tables[1].Select(&quot;ItemID = &#39;&quot; + itemId + &quot;&#39;&quot;)[0];
                    foreach (var pair in dic)
                    {
                        if (itemRow[pair.Key] != null)
                        {
                            if (string.IsNullOrEmpty(pair.Value.Trim()))
                                itemRow[pair.Key] = DBNull.Value;
                            else
                                itemRow[pair.Key] = pair.Value.Trim().ToDecimal2();
                        }
                    }
                    decimal plannedQty = 0, quantity;
                    int scheduleId;
                    foreach (DataColumn schedule in itemRow.Table.Columns)
                    {
                        if (int.TryParse(schedule.ColumnName, out scheduleId))
                            plannedQty += (decimal.TryParse(itemRow[schedule].ToString2(), out quantity) ? quantity : 0);
                    }
                    itemRow[&quot;RemainingQty&quot;] = itemRow[&quot;Quantity&quot;].ToDecimal2() - plannedQty;
                }
            }

            try
            {
                HGrid.CallbackResult = &quot;1&quot;;
            }
            catch (Exception ex)
            {
                HGrid.CallbackResult = &quot;Error:&quot; + ex.Message;
            }
        }

        private void HGrid_FetchSubItems(HierarchicalGrid sender, int itemID)
        {
            sender.SubItemTable = new DataTable();
        }

        private void HGrid_FetchActivities(HierarchicalGrid sender, int itemID)
        {
            sender.ActivityTable = new DataTable();
        }

        private HierarchicalGridColumns HGridColumns(int lowerLimit)
        {
            var tempHGridColumns = new HierarchicalGridColumns();

            List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
            string qtyColumnName = ModuleComponents.Contains(&quot;UnitQuantityModel&quot;) ?
                LocalizationManager.GetString(&quot;Amount&quot;) : LocalizationManager.GetString(&quot;Quantity&quot;);

            tempHGridColumns.TreeColumnWidth = 180;
            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;LineNo&quot;, 70, false, null, true, &quot;Line Number&quot;));
            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Description&quot;, 200, false));
            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Unit&quot;, 40));

            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;Quantity&quot;, 100, false, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, true, &quot;Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL)));
            tempHGridColumns.Add(new HierarchicalGridColumn(&quot;RemainingQty&quot;, 100, false, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, true, &quot;Remaining Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL)));

            int currentScheduleNumber = 0;
            if (ScheduleData.Tables.Count &gt; 5 &amp;&amp; ScheduleData.Tables[5].Rows.Count &gt; 0)
            {
                currentScheduleNumber = ScheduleData.Tables[5].Rows[0][&quot;Number&quot;].ToInt32_2();
            }

            for (int i = lowerLimit; i &lt;= CurrentUpperLimit; i++)
                tempHGridColumns.Add(new HierarchicalGridColumn(i.ToString2(), 100, i &gt;= currentScheduleNumber, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                true, Caption: GetColumnHeader(i)));

            return tempHGridColumns;
        }

        private string GetColumnHeader(int number)
        {
            if (ScheduleData.Tables.Count &gt;= 3 &amp;&amp; ScheduleData.Tables[3].Columns.Contains(&quot;Number&quot;))
            {
                DataRow currentRow = ScheduleData.Tables[3].Select(&quot;Number = &#39;&quot; + number + &quot;&#39;&quot;)[0];
                DateTime dateColName;

                if (ScheduleData.Tables[3].Columns.Contains(&quot;Name&quot;))
                {
                    if (currentRow[&quot;PeriodBasis&quot;].ToString2().Equals(&quot;2&quot;) &amp;&amp;
                        DateTime.TryParse(currentRow[&quot;Name&quot;].ToString2(), out dateColName))
                        return dateColName.ToMWDateTimeString_FormatDate();
                    else
                        return currentRow[&quot;Name&quot;].ToString2();
                }
                else
                    return @&quot;Week &quot; + (number - StartNo + 1) + &quot;: &quot; +
                           currentRow[&quot;StartDate&quot;].ToMWDateTimeString_FormatDate()
                           + &quot; - &quot; + currentRow[&quot;EndDate&quot;].ToMWDateTimeString_FormatDate();
            }
            return number.ToString();
        }

        public HierarchicalGridColumn AmountColumn()
        {
            var col = new HierarchicalGridColumn(&quot;Amount&quot;, 120, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, false);
            col.Caption = &quot;Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL);
            return col;
        }

        protected void btnFilterGhost_Click(object sender, EventArgs e)
        {
            string filter = ModelHelper.GetFilterXML(tblFilter.UniqueID.Remove(tblFilter.UniqueID.Length - 9), Request,
                                                     GetApplyFilterLabels());
            FetchData(filter);
            FormatNavigatorButtons();
            BindItemDetailsGrid(string.Empty);
        }

        private void HideMenu(string buttonID, bool bUnHide)
        {
            if (bUnHide) MainToolBar.ShowMenu(buttonID);
            else MainToolBar.HideMenu(buttonID);
        }

        protected override void CreateContextMenu()
        {
            HGrid.GetContextMenu(CMenu.CMenuArray);

            base.CreateContextMenu();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,69,1],[28,34,28,38,1],[28,39,28,43,1],[30,34,30,38,1],[30,39,30,43,1],[32,35,32,39,1],[32,40,32,44,1],[36,17,36,18,1],[36,19,36,64,1],[36,65,36,66,1],[37,17,37,18,1],[37,19,37,48,1],[37,49,37,50,1],[42,17,42,18,1],[42,19,42,62,1],[42,63,42,64,1],[43,17,43,18,1],[43,19,43,46,1],[43,47,43,48,1],[48,17,48,18,1],[48,19,48,74,1],[48,75,48,76,1],[49,17,49,18,1],[49,19,49,58,1],[49,59,49,60,1],[54,17,54,18,1],[54,19,54,74,1],[54,75,54,76,1],[55,17,55,18,1],[55,19,55,58,1],[55,59,55,60,1],[60,17,60,18,1],[60,19,60,63,1],[60,64,60,65,1],[61,17,61,18,1],[61,19,61,53,1],[61,54,61,55,1],[69,17,69,18,0],[69,19,69,121,0],[69,122,69,123,0],[75,13,75,14,1],[76,17,76,59,1],[77,13,77,14,1],[83,13,83,14,1],[84,17,84,50,1],[85,13,85,14,1],[91,13,91,14,1],[92,17,92,52,1],[93,17,93,18,1],[94,21,94,177,1],[95,25,95,95,1],[97,25,97,95,1],[98,17,98,18,1],[100,17,100,47,1],[101,13,101,14,1],[105,9,105,10,1],[106,13,106,60,1],[107,13,107,31,1],[108,9,108,10,1],[111,9,111,10,1],[112,13,112,41,1],[114,13,114,66,1],[116,13,116,78,1],[117,17,117,31,1],[118,21,118,68,1],[120,13,120,28,1],[121,9,121,10,1],[124,9,124,10,1],[125,13,125,35,1],[126,13,126,39,1],[140,13,140,64,1],[141,13,141,63,1],[142,13,142,78,1],[143,17,143,31,1],[144,21,144,94,1],[145,13,145,88,1],[146,13,146,105,1],[147,13,147,93,1],[148,13,148,115,1],[149,13,149,76,1],[150,17,150,118,0],[152,13,152,106,1],[153,13,153,89,1],[154,13,154,108,1],[156,13,156,45,1],[157,13,157,42,1],[159,13,159,49,1],[161,13,161,43,1],[162,13,162,14,1],[163,17,163,97,1],[164,17,164,109,1],[165,13,165,14,1],[167,13,167,26,1],[168,13,168,31,1],[169,13,172,117,1],[174,13,174,29,1],[175,17,175,42,1],[176,13,176,40,1],[177,9,177,10,1],[180,9,180,10,1],[182,13,182,42,1],[185,13,186,70,1],[187,13,187,14,1],[188,17,188,97,1],[189,17,192,105,1],[194,17,196,73,1],[199,17,202,118,1],[203,17,207,104,1],[208,17,213,100,1],[214,13,214,14,1],[216,9,216,10,1],[219,9,219,10,1],[220,13,221,113,1],[222,9,222,10,1],[225,9,225,10,1],[226,13,226,45,1],[227,13,227,43,1],[228,13,228,48,1],[229,13,229,39,1],[230,13,230,58,1],[232,13,232,43,1],[233,13,233,64,1],[234,13,234,58,1],[236,13,236,28,1],[237,9,237,10,1],[240,9,240,10,1],[241,13,241,57,1],[242,17,242,49,0],[243,13,243,59,1],[244,17,244,53,1],[245,9,245,10,1],[248,9,248,10,1],[249,13,249,91,1],[250,13,250,78,1],[251,13,251,14,1],[252,17,252,37,1],[253,17,253,18,1],[254,21,254,52,1],[255,21,255,75,1],[256,17,256,18,1],[257,13,257,14,1],[259,13,259,128,1],[260,13,260,14,1],[261,17,261,37,1],[262,17,262,18,1],[263,21,263,45,1],[264,17,264,18,1],[265,13,265,14,1],[267,13,267,71,1],[269,13,269,35,1],[270,13,270,14,1],[271,17,271,52,1],[272,17,272,52,1],[273,13,273,14,1],[275,13,275,67,1],[276,13,276,33,1],[277,13,277,14,1],[278,17,278,52,1],[279,17,279,71,1],[280,13,280,14,1],[282,13,282,75,1],[283,13,283,37,1],[284,13,284,14,1],[285,17,285,56,1],[286,17,286,75,1],[287,13,287,14,1],[289,13,289,115,1],[290,13,290,76,1],[291,13,291,14,0],[292,17,292,97,0],[293,17,293,50,0],[294,17,294,18,0],[295,21,295,68,0],[296,21,296,88,0],[297,17,297,18,0],[298,13,298,14,0],[300,13,300,71,1],[301,13,301,35,1],[302,13,302,14,1],[303,17,303,57,1],[304,13,304,14,1],[305,9,305,10,1],[308,9,308,10,1],[309,13,309,118,1],[310,13,310,28,1],[311,13,312,121,1],[313,13,313,14,1],[314,17,314,33,1],[315,21,315,56,1],[317,21,317,106,0],[318,13,318,14,1],[320,13,320,37,1],[321,13,321,38,1],[322,13,322,47,1],[324,13,324,67,1],[325,9,325,10,0],[328,9,328,10,0],[329,13,329,59,0],[330,17,330,102,0],[332,13,335,106,0],[336,9,336,10,0],[338,9,338,10,0],[339,13,341,51,0],[342,9,342,10,0],[345,9,345,10,1],[346,13,346,46,1],[347,13,347,57,1],[347,58,347,84,0],[348,18,348,51,1],[349,13,349,45,1],[350,13,350,14,1],[351,17,351,47,1],[352,13,352,14,1],[354,13,354,14,0],[355,17,355,53,0],[356,13,356,14,0],[357,13,357,43,1],[358,13,358,14,1],[359,17,359,43,1],[360,13,360,14,1],[362,13,362,14,0],[363,17,363,49,0],[364,13,364,14,0],[365,13,365,47,1],[366,9,366,10,1],[369,9,369,10,0],[370,13,370,48,0],[371,13,371,54,0],[371,55,371,97,0],[372,13,372,54,0],[373,13,373,54,0],[373,55,373,88,0],[374,13,374,45,0],[375,13,375,14,0],[376,17,376,47,0],[377,13,377,14,0],[379,13,379,14,0],[380,17,380,53,0],[381,13,381,14,0],[382,13,382,43,0],[383,13,383,14,0],[384,17,384,43,0],[385,13,385,14,0],[387,13,387,14,0],[388,17,388,49,0],[389,13,389,14,0],[391,13,391,47,0],[392,9,392,10,0],[395,9,395,10,1],[396,13,396,110,1],[397,13,397,58,1],[398,13,398,51,1],[401,13,401,29,1],[403,13,403,29,1],[404,17,404,41,1],[406,13,406,47,1],[407,13,407,81,1],[408,17,409,107,1],[410,9,410,10,1],[413,9,413,10,1],[414,13,414,110,1],[415,13,415,34,1],[416,13,416,62,1],[417,13,417,96,1],[418,13,418,85,1],[419,13,419,57,1],[420,13,420,14,0],[421,17,421,43,0],[422,13,422,14,0],[423,18,423,76,1],[425,13,425,32,1],[426,13,426,14,1],[427,17,427,50,1],[428,17,428,93,1],[430,17,430,79,1],[431,17,431,18,1],[432,21,432,81,1],[433,21,433,72,1],[434,17,434,18,1],[435,13,435,14,1],[436,9,436,10,1],[439,9,439,10,1],[440,13,440,61,1],[442,13,442,20,1],[442,22,442,43,1],[442,44,442,46,1],[442,47,442,67,1],[443,17,443,79,1],[444,21,444,84,1],[446,13,446,20,1],[446,22,446,38,1],[446,39,446,41,1],[446,42,446,73,1],[447,13,447,14,1],[448,17,448,57,1],[449,17,449,98,1],[450,17,450,49,1],[451,17,451,18,1],[452,21,452,28,1],[452,30,452,51,1],[452,52,452,54,1],[452,55,452,75,1],[453,21,453,22,1],[454,25,454,87,1],[455,25,455,26,1],[456,29,456,116,1],[457,25,457,26,1],[458,21,458,22,1],[459,17,459,18,1],[460,13,460,14,1],[461,9,461,10,1],[464,9,464,10,1],[466,13,466,38,1],[467,13,467,14,0],[468,17,468,45,0],[469,17,469,52,0],[471,17,471,70,0],[472,21,472,58,0],[473,17,473,125,0],[474,21,474,74,0],[476,21,476,74,0],[477,17,477,98,0],[478,13,478,14,0],[480,13,480,60,1],[481,13,481,56,1],[482,13,482,62,1],[484,13,484,69,1],[485,13,485,60,1],[486,13,486,73,1],[487,13,487,53,1],[488,13,488,65,1],[489,13,489,57,1],[490,13,490,43,1],[491,13,491,53,1],[492,13,492,57,1],[494,13,494,49,1],[496,13,497,130,1],[498,13,498,14,1],[499,17,499,41,1],[500,13,500,14,1],[502,17,502,69,1],[504,13,504,61,1],[505,13,505,48,1],[506,13,506,48,1],[508,13,508,60,1],[509,13,509,56,1],[510,13,510,60,1],[511,13,511,68,1],[512,13,512,52,1],[513,13,513,53,1],[514,13,514,66,1],[515,13,515,62,1],[517,13,517,26,1],[518,9,518,10,1],[521,9,521,10,1],[522,13,522,49,1],[526,9,526,10,1],[527,13,527,20,1],[527,22,527,29,1],[527,30,527,32,1],[527,33,527,40,1],[528,13,528,14,1],[529,17,529,47,1],[530,17,530,91,1],[531,17,531,18,1],[532,21,532,101,1],[533,21,533,28,1],[533,30,533,38,1],[533,39,533,41,1],[533,42,533,45,1],[534,21,534,22,1],[535,25,535,55,1],[536,25,536,26,1],[537,29,537,73,1],[538,33,538,66,0],[540,33,540,84,1],[541,25,541,26,1],[542,21,542,22,1],[543,21,543,43,1],[545,21,545,28,1],[545,30,545,49,1],[545,50,545,52,1],[545,53,545,74,1],[546,21,546,22,1],[547,25,547,79,1],[548,29,548,122,1],[549,21,549,22,1],[550,21,550,93,1],[551,17,551,18,1],[552,13,552,14,1],[555,13,555,14,1],[556,17,556,44,1],[557,13,557,14,1],[558,13,558,33,0],[559,13,559,14,0],[560,17,560,62,0],[561,13,561,14,0],[562,9,562,10,1],[565,9,565,10,0],[566,13,566,51,0],[567,9,567,10,0],[570,9,570,10,0],[571,13,571,52,0],[572,9,572,10,0],[575,9,575,10,1],[576,13,576,66,1],[578,13,578,111,1],[579,13,580,101,1],[582,13,582,52,1],[583,13,583,110,1],[584,13,584,89,1],[585,13,585,74,1],[587,13,587,220,1],[588,13,588,234,1],[590,13,590,43,1],[591,13,591,88,1],[592,13,592,14,1],[593,17,593,94,1],[594,13,594,14,1],[596,18,596,36,1],[596,38,596,60,1],[596,62,596,65,1],[597,17,598,101,1],[600,13,600,37,1],[601,9,601,10,1],[604,9,604,10,1],[605,13,605,101,1],[606,13,606,14,1],[607,17,607,100,1],[610,17,610,69,1],[611,17,611,18,1],[612,21,613,92,1],[614,25,614,76,0],[616,25,616,63,1],[619,21,621,92,0],[623,13,623,38,0],[624,9,624,10,1],[627,9,627,10,1],[628,13,628,120,1],[629,13,629,106,1],[630,13,630,24,1],[631,9,631,10,1],[634,9,634,10,0],[635,13,636,78,0],[637,13,637,31,0],[638,13,638,38,0],[639,13,639,47,0],[640,9,640,10,0],[643,9,643,10,1],[644,13,644,25,1],[644,26,644,57,1],[645,18,645,49,0],[646,9,646,10,1],[649,9,649,10,1],[650,13,650,52,1],[652,13,652,38,1],[653,9,653,10,1]]);
    </script>
  </body>
</html>