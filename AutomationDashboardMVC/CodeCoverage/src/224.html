<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Pay Estimates\ConcreateModels\EstimatesListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Web;
using System.Drawing;
using System.Globalization;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ContmgtDTO;
using Aurigo.AMP3.CONTMGTPEDTO;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.AMP3.WORKORDBL;
using Aurigo.Brix.Construction.ContractManager.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.Documents.Excel;
using Infragistics.WebUI.UltraWebGrid;
using Infragistics.WebUI.UltraWebGrid.ExcelExport;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Telerik.Web.UI;

namespace Aurigo.AMP3.ContractManagementPayEstimatesUI
{
    [ListModelContext(Name = &quot;PAYESTM&quot;, Table = &quot;CONTMGTPEMaster&quot;)]
    public class EstimatesListModel : ListModel, IWorkflowEnabledList
    {
        private static DataSet reportDS;
        private readonly Dictionary&lt;string, object&gt; retDic = new Dictionary&lt;string, object&gt;();
        public bool islatest;
        public string selPEId = &quot;&quot;;

        public override string QueryStringName
        {
            get { return &quot;ID&quot;; }
        }

        public override string ModuleId
        {
            get { return &quot;PAYESTM&quot;; }
        }

        public override bool HasMultiApprove
        {
            get { return false; }
        }

        protected bool IsFinal
        {
            get
            {
                return (MWGrid.GetSelectedRow(mwGrid) != null &amp;&amp;
                        MWGrid.ColumnExists(MWGrid.GetSelectedRow(mwGrid), &quot;IsFinal&quot;) &amp;&amp;
                       MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;IsFinal&quot;).ToBoolean2());
            }
        }

        public override List&lt;MenuGroup&gt; MenuGroups
        {
            get
            {
                List&lt;MenuGroup&gt; menuGroups = base.MenuGroups;

                MenuGroup otherGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_OTHERS);
                if (otherGroup == null)
                {
                    otherGroup = new MenuGroup(GROUP_OTHERS);
                    menuGroups.Add(otherGroup);
                }
                if (displaySettings)
                {
                    otherGroup.AddMenu(new TextIcon(&quot;lnkSettings&quot;, &quot;Settings&quot;, &quot;Icn_Settings_16.png&quot;));
                }
                var permissions = (HttpContext.Current.Items[Constants.MODULE_PERMISSIONS] as List&lt;string&gt;);
                if (string.IsNullOrEmpty(Request[&quot;woid&quot;]))
                    if (permissions.Contains(&quot;RetentionRelease&quot;))
                        otherGroup.AddMenu(new TextIcon(&quot;lnkRetentionRelease&quot;, &quot;Retention Release&quot;,
                                                        &quot;Icn_Retensionrelease_16.png&quot;));
                MenuButton reportButton = (MenuButton)otherGroup.Menus.Find(m =&gt; m.ID == MENU_REPORTS_ID);
                if (reportButton == null)
                {
                    reportButton = new MenuButton(MENU_REPORTS_ID, MENU_REPORTS, &quot;Icn_Reports.png&quot;);
                    //otherGroup.AddMenu(reportButton);
                }
                bool hasReports = reportButton.SubMenus.Count &gt; 0;
                if (displayReportsPE)
                {
                    reportButton.AddSubMenu(new TextIcon(&quot;lnkReportOverview&quot;, PayEstimateName + &quot; Overview&quot;, &quot;Icn_Pdf_16.png&quot;));

                    reportButton.AddSubMenu(new TextIcon(&quot;lnkReportSections&quot;, PayEstimateName + &quot; Detail&quot;, &quot;Icn_Pdf_16.png&quot;));

                    reportButton.AddSubMenu(new TextIcon(&quot;lnkReportGroups&quot;, PayEstimateName + &quot; by &quot; + Group, &quot;Icn_Pdf_16.png&quot;));
                }
                if (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]))
                {
                    reportDS =
                            ComponentHelper.Instance.ExecuteDataSet(
                                ContractManagerStoredProcedure.usp_RPTMGMTGetReports, retDic, null, null, null, null,
                                null, null, null, null, &quot;MBOOKPT&quot;);
                    if (reportDS.Tables[0].Rows.Count &gt; 0)
                        reportButton.AddSubMenu(new TextIcon(&quot;lnkMeasurementBook&quot;, LocalizationManager.GetString(&quot;LOC_MeasurementBook&quot;), &quot;Icn_Pdf_16.png&quot;));
                }
                if (!reportButton.HasSubMenus)
                {
                    otherGroup.Menus.Remove(reportButton);
                }
                else if (!hasReports)
                    otherGroup.AddMenu(reportButton);
                if (permissions.Contains(&quot;FinalPE&quot;) &amp;&amp; islatest)
                {
                    otherGroup.AddMenu(new TextIcon(&quot;lnkFinal&quot;, &quot;Final&quot;, &quot;Icn_lock_16.png&quot;));
                }


                return menuGroups;
            }
        }

        public override MenuArray Menus
        {
            get
            {
                MenuArray m = base.Menus;
                //if (string.IsNullOrEmpty(Request[&quot;WOID&quot;]))
                //{
                int idx = 1, j = 1;
                foreach (BrixMenu BMenu in m)
                {
                    if (BMenu.Id == &quot;lnkApprove&quot; &amp;&amp; BMenu.Name == &quot;Approve&quot;)
                        j = idx - 1;
                    else if (string.IsNullOrEmpty(Request[&quot;woid&quot;]) &amp;&amp; BMenu.Name.Equals(&quot;Others&quot;))
                    {
                        var permissions = (HttpContext.Current.Items[Constants.MODULE_PERMISSIONS] as List&lt;string&gt;);
                        if (permissions.Contains(&quot;RetentionRelease&quot;))
                            BMenu.subMenus.Add(new BrixMenu(&quot;lnkRetentionRelease&quot;, &quot;Retention Release&quot;,
                                                            &quot;Icn_Settings.gif&quot;));
                    }
                    else if (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp; BMenu.Name.Equals(&quot;Reports&quot;))
                    {
                        reportDS =
                            ComponentHelper.Instance.ExecuteDataSet(
                                ContractManagerStoredProcedure.usp_RPTMGMTGetReports, retDic, null, null, null, null,
                                null, null, null, null, &quot;MBOOKPT&quot;);
                        if (reportDS.Tables[0].Rows.Count &gt; 0)
                            BMenu.subMenus.Add(new BrixMenu(&quot;lnkMeasurementBook&quot;, LocalizationManager.GetString(&quot;LOC_MeasurementBook&quot;), &quot;Icn_viewPDF.gif&quot;));
                    }
                    ++idx;
                }
                //BrixMenu mi = new BrixMenu(&quot;lnkSubmit&quot;, &quot;Submit&quot;, &quot;Icn_Approve.png&quot;);
                //m.Insert((j == 1) ? m.Count - 2 : j, mi);
                if (HttpContext.Current.Items.Contains(Constants.MODULE_PERMISSIONS))
                {
                    var permissions = (HttpContext.Current.Items[Constants.MODULE_PERMISSIONS] as List&lt;string&gt;);
                    if (permissions.Contains(&quot;FinalPE&quot;) &amp;&amp; islatest)
                        m.Insert((j == 1) ? m.Count - 2 : j, new BrixMenu(&quot;lnkFinal&quot;, &quot;Final&quot;, &quot;IcnLock.png&quot;));
                }
                //}
                return m;
            }
        }

        public override OtherAction[] OtherActions
        {
            get
            {
                var list = new List&lt;OtherAction&gt;();

                var action = new OtherAction();
                action.ID = &quot;lnkReportOverview&quot;;
                action.Name = &quot;Report Overview&quot;;
                list.Add(action);

                action = new OtherAction();
                action.ID = &quot;lnkReportSections&quot;;
                action.Name = &quot;Report by Sections&quot;;
                list.Add(action);

                action = new OtherAction();
                action.ID = &quot;lnkReportGroups&quot;;
                action.Name = &quot;Report by Global Groups&quot;;
                list.Add(action);

                return list.ToArray();
            }
        }

        #region IWorkflowEnabledList Members

        public string FormName
        {
            get { return &quot;XPAYEST&quot;; }
        }

        public int ParentModuleId
        {
            get { return 0; }
        }

        public string ListPrimaryKey
        {
            get { return &quot;ID&quot;; }
        }

        public int PID
        {
            get { return 0; }
        }

        #endregion

        #region Enterprise Search

        public override string PIDKey
        {
            get { return &quot;PID&quot;; }
        }

        public override string ParentIDKey
        {
            get { return &quot;ContractID&quot;; }
        }

        #endregion

        public override void ApplyToolBarCustomisation(ToolBar toolBarArg)
        {
            base.ApplyToolBarCustomisation(toolBarArg);
            if (HttpContext.Current.Items.Contains(Constants.MODULE_PERMISSIONS))
            {
                var permissions = (HttpContext.Current.Items[Constants.MODULE_PERMISSIONS] as List&lt;string&gt;);

                if (toolBarArg.GetMenuReference(&quot;lnkSubmit&quot;) != null)
                {
                    toolBarArg.GetMenuReference(&quot;lnkSubmit&quot;).Enabled = permissions.Contains(&quot;Create&quot;);
                    toolBarArg.GetMenuReference(&quot;lnkSubmit&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                  Convert.ToInt32(ValidateSelection.OneItem, CultureInfo.CurrentCulture) +
                                                  &quot;&#39;, &#39;&quot; + mwGrid.ClientID + &quot;&#39;, &#39;&quot; + QueryStringName + &quot;&#39;);&quot;;
                }
                if (toolBarArg.GetMenuReference(&quot;lnkOthers&quot;) != null)
                {
                    if (toolBarArg.GetMenuReference(&quot;lnkSettings&quot;) != null)
                        toolBarArg.GetMenuReference(&quot;lnkSettings&quot;).Enabled = permissions.Contains(&quot;Settings&quot;);
                }

                if (toolBarArg.GetMenuReference(&quot;lnkBack&quot;) != null)
                    toolBarArg.GetMenuReference(&quot;lnkBack&quot;).Click += lnkBack_Click;

                foreach (var row in MWGrid.GetRows(mwGrid))
                {
                    if (MWGrid.ColumnExists(row, &quot;IsFinal&quot;) &amp;&amp; MWGrid.GetCellValue(row, &quot;IsFinal&quot;).ToBoolean2())
                    {
                        if (toolBarArg.GetMenuReference(&quot;lnkNew&quot;) != null)
                            toolBarArg.GetMenuReference(&quot;lnkNew&quot;).Enabled = false;
                        break;
                    }
                }
            }
        }

        protected void lnkBack_Click(object sender, EventArgs e)
        {
            Response.Redirect(@&quot;~/Common/BrixListPage.aspx?Context=WORKORD&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ContractID=&quot; +
                              Request[&quot;ContractID&quot;] + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;]);
        }

        public override void SetUIDetails()
        {
            //Visible Coloumns
            ModifyColumnProperties(&quot;PAYESTM No.&quot;, false, 0, null, &quot;80&quot;, false);
            //if (string.IsNullOrEmpty(Request[&quot;WOID&quot;]))
            ModifyColumnProperties(&quot;Submitted&quot;, false, 1, null, &quot;100&quot;, false);
            ModifyColumnProperties(&quot;PELineNumber&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Status&quot;, false, 2, null, &quot;100&quot;, false);
            ModifyColumnProperties(&quot;CreatedOn&quot;, false, 3, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false);
            ModifyColumnProperties(&quot;CreatedBy&quot;, false, 4, null, null, false);
            ModifyColumnProperties(&quot;ApprovedOn&quot;, false, 5, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false);
            ModifyColumnProperties(&quot;RetP&quot;, false, 6, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, null, false, &quot;Hold %&quot;);
            ModifyColumnProperties(&quot;ApprovedBy&quot;, false, 7, null, null, false);
            ModifyColumnProperties(&quot;CostAmt&quot;, false, 8, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null, false);

            //Hidden Coloumns
            ModifyColumnProperties(&quot;ID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Multi&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;IsChange&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Approved&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Submitted&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;IsFinal&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RetReleaseDate&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RetPercentage&quot;, false, 6, AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, null, false, &quot;Retention %&quot;);
            //if (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]))
            //    ModifyColumnProperties(&quot;Submitted&quot;, true, null, null, null, false);

            //Show extra buttons
            displayApplyFilter = true;
            displayExport = true;
            displayReportsPE = true;

            if (Request != null)
            {
                islatest = (string.IsNullOrEmpty(Request[&quot;WOID&quot;]) || Request[&quot;WOID&quot;] == &quot;0&quot;)
                               ? true
                               : (Request[&quot;WOID&quot;].ToInt32_2() ==
                                  WOManager.Instance.GetLatestWorkOrderID(Request[&quot;WOID&quot;].ToInt32_2()));


                displaySettings = String.IsNullOrEmpty(Request[&quot;WOID&quot;]);
                displayBack = !displaySettings;
                EnableNew = EnableEdit = (BL.Instance.GetLockStatus(Request[&quot;ContractID&quot;].ToInt32_2()));
                displayApprove = displayUnApprove = false;

                header = string.IsNullOrEmpty(Request[&quot;woid&quot;])
                             ? PayEstimatesName + &quot; List&quot;
                             : &quot;Work Order - &quot; + PayEstimatesName + &quot; List&quot;;

                EnableNew = EnableEdit = (islatest &amp;&amp; EnableNew);
            }
            instanceIDColumn = &quot;Id&quot;;
            createDateColumn = &quot;CreatedOn&quot;;
        }

        protected override void SetModuleLevelPermissions(List&lt;string&gt; permissions)
        {
            //Button Visibility according to Permissions set here
            if (displayOtherDropMenu)
            {
                if (permissions.Contains(&quot;Settings&quot;)) displaySettings = true;
                else
                    displaySettings = false;
                if (displayExport &amp;&amp; !permissions.Contains(&quot;Export&quot;)) displayExport = false;
            }
        }

        public override BrixFilter[] GetApplyFilterLabels()
        {
            var filters = new BrixFilter[4];
            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Created By&quot;;
            filters[0].Name = &quot;CreatedBy&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Approved By&quot;;
            filters[1].Name = &quot;ApprovedBy&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            filters[2] = new BrixFilter();
            filters[2].Title = &quot;Contractor&quot;;
            filters[2].Name = &quot;Contact&quot;;
            filters[2].FilterType = BrixFilter.Type.Text;

            filters[3] = new BrixFilter();
            filters[3].Title = &quot;Status&quot;;
            filters[3].Name = &quot;IsApproved&quot;;
            filters[3].FilterType = BrixFilter.Type.Radio;
            filters[3].Values = new Dictionary&lt;string, string&gt;();
            filters[3].Values[&quot;Approved&quot;] = &quot;A&quot;;
            filters[3].Values[&quot;Submitted&quot;] = &quot;S&quot;;
            filters[3].Values[&quot;Draft&quot;] = &quot;D&quot;;
            filters[3].Values[&quot;Any&quot;] = null;

            return filters;
        }

        public override void HandleNew()
        {
            if (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp;
                !BL.Instance.ShouldModulebeEnabled(Request[&quot;woid&quot;].ToInt32_2(), &quot;WORKRAB&quot;))
            {
                throw new Exception(&quot;The amendment is in progress for the associated work order. Request denied.&quot;);
            }

            Response.Redirect(&quot;~/Modules/PAYESTM/CreateEstimate.aspx?PID=&quot; +
                              base.Request[Constants.QRY_PROJECTID].ToString2() + &quot;&amp;ContractID=&quot; +
                              base.Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;ParentID=&quot; + base.Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;ParentContext=CONTMGT&quot; +
                              (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                              (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
        }

        public override void HandleEdit()
        {
            string selPEId = GetSelectedItemFromGrid();
            if (!String.IsNullOrEmpty(selPEId))
            {
                //if (brixGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;IsChange&quot;).Text == &quot;N&quot; &amp;&amp;
                //    !string.IsNullOrEmpty(BrixWorkflowManager.Instance.IsWorkflowAssociated(FormName, Request.QueryString[&quot;ContractID&quot;])))
                //{
                //    throw new Exception(&quot;New &quot; + PayEstimateName + &quot;(s) for &#39;&quot; +
                //                        ((brixGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;Contractor&quot;) != null)
                //                             ? brixGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;Contractor&quot;).Text
                //                             : &quot;&quot;) + &quot;&#39; have already been generated. Cannot Edit the chosen &quot; +
                //                        PayEstimateName + &quot;.Request Denied&quot;);
                //}
                //else if (brixGrid.DisplayLayout.ActiveRow.Cells.FromKey(&quot;Approved&quot;).Text == &quot;Y&quot; &amp;&amp;
                //         !string.IsNullOrEmpty(BrixWorkflowManager.Instance.IsWorkflowAssociated(FormName, Request.QueryString[&quot;ContractID&quot;]))
                //    )
                //{
                //    throw new Exception(&quot;Cannot edit approved &quot; + PayEstimateName + &quot;. Request Denied&quot;);
                //}
                //else
                //{
                string isFinalKey = IsFinal ? &quot;&amp;IsF=1&quot; : string.Empty;
                Response.Redirect(&quot;~/Modules/PAYESTM/CreateEstimate.aspx?Mode=Edit&amp;PID=&quot; +
                                  Request[Constants.QRY_PROJECTID].ToString2() + &quot;&amp;ContractID=&quot; +
                                  Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;PEID=&quot; + selPEId + &quot;&amp;ParentContext=CONTMGT&quot; +
                                  isFinalKey +
                                  (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                                  (String.IsNullOrEmpty(Request[&quot;WOType&quot;])
                                       ? String.Empty
                                       : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
                //}
            }
        }

        public override void HandleView()
        {
            string selPEId = GetSelectedItemFromGrid();
            if (!String.IsNullOrEmpty(selPEId))
            {
                string isFinalKey = IsFinal ? &quot;&amp;IsF=1&quot; : string.Empty;
                Response.Redirect(&quot;~/Modules/PAYESTM/CreateEstimate.aspx?Mode=View&amp;PID=&quot; +
                                  Request[Constants.QRY_PROJECTID].ToString2() + &quot;&amp;ContractID=&quot; +
                                  Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;PEID=&quot; + selPEId + &quot;&amp;ParentContext=CONTMGT&quot; +
                                  isFinalKey +
                                  (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                                  (String.IsNullOrEmpty(Request[&quot;WOType&quot;])
                                       ? String.Empty
                                       : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
            }
        }

        public override int HandleDelete()
        {
            var dto = new DTOPE();

            string selPEId = GetSelectedItemFromGrid();
            selPEId = FilterIdsToDeleteBasedOnWFDefinitions(FormName, PID.ToString2(), Request.QueryString[&quot;ContractID&quot;], selPEId);
            try
            {
                if (!String.IsNullOrEmpty(selPEId))
                {
                    dto.IDs.Add(selPEId.ToInt32_2());
                }
                if (IsFinal)
                    throw new Exception(&quot;The record marked as Final cannot be deleted.&quot;);

                double amount = MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;CostAmt&quot;).ToDouble2();

                dto.CreatedBy = UserDetail.GetCurrentUserDetail().UID;
                CONTMGTPEBL.BL.Instance.CUDPE(Request[&quot;ContractID&quot;].ToString2().ToInt32_2(), PEOperations.Destroy, dto);
                ForceDeleteWorkflowsForThisForm(selPEId.TrimEnd(&#39;,&#39;), FormName);
            }
            catch (Exception ex)
            {
                throw ex;
                //lblError.Text = ex.Message;
            }

            return selPEId.ToInt32_2();
        }

        public override MenuHandlerStatus HandleApprove()
        {
            try
            {
                //this will be called by the EIS list model
                string errMsg = ApprovePE();


                if (!string.IsNullOrEmpty(errMsg)) throw new Exception(errMsg);


                if (IsFinal &amp;&amp; !String.IsNullOrEmpty(Request[&quot;WOID&quot;]) &amp;&amp; !String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                {
                    CloseOutWorkOrder(Request[&quot;WOID&quot;].ToInt32_2(), UserDetail.GetCurrentUserDetail().UID,
                                      UserDetail.GetCurrentUserDetail().UserName, Request[&quot;ContractID&quot;].ToInt32_2(),
                                      Request[&quot;WOType&quot;]);
                }
            }
            catch (Exception ex)
            {
                return MenuHandlerStatus.GetErrorObject(ex.Message.Replace(&quot;Pay Estimate&quot;, LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE)));
            }
            return MenuHandlerStatus.GetSuccessObject(string.Empty);
        }

        protected void CloseOutWorkOrder(int woid, int userId, string userName, int contractId, string woType)
        {
            int latestWOID = WOManager.Instance.GetLatestWorkOrderID(woid);
            if (woType.Equals(&quot;A&quot;))
                WOManager.Instance.CloseWorkOrder(latestWOID, userId, userName, DateTime.UtcNow, &quot;Closed&quot;, &quot;Y&quot;);
            else
                WORKORDManager.Instance.CloseWorkOrder(latestWOID, userId, userName, DateTime.UtcNow, &quot;Closed&quot;, &quot;Y&quot;);
            if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
            {
                WORKORDManager.Instance.HandleAXIntegrationforCloseOut(woid.ToString2(), contractId.ToString2());
            }
        }

        protected string ApprovePE()
        {
            try
            {
                var dto = new DTOPE();

                selPEId = GetSelectedItemFromGrid();
                if (!String.IsNullOrEmpty(selPEId))
                {
                    //TODO:Merge - new workflow
                    //if (!this.displayWorkFlow &amp;&amp; IsFinal)
                    if (IsFinal)
                    {
                        string retMsg = ValidatePEForFinal(selPEId.ToInt32_2());
                        if (!string.IsNullOrEmpty(retMsg)) throw new Exception(retMsg);
                    }
                    dto.IDs.Add(selPEId.ToInt32_2());
                }

                UserDetail currUser = UserDetail.GetCurrentUserDetail();
                dto.CreatedBy = currUser.UID;
                dto.CreatedOn = String.IsNullOrEmpty(ApproveDate) ? DateTime.UtcNow : Convert.ToDateTime(ApproveDate);
                CONTMGTPEBL.BL.Instance.CUDPE(Request[&quot;ContractID&quot;].ToString2().ToInt32_2(), PEOperations.Approve, dto);
            }
            catch (Exception ex)
            {
                return ex.Message.Replace(&quot;Pay Estimate&quot;, LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE));
            }

            #region TODO : BRIX-AX Integration

            //TODO: BRIX-AX Integration
            //if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
            //{
            //    int count = 0;
            //    string path = &quot;&quot;;
            //    path = (DocumentManager.Instance.StoragePath + &quot;PE_&quot; + ID.ToString2();
            //    //SaveOverViewPDF(ID, path);
            //    //SaveDetailPDF(ID, path);

            //    DataSet dsDate = BL.Instance.GetAllDetails(BrixDatatypeHelper.ToInt32_2(Request[&quot;ContractID&quot;].ToString2()), ID, &quot;OG&quot;);
            //    KeyValuePair&lt;string, object&gt;[] pageData =
            //        new KeyValuePair&lt;string, object&gt;[]
            //          { new KeyValuePair&lt;string,object&gt;(&quot;ContractId&quot;,BrixDatatypeHelper.ToInt32_2(Request[&quot;ContractId&quot;].ToString2())),
            //            new KeyValuePair&lt;string,object&gt;(&quot;Amount&quot;,amount),
            //            new KeyValuePair&lt;string,object&gt;(&quot;Date&quot;, dsDate.Tables[0]),
            //            new KeyValuePair&lt;string,object&gt;(&quot;PEID&quot;,ID),
            //            new KeyValuePair&lt;string,object&gt;(&quot;Path&quot;,path)};

            //    List&lt;ConnectionBrixInfo&gt; lstBrixInfo = new List&lt;ConnectionBrixInfo&gt;();
            //    lstBrixInfo.Add(new ConnectionBrixInfo(AMP3Object.CONTMGT, Request[&quot;ContractId&quot;].ToString2(),
            //                                            AMP3Object.UNKNOWN, null));

            //    ConnectorParameters connectorParameter = new ConnectorParameters(Session[Constants.EIS_ADDITIONAL_INFO].ToString2(), MethodInfo.GetCurrentMethod(), AMP3ObjectType.Unknown, null, lstBrixInfo);
            //    DataSet dsPE = EISPageDataManager.GetPageDataForPayEstimate(pageData);
            //    IntegrationConnectorManager.HandleIntegration(connectorParameter, ref count, ref dsPE, false);
            //}  

            #endregion

            return String.Empty;
        }

        public override string HandleMenuItem(string eventString)
        {
            if (eventString.Equals(&quot;Settings&quot;))
            {
                Response.Redirect(&quot;~/Modules/PAYESTM/Settings.aspx?PID=&quot; + Request[Constants.QRY_PROJECTID] +
                                  &quot;&amp;ContractID=&quot; + Request[&quot;ContractID&quot;] + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;], true);
            }
            else if (eventString.Equals(&quot;Undo Approve&quot;) || eventString.ToLower2().Equals(&quot;unapprove&quot;))
            //UnApprove eventstring is returned by reopen
            {
                try
                {
                    //TODO:Merge - new workflow
                    //if (!this.displayWorkFlow &amp;&amp; !string.IsNullOrEmpty(Request[&quot;WOID&quot;])
                    if (!string.IsNullOrEmpty(Request[&quot;WOID&quot;])
                        &amp;&amp; !BL.Instance.ShouldModulebeEnabled(Request[&quot;woid&quot;].ToInt32_2(), &quot;WORKRAB&quot;))
                    {
                        throw new Exception(
                            &quot;The amendment is in progress for the associated work order. Request denied.&quot;);
                    }
                    var dto = new DTOPE();
                    string selPEId = GetSelectedItemFromGrid();
                    if (!String.IsNullOrEmpty(selPEId))
                    {
                        //TODO:Merge - new workflow
                        // if (!this.displayWorkFlow &amp;&amp; IsFinal)
                        if (IsFinal)
                            throw new Exception(&quot;Final &quot; + PayEstimateName + &quot; approval cannot be reopened.&quot;);
                        dto.IDs.Add(selPEId.ToInt32_2());
                    }

                    dto.CreatedBy = UserDetail.GetCurrentUserDetail().UID;

                    CONTMGTPEBL.BL.Instance.CUDPE(Request[&quot;ContractID&quot;].ToString2().ToInt32_2(),
                                                  PEOperations.UnApprove, dto);
                }
                catch (Exception ex)
                {
                    throw ex;
                }
            }
            else if (eventString.Equals(PayEstimateName + &quot; Overview&quot;))
            {
                string selPEId = GetSelectedItemFromGrid();
                if (String.IsNullOrEmpty(selPEId))
                {
                    throw new Exception(&quot;Please select a &quot; + PayEstimateName + &quot;.&quot;);
                }

                Response.Redirect(
                    @&quot;~/Common/BrixReportPage.aspx?Context=OVERVIEW&amp;MODID=PAYESTM&amp;PID=&quot; +
                    Request[Constants.QRY_PROJECTID] + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;]
                    + &quot;&amp;PEID=&quot; + selPEId + &quot;&amp;ParentModuleID=CONTMGT&quot; +
                    (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? &quot;&amp;woid=&quot; + Request[&quot;WOID&quot;] : string.Empty) +
                    (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
            }
            else if (eventString.Equals(PayEstimateName + &quot; Detail&quot;))
            {
                string selPEId = GetSelectedItemFromGrid();
                if (String.IsNullOrEmpty(selPEId))
                {
                    throw new Exception(&quot;Please select a &quot; + PayEstimateName + &quot;.&quot;);
                }

                Response.Redirect(
                    @&quot;~/Common/BrixReportPage.aspx?Context=DETAILSBYCONT&amp;MODID=PAYESTM&amp;PID=&quot; +
                    Request[Constants.QRY_PROJECTID] + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;]
                    + &quot;&amp;PEID=&quot; + selPEId + &quot;&amp;ParentModuleID=CONTMGT&quot; +
                    (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? &quot;&amp;woid=&quot; + Request[&quot;WOID&quot;] : string.Empty) +
                    (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
            }
            else if (eventString.Equals(PayEstimateName + &quot; by &quot; + Group))
            {
                string selPEId = GetSelectedItemFromGrid();
                if (String.IsNullOrEmpty(selPEId))
                {
                    throw new Exception(&quot;Please select a &quot; + PayEstimateName + &quot;.&quot;);
                }

                Response.Redirect(
                    @&quot;~/Common/BrixReportPage.aspx?Context=DETAILSBYCONT&amp;MODID=PAYESTM&amp;Code=G&amp;PID=&quot; +
                    Request[Constants.QRY_PROJECTID] + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;]
                    + &quot;&amp;PEID=&quot; + selPEId + &quot;&amp;ParentModuleID=CONTMGT&quot; +
                    (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? &quot;&amp;woid=&quot; + Request[&quot;WOID&quot;] : string.Empty) +
                    (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
            }
            else if (eventString.Equals(&quot;Submit&quot;))
            {
                try
                {
                    string selPEId = GetSelectedItemFromGrid();
                    var dto = new DTOPE();
                    if (!String.IsNullOrEmpty(selPEId))
                    {
                        if (IsFinal)
                        {
                            string retMsg = ValidatePEForFinal(selPEId.ToInt32_2());
                            if (!string.IsNullOrEmpty(retMsg)) throw new Exception(retMsg);
                            Response.Redirect(&quot;~/Modules/PAYESTM/CreateEstimate.aspx?Mode=Edit&amp;PID=&quot; +
                                              Request[Constants.QRY_PROJECTID].ToString2() + &quot;&amp;ContractID=&quot; +
                                              Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;PEID=&quot; + selPEId +
                                              &quot;&amp;ParentContext=CONTMGT&amp;IsF=1&amp;IsSubmit=1&quot; +
                                              (String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                   ? String.Empty
                                                   : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                                              (String.IsNullOrEmpty(Request[&quot;WOType&quot;])
                                                   ? String.Empty
                                                   : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
                        }
                        else
                        {
                            dto.IDs.Add(selPEId.ToInt32_2());
                            CONTMGTPEBL.BL.Instance.CUDPE(Request[&quot;ContractID&quot;].ToString2().ToInt32_2(),
                                                          PEOperations.Submit, dto);
                        }
                        //dont know why this is written
                        //selPEId = GetSelectedItemFromGrid();
                    }
                }
                catch (Exception ex)
                {
                    return ex.Message.Replace(&quot;Pay Estimate&quot;,
                                              LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE));
                }
            }
            else if (eventString.Equals(&quot;Resource Consumption Report&quot;))
            {
                string selPEId = GetSelectedItemFromGrid();
                if (string.IsNullOrEmpty(selPEId) || selPEId.Split(&#39;,&#39;).Length != 1)
                    throw new Exception(&quot;Please select one record&quot;);

                string queryString = &quot;ModuleID=PAYESTM&amp;PID=&quot; + Request[Constants.QRY_PROJECTID].ToString2() + &quot;&amp;ContractID=&quot; + Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;].ToString2() +
                    &quot;&amp;Context=RESCONS&amp;ParentContext=PAYESTM&amp;PEID=&quot; + selPEId + (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                    (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]);
                Response.Redirect(&quot;~/Common/BrixListReportPage.aspx?&quot; + queryString, false);
            }
            else if (eventString.Equals(&quot;Final&quot;))
            {
                try
                {
                    selPEId = GetSelectedItemFromGrid();
                    if (String.IsNullOrEmpty(selPEId))
                        throw new Exception(&quot;Please select a &quot; + PayEstimateName + &quot;.&quot;);
                    if (IsFinal)
                        throw new Exception(&quot;The selected record is already marked as final. Request denied.&quot;);
                    if (MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Approved&quot;))
                        throw new Exception(&quot;The selected record is already approved. Request denied.&quot;);
                    string errorMsg = ValidatePEForFinal(selPEId.ToInt32_2());
                    if (string.IsNullOrEmpty(errorMsg))
                        HandleRequestForFinal(selPEId.ToInt32_2());
                    return errorMsg;
                }
                catch (Exception ex)
                {
                    return ex.Message;
                }
            }
            else if (eventString.Equals(&quot;Retention Release&quot;))
            {
                bool isFinalRABApproved = false;

                foreach (var row in MWGrid.GetRows(mwGrid))
                {
                    if (MWGrid.ColumnExists(row, &quot;IsFinal&quot;) &amp;&amp; MWGrid.GetCellValue(row, &quot;IsFinal&quot;).ToBoolean2() &amp;&amp;
                       MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Approved&quot;))
                    {
                        if (MWGrid.ColumnExists(row, &quot;RetReleaseDate&quot;) &amp;&amp;
                           MWGrid.GetCellValue(row, &quot;RetReleaseDate&quot;).ToDateTime_MWCulture().Date &gt; MWDateTimeHelper.MWToday)
                            return
                                &quot;Cannot create retention release before the retention release date mentioned in the final &quot; +
                                PayEstimateName + &quot;.&quot;;
                        isFinalRABApproved = true;
                        break;
                    }
                }
                if (isFinalRABApproved)
                    Response.Redirect(
                        string.Format(CultureInfo.CurrentCulture,
                                      &quot;~/Common/BrixListPage.aspx?context=RETNRLS&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID=0&quot;,
                                      Request[Constants.QRY_PROJECTID], Request[&quot;ContractID&quot;]), true);
                else
                    return &quot;There is no approved final &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot;. Request denied.&quot;;
            }
            else if (eventString.Equals(LocalizationManager.GetString(&quot;LOC_MeasurementBook&quot;)))
            {
                try
                {
                    string selPEID = GetSelectedItemFromGrid();
                    if (String.IsNullOrEmpty(selPEID))
                    {
                        throw new Exception(&quot;Please select a &quot; + PayEstimateName + &quot;.&quot;);
                    }

                    HandleSQLReport(&quot;MBOOKPT&quot;, selPEID);
                }
                catch (Exception ex)
                {
                    return ex.Message;
                }
            }
            else
            {
                return base.HandleMenuItem(eventString);
            }
            return String.Empty;
        }

        protected virtual string ValidatePEForFinal(int peId)
        {
            string errMessage = string.Empty;

            foreach (var row in MWGrid.GetRows(mwGrid))
            {
                if (row != MWGrid.GetSelectedRow(mwGrid) &amp;&amp;
                   MWGrid.ColumnExists(row, &quot;Status&quot;) &amp;&amp;
                    !MWGrid.GetCellValue(row, &quot;Status&quot;).ToString2().ToLower2().Equals(&quot;approved&quot;)
                    )
                {
                    return &quot;There already exists un approved record(s). Request denied.&quot;;
                }
            }
            errMessage = PayEstimateValidationManager.Instance.ValidateRABforFinal(peId,
                                                                                   !String.IsNullOrEmpty(Request[&quot;WOID&quot;]));
            DTO contractDTO = BL.Instance.GetContract(Request[&quot;ContractID&quot;].ToInt32_2(), FetchSet.Modules);
            string replaceStr = string.Empty;
            if (contractDTO.ContainsModule(&quot;CONTMOH&quot;))
                replaceStr = &quot;Prepayment(s)&quot;;
            if (contractDTO.ContainsModule(&quot;MONHAND&quot;))
                replaceStr = replaceStr + (string.IsNullOrEmpty(replaceStr) ? &quot;MOH(s)&quot; : &quot; | MOH(s)&quot;);
            return errMessage.Replace(&quot;PAYESTM&quot;, PayEstimateName).Replace(&quot;CONTMOH&quot;, replaceStr).Replace(&quot;LOC_ITEM&quot;,
                                                                                                         ItemNameAbbr);
        }

        private void HandleRequestForFinal(int peId)
        {
            Response.Redirect(&quot;~/Modules/PAYESTM/CreateEstimate.aspx?Mode=Edit&amp;PID=&quot; +
                             Request[Constants.QRY_PROJECTID].ToString2() + &quot;&amp;ContractID=&quot; +
                             Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;PEID=&quot; + selPEId + &quot;&amp;ParentContext=CONTMGT&amp;IsF=1&quot; +
                             (String.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? String.Empty : &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;]) +
                             (String.IsNullOrEmpty(Request[&quot;WOType&quot;]) ? String.Empty : &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;]), true);
        }

        private void ExportGridData(DataTable dt, string sheetName, Workbook book, UltraWebGrid grdTemp,
                                    UltraWebGridExcelExporter expGrid)
        {
            grdTemp.Rows.Clear();
            grdTemp.Columns.Clear();
            if (dt != null)
            {
                if (dt.Rows.Count == 0)
                {
                    dt.Rows.Add(dt.NewRow());
                }
                grdTemp.DataSource = dt;
                grdTemp.DataBind();
                ApplyGridLocalizationforExport(grdTemp);
            }
            book.Worksheets.Add(sheetName);
            expGrid.Export(grdTemp, book.Worksheets[sheetName]);
        }

        private void ApplyGridLocalizationforExport(UltraWebGrid grdTemp)
        {
            if (grdTemp.Columns.FromKey(&quot;Estimated Quantity&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Estimated Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            if (grdTemp.Columns.FromKey(&quot;Quantity&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            if (grdTemp.Columns.FromKey(&quot;Unit Price&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Unit Price&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            if (grdTemp.Columns.FromKey(&quot;Estimated Value&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Estimated Value&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            if (grdTemp.Columns.FromKey(&quot;Work Completed This Application - Quantity&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Work Completed This Application - Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            if (grdTemp.Columns.FromKey(&quot;Work Completed This Application - Value&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Work Completed This Application - Value&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            if (grdTemp.Columns.FromKey(&quot;Work Completed Previous - Quantity&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Work Completed Previous - Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            if (grdTemp.Columns.FromKey(&quot;Work Completed Previous - Value&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Work Completed Previous - Value&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            if (grdTemp.Columns.FromKey(&quot;Work Completed Total To Date - Quantity&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Work Completed Total To Date - Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            if (grdTemp.Columns.FromKey(&quot;Work Completed Total To Date - Value&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Work Completed Total To Date - Value&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            if (grdTemp.Columns.FromKey(&quot;Work Remaining - Quantity&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Work Remaining - Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            if (grdTemp.Columns.FromKey(&quot;Work Remaining - Value&quot;) != null)
                grdTemp.Columns.FromKey(&quot;Work Remaining - Value&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            if (grdTemp.Columns.FromKey(&quot;WorkOrderType&quot;) != null)
                grdTemp.Columns.FromKey(&quot;WorkOrderType&quot;).Hidden = true;
            if (grdTemp.Columns.FromKey(&quot;IsRFI&quot;) != null)
                grdTemp.Columns.FromKey(&quot;IsRFI&quot;).Hidden = true;
            if (grdTemp.Columns.FromKey(&quot;IsBaseVersion&quot;) != null)
                grdTemp.Columns.FromKey(&quot;IsBaseVersion&quot;).Hidden = true;
            if (grdTemp.Columns.FromKey(&quot;SubContractorSource&quot;) != null)
                grdTemp.Columns.FromKey(&quot;SubContractorSource&quot;).Hidden = true;
        }

        private void ModifyDataSetDetailsbyContainertoXLS(DataSet dsPayEstimateDetailsbyContainer)
        {
            #region Naming the Tables

            DataTable dtContract = dsPayEstimateDetailsbyContainer.Tables[&quot;Contract&quot;];
            DataTable dtContractBOQs = dsPayEstimateDetailsbyContainer.Tables[&quot;ContractBOQs&quot;];
            DataTable dtModifications = dsPayEstimateDetailsbyContainer.Tables[&quot;Modifications&quot;];
            DataTable dtContainerSummary = dsPayEstimateDetailsbyContainer.Tables[&quot;ContainerSummary&quot;];
            DataTable dtNCBOQs = dsPayEstimateDetailsbyContainer.Tables[&quot;NCBOQs&quot;];
            DataTable dtItemAddendums = dsPayEstimateDetailsbyContainer.Tables[&quot;ItemAddendums&quot;];

            #endregion

            int WOID = 0;
            if (dsPayEstimateDetailsbyContainer.Tables[0].Columns.Contains(&quot;WOID&quot;) &amp;&amp;
                dsPayEstimateDetailsbyContainer.Tables[0].Rows.Count &gt; 0)
                int.TryParse(dsPayEstimateDetailsbyContainer.Tables[0].Rows[0][&quot;WOID&quot;].ToString2(), out WOID);

            #region Calculating Remaining Work - All Required Tables

            if (!dtContractBOQs.Columns.Contains(&quot;RemQty&quot;))
                dtContractBOQs.Columns.Add(&quot;RemQty&quot;, Type.GetType(&quot;System.Double&quot;));
            if (!dtContractBOQs.Columns.Contains(&quot;RemAmt&quot;))
                dtContractBOQs.Columns.Add(&quot;RemAmt&quot;, Type.GetType(&quot;System.Double&quot;));

            foreach (DataRow drBOQ in dtContractBOQs.Rows)
            {
                drBOQ[&quot;RemQty&quot;] = drBOQ[&quot;Qty&quot;].ToString2().ToDouble2() - drBOQ[&quot;TotalPostedQty&quot;].ToString2().ToDouble2();
                drBOQ[&quot;RemAmt&quot;] = drBOQ[&quot;Amt&quot;].ToString2().ToDouble2() - drBOQ[&quot;TotalPostedAmt&quot;].ToString2().ToDouble2();
            }

            if (!dtContainerSummary.Columns.Contains(&quot;RemAmt&quot;))
                dtContainerSummary.Columns.Add(&quot;RemAmt&quot;, Type.GetType(&quot;System.Double&quot;));
            foreach (DataRow drContainer in dtContainerSummary.Rows)
                drContainer[&quot;RemAmt&quot;] = drContainer[&quot;Amt&quot;].ToString2().ToDouble2() -
                                        drContainer[&quot;TotalPostedAmt&quot;].ToString2().ToDouble2();

            if (!dtNCBOQs.Columns.Contains(&quot;RemQty&quot;)) dtNCBOQs.Columns.Add(&quot;RemQty&quot;, Type.GetType(&quot;System.Double&quot;));
            if (!dtNCBOQs.Columns.Contains(&quot;RemAmt&quot;)) dtNCBOQs.Columns.Add(&quot;RemAmt&quot;, Type.GetType(&quot;System.Double&quot;));

            foreach (DataRow dtNCBOQ in dtNCBOQs.Rows)
            {
                dtNCBOQ[&quot;RemQty&quot;] = dtNCBOQ[&quot;Qty&quot;].ToString2().ToDouble2() -
                                    dtNCBOQ[&quot;TotalPostedQty&quot;].ToString2().ToDouble2();
                dtNCBOQ[&quot;RemAmt&quot;] = dtNCBOQ[&quot;Amt&quot;].ToString2().ToDouble2() -
                                    dtNCBOQ[&quot;TotalPostedAmt&quot;].ToString2().ToDouble2();
            }


            if (!dtItemAddendums.Columns.Contains(&quot;RemQty&quot;))
                dtItemAddendums.Columns.Add(&quot;RemQty&quot;, Type.GetType(&quot;System.Double&quot;));
            if (!dtItemAddendums.Columns.Contains(&quot;RemAmt&quot;))
                dtItemAddendums.Columns.Add(&quot;RemAmt&quot;, Type.GetType(&quot;System.Double&quot;));

            foreach (DataRow dtAddendum in dtItemAddendums.Rows)
            {
                dtAddendum[&quot;RemQty&quot;] = dtAddendum[&quot;Quantity&quot;].ToString2().ToDouble2() -
                                       dtAddendum[&quot;TotalPostedQty&quot;].ToString2().ToDouble2();
                dtAddendum[&quot;RemAmt&quot;] = dtAddendum[&quot;Amt&quot;].ToString2().ToDouble2() -
                                       dtAddendum[&quot;TotalPostedAmt&quot;].ToString2().ToDouble2();
            }

            #endregion

            #region Generating new Table by merging Modification entries with BOQs and grouping by Containers

            DataTable dtTempBOQs = dtContractBOQs.Clone();
            foreach (DataRow drContainer in dtContainerSummary.Rows)
            {
                #region Adding the Container Heading

                DataRow drTempBOQ = dtTempBOQs.NewRow();
                drTempBOQ[&quot;Desc&quot;] = String.Empty;
                dtTempBOQs.Rows.Add(drTempBOQ);

                drTempBOQ = dtTempBOQs.NewRow();
                drTempBOQ[&quot;Desc&quot;] = drContainer[&quot;Path&quot;].ToString2();
                dtTempBOQs.Rows.Add(drTempBOQ);

                #endregion

                #region Adding all the BOQs under that Container

                DataRow[] ContractBOQRowColl = dtContractBOQs.Select(&quot;SectionID=&quot; + drContainer[&quot;SectionID&quot;].ToString2());
                foreach (DataRow drBOQ in ContractBOQRowColl)
                {
                    drTempBOQ = dtTempBOQs.NewRow();
                    drTempBOQ[&quot;Desc&quot;] = String.Empty;
                    dtTempBOQs.Rows.Add(drTempBOQ);

                    DataRow[] ModificationRowColl = dtModifications.Select(&quot;ItemID=&quot; + drBOQ[&quot;ItemID&quot;].ToString2());
                    if (ModificationRowColl.Length &gt; 0)
                    {
                        if (WOID == 0)
                        {
                            #region Adding the Original Line

                            drTempBOQ = dtTempBOQs.NewRow();
                            drTempBOQ[&quot;Desc&quot;] = drBOQ[&quot;Desc&quot;].ToString2();
                            double OrigQty = drBOQ[&quot;Qty&quot;].ToString2().ToDouble2();
                            foreach (DataRow drMod in ModificationRowColl)
                            {
                                double modQty = 0;
                                double.TryParse(drMod[&quot;Quantity&quot;].ToString2(), out modQty);
                                OrigQty -= modQty;
                            }
                            drTempBOQ[&quot;Qty&quot;] = OrigQty;
                            drTempBOQ[&quot;Unit&quot;] = drBOQ[&quot;Unit&quot;].ToString2();
                            drTempBOQ[&quot;UnitPrice&quot;] = drBOQ[&quot;UnitPrice&quot;];
                            drTempBOQ[&quot;Amt&quot;] = OrigQty * drBOQ[&quot;UnitPrice&quot;].ToString2().ToDouble2();
                            dtTempBOQs.Rows.Add(drTempBOQ);

                            #endregion
                        }

                        #region Adding all the modification lines

                        foreach (DataRow drMod in ModificationRowColl)
                        {
                            drTempBOQ = dtTempBOQs.NewRow();
                            drTempBOQ[&quot;Desc&quot;] = ((WOID == 0) ? &quot;CO Modification - &quot; : &quot;WO Amendment - &quot;) +
                                                drMod[&quot;CODesc&quot;].ToString2();
                            drTempBOQ[&quot;Qty&quot;] = drMod[&quot;Quantity&quot;];
                            drTempBOQ[&quot;Unit&quot;] = drMod[&quot;Unit&quot;].ToString2();
                            drTempBOQ[&quot;UnitPrice&quot;] = drMod[&quot;UnitPrice&quot;];
                            drTempBOQ[&quot;Amt&quot;] = drMod[&quot;Amt&quot;];

                            if (dtModifications.Columns.Contains(&quot;PostedQty&quot;))
                                drTempBOQ[&quot;PostedQty&quot;] = drMod[&quot;PostedQty&quot;];
                            if (dtModifications.Columns.Contains(&quot;PostedAmt&quot;))
                                drTempBOQ[&quot;PostedAmt&quot;] = drMod[&quot;PostedAmt&quot;];
                            if (dtModifications.Columns.Contains(&quot;PrevPostedQty&quot;))
                                drTempBOQ[&quot;PrevPostedQty&quot;] = drMod[&quot;PrevPostedQty&quot;];
                            if (dtModifications.Columns.Contains(&quot;PrevPostedAmt&quot;))
                                drTempBOQ[&quot;PrevPostedAmt&quot;] = drMod[&quot;PrevPostedAmt&quot;];
                            if (dtModifications.Columns.Contains(&quot;TotalPostedQty&quot;))
                                drTempBOQ[&quot;TotalPostedQty&quot;] = drMod[&quot;TotalPostedQty&quot;];
                            if (dtModifications.Columns.Contains(&quot;TotalPostedAmt&quot;))
                                drTempBOQ[&quot;TotalPostedAmt&quot;] = drMod[&quot;TotalPostedAmt&quot;];

                            dtTempBOQs.Rows.Add(drTempBOQ);
                        }

                        #endregion
                    }
                    dtTempBOQs.ImportRow(drBOQ);
                }

                #endregion
            }
            dtContractBOQs.TableName = &quot;Remove&quot;;
            dsPayEstimateDetailsbyContainer.Tables.Add(dtTempBOQs);
            dsPayEstimateDetailsbyContainer.Tables.Remove(dtContractBOQs);
            dtContractBOQs = dtTempBOQs;

            #endregion

            #region Adding Lengend row to Addendums tables

            if (dtItemAddendums.Columns.Contains(&quot;DELETED&quot;))
            {
                DataRow drAddendum = dtItemAddendums.NewRow();
                drAddendum[&quot;Description&quot;] = String.Empty;
                dtItemAddendums.Rows.Add(drAddendum);

                drAddendum = dtItemAddendums.NewRow();
                drAddendum[&quot;Description&quot;] = &quot;* - &quot; + ItemNameAbbr + &quot;(s) Removed from Work Order&quot;;
                dtItemAddendums.Rows.Add(drAddendum);
            }

            #endregion

            #region Renaming Columns

            if (dtContract.Columns.Contains(&quot;Name&quot;)) dtContract.Columns[&quot;Name&quot;].ColumnName = &quot;Project Name&quot;;
            if (dtContract.Columns.Contains(&quot;Code&quot;)) dtContract.Columns[&quot;Code&quot;].ColumnName = &quot;Project Code&quot;;
            if (dtContract.Columns.Contains(&quot;CCode&quot;)) dtContract.Columns[&quot;CCode&quot;].ColumnName = &quot;Contract Code&quot;;
            if (dtContract.Columns.Contains(&quot;FromDt&quot;)) dtContract.Columns[&quot;FromDt&quot;].ColumnName = &quot;Construction From&quot;;
            if (dtContract.Columns.Contains(&quot;ToDt&quot;)) dtContract.Columns[&quot;ToDt&quot;].ColumnName = &quot;Construction To&quot;;
            if (dtContract.Columns.Contains(&quot;CreatedOn&quot;)) dtContract.Columns[&quot;CreatedOn&quot;].ColumnName = &quot;Run Date&quot;;
            if (dtContract.Columns.Contains(&quot;ID_NUM&quot;)) dtContract.Columns[&quot;ID_NUM&quot;].ColumnName = &quot;Estimate Number&quot;;

            if (dtContractBOQs.Columns.Contains(&quot;Desc&quot;)) dtContractBOQs.Columns[&quot;Desc&quot;].ColumnName = &quot;Description&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;Path&quot;)) dtContractBOQs.Columns[&quot;Path&quot;].ColumnName = &quot;Container&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;Qty&quot;)) dtContractBOQs.Columns[&quot;Qty&quot;].ColumnName = &quot;Estimated Quantity&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;UnitPrice&quot;))
                dtContractBOQs.Columns[&quot;UnitPrice&quot;].ColumnName = &quot;Unit Price&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;Amt&quot;)) dtContractBOQs.Columns[&quot;Amt&quot;].ColumnName = &quot;Estimated Value&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;PostedQty&quot;))
                dtContractBOQs.Columns[&quot;PostedQty&quot;].ColumnName = &quot;Work Completed This Application - Quantity&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;PrevPostedQty&quot;))
                dtContractBOQs.Columns[&quot;PrevPostedQty&quot;].ColumnName = &quot;Work Completed Previous - Quantity&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;TotalPostedQty&quot;))
                dtContractBOQs.Columns[&quot;TotalPostedQty&quot;].ColumnName = &quot;Work Completed Total To Date - Quantity&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;PostedAmt&quot;))
                dtContractBOQs.Columns[&quot;PostedAmt&quot;].ColumnName = &quot;Work Completed This Application - Value&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;PrevPostedAmt&quot;))
                dtContractBOQs.Columns[&quot;PrevPostedAmt&quot;].ColumnName = &quot;Work Completed Previous - Value&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;TotalPostedAmt&quot;))
                dtContractBOQs.Columns[&quot;TotalPostedAmt&quot;].ColumnName = &quot;Work Completed Total To Date - Value&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;RemQty&quot;))
                dtContractBOQs.Columns[&quot;RemQty&quot;].ColumnName = &quot;Work Remaining - Quantity&quot;;
            if (dtContractBOQs.Columns.Contains(&quot;RemAmt&quot;))
                dtContractBOQs.Columns[&quot;RemAmt&quot;].ColumnName = &quot;Work Remaining - Value&quot;;

            if (dtContainerSummary.Columns.Contains(&quot;Path&quot;))
                dtContainerSummary.Columns[&quot;Path&quot;].ColumnName = &quot;Container&quot;;
            if (dtContainerSummary.Columns.Contains(&quot;Amt&quot;))
                dtContainerSummary.Columns[&quot;Amt&quot;].ColumnName = &quot;Estimated Value&quot;;
            if (dtContainerSummary.Columns.Contains(&quot;PostedAmt&quot;))
                dtContainerSummary.Columns[&quot;PostedAmt&quot;].ColumnName = &quot;Work Completed This Application - Value&quot;;
            if (dtContainerSummary.Columns.Contains(&quot;PrevPostedAmt&quot;))
                dtContainerSummary.Columns[&quot;PrevPostedAmt&quot;].ColumnName = &quot;Work Completed Previous - Value&quot;;
            if (dtContainerSummary.Columns.Contains(&quot;TotalPostedAmt&quot;))
                dtContainerSummary.Columns[&quot;TotalPostedAmt&quot;].ColumnName = &quot;Work Completed Total To Date - Value&quot;;
            if (dtContainerSummary.Columns.Contains(&quot;RemAmt&quot;))
                dtContainerSummary.Columns[&quot;RemAmt&quot;].ColumnName = &quot;Work Remaining - Value&quot;;

            if (dtNCBOQs.Columns.Contains(&quot;Qty&quot;)) dtNCBOQs.Columns[&quot;Qty&quot;].ColumnName = &quot;Estimated Quantity&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;UnitPrice&quot;)) dtNCBOQs.Columns[&quot;UnitPrice&quot;].ColumnName = &quot;Unit Price&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;Amt&quot;)) dtNCBOQs.Columns[&quot;Amt&quot;].ColumnName = &quot;Estimated Value&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;PostedQty&quot;))
                dtNCBOQs.Columns[&quot;PostedQty&quot;].ColumnName = &quot;Work Completed This Application - Quantity&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;PrevPostedQty&quot;))
                dtNCBOQs.Columns[&quot;PrevPostedQty&quot;].ColumnName = &quot;Work Completed Previous - Quantity&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;TotalPostedQty&quot;))
                dtNCBOQs.Columns[&quot;TotalPostedQty&quot;].ColumnName = &quot;Work Completed Total To Date - Quantity&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;PostedAmt&quot;))
                dtNCBOQs.Columns[&quot;PostedAmt&quot;].ColumnName = &quot;Work Completed This Application - Value&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;PrevPostedAmt&quot;))
                dtNCBOQs.Columns[&quot;PrevPostedAmt&quot;].ColumnName = &quot;Work Completed Previous - Value&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;TotalPostedAmt&quot;))
                dtNCBOQs.Columns[&quot;TotalPostedAmt&quot;].ColumnName = &quot;Work Completed Total To Date - Value&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;RemQty&quot;))
                dtNCBOQs.Columns[&quot;RemQty&quot;].ColumnName = &quot;Work Remaining - Quantity&quot;;
            if (dtNCBOQs.Columns.Contains(&quot;RemAmt&quot;)) dtNCBOQs.Columns[&quot;RemAmt&quot;].ColumnName = &quot;Work Remaining - Value&quot;;

            if (dtItemAddendums.Columns.Contains(&quot;Quantity&quot;))
                dtItemAddendums.Columns[&quot;Quantity&quot;].ColumnName = &quot;Estimated Quantity&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;UnitPrice&quot;))
                dtItemAddendums.Columns[&quot;UnitPrice&quot;].ColumnName = &quot;Unit Price&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;Amt&quot;)) dtItemAddendums.Columns[&quot;Amt&quot;].ColumnName = &quot;Estimated Value&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;PostedQty&quot;))
                dtItemAddendums.Columns[&quot;PostedQty&quot;].ColumnName = &quot;Work Completed This Application - Quantity&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;PrevPostedQty&quot;))
                dtItemAddendums.Columns[&quot;PrevPostedQty&quot;].ColumnName = &quot;Work Completed Previous - Quantity&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;TotalPostedQty&quot;))
                dtItemAddendums.Columns[&quot;TotalPostedQty&quot;].ColumnName = &quot;Work Completed Total To Date - Quantity&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;PostedAmt&quot;))
                dtItemAddendums.Columns[&quot;PostedAmt&quot;].ColumnName = &quot;Work Completed This Application - Value&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;PrevPostedAmt&quot;))
                dtItemAddendums.Columns[&quot;PrevPostedAmt&quot;].ColumnName = &quot;Work Completed Previous - Value&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;TotalPostedAmt&quot;))
                dtItemAddendums.Columns[&quot;TotalPostedAmt&quot;].ColumnName = &quot;Work Completed Total To Date - Value&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;RemQty&quot;))
                dtItemAddendums.Columns[&quot;RemQty&quot;].ColumnName = &quot;Work Remaining - Quantity&quot;;
            if (dtItemAddendums.Columns.Contains(&quot;RemAmt&quot;))
                dtItemAddendums.Columns[&quot;RemAmt&quot;].ColumnName = &quot;Work Remaining - Value&quot;;

            #endregion

            #region Removing unwanted columns from each table

            if (dtContract.Columns.Contains(&quot;WOID&quot;)) dtContract.Columns.Remove(&quot;WOID&quot;);

            if (dtContractBOQs.Columns.Contains(&quot;GrpID&quot;)) dtContractBOQs.Columns.Remove(&quot;GrpID&quot;);
            if (dtContractBOQs.Columns.Contains(&quot;GroupName&quot;)) dtContractBOQs.Columns.Remove(&quot;GroupName&quot;);
            if (dtContractBOQs.Columns.Contains(&quot;SectionID&quot;)) dtContractBOQs.Columns.Remove(&quot;SectionID&quot;);
            if (dtContractBOQs.Columns.Contains(&quot;ItemID&quot;)) dtContractBOQs.Columns.Remove(&quot;ItemID&quot;);
            if (dtContractBOQs.Columns.Contains(&quot;Section&quot;)) dtContractBOQs.Columns.Remove(&quot;Section&quot;);

            if (dtModifications.Columns.Contains(&quot;ParentInstanceID&quot;))
                dtModifications.Columns.Remove(&quot;ParentInstanceID&quot;);

            if (dtContainerSummary.Columns.Contains(&quot;SectionID&quot;)) dtContainerSummary.Columns.Remove(&quot;SectionID&quot;);
            if (dtContainerSummary.Columns.Contains(&quot;Section&quot;)) dtContainerSummary.Columns.Remove(&quot;Section&quot;);

            if (dtNCBOQs.Columns.Contains(&quot;GrpID&quot;)) dtNCBOQs.Columns.Remove(&quot;GrpID&quot;);
            if (dtNCBOQs.Columns.Contains(&quot;GroupName&quot;)) dtNCBOQs.Columns.Remove(&quot;GroupName&quot;);
            if (dtNCBOQs.Columns.Contains(&quot;SectionID&quot;)) dtNCBOQs.Columns.Remove(&quot;SectionID&quot;);
            if (dtNCBOQs.Columns.Contains(&quot;ItemID&quot;)) dtNCBOQs.Columns.Remove(&quot;ItemID&quot;);

            if (dtItemAddendums.Columns.Contains(&quot;DELETED&quot;)) dtItemAddendums.Columns.Remove(&quot;DELETED&quot;);

            #endregion

            #region Adding atleast one row and Column to each table

            foreach (DataTable dt in dsPayEstimateDetailsbyContainer.Tables)
            {
                if (dt.Rows.Count &lt; 1)
                    dt.Rows.Add(dt.NewRow());
            }

            #endregion
        }

        public override string HandleMenuItems(string eventString,
                                               UltraWebGridExcelExporter UltraWebGridExcelExporter1, string filter = &quot;&quot;)
        {
            string error = String.Empty;
            switch (eventString)
            {
                case &quot;Excel Export (xls)&quot;:
                case &quot;Excel Export (xlsx)&quot;:
                    string selPEId = GetSelectedItemFromGrid();
                    if (String.IsNullOrEmpty(selPEId))
                    {
                        error = &quot;Please select a &quot; + PayEstimateName + &quot;.&quot;;
                        break;
                    }
                    try
                    {
                        int peID = 0;
                        int.TryParse(selPEId, out peID);

                        DataSet dsPEContainers =
                            ComponentHelper.Instance.ExecuteDataSet(PayEstimateStoredProcedure.usp_CONTMGTGetPE, null,
                                                                    Request[&quot;ContractID&quot;].ToInt32_2(),
                                                                    null, null, null, null, null, peID, null, &quot;O&quot;);

                        if (dsPEContainers == null || dsPEContainers.Tables == null || dsPEContainers.Tables.Count &lt; 1)
                            break;


                        if (dsPEContainers.Tables.Count &lt;= 7 || dsPEContainers.Tables[0].Columns.Count == 1)
                            break; //PE has been deleted


                        int WOID = 0;
                        if (dsPEContainers.Tables[0].Columns.Contains(&quot;WOID&quot;) &amp;&amp; dsPEContainers.Tables[0].Rows.Count &gt; 0)
                            int.TryParse(dsPEContainers.Tables[0].Rows[0][&quot;WOID&quot;].ToString2(), out WOID);

                        //var grid = new UltraWebGrid(&quot;grd_Temp&quot;);
                        //UltraWebGridExcelExporter1.DownloadName = &quot;Contract_&quot; + Request[&quot;ContractID&quot;].ToString2() + &quot;_&quot; +
                        //                                          PayEstimateName + &quot;_&quot; + selPEId + &quot;.XLS&quot;;
                        //var book = new Workbook();
                        ModifyDataSetDetailsbyContainertoXLS(dsPEContainers);
                        #region Naming the Tables

                        dsPEContainers.DataSetName = &quot;Contract_&quot; + Request[&quot;ContractID&quot;].ToString2() + &quot;_&quot; +
                                                                  PayEstimateName + &quot;_&quot; + selPEId;

                        dsPEContainers.Tables[0].TableName = &quot;Contract Details&quot;;
                        dsPEContainers.Tables[1].TableName = (WOID == 0)
                                           ? &quot;Contract &quot; + ItemNameAbbr + &quot;s&quot;
                                           : &quot;Work Order &quot; + ItemNameAbbr + &quot;s&quot;;
                        dsPEContainers.Tables[2].TableName = &quot;Modifications&quot;;
                        dsPEContainers.Tables[3].TableName = &quot;Container Summary&quot;;
                        dsPEContainers.Tables[4].TableName = &quot;NCBOQs&quot;;
                        dsPEContainers.Tables[5].TableName = (WOID == 0)
                                           ? &quot;Newly Added &quot; + ItemNameAbbr + &quot;s through CO&quot;
                                           : ItemNameAbbr + &quot;s Added/Removed from WO&quot;;


                        if (WOID != 0)
                        {
                            dsPEContainers.Tables.Remove(&quot;NCBOQs&quot;);
                        }
                        else
                        {
                            dsPEContainers.Tables[4].TableName = &quot;Non Contract&quot;;
                        }

                        ExcelExportEntity excelExportEntity = new ExcelExportEntity(dsPEContainers);
                        ExcelHelper.ExportToExcel(eventString, excelExportEntity);


                        //DataTable dtContract = dsPEContainers.Tables[&quot;Contract&quot;];
                        //DataTable dtContractBOQs = dsPEContainers.Tables[&quot;ContractBOQs&quot;];
                        //DataTable dtModifications = dsPEContainers.Tables[&quot;Modifications&quot;];
                        //DataTable dtContainerSummary = dsPEContainers.Tables[&quot;ContainerSummary&quot;];
                        //DataTable dtNCBOQs = dsPEContainers.Tables[&quot;NCBOQs&quot;];
                        //DataTable dtItemAddendums = dsPEContainers.Tables[&quot;ItemAddendums&quot;];

                        #endregion

                        //ModifyDataSetDetailsbyContainertoXLS(dsPEContainers);

                        //ExportGridData(dtContract, &quot;Contract Details&quot;, book, grid, UltraWebGridExcelExporter1);
                        //ExportGridData(dsPEContainers.Tables[&quot;ContractBOQs&quot;],
                        //               (WOID == 0)
                        //                   ? &quot;Contract &quot; + ItemNameAbbr + &quot;s&quot;
                        //                   : &quot;Work Order &quot; + ItemNameAbbr + &quot;s&quot;, book, grid, UltraWebGridExcelExporter1);
                        //ExportGridData(dtContainerSummary, &quot;Container Summary&quot;, book, grid, UltraWebGridExcelExporter1);
                        //if (WOID == 0)
                        //    ExportGridData(dtNCBOQs, &quot;Non Contract &quot; + ItemNameAbbr + &quot;s&quot;, book, grid,
                        //                   UltraWebGridExcelExporter1);
                        //ExportGridData(dtItemAddendums,
                        //               (WOID == 0)
                        //                   ? &quot;Newly Added &quot; + ItemNameAbbr + &quot;s through CO&quot;
                        //                   : ItemNameAbbr + &quot;s Added/Removed from WO&quot;, book, grid,
                        //               UltraWebGridExcelExporter1);
                    }
                    catch (Exception ex)
                    {
                        error = ex.Message.Replace(&quot;Pay Estimate&quot;,
                                                   LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE));
                    }
                    break;
                default:
                    error = HandleMenuItem(eventString);
                    break;
            }
            return error;
        }

        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int CurrentPage,
                                        out int count)
        {
            #region Override SortOrder for Image Cols

            sortOrder = string.IsNullOrEmpty(sortOrder) ? DefaultSortColumn + &quot; ASC&quot; : sortOrder;
            //sortOrder = DefaultSortColumn + &quot; DESC&quot;;

            if (!string.IsNullOrEmpty(sortOrder) &amp;&amp; sortOrder.Contains(&quot;img_&quot;))
                sortOrder = sortOrder.Replace(&quot;img_&quot;, string.Empty);

            #endregion

            if (String.IsNullOrEmpty(Request[Constants.QRY_PROJECTID]))
                Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;, true);
            else if (String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID],
                                  true);
            DataTable dtPEMaster = CONTMGTPEBL.BL.Instance.GetPE(base.Request[&quot;ContractID&quot;].ToString2().ToInt32_2(),
                                                                 (1 +
                                                                  (pageSize * (CurrentPage == 0 ? 0 : CurrentPage - 1))),
                                                                 pageSize, sortOrder, filter, null,
                                                                 String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                                     ? (int?)null
                                                                     : int.Parse(Request[&quot;WOID&quot;]));
            int rowCount = CONTMGTPEBL.BL.Instance.GetPECount(base.Request[&quot;ContractID&quot;].ToInt32_2(), filter,
                                                              String.IsNullOrEmpty(Request[&quot;WOID&quot;])
                                                                  ? (int?)null
                                                                  : int.Parse(Request[&quot;WOID&quot;]));
            if ((rowCount % pageSize) == 0)
                count = rowCount / pageSize;
            else
                count = rowCount / pageSize + 1;

            if (count == 0) CurrentPage = 0;

            //Modified the below piece of code so that it will be called in an instance where AX is associated with the build
            //The below method was adding Prepayment and MOH payments to cost amount(which was coming from db as net bill value exculding the advance payments),
            //which is correct in an AX attached build.

            //Now the code has been modified in such a way that this will be called only when AX is attached and that too to remove the 
            //payments made against advance from the net bill value.
            if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
            {
                foreach (DataRow row in dtPEMaster.Rows)
                {
                    row[&quot;costAmt&quot;] = CONTMGTPEBL.BL.Instance.CalculateTotalAmount(row[&quot;ID&quot;].ToInt32_2(),
                                                                                  row[&quot;costAmt&quot;].ToDecimal2());
                }
            }

            return dtPEMaster.DataSet;
        }

        public override bool PerformServerValidation(string key)
        {
            var selectedRow = MWGrid.GetSelectedRow(mwGrid);

            if (selectedRow != null)
            {
                if (key.Equals(&quot;Approve&quot;) &amp;&amp; MWGrid.GetCellValue(selectedRow, &quot;Status&quot;).Equals(&quot;Approved&quot;))
                    throw new Exception(&quot;The selected &quot; + PayEstimateName + &quot; is already approved.&quot;);
                else if (key.Equals(&quot;Approve&quot;) &amp;&amp; !MWGrid.GetCellValue(selectedRow, &quot;Status&quot;).Equals(&quot;Submitted&quot;))
                    throw new Exception(&quot;The selected &quot; + PayEstimateName + &quot; should be submitted before approval.&quot;);
                selPEId = GetSelectedItemFromGrid();
                if (IsFinal &amp;&amp; !string.IsNullOrEmpty(selPEId))
                {
                    if (key.ToLower2().Equals(&quot;approve&quot;))
                    {
                        string retMsg = ValidatePEForFinal(selPEId.ToInt32_2());
                        if (!string.IsNullOrEmpty(retMsg)) throw new Exception(retMsg);
                    }
                    else if (key.ToLower2().Equals(&quot;reopen&quot;))
                        throw new Exception(&quot;Final &quot; + PayEstimateName + &quot; approval cannot be reopened.&quot;);
                }

                object isRFI = ComponentHelper.Instance.ExecuteScalar(PayEstimateStoredProcedure.usp_PAYESTMGetIsRFIFromPE, null, selPEId);

                if (!string.IsNullOrEmpty(selPEId) &amp;&amp; key.Equals(&quot;Approve&quot;) &amp;&amp; isRFI == null
                        ? false
                        : Convert.ToBoolean(isRFI))
                {
                    DataSet ds =
                        ComponentHelper.Instance.ExecuteDataSet(PayEstimateStoredProcedure.usp_PAYESTMGetRFIDetailsOfPE, null, selPEId);
                    if (ds != null &amp;&amp; ds.Tables[0].Rows.Count &gt; 0)
                        throw new Exception(LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) +
                                            &quot; included one or more &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot;(s) that is not approved / rejected. All the &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot;(s) included in this &quot; +
                                            LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) +
                                            &quot; need to be approved / rejected first. Cannot Approve the chosen &quot; +
                                            LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) +
                                            &quot;. Request Denied.&quot;);
                }
                if (key.ToLower2().Equals(&quot;reopen&quot;) &amp;&amp; !MWGrid.GetCellValue(selectedRow, &quot;Status&quot;).Equals(&quot;Approved&quot;))
                    throw new Exception(&quot;Only an approved &quot; + PayEstimateName + &quot; can be reopened.&quot;);

                if (key.ToLower2().Equals(&quot;reopen&quot;) &amp;&amp; !string.IsNullOrEmpty(Request[&quot;WOID&quot;])
                    &amp;&amp; !BL.Instance.ShouldModulebeEnabled(Request[&quot;woid&quot;].ToInt32_2(), &quot;WORKRAB&quot;))
                {
                    throw new Exception(&quot;The amendment is in progress for the associated work order. Request denied.&quot;);
                }
                //TODO
                //if (key.Equals(&quot;Approve&quot;) &amp;&amp; selectedRow.Cells.FromKey(&quot;Status&quot;).Equals(&quot;Submitted&quot;))
                //{
                //    //Do validations before approval
                //}
                //if (key.Equals(&quot;Reopen&quot;) &amp;&amp; selectedRow.Cells.FromKey(&quot;Status&quot;).Equals(&quot;Approved&quot;))
                //{
                //    //Do validations before unapproval
                //}
            }

            return true;
        }

        public override void HandleGridRowInitialization&lt;T&gt;(object sender, T row)
        {
            if (row is GridDataItem &amp;&amp; MWGrid.ColumnExists(row, &quot;IsFinal&quot;) &amp;&amp; MWGrid.GetCellValue(row, &quot;IsFinal&quot;).ToBoolean2())
                MWGrid.SetRowBackColor(row, Color.LightGray);
        }

        protected void HandleSQLReport(string context, string PEID)
        {
            //if (retDic.ContainsKey(&quot;Result&quot;) &amp;&amp; Int32.TryParse(retDic[&quot;Result&quot;].ToString2(), out retVal) &amp;&amp; (reportDS.Tables[0].Select(&quot;Context=&#39;&quot; + context + &quot;&#39;&quot;).Length &gt; 0))
            //{
            //    if (retVal &gt;= 0)
            //    {
            //DataRow reportList = reportDS.Tables[0].Select(&quot;Context=&#39;&quot; + context + &quot;&#39;&quot;)[0];
            //ReportDetails report = new ReportDetails(reportList);
            //System.Web.HttpContext.Current.Session.Add(&quot;reportDTO&quot;, report);
            string queryString = &quot;Context=MBOOKPT&amp;&amp;PID=&quot; + Request[Constants.QRY_PROJECTID].ToString2() + &quot;&amp;ContractID=&quot; +
                                 Request[&quot;ContractID&quot;].ToString2() + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;].ToString2()
                                 + &quot;&amp;PEID=&quot; + PEID + &quot;&amp;WOID=&quot; + Request[&quot;WOID&quot;] + &quot;&amp;WOType=&quot; + Request[&quot;WOType&quot;] +
                                 &quot;&amp;ItemName=&quot; + ItemNameAbbr + &quot;&amp;PayEstimateName=&quot; + PayEstimateName +
                                 &quot;&amp;ModuleID=CONTMBO&quot;;
            Response.Redirect(&quot;~/Common/BrixListReportPage.aspx?&quot; + queryString, true);
            //}
            //}    
        }

        public override string GetEditPageURL(string pID, string parentID, string instanceID, string context)
        {
            //string query = string.Format(&quot;select ISNULL(WOID,0) from CONTMGTPEMaster WHERE ID={0}&quot;, instanceID);
            // object objWOID = ComponentHelper.Instance.ExecuteScalar(query);
            object objWOID = ComponentHelper.Instance.ExecuteScalar(WOStoredProcedure.usp_WORKORDCheckIFWOIDIsNULL, null, instanceID);

            string url = string.Format(&quot;~/Modules/PAYESTM/CreateEstimate.aspx?Mode=Edit&amp;ParentContext=CONTMGT&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;PEID={2}&quot;,
                    pID, parentID, instanceID);
            int woid = 0;
            if (objWOID != null &amp;&amp; int.TryParse(objWOID.ToString(), out woid) &amp;&amp; woid &gt; 0)
            {
                url += &quot;&amp;WOID=&quot; + woid;
                // query = string.Format(&quot;select ISNULL(WorkOrderType,&#39;&#39;) from WORKORDMain WHERE WorkOrderID={0}&quot;, woid);
                //object objType = ComponentHelper.Instance.ExecuteScalar(query);
                object objType = ComponentHelper.Instance.ExecuteScalar(WOStoredProcedure.usp_WORKORDCheckIFWorkOrderTypeIsNULL, null, woid);
                if (objType != null &amp;&amp; !string.IsNullOrEmpty(objType.ToString()))
                    url += &quot;&amp;WOType=&quot; + objType.ToString();
            }
            return url;
        }

        public override string GetViewPageURL(string pID, string parentID, string instanceID, string context)
        {
            //string query = string.Format(&quot;select ISNULL(WOID,0) from CONTMGTPEMaster WHERE ID={0}&quot;, instanceID);
            // object objWOID = ComponentHelper.Instance.ExecuteScalar(query);
            object objWOID = ComponentHelper.Instance.ExecuteScalar(WOStoredProcedure.usp_WORKORDCheckIFWOIDIsNULL, null, instanceID);

            string url = string.Format(&quot;~/Modules/PAYESTM/CreateEstimate.aspx?Mode=View&amp;ParentContext=CONTMGT&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;PEID={2}&quot;,
                    pID, parentID, instanceID);
            int woid = 0;
            if (objWOID != null &amp;&amp; int.TryParse(objWOID.ToString(), out woid) &amp;&amp; woid &gt; 0)
            {
                url += &quot;&amp;WOID=&quot; + woid;
                // query = string.Format(&quot;select ISNULL(WorkOrderType,&#39;&#39;) from WORKORDMain WHERE WorkOrderID={0}&quot;, woid);
                //object objType = ComponentHelper.Instance.ExecuteScalar(query);
                object objType = ComponentHelper.Instance.ExecuteScalar(WOStoredProcedure.usp_WORKORDCheckIFWorkOrderTypeIsNULL, null, woid);
                if (objType != null &amp;&amp; !string.IsNullOrEmpty(objType.ToString()))
                    url += &quot;&amp;WOType=&quot; + objType.ToString();
            }
            return url;
        }

        public override bool HasAttachments { get { return true; } }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,95,0],[35,9,35,36,0],[39,17,39,18,0],[39,19,39,31,0],[39,32,39,33,0],[44,17,44,18,0],[44,19,44,36,0],[44,37,44,38,0],[49,17,49,18,0],[49,19,49,32,0],[49,33,49,34,0],[55,13,55,14,0],[56,17,58,100,0],[59,13,59,14,0],[65,13,65,14,0],[66,17,66,62,0],[68,17,68,62,0],[68,62,68,86,0],[68,86,68,88,0],[68,17,68,88,0],[69,17,69,40,0],[70,17,70,18,0],[71,21,71,62,0],[72,21,72,48,0],[73,17,73,18,0],[74,17,74,37,0],[75,17,75,18,0],[76,21,76,104,0],[77,17,77,18,0],[78,17,78,109,0],[79,17,79,59,0],[80,21,80,66,0],[81,25,82,89,0],[83,17,83,82,0],[83,82,83,105,0],[83,105,83,107,0],[83,17,83,107,0],[84,17,84,42,0],[85,17,85,18,0],[86,21,86,101,0],[88,17,88,18,0],[89,17,89,67,0],[90,17,90,38,0],[91,17,91,18,0],[92,21,92,129,0],[94,21,94,127,0],[96,21,96,130,0],[97,17,97,18,0],[98,17,98,60,0],[99,17,99,18,0],[100,21,103,68,0],[104,21,104,59,0],[105,25,105,157,0],[106,17,106,18,0],[107,17,107,47,0],[108,17,108,18,0],[109,21,109,59,0],[110,17,110,18,0],[111,22,111,38,0],[112,21,112,54,0],[113,17,113,65,0],[114,17,114,18,0],[115,21,115,94,0],[116,17,116,18,0],[119,17,119,35,0],[120,13,120,14,0],[126,13,126,14,0],[127,17,127,42,0],[130,17,130,28,0],[130,30,130,35,0],[131,17,131,24,0],[131,26,131,40,0],[131,41,131,43,0],[131,44,131,45,0],[132,17,132,18,0],[133,21,133,77,0],[134,25,134,37,0],[135,26,135,99,0],[136,21,136,22,0],[137,25,137,117,0],[138,25,138,70,0],[139,29,140,82,0],[141,21,141,22,0],[142,26,142,101,0],[143,21,143,22,0],[144,25,147,68,0],[148,25,148,63,0],[149,29,149,157,0],[150,21,150,22,0],[151,21,151,27,0],[152,17,152,18,0],[155,17,155,86,0],[156,17,156,18,0],[157,21,157,113,0],[158,21,158,69,0],[159,25,159,112,0],[160,17,160,18,0],[162,17,162,26,0],[163,13,163,14,0],[169,13,169,14,0],[170,17,170,52,0],[172,17,172,48,0],[173,17,173,49,0],[174,17,174,49,0],[175,17,175,34,0],[177,17,177,44,0],[178,17,178,49,0],[179,17,179,52,0],[180,17,180,34,0],[182,17,182,44,0],[183,17,183,47,0],[184,17,184,57,0],[185,17,185,34,0],[187,17,187,39,0],[188,13,188,14,0],[195,17,195,18,0],[195,19,195,36,0],[195,37,195,38,0],[200,17,200,18,0],[200,19,200,28,0],[200,29,200,30,0],[205,17,205,18,0],[205,19,205,31,0],[205,32,205,33,0],[210,17,210,18,0],[210,19,210,28,0],[210,29,210,30,0],[219,17,219,18,0],[219,19,219,32,0],[219,33,219,34,0],[224,17,224,18,0],[224,19,224,39,0],[224,40,224,41,0],[230,9,230,10,0],[231,13,231,56,0],[232,13,232,82,0],[233,13,233,14,0],[234,17,234,109,0],[236,17,236,70,0],[237,17,237,18,0],[238,21,238,103,0],[239,21,241,111,0],[242,17,242,18,0],[243,17,243,70,0],[244,17,244,18,0],[245,21,245,76,0],[246,25,246,111,0],[247,17,247,18,0],[249,17,249,68,0],[250,21,250,83,0],[252,17,252,24,0],[252,26,252,33,0],[252,34,252,36,0],[252,37,252,59,0],[253,17,253,18,0],[254,21,254,113,0],[255,21,255,22,0],[256,25,256,75,0],[257,29,257,83,0],[258,25,258,31,0],[260,17,260,18,0],[261,13,261,14,0],[262,9,262,10,0],[265,9,265,10,0],[266,13,267,93,0],[268,9,268,10,0],[271,9,271,10,0],[273,13,273,80,0],[275,13,275,79,0],[276,13,276,83,0],[277,13,277,76,0],[278,13,278,118,0],[279,13,279,78,0],[280,13,280,119,0],[281,13,281,127,0],[282,13,282,79,0],[283,13,283,118,0],[286,13,286,73,0],[287,13,287,77,0],[288,13,288,76,0],[289,13,289,79,0],[290,13,290,79,0],[291,13,291,80,0],[292,13,292,78,0],[293,13,293,85,0],[294,13,294,143,0],[299,13,299,39,0],[300,13,300,34,0],[301,13,301,37,0],[303,13,303,33,0],[304,13,304,14,0],[305,17,308,105,0],[311,17,311,73,0],[312,17,312,48,0],[313,17,313,105,0],[314,17,314,59,0],[316,17,318,77,0],[320,17,320,66,0],[321,13,321,14,0],[322,13,322,37,0],[323,13,323,44,0],[324,9,324,10,0],[327,9,327,10,0],[329,13,329,38,0],[330,13,330,14,0],[331,17,331,54,0],[331,55,331,78,0],[333,21,333,45,0],[334,17,334,70,0],[334,71,334,93,0],[335,13,335,14,0],[336,9,336,10,0],[339,9,339,10,0],[340,13,340,45,0],[341,13,341,43,0],[342,13,342,45,0],[343,13,343,43,0],[344,13,344,58,0],[346,13,346,43,0],[347,13,347,46,0],[348,13,348,44,0],[349,13,349,58,0],[351,13,351,43,0],[352,13,352,45,0],[353,13,353,41,0],[354,13,354,58,0],[356,13,356,43,0],[357,13,357,41,0],[358,13,358,44,0],[359,13,359,59,0],[360,13,360,66,0],[361,13,361,49,0],[362,13,362,50,0],[363,13,363,46,0],[364,13,364,45,0],[366,13,366,28,0],[367,9,367,10,0],[370,9,370,10,0],[371,13,372,92,0],[373,13,373,14,0],[374,17,374,116,0],[377,13,381,128,0],[382,9,382,10,0],[385,9,385,10,0],[386,13,386,56,0],[387,13,387,48,0],[388,13,388,14,0],[406,17,406,71,0],[407,17,414,81,0],[416,13,416,14,0],[417,9,417,10,0],[420,9,420,10,0],[421,13,421,56,0],[422,13,422,48,0],[423,13,423,14,0],[424,17,424,71,0],[425,17,432,81,0],[433,13,433,14,0],[434,9,434,10,0],[437,9,437,10,0],[438,13,438,35,0],[440,13,440,56,0],[441,13,441,132,0],[443,13,443,14,0],[444,17,444,52,0],[445,17,445,18,0],[446,21,446,54,0],[447,17,447,18,0],[448,17,448,29,0],[449,21,449,90,0],[451,17,451,107,0],[453,17,453,71,0],[454,17,454,121,0],[455,17,455,81,0],[456,13,456,14,0],[457,13,457,33,0],[458,13,458,14,0],[459,17,459,26,0],[463,13,463,40,0],[464,9,464,10,0],[467,9,467,10,0],[469,13,469,14,0],[471,17,471,45,0],[474,17,474,51,0],[474,52,474,80,0],[477,17,477,119,0],[478,17,478,18,0],[479,21,481,58,0],[482,17,482,18,0],[483,13,483,14,0],[484,13,484,33,0],[485,13,485,14,0],[486,17,486,155,0],[488,13,488,69,0],[489,9,489,10,0],[492,9,492,10,0],[493,13,493,76,0],[494,13,494,36,0],[495,17,495,113,0],[497,17,497,118,0],[498,13,498,103,0],[499,13,499,14,0],[500,17,500,114,0],[501,13,501,14,0],[502,9,502,10,0],[505,9,505,10,0],[507,13,507,14,0],[508,17,508,39,0],[510,17,510,53,0],[511,17,511,52,0],[512,17,512,18,0],[515,21,515,33,0],[516,21,516,22,0],[517,25,517,81,0],[518,25,518,59,0],[518,60,518,88,0],[519,21,519,22,0],[520,21,520,54,0],[521,17,521,18,0],[523,17,523,73,0],[524,17,524,46,0],[525,17,525,119,0],[526,17,526,121,0],[527,13,527,14,0],[528,13,528,33,0],[529,13,529,14,0],[530,17,530,121,0],[564,13,564,33,0],[565,9,565,10,0],[568,9,568,10,0],[569,13,569,48,0],[570,13,570,14,0],[571,17,572,120,0],[573,13,573,14,0],[574,18,574,103,0],[576,13,576,14,0],[578,17,578,18,0],[581,21,582,103,0],[583,21,583,22,0],[584,25,585,108,0],[587,21,587,43,0],[588,21,588,64,0],[589,21,589,56,0],[590,21,590,22,0],[593,25,593,37,0],[594,29,594,111,0],[595,25,595,58,0],[596,21,596,22,0],[598,21,598,75,0],[600,21,601,80,0],[602,17,602,18,0],[603,17,603,37,0],[604,17,604,18,0],[605,21,605,30,0],[607,13,607,14,0],[608,18,608,72,0],[609,13,609,14,0],[610,17,610,60,0],[611,17,611,51,0],[612,17,612,18,0],[613,21,613,85,0],[616,17,621,118,0],[622,13,622,14,0],[623,18,623,70,0],[624,13,624,14,0],[625,17,625,60,0],[626,17,626,51,0],[627,17,627,18,0],[628,21,628,85,0],[631,17,636,118,0],[637,13,637,14,0],[638,18,638,75,0],[639,13,639,14,0],[640,17,640,60,0],[641,17,641,51,0],[642,17,642,18,0],[643,21,643,85,0],[646,17,651,118,0],[652,13,652,14,0],[653,18,653,51,0],[654,13,654,14,0],[656,17,656,18,0],[657,21,657,64,0],[658,21,658,43,0],[659,21,659,56,0],[660,21,660,22,0],[661,25,661,37,0],[662,25,662,26,0],[663,29,663,85,0],[664,29,664,63,0],[664,64,664,92,0],[665,29,674,93,0],[675,25,675,26,0],[677,25,677,26,0],[678,29,678,62,0],[679,29,680,85,0],[681,25,681,26,0],[684,21,684,22,0],[685,17,685,18,0],[686,17,686,37,0],[687,17,687,18,0],[688,21,689,109,0],[691,13,691,14,0],[692,18,692,72,0],[693,13,693,14,0],[694,17,694,60,0],[695,17,695,85,0],[696,21,696,69,0],[698,17,700,111,0],[701,17,701,93,0],[702,13,702,14,0],[703,18,703,50,0],[704,13,704,14,0],[706,17,706,18,0],[707,21,707,57,0],[708,21,708,55,0],[709,25,709,89,0],[710,21,710,33,0],[711,25,711,112,0],[712,21,712,105,0],[713,25,713,105,0],[714,21,714,79,0],[715,21,715,56,0],[716,25,716,68,0],[717,21,717,37,0],[719,17,719,37,0],[720,17,720,18,0],[721,21,721,39,0],[724,18,724,62,0],[725,13,725,14,0],[726,17,726,49,0],[728,17,728,24,0],[728,26,728,33,0],[728,34,728,36,0],[728,37,728,59,0],[729,17,729,18,0],[730,21,731,78,0],[732,21,732,22,0],[733,25,734,126,0],[735,29,737,55,0],[738,25,738,51,0],[739,25,739,31,0],[741,17,741,18,0],[742,17,742,40,0],[743,21,746,103,0],[748,21,748,143,0],[749,13,749,14,0],[750,18,750,95,0],[751,13,751,14,0],[753,17,753,18,0],[754,21,754,64,0],[755,21,755,55,0],[756,21,756,22,0],[757,25,757,89,0],[760,21,760,57,0],[761,17,761,18,0],[762,17,762,37,0],[763,17,763,18,0],[764,21,764,39,0],[766,13,766,14,0],[768,13,768,14,0],[769,17,769,57,0],[771,13,771,33,0],[772,9,772,10,0],[775,9,775,10,0],[776,13,776,46,0],[778,13,778,20,0],[778,22,778,29,0],[778,30,778,32,0],[778,33,778,55,0],[779,13,779,14,0],[780,17,783,22,0],[784,17,784,18,0],[785,21,785,90,0],[787,13,787,14,0],[788,13,789,124,0],[790,13,790,108,0],[791,13,791,46,0],[792,13,792,55,0],[793,17,793,46,0],[794,13,794,55,0],[795,17,795,103,0],[796,13,797,120,0],[798,9,798,10,0],[801,9,801,10,0],[802,13,806,127,0],[807,9,807,10,0],[811,9,811,10,0],[812,13,812,34,0],[813,13,813,37,0],[814,13,814,28,0],[815,13,815,14,0],[816,17,816,40,0],[817,17,817,18,0],[818,21,818,46,0],[819,17,819,18,0],[820,17,820,41,0],[821,17,821,36,0],[822,17,822,57,0],[823,13,823,14,0],[824,13,824,44,0],[825,13,825,65,0],[826,9,826,10,0],[829,9,829,10,0],[830,13,830,71,0],[831,17,831,121,0],[832,13,832,61,0],[833,17,833,111,0],[834,13,834,63,0],[835,17,835,115,0],[836,13,836,68,0],[837,17,837,116,0],[838,13,838,95,0],[839,17,839,145,0],[840,13,840,92,0],[841,17,841,140,0],[842,13,842,87,0],[843,17,843,137,0],[844,13,844,84,0],[845,17,845,132,0],[846,13,846,92,0],[847,17,847,142,0],[848,13,848,89,0],[849,17,849,137,0],[850,13,850,78,0],[851,17,851,128,0],[852,13,852,75,0],[853,17,853,123,0],[854,13,854,66,0],[855,17,855,72,0],[856,13,856,58,0],[857,17,857,64,0],[858,13,858,66,0],[859,17,859,72,0],[860,13,860,72,0],[861,17,861,78,0],[862,9,862,10,0],[865,9,865,10,0],[868,13,868,87,0],[869,13,869,95,0],[870,13,870,97,0],[871,13,871,103,0],[872,13,872,83,0],[873,13,873,97,0],[877,13,877,26,0],[878,13,879,74,0],[880,17,880,111,0],[884,13,884,60,0],[885,17,885,85,0],[886,13,886,60,0],[887,17,887,85,0],[889,13,889,20,0],[889,22,889,35,0],[889,36,889,38,0],[889,39,889,58,0],[890,13,890,14,0],[891,17,891,122,0],[892,17,892,122,0],[893,13,893,14,0],[895,13,895,64,0],[896,17,896,89,0],[897,13,897,20,0],[897,22,897,41,0],[897,42,897,44,0],[897,45,897,68,0],[898,17,899,95,0],[901,13,901,54,0],[901,55,901,117,0],[902,13,902,54,0],[902,55,902,117,0],[904,13,904,20,0],[904,22,904,37,0],[904,38,904,40,0],[904,41,904,54,0],[905,13,905,14,0],[906,17,907,87,0],[908,17,909,87,0],[910,13,910,14,0],[913,13,913,61,0],[914,17,914,86,0],[915,13,915,61,0],[916,17,916,86,0],[918,13,918,20,0],[918,22,918,40,0],[918,41,918,43,0],[918,44,918,64,0],[919,13,919,14,0],[920,17,921,93,0],[922,17,923,93,0],[924,13,924,14,0],[930,13,930,59,0],[931,13,931,20,0],[931,22,931,41,0],[931,42,931,44,0],[931,45,931,68,0],[932,13,932,14,0],[935,17,935,57,0],[936,17,936,50,0],[937,17,937,48,0],[939,17,939,49,0],[940,17,940,69,0],[941,17,941,48,0],[947,17,947,123,0],[948,17,948,24,0],[948,26,948,39,0],[948,40,948,42,0],[948,43,948,61,0],[949,17,949,18,0],[950,21,950,53,0],[951,21,951,54,0],[952,21,952,52,0],[954,21,954,117,0],[955,21,955,56,0],[956,21,956,22,0],[957,25,957,39,0],[958,25,958,26,0],[961,29,961,61,0],[962,29,962,75,0],[963,29,963,83,0],[964,29,964,36,0],[964,38,964,51,0],[964,52,964,54,0],[964,55,964,74,0],[965,29,965,30,0],[966,33,966,51,0],[967,33,967,92,0],[968,33,968,51,0],[969,29,969,30,0],[970,29,970,56,0],[971,29,971,75,0],[972,29,972,73,0],[973,29,973,101,0],[974,29,974,60,0],[977,25,977,26,0],[981,25,981,32,0],[981,34,981,47,0],[981,48,981,50,0],[981,51,981,70,0],[982,25,982,26,0],[983,29,983,61,0],[984,29,985,77,0],[986,29,986,66,0],[987,29,987,75,0],[988,29,988,73,0],[989,29,989,61,0],[991,29,991,79,0],[992,33,992,77,0],[993,29,993,79,0],[994,33,994,77,0],[995,29,995,83,0],[996,33,996,85,0],[997,29,997,83,0],[998,33,998,85,0],[999,29,999,84,0],[1000,33,1000,87,0],[1001,29,1001,84,0],[1002,33,1002,87,0],[1004,29,1004,60,0],[1005,25,1005,26,0],[1008,21,1008,22,0],[1009,21,1009,49,0],[1010,17,1010,18,0],[1013,13,1013,14,0],[1014,13,1014,49,0],[1015,13,1015,68,0],[1016,13,1016,75,0],[1017,13,1017,41,0],[1023,13,1023,61,0],[1024,13,1024,14,0],[1025,17,1025,63,0],[1026,17,1026,58,0],[1027,17,1027,54,0],[1029,17,1029,55,0],[1030,17,1030,99,0],[1031,17,1031,54,0],[1032,13,1032,14,0],[1038,13,1038,53,0],[1038,54,1038,109,0],[1039,13,1039,53,0],[1039,54,1039,109,0],[1040,13,1040,54,0],[1040,55,1040,112,0],[1041,13,1041,55,0],[1041,56,1041,118,0],[1042,13,1042,53,0],[1042,54,1042,112,0],[1043,13,1043,58,0],[1043,59,1043,115,0],[1044,13,1044,55,0],[1044,56,1044,116,0],[1046,13,1046,57,0],[1046,58,1046,116,0],[1047,13,1047,57,0],[1047,58,1047,114,0],[1048,13,1048,56,0],[1048,57,1048,121,0],[1049,13,1049,62,0],[1050,17,1050,79,0],[1051,13,1051,56,0],[1051,57,1051,118,0],[1052,13,1052,62,0],[1053,17,1053,111,0],[1054,13,1054,66,0],[1055,17,1055,107,0],[1056,13,1056,67,0],[1057,17,1057,113,0],[1058,13,1058,62,0],[1059,17,1059,108,0],[1060,13,1060,66,0],[1061,17,1061,104,0],[1062,13,1062,67,0],[1063,17,1063,110,0],[1064,13,1064,59,0],[1065,17,1065,91,0],[1066,13,1066,59,0],[1067,17,1067,88,0],[1069,13,1069,61,0],[1070,17,1070,77,0],[1071,13,1071,60,0],[1072,17,1072,82,0],[1073,13,1073,66,0],[1074,17,1074,112,0],[1075,13,1075,70,0],[1076,17,1076,108,0],[1077,13,1077,71,0],[1078,17,1078,114,0],[1079,13,1079,63,0],[1080,17,1080,92,0],[1082,13,1082,50,0],[1082,51,1082,109,0],[1083,13,1083,56,0],[1083,57,1083,113,0],[1084,13,1084,50,0],[1084,51,1084,106,0],[1085,13,1085,56,0],[1086,17,1086,105,0],[1087,13,1087,60,0],[1088,17,1088,101,0],[1089,13,1089,61,0],[1090,17,1090,107,0],[1091,13,1091,56,0],[1092,17,1092,102,0],[1093,13,1093,60,0],[1094,17,1094,98,0],[1095,13,1095,61,0],[1096,17,1096,104,0],[1097,13,1097,53,0],[1098,17,1098,85,0],[1099,13,1099,53,0],[1099,54,1099,119,0],[1101,13,1101,62,0],[1102,17,1102,87,0],[1103,13,1103,63,0],[1104,17,1104,80,0],[1105,13,1105,57,0],[1105,58,1105,120,0],[1106,13,1106,63,0],[1107,17,1107,112,0],[1108,13,1108,67,0],[1109,17,1109,108,0],[1110,13,1110,68,0],[1111,17,1111,114,0],[1112,13,1112,63,0],[1113,17,1113,109,0],[1114,13,1114,67,0],[1115,17,1115,105,0],[1116,13,1116,68,0],[1117,17,1117,111,0],[1118,13,1118,60,0],[1119,17,1119,92,0],[1120,13,1120,60,0],[1121,17,1121,89,0],[1127,13,1127,53,0],[1127,54,1127,88,0],[1129,13,1129,58,0],[1129,59,1129,98,0],[1130,13,1130,62,0],[1130,63,1130,106,0],[1131,13,1131,62,0],[1131,63,1131,106,0],[1132,13,1132,59,0],[1132,60,1132,100,0],[1133,13,1133,60,0],[1133,61,1133,102,0],[1135,13,1135,70,0],[1136,17,1136,68,0],[1138,13,1138,66,0],[1138,67,1138,114,0],[1139,13,1139,64,0],[1139,65,1139,110,0],[1141,13,1141,52,0],[1141,53,1141,86,0],[1142,13,1142,56,0],[1142,57,1142,94,0],[1143,13,1143,56,0],[1143,57,1143,94,0],[1144,13,1144,53,0],[1144,54,1144,88,0],[1146,13,1146,61,0],[1146,62,1146,104,0],[1152,13,1152,20,0],[1152,22,1152,34,0],[1152,35,1152,37,0],[1152,38,1152,76,0],[1153,13,1153,14,0],[1154,17,1154,39,0],[1155,21,1155,46,0],[1156,13,1156,14,0],[1159,9,1159,10,0],[1163,9,1163,10,0],[1164,13,1164,41,0],[1165,13,1165,33,0],[1169,21,1169,64,0],[1170,21,1170,55,0],[1171,21,1171,22,0],[1172,25,1172,76,0],[1173,25,1173,31,0],[1176,21,1176,22,0],[1177,25,1177,38,0],[1178,25,1178,57,0],[1180,25,1183,116,0],[1185,25,1185,120,0],[1186,29,1186,35,0],[1189,25,1189,109,0],[1190,29,1190,35,0],[1193,25,1193,38,0],[1194,25,1194,122,0],[1195,29,1195,106,0],[1201,25,1201,78,0],[1204,25,1205,99,0],[1207,25,1207,81,0],[1208,25,1210,81,0],[1211,25,1211,78,0],[1212,25,1212,82,0],[1213,25,1213,71,0],[1214,25,1216,87,0],[1219,25,1219,39,0],[1220,25,1220,26,0],[1221,29,1221,68,0],[1222,25,1222,26,0],[1224,25,1224,26,0],[1225,29,1225,81,0],[1226,25,1226,26,0],[1228,25,1228,101,0],[1229,25,1229,83,0],[1257,21,1257,22,0],[1258,21,1258,41,0],[1259,21,1259,22,0],[1260,25,1261,114,0],[1262,21,1262,22,0],[1263,21,1263,27,0],[1265,21,1265,57,0],[1266,21,1266,27,0],[1268,13,1268,26,0],[1269,9,1269,10,0],[1273,9,1273,10,0],[1276,13,1276,98,0],[1279,13,1279,80,0],[1280,17,1280,69,0],[1284,13,1284,72,0],[1285,17,1285,87,0],[1286,18,1286,66,0],[1287,17,1288,41,0],[1289,13,1295,100,0],[1296,13,1299,97,0],[1300,13,1300,44,0],[1301,17,1301,45,0],[1303,17,1303,49,0],[1305,13,1305,28,0],[1305,29,1305,45,0],[1313,13,1313,103,0],[1314,13,1314,14,0],[1315,17,1315,24,0],[1315,26,1315,37,0],[1315,38,1315,40,0],[1315,41,1315,56,0],[1316,17,1316,18,0],[1317,21,1318,112,0],[1319,17,1319,18,0],[1320,13,1320,14,0],[1322,13,1322,39,0],[1323,9,1323,10,0],[1326,9,1326,10,0],[1327,13,1327,61,0],[1329,13,1329,37,0],[1330,13,1330,14,0],[1331,17,1331,108,0],[1332,21,1332,102,0],[1333,22,1333,115,0],[1334,21,1334,118,0],[1335,17,1335,53,0],[1336,17,1336,63,0],[1337,17,1337,18,0],[1338,21,1338,58,0],[1339,21,1339,22,0],[1340,25,1340,81,0],[1341,25,1341,59,0],[1341,60,1341,88,0],[1342,21,1342,22,0],[1343,26,1343,62,0],[1344,25,1344,107,0],[1345,17,1345,18,0],[1347,17,1347,140,0],[1349,17,1351,52,0],[1352,17,1352,18,0],[1353,21,1354,137,0],[1355,21,1355,67,0],[1356,25,1361,66,0],[1362,17,1362,18,0],[1363,17,1363,119,0],[1364,21,1364,102,0],[1366,17,1367,99,0],[1368,17,1368,18,0],[1369,21,1369,120,0],[1380,13,1380,14,0],[1382,13,1382,25,0],[1383,9,1383,10,0],[1386,9,1386,10,0],[1387,13,1387,128,0],[1388,17,1388,62,0],[1389,9,1389,10,0],[1392,9,1392,10,0],[1400,13,1404,54,0],[1405,13,1405,88,0],[1408,9,1408,10,0],[1411,9,1411,10,0],[1414,13,1414,135,0],[1416,13,1417,48,0],[1418,13,1418,26,0],[1419,13,1419,91,0],[1420,13,1420,14,0],[1421,17,1421,40,0],[1424,17,1424,142,0],[1425,17,1425,82,0],[1426,21,1426,60,0],[1427,13,1427,14,0],[1428,13,1428,24,0],[1429,9,1429,10,0],[1432,9,1432,10,0],[1435,13,1435,135,0],[1437,13,1438,48,0],[1439,13,1439,26,0],[1440,13,1440,91,0],[1441,13,1441,14,0],[1442,17,1442,40,0],[1445,17,1445,142,0],[1446,17,1446,82,0],[1447,21,1447,60,0],[1448,13,1448,14,0],[1449,13,1449,24,0],[1450,9,1450,10,0],[1452,51,1452,52,0],[1452,53,1452,65,0],[1452,66,1452,67,0]]);
    </script>
  </body>
</html>