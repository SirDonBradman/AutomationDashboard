<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\MODMGMT\Permission.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Linq;
using System.Globalization;
using System.Text;
using System.Web.UI.HtmlControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.AMP3.ModuleManagementUI
{
    public partial class Permission : BrixPageBase
    {
        private string moduleID;

        protected override void OnInit(EventArgs e)
        {
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);
            PermissionsToCheck.Add(&quot;Permission&quot;);

            base.OnInit(e);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                PageTitle = &quot;Module Details&quot;;
                DataRow detailRow;

                if (((moduleID = Request.QueryString[&quot;moduleID&quot;]) == null)
                    || ((detailRow = ModuleManager.Instance.GetModuleDetails(moduleID)) == null))
                {
                    lblMessage.Text = MessageResourceManager.GetString(&quot;E_MODMGMT_MODULE_UNDEPLOYED_BY_USER&quot;,
                        Enumerations.MessageType.ErrorMessage);
                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=MODMGMT&quot;, false);
                    return;
                }

                if (!IsPostBack)
                {
                    if (moduleID == &quot;PAYESTM&quot;)
                        lblName.Text = lblDescription.Text = moduleID;
                    else
                    {
                        lblName.Text = detailRow[&quot;ModuleName&quot;].ToString2();
                        lblDescription.Text = detailRow[&quot;ModuleDescription&quot;].ToString2();
                    }
                    lblUpdatedOn.Text =
                        detailRow[&quot;UploadedDate&quot;].ToMWDateTimeString_FormatDateTime();
                    lblUpdatedBy.Text = detailRow[&quot;UploadedBy&quot;].ToString2();
                    lblType.Text = detailRow[&quot;ModuleType&quot;].ToString2();
                    lblVersion.Text = detailRow[&quot;Version&quot;].ToString2();
                    chklogging.Checked = detailRow[&quot;EnableLogging&quot;].ToBoolean2();
                    chklogging.Visible = true;
                    chkEnableEditByNonStakeHolder.Checked = detailRow[&quot;EnableEditByNonStakeHolder&quot;].ToBoolean2();
                    chkEnableEditByNonStakeHolder.Visible = true;
                    chkAllowActionByAllStakeHolders.Checked = detailRow[&quot;AllowActionByAllStakeHolders&quot;].ToBoolean2();
                    chkAllowActionByAllStakeHolders.Visible = true;

                    chkSearch.Checked = detailRow[&quot;IsSearchable&quot;].ToBoolean2();

                    //Permission Matrix
                    Dictionary&lt;int, string&gt; roles = ModuleManager.Instance.GetAllRoles(); //Roles
                    Dictionary&lt;int, string[]&gt; allfeatures = ModuleManager.Instance.GetModuleFeaturesWithDetails(moduleID);
                    //Features
                    Dictionary&lt;int, string&gt; features = new Dictionary&lt;int, string&gt;();
                    using (DataContext context = new DataContext(ConnectionHelper.GetConnectionString()))
                    {
                        //We Can not able to exclude any of the reports. So-that we are commenting this code.
                        // Table&lt;ReportDetails&gt; rptTable = context.GetTable&lt;ReportDetails&gt;();
                        foreach (KeyValuePair&lt;int, string[]&gt; key in allfeatures)
                        {
                            // ReportDetails rpt = rptTable.FirstOrDefault(r =&gt; r.ModuleId == moduleID &amp;&amp; (r.Context == key.Value[0] ||
                            // (r.ReportType.ToLower().Equals(ReportHostType.dda.ToString()) &amp;&amp; r.Code != null &amp;&amp; r.Code != string.Empty &amp;&amp; r.Context == key.Value[0] + &quot;Report&quot; + &quot;-&quot; + r.Code) ||
                            // (r.ReportType.ToLower().Equals(ReportHostType.dda.ToString()) &amp;&amp; r.Context == key.Value[0] + &quot;Report&quot;)));
                            // if (rpt == null)
                            features.Add(key.Key, key.Value[1]);
                        }
                    }
                    if (features.Count &gt; 0)
                    {
                        Dictionary&lt;int, List&lt;int&gt;&gt; matrix = ModuleManager.Instance.GetPermissionMatrix(moduleID);
                        string table = CreatePermissionTable(roles, features, matrix, true, moduleID);
                        outermostDiv.InnerHtml = table;
                        StringBuilder visibleColumnsArrayStr = new StringBuilder();
                        StringBuilder ColumnsSettingsStr = new StringBuilder();
                        foreach (KeyValuePair&lt;int, string&gt; feature in features)
                        {
                            visibleColumnsArrayStr.AppendFormat(&quot;{0},&quot;, feature.Key);
                            ColumnsSettingsStr.AppendFormat(&quot;_{0}=75;&quot;, feature.Key);
                        }
                        if (visibleColumnsArrayStr.Length &gt; 1)
                            hdnVisibleColumns.Value =
                                visibleColumnsArrayStr.Remove(visibleColumnsArrayStr.Length - 1, 1).ToString();
                        if (visibleColumnsArrayStr.Length &gt; 1)
                        {
                            ColumnsSettingsStr.Remove(ColumnsSettingsStr.Length - 1, 1)
                                .Insert(0, &#39;&quot;&#39;)
                                .Insert(ColumnsSettingsStr.Length, &#39;&quot;&#39;);
                            this.Page.ClientScript.RegisterArrayDeclaration(&quot;ColumnSettings&quot;,
                                ColumnsSettingsStr.ToString());
                        }
                    }
                    else
                    {
                        tdPermissionDetails.Visible = false;
                    }
                    // to set back button as the default button
                    var myForm = (HtmlForm)Page.Master.FindControl(&quot;form1&quot;);
                    myForm.DefaultButton = (btnSave.Enabled == false) ? btnBack.UniqueID : btnSave.UniqueID;
                }
            }
            catch (Exception ex)
            {
                lblMessage.Text = ex.Message;
            }
        }

        DataTable GetRoleName(int RoleID)
        {
            DataTable dtGetRoleName = new DataTable();
            dtGetRoleName = UserManager.Instance.GetRole(RoleID);
            return dtGetRoleName;
        }

        DataTable GetRoleNames(string RoleIDs)
        {
            DataTable dtGetRoleNames = new DataTable();
            dtGetRoleNames = UserManager.Instance.GetRoleNames(RoleIDs);
            return dtGetRoleNames;
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            try
            {
                var matrix = new Dictionary&lt;int, List&lt;int&gt;&gt;();
                DataTable dt;
                int ViewFeatureID;
                dt = ModuleManager.Instance.GetViewVisibilityFeatureIDS(moduleID);

                // int VisibilityFeatureID = ModuleManager.Instance.GetVisibilityFeatureID(moduleID);
                if (dt.Rows.Count &gt; 1)
                    ViewFeatureID = dt.Rows[1][1].ToInt32_2();
                int VisibilityFeatureID = dt.Rows[0][1].ToInt32_2();

                string[] chkBoxIDs = hdnChkBoxIds.Value.Split(&#39;;&#39;);
                foreach (string chkBoxID in chkBoxIDs)
                {
                    if (chkBoxID.Length &lt;= 3)
                        continue;
                    string id =
                        chkBoxID.Substring(chkBoxID.IndexOf(&quot;cM_&quot;, StringComparison.CurrentCultureIgnoreCase) +
                                           &quot;cM_&quot;.Length);
                    int featureID = BrixDatatypeHelper.ToInt32_2(id.Split(&#39;_&#39;)[0]);
                    int roleID = BrixDatatypeHelper.ToInt32_2(id.Split(&#39;_&#39;)[1]);
                    if (!matrix.ContainsKey(featureID))
                    {
                        List&lt;int&gt; roles = new List&lt;int&gt;();
                        roles.Add(roleID);
                        matrix.Add(featureID, roles);
                    }
                    else
                    {
                        matrix[featureID].Add(roleID);
                    }
                    lblMessage.Text = &quot;&quot;;
                }
                //foreach (string key in Request.Form.AllKeys)
                //{
                //    if ((key.Contains(&quot;cM_&quot;)) &amp;&amp; (Request.Form[key] == &quot;on&quot;))
                //    {
                //        string id =
                //            key.Substring(key.IndexOf(&quot;cM_&quot;, StringComparison.CurrentCultureIgnoreCase) + &quot;cM_&quot;.Length);
                //        int featureID = id.Split(&#39;_&#39;)[0].ToInt32_2();
                //        int roleID = id.Split(&#39;_&#39;)[1].ToInt32_2();

                //        if (!matrix.ContainsKey(featureID))
                //        {
                //            var roles = new List&lt;int&gt;();
                //            roles.Add(roleID);
                //            matrix.Add(featureID, roles);
                //        }
                //        else
                //        {
                //            matrix[featureID].Add(roleID);
                //        }
                //        lblMessage.Text = &quot;&quot;;
                //    }
                //}

                if (matrix.Count != 0)
                {
                    if (!matrix.ContainsKey(VisibilityFeatureID))
                    {
                        lblMessage.Text =
                            MessageResourceManager.GetString(&quot;W_MODMGMT_VISIBILITY_PERMISSION_SHOULD_BE_GIVEN_FIRST&quot;,
                                Enumerations.MessageType.WarningMessage);
                        ////ModuleManager.Instance.CreatePermissionTable(tblPermissions,
                        ////                                             ModuleManager.Instance.GetAllRoles(),
                        ////                                             ModuleManager.Instance.GetModuleFeatures(moduleID),
                        ////                                             matrix, true, moduleID);
                        string table = CreatePermissionTable(ModuleManager.Instance.GetAllRoles(),
                            ModuleManager.Instance.GetModuleFeatures(moduleID),
                            matrix, true, moduleID);
                        outermostDiv.InnerHtml = table;
                        return;
                    }

                    if (dt.Rows.Count &gt; 1)
                    {
                        ViewFeatureID = dt.Rows[1][1].ToInt32_2();

                        if (matrix.Count &gt; 1 &amp;&amp; !matrix.ContainsKey(ViewFeatureID))
                        {
                            lblMessage.Text =
                                MessageResourceManager.GetString(&quot;W_MODMGMT_VIEW_PERMISSION_SHOULD_BE_GIVEN_FIRST&quot;,
                                    Enumerations.MessageType.WarningMessage);
                            //ModuleManager.Instance.CreatePermissionTable(tblPermissions,
                            //                                             ModuleManager.Instance.GetAllRoles(),
                            //                                             ModuleManager.Instance.GetModuleFeatures(
                            //                                                 moduleID),
                            //                                             matrix, true, moduleID);
                            string table = CreatePermissionTable(ModuleManager.Instance.GetAllRoles(),
                                ModuleManager.Instance.GetModuleFeatures(moduleID),
                                matrix, true, moduleID);
                            outermostDiv.InnerHtml = table;
                            return;
                        }
                    }

                    List&lt;int&gt; visibilityRoleList = matrix[VisibilityFeatureID];

                    // Check if the visibility feature is set
                    foreach (var feature in matrix)
                    {
                        if (feature.Key == VisibilityFeatureID)
                            continue;

                        List&lt;int&gt; featureRoleList = feature.Value;

                        if (visibilityRoleList.Count &lt; featureRoleList.Count) // Quick Check
                        {
                            //List&lt;int&gt; GetRoleIDList = new List&lt;int&gt;();
                            DataTable dtGetRoleNames = new DataTable();
                            string strRoleID = &quot;&quot;;
                            string strRoleName = &quot;&quot;;
                            foreach (int roleid in featureRoleList)
                            {
                                if (!visibilityRoleList.Contains(roleid))
                                    strRoleID = (string.IsNullOrEmpty(strRoleID))
                                        ? roleid.ToString()
                                        : strRoleID + &quot;,&quot; + roleid.ToString();
                                //GetRoleIDList.Add(i);
                            }

                            if (!string.IsNullOrEmpty(strRoleID))
                                dtGetRoleNames = GetRoleNames(strRoleID);

                            if (dtGetRoleNames != null &amp;&amp; dtGetRoleNames.Rows.Count &gt; 0)
                            {
                                strRoleName = dtGetRoleNames.Rows[0][&quot;RoleName&quot;].ToString2();
                            }

                            if (!string.IsNullOrEmpty(strRoleName))
                            {
                                Array arrLength = strRoleName.Split(&#39;,&#39;);
                                if (arrLength.Length &gt; 1)
                                    lblMessage.Text = &quot;Visibility Permission must be assigned to role (&quot; + strRoleName +
                                                      &quot;) to assign any other permission(s).&quot;;
                                else
                                    lblMessage.Text = &quot;Visibility Permission must be assigned to a role (&quot; + strRoleName +
                                                      &quot;) to assign any other permission(s).&quot;;

                                //lblMessage.Text =
                                //    MessageResourceManager.GetString(
                                //        &quot;W_MODMGMT_VISIBILITY_PERMISSION_SHOULD_BE_GIVEN_FIRST&quot;,
                                //        Enumerations.MessageType.WarningMessage);
                                //ModuleManager.Instance.CreatePermissionTable(tblPermissions,
                                //                                             ModuleManager.Instance.GetAllRoles(),
                                //                                             ModuleManager.Instance.GetModuleFeatures(
                                //                                                 moduleID), matrix, true, moduleID);
                                string table = CreatePermissionTable(ModuleManager.Instance.GetAllRoles(),
                                    ModuleManager.Instance.GetModuleFeatures(moduleID),
                                    matrix, true, moduleID);
                                outermostDiv.InnerHtml = table;
                                return;
                            }
                        }

                        // Detailed check
                        string sRoleID = &quot;&quot;;
                        string sRoleName = &quot;&quot;;
                        DataTable dGetRoleNames = new DataTable();

                        foreach (int role in featureRoleList)
                        {
                            if (!visibilityRoleList.Contains(role))
                            {
                                if (!visibilityRoleList.Contains(role))
                                    sRoleID = (string.IsNullOrEmpty(sRoleID))
                                        ? role.ToString()
                                        : sRoleID + &quot;,&quot; + role.ToString();
                                //GetRoleIDList.Add(i);
                            }
                        }

                        if (!string.IsNullOrEmpty(sRoleID))
                        {
                            dGetRoleNames = GetRoleNames(sRoleID);
                            if (dGetRoleNames != null &amp;&amp; dGetRoleNames.Rows.Count &gt; 0)
                            {
                                sRoleName = dGetRoleNames.Rows[0][&quot;RoleName&quot;].ToString2();
                            }

                            if (!string.IsNullOrEmpty(sRoleName))
                            {
                                Array arrLength = sRoleName.Split(&#39;,&#39;);
                                if (arrLength.Length &gt; 1)
                                    lblMessage.Text = &quot;Visibility Permission must be assigned to role (&quot; + sRoleName +
                                                      &quot;) to assign any other permission(s).&quot;;
                                else
                                    lblMessage.Text = &quot;Visibility Permission must be assigned to a role (&quot; + sRoleName +
                                                      &quot;) to assign any other permission(s).&quot;;
                                //MessageResourceManager.GetString(
                                //    &quot;W_MODMGMT_VISIBILITY_PERMISSION_SHOULD_BE_GIVEN_FIRST&quot;,
                                //    Enumerations.MessageType.WarningMessage);
                                //ModuleManager.Instance.CreatePermissionTable(tblPermissions,
                                //                                             ModuleManager.Instance.GetAllRoles(),
                                //                                             ModuleManager.Instance.GetModuleFeatures(
                                //                                                 moduleID), matrix, true, moduleID);
                                string table = CreatePermissionTable(ModuleManager.Instance.GetAllRoles(),
                                    ModuleManager.Instance.GetModuleFeatures(moduleID),
                                    matrix, true, moduleID);
                                outermostDiv.InnerHtml = table;
                                return;
                            }
                        }
                    }
                }

                if (
                    ModuleManager.Instance.UpdatePermissionMatrix(moduleID, matrix, Constants.USRMGMT_ADMIN_RID,
                        chklogging.Checked, chkSearch.Checked, chkEnableEditByNonStakeHolder.Checked, chkAllowActionByAllStakeHolders.Checked))
                {
                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=MODMGMT&quot;, false);
                }
                else
                {
                    lblMessage.Text =
                        MessageResourceManager.GetString(&quot;E_MODMGMT_UNABLE_TO_GET_PERMISSION_MATRIX&quot;,
                            Enumerations.MessageType.ErrorMessage);
                }
            }
            catch (Exception ex)
            {
                lblMessage.Text = ex.Message.ToString2();
            }
        }

        public string CreatePermissionTable(Dictionary&lt;int, string&gt; roles, Dictionary&lt;int, string&gt; features,
            Dictionary&lt;int, List&lt;int&gt;&gt; matrix, bool isEdit, string moduleID)
        {
            int rtnAdminRoleID = 0;
            StringBuilder sb = new StringBuilder();
            int roleWidth = 0;
            foreach (KeyValuePair&lt;int, string&gt; role in roles)
            {
                int tempWidth = (role.Value.Length*10) + 10;
                if (roleWidth &lt; tempWidth)
                    roleWidth = tempWidth;
            }
            if (roleWidth &lt; 100)
                roleWidth = 100;
            int width = 0;
            int height = 0;
            foreach (KeyValuePair&lt;int, string&gt; feature in features)
            {
                width = width +
                        (((feature.Value.Trim().Length*8) - 12) &lt; 60 ? 60 : ((feature.Value.Trim().Length*8) - 12));
            }
            width = (width &lt; 680) ? width : 680;
            height = ((roles.Count*21) + 4) &lt; 280 ? ((roles.Count*21) + 4) : 279;
            outermostDiv.Attributes.Add(&quot;style&quot;, &quot;width:&quot; + (roleWidth + width + 20).ToString2() + &quot;px;height: 100%;&quot;);
            GenerateStyleForResizableColumns(features);
            sb.Append(&quot;\r\n&lt;table width=\&quot;&quot; + (roleWidth + width + 20).ToString2() +
                      &quot;px\&quot; style=\&quot;border-collapse:collapse;\&quot;&gt;\r\n\t&lt;tr&gt;\n\t\t&lt;td  class=\&quot;modLeftTopHeader\&quot; style=\&quot;width:&quot; +
                      roleWidth.ToString2() +
                      &quot;px;height:51px\&quot; align=\&quot;center\&quot;&gt;Roles&lt;/td&gt;\r\n\t\t&lt;td class=\&quot;modTopHeader\&quot; style=\&quot;width:700px\&quot;&gt;&quot;);
            sb.Append(&quot;\r\n\t\t\t&lt;table width=\&quot;100%\&quot;&gt;\r\n\t\t\t&lt;tr style=\&quot;width:&quot; + width.ToString2() +
                      &quot;px;height:30px;\&quot;&gt;&lt;td align=\&quot;center\&quot; style=\&quot;width:&quot; + width.ToString2() +
                      &quot;px;font-weight: bold;font-family: Verdana;font-size: 12px;\&quot;&gt;Features&lt;/td&gt;&lt;/tr&gt;\r\n\t\t\t&lt;tr  align=\&quot;left\&quot; style=\&quot;height:21px;\&quot;&gt;&lt;td align=\&quot;left\&quot; style=\&quot; width:&quot; +
                      width.ToString2() + &quot;px;text-align:left;vertical-align:bottom;\&quot;&gt;&quot;);
            //Features Header Table (Includes Constant Header &quot;Feature&quot; and a Div with all features
            sb.Append(&quot;\r\n\t\t\t&lt;div id =\&quot;divFeatures\&quot; style=\&quot;width:&quot; + width.ToString2() +
                      &quot;px;overflow:hidden;height:21px\&quot;&gt;&quot;); //Features Div
            sb.Append(&quot;\r\n\t\t\t\t&lt;table id=\&quot;tblFeaturesHeader\&quot; border=\&quot;0px\&quot; width=\&quot;&quot; + width.ToString() +
                      &quot;\&quot; style=\&quot;table-layout:fixed;border-collapse:collapse;\&quot;&gt;&quot;);
            sb.Append(&quot;\r\n\t\t\t\t\t&lt;tr&gt;&quot;);
            int count = 0;
            Dictionary&lt;int, int&gt; frtWidth = new Dictionary&lt;int, int&gt;();
            foreach (KeyValuePair&lt;int, string&gt; feature in features)
            {
                sb.Append(&quot;\r\n\t\t\t\t\t\t&lt;td title=\&quot;&quot; + feature.Value.Trim() + &quot;\&quot; id=\&quot;td_&quot; + feature.Key + &quot;\&quot;&quot;);
                sb.Append(&quot; class=\&quot;modHeader col_&quot; + count.ToString() + &quot;\&quot; &gt;&quot;);
                if (feature.Value.Contains(&quot; &quot;))
                    sb.Append(&quot;&lt;nobr&gt;&quot; + feature.Value.Trim() + &quot;&lt;/nobr&gt;&quot;);
                else
                    sb.Append(feature.Value.Trim());
                sb.Append(&quot;&lt;div class=\&quot;resize_handle\&quot; ord=\&quot;&quot; + count +
                          &quot;\&quot;&gt;&lt;div id=\&quot;seperator\&quot; style=\&quot;height:100%;width:5px;background-color:black;position:absolute;left:1px;top:0px;z-index:1001;float:right;display:none;\&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;&quot;);
                count++;
            }
            sb.Append(&quot;\r\n\t\t\t\t\t&lt;/tr&gt;\r\n\t\t\t\t&lt;/table&gt;\r\n\t\t\t&lt;/div&gt;&quot;); //End of Feature Name Div
            sb.Append(&quot;\r\n\t\t\t&lt;/td&gt;&lt;/tr&gt;\r\n\t\t\t&lt;/table&gt;&quot;); //End of Features Header Table
            sb.Append(&quot;\r\n\t\t&lt;/td&gt;\r\n\t&lt;/tr&gt;\r\n\t&lt;tr&gt;\r\n\t\t&lt;td valign=\&quot;top\&quot; style=\&quot;width:&quot; +
                      (roleWidth).ToString2() + &quot;px;\&quot;&gt;&quot;);

            sb.Append(&quot;\r\n\t\t\t&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;div id =\&quot;divRoles\&quot; border=\&quot;1px\&quot; style=\&quot;overflow:hidden;width:&quot; +
                      roleWidth.ToString2() + &quot;px;height:&quot; + height.ToString2() +
                      &quot;px;\&quot;&gt;\r\n\t\t\t\t&lt;table border=\&quot;1px\&quot; style=\&quot;border-collapse:collapse;\&quot;&gt;&quot;);

            foreach (KeyValuePair&lt;int, string&gt; role in roles)
            {
                sb.Append(&quot;\r\n\t\t\t\t\t&lt;tr&gt;\r\n\t\t\t\t\t\t&lt;td title=\&quot;&quot; + role.Value +
                          &quot;\&quot; class=\&quot;modLeftHeader\&quot; style=\&quot;width:&quot; + roleWidth.ToString2() +
                          &quot;px; height:25px; background:#f1f1f1; \&quot;&gt;&lt;nobr&gt;&amp;nbsp;&amp;nbsp;&quot; + role.Value +
                          &quot;&amp;nbsp;&amp;nbsp;&lt;/nobr&gt;&lt;/td&gt;\r\n\t\t\t\t\t&lt;/tr&gt;&quot;);
            }
            sb.Append(&quot;\r\n\t\t\t\t&lt;/table&gt;\r\n\t\t\t&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;); // End of Role Name Div
            sb.Append(&quot;\r\n\t\t&lt;/td&gt;&quot;);
            sb.Append(&quot;\r\n\t\t&lt;td&gt;&quot;);
            sb.Append(&quot;\r\n\t\t&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot;);
            sb.Append(&quot;\r\n\t\t\t&lt;div id=\&quot;divMatrix\&quot; style=\&quot;width:&quot; + (width + 20).ToString2() + &quot;px;height:&quot; +
                      (height + 21).ToString2() + &quot;px;overflow:scroll;\&quot;&quot;);
            sb.Append(
                &quot;onscroll=\&quot;document.getElementById(&#39;divFeatures&#39;).scrollLeft=this.scrollLeft; document.getElementById(&#39;divRoles&#39;).scrollTop=this.scrollTop;\&quot;&gt;&quot;);
            sb.Append(
                &quot;\r\n\t\t\t\t&lt;table class=\&quot;matrixTable\&quot; border=\&quot;1px\&quot; style=\&quot;width:100%;table-layout:fixed;border-collapse:collapse;\&quot;&gt;&quot;);

            bool alternate = false;
            foreach (KeyValuePair&lt;int, string&gt; role in roles)
            {
                sb.Append(&quot;\r\n\t\t\t\t\t&lt;tr&quot;);
                sb.Append(&quot; style=\&quot;background-color:&quot;);

                if (alternate)
                {
                    sb.Append(&quot;white&quot;);
                }
                else
                {
                    sb.Append(&quot;#fbfbf7&quot;);
                }
                sb.Append(&quot;\&quot;&gt;&quot;);
                alternate = !alternate;
                int counter = -1;
                foreach (KeyValuePair&lt;int, string&gt; feature in features)
                {
                    counter++;
                    sb.Append(&quot;\r\n\t\t\t\t\t\t&lt;td title=\&quot;&quot; + role.Value + &quot; - &quot; + feature.Value.Trim() +
                              &quot;\&quot; class=\&quot;col_&quot; + counter + &quot;\&quot;  &gt;&quot;);
                    StringBuilder sbChk = new StringBuilder();
                    string chkId = &quot;cM_&quot; + feature.Key + &quot;_&quot; + role.Key;
                    sbChk.Append(&quot;\r\n\t\t\t\t\t\t\t&lt;input type=\&quot;checkbox\&quot; runat=\&quot;server\&quot; id=\&quot;&quot; + chkId +
                                 &quot;\&quot; onclick=\&quot;ChkBoxClicked(&#39;&quot; + chkId + &quot;&#39;)\&quot;&quot;);
                    if (role.Key == Constants.USRMGMT_ADMIN_RID)
                    {
                        rtnAdminRoleID = role.Key;
                        sbChk.Append(&quot; Disabled Checked &quot;);
                    }
                    else if (role.Value == &quot;Bidder&quot;)
                    {
                        sbChk.Append(&quot; Disabled UnChecked &quot;);
                    }
                    else
                    {
                        sbChk.Append((isEdit) ? &quot; Enabled&quot; : &quot; Disabled&quot;);
                        sbChk.Append(&quot; UnChecked&quot;);
                        hdnChkBoxIds.Value = hdnChkBoxIds.Value.Replace(chkId + &quot;;&quot;, &quot;&quot;);

                        // library modifications **************
                        switch (feature.Value)
                        {
                            case &quot;ModifySchema&quot;:
                            case &quot;ModifyRecords&quot;:
                            case &quot;PendingApproval&quot;:
                            case &quot;CreateUser&quot;:
                            case &quot;ModifyUser&quot;:
                            case &quot;ManageRoles&quot;:
                            case &quot;AddScript&quot;:
                            case &quot;DeleteScript&quot;:
                            case &quot;DownloadScript&quot;:
                            case &quot;ViewDetails&quot;:
                            case &quot;SetDefault&quot;:
                            case &quot;Deploy&quot;:
                            case &quot;Permission&quot;:
                                sbChk.Replace(&quot; Enabled&quot;, &quot;&quot;);
                                sbChk.Replace(&quot; Disabled&quot;, &quot;&quot;);
                                sbChk.Replace(&quot; Checked&quot;, &quot;&quot;);
                                sbChk.Replace(&quot; UnChecked&quot;, &quot;&quot;);
                                sbChk.Append(&quot; Disabled&quot;);
                                sbChk.Append(&quot; UnChecked&quot;);
                                hdnChkBoxIds.Value = hdnChkBoxIds.Value.Replace(chkId + &quot;;&quot;, &quot;&quot;);
                                break;
                            case &quot;ModifyLinks&quot;:
                            case &quot;Settings&quot;:
                            case Constants.MODFEAT_VISIBILITY:
                            case &quot;View&quot;:
                            case &quot;Delete&quot;:
                                switch (moduleID)
                                {
                                    case &quot;WORKFLW&quot;:
                                    case &quot;USRMGMT&quot;:
                                    case &quot;MODMGMT&quot;:
                                        sbChk.Replace(&quot; Enabled&quot;, &quot;&quot;);
                                        sbChk.Replace(&quot; Disabled&quot;, &quot;&quot;);
                                        sbChk.Replace(&quot; Checked&quot;, &quot;&quot;);
                                        sbChk.Replace(&quot; UnChecked&quot;, &quot;&quot;);
                                        sbChk.Append(&quot; Disabled&quot;);
                                        sbChk.Append(&quot; UnChecked&quot;);
                                        hdnChkBoxIds.Value = hdnChkBoxIds.Value.Replace(chkId + &quot;;&quot;, &quot;&quot;);
                                        break;
                                }
                                break;
                        }


                        if (matrix.ContainsKey(feature.Key))
                        {
                            List&lt;int&gt; tempstr = matrix[feature.Key];
                            if (tempstr.Contains(role.Key))
                            {
                                sbChk.Replace(&quot; Checked&quot;, &quot;&quot;);
                                sbChk.Replace(&quot; UnChecked&quot;, &quot;&quot;);
                                sbChk.Append(&quot; Checked&quot;);
                                hdnChkBoxIds.Value = hdnChkBoxIds.Value.Replace(chkId + &quot;;&quot;, &quot;&quot;);
                                hdnChkBoxIds.Value = hdnChkBoxIds.Value + chkId + &quot;;&quot;;
                            }
                        }
                    }
                    sb.Append(sbChk.ToString());
                    sb.Append(&quot;/&gt;\r\n\t\t\t\t\t\t&lt;/td&gt;&quot;);
                }
                sb.Append(&quot;\r\n\t\t\t\t\t&lt;/tr&gt;&quot;);
            }
            sb.Append(&quot;\r\n\t\t\t\t\t&lt;tr style=\&quot;height:5px;\&quot;&gt;&lt;td colspan=\&quot;&quot; + features.Count + &quot;\&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
            sb.Append(&quot;\r\n\t\t\t\t&lt;/table&gt;\r\n\t\t\t&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\r\n\t\t&lt;/td&gt;\r\n\t&lt;/tr&gt;\r\n&lt;/table&gt;&quot;);

            return sb.ToString2();
        }

        private void GenerateStyleForResizableColumns(Dictionary&lt;int, string&gt; features)
        {
            StringBuilder styleSB = new StringBuilder();
            styleSB.Append(&quot;&lt;style title=\&quot;resize_col_style\&quot;&gt;&quot;);
            int counter = 0;
            foreach (KeyValuePair&lt;int, string&gt; feature in features)
            {
                styleSB.Append(&quot;\r\n\t td.col_&quot;);
                styleSB.Append(counter);
                styleSB.Append(&quot;{width:&quot; +
                               (((feature.Value.Trim().Length*8) - 12) &lt; 60
                                   ? 60
                                   : ((feature.Value.Trim().Length*8) - 12)).ToString2());
                styleSB.Append(&quot;px;padding-left:2px;line-height:25px;text-align:center;vertical-align:top;} &quot;);
                counter++;
            }
            styleSB.Append(&quot;\r\n&lt;/style&gt;&quot;);
            DivStyle.InnerHtml = styleSB.ToString2();
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            menus.Add(new BrixMenu(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;, 55));
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            if (MainToolBar.GetMenuReference(&quot;lnkSave&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += btnSave_Click;
            if (MainToolBar.GetMenuReference(&quot;lnkCancel&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).PostBackUrl = &quot;~/Common/BrixListPage.aspx?context=MODMGMT&quot;;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,0],[26,13,26,66,0],[27,13,27,50,0],[29,13,29,28,0],[30,9,30,10,0],[33,9,33,10,0],[35,13,35,14,0],[36,17,36,46,0],[39,17,40,98,0],[41,17,41,18,0],[42,21,43,64,0],[44,21,44,92,0],[45,21,45,28,0],[48,17,48,33,0],[49,17,49,18,0],[50,21,50,47,0],[51,25,51,71,0],[53,21,53,22,0],[54,25,54,76,0],[55,25,55,90,0],[56,21,56,22,0],[57,21,58,87,0],[59,21,59,77,0],[60,21,60,72,0],[61,21,61,72,0],[62,21,62,82,0],[63,21,63,47,0],[64,21,64,114,0],[65,21,65,66,0],[66,21,66,118,0],[67,21,67,68,0],[69,21,69,80,0],[72,21,72,90,0],[73,21,73,123,0],[75,21,75,86,0],[76,28,76,105,0],[77,21,77,22,0],[80,25,80,32,0],[80,34,80,65,0],[80,66,80,68,0],[80,69,80,80,0],[81,25,81,26,0],[86,29,86,65,0],[87,25,87,26,0],[88,21,88,22,0],[89,21,89,44,0],[90,21,90,22,0],[91,25,91,114,0],[92,25,92,103,0],[93,25,93,56,0],[94,25,94,84,0],[95,25,95,80,0],[96,25,96,32,0],[96,34,96,67,0],[96,68,96,70,0],[96,71,96,79,0],[97,25,97,26,0],[98,29,98,86,0],[99,29,99,86,0],[100,25,100,26,0],[101,25,101,63,0],[102,29,103,112,0],[104,25,104,63,0],[105,25,105,26,0],[106,29,108,73,0],[109,29,110,64,0],[111,25,111,26,0],[112,21,112,22,0],[114,21,114,22,0],[115,25,115,61,0],[116,21,116,22,0],[118,21,118,77,0],[119,21,119,109,0],[120,17,120,18,0],[121,13,121,14,0],[122,13,122,33,0],[123,13,123,14,0],[124,17,124,46,0],[125,13,125,14,0],[126,9,126,10,0],[129,9,129,10,0],[130,13,130,55,0],[131,13,131,66,0],[132,13,132,34,0],[133,9,133,10,0],[136,9,136,10,0],[137,13,137,56,0],[138,13,138,73,0],[139,13,139,35,0],[140,9,140,10,0],[143,9,143,10,0],[145,13,145,14,0],[146,17,146,63,0],[149,17,149,83,0],[152,17,152,39,0],[153,21,153,63,0],[154,17,154,69,0],[156,17,156,68,0],[157,17,157,24,0],[157,26,157,41,0],[157,42,157,44,0],[157,45,157,54,0],[158,17,158,18,0],[159,21,159,46,0],[160,25,160,34,0],[161,21,163,58,0],[164,21,164,84,0],[165,21,165,81,0],[166,21,166,56,0],[167,21,167,22,0],[168,25,168,59,0],[169,25,169,43,0],[170,25,170,54,0],[171,21,171,22,0],[173,21,173,22,0],[174,25,174,55,0],[175,21,175,22,0],[176,21,176,42,0],[177,17,177,18,0],[201,17,201,39,0],[202,17,202,18,0],[203,21,203,66,0],[204,21,204,22,0],[205,25,207,74,0],[212,25,214,53,0],[215,25,215,56,0],[216,25,216,32,0],[219,21,219,43,0],[220,21,220,22,0],[221,25,221,67,0],[223,25,223,84,0],[224,25,224,26,0],[225,29,227,78,0],[233,29,235,57,0],[236,29,236,60,0],[237,29,237,36,0],[239,21,239,22,0],[241,21,241,80,0],[244,21,244,28,0],[244,30,244,41,0],[244,42,244,44,0],[244,45,244,51,0],[245,21,245,22,0],[246,25,246,64,0],[247,29,247,38,0],[249,25,249,67,0],[251,25,251,78,0],[252,25,252,26,0],[254,29,254,72,0],[255,29,255,51,0],[256,29,256,53,0],[257,29,257,36,0],[257,38,257,48,0],[257,49,257,51,0],[257,52,257,67,0],[258,29,258,30,0],[259,33,259,74,0],[260,37,262,79,0],[264,29,264,30,0],[266,29,266,66,0],[267,33,267,74,0],[269,29,269,89,0],[270,29,270,30,0],[271,33,271,94,0],[272,29,272,30,0],[274,29,274,68,0],[275,29,275,30,0],[276,33,276,74,0],[277,33,277,58,0],[278,37,279,94,0],[281,37,282,94,0],[292,33,294,61,0],[295,33,295,64,0],[296,33,296,40,0],[298,25,298,26,0],[301,25,301,45,0],[302,25,302,47,0],[303,25,303,67,0],[305,25,305,32,0],[305,34,305,42,0],[305,43,305,45,0],[305,46,305,61,0],[306,25,306,26,0],[307,29,307,68,0],[308,29,308,30,0],[309,33,309,72,0],[310,37,312,75,0],[314,29,314,30,0],[315,25,315,26,0],[317,25,317,60,0],[318,25,318,26,0],[319,29,319,67,0],[320,29,320,87,0],[321,29,321,30,0],[322,33,322,91,0],[323,29,323,30,0],[325,29,325,66,0],[326,29,326,30,0],[327,33,327,72,0],[328,33,328,58,0],[329,37,330,94,0],[332,37,333,94,0],[341,33,343,61,0],[344,33,344,64,0],[345,33,345,40,0],[347,25,347,26,0],[348,21,348,22,0],[349,17,349,18,0],[351,17,353,144,0],[354,17,354,18,0],[355,21,355,92,0],[356,17,356,18,0],[358,17,358,18,0],[359,21,361,68,0],[362,17,362,18,0],[363,13,363,14,0],[364,13,364,33,0],[365,13,365,14,0],[366,17,366,58,0],[367,13,367,14,0],[368,9,368,10,0],[372,9,372,10,0],[373,13,373,36,0],[374,13,374,52,0],[375,13,375,31,0],[376,13,376,20,0],[376,22,376,52,0],[376,53,376,55,0],[376,56,376,61,0],[377,13,377,14,0],[378,17,378,61,0],[379,17,379,43,0],[380,21,380,43,0],[381,13,381,14,0],[382,13,382,33,0],[383,17,383,33,0],[384,13,384,27,0],[385,13,385,28,0],[386,13,386,20,0],[386,22,386,55,0],[386,56,386,58,0],[386,59,386,67,0],[387,13,387,14,0],[388,17,389,117,0],[390,13,390,14,0],[391,13,391,49,0],[392,13,392,82,0],[393,13,393,120,0],[394,13,394,56,0],[395,13,398,128,0],[399,13,402,91,0],[404,13,405,60,0],[406,13,407,85,0],[408,13,408,45,0],[409,13,409,27,0],[410,13,410,72,0],[411,13,411,20,0],[411,22,411,55,0],[411,56,411,58,0],[411,59,411,67,0],[412,13,412,14,0],[413,17,413,119,0],[414,17,414,82,0],[415,17,415,49,0],[416,21,416,76,0],[418,21,418,53,0],[419,17,420,202,0],[421,17,421,25,0],[422,13,422,14,0],[423,13,423,82,0],[424,13,424,65,0],[425,13,426,59,0],[428,13,430,103,0],[432,13,432,20,0],[432,22,432,52,0],[432,53,432,55,0],[432,56,432,61,0],[433,13,433,14,0],[434,17,437,74,0],[438,13,438,14,0],[439,13,439,81,0],[440,13,440,40,0],[441,13,441,39,0],[442,13,442,50,0],[443,13,444,76,0],[445,13,446,163,0],[447,13,448,143,0],[450,13,450,36,0],[451,13,451,20,0],[451,22,451,52,0],[451,53,451,55,0],[451,56,451,61,0],[452,13,452,14,0],[453,17,453,48,0],[454,17,454,57,0],[456,17,456,31,0],[457,17,457,18,0],[458,21,458,40,0],[459,17,459,18,0],[461,17,461,18,0],[462,21,462,42,0],[463,17,463,18,0],[464,17,464,34,0],[465,17,465,40,0],[466,17,466,34,0],[467,17,467,24,0],[467,26,467,59,0],[467,60,467,62,0],[467,63,467,71,0],[468,17,468,18,0],[469,21,469,31,0],[470,21,471,70,0],[472,21,472,63,0],[473,21,473,73,0],[474,21,475,83,0],[476,21,476,65,0],[477,21,477,22,0],[478,25,478,51,0],[479,25,479,60,0],[480,21,480,22,0],[481,26,481,53,0],[482,21,482,22,0],[483,25,483,62,0],[484,21,484,22,0],[486,21,486,22,0],[487,25,487,75,0],[488,25,488,52,0],[489,25,489,90,0],[492,25,492,47,0],[507,33,507,63,0],[508,33,508,64,0],[509,33,509,63,0],[510,33,510,65,0],[511,33,511,59,0],[512,33,512,60,0],[513,33,513,98,0],[514,33,514,39,0],[520,33,520,50,0],[525,41,525,71,0],[526,41,526,72,0],[527,41,527,71,0],[528,41,528,73,0],[529,41,529,67,0],[530,41,530,68,0],[531,41,531,106,0],[532,41,532,47,0],[534,33,534,39,0],[538,25,538,61,0],[539,25,539,26,0],[540,29,540,69,0],[541,29,541,60,0],[542,29,542,30,0],[543,33,543,63,0],[544,33,544,65,0],[545,33,545,58,0],[546,33,546,98,0],[547,33,547,87,0],[548,29,548,30,0],[549,25,549,26,0],[550,21,550,22,0],[551,21,551,49,0],[552,21,552,58,0],[553,17,553,18,0],[554,17,554,50,0],[555,13,555,14,0],[556,13,556,116,0],[557,13,557,117,0],[559,13,559,35,0],[560,9,560,10,0],[563,9,563,10,0],[564,13,564,57,0],[565,13,565,66,0],[566,13,566,29,0],[567,13,567,20,0],[567,22,567,55,0],[567,56,567,58,0],[567,59,567,67,0],[568,13,568,14,0],[569,17,569,50,0],[570,17,570,41,0],[571,17,574,91,0],[575,17,575,112,0],[576,17,576,27,0],[577,13,577,14,0],[578,13,578,44,0],[579,13,579,54,0],[580,9,580,10,0],[583,9,583,10,0],[584,13,584,41,0],[585,13,585,76,0],[586,13,586,82,0],[587,13,587,44,0],[588,9,588,10,0],[591,9,591,10,0],[592,13,592,65,0],[593,17,593,80,0],[594,13,594,67,0],[595,17,595,118,0],[596,9,596,10,0]]);
    </script>
  </body>
</html>