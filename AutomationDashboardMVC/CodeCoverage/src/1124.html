<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\ConcreteModels\DocumentManagement\DocumentListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.DocumentManagementBL;
using Aurigo.AMP3.DocumentManagementDTO;
using Aurigo.AMP3.LinksBL;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.ProjectBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.FileParser;
using Aurigo.Brix.Platform.BusinessLayer.UserControls;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.WorkflowMediators;
using Aurigo.Common;
using Aurigo.Workflow;
using Infragistics.WebUI.UltraWebGrid.ExcelExport;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.Data;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Web;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Telerik.Web.UI;

namespace Aurigo.Brix.Platform.BusinessLayer.ConcreteModels.DocumentManagement
{
    [ListModelContext(Name = &quot;DOCMGMT&quot;)]
    public class DocumentListModel : ListModel, IWorkflowEnabledList
    {
        private Page Page { get; set; }

        private int _parentID;
        private const string DOC_NAME_DBNAME = &quot;DocName&quot;;
        private const string DOC_DESCR_DBNAME = &quot;DocDesc&quot;;
        private const string DOC_TYPE_DBNAME = &quot;DocType&quot;;

        private const string DOC_NAME = &quot;File Name&quot;;
        private const string DOC_DESCR = &quot;Title&quot;;

        private List&lt;string&gt; _docmgmtModuleComponents = null;
        private List&lt;string&gt; _folderPermissions = null;

        private string _folderName = string.Empty;
        private Folder _folderDTO = null;
        private BrixFormModel _metadataFormModel = null;

        protected global::Aurigo.Brix.WorkflowMediators.VersionHistory versionHistory;
        protected global::Aurigo.AMP3.Core.UserControls.ModalPopupExtender popupExtender;
        protected global::Aurigo.AMP3.Core.UserControls.DocumentMove appDocumentMove;
        protected global::Aurigo.AMP3.Core.UserControls.DocumentMove appDocumentCopy;
        protected global::Aurigo.AMP3.Core.UserControls.DocumentMove appDocumentTransmit;
        protected global::Aurigo.AMP3.Core.UserControls.DocumentManualAssociation appDocumentMnlAssociation;
        protected global::Aurigo.Brix.WorkflowMediators.ApprovalHistory approvalHistory;
        protected global::Aurigo.Brix.WorkflowMediators.WorkflowUserOverriding appWorkflowUserOverriding;

        protected global::Aurigo.Brix.Platform.BusinessLayer.UserControls.DocumentFolder documentFolder;
        Button btnWFHistory;
        Button btnLoadVerHistory;
        Button btnPopupExtenderForMove;
        Button btnPopupExtenderForCopy;
        Button btnPopupExtenderForTransmit;
        Button btnFolderMenuNew;
        Button btnFolderMenuEdit;
        Button btnWFUserOverriding;
        Button btnOpenPnlMnlAssociate;
        private int _xref = 1, _rendition = 2;

        #region Properties
        public string FormName
        {
            get { return &quot;XDOCMGT&quot;; }
        }

        public string ListPrimaryKey
        {
            get { return QueryStringName; }
        }

        public int ParentModuleId
        {
            get
            {
                return Request[&quot;IID&quot;].ToInt32_2();
                ;
            }
        }

        public int PID
        {
            get { return Request[Constants.QRY_PROJECTID].ToInt32_2(); }
        }

        public int IID
        {
            get { return Request[&quot;IID&quot;].ToInt32_2(); }
        }

        public string MID
        {
            get { return Request[&quot;MID&quot;].ToString(); }
        }

        private BrixFormModel MetadataFormModel
        {
            get
            {
                if (_metadataFormModel == null)
                    _metadataFormModel = ProjectManager.Instance.GetProjectMetadataXMLModel(ProjectID);

                return _metadataFormModel;
            }
        }

        private List&lt;string&gt; DOCMGMTModuleComponents
        {
            get
            {
                if (_docmgmtModuleComponents == null)
                    _docmgmtModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);

                return _docmgmtModuleComponents;
            }
        }

        private List&lt;string&gt; FolderPermissions
        {
            get
            {
                if (_folderPermissions == null)
                    _folderPermissions = Aurigo.AMP3.DocumentManagementBL.DocumentManager.Instance.GetPermissions(ProjectID, FID);

                return _folderPermissions;
            }
        }

        private int FID
        {
            get
            {
                int folderId = 0;

                if (!string.IsNullOrEmpty(Request.QueryString.Get(&quot;FID&quot;)))
                    int.TryParse(Request.QueryString.Get(&quot;FID&quot;), out folderId);

                return folderId;
            }
        }

        /// &lt;summary&gt;
        /// Gets the name of the query string.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The name of the query string.&lt;/value&gt;
        public override string QueryStringName
        {
            get { return &quot;DocId&quot;; }
        }

        /// &lt;summary&gt;
        /// Gets the module identifier.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The module identifier.&lt;/value&gt;
        public override string ModuleId
        {
            get { return &quot;DOCMGMT&quot;; }
        }

        public override int GetProjectIdFromInstanceId()
        {
            return DocumentManager.Instance.GetProjectIdFromFolderId(FID);
        }

        /// &lt;summary&gt;
        /// Gets the project identifier.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The project identifier.&lt;/value&gt;
        protected int ProjectID
        {
            get { return string.IsNullOrEmpty(Request[&quot;PID&quot;]) ? 0 : Request[&quot;PID&quot;].ToInt32_2(); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the parent identifier.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The parent identifier.&lt;/value&gt;
        public int ParentID
        {
            get { return _parentID; }
            set { _parentID = value; }
        }

        private Folder FolderDTO
        {
            get
            {
                if (_folderDTO == null)
                    _folderDTO = DocumentManager.Instance.GetFolderDetails(FID);

                return _folderDTO;
            }
        }

        public string FolderName
        {
            get
            {
                if (string.IsNullOrEmpty(_folderName))
                    _folderName = FolderDTO.FolderName;

                return _folderName;
            }
        }

        public override bool RecreateMenuItemsOnMenuItemClick
        {
            get { return false; }
        }

        public override bool HasAnnotations
        {
            get
            {
                return true;
            }
        }

        private Page CurrentPage
        {
            get
            {
                return HttpContext.Current.Handler as Page;
            }
        }

        private bool IsFolderAvailableOffline { get; set; }
        private bool IsFolderAvailableOfflineBecauseOfParent { get; set; }

        /// &lt;summary&gt;
        /// Gets the menu groups.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The menu groups.&lt;/value&gt;
        public override List&lt;MenuGroup&gt; MenuGroups
        {
            get
            {
                //int ParentID = thisFolder.ParentId;
                ParentID = FolderDTO.ParentId;

                //if (!permissions.Contains(&quot;Visibility&quot;) || !permissions.Contains(&quot;ViewF&quot;))
                //to view a page, only Visibility page is required
                if (!FolderPermissions.Contains(&quot;Visibility&quot;))
                {
                    UIHelper.RedirectURL(
                        &quot;The current role does not have the required permissions to view this page.&quot;,
                        Constants.URL_ENTERPRISE, null, HttpContext.Current);
                }

                //if a user is not invited to a project he should not be able to view this page
                //this check is required because for download document, we are giving a direct link to this page
                UserDetail ud = UserDetail.GetCurrentUserDetail();

                if (ProjectID &gt; 0 &amp;&amp; !Request.QueryString.Get(&quot;MID&quot;).Equals(&quot;ENTPRSE&quot;))
                {
                    if (ModuleManager.Instance.IsEffectivePermissionOfRoles())
                    {
                        DataTable dtProjUsers = ProjectManager.Instance.GetProjectUsers(ProjectID);
                        if (!UserManager.Instance.IsUserAdministrator(ud.UID) &amp;&amp;
                            (dtProjUsers.Select(&quot;UserID=&quot; + ud.UID).Length == 0))
                        {
                            UIHelper.RedirectURL(&quot;The current role does not have the required permissions to view this page.&quot;, Constants.URL_ENTERPRISE, null, HttpContext.Current);
                        }
                    }

                    else
                    {
                        if (ud.RID != Constants.USRMGMT_ADMIN_RID &amp;&amp; !ProjectManager.Instance.IsUserWithRoleInvitedToProject(ProjectID, ud.UID, ud.RID))
                            UIHelper.RedirectURL(&quot;The current role does not have the required permissions to view this page.&quot;, Constants.URL_ENTERPRISE, null, HttpContext.Current);
                    }
                }
                //setting the filter for all columns of the list page.
                DisplayFilterForColumns();

                List&lt;MenuGroup&gt; menuGroups = new List&lt;MenuGroup&gt;(); // base.MenuGroups;

                #region General

                MenuGroup generalGroup = new MenuGroup(&quot;General&quot;);
                if (FolderPermissions.Contains(&quot;Upload&quot;))
                    generalGroup.AddMenu(new LargeButton(&quot;lnkNew&quot;, &quot;New&quot;, &quot;Icn_New.png&quot;));
                else
                    DisplayNew = false;

                if (FolderPermissions.Contains(&quot;ViewD&quot;))
                    generalGroup.AddMenu(new TextIcon(&quot;lnkView&quot;, &quot;View&quot;, &quot;Icn_View_16.png&quot;));
                else
                    displayView = false;

                if (FolderPermissions.Contains(&quot;EditD&quot;))
                {
                    generalGroup.AddMenu(new TextIcon(&quot;lnkEdit&quot;, &quot;Edit Properties&quot;, &quot;Icn_Edit_16.png&quot;));
                }
                else
                    DisplayEdit = false;

                //Move doc Operation independent of Edit Doc Permissions : TRCA-41765
                var newDocOperation = new MenuButton(&quot;lnkEditmain&quot;, &quot;Document Operations&quot;, &quot;MoveIcon.png&quot;);
                newDocOperation.ButtonSize = ButtonSize.Medium;
                //added new icons to copy and transmit
                if (DOCMGMTModuleComponents.Contains(&quot;Move&quot;) &amp;&amp; FolderPermissions.Contains(&quot;Move&quot;))
                    newDocOperation.AddSubMenu(new TextIcon(&quot;lnkMove&quot;, &quot;Move&quot;, &quot;MoveIcon.png&quot;));
                if (DOCMGMTModuleComponents.Contains(&quot;Copy&quot;) &amp;&amp; FolderPermissions.Contains(&quot;Copy&quot;))
                    newDocOperation.AddSubMenu(new TextIcon(&quot;lnkCopy&quot;, &quot;Copy&quot;, &quot;Icn_Copy2_16.png&quot;));
                if (DOCMGMTModuleComponents.Contains(&quot;Transmit&quot;) &amp;&amp; FolderPermissions.Contains(&quot;Transmit&quot;))
                    newDocOperation.AddSubMenu(new TextIcon(&quot;lnkTransmit&quot;, &quot;Transmit&quot;, &quot;Icn_Transmit_16.png&quot;));
                if (DOCMGMTModuleComponents.Contains(&quot;Merge&quot;) &amp;&amp; FolderPermissions.Contains(&quot;Merge&quot;))
                    newDocOperation.AddSubMenu(new TextIcon(&quot;lnkMerge&quot;, &quot;Merge&quot;, &quot;Icn_document_merge_16.png&quot;));

                if (AMP3ApplicationSettings.Instance.MobileEnableOfflineDocuments)
                {
                    newDocOperation.AddSubMenu(new TextIcon(&quot;lnkDocMarkOffline&quot;, &quot;Mark Offline&quot;, &quot;Icn_AvailableOffline_16.png&quot;));
                    newDocOperation.AddSubMenu(new TextIcon(&quot;lnkDocMarkOnline&quot;, &quot;Mark Online&quot;, &quot;Icn_AvailableOnline_16.png&quot;));
                }

                if (newDocOperation.HasSubMenus)
                    generalGroup.AddMenu(newDocOperation);

                if (DOCMGMTModuleComponents.Contains(&quot;Archive&quot;) &amp;&amp; FolderPermissions.Contains(&quot;ArchiveD&quot;) &amp;&amp;
                    !FolderName.Equals(&quot;Archive&quot;))
                    generalGroup.AddMenu(new TextIcon(&quot;lnkArchive&quot;, &quot;Archive&quot;, &quot;Trashicon.png&quot;));
                if (FolderPermissions.Contains(&quot;DeleteD&quot;))
                    generalGroup.AddMenu(new TextIcon(&quot;lnkDelete&quot;, &quot;Delete&quot;, &quot;Icn_Delete_16.png&quot;));
                else
                    DisplayDelete = false;

                if (DOCMGMTModuleComponents.Contains(&quot;ShowCommentLog&quot;))
                {
                    //added for report link and its sub menus
                    var newReport = new MenuButton(&quot;lnkReport&quot;, &quot;Report&quot;, &quot;Icn_Reports.png&quot;);
                    newReport.AddSubMenu(new LargeButton(&quot;lnkReportClr&quot;, &quot;Comment Log Report&quot;, &quot;Icn_Pdf_16.png&quot;));
                    generalGroup.AddMenu(newReport);
                    if (FolderPermissions.Contains(&quot;ShowCommentLog&quot;))
                        generalGroup.AddMenu(new TextIcon(&quot;lnkCommentLog&quot;, &quot;Comment Log&quot;, &quot;Icn_Edit_16.png&quot;));
                }

                var newCheckinCheckout = new MenuButton(&quot;lnkchkinchkout&quot;, &quot;Check In/Out&quot;, &quot;IcnDiscardckeckout.png&quot;);
                newCheckinCheckout.ButtonSize = ButtonSize.Medium;
                if (FolderPermissions.Contains(&quot;CheckOut&quot;))
                    newCheckinCheckout.AddSubMenu(new TextIcon(&quot;lnkCheckOut&quot;, &quot;Check Out&quot;, &quot;IcnCheckout.png&quot;));
                if (FolderPermissions.Contains(&quot;CheckOut&quot;))
                    newCheckinCheckout.AddSubMenu(new TextIcon(&quot;lnkUndoCheckOut&quot;, &quot;Discard Check Out&quot;,
                        &quot;IcnDiscardckeckout.png&quot;));
                if (FolderPermissions.Contains(&quot;CheckIn&quot;))
                    newCheckinCheckout.AddSubMenu(new TextIcon(&quot;lnkCheckIn&quot;, &quot;Check In&quot;, &quot;Icncheckin.png&quot;));
                if (newCheckinCheckout.HasSubMenus)
                    generalGroup.AddMenu(newCheckinCheckout);

                if (FolderPermissions.Contains(&quot;VersionHistory&quot;))
                    generalGroup.AddMenu(new TextIcon(&quot;lnkVersionHistory&quot;, &quot;Version History&quot;, &quot;IcnVersions.gif&quot;));

                //generalGroup.AddMenu(new TextIcon(&quot;lnkCommentLogReport&quot;, &quot;Comment Log Report&quot;, &quot;Icn_View_16.png&quot;));

                generalGroup.AddMenu(new TextIcon(&quot;lnkGridSetting&quot;, &quot;Customize List&quot;, &quot;icn_Customlist_16.png&quot;));
                if (FolderPermissions.Contains(&quot;ViewD&quot;))
                {
                    if (FolderPermissions.Contains(&quot;DownloadD&quot;))
                    {
                        generalGroup.AddMenu(new TextIcon(&quot;lnkDownload&quot;, &quot;Get Document&quot;, &quot;Icn_XMLImport.png&quot;));
                    }
                    if (DOCMGMTModuleComponents.Contains(&quot;SlideShow&quot;))
                        generalGroup.AddMenu(new TextIcon(&quot;lnkSlideShow&quot;, &quot;Slide Show&quot;, &quot;Icn_gallery.gif&quot;));
                    if (DOCMGMTModuleComponents.Contains(&quot;ThumbnailView&quot;))
                        generalGroup.AddMenu(new TextIcon(&quot;lnkThumb&quot;, &quot;Thumbnail View&quot;, &quot;thumbnails-large.gif&quot;));
                }

                //leadtools annotation
                if (AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocumentViewer&quot;) &amp;&amp;
                    AMP3ApplicationSettings.Instance.appSettings[&quot;DocumentViewer&quot;].ToUpper2() == &quot;LEADTOOLS&quot; &amp;&amp; FolderPermissions.Contains(&quot;ViewD&quot;))
                    generalGroup.AddMenu(new TextIcon(&quot;lnkAnnotations&quot;, &quot;Annotations&quot;, &quot;Icn_Edit2_16.png&quot;));


                // generalGroup.AddMenu(new TextIcon(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;back.png&quot;));

                MenuButton menuImpExp = new MenuButton(&quot;lnkImportExport&quot;, &quot;Excel Export&quot;, &quot;Icn_xl_16.png&quot;);
                menuImpExp.ButtonSize = ButtonSize.Medium;
                if (FolderPermissions.Contains(&quot;ViewF&quot;))
                {
                    menuImpExp.AddSubMenu(new TextIcon(&quot;lnkExcelExport&quot;, &quot;Excel Export (xls)&quot;, &quot;Icn_export_16.png&quot;));
                    menuImpExp.AddSubMenu(new TextIcon(&quot;lnkExcelExportXlsx&quot;, &quot;Excel Export (xlsx)&quot;, &quot;Icn_export_16.png&quot;));
                }

                if (FolderPermissions.Contains(&quot;EditD&quot;) &amp;&amp; !FolderName.Equals(&quot;Archive&quot;))
                {
                    //this is no longer required
                    //menuImpExp.AddSubMenu(new TextIcon(&quot;lnkExcelImport&quot;, &quot;Excel Import&quot;, &quot;Icn_importxl_16.png&quot;));
                    menuImpExp.AddSubMenu(new TextIcon(&quot;lnkTemplateExport&quot;, ExcelHelper.EXCEL_TEMPLATE, &quot;Icn_exceltemplateexport_16.png&quot;));
                    menuImpExp.AddSubMenu(new TextIcon(&quot;lnkTemplateExportXlsx&quot;, ExcelHelper.EXCEL_TEMPLATE_XLSX, &quot;Icn_exceltemplateexport_16.png&quot;));
                }

                if (DOCMGMTModuleComponents.Contains(&quot;ExcelImortAndExport&quot;))
                {
                    generalGroup.AddMenu(menuImpExp);
                }

                if (MailMergeManager.IsMailMergeEnabled)
                    generalGroup.AddMenu(new TextIcon(&quot;lnkMailMerge&quot;, &quot;Mail Merge&quot;, &quot;IcnMailMerge_16.png&quot;));


                #region AUTO-ASSOCIATE

                if (DOCMGMTModuleComponents.Contains(&quot;AutoCadIntegration&quot;))
                {
                    if (FolderPermissions.Contains(&quot;AutoAssociate&quot;))
                    {
                        MenuButton lnkAssociation = new MenuButton(&quot;lnkAssociation&quot;, &quot;Association&quot;, &quot;icn_dwg_32x32.png&quot;);

                        TextIcon autoAssociate = new TextIcon(&quot;lnkAutoAssociate&quot;, &quot;Auto-Associate&quot;,
                            &quot;Icn_Addexistingrecord_16.png&quot;);
                        lnkAssociation.AddSubMenu(autoAssociate);

                        TextIcon manuallyAssociate = new TextIcon(&quot;lnkManuallyAssociate&quot;, &quot;Manually Associate&quot;,
                            &quot;Icn_Addexistingrecord_16.png&quot;);
                        lnkAssociation.AddSubMenu(manuallyAssociate);

                        TextIcon removeAssociation = new TextIcon(&quot;lnkRemoveAssociation&quot;, &quot;Remove Association&quot;,
                            &quot;Icn_Addexistingrecord_16.png&quot;);
                        lnkAssociation.AddSubMenu(removeAssociation);

                        generalGroup.AddMenu(lnkAssociation);
                    }

                    if (FolderPermissions.ContainsAllOf(&quot;GetPackage&quot;, &quot;ViewD&quot;, &quot;DownloadD&quot;, &quot;ViewF&quot;))
                    {
                        TextIcon getPackage = new TextIcon(&quot;lnkGetPackage&quot;, &quot;Get Package&quot;, &quot;Icn_GetPackage_16.png&quot;, tooltip: &quot;Get with all Xrefs.&quot;);
                        generalGroup.AddMenu(getPackage);
                    }
                }

                #endregion

                #region Review &amp; Consolidate

                if (DOCMGMTModuleComponents.Contains(&quot;Review&quot;) &amp;&amp; FolderPermissions.Contains(&quot;ReviewDocument&quot;))
                {
                    TextIcon review = new TextIcon(&quot;lnkReviewDocument&quot;, &quot;Review&quot;, &quot;icn_review_16.png&quot;, tooltip: &quot;Review the document.&quot;);
                    generalGroup.AddMenu(review);
                }

                if (DOCMGMTModuleComponents.Contains(&quot;Consolidate&quot;) &amp;&amp; FolderPermissions.Contains(&quot;ConsolidateDocumentReviews&quot;))
                {
                    TextIcon consolidate = new TextIcon(&quot;lnkConsolidate&quot;, &quot;Consolidate&quot;, &quot;icn_consolidate_16.png&quot;, tooltip: &quot;Consolidate reviews.&quot;);
                    generalGroup.AddMenu(consolidate);
                }

                #endregion

                if (generalGroup.Menus.Count &gt; 0)
                    menuGroups.Add(generalGroup);

                MenuGroup workflowGroup = new MenuGroup(&quot;Workflow&quot;);
                if (FolderPermissions.Contains(&quot;ViewH&quot;))
                {
                    workflowGroup.AddMenu(new LargeButton(&quot;lnkWorkFlowHistory&quot;, &quot;History&quot;, &quot;Icn_History.png&quot;));
                }

                List&lt;string&gt; permissionsForUserOverriding = Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetPermissionByUserOrRole(&quot;WORKFLW&quot;, ud.UID, ud.RID, ProjectID);
                if (permissionsForUserOverriding.Contains(&quot;UserOverriding&quot;))
                {
                    workflowGroup.AddMenu(new TextIcon(&quot;lnkWorkFlowUserOverriding&quot;, &quot;Workflow User(s)&quot;, &quot;Icn_WorkflowUsers.png&quot;));
                }

                menuGroups.Add(workflowGroup);

                #endregion

                #region Folder

                MenuGroup documentGroup = new MenuGroup(&quot;Folder&quot;);
                if (FolderPermissions.Contains(&quot;CreateSF&quot;))
                    documentGroup.AddMenu(new TextIcon(&quot;lnkNewSubfolder&quot;, &quot;New&quot;, &quot;Icn_Folder_16.png&quot;));
                if (FolderPermissions.Contains(&quot;EditF&quot;) &amp;&amp; ParentID &gt; 0)
                    documentGroup.AddMenu(new TextIcon(&quot;lnkEditFolder&quot;, &quot;Edit&quot;, &quot;IcnFolderedit.png&quot;));
                if (FolderPermissions.Contains(&quot;DeleteF&quot;) &amp;&amp; ParentID &gt; 0)
                    documentGroup.AddMenu(new TextIcon(&quot;lnkDeleteFolder&quot;, &quot;Delete&quot;, &quot;IcnFolderDelete.png&quot;));

                //Should be visible only if he is administrator
                if ((UserManager.Instance.IsUserAdministrator(UserDetail.GetCurrentUserDetail().UID)) || (FolderPermissions.Contains(&quot;ModifyP&quot;)))
                    documentGroup.AddMenu(new TextIcon(&quot;lnkPermissions&quot;, &quot;Permissions&quot;, &quot;Icn_permission_16.png&quot;));

                //If the Offline Documents feature is enabled, then show the Mark as Online/Offline menu

                if (AMP3ApplicationSettings.Instance.MobileEnableOfflineDocuments)
                {
                    if (!IsFolderAvailableOffline)
                        documentGroup.AddMenu(new TextIcon(&quot;lnkFolderMarkOffline&quot;, &quot;Mark Offline&quot;, &quot;Icn_AvailableOffline_16.png&quot;));
                    else
                        documentGroup.AddMenu(new TextIcon(&quot;lnkFolderMarkOnline&quot;, &quot;Mark Online&quot;, &quot;Icn_AvailableOnline_16.png&quot;));
                }

                if (documentGroup.Menus.Count &gt; 0)
                    menuGroups.Add(documentGroup);

                #endregion

                #region DocuSign Integration
                if (DOCMGMTModuleComponents.Contains(&quot;DocuSignIntegration&quot;))
                {
                    if (FolderPermissions.Contains(&quot;ViewD&quot;) &amp;&amp; FolderPermissions.Contains(&quot;Visibility&quot;) &amp;&amp; FolderPermissions.Contains(&quot;SignDocument&quot;))
                    {
                        MenuButton DocuSign = new MenuButton(&quot;lnkDocuSign&quot;, &quot;DocuSign&quot;, &quot;Icn_DocuSign.png&quot;, &quot;&quot;, &quot;Digital Signature using DocuSign&quot;);
                        DocuSign.ButtonSize = ButtonSize.Medium;
                        DocuSign.AddSubMenu(new TextIcon(&quot;lnkSignDocument&quot;, &quot;Sign Document&quot;, &quot;Icn_SignDoc.jpg&quot;));

                        if (DOCMGMTModuleComponents.Contains(&quot;DocuSignAdmin&quot;))
                        {
                            DocuSign.AddSubMenu(new TextIcon(&quot;lnkSendForSign&quot;, &quot;Send Document&quot;, &quot;Icn_SendDoc.jpg&quot;));
                            DocuSign.AddSubMenu(new TextIcon(&quot;lnkConsole&quot;, &quot;Admin Console&quot;, &quot;Icn_DocuSign.png&quot;));
                        }

                        generalGroup.AddMenu(DocuSign);
                    }
                }
                #endregion

                if (!(HttpContext.Current.Handler as Page).IsPostBack)
                {
                    DisableMenuItems(menuGroups, true);
                }
                return menuGroups;
            }
        }

        private BrixPageBase BasePage
        {
            get
            {
                return HttpContext.Current.Handler as BrixPageBase;
            }
        }

        #endregion

        #region Methods

        private void SetOfflineDetails()
        {
            bool isOffline = false, isOfflineBecauseOfParent = false;

            DocumentManager.Instance.GetOfflineSettingsForFolder(ProjectID, Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                        UserDetail.GetCurrentUserDetail().UID, out isOffline, out isOfflineBecauseOfParent);

            IsFolderAvailableOffline = isOffline;
            IsFolderAvailableOfflineBecauseOfParent = isOfflineBecauseOfParent;
        }

        public override bool CheckAccess(UserDetail ud)
        {
            int roleID;

            if (ModuleManager.Instance.IsEffectivePermissionOfRoles())
                roleID = 0;
            else
                roleID = ud.RID;

            List&lt;string&gt; perms = Aurigo.AMP3.DocumentManagementBL.DocumentManager.Instance.GetFolderPermissions((Request[&quot;FID&quot;]).ToInt32_2(),
                 string.IsNullOrEmpty(Request[PIDKey]) ? 0 : Request[PIDKey].ToInt32_2(), Request.QueryString[&quot;MID&quot;].ToString(),
                 Request.QueryString[&quot;IID&quot;].ToInt32_2(), ud.UID, roleID, true);

            if (perms.Contains(Constants.MODFEAT_VISIBILITY.ToLower()))
                return true;
            else
                return false;
        }

        /// &lt;summary&gt;
        /// Called when [initialize].
        /// &lt;/summary&gt;
        public override void OnInit()
        {
            SetOfflineDetails();

            base.OnInit();

            CurrentPage.LoadComplete += new EventHandler(Page_LoadComplete);

            RegisterClientScriptInclude(VirtualPathUtility.ToAbsolute(&quot;~/Scripts/jquery.swipebox.min.js&quot;));
            RegisterClientScriptInclude(VirtualPathUtility.ToAbsolute(&quot;~/Scripts/Document.js&quot;));
            CurrentPage.Header.Controls.Add(new LiteralControl(&quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;&quot; + VirtualPathUtility.ToAbsolute(&quot;~/css/swipebox.min.css&quot;) + &quot;\&quot; /&gt;&quot;));
            CurrentPage.Header.Controls.Add(new LiteralControl(&quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;&quot; + VirtualPathUtility.ToAbsolute(&quot;~/css/DOCMGMT_Slideshow.css&quot;) + &quot;\&quot; /&gt;&quot;));
            CurrentPage.Header.Controls.Add(new LiteralControl(&quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;&quot; + VirtualPathUtility.ToAbsolute(&quot;~/css/jquery.fancygallery.css&quot;) + &quot;\&quot; /&gt;&quot;));

            //if a user is not invited to a project he should not be able to view this page
            //this check is required because for download document, we are giving a direct link to this page
            Dictionary&lt;int, string&gt; invitedUsers = ProjectManager.Instance.GetProjectUserDetails(ProjectID);
            UserDetail ud = UserDetail.GetCurrentUserDetail();
            if (ProjectID &gt; 0 &amp;&amp; !Request.QueryString.Get(&quot;MID&quot;).Equals(&quot;ENTPRSE&quot;))
            {
                if (!invitedUsers.ContainsKey(ud.UID) &amp;&amp; ud.RID != 1)
                    UIHelper.RedirectURL(&quot;The current role does not have the required permissions to view this page.&quot;,
                        Constants.URL_ENTERPRISE, null, HttpContext.Current);
            }

            Page pg = (HttpContext.Current.CurrentHandler as Page);
            versionHistory = (VersionHistory)pg.LoadControl(VirtualPathUtility.ToAbsolute(&quot;~/Modules/UserControls/VersionHistory.ascx&quot;));
            pg.Form.Controls.Add(versionHistory);
            btnLoadVerHistory = new Button();
            btnLoadVerHistory.ID = &quot;btnLoadVerHistory&quot;;
            btnLoadVerHistory.Style.Add(&quot;display&quot;, &quot;none&quot;);
            pg.Form.Controls.Add(btnLoadVerHistory);

            popupExtender = (ModalPopupExtender)pg.LoadControl(&quot;~/Modules/UserControls/ModalPopup.ascx&quot;);
            pg.Form.Controls.Add(popupExtender);

            appDocumentMove = (DocumentMove)pg.LoadControl(&quot;~/Modules/UserControls/DocumentMove.ascx&quot;);
            pg.Form.Controls.Add(appDocumentMove);
            appDocumentMove.CurLogInUser = UserDetail.GetCurrentUserDetail().UID.ToString2();
            appDocumentMove.DocOperation = DocumentOperation.Move;
            appDocumentMove.InstanceID = Request.QueryString[&quot;IID&quot;];
            appDocumentMove.ModuleID = Request.QueryString[&quot;MID&quot;];
            appDocumentMove.ProjectId = Request.QueryString[&quot;PID&quot;];
            appDocumentMove.NodeClicked += DocMove_NodeClicked;
            btnPopupExtenderForMove = new Button();
            btnPopupExtenderForMove.ID = &quot;btnPopupExtenderForMove&quot;;
            btnPopupExtenderForMove.Style.Add(&quot;display&quot;, &quot;none&quot;);
            pg.Form.Controls.Add(btnPopupExtenderForMove);

            appDocumentCopy = (DocumentMove)pg.LoadControl(&quot;~/Modules/UserControls/DocumentMove.ascx&quot;);
            pg.Form.Controls.Add(appDocumentCopy);
            appDocumentCopy.CurLogInUser = UserDetail.GetCurrentUserDetail().UID.ToString2();
            appDocumentCopy.DocOperation = DocumentOperation.Copy;
            appDocumentCopy.InstanceID = Request.QueryString[&quot;IID&quot;];
            appDocumentCopy.ModuleID = Request.QueryString[&quot;MID&quot;];
            appDocumentCopy.ProjectId = Request.QueryString[&quot;PID&quot;];
            appDocumentCopy.NodeClicked += DocMove_NodeClicked;
            btnPopupExtenderForCopy = new Button();
            btnPopupExtenderForCopy.ID = &quot;btnPopupExtenderForCopy&quot;;
            btnPopupExtenderForCopy.Style.Add(&quot;display&quot;, &quot;none&quot;);
            pg.Form.Controls.Add(btnPopupExtenderForCopy);

            appDocumentTransmit = (DocumentMove)pg.LoadControl(&quot;~/Modules/UserControls/DocumentMove.ascx&quot;);
            pg.Form.Controls.Add(appDocumentTransmit);
            appDocumentTransmit.CurLogInUser = UserDetail.GetCurrentUserDetail().UID.ToString2();
            appDocumentTransmit.DocOperation = DocumentOperation.Transmit;
            appDocumentTransmit.InstanceID = Request.QueryString[&quot;IID&quot;];
            appDocumentTransmit.ModuleID = Request.QueryString[&quot;MID&quot;];
            appDocumentTransmit.ProjectId = Request.QueryString[&quot;PID&quot;];
            appDocumentTransmit.NodeClicked += DocMove_NodeClicked;
            btnPopupExtenderForTransmit = new Button();
            btnPopupExtenderForTransmit.ID = &quot;btnPopupExtenderForTransmit&quot;;
            btnPopupExtenderForTransmit.Style.Add(&quot;display&quot;, &quot;none&quot;);
            pg.Form.Controls.Add(btnPopupExtenderForTransmit);

            approvalHistory = (ApprovalHistory)pg.LoadControl(&quot;~/Modules/UserControls/ApprovalHistory.ascx&quot;);
            pg.Form.Controls.Add(approvalHistory);
            appWorkflowUserOverriding = (WorkflowUserOverriding)pg.LoadControl(&quot;~/Modules/UserControls/WorkflowUserOverriding.ascx&quot;);
            pg.Form.Controls.Add(appWorkflowUserOverriding);
            documentFolder = (DocumentFolder)pg.LoadControl(&quot;~/Modules/UserControls/DocumentFolder.ascx&quot;);
            pg.Form.Controls.Add(documentFolder);
            documentFolder.SetInstanceID(Request.QueryString.Get(&quot;IID&quot;), Request.QueryString.Get(&quot;MID&quot;), Request.QueryString[&quot;FID&quot;], Request[&quot;PID&quot;], UserDetail.GetCurrentUserDetail().UID.ToString2());

            appDocumentMnlAssociation = (DocumentManualAssociation)pg.LoadControl(&quot;~/Modules/UserControls/DocumentManualAssociation.ascx&quot;);
            appDocumentMnlAssociation.InstanceID = Request.QueryString[&quot;PID&quot;].ToInt32_2();
            appDocumentMnlAssociation.ModuleID = Request.QueryString[&quot;MID&quot;].ToString2();
            appDocumentMnlAssociation.GridID = mwGrid.ClientID;
            pg.Form.Controls.Add(appDocumentMnlAssociation);
            appDocumentMnlAssociation.MAssociate += btnMnlAssociate_Click;
            btnOpenPnlMnlAssociate = new Button();
            btnOpenPnlMnlAssociate.ID = &quot;btnOpenPnlMnlAssociate&quot;;
            btnOpenPnlMnlAssociate.Style.Add(&quot;display&quot;, &quot;none&quot;);
            pg.Form.Controls.Add(btnOpenPnlMnlAssociate);

            btnFolderMenuNew = new Button();
            btnFolderMenuNew.ID = &quot;btnFolderMenuNew&quot;;
            btnFolderMenuNew.Style.Add(&quot;display&quot;, &quot;none&quot;);
            pg.Form.Controls.Add(btnFolderMenuNew);

            btnFolderMenuEdit = new Button();
            btnFolderMenuEdit.ID = &quot;btnFolderMenuEdit&quot;;
            btnFolderMenuEdit.Style.Add(&quot;display&quot;, &quot;none&quot;);
            pg.Form.Controls.Add(btnFolderMenuEdit);

            btnWFHistory = (Button)pg.Master.FindControl(&quot;btnWFHistory&quot;);
            btnWFUserOverriding = new Button();
            btnWFUserOverriding.ID = &quot;btnWFUserOverriding&quot;;
            btnWFUserOverriding.Style.Add(&quot;display&quot;, &quot;none&quot;);
            pg.Form.Controls.Add(btnWFUserOverriding);

            HtmlGenericControl divShowThumb = new HtmlGenericControl(&quot;DIV&quot;);
            divShowThumb.ID = &quot;divShowThumb&quot;;
            divShowThumb.Attributes.Add(&quot;display&quot;, &quot;none&quot;);
            divShowThumb.Style.Add(&quot;position&quot;, &quot;absolute&quot;);
            divShowThumb.Style.Add(&quot;top&quot;, &quot;10%&quot;);
            pg.Form.Controls.Add(divShowThumb);

            string errFolderDuplication = string.Empty;
            if ((HttpContext.Current.CurrentHandler as Page).Session[&quot;FolderNameAlreadyExists&quot;] != null)
                errFolderDuplication = (HttpContext.Current.CurrentHandler as Page).Session[&quot;FolderNameAlreadyExists&quot;].ToString();

            if (errFolderDuplication != &quot;&quot; &amp;&amp; errFolderDuplication != string.Empty)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(HttpContext.Current.CurrentHandler.GetType(), &quot;FolderNameAlreadyExists&quot;, &quot;ShowError(&#39;&quot; + errFolderDuplication + &quot;&#39;);&quot;, true);
                (HttpContext.Current.CurrentHandler as Page).Session[&quot;FolderNameAlreadyExists&quot;] = &quot;&quot;;
            }
            HtmlGenericControl divSlideShow;
            divSlideShow = (HtmlGenericControl)((Page)HttpContext.Current.CurrentHandler).Form.FindControl(&quot;divSlideShow&quot;);
            if (divSlideShow == null)
            {
                divSlideShow = new HtmlGenericControl(&quot;DIV&quot;);
                divSlideShow.ID = &quot;divSlideShow&quot;;

                ((Page)HttpContext.Current.CurrentHandler).Form.Controls.Add(divSlideShow);
            }
        }

        public override void Page_Load()
        {
            Page = HttpContext.Current.Handler as Page;

            RegisterJavaScriptFunctionDefinitions();

            if (!Page.IsPostBack)
            {
                //if DTD (DocumentToDownload) exists in QueryString it means it is a link to download a file
                //from the edit properties page
                //to download the file we register a javascript which will load the page in a IFRAME
                int docToDownload = 0;
                if (Request.QueryString[&quot;DTD&quot;] != null
                    &amp;&amp; int.TryParse(Request.QueryString[&quot;DTD&quot;].ToString(), out docToDownload)
                    &amp;&amp; docToDownload &gt; 0)
                {
                    if (FolderPermissions.Contains(&quot;ViewD&quot;) &amp;&amp; FolderPermissions.Contains(&quot;DownloadD&quot;))
                    {
                        if (Request.QueryString[&quot;Version&quot;] != null &amp;&amp; Request.QueryString[&quot;Version&quot;].ToInt32_2() != 0)
                            RegisterDownloadFileScript(docToDownload, false, Request.QueryString[&quot;Version&quot;].ToInt32_2());
                        else
                        {
                            RegisterDownloadFileScript(docToDownload, false, 0);
                        }
                    }
                    else
                        throw new Exception(&quot;The current role does not have the required permissions to view this document.&quot;);
                }

                if (DOCMGMTModuleComponents.Contains(&quot;DocuSignIntegration&quot;))
                {
                    string errDocuSign = string.Empty;
                    if ((HttpContext.Current.CurrentHandler as Page).Session[&quot;DocuSignErr&quot;] != null)
                        errDocuSign = (HttpContext.Current.CurrentHandler as Page).Session[&quot;DocuSignErr&quot;].ToString();

                    if (!string.IsNullOrEmpty(errDocuSign))
                    {
                        ShowError(errDocuSign);
                        (HttpContext.Current.CurrentHandler as Page).Session.Remove(&quot;DocuSignErr&quot;);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// Customizes the tool bar menu.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;toolBar&quot;&gt;The tool bar.&lt;/param&gt;
        public override void CustomizeToolBarMenu(ToolBar toolBar)
        {
            string validateOneRecordSelected = string.Format(&quot;return lnkValidation(&#39;{0}&#39;, &#39;{1}&#39;, &#39;{2}&#39;);&quot;, Convert.ToInt32(ValidateSelection.OneItem, CultureInfo.CurrentCulture), mwGrid.ClientID, QueryStringName);

            base.CustomizeToolBarMenu(toolBar);

            if (toolBar.GetMenuReference(&quot;lnkView&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkView&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                    Convert.ToInt32(
                                                                        ValidateSelection.OneItem,
                                                                        CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                    mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                    QueryStringName +
                                                                    &quot;&#39;);&quot;;
            }
            if (toolBar.GetMenuReference(&quot;lnkEdit&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkEdit&quot;).OnClientClick = &quot;return ShowEditPopup(&#39;&quot; + mwGrid.ClientID + &quot;&#39;);&quot;;
            }

            if (toolBar.GetMenuReference(&quot;lnkDelete&quot;) != null)
                toolBar.GetMenuReference(&quot;lnkDelete&quot;).OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                                                                      Convert.ToInt32(
                                                                          ValidateSelection.OneOrMoreItems,
                                                                          CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                      mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                        QueryStringName +
                                                                        &quot;&#39;)){ return confirm(DocumentDeleteConfirmMessage(&#39;&quot; + mwGrid.ClientID + &quot;&#39;)); } else return false;&quot;;

            if (toolBar.GetMenuReference(&quot;lnkNewSubfolder&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkNewSubfolder&quot;).OnClientClick = &quot;ShowPopup(&#39;Folder&#39;,1,&#39;&quot; + mwGrid.ClientID +
                                                                            &quot;&#39;,&#39;&quot; + btnFolderMenuNew.ClientID + &quot;&#39;,&#39;&quot; +
                                                                            UIHelper.JavascriptEncode(FolderName) + &quot;&#39;);return false;&quot;;
                popupExtender.AddNewPopup(documentFolder.aspPnlFolder.ClientID, btnFolderMenuNew.ClientID,
                    documentFolder.btnFolderCancel.ClientID, 200, 400, &quot;New Folder&quot;);
                documentFolder.btnFolderCancel.Attributes.Add(&quot;onclick&quot;,
                    string.Format(&quot;$(&#39;#{0}&#39;).dialog(&#39;close&#39;); return false;&quot;, documentFolder.aspPnlFolder.ClientID));
            }

            if (toolBar.GetMenuReference(&quot;lnkEditFolder&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkEditFolder&quot;).OnClientClick = &quot;ShowPopup(&#39;Folder&#39;,2,&#39;&quot; + mwGrid.ClientID +
                                                                          &quot;&#39;,&#39;&quot; + btnFolderMenuNew.ClientID + &quot;&#39;,&#39;&quot; +
                                                                          UIHelper.JavascriptEncode(FolderName) + &quot;&#39;);return false;&quot;;
                popupExtender.AddNewPopup(documentFolder.aspPnlFolder.ClientID, btnFolderMenuEdit.ClientID,
                    documentFolder.btnFolderCancel.ClientID, 200, 400, &quot;Edit Folder&quot;);
            }
            if (toolBar.GetMenuReference(&quot;lnkDeleteFolder&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkDeleteFolder&quot;).OnClientClick = &quot;return ShowPopup(&#39;Folder&#39;,3,&#39;&quot; +
                                                                            mwGrid.ClientID + &quot;&#39;,&#39;&quot; +
                                                                            btnFolderMenuNew.ClientID + &quot;&#39;,&#39;&quot; +
                                                                            UIHelper.JavascriptEncode(FolderName) + &quot;&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkDeleteFolder&quot;).Click += btnDelFolder_Click;
            }
            if (toolBar.GetMenuReference(&quot;lnkWorkFlowHistory&quot;) != null)
            {
                approvalHistory.SetInstanceID(mwGrid, &quot;XDOCMGT&quot;);

                toolBar.GetMenuReference(&quot;lnkWorkFlowHistory&quot;).OnClientClick =
                    string.Format(
                        &quot;if(lnkValidation(&#39;{0}&#39;, &#39;{1}&#39;, &#39;{2}&#39;)) {{ LoadWorkfowHistory(); ShowWFPopup(&#39;{3}&#39;); }} return false;&quot;,
                        Convert.ToInt32(ValidateSelection.OneItem, CultureInfo.CurrentCulture), mwGrid.ClientID,
                        QueryStringName, btnWFHistory.ClientID);

                popupExtender.AddNewPopup(approvalHistory.aspPnlWF.ClientID, btnWFHistory.ClientID,
                    approvalHistory.btnCncl.ClientID, 450, 600, &quot;Workflow History&quot;);
                approvalHistory.btnCncl.Attributes.Add(&quot;onclick&quot;,
                    string.Format(&quot;$(&#39;#{0}&#39;).dialog(&#39;close&#39;); return false;&quot;, approvalHistory.aspPnlWF.ClientID));
            }
            if (toolBar.GetMenuReference(&quot;lnkWorkFlowUserOverriding&quot;) != null)
            {
                appWorkflowUserOverriding.SetInstanceID(mwGrid, &quot;XDOCMGT&quot;);

                toolBar.GetMenuReference(&quot;lnkWorkFlowUserOverriding&quot;).OnClientClick =
                    string.Format(&quot;{{ LoadWorkflowUserOverriding(&#39;{1}&#39;, &#39;{3}&#39;);}} return false;&quot;,
                        ValidateSelection.None.ToInt32_2(), mwGrid.ClientID, QueryStringName,
                        btnWFUserOverriding.ClientID);

                popupExtender.AddNewPopup(appWorkflowUserOverriding.aspPnlWF.ClientID, btnWFUserOverriding.ClientID,
                    appWorkflowUserOverriding.btnCncl.ClientID, 450, 600, &quot;Workflow User(s)&quot;);
                appWorkflowUserOverriding.btnCncl.Attributes.Add(&quot;onclick&quot;,
                    string.Format(&quot;$(&#39;#{0}&#39;).dialog(&#39;close&#39;); return false;&quot;,
                        appWorkflowUserOverriding.aspPnlWF.ClientID));
            }
            if (toolBar.GetMenuReference(&quot;lnkCheckOut&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkCheckOut&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                        Convert.ToInt32(
                                                                            ValidateSelection.OneOrMoreItems,
                                                                            CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                        mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                        QueryStringName + &quot;&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkCheckOut&quot;).Click += lnkCheckOut_Click;
            }
            if (toolBar.GetMenuReference(&quot;lnkDownload&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkDownload&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                        Convert.ToInt32(
                                                                            ValidateSelection.OneItem,
                                                                            CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                        mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                        QueryStringName + &quot;&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkDownload&quot;).Click += lnkDownload_ServerClick;
            }

            if (toolBar.GetMenuReference(&quot;lnkUndoCheckOut&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkUndoCheckOut&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                            Convert.ToInt32(
                                                                                ValidateSelection.OneOrMoreItems,
                                                                                CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                            mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                            QueryStringName + &quot;&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkUndoCheckOut&quot;).Click += lnkUndoCheckOut_ServerClick;
            }
            if (toolBar.GetMenuReference(&quot;lnkCheckIn&quot;) != null)
                toolBar.GetMenuReference(&quot;lnkCheckIn&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                       Convert.ToInt32(
                                                                           ValidateSelection.OneItem,
                                                                           CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                       mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                       QueryStringName + &quot;&#39;);&quot;;

            if (toolBar.GetMenuReference(&quot;lnkVersionHistory&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkVersionHistory&quot;).OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                                                                              Convert.ToInt32(
                                                                                  ValidateSelection.OneItem,
                                                                                  CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                              mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                              QueryStringName +
                                                                              &quot;&#39;)){ if (grdVersionHistory_IsRowSelected(&#39;&quot; +
                                                                              mwGrid.ClientID +
                                                                              &quot;&#39;,&#39;StorageId&#39;)) { ShowWFPopup(&#39;&quot; +
                                                                              btnLoadVerHistory.ID + &quot;&#39;);$(&#39;#&quot; +
                                                                              versionHistory.btnLoadVersion.ClientID +
                                                                              &quot;&#39;).click();}return false;} else return false;&quot;;
                popupExtender.AddNewPopup(versionHistory.aspPnlWF.ClientID, btnLoadVerHistory.ClientID,
                    versionHistory.btnCncl.ClientID, 450, 600, &quot;Version History&quot;);
                versionHistory.btnCncl.Attributes.Add(&quot;onclick&quot;,
                    string.Format(&quot;$(&#39;#{0}&#39;).dialog(&#39;close&#39;); return false;&quot;, versionHistory.aspPnlWF.ClientID));
            }
            if (toolBar.GetMenuReference(&quot;lnkMove&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkMove&quot;).OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                                                                    Convert.ToInt32(
                                                                        ValidateSelection.OneOrMoreItems,
                                                                        CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                    mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                    QueryStringName +
                                                                    &quot;&#39;)){ if (BeforeDocMove(&#39;&quot; + mwGrid.ClientID +
                                                                    &quot;&#39;)) { ShowWFPopup(&#39;&quot; + btnPopupExtenderForMove.ID +
                                                                    &quot;&#39;);}return false;} else return false;&quot;;


                popupExtender.AddNewPopup(appDocumentMove.aspPnlDM.ClientID, btnPopupExtenderForMove.ClientID,
                    appDocumentMove.btnCncl.ClientID, 350, 400, &quot;Move Document&quot;);
                appDocumentMove.btnCncl.Attributes.Add(&quot;onclick&quot;,
                    string.Format(&quot;$(&#39;#{0}&#39;).dialog(&#39;close&#39;); return false;&quot;, appDocumentMove.aspPnlDM.ClientID));
                //Closing the popup window                
            }
            if (toolBar.GetMenuReference(&quot;lnkCopy&quot;) != null)
            {
                string copyScript =
                    string.Format(
                        &quot;if (BeforeDocMove()) {{ ShowWFPopup(&#39;{0}&#39;); return false; }} else {{ return false; }}&quot;,
                        btnPopupExtenderForCopy.ClientID);

                toolBar.GetMenuReference(&quot;lnkCopy&quot;).OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                                                                    Convert.ToInt32(
                                                                        ValidateSelection.OneOrMoreItems,
                                                                        CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                    mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                    QueryStringName +
                                                                    &quot;&#39;)){ &quot; + copyScript + &quot; } else return false;&quot;;

                popupExtender.AddNewPopup(appDocumentCopy.aspPnlDM.ClientID, btnPopupExtenderForCopy.ClientID,
                    appDocumentCopy.btnCncl.ClientID, 350, 400, &quot;Copy Document&quot;);
                appDocumentCopy.btnCncl.Attributes.Add(&quot;onclick&quot;,
                    string.Format(&quot;$(&#39;#{0}&#39;).dialog(&#39;close&#39;); return false;&quot;, appDocumentCopy.aspPnlDM.ClientID));
                //Closing the popup window                
            }
            if (toolBar.GetMenuReference(&quot;lnkTransmit&quot;) != null)
            {
                string transmitScript =
                    string.Format(
                        &quot;if (BeforeDocMove()) {{ ShowWFPopup(&#39;{0}&#39;); return false; }} else {{ return false; }}&quot;,
                        btnPopupExtenderForTransmit.ClientID);
                toolBar.GetMenuReference(&quot;lnkTransmit&quot;).OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                                                                        Convert.ToInt32(
                                                                            ValidateSelection.OneOrMoreItems,
                                                                            CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                        mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                        QueryStringName +
                                                                        &quot;&#39;)){ &quot; + transmitScript +
                                                                        &quot; } else return false;&quot;;
                popupExtender.AddNewPopup(appDocumentTransmit.aspPnlDM.ClientID, btnPopupExtenderForTransmit.ClientID,
                    appDocumentTransmit.btnCncl.ClientID, 350, 400, &quot;Transmit Document&quot;);
                appDocumentTransmit.btnCncl.Attributes.Add(&quot;onclick&quot;,
                    string.Format(&quot;$(&#39;#{0}&#39;).dialog(&#39;close&#39;); return false;&quot;, appDocumentTransmit.aspPnlDM.ClientID));
                //Closing the popup window                
            }

            if (toolBar.GetMenuReference(&quot;lnkArchive&quot;) != null)
                toolBar.GetMenuReference(&quot;lnkArchive&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                       Convert.ToInt32(
                                                                           ValidateSelection.OneOrMoreItems,
                                                                           CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                       mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                       QueryStringName + &quot;&#39;);&quot;;

            if (toolBar.GetMenuReference(&quot;lnkSlideShow&quot;) != null)
                toolBar.GetMenuReference(&quot;lnkSlideShow&quot;).OnClientClick = &quot;return startSlideShow();&quot;;

            if (toolBar.GetMenuReference(&quot;lnkThumb&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkThumb&quot;).OnClientClick = &quot;return ShowThumb();&quot;;
            }

            List&lt;string&gt; CheckComponents =
                 Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);
            if (CheckComponents.Contains(&quot;ShowCommentLog&quot;))
            {
                //sub menu under report
                if (toolBar.GetMenuReference(&quot;lnkReportClr&quot;) != null)
                {
                    toolBar.GetMenuReference(&quot;lnkReportClr&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                             Convert.ToInt32(
                                                                                 ValidateSelection.OneItem,
                                                                                 CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                             mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                             QueryStringName + &quot;&#39;);&quot;;
                    toolBar.GetMenuReference(&quot;lnkReportClr&quot;).Click += new EventHandler(lnkReportClr_Click);
                }
            }
            if (toolBar.GetMenuReference(&quot;lnkPermissions&quot;) != null)
                toolBar.GetMenuReference(&quot;lnkPermissions&quot;).Click += lnkPermissions_Click;
            if (toolBar.GetMenuReference(&quot;lnkCommentLog&quot;) != null)
                toolBar.GetMenuReference(&quot;lnkCommentLog&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                          Convert.ToInt32(
                                                                              ValidateSelection.OneItem,
                                                                              CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                          mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                          QueryStringName + &quot;&#39;);&quot;;

            if (toolBar.GetMenuReference(&quot;lnkMerge&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkMerge&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                     Convert.ToInt32(
                                                                         ValidateSelection.OneItem,
                                                                         CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                     mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                     QueryStringName + &quot;&#39;);&quot;;
            }

            #region Auto Association

            if (toolBar.GetMenuReference(&quot;lnkAutoAssociate&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkAutoAssociate&quot;).OnClientClick =
                    &quot;return confirm(&#39;The existing associations for the selected files with their respective Parent drawings will be lost. Do you want to proceed?&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkAutoAssociate&quot;).Click += lnkAutoAssociate_Click;
            }
            Aurigo.AMP3.Core.UserControls.Menu lnkManuallyAssociate = toolBar.GetMenuReference(&quot;lnkManuallyAssociate&quot;);
            if (lnkManuallyAssociate != null)
            {
                lnkManuallyAssociate.OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                                                     Convert.ToInt32(
                                                         ValidateSelection.OneOrMoreItems,
                                                         CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                     mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                     QueryStringName + &quot;&#39;)){ShowWFPopup(&#39;&quot; + btnOpenPnlMnlAssociate.ID +
                                                     &quot;&#39;);return false;}else return false;&quot;;
                //Pending
                popupExtender.AddNewPopup(appDocumentMnlAssociation.aspPnlMnlAstn.ClientID,
                    btnOpenPnlMnlAssociate.ClientID, appDocumentMnlAssociation.btnCancelMnlAssociate.ClientID, 200, 750,
                    &quot;Manually Associate Documents&quot;);


                appDocumentMnlAssociation.btnCancelMnlAssociate.Attributes.Add(&quot;onclick&quot;,
                    string.Format(&quot;$(&#39;#{0}&#39;).dialog(&#39;close&#39;); return false;&quot;,
                        appDocumentMnlAssociation.aspPnlMnlAstn.ClientID));
            }

            if (toolBar.GetMenuReference(&quot;lnkRemoveAssociation&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkRemoveAssociation&quot;).OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                                                                                 Convert.ToInt32(
                                                                                     ValidateSelection.OneOrMoreItems,
                                                                                     CultureInfo.CurrentCulture) +
                                                                                 &quot;&#39;, &#39;&quot; +
                                                                                 mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                                 QueryStringName +
                                                                                 &quot;&#39;)) return confirm(&#39;The existing associations of the selected file(s) will be lost. Do you want to proceed?&#39;); else return false;&quot;;
                toolBar.GetMenuReference(&quot;lnkRemoveAssociation&quot;).Click += lnkRemoveAssociation_Click;
            }
            if (toolBar.GetMenuReference(&quot;lnkGetPackage&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkGetPackage&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                          Convert.ToInt32(
                                                                              ValidateSelection.OneOrMoreItems,
                                                                              CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                          mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                          QueryStringName + &quot;&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkGetPackage&quot;).Click += lnkGetPackage_Click;
            }

            #endregion

            #region Review &amp; Consolidate

            Aurigo.AMP3.Core.UserControls.Menu lnkReviewDocument = toolBar.GetMenuReference(&quot;lnkReviewDocument&quot;);
            if (lnkReviewDocument != null)
            {
                lnkReviewDocument.OnClientClick = validateOneRecordSelected;
                lnkReviewDocument.Click += lnkReviewDocument_Click;
            }

            Aurigo.AMP3.Core.UserControls.Menu lnkConsolidate = toolBar.GetMenuReference(&quot;lnkConsolidate&quot;);
            if (lnkConsolidate != null)
            {
                lnkConsolidate.OnClientClick = validateOneRecordSelected;
                lnkConsolidate.Click += lnkConsolidate_Click;
            }

            #endregion

            #region DocuSign Integration
            if (DOCMGMTModuleComponents.Contains(&quot;DocuSignIntegration&quot;))
            {
                AMP3.Core.UserControls.Menu lnkSignDocument = toolBar.GetMenuReference(&quot;lnkSignDocument&quot;);
                AMP3.Core.UserControls.Menu lnkSendForSign = toolBar.GetMenuReference(&quot;lnkSendForSign&quot;);
                AMP3.Core.UserControls.Menu lnkConsole = toolBar.GetMenuReference(&quot;lnkConsole&quot;);

                if (lnkSignDocument != null)
                    lnkSignDocument.Click += new EventHandler(SignDocuments_Click);

                if (lnkSendForSign != null)
                    lnkSendForSign.Click += new EventHandler(SendDocumentsForSign_Click);

                if (lnkConsole != null)
                    lnkConsole.Click += new EventHandler(DocuSignConsole_Click);
            }
            #endregion

            if (toolBar.GetMenuReference(&quot;lnkDocMarkOffline&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkDocMarkOffline&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                         Convert.ToInt32(
                                                                             ValidateSelection.OneOrMoreItems,
                                                                             CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                         mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                         QueryStringName + &quot;&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkDocMarkOffline&quot;).Click += lnkDocMarkOffline_Click;
            }

            if (toolBar.GetMenuReference(&quot;lnkDocMarkOnline&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkDocMarkOnline&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                        Convert.ToInt32(
                                                                            ValidateSelection.OneOrMoreItems,
                                                                            CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                        mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                        QueryStringName + &quot;&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkDocMarkOnline&quot;).Click += lnkDocMarkOnline_Click;
            }

            if (toolBar.GetMenuReference(&quot;lnkFolderMarkOffline&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkFolderMarkOffline&quot;).Click += lnkFolderMarkOffline_Click;
            }

            if (toolBar.GetMenuReference(&quot;lnkFolderMarkOnline&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkFolderMarkOnline&quot;).Click += lnkFolderMarkOnline_Click;
            }


            if (toolBar.GetMenuReference(&quot;lnkMailMerge&quot;) != null)
                toolBar.HideMenu(&quot;lnkMailMerge&quot;, true);


            if (toolBar.GetMenuReference(&quot;lnkAnnotations&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkAnnotations&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                          Convert.ToInt32(
                                                                              ValidateSelection.OneItem,
                                                                              CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                          mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                          QueryStringName + &quot;&#39;);&quot;;
                toolBar.GetMenuReference(&quot;lnkAnnotations&quot;).Click += lnkAnnotations_Click;
            }

        }

        private void lnkAnnotations_Click(object sender, EventArgs e)
        {
            int docid;
            int versionNo;
            string docType;
            GridDataItem GridRow = MWGrid.GetSelectedRow&lt;RadGrid&gt;(mwGrid) as GridDataItem;

            if (GridRow == null)
            {
                ShowError(&quot;Please select a record.&quot;);
            }
            else
            {
                docid = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;DocId&quot;).ToInt32_2();
                versionNo = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;VersionNo&quot;).ToInt32_2();
                docType = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;DocType&quot;).ToString2();

                if (DocumentManager.Instance.DocTypes.Contains(docType.ToLower()))
                {
                    int linkId = DocumentManager.Instance.GetLinkIdForDocument(docid, Request.QueryString[&quot;MID&quot;].ToString(), Request.QueryString[&quot;IID&quot;].ToInt32_2());
                    string backURL = HttpContext.Current.Request.Url.PathAndQuery;
                    string mode = &quot;Edit&quot;; //hardcoded to edit because in document management anybody with view permission on document should be able to annotate
                    Response.Redirect(string.Format(&quot;~/Common/BrixListPage.aspx?xContext=DOCANOT&amp;DocID={0}&amp;versionNo={1}&amp;LinkID={2}&amp;Mode={3}&amp;BackURL={4}&quot;, docid, versionNo, linkId, mode, HttpContext.Current.Server.UrlEncode(backURL)));
                }
                else
                {
                    ShowError(&quot;The document format does not support annotation&quot;);
                }
            }
        }

        private void lnkFolderMarkOnline_Click(object sender, EventArgs e)
        {
            if (IsFolderAvailableOfflineBecauseOfParent)
                ShowError(&quot;Cannot modify the folder when the parent folder is available offline&quot;);
            else
            {
                DocumentManager.Instance.CreateOrUpdateDocumentOfflineSettings(OfflineSettingsType.Folder.ToString(),
                    Request.QueryString[&quot;FID&quot;], ProjectID, UserDetail.GetCurrentUserDetail().UID, MWDateTimeHelper.UtcNow, false);
                Response.Redirect(Request.RawUrl);
            }
        }

        private void lnkFolderMarkOffline_Click(object sender, EventArgs e)
        {
            if (IsFolderAvailableOfflineBecauseOfParent)
                ShowError(&quot;Cannot modify the folder when the parent folder is available offline&quot;);
            else
            {
                DocumentManager.Instance.CreateOrUpdateDocumentOfflineSettings(OfflineSettingsType.Folder.ToString(),
                    Request.QueryString[&quot;FID&quot;], ProjectID, UserDetail.GetCurrentUserDetail().UID, MWDateTimeHelper.UtcNow, true);
                Response.Redirect(Request.RawUrl);
            }
        }

        private void lnkDocMarkOffline_Click(object sender, EventArgs e)
        {
            if (IsFolderAvailableOffline || IsFolderAvailableOfflineBecauseOfParent)
                ShowError(&quot;Cannot modify the document(s) when the folder is available offline.&quot;);
            else
            {
                DocumentManager.Instance.CreateOrUpdateDocumentOfflineSettings(OfflineSettingsType.Document.ToString(),
                  GetSelectedItemsFromGrid(&quot;LinkID&quot;), ProjectID, UserDetail.GetCurrentUserDetail().UID, MWDateTimeHelper.UtcNow, true);
                Response.Redirect(Request.RawUrl);
            }
        }

        private void lnkDocMarkOnline_Click(object sender, EventArgs e)
        {
            if (IsFolderAvailableOffline || IsFolderAvailableOfflineBecauseOfParent)
                ShowError(&quot;Cannot modify the document(s) when the folder is available offline.&quot;);
            else
            {
                DocumentManager.Instance.CreateOrUpdateDocumentOfflineSettings(OfflineSettingsType.Document.ToString(),
                    GetSelectedItemsFromGrid(&quot;LinkID&quot;), ProjectID, UserDetail.GetCurrentUserDetail().UID, MWDateTimeHelper.UtcNow, false);
                Response.Redirect(Request.RawUrl);
            }
        }

        private void DisableMenuItems(List&lt;MenuGroup&gt; menuGroup, bool disable)
        {
            try
            {
                menuGroup.ForEach&lt;MenuGroup&gt;(mg =&gt; mg.Menus.ForEach(mi =&gt; mi.Enabled = !disable));

                (HttpContext.Current.Handler as Page).Session[&quot;DocListMenuGroup&quot;] = menuGroup;
            }
            catch (Exception ex)
            {
            }
        }

        protected void Page_LoadComplete(object sender, EventArgs e)
        {
            try
            {
                if (!(HttpContext.Current.Handler as Page).IsPostBack)
                {
                    var httpSessionState = (HttpContext.Current.Handler as Page).Session;
                    if (httpSessionState[&quot;DocListMenuGroup&quot;] != null)
                    {
                        List&lt;MenuGroup&gt; menuGroup = (List&lt;MenuGroup&gt;)httpSessionState[&quot;DocListMenuGroup&quot;];

                        DisableMenuItems(menuGroup, false);

                        //var jsonString = Newtonsoft.Json.JsonConvert.SerializeObject(menuGroup);
                        //Removing this session object as it is not referenced for 
                        //further usage. This can be replaced with Class Level variable to 
                        //handle this feature
                        httpSessionState.Remove(&quot;DocListMenuGroup&quot;);
                    }
                }
            }
            catch (Exception ex)
            {
            }
        }

        /// &lt;summary&gt;
        /// Sets the UI details.
        /// &lt;/summary&gt;
        public override void SetUIDetails()
        {
            ShowMapView = displayAddDynamicColumns = false;
            DisplayExport = false;
            displayApplyFilter = true;

            var FolderName =
                DocumentManager.Instance.GetFolderName(HttpContext.Current.Request.QueryString[&quot;FID&quot;].ToInt32_2(), true);
            header = String.IsNullOrEmpty(FolderName) ? LocalizationManager.GetString(&quot;Documents&quot;) : FolderName;


            //check if the project has any metadata and set col props for those columns
            BrixFormModel model =
                ProjectManager.Instance.GetProjectMetadataXMLModel(
                    HttpContext.Current.Request.QueryString[&quot;PID&quot;].ToInt32_2());



            int columnPosition = 1;
            ModifyColumnProperties(&quot;DocName&quot;, false, columnPosition++, null, null, false, &quot;Name&quot;);
            ModifyColumnProperties(&quot;DocDesc&quot;, false, columnPosition++, null, null, false, &quot;Title&quot;);
            if (DOCMGMTModuleComponents.Contains(&quot;DocuSignIntegration&quot;))
            {
                ModifyColumnProperties(&quot;SignedDocLink&quot;, false, columnPosition++, null, null, false, &quot;Signed Copy&quot;);
            }
            else
            {
                ModifyColumnProperties(&quot;SignedDocLink&quot;, true, null, null, null, false);
            }

            ModifyColumnProperties(&quot;IsTemplate&quot;, false, columnPosition++, null, null, false, &quot;Is Template&quot;);
            ModifyColumnProperties(&quot;IsAvailableOffline&quot;, false, columnPosition++, null, &quot;70&quot;, false, &quot;Is Available Offline&quot;);

            if (model != null)
            {

                model.form.ProcessAllControlsDeeply(control =&gt;
                {
                    if (control.Type == XMLForm.ControlType.Date)
                        ModifyColumnProperties(control.Name, false, columnPosition++, AMP3ApplicationSettings.Instance.FORMAT_DATE,
                            null, false,
                            (string.IsNullOrEmpty(control.Caption)
                                ? control.Name
                                : control.ParseDynamicString(control.Caption).TrimEnd(&quot;:&quot;.ToCharArray())), control.IsTimezoneApplicable);
                    else
                        ModifyColumnProperties(control.Name, false, columnPosition++, null, null, false,
                            (string.IsNullOrEmpty(control.Caption)
                                ? control.Name
                                : control.ParseDynamicString(control.Caption).TrimEnd(&quot;:&quot;.ToCharArray())), control.IsTimezoneApplicable);
                });
            }

            ModifyColumnProperties(&quot;AuthorName&quot;, false, columnPosition++, null, null, false, &quot;Created By&quot;);
            ModifyColumnProperties(&quot;CreationDate&quot;, false, columnPosition++, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;Created Date&quot;, true);
            ModifyColumnProperties(&quot;ModifiedBy&quot;, false, columnPosition++, null, null, false, &quot;Modified By&quot;);
            ModifyColumnProperties(&quot;ModifiedDate&quot;, false, columnPosition++, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;Modified Date&quot;, true);
            ModifyColumnProperties(&quot;DocType&quot;, false, columnPosition++, null, null, false, &quot;Extn&quot;);

            ModifyColumnProperties(&quot;DocSize&quot;, false, columnPosition++, null, null, false, &quot;Document Size&quot;);
            ModifyColumnProperties(&quot;CheckedByName&quot;, false, columnPosition++, null, null, false, &quot;Checked Out To&quot;);
            ModifyColumnProperties(&quot;VersionNo&quot;, false, columnPosition++, null, null, false, &quot;Version&quot;);
            ModifyColumnProperties(&quot;HasCommentLog&quot;, false, columnPosition++, null, null, false, &quot;Has Comment Log&quot;);

            if (!DOCMGMTModuleComponents.Contains(&quot;AutoCadIntegration&quot;))
            {
                ModifyColumnProperties(&quot;xrefCount&quot;, true, null, null, null, false);
                ModifyColumnProperties(&quot;renditionCount&quot;, true, null, null, null, false);
                ModifyColumnProperties(&quot;AssociationType&quot;, true, null, null, null, false);
                ModifyColumnProperties(&quot;missingCount&quot;, true, null, null, null, false);
                ModifyColumnProperties(&quot;DocOp&quot;, true, null, null, null, false);
            }
            else
            {
                ModifyColumnProperties(&quot;xrefCount&quot;, false, columnPosition++, null, null, false);
                ModifyColumnProperties(&quot;renditionCount&quot;, false, columnPosition++, null, null, false);
                ModifyColumnProperties(&quot;AssociationType&quot;, false, columnPosition++, null, null, false);
                ModifyColumnProperties(&quot;missingCount&quot;, false, columnPosition++, null, null, false);
                ModifyColumnProperties(&quot;DocOp&quot;, false, columnPosition++, null, null, false);
            }
            ModifyColumnProperties(&quot;WF_FStatus&quot;, false, columnPosition++, null, null, false);
            ModifyColumnProperties(&quot;WF_PendingOnRole&quot;, false, columnPosition++, null, null, false);
            ModifyColumnProperties(&quot;WF_PendingOnUser&quot;, false, columnPosition++, null, null, false);

            ModifyColumnProperties(&quot;DocId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;StorageId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;DocStatus&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ParentId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Author&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;CheckedBy&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;FolderId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;LinkID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;TypeId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;SrcModuleID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;WorkflowInstanceGuid&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;WF_FileID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;XMLInfo&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Buttons&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;PictureLink&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;LinkExists&quot;, true, null, null, null, false);
        }

        ///// &lt;summary&gt;
        ///// Sets the UI details.
        ///// &lt;/summary&gt;
        ///// &lt;param name=&quot;listModel&quot;&gt;The list model.&lt;/param&gt;
        //public override void SetUIDetails(ListModel listModel)
        //{
        //    base.SetUIDetails(listModel);
        //    DisplayExport = false;
        //    ModifyColumnProperties(&quot;DocId&quot;, true, null, null, null, false);
        //    ModifyColumnProperties(&quot;StorageId&quot;, true, null, null, null, false);
        //}

        /// &lt;summary&gt;
        /// Set Grid column properties after the binding to the grid...
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;grid&quot;&gt;The grid.&lt;/param&gt;
        public override void SetGridColumnProperties&lt;T&gt;(T grid)
        {
            base.SetGridColumnProperties(grid);
        }

        /// &lt;summary&gt;
        /// Gets the list.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pageSize&quot;&gt;Size of the page.&lt;/param&gt;
        /// &lt;param name=&quot;sortOrder&quot;&gt;The sort order.&lt;/param&gt;
        /// &lt;param name=&quot;filter&quot;&gt;The filter.&lt;/param&gt;
        /// &lt;param name=&quot;CurrentPage&quot;&gt;The current page.&lt;/param&gt;
        /// &lt;param name=&quot;count&quot;&gt;The count.&lt;/param&gt;
        /// &lt;returns&gt;DataSet.&lt;/returns&gt;
        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int CurrentPage, out int count)
        {
            int pagecount = 0;

            int startIdx = 1 + (pageSize * mwGrid.MasterTableView.CurrentPageIndex);
            DataTable dt = GetDocumentList(&quot;&quot;, startIdx, pageSize, ref pagecount);
            int rowCount = dt.Rows.Count;
            count = pagecount;

            if (count == 0) CurrentPage = 0;

            DataSet ds = new DataSet();
            ds.Tables.Add(dt);
            return ds;
        }

        public override void FormatColumns(RadGrid grid)
        {
            (grid.MasterTableView.AutoGeneratedColumns.Where(x =&gt; x.UniqueName == &quot;SignedDocLink&quot;).FirstOrDefault() as GridBoundColumn).HtmlEncode = false;
            grid.Rebind();
        }

        public override void OnPreRender()
        {
            base.OnPreRender();

            if (DOCMGMTModuleComponents.Contains(&quot;AutoCadIntegration&quot;))
            {
                if (mwGrid.MasterTableView.GetColumnSafe(&quot;DocOp&quot;) != null)
                {
                    (mwGrid.MasterTableView.GetColumnSafe(&quot;DocOp&quot;) as GridBoundColumn).AllowFiltering = false;
                    GridColumn gridCol = mwGrid.MasterTableView.GetColumn(&quot;DocOp&quot;);
                    gridCol.HeaderStyle.Width = Unit.Pixel(25);
                    mwGrid.Rebind();
                }

                foreach (GridDataItem item in mwGrid.MasterTableView.Items)
                {
                    if (item[&quot;AssociationType&quot;].Text.ToLower2() == &quot;rendition&quot;)
                        item.BackColor = System.Drawing.ColorTranslator.FromHtml(&quot;#b2b2b2&quot;);
                    if (Convert.ToInt32(item[&quot;missingCount&quot;].Text, CultureInfo.InvariantCulture) &gt; 0)
                        item.BackColor = System.Drawing.ColorTranslator.FromHtml(&quot;#F3B5A2&quot;);

                    string docOp = string.Empty;
                    if (item[&quot;AssociationType&quot;].Text.ToLower2() == &quot;xref&quot;)
                        docOp = &quot;XRefChild&quot;;
                    else if (Convert.ToInt32(item[&quot;xrefCount&quot;].Text) &gt; 1)
                        docOp = &quot;XRefParent&quot;;
                    else if (item[&quot;AssociationType&quot;].Text.ToLower2() == &quot;rendition&quot;)
                        docOp = &quot;RendDoc&quot;;
                    else docOp = item[&quot;DocOp&quot;].Text;

                    item[&quot;DocOp&quot;].Text = SetImage(docOp);
                }
            }
        }

        private string SetImage(string FileType)
        {
            switch (FileType)
            {
                case &quot;XRefParent&quot;:
                    return &quot;&lt;img src=\&quot;/Images/Officebar/XRefParent.png\&quot; title=&#39;XRefParent&#39; alt=&#39;Copied&#39;/&gt;&quot;;
                case &quot;XRefChild&quot;:
                    return &quot;&lt;img src=\&quot;/Images/Officebar/XRefChild.png\&quot; title=&#39;XRefChild&#39; alt=&#39;Copied&#39;/&gt;&quot;;
                case &quot;RendDoc&quot;:
                    return &quot;&lt;img src=\&quot;/Images/Officebar/Rendition.png\&quot; title=&#39;RenditionChild&#39; alt=&#39;Copied&#39;/&gt;&quot;;
                case &quot;C&quot;:
                    return &quot;&lt;img src=\&quot;/Images/Officebar/Icn_Copy2_16_Disable.png\&quot; title=&#39;Copied&#39; alt=&#39;Copied&#39;/&gt;&quot;;
                case &quot;T&quot;:
                    return
                        &quot;&lt;img src=\&quot;/Images/Officebar/Icn_transmitted-Document_16.png\&quot; title=&#39;Transmitted&#39; alt=&#39;Transmitted&#39;/&gt;&quot;;
                case &quot;P&quot;:
                    return
                        &quot;&lt;img src=\&quot;/Images/Officebar/Icn_Placeholder_16.png\&quot; title=&#39;Placeholder&#39; alt=&#39;Placeholder&#39;/&gt;&quot;;
                case &quot;MR&quot;:
                    return &quot;&lt;img src=\&quot;/Images/Officebar/Icn_document_merge_16.png\&quot; title=&#39;Merged&#39; alt=&#39;Merged&#39;/&gt;&quot;;
                case &quot;&quot;:
                    return &quot;&lt;img src=\&quot;/Images/Officebar/Icn_Normal-document_16.png\&quot; title=&#39;Normal&#39; alt=&#39;Normal&#39;/&gt;&quot;;
                case &quot;&amp;nbsp;&quot;:
                    return &quot;&lt;img src=\&quot;/Images/Officebar/Icn_Normal-document_16.png\&quot; title=&#39;Normal&#39; alt=&#39;Normal&#39;/&gt;&quot;;
            }
            return FileType;
        }

        /// &lt;summary&gt;
        /// Handles the new.
        /// &lt;/summary&gt;
        public override void HandleNew()
        {
            Response.Redirect(&quot;~/Modules/DOCMGMT/Documents.aspx?FID=&quot; + Request.QueryString[&quot;FID&quot;] + &quot;&amp;PID=&quot; +
                              Request.QueryString[&quot;PID&quot;] + &quot;&amp;IID=&quot; +
                              Request.QueryString[&quot;IID&quot;] + &quot;&amp;MID=&quot; + Request.QueryString[&quot;MID&quot;] + &quot;&amp;Mode=New&quot;);
        }

        /// &lt;summary&gt;
        /// Handles the view.
        /// &lt;/summary&gt;
        public override void HandleView()
        {
            try
            {
                int docID = GetSelectedIds().ToInt32_2();
                int VersionNo = GetActiveItemValue(&quot;VersionNo&quot;).ToInt32_2();
                string storageid = GetActiveItemValue(&quot;StorageId&quot;).ToString();
                string DocName = GetActiveItemValue(&quot;DocName&quot;).ToString();
                string DocType = GetActiveItemValue(&quot;DocType&quot;).ToString();

                if (AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocumentViewer&quot;) &amp;&amp;
                    AMP3ApplicationSettings.Instance.appSettings[&quot;DocumentViewer&quot;].ToUpper2() == &quot;VIEWONE&quot;)
                {
                    if (FolderPermissions.Contains(&quot;AnotateDoc&quot;))
                        Response.Redirect(
                            string.Format(
                                &quot;~/ViewOne.aspx?ModuleID={0}&amp;File={1}&amp;DocId={2}&amp;Version={3}&amp;PID={4}&amp;DocList={5}&quot;,
                                Request.QueryString[&quot;MID&quot;].ToString(), storageid, docID, VersionNo,
                                Request.QueryString[&quot;PID&quot;], HttpContext.Current.Server.UrlEncode(Request.RawUrl)), false);
                    else
                        Response.Redirect(
                            string.Format(
                                &quot;~/ViewOne.aspx?ae=0&amp;ModuleID={0}&amp;File={1}&amp;DocId={2}&amp;Version={3}&amp;PID={4}&amp;DocList={5}&quot;,
                                Request.QueryString[&quot;MID&quot;].ToString(), storageid, docID, VersionNo,
                                Request.QueryString[&quot;PID&quot;],
                                HttpContext.Current.Server.UrlEncode(Request.RawUrl)), false);
                }
                else if (AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocumentViewer&quot;) &amp;&amp;
                    AMP3ApplicationSettings.Instance.appSettings[&quot;DocumentViewer&quot;].ToUpper2() == &quot;LEADTOOLS&quot;)
                {
                    if (DocumentManager.Instance.DocTypes.Contains(DocType.ToLower()))
                    {
                        int linkId = DocumentManager.Instance.GetLinkIdForDocument(docID, Request.QueryString[&quot;MID&quot;].ToString(), Request.QueryString[&quot;IID&quot;].ToInt32_2());
                        string mode = &quot;Viewer&quot;;
                        Response.Redirect(
                                string.Format(
                                    &quot;~/Modules/DOCMGMT/DocumentViewer.aspx?DocID={0}&amp;VersionNo={1}&amp;Mode={2}&amp;LinkID={3}&amp;BackURL={4}&quot;,
                                    docID, VersionNo, mode, linkId, HttpContext.Current.Server.UrlEncode(Request.RawUrl)), false);
                    }
                    else
                    {
                        ShowError(&quot;The document format does not support viewing&quot;);
                    }

                }
                else
                {
                    //DocumentManager.Instance.WriteFiletoBrowser(Response, DocId);

                    UserDetail ud = UserDetail.GetCurrentUserDetail();
                    string sesName = &quot;FileDownload&quot; + ud.UserID.ToString2();
                    HttpContext.Current.Session[sesName] = docID;
                    RegisterDownloadFileScript(docID, false, VersionNo, 1);
                }
                List&lt;string&gt; CheckComponents =
                    Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);
                if (CheckComponents.Contains(&quot;LogActivities&quot;))
                {
                    string docName = DocName + &quot;.&quot; + DocType.ToLower();
                    int folderId = HttpContext.Current.Request.QueryString[&quot;FID&quot;].ToInt32_2();
                    string fname = DocumentManager.Instance.GetFolderName(folderId, getDisplayName: true);
                    string message = &quot;Viewed document &quot; + docName;
                    string activity = &quot;Document View&quot;;
                    Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                    additionalParam.Add(&quot;FolderId&quot;, folderId.ToString());
                    Dictionary&lt;string, object&gt; resultObject = DocumentManager.Instance.GetLogMessage(docID, &quot;View&quot;,
                        additionalParam);
                    if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                    {
                        message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                        activity = resultObject[&quot;activity&quot;].ToString();
                    }

                    DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docID,
                        String.Format(
                            &quot;&lt;ACTION&gt;{4}&lt;/ACTION&gt;&lt;DOCNAME&gt;&lt;![CDATA[{0}]]&gt;&lt;/DOCNAME&gt;&lt;FOLDER&gt;{1}&lt;/FOLDER&gt;&lt;FOLDERID&gt;{2}&lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3}&lt;/PROJECTID&gt;&quot;,
                            docName, fname, Request.QueryString[&quot;FID&quot;].ToInt32_2(), ProjectID, activity), message);
                }
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Handles the edit.
        /// &lt;/summary&gt;
        public override void HandleEdit()
        {
            string id = GetSelectedIds();
            Response.Redirect(&quot;~/Modules/DOCMGMT/Documents.aspx?FID=&quot; + Request.QueryString[&quot;FID&quot;] + &quot;&amp;PID=&quot; +
                              Request.QueryString[&quot;PID&quot;] + &quot;&amp;IID=&quot; +
                              Request.QueryString[&quot;IID&quot;] + &quot;&amp;MID=&quot; + Request.QueryString[&quot;MID&quot;] + &quot;&amp;Mode=Edit&quot; +
                              &quot;&amp;DocId=&quot; + id);
        }

        /// &lt;summary&gt;
        /// Handles the delete.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;System.Int32.&lt;/returns&gt;
        public override int HandleDelete()
        {
            try
            {
                //string ids = GetSelectedIds();
                string PID = Request.QueryString[&quot;PID&quot;].ToString();
                bool deletedRecords = false;
                bool logActivities = DOCMGMTModuleComponents.Contains(&quot;LogActivities&quot;);
                for (int i = 0; i &lt; mwGrid.MasterTableView.GetSelectedItems().Count(); i++)
                {

                    string docId = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;DocId&quot;].Text;
                    string checkedBy = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;CheckedBy&quot;].Text;
                    string linkID = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;LinkID&quot;].Text;
                    string docNameWithExt = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;DocName&quot;].Text + &quot;.&quot; +
                                                 mwGrid.MasterTableView.GetSelectedItems()[i][&quot;DocType&quot;].Text.ToLower();

                    try
                    {
                        DeleteDocument(UserDetail.GetCurrentUserDetail().UID, PID.ToInt32_2(), Request[&quot;IID&quot;].ToInt32_2(), Request[&quot;MID&quot;], Request[&quot;FID&quot;].ToInt32_2(),
                            docId.ToInt32_2(), linkID.ToInt32_2(), docNameWithExt, checkedBy, true, MetadataFormModel, logActivities);
                    }
                    catch (Exception ex)
                    {
                        ShowError(ex.Message);
                    }

                }
                if (deletedRecords)
                    ShowSuccess(&quot;Document(s) deleted successfully.&quot;);
            }
            catch (Exception ex)
            {
                ShowError(ex.Message);
            }
            return 0;
        }

        public static bool DeleteDocument(int currentUserId, int PID, int instanceId, string moduleId, int folderId, int docId, int linkID,
            string docNameWithExtention, string checkedBy, bool deleteAllDocumentlink, BrixFormModel metadataFormModel, bool logActivities)
        {
            bool isDeleted = false;

            try
            {
                if (checkedBy != &quot;0&quot; &amp;&amp; checkedBy != currentUserId.ToString2())
                {
                    throw new Exception(
                        &quot;ShowError(&#39;Selected record(s) is checked out by another user. Request denied.&#39;);&quot;);
                }
                var DocDTO = new Document();
                DocDTO.ParentId = PID.ToInt32_2();
                DocDTO.DocId = docId.ToInt32_2();
                Dictionary&lt;string, Type&gt; dicObj = AfterSaveRecordModel.GetModelObjects();

                Logger.Log(AMP3.Resources.MessageResources.Enumerations.LogType.Information, dicObj.Count.ToString(),
                    &quot;DOCUMENT&quot;);

                foreach (KeyValuePair&lt;string, Type&gt; kvp in dicObj)
                {
                    Logger.Log(AMP3.Resources.MessageResources.Enumerations.LogType.Information,
                        &quot;KVP Key -&quot; + kvp.Key, &quot;DOCUMENT&quot;);
                    var Savemodel = AfterSaveRecordModel.GetInstance(kvp.Key);
                    if (Savemodel != null)
                        Savemodel.SaveDetails(DocDTO, null, &quot;&quot;, &quot;DELETE_DOCUMENT&quot;);
                }

                string ParentID = string.Empty;
                if (moduleId == &quot;PROJECT&quot; &amp;&amp; PID != 0)
                {
                    ParentID = PID.ToString();
                }
                else if (moduleId == &quot;CONTMGT&quot; &amp;&amp; instanceId != 0)
                {
                    ParentID = instanceId.ToString();
                }
                string canDeleteDocIds = ListModel.FilterIdsToDeleteBasedOnWFDefinitions(&quot;XDOCMGT&quot;, PID.ToString(), ParentID, docId.ToString());
                if (!(string.IsNullOrEmpty(canDeleteDocIds)))
                {
                    //Should delete all link when document is deleted from documnet manager
                    //Remove links as well as the document itself
                    Hashtable htReturn = LinksManager.Instance.RemoveLinks(new List&lt;int&gt; { linkID }, deleteAllDocumentlink);

                    //Delete document from mapping table 
                    if (!string.IsNullOrEmpty(canDeleteDocIds))
                    {
                        ListModel.ForceDeleteWorkflowsForThisForm(canDeleteDocIds, &quot;XDOCMGT&quot;);
                        DocumentManager.Instance.DeleteDocumentContent(canDeleteDocIds);
                    }

                    if (((int)htReturn[&quot;Success&quot;]) == 1)
                    {
                        //Delete MetaData
                        try
                        {
                            if (metadataFormModel != null)
                                ComponentHelper.Instance.ExecuteNonQuery(&quot;delete &quot; + metadataFormModel.form.TableName + &quot; where DocId in (&quot; + canDeleteDocIds + &quot;)&quot;);
                        }
                        catch
                        {
                        }

                        //Delete Asosciations
                        DocumentManager.Instance.DeleteAssociations(canDeleteDocIds);

                        //Log Deletion action on Document
                        if (logActivities)
                        {
                            string message = string.Format(&quot;{0} document deleted&quot;, docNameWithExtention);
                            string activity = &quot;Document Deleted&quot;;

                            Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                            additionalParam.Add(&quot;DocName&quot;, docNameWithExtention);
                            Dictionary&lt;string, object&gt; resultObject =
                                DocumentManager.Instance.GetLogMessage(canDeleteDocIds.ToInt32_2(),
                                    &quot;Delete&quot;, additionalParam);
                            if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                            {
                                message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                                activity = resultObject[&quot;activity&quot;].ToString();
                            }

                            string fname =
                                UIHelper.JavascriptEncode(
                                    DocumentManager.Instance.GetFolderName(folderId, getDisplayName: true));
                            DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, canDeleteDocIds.ToInt32_2(),
                                String.Format(
                                    &quot;&lt;ACTION&gt;{0}&lt;/ACTION&gt; &lt;DOCNAME&gt; &lt;![CDATA[{1}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt;  {2} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {3} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{4} &lt;/PROJECTID&gt;&quot;,
                                    activity, docNameWithExtention, fname, folderId, PID),
                                message);
                        }
                        isDeleted = true;
                    }
                    else
                    {
                        throw new Exception(&quot;Document deletion failed.&quot;);
                    }
                }
                else
                {
                    throw new Exception(&quot;The selected document is in a workflow stage where it may not be deleted.&quot;);
                }
            }
            catch (Exception ex)
            {
                throw;
            }

            return isDeleted;
        }

        /// &lt;summary&gt;
        /// Handles the menu item.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;eventString&quot;&gt;The event string.&lt;/param&gt;
        /// &lt;returns&gt;System.String.&lt;/returns&gt;
        /// &lt;exception cref=&quot;System.Exception&quot;&gt;
        /// Selected record(s) is checked out by another user. Request denied.
        /// or
        /// You do not have permission to merge documents from this folder.
        /// &lt;/exception&gt;
        public override string HandleMenuItem(string eventString)
        {
            string retValue = string.Empty;
            if (eventString == &quot;Check In&quot;)
            {
                string id = GetSelectedIds();
                try
                {
                    WorkFlowValidation(id.ToInt32_2(), &quot;checkin&quot;);
                    if (GetActiveItemValue(&quot;CheckedBy&quot;) != &quot;0&quot; &amp;&amp;
                        GetActiveItemValue(&quot;CheckedBy&quot;) != UserDetail.GetCurrentUserDetail().UID.ToString2())
                        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                            HttpContext.Current.CurrentHandler.GetType(), &quot;CheckOutByDiffUser&quot;,
                            &quot;ShowError(&#39;Selected record(s) is checked out by another user. Request denied. &#39;);&quot;, true);


                    else if (GetActiveItemValue(&quot;CheckedBy&quot;) == &quot;0&quot;)
                        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                            HttpContext.Current.CurrentHandler.GetType(), &quot;NotCheckedOut&quot;,
                            &quot;ShowError(&#39;Selected record is not Checked Out. Request denied.&#39;);&quot;, true);

                    else
                        Response.Redirect(&quot;~/Modules/DOCMGMT/Documents.aspx?FID=&quot; + Request.QueryString[&quot;FID&quot;] + &quot;&amp;PID=&quot; +
                                          Request.QueryString[&quot;PID&quot;] + &quot;&amp;IID=&quot; +
                                          Request.QueryString[&quot;IID&quot;] + &quot;&amp;MID=&quot; + Request.QueryString[&quot;MID&quot;] +
                                          &quot;&amp;Mode=CheckIn&quot; + &quot;&amp;DocId=&quot; + id);
                }
                catch (Exception ex)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                        &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
                }
                return retValue;
            }
            else if (eventString == &quot;Comment Log&quot;)
            {
                int DocId = GetSelectedIds().ToInt32_2();
                var DocName = GetActiveItemValue(&quot;DocName&quot;).ToString2();
                var FolderId = Request.QueryString[&quot;FID&quot;].ToInt32_2();
                string queryString = &quot;?DocId=&quot; + DocId + &quot;&amp;DocName=&quot; + HttpContext.Current.Server.UrlEncode(DocName) +
                                     &quot;&amp;FolderId=&quot; + FolderId;
                NameValueCollection qs = Request.QueryString;

                foreach (String s in qs.AllKeys)
                {
                    if (!queryString.Contains(&quot;&amp;{0}&quot;.Format2(s)))
                        queryString += &quot;&amp;{0}={1}&quot;.Format2(s, qs[s]);
                }
                Response.Redirect(string.Format(&quot;/Modules/DOCMGMT/CommentLog.aspx{0}&quot;, queryString), false);
                return retValue;
            }
            else if (eventString == &quot;Archive&quot;)
            {
                try
                {
                    Page pg = (HttpContext.Current.CurrentHandler as Page);
                    pg.Validate();
                    if (pg.IsValid)
                    {
                        string checkedbyname = string.Empty;
                        for (int i = 0; i &lt; mwGrid.MasterTableView.GetSelectedItems().Count(); i++)
                        {
                            checkedbyname = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;CheckedBy&quot;].Text;
                            if (!string.IsNullOrEmpty(checkedbyname) &amp;&amp; !(checkedbyname == &quot;0&quot;) &amp;&amp;
                                !(checkedbyname.Equals(UserDetail.GetCurrentUserDetail().UID.ToString2())))
                            {
                                throw new Exception(&quot;Selected record(s) is checked out by another user. Request denied.&quot;);
                            }
                        }

                        var GetParentFolderID =
                            ComponentHelper.Instance.ExecuteScalar(
                                &quot;select folderid from DOCMGMTFolder where instanceid={0} and parentfolderid=0 and ModuleId={1}&quot;,
                                Request.QueryString[&quot;IID&quot;].ToString(), Request.QueryString[&quot;MID&quot;].ToString());
                        string foldername = &quot;Archive&quot;;
                        string folderdesc = &quot;Archive&quot;;
                        var FolderDTObj = new Folder();
                        FolderDTObj.ParentId = GetParentFolderID.ToInt32_2(); //FolderID;
                        FolderDTObj.FolderName = foldername;
                        FolderDTObj.FolderDesc = folderdesc;
                        FolderDTObj.ModuleId = Request.QueryString[&quot;MID&quot;].ToString();
                        FolderDTObj.InstanceId = Request.QueryString[&quot;IID&quot;].ToString();
                        FolderDTObj.FolderType = FolderType.ArchiveFolder;

                        int result = DocumentManager.Instance.AddFolder(FolderDTObj);
                        if (result &gt; 0)
                        {
                            MoveDocumentForArchive(result);
                        }
                        else
                        {
                            var GetArchiveFolderID =
                                ComponentHelper.Instance.ExecuteScalar(
                                    &quot;select top 1 folderid from DOCMGMTFolder where instanceid={0}&quot;
                                     + &quot; and parentfolderid={1} and FolderName=&#39;Archive&#39; and ModuleId={2}&quot;,
                                     Request.QueryString[&quot;IID&quot;].ToString(), GetParentFolderID.ToInt32_2(), Request.QueryString[&quot;MID&quot;].ToString());
                            MoveDocumentForArchive(GetArchiveFolderID.ToInt32_2());
                        }
                    }
                }

                catch (Exception ex)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                        &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
                }

                return retValue;
            }
            else if ((eventString == ExcelHelper.EXCEL_TEMPLATE) || (eventString == ExcelHelper.EXCEL_TEMPLATE_XLSX))
            {
                DataTable bindingTable = new BrixDataTable();
                bindingTable = GetSchema(ProjectID.ToInt32_2());
                bindingTable.TableName = &quot;Metadata&quot;;
                DataSet ds = new DataSet();
                ds.Tables.Add(bindingTable);
                ds.DataSetName = &quot;Metadata&quot;;
                ExcelExportEntity excelExportEntity = new ExcelExportEntity(ds);
                ExcelHelper.ExportToExcel(eventString, excelExportEntity);
                return retValue;
            }
            else if (eventString == &quot;Merge&quot;)
            {
                try
                {
                    string destinationFolderName = string.Empty;
                    int SourceFileID = Request.QueryString.Get(&quot;FID&quot;).ToInt32_2();
                    int folderID = Request.QueryString.Get(&quot;FID&quot;).ToInt32_2();
                    string moduleID = Request.QueryString[&quot;MID&quot;].ToString2();
                    int moduleInstanceID = Request.QueryString[&quot;IID&quot;].ToInt32_2();
                    //TODO: Check for merge permission on the current folder and allow merge
                    List&lt;string&gt; permissionList =
                        Aurigo.AMP3.DocumentManagementBL.DocumentManager.Instance.GetPermissions(ProjectID, folderID);
                    if (!permissionList.Contains(&quot;Merge&quot;))
                        throw new Exception(&quot;You do not have permission to merge documents from this folder.&quot;);
                    BrixFormModel model = ProjectManager.Instance.GetProjectMetadataXMLModel(ProjectID);

                    Document sourceDocument =
                        DocumentManager.Instance.GetDocumentDetails(GetActiveItemValue((&quot;StorageID&quot;).ToString2()));
                    //GetDocument(GridRow);

                    int docId = DocumentManager.Instance.ValidateDocumentForMergeAndGetDestinationDocId(sourceDocument,
                        folderID);
                    Document destinationDocument = DocumentManager.Instance.ViewDocumentDetails(docId);

                    //validate document name and extension for merge 
                    DocumentManager.Instance.ValidateDocumentForMerge(sourceDocument, destinationDocument);

                    //Original Document to which merge is being performed must be in a workflow stage that allows edit
                    WorkFlowValidation(destinationDocument.DocId, &quot;merge&quot;);

                    DocumentManager.Instance.MergeDocuments(SourceFileID, destinationDocument.FolderId, moduleInstanceID,
                        moduleID, ProjectID, destinationDocument, sourceDocument, model);
                    DocumentManager.Instance.DeleteDocument(sourceDocument.DocId);
                    object[] docParam = new object[1] { destinationDocument.FolderId };
                    destinationFolderName =
                        ComponentHelper.Instance.ExecuteScalar(
                            DocumentStoredProcedure.usp_DOCMGMTCheckFolderForDocument, null, docParam).ToString2();

                    //var FolderName = ComponentHelper.Instance.ExecuteScalar(&quot;select CASE WHEN ISNULL(ParentFolderId, 0)=0 then &#39;Documents&#39; else FolderName end FolderName from DOCMGMTFolder where FolderId=&quot; + FolderID);
                    if (destinationFolderName != null &amp;&amp; destinationFolderName.ToString() != &quot;&quot;)
                    {
                        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                            HttpContext.Current.CurrentHandler.GetType(), &quot;MsgMerge&quot;,
                            &quot;ShowSuccess(&#39;&quot; + string.Format(&quot;Document(s) have been merged to destination folder: &quot;) +
                            UIHelper.JavascriptEncode(destinationFolderName) + &quot;&#39;);&quot;, true);
                    }
                    //TODO: Log activity
                }
                catch (Exception ex)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                        &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
                    //ShowNotificationMessage(ex.Message, NotificationType.Error);
                }
                return retValue;
            }
            else
                return base.HandleMenuItem(eventString);
        }

        /// &lt;summary&gt;
        /// Handles the menu items.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;eventString&quot;&gt;The event string.&lt;/param&gt;
        /// &lt;param name=&quot;UltraWebGridExcelExporter1&quot;&gt;The ultra web grid excel exporter1.&lt;/param&gt;
        /// &lt;returns&gt;System.String.&lt;/returns&gt;
        public override string HandleMenuItems(string eventString, UltraWebGridExcelExporter UltraWebGridExcelExporter1, string filter = &quot;&quot;)
        {
            string error = String.Empty;
            switch (eventString)
            {
                case &quot;Excel Export (xls)&quot;:
                case &quot;Excel Export (xlsx)&quot;:
                    int pagecount = 0;
                    DataTable finalDt = GetDocumentList(&quot;&quot;, 0, -1, ref pagecount, true).Select(filter).CopyToDataTable();
                    FormatExcelColumn(finalDt);
                    ExportTable(eventString, finalDt, UltraWebGridExcelExporter1);
                    isMenuClickHandled = true;
                    break;
                default:
                    error = base.HandleMenuItems(eventString, UltraWebGridExcelExporter1, filter);
                    break;
            }

            return error;
        }

        /// &lt;summary&gt;
        /// Gets the document list.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;metadataSearchCrieteria&quot;&gt;The metadata search crieteria.&lt;/param&gt;
        /// &lt;param name=&quot;startIdx&quot;&gt;The start index.&lt;/param&gt;
        /// &lt;param name=&quot;pageSize&quot;&gt;Size of the page.&lt;/param&gt;
        /// &lt;param name=&quot;pagecount&quot;&gt;The pagecount.&lt;/param&gt;
        /// &lt;param name=&quot;isExport&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [is export].&lt;/param&gt;
        /// &lt;returns&gt;DataTable.&lt;/returns&gt;
        private DataTable GetDocumentList(string metadataSearchCrieteria, int startIdx, int pageSize, ref int pagecount,
            bool isExport = false, bool getOnlyDocIds = false)
        {
            UserDetail ud = UserDetail.GetCurrentUserDetail();

            // get all the document inside the folder (without filter and metadata)
            DataTable dt = DocumentManager.Instance.GetDocumentList(Request.QueryString[&quot;FID&quot;].ToInt32_2(), UserDetail.GetCurrentUserDetail().UID, null, null, null,
                UserManager.Instance.GetRoleNames(ud.UID, PID, ud.RID, ud.RoleName));

            string docIDs = string.Empty;
            if (dt.Rows.Count &gt; 0)
            {
                // Get comma separated list ids
                docIDs = dt.AsEnumerable()
                    .Select(row =&gt; row[&quot;DocID&quot;].ToString())
                    .Aggregate((s1, s2) =&gt; String.Join(&quot;,&quot;, s1, s2));
            }
            else
                docIDs = &quot;Null&quot;;

            DataTable newDt;

            DataSet ds = new DataSet();

            if (MetadataFormModel != null)
            {
                newDt = dt.Clone();

                DataSet dsMD =
                    ComponentHelper.Instance.ExecuteDataSet(&quot;select Dr.*, L.LinkID as &#39;LinkID&#39; from &quot; +
                                                            MetadataFormModel.form.TableName +
                                                            &quot; Dr inner join LINKMODLinkDetails L on L.DestId = Dr.DocId &quot; +
                                                            &quot; where DocId in (&quot; + docIDs + &quot;) and L.FolderID = &quot; +
                                                            Request.QueryString[&quot;FID&quot;]);
                // + (string.IsNullOrEmpty(metadataSearchCrieteria) ? &quot;&quot; : &quot; and &quot; + metadataSearchCrieteria));
                //if (dsMD.Tables.Count &gt; 0)
                //{
                DataTable dtMetadata = dsMD.Tables[0];
                dt.TableName = &quot;Main&quot;;
                dtMetadata.TableName = &quot;Properties&quot;;
                ds.Tables.Add(dt.Copy());
                ds.Tables.Add(dtMetadata.Copy());
                ds.Relations.Add(&quot;RelMD&quot;, ds.Tables[0].Columns[&quot;LinkID&quot;], ds.Tables[1].Columns[&quot;LinkID&quot;]);
                //}

                List&lt;string&gt; colNames = new List&lt;string&gt;();


                // creating schema for the metadata table
                // addign all the metadata columns, in case of dropdown we need to add two columns - one for text with the real column name and 
                //another for value with real column name + _value column
                // replace metadata search string to work on value column in place of real column
                if (dsMD.Tables.Count &gt; 0)
                {
                    foreach (DataColumn col in dsMD.Tables[0].Columns)
                    {
                        if (col.ColumnName != &quot;DocId&quot;)
                        {
                            xControl ctrl = MetadataFormModel.form.GetControl(col.ColumnName);
                            if (ctrl != null &amp;&amp;
                                ctrl.Type != Aurigo.Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden)
                            {
                                DataColumn dc = new DataColumn(col.ColumnName, col.DataType);

                                //take caption for export and keep &quot;:&quot; for export
                                if (isExport)
                                {
                                    dc.ColumnName = (string.IsNullOrEmpty(ctrl.Caption)
                                        ? ctrl.Name
                                        : ctrl.ParseDynamicString(ctrl.Caption));
                                }
                                else
                                {
                                    // To work with work listmodel as it was replacing &quot;_&quot; for spaces, so cannot take caption
                                    dc.ColumnName = ctrl.Name;
                                }

                                //Temporary fix for Drop down list in Documents metadata - TODO: find  abetter way - Akila

                                if (ctrl != null &amp;&amp;
                                    ctrl.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList)
                                {
                                    metadataSearchCrieteria = metadataSearchCrieteria.Replace(&quot;[&quot; + ctrl.Name + &quot;]&quot;,
                                        &quot;[&quot; + ctrl.Name + &quot;_ValueColumn&quot; + &quot;]&quot;);
                                    dc.DataType = typeof(string);
                                    DataColumn dcId = new DataColumn(ctrl.Name + &quot;_ValueColumn&quot;, col.DataType);
                                    colNames.Add(ctrl.Name + &quot;_ValueColumn&quot;);
                                    newDt.Columns.Add(dcId);
                                }
                                else
                                {
                                    dc.DataType = col.DataType;
                                }

                                colNames.Add(dc.ColumnName);
                                newDt.Columns.Add(dc);
                            }
                        }
                    }
                }

                newDt.AcceptChanges();

                foreach (DataRow row in ds.Tables[0].Rows) // real doc table
                {
                    // in new table get allthe values from document list table
                    DataRow newR = newDt.Rows.Add();


                    foreach (DataColumn myColumn in ds.Tables[0].Columns)
                        newR[myColumn.ColumnName] = row[myColumn.ColumnName];

                    //One document can have only one entry. Hence we are reading r[0] always.
                    DataRow[] r = row.GetChildRows(&quot;RelMD&quot;);

                    int cc = 0;
                    for (int i = 0; i &lt; ds.Tables[1].Columns.Count; i++)
                    {
                        string colName = ds.Tables[1].Columns[i].ColumnName;
                        if (colName != &quot;DocId&quot;)
                        {
                            xControl ctrl = MetadataFormModel.form.GetControl(colName);
                            if (ctrl != null &amp;&amp;
                                ctrl.Type != Aurigo.Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden)
                            {
                                //Temporary fix for Drop down list in Documents metadata - TODO: find  abetter way - Akila
                                if (ctrl != null &amp;&amp;
                                    ctrl.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList)
                                {
                                    if (r.Length &gt; 0)
                                    {
                                        DropDownList ddl = new DropDownList();
                                        HtmlRenderer.BindDropDown(ctrl, ddl);

                                        string colValue = (r[0][i] ?? &quot;&quot;).ToString();
                                        string colText = (r[0][i] ?? &quot;&quot;).ToString();

                                        foreach (ListItem li in ddl.Items)
                                        {
                                            if (li.Value == colValue)
                                            {
                                                colValue = li.Value;
                                                colText = li.Text;
                                                break;
                                            }
                                        }

                                        SetDataRowColumnValue(newR, colValue, colNames[cc++]);
                                        SetDataRowColumnValue(newR, colText, colNames[cc++]);
                                    }
                                    else
                                    {
                                        SetDataRowColumnValue(newR, &quot;0&quot;, colNames[cc++]);
                                        SetDataRowColumnValue(newR, &quot;&quot;, colNames[cc++]);
                                    }
                                }
                                else
                                {
                                    if (r.Length &gt; 0)
                                        newR[colNames[cc++]] = r[0][i];
                                    else
                                        newR[colNames[cc++]] = DBNull.Value;
                                }
                            }
                        }
                    }
                }
            }
            else
                newDt = dt.Copy();

            //Filter the datatable
            DataTable finalDt = new DataTable();

            DataRow[] drs;

            int rowCount;

            if (mwGrid.MasterTableView.SortExpressions.Count &gt; 0 &amp;&amp;
                mwGrid.MasterTableView.SortExpressions[0].FieldName != &quot;WF_FStatus&quot; &amp;&amp;
                mwGrid.MasterTableView.SortExpressions[0].FieldName != &quot;WF_PendingOnRole&quot; &amp;&amp;
                mwGrid.MasterTableView.SortExpressions[0].FieldName != &quot;img_DataHasAnnotations&quot;)  //this field is not present in dataset
            {
                drs = newDt.Select(mwGrid.MasterTableView.FilterExpression,
                    &quot;{0} {1}&quot;.Format2(mwGrid.MasterTableView.SortExpressions[0].FieldName,
                        mwGrid.MasterTableView.SortExpressions[0].SortOrder.ToString().ToLower() == &quot;descending&quot; ? &quot;DESC&quot; : &quot;ASC&quot;));
            }
            else
                drs = newDt.Select(mwGrid.MasterTableView.FilterExpression);

            rowCount = drs.Length;
            if ((rowCount % pageSize) == 0)
                pagecount = rowCount / pageSize;
            else
                pagecount = rowCount / pageSize + 1;

            if (pagecount == 0) startIdx = 0;

            if (pageSize != -1)
            {
                drs = drs.Where((row, i) =&gt; i &gt;= startIdx - 1 &amp;&amp; i &lt; startIdx * pageSize).ToArray();
            }

            if (drs.Length &gt; 0)
                finalDt = drs.CopyToDataTable();
            else
                finalDt = newDt.Clone();

            //Add div for slide show
            HtmlGenericControl divSlideShow = (HtmlGenericControl)CurrentPage.Form.FindControl(&quot;divSlideShow&quot;);
            if (divSlideShow != null)
            {
                divSlideShow.InnerHtml = &quot;&quot;;
                foreach (DataRow dr in dt.Rows)
                {
                    divSlideShow.InnerHtml += string.IsNullOrEmpty(Convert.ToString(dr[&quot;PictureLink&quot;])) ? &quot;&quot; : Convert.ToString(dr[&quot;PictureLink&quot;]);
                }
            }

            if (isExport)
            {
                foreach (DataRow dRow in finalDt.Rows)
                {
                    dRow[DOC_NAME_DBNAME] = dRow[DOC_NAME_DBNAME] + &quot;.&quot; + dRow[DOC_TYPE_DBNAME];
                }
            }

            return finalDt;
        }

        private Document GetDocument(GridDataItem GridDataItem)
        {
            Document dtoDoc = null;
            CustomizePageModel cpm = DocumentManager.Instance.GetCustomPageModelInstance();
            Dictionary&lt;string, object&gt; cpmRequest = new Dictionary&lt;string, object&gt;();
            if (cpm != null)
            {
                Dictionary&lt;string, object&gt; additionalParameters = new Dictionary&lt;string, object&gt;();
                additionalParameters.Add(&quot;selectedRow&quot;, GridDataItem);
                cpmRequest = cpm.GetData(null, mode: &quot;GetDocumentDTO&quot;, callerContext: &quot;DocumentCustomizePageModel&quot;,
                    additionalParameters: additionalParameters);
                if (cpmRequest.ContainsKey(&quot;DocumentDTO&quot;))
                {
                    dtoDoc = (Document)cpmRequest[&quot;DocumentDTO&quot;];
                }
            }

            if (dtoDoc == null)
            {
                dtoDoc =
                    DocumentManager.Instance.GetDocumentDetails(GridDataItem[&quot;StorageID&quot;].Text.Replace(&quot;&amp;nbsp;&quot;, &quot;&quot;));
            }
            return dtoDoc;
        }

        /// &lt;summary&gt;
        /// Sets the data row column value.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;newR&quot;&gt;The new r.&lt;/param&gt;
        /// &lt;param name=&quot;colValue&quot;&gt;The col value.&lt;/param&gt;
        /// &lt;param name=&quot;valueColumnName&quot;&gt;Name of the value column.&lt;/param&gt;
        private static void SetDataRowColumnValue(DataRow newR, string colValue, string valueColumnName)
        {
            if (colValue == string.Empty &amp;&amp; newR.Table.Columns[valueColumnName].IsNumeric()
                &amp;&amp; newR.Table.Columns[valueColumnName].AllowDBNull)
                newR[valueColumnName] = DBNull.Value;
            else
                newR[valueColumnName] = colValue;
        }

        /// &lt;summary&gt;
        /// Works the flow validation.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;docid&quot;&gt;The docid.&lt;/param&gt;
        /// &lt;param name=&quot;Action&quot;&gt;The action.&lt;/param&gt;
        /// &lt;exception cref=&quot;System.Exception&quot;&gt;
        /// One or more records are already in the end stage of the workflow. Cannot do any more modifications.
        /// or
        /// One or more records are in a workflow stage where modifications are not allowed.
        /// or
        /// The current workflow stage of the document does not allow  + Action +  . 
        /// or
        /// The current workflow stage of the document does not allow  + Action +  . 
        /// or
        /// Request denied. Yo do not have permission for  + Action +  . 
        /// or
        /// The current workflow stage of the document does not allow  + Action +  . 
        /// or
        /// Request denied. Yo do not have permission for  + Action +  . 
        /// &lt;/exception&gt;
        public static void WorkFlowValidation(int docid, string Action)
        {
            // Find if any WF is attached. If attached find the current stage and if it is editable, if editable check stake holders.
            //If the logged in user has got rights to edit in the current stage allow to check out, or else throw error.

            //Pass form instance id as doc id and check if wf is associated.
            string sGuid = BrixWorkflowManager.Instance.IsWorkflowAssociated(&quot;XDOCMGT&quot;, docid.ToString());
            if (!String.IsNullOrEmpty(sGuid))
            {
                //get the current state if WF exists
                Guid newGuid = Guid.Empty;
                DataTable dt = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(docid.ToString(), &quot;XDOCMGT&quot;);

                if (Boolean.Parse(dt.Rows[0][&quot;IsCompleted&quot;].ToString()))
                {
                    throw new Exception(
                        &quot;One or more records are already in the end stage of the workflow. Cannot do any more modifications.&quot;);
                }
                else
                {
                    IState state = BrixWorkflowManager.Instance.GetCurrentState(new Guid(sGuid), ref newGuid);

                    // get form stages visibility for this stage [workflow Section is a stage in xmlform]
                    Sections sections =
                        Sections.DeserializeSections(
                            HttpContext.Current.Server.UrlDecode(
                                (state as StateInfo).SectionDisplayInfo));
                    foreach (Aurigo.Common.Section sec in sections.Secs)
                    {
                        if (String.Compare(Action, &quot;checkin&quot;, true) == 0 ||
                            String.Compare(Action, &quot;checkout&quot;, true) == 0)
                        {
                            if (sec.SectionName == &quot;Document&quot;)
                            {
                                if (String.Compare(sec.Visibility, &quot;edit&quot;, true) == 0) // allow check in;
                                {
                                    string[] stakeHolders = null == state.ActionsMustBePerformedBy
                                        ? null
                                        : state.ActionsMustBePerformedBy.Split(&#39;,&#39;);

                                    bool bHasRoleToPlay = false;

                                    foreach (string stakeHolderRole in stakeHolders)
                                    {
                                        bHasRoleToPlay =
                                            UserManager.Instance.IsUserRole(UserDetail.GetCurrentUserDetail().UID,
                                                UserManager.Instance.GetUsersRoleId(
                                                    stakeHolderRole));
                                        if (bHasRoleToPlay) break;
                                    }

                                    if (!bHasRoleToPlay)
                                    {
                                        throw new Exception(
                                            &quot;One or more records are in a workflow stage where modifications are not allowed.&quot;);
                                    }
                                }
                                else
                                {
                                    throw new Exception(&quot;The current workflow stage of the document does not allow &quot; +
                                                        Action + &quot; . &quot;);
                                }
                                break;
                            }
                        }
                        else if (Action.ToLower() == &quot;review&quot; &amp;&amp; sec.SectionName == &quot;Review&quot;)
                        {
                            if (String.Compare(sec.Visibility, &quot;edit&quot;, true) != 0)
                                throw new Exception(&quot;The current workflow stage of the document does not allow &quot; +
                                                    Action + &quot; . &quot;);
                            else
                            {
                                bool bHasRoleToPlay = false;
                                string[] stakeHolders = null == state.ActionsMustBePerformedBy
                                    ? null
                                    : state.ActionsMustBePerformedBy.Split(&#39;,&#39;);
                                foreach (string stakeHolderRole in stakeHolders)
                                {
                                    bHasRoleToPlay =
                                        UserManager.Instance.IsUserRole(UserDetail.GetCurrentUserDetail().UID,
                                            UserManager.Instance.GetUsersRoleId(
                                                stakeHolderRole));
                                    if (bHasRoleToPlay) break;
                                }

                                if (!bHasRoleToPlay)
                                    throw new Exception(&quot;Request denied. Yo do not have permission for &quot; + Action +
                                                        &quot; . &quot;);
                            }
                        }
                        else if (Action.ToLower() == &quot;consolidate&quot; &amp;&amp; sec.SectionName == &quot;Consolidate&quot;)
                        {
                            if (String.Compare(sec.Visibility, &quot;edit&quot;, true) != 0)
                                throw new Exception(&quot;The current workflow stage of the document does not allow &quot; +
                                                    Action + &quot; . &quot;);
                            else
                            {
                                bool bHasRoleToPlay = false;
                                string[] stakeHolders = null == state.ActionsMustBePerformedBy
                                    ? null
                                    : state.ActionsMustBePerformedBy.Split(&#39;,&#39;);
                                if (null != stakeHolders)
                                {
                                    foreach (string stakeHolderRole in stakeHolders)
                                    {
                                        bHasRoleToPlay =
                                            UserManager.Instance.IsUserRole(UserDetail.GetCurrentUserDetail().UID,
                                                UserManager.Instance.GetUsersRoleId(
                                                    stakeHolderRole));
                                        if (bHasRoleToPlay) break;
                                    }
                                }

                                if (!bHasRoleToPlay)
                                    throw new Exception(&quot;Request denied. Yo do not have permission for &quot; + Action +
                                                        &quot; . &quot;);
                            }
                        }
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// Gets the schema.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ProjectID&quot;&gt;The project identifier.&lt;/param&gt;
        /// &lt;returns&gt;DataTable.&lt;/returns&gt;
        public DataTable GetSchema(int ProjectID = 0)
        {
            CustomizePageModel cpModel = DocumentManager.Instance.GetCustomPageModelInstance();
            Dictionary&lt;string, object&gt; customizeDataset;
            if (cpModel != null)
            {
                Dictionary&lt;string, string&gt; additionalParameters = new Dictionary&lt;string, string&gt;();
                additionalParameters.Add(&quot;ProjectID&quot;, ProjectID.ToString2());
                customizeDataset = cpModel.GetData(null, mode: &quot;GetCustomizedSchema&quot;,
                    callerContext: &quot;DocumentCustomizePageModel&quot;, additionalParameters: additionalParameters);
                DataTable SchemaDataset = (DataTable)customizeDataset[&quot;Schema&quot;];
                return SchemaDataset;
            }
            else
            {
                //DocumentImport di = new DocumentImport();
                return GetSchema_Table(ProjectID.ToInt32_2());
            }
        }

        /// &lt;summary&gt;
        /// Gets the schema_ table.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;projectId&quot;&gt;The project identifier.&lt;/param&gt;
        /// &lt;returns&gt;DataTable.&lt;/returns&gt;
        public DataTable GetSchema_Table(int projectId = 0)
        {
            DataTable dtSchema = new DataTable(&quot;Metadata&quot;);

            dtSchema.Columns.Add(DOC_NAME);
            //added a unique constraint to the document name as there should not be duplicate documents.
            dtSchema.Columns[DOC_NAME].Unique = false;
            dtSchema.Columns.Add(DOC_DESCR);
            if (xmlModel == null &amp;&amp; projectId != 0)
            {
                xmlModel = ProjectManager.Instance.GetProjectMetadataXMLModel(projectId);
            }
            if (xmlModel != null)
            {
                xmlModel.form.ProcessAllControlsDeeply(xc =&gt;
                {
                    if (xc.Type != Aurigo.Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden &amp;&amp;
                        !string.IsNullOrEmpty(xc.DBType))
                    {
                        DataColumn column = new DataColumn();
                        column.ColumnName = string.IsNullOrEmpty(xc.Caption)
                            ? xc.Name
                            : xc.ParseDynamicString(xc.Caption);
                        GetControllerDataType(xc, ref column);
                        CheckAllowNull(xc, ref column);

                        //dtSchema.Columns.Add(string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption));
                        dtSchema.Columns.Add(column);
                    }
                });
            }
            return dtSchema;
        }

        /// &lt;summary&gt;
        /// Gets the type of the controller data.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xc&quot;&gt;The xc.&lt;/param&gt;
        /// &lt;param name=&quot;column&quot;&gt;The column.&lt;/param&gt;
        private void GetControllerDataType(xControl xc, ref DataColumn column)
        {
            switch (xc.Type)
            {
                case Aurigo.Brix.Platform.BusinessLayer.XMLForm.ControlType.Integer:
                    column.DataType = typeof(int);
                    break;
                case Aurigo.Brix.Platform.BusinessLayer.XMLForm.ControlType.Date:
                    column.DataType = typeof(DateTime);
                    break;

                default:
                    column.DataType = typeof(string);
                    break;
            }
            //(xc.Type == ControlType.Integer) ? typeof(int) : typeof(string);
        }

        /// &lt;summary&gt;
        /// Checks the allow null.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xc&quot;&gt;The xc.&lt;/param&gt;
        /// &lt;param name=&quot;column&quot;&gt;The column.&lt;/param&gt;
        private void CheckAllowNull(xControl xc, ref DataColumn column)
        {
            if (xc.Validations == &quot;Unique&quot;)
            {
                column.Unique = true;
            }
            column.AllowDBNull = true;
            if (xc.Validations == &quot;Required&quot;)
            {
                column.AllowDBNull = false;
            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the lnkReportClr control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        protected void lnkReportClr_Click(object sender, EventArgs e)
        {
            try
            {
                string pid = Request.QueryString.Get(&quot;PID&quot;);
                //int parentID = Request.QueryString.Get(&quot;ParentID&quot;).ToInt32_2();
                int docId = GetActiveItemValue(&quot;DocId&quot;).ToInt32_2();
                string fID = Request.QueryString[&quot;FID&quot;];
                string iID = Request.QueryString[&quot;IID&quot;];
                string mID = Request.QueryString[&quot;MID&quot;];

                Response.Redirect(
                    string.Format(
                        &quot;~/Common/BrixListReportPage.aspx?ModuleID=DOCMGMT&amp;PID={0}&amp;ParentID={1}&amp;DocID={2}&amp;Context=CLOGRPT&amp;ParentContext=DOCMGMT&amp;ParentModuleID=DOCMGMT&amp;ModelType=List&amp;FID={3}&amp;IID={4}&amp;MID={5}&quot;,
                        pid, ParentID, docId, fID, iID, mID), false);
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the lnkReviewDocument control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        private void lnkReviewDocument_Click(object sender, EventArgs e)
        {
            string docId = GetSelectedIds().ToString2();
            try
            {
                if (string.IsNullOrEmpty(docId))
                {
                    ShowError(&quot;Please select a document to review.&quot;);
                    return;
                }
                else if (docId.Split(&quot;,&quot;.ToCharArray()).Length &gt; 1)
                {
                    ShowError(&quot;You can select only one document for review.&quot;);
                    return;
                }

                WorkFlowValidation(docId.ToInt32_2(), &quot;review&quot;);

                string docName = &quot;Test&quot;, versionNo = &quot;1&quot;, docType = &quot;&quot;;
                int parentID = Request.QueryString.Get(&quot;ParentID&quot;).ToInt32_2();
                if (!string.IsNullOrEmpty(docId))
                {
                    docName = GetActiveItemValue(&quot;DocName&quot;).ToString2();
                    versionNo = GetActiveItemValue(&quot;VersionNo&quot;).ToString2();
                    docType = GetActiveItemValue(&quot;DocType&quot;).ToString2();
                }
                if (docType.ToLower() != &quot;pdf&quot;)
                {
                    ShowError(&quot;Please select a document of type \&quot;.PDF\&quot;.&quot;);
                    return;
                }

                string url =
                    string.Format(
                        &quot;~/Modules/DOCMGMT/PDFViewer.aspx?pid={0}&amp;parentid={1}&amp;docid={2}&amp;amode={3}&amp;docName={4}&amp;versionNo={5}&quot;,
                        UIHelper.UrlEncode(ProjectID.ToString()), UIHelper.UrlEncode(parentID.ToString()), UIHelper.UrlEncode(docId.ToString()), &quot;R&quot;, HttpContext.Current.Server.UrlEncode(docName) + &quot;.&quot; + UIHelper.UrlEncode(docType),
                         UIHelper.UrlEncode(versionNo));

                string script = &quot;OpenDocumentForAnnotation(&#39;&quot; + VirtualPathUtility.ToAbsolute(url) + &quot;&#39;);&quot;;

                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), &quot;OpenDocumentForReview&quot;, script, true);
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
                return;
            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the lnkConsolidate control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        private void lnkConsolidate_Click(object sender, EventArgs e)
        {
            try
            {
                string docId = GetSelectedIds().ToString2();

                if (string.IsNullOrEmpty(docId))
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;ConsolidateValidation&quot;,
                        &quot;Please select a document to consolidate reviews.&quot;, true);
                    return;
                }
                else if (docId.Split(&quot;,&quot;.ToCharArray()).Length &gt; 1)
                {
                    ShowError(&quot;You can select only one document for consolidation.&quot;);
                    return;
                }
                WorkFlowValidation(docId.ToInt32_2(), &quot;consolidate&quot;);


                string docName = &quot;Test&quot;, versionNo = &quot;1&quot;, docType = &quot;&quot;;
                int parentID = Request.QueryString.Get(&quot;ParentID&quot;).ToInt32_2();
                if (!string.IsNullOrEmpty(docId))
                {
                    docName = GetActiveItemValue(&quot;DocName&quot;).ToString2();
                    versionNo = GetActiveItemValue(&quot;VersionNo&quot;).ToString2();
                    docType = GetActiveItemValue(&quot;DocType&quot;).ToString2();
                }

                if (docType.ToLower() != &quot;pdf&quot;)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;ConsolidateValidation&quot;,
                        &quot;ShowError(&#39;&quot; + &quot;Please select a document of type \&quot;.PDF\&quot;.&quot; + &quot;&#39;);&quot;, true);
                    return;
                }

                string url =
                    string.Format(
                        &quot;~/Modules/DOCMGMT/PDFViewer.aspx?pid={0}&amp;parentid={1}&amp;docid={2}&amp;amode={3}&amp;docName={4}&amp;versionNo={5}&quot;,
                        UIHelper.UrlEncode(ProjectID.ToString()), UIHelper.UrlEncode(parentID.ToString()), UIHelper.UrlEncode(docId.ToString()), &quot;C&quot;,
                        HttpContext.Current.Server.UrlEncode(docName) + &quot;.&quot; + UIHelper.UrlEncode(docType), UIHelper.UrlEncode(versionNo));

                string script = &quot;OpenDocumentForAnnotation(&#39;&quot; + VirtualPathUtility.ToAbsolute(url) + &quot;&#39;);&quot;;

                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), &quot;OpenDocumentForReview&quot;, script, true);
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
                return;
            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the lnkExcelImport control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        //private void lnkExcelImport_Click(object sender, EventArgs e)
        //{
        //    Response.Redirect(&quot;~/Modules/DOCMGMT/DocumentImport.aspx&quot; + Request.Url.Query);
        //}

        /// &lt;summary&gt;
        /// Formats the excel column.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;finalDt&quot;&gt;The final dt.&lt;/param&gt;
        private void FormatExcelColumn(DataTable finalDt)
        {
            List&lt;string&gt; validExportColumns = new List&lt;string&gt;();
            DataTable bindingTable = new BrixDataTable();
            bindingTable = GetSchema(ProjectID.ToInt32_2());
            validExportColumns = bindingTable.Columns.Cast&lt;DataColumn&gt;().Select(x =&gt; x.ColumnName).ToList();
            finalDt.Columns[finalDt.Columns.IndexOf(DOC_NAME_DBNAME)].ColumnName = DOC_NAME;
            finalDt.Columns[finalDt.Columns.IndexOf(DOC_DESCR_DBNAME)].ColumnName = DOC_DESCR;
            DataTable newDt = finalDt.Copy();
            foreach (DataColumn col in newDt.Columns)
            {
                if (!validExportColumns.Contains(col.ColumnName) &amp;&amp; finalDt.Columns.Contains(col.ColumnName))
                    finalDt.Columns.Remove(col.ColumnName);
            }
            foreach (string ColumnName in validExportColumns)
            {
                if (validExportColumns.Contains(ColumnName) &amp;&amp; !finalDt.Columns.Contains(ColumnName))
                    finalDt.Columns.Add(ColumnName);
            }
        }

        /// &lt;summary&gt;
        /// Exports the table.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dt&quot;&gt;The dt.&lt;/param&gt;
        /// &lt;param name=&quot;UltraWebGridExcelExporter1&quot;&gt;The ultra web grid excel exporter1.&lt;/param&gt;
        private void ExportTable(string eventString, DataTable dt, UltraWebGridExcelExporter UltraWebGridExcelExporter1)
        {
            //Set date formate for data columns

            //AMP3ApplicationSettings.Instance.FORMAT_DATE
            ArrayList dateColumns = new ArrayList();

            DataTable dtCopy = dt.Clone();

            foreach (DataColumn col in dtCopy.Columns)
            {
                if (col.DataType == System.Type.GetType(&quot;System.DateTime&quot;))
                {
                    col.DataType = System.Type.GetType(&quot;System.String&quot;);
                    dateColumns.Add(col.ColumnName);
                }
            }

            foreach (DataRow row in dt.Rows)
            {
                dtCopy.ImportRow(row);
                foreach (string colName in dateColumns)
                {
                    //DateTime.Parse(String.Format(AMP3ApplicationSettings.Instance.FORMAT_DATE,row[colName]));
                    dtCopy.Rows[dtCopy.Rows.Count - 1][colName] = (string.IsNullOrEmpty(row[colName].ToString2()))
                        ? &quot;&quot;
                        : row[colName].ToMWDateTime().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, DateTimeFormatInfo.InvariantInfo);
                    //Convert.ToDateTime(row[colName]).ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, DateTimeFormatInfo.InvariantInfo);
                    ;
                }
            }
            DataSet ds = new DataSet();
            dtCopy.TableName = &quot;Metadata&quot;;
            ds.Tables.Add(dtCopy);
            ds.DataSetName = &quot;Metadata&quot;;
            ExcelExportEntity excelExportEntity = new ExcelExportEntity(ds);
            ExcelHelper.ExportToExcel(eventString, excelExportEntity);
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the lnkPermissions control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        private void lnkPermissions_Click(object sender, EventArgs e)
        {
            Response.Redirect(&quot;/Modules/DOCMGMT/DocumentPermissions.aspx?&quot; + Request.QueryString);
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the lnkCheckOut control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        private void lnkCheckOut_Click(object sender, EventArgs e)
        {
            try
            {
                string docid = string.Empty;
                string storageid = &quot;&quot;;
                string docName = string.Empty;
                string docType = string.Empty;
                string checkedbyname = string.Empty;
                string folderid = string.Empty;
                int version = 0;
                int count = 0;
                int CheckdOutCount = 0;

                for (int i = 0; i &lt; mwGrid.MasterTableView.GetSelectedItems().Count(); i++)
                {
                    count++;

                    storageid = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;StorageId&quot;].Text;
                    docName = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;DocName&quot;].Text + &quot;.&quot; +
                              mwGrid.MasterTableView.GetSelectedItems()[i][&quot;DocType&quot;].Text.ToLower();
                    docType = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;DocType&quot;].Text;
                    checkedbyname = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;CheckedBy&quot;].Text;
                    docid = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;DocId&quot;].Text;
                    folderid = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;FolderId&quot;].Text;
                    version = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;VersionNo&quot;].Text.ToInt32_2();
                    if (!string.IsNullOrEmpty(checkedbyname) &amp;&amp; !(checkedbyname == &quot;0&quot;))
                    {
                        CheckdOutCount++;
                        continue;
                    }
                    WorkFlowValidation(docid.ToInt32_2(), &quot;checkout&quot;);

                    if (CheckdOutCount == 0)
                    {
                        bool result = DocumentManager.Instance.CheckOut(Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                            storageid, UserDetail.GetCurrentUserDetail().UID);
                        if (result)
                        {
                            List&lt;string&gt; CheckComponents =
                                Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(
                                    Constants.MODID_DOCMGMT);

                            //Log Document checkout activity
                            if (CheckComponents.Contains(&quot;LogActivities&quot;))
                            {
                                docName = docName + &quot;.&quot; + docType.ToLower();
                                var FolderId = folderid.ToInt32_2();
                                string fname =
                                    HttpUtility.HtmlEncode(DocumentManager.Instance.GetFolderName(FolderId,
                                        getDisplayName: true));
                                string message = string.Format(&quot;Checked out document {0} from folder {1}.&quot;, docName,
                                    fname);
                                ;
                                string activity = &quot;Checked out Document&quot;;
                                Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                                additionalParam.Add(&quot;FolderId&quot;, FolderId.ToString());
                                Dictionary&lt;string, object&gt; resultObject =
                                    DocumentManager.Instance.GetLogMessage(docid.ToInt32_2(), &quot;CheckedOut&quot;,
                                        additionalParam);

                                if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                                {
                                    message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                                    activity = resultObject[&quot;activity&quot;].ToString();
                                }

                                DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docid.ToInt32_2(),
                                    String.Format(
                                        &quot;&lt;ACTION&gt;{4}&lt;/ACTION&gt;&lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt; {1} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                                        docName, fname, FolderId, ProjectID, activity), message);
                            }
                        }
                    }
                }

                if (count == 1 &amp;&amp; CheckdOutCount == 1)
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;CheckedOut&quot;,
                        &quot;ShowError(&#39;Selected record is already Checked Out. Request denied.&#39;);&quot;, true);


                else if (count &gt; 1 &amp;&amp; CheckdOutCount &gt;= 1)
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;OneOrMoreCheckedOut&quot;,
                        &quot;ShowError(&#39;One or more Document(s) are already Checked Out. Request denied.&#39;);&quot;, true);


                else if (count == 1 &amp;&amp; CheckdOutCount == 0)
                {
                    RegisterDownloadFileScript(docid.ToInt32_2(), true, version);
                }
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Handles the ServerClick event of the lnkUndoCheckOut control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        /// &lt;exception cref=&quot;System.Exception&quot;&gt;
        /// Selected record(s) is checked out by another user. Request denied.
        /// or
        /// Selected record is not Checked Out. Request denied.
        /// or
        /// One or more record(s) are not Checked Out (Or) checked out by another user. Request denied.
        /// or
        /// One or more record(s) are not Checked Out. Request denied.
        /// &lt;/exception&gt;
        private void lnkUndoCheckOut_ServerClick(object sender, EventArgs e)
        {
            try
            {
                int CheckdOutCount = 0;
                int Count = 0;
                int otherChkdOutcount = 0;
                string storageid = &quot;&quot;;
                string checkedbyname = &quot;&quot;;

                for (int i = 0; i &lt; mwGrid.MasterTableView.GetSelectedItems().Count(); i++)
                {
                    Count++;
                    storageid = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;StorageId&quot;].Text;
                    checkedbyname = mwGrid.MasterTableView.GetSelectedItems()[i][&quot;CheckedBy&quot;].Text;

                    if (string.IsNullOrEmpty(checkedbyname))
                    {
                        CheckdOutCount++;
                        continue;
                    }
                    if (!checkedbyname.Equals(&quot;0&quot;) &amp;&amp;
                        !checkedbyname.Equals(UserDetail.GetCurrentUserDetail().UID.ToString2()))
                    {
                        otherChkdOutcount++;
                        continue;
                    }

                    bool result = DocumentManager.Instance.UndoCheckOut(Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                        storageid);
                }
                if (Count == 1)
                {
                    if (CheckdOutCount == 1)
                    {
                        throw new Exception(&quot;Selected record is not Checked Out. Request denied.&quot;);
                    }
                    else if (otherChkdOutcount == 1)
                    {
                        throw new Exception(&quot;Selected record(s) is checked out by another user. Request denied.&quot;);
                    }
                }
                else if (Count &gt; 1)
                {
                    if (otherChkdOutcount &gt;= 1)
                    {
                        throw new Exception(
                            &quot;One or more record(s) are not Checked Out (Or) checked out by another user. Request denied.&quot;);
                    }
                    else if (CheckdOutCount &gt;= 1)
                    {
                        throw new Exception(&quot;One or more record(s) are not Checked Out. Request denied.&quot;);
                    }
                }
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Gets the operation code.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Operate&quot;&gt;The operate.&lt;/param&gt;
        /// &lt;param name=&quot;Words&quot;&gt;The words.&lt;/param&gt;
        /// &lt;returns&gt;System.String.&lt;/returns&gt;
        private string GetOperationCode(DocumentOperation Operate, out Dictionary&lt;string, string&gt; Words)
        {
            Words = new Dictionary&lt;string, string&gt;();

            switch (Operate)
            {
                case DocumentOperation.Copy:
                    Words.Add(&quot;Single&quot;, &quot;copy&quot;);
                    Words.Add(&quot;Plural&quot;, &quot;copied&quot;);
                    return &quot;C&quot;;
                case DocumentOperation.Transmit:
                    Words.Add(&quot;Single&quot;, &quot;transmit&quot;);
                    Words.Add(&quot;Plural&quot;, &quot;transmitted&quot;);
                    return &quot;T&quot;;
                case DocumentOperation.Merge:
                    Words.Add(&quot;Single&quot;, &quot;merge&quot;);
                    Words.Add(&quot;Plural&quot;, &quot;merged&quot;);
                    return &quot;M&quot;;
                default:
                    Words.Add(&quot;Single&quot;, &quot;move&quot;);
                    Words.Add(&quot;Plural&quot;, &quot;moved&quot;);
                    break;
            }
            return null;
        }

        /// &lt;summary&gt;
        /// Moves the document.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;doc&quot;&gt;The document.&lt;/param&gt;
        /// &lt;param name=&quot;FolderID&quot;&gt;The folder identifier.&lt;/param&gt;
        /// &lt;param name=&quot;Operation&quot;&gt;The operation.&lt;/param&gt;
        /// &lt;param name=&quot;bnlRowChecked&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [BNL row checked].&lt;/param&gt;
        /// &lt;param name=&quot;documentLinked&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [document linked].&lt;/param&gt;
        /// &lt;param name=&quot;achiveCount&quot;&gt;The achive count.&lt;/param&gt;
        /// &lt;param name=&quot;docExists&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [document exists].&lt;/param&gt;
        /// &lt;exception cref=&quot;System.Exception&quot;&gt;Document(s) cannot be Moved to Source folder. Please select Another folder.&lt;/exception&gt;
        private void MoveDocument(Document doc, string FolderID, DocumentOperation Operation, ref bool status,
            ref bool documentLinked, ref int achiveCount, ref bool docExists, ref string DocDetails)
        {
            object IsResult = 0;

            if (FolderID.ToUpper() == doc.FolderId.ToString2().ToUpper())
                throw new Exception(&quot;Document(s) cannot be Moved to Source folder. Please select Another folder.&quot;);
            object[] parameters = new object[3];
            parameters[0] = FolderID;
            parameters[1] = doc.DocId;
            IsResult = ComponentHelper.Instance.ExecuteScalar(DocumentStoredProcedure.usp_DOCMGMTUpdateDocumentMove,
                null, parameters);
            achiveCount++;
            if (IsResult.ToInt32_2() &gt; 0)
            {
                List&lt;string&gt; CheckComponents =
                    Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);
                status = true;
                //Log Move action on Document if component is enabled
                if (CheckComponents.Contains(&quot;LogActivities&quot;))
                {
                    string message = &quot;Moved the document&quot; + doc.DocName;
                    string activity = &quot;Document Moved&quot;;
                    Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                    additionalParam.Add(&quot;FolderId&quot;, doc.FolderId.ToString());
                    additionalParam.Add(&quot;DestFolderId&quot;, FolderID.ToString());
                    Dictionary&lt;string, object&gt; resultObject =
                        DocumentManager.Instance.GetLogMessage(GetActiveItemValue(&quot;DocId&quot;).ToInt32_2(), &quot;Move&quot;,
                            additionalParam);
                    if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                    {
                        message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                        activity = resultObject[&quot;activity&quot;].ToString();
                    }

                    string srcFolder =
                        UIHelper.JavascriptEncode(DocumentManager.Instance.GetFolderName(doc.FolderId, getDisplayName: true));
                    string destFolder =
                        UIHelper.JavascriptEncode(DocumentManager.Instance.GetFolderName(FolderID.ToInt32_2(),
                            getDisplayName: true));
                    DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, doc.DocId,
                        String.Format(
                            &quot;&lt;ACTION&gt;{0}&lt;/ACTION&gt; &lt;DOCNAME&gt; &lt;![CDATA[{1}]]&gt; &lt;/DOCNAME&gt; &lt;SRCFOLDER&gt;  {2} &lt;/SRCFOLDER&gt; &lt;FOLDER&gt;  {3} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {4} &lt;/FOLDERID&gt;&lt;SRCFOLDERID&gt;  {5} &lt;/SRCFOLDERID&gt;&lt;PROJECTID&gt;{6} &lt;/PROJECTID&gt;&quot;,
                            activity, HttpUtility.HtmlEncode(doc.DocName), srcFolder, destFolder, FolderID, doc.FolderId,
                            ProjectID), message);
                }
            }
            else if (IsResult.ToInt32_2() == -2) //Document is linked to other folder
            {
                documentLinked = true;
            }
            else if (IsResult.ToInt32_2() == -1) // same Document Name Exists
            {
                docExists = true;
                DocDetails += (DocDetails != &quot;&quot; ? &quot;,&quot; + doc.DocId.ToString() : doc.DocId.ToString());
                status = false;
            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the btnMnlAssociate control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        protected void btnMnlAssociate_Click(object sender, EventArgs e)
        {
            try
            {
                int associatedDocID = 0;
                string docId = GetSelectedIds().ToString2();

                if (string.IsNullOrEmpty(docId))
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;AssociationWarning&quot;,
                        &quot;ShowError(&#39;&quot; + &quot;Please select a record.&quot; + &quot;&#39;);&quot;, true);


                if (string.IsNullOrEmpty(appDocumentMnlAssociation.AssociatedDoc) ||
                    appDocumentMnlAssociation.AssociatedDoc == &quot;0&quot;)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;AssociationWarning&quot;,
                        &quot;ShowError(&#39;&quot; + &quot;Please select an document to associate.&quot; + &quot;&#39;);&quot;, true);
                }

                if (string.IsNullOrEmpty(appDocumentMnlAssociation.AssociatedType) ||
                    appDocumentMnlAssociation.AssociatedType == &quot;0&quot;)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;AssociationWarning&quot;,
                        &quot;ShowError(&#39;&quot; + &quot;Please select an association type.&quot; + &quot;&#39;);&quot;, true);
                }

                //&amp;&amp; 
                var masterDocID = Convert.ToInt32(appDocumentMnlAssociation.AssociatedDoc);
                var AssociatedDocPath = &quot;&quot;;
                var AssociationTypeId = Convert.ToInt32(appDocumentMnlAssociation.AssociatedType);
                string[] arrDocIDs = new string[docId.Split(&quot;,&quot;.ToCharArray()).Length];
                arrDocIDs = (string[])docId.Split(&quot;,&quot;.ToCharArray());


                for (int i = 0; i &lt; arrDocIDs.Length; i++)
                {
                    associatedDocID = arrDocIDs[i].ToInt32_2();

                    //Do manual association and log association activity
                    DocumentManager.Instance.CreateAssociation(masterDocID, AssociatedDocPath, associatedDocID,
                        AssociationTypeId, ProjectID.ToInt32_2());
                }
            }
            catch (Exception ex)
            {
                //lblerrormsg.Text = ex.Message;
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Documents the move_ node clicked.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The sender.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        /// &lt;param name=&quot;selectedNode&quot;&gt;The selected node.&lt;/param&gt;
        /// &lt;param name=&quot;Operation&quot;&gt;The operation.&lt;/param&gt;
        /// &lt;exception cref=&quot;System.Exception&quot;&gt;You do not have permission to upload documents to this folder.&lt;/exception&gt;
        void DocMove_NodeClicked(object sender, EventArgs e, TreeNode selectedNode, DocumentOperation Operation)
        {
            try
            {
                bool status = true;
                bool documentLinked = false;
                bool docExists = false;
                int achiveCount = 0;
                string FolderID = selectedNode.Value;
                string DocDetails = string.Empty;
                CustomizePageModel cpm = DocumentManager.Instance.GetCustomPageModelInstance();
                int SourceFileID = Request.QueryString.Get(&quot;FID&quot;).ToInt32_2();
                Dictionary&lt;string, string&gt; MessageWords;
                List&lt;string&gt; uploadPermission =
                    Aurigo.AMP3.DocumentManagementBL.DocumentManager.Instance.GetPermissions(ProjectID,
                        FolderID.ToInt32_2());
                string OperationType = GetOperationCode(Operation, out MessageWords);
                if (!uploadPermission.Contains(&quot;Upload&quot;))
                    throw new Exception(&quot;You do not have permission to upload documents to this folder.&quot;);
                BrixFormModel model = ProjectManager.Instance.GetProjectMetadataXMLModel(ProjectID);

                for (int i = 0; i &lt; mwGrid.MasterTableView.GetSelectedItems().Count(); i++)
                {
                    //if (!bool.Parse(((UltraGridCell)GridRow.Cells.FromKey(&quot;Multi&quot;)).Value.ToString()))
                    //    continue;
                    status = true; //make this true to say a row was checked
                    Document doc = GetDocument(mwGrid.MasterTableView.GetSelectedItems()[i]);

                    doc.DocumentOperationType = OperationType;
                    if (Operation == DocumentOperation.Move)
                    {
                        MoveDocument(doc, FolderID, Operation, ref status, ref documentLinked, ref achiveCount,
                            ref docExists, ref DocDetails);
                    }
                    else if (Operation == DocumentOperation.Copy || Operation == DocumentOperation.Transmit)
                    {
                        DocumentManager.Instance.CopyDocuments(SourceFileID, FolderID.ToInt32_2(),
                            Request.QueryString[&quot;IID&quot;].ToInt32_2(), Request.QueryString[&quot;MID&quot;].ToString2(), doc,
                            Request.QueryString.Get(&quot;PID&quot;), model, ref docExists, ref DocDetails, ref status);
                    }
                }

                object[] docParam = new object[1];
                docParam[0] = FolderID;
                var FolderName =
                    ComponentHelper.Instance.ExecuteScalar(DocumentStoredProcedure.usp_DOCMGMTCheckFolderForDocument,
                        null, docParam);
                //var FolderName = ComponentHelper.Instance.ExecuteScalar(&quot;select CASE WHEN ISNULL(ParentFolderId, 0)=0 then &#39;Documents&#39; else FolderName end FolderName from DOCMGMTFolder where FolderId=&quot; + FolderID);
                if (FolderName != null &amp;&amp; FolderName.ToString() != &quot;&quot; &amp;&amp; status)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;MoveSuccess&quot;,
                        &quot;ShowSuccess(&#39;&quot; +
                        string.Format(&quot;Document(s) have been {0} to destination folder : &quot;,
                            UIHelper.JavascriptEncode(MessageWords[&quot;Plural&quot;].ToString2())) + UIHelper.JavascriptEncode(FolderName.ToString()) + &quot;&#39;);&quot;, true);
                }
                if (documentLinked &amp;&amp; achiveCount &gt; 1)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;MoveWarning&quot;,
                        &quot;ShowError(&#39;&quot; +
                        string.Format(&quot;One or more Document(s) are not {0} to destination folder &#39;&quot;,
                            UIHelper.JavascriptEncode(MessageWords[&quot;Plural&quot;].ToString2())) + UIHelper.JavascriptEncode(FolderName.ToString()) + &quot;&#39; which are Linked to other Folder(s).&quot; +
                        &quot;&#39;);&quot;, true);
                }
                else if (documentLinked &amp;&amp; achiveCount &lt;= 1)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;MoveWarning&quot;,
                        &quot;ShowError(&#39;&quot; +
                        string.Format(&quot;Cannot {0} Document(s) which are Linked to other Folder(s).&quot;,
                            UIHelper.JavascriptEncode(MessageWords[&quot;Plural&quot;].ToString2())) + &quot;&#39;);&quot;, true);
                }
                else if (docExists)
                {
                    if (DocDetails != &quot;&quot; &amp;&amp; cpm != null)
                    {
                        int pagecount = mwGrid.PageCount;
                        GetDocumentList(&quot;&quot;, mwGrid.CurrentPageIndex, mwGrid.PageSize, ref pagecount, false);
                        Dictionary&lt;string, object&gt; cpmRequest = new Dictionary&lt;string, object&gt;();
                        cpmRequest.Add(&quot;DocDetails&quot;, DocDetails.Trim(&#39;,&#39;));
                        cpmRequest.Add(&quot;DestFolderID&quot;, FolderID);
                        cpmRequest.Add(&quot;Action&quot;, Operation);
                        cpm.GetData((HttpContext.Current.CurrentHandler as Page), mode: &quot;DocumentOperationOptionsPopUp&quot;,
                            callerContext: &quot;DocumentCustomizePageModel&quot;, additionalParameters: cpmRequest);
                    }
                    else
                    {
                        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                            HttpContext.Current.CurrentHandler.GetType(), &quot;MoveWarning&quot;,
                            &quot;ShowError(&#39;One or more Document(s) Already Exists. &#39;);&quot;, true);
                    }
                }
                if (Operation == DocumentOperation.Move)
                {
                    appDocumentMove.ClearSelectedTreeNode();
                }
                else if (Operation == DocumentOperation.Copy)
                {
                    appDocumentCopy.ClearSelectedTreeNode();
                }
                else if (Operation == DocumentOperation.Transmit)
                {
                    appDocumentTransmit.ClearSelectedTreeNode();
                }
            }
            catch (Exception ex)
            {
                //lblerrormsg.Text = ex.Message;
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Moves the document for archive.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;FolderID&quot;&gt;The folder identifier.&lt;/param&gt;
        private void MoveDocumentForArchive(int FolderID)
        {
            bool documentLinked = false;
            int achiveCount = 0;
            object IsResult = 0;
            try
            {
                for (int i = 0; i &lt; mwGrid.MasterTableView.GetSelectedItems().Count(); i++)
                {
                    Document doc = GetDocument(mwGrid.MasterTableView.GetSelectedItems()[i]);
                    if (doc.StorageId == null) // check if placeholder, then do not proceed
                    {
                        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                            HttpContext.Current.CurrentHandler.GetType(), &quot;NotArchivedOneOrMoreDocs&quot;,
                            &quot;ShowError(&#39;Placeholder cannot be archived.&#39;);&quot;, true);
                    }
                    object[] parameters = new object[2];
                    parameters[0] = FolderID;
                    parameters[1] = doc.DocId;
                    IsResult =
                        ComponentHelper.Instance.ExecuteScalar(DocumentStoredProcedure.usp_DOCMGMTUpdateDocumentMove,
                            null, parameters);
                    achiveCount++;
                    if (IsResult.ToInt32_2() == -2)
                    {
                        documentLinked = true;
                    }
                    List&lt;string&gt; CheckComponents =
                        Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(
                            Constants.MODID_DOCMGMT);

                    //Log Document archive activity    
                    if (CheckComponents.Contains(&quot;LogActivities&quot;))
                    {
                        string message = &quot;Document &quot; + doc.DocName + &quot;is archived&quot;;
                        string activity = &quot;Archiving the document&quot;;
                        Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                        additionalParam.Add(&quot;FolderId&quot;, doc.FolderId.ToString());
                        Dictionary&lt;string, object&gt; resultObject = DocumentManager.Instance.GetLogMessage(doc.DocId,
                            &quot;Archive&quot;, additionalParam);
                        if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                        {
                            message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                            activity = resultObject[&quot;activity&quot;].ToString();
                        }

                        string docName = HttpUtility.HtmlEncode(doc.DocName);
                        DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, doc.DocId,
                            String.Format(
                                &quot;&lt;ACTION&gt;{0}&lt;/ACTION&gt;&lt;DOCNAME&gt; &lt;![CDATA[{1}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt;  {2}&lt;/FOLDER&gt;&lt;FOLDERID&gt;  {3} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{4} &lt;/PROJECTID&gt;&quot;,
                                activity, docName,
                                HttpUtility.HtmlEncode(DocumentManager.Instance.GetFolderName(doc.FolderId,
                                    getDisplayName: true)), doc.FolderId, ProjectID), message + &quot; &quot; + docName + &quot;.&quot;);
                    }
                }

                if (documentLinked &amp;&amp; achiveCount &gt; 1) // checks where multi docs seleted and linked to other folders
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;NotArchivedOneOrMoreDocs&quot;,
                        &quot;ShowError(&#39;One or more Document(s) are not Archived which are Linked to other Folder(s).&#39;);&quot;,
                        true);
                }
                else if (documentLinked &amp;&amp; achiveCount &lt;= 1)
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;NotArchivedLinkDocs&quot;,
                        &quot;ShowError(&#39;Cannot Archive Document(s) which are Linked to other Folder(s).&#39;);&quot;, true);
                }
                else
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;SuccessArchive&quot;,
                        &quot;ShowSuccess(&#39;Document(s) have been moved to destination folder : Archive&#39;);&quot;, true);
                }
                (HttpContext.Current.CurrentHandler as BrixPageBase).UpdateTree = true;
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Handles the ServerClick event of the lnkDownload control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        /// 
        private void lnkDownload_ServerClick(object sender, EventArgs e)
        {
            try
            {
                int docid = GetSelectedItemsFromGrid().ToInt32_2();
                int version = GetActiveItemValue(&quot;VersionNo&quot;).ToInt32_2();
                PropertyInfo isreadonly =
                    typeof(System.Collections.Specialized.NameValueCollection).GetProperty(&quot;IsReadOnly&quot;,
                        BindingFlags.Instance | BindingFlags.NonPublic);
                // make collection editable
                isreadonly.SetValue(this.Request.QueryString, false, null);
                Request.QueryString.Add(&quot;Version&quot;, GetActiveItemValue(&quot;VersionNo&quot;).ToString2());

                List&lt;string&gt; CheckComponents =
                    Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);

                //Log Document checkout activity
                if (CheckComponents.Contains(&quot;LogActivities&quot;))
                {
                    string docName = GetActiveItemValue(&quot;DocName&quot;).ToString2() + &quot;.&quot; +
                                     GetActiveItemValue(&quot;DocType&quot;).ToString2().ToLower2();
                    var FolderId = GetActiveItemValue(&quot;FolderId&quot;).ToInt32_2();
                    string fname =
                        HttpUtility.HtmlEncode(DocumentManager.Instance.GetFolderName(FolderId, getDisplayName: true));
                    string message = string.Format(&quot;Downloaded document {0} from folder {1}.&quot;, docName, fname);
                    ;
                    string activity = &quot;Downloaded Document&quot;;

                    Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                    additionalParam.Add(&quot;FolderId&quot;, FolderId.ToString());
                    Dictionary&lt;string, object&gt; resultObject =
                        DocumentManager.Instance.GetLogMessage(GetActiveItemValue(&quot;DocId&quot;).ToInt32_2(), &quot;Download&quot;,
                            additionalParam);

                    if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                    {
                        message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                        activity = resultObject[&quot;activity&quot;].ToString();
                    }

                    DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docid,
                        String.Format(
                            &quot;&lt;ACTION&gt;{4} &lt;/ACTION&gt;&lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt; {1} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                            docName, fname, FolderId, ProjectID, activity), message);
                    //DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docid, String.Format(&quot;&lt;ACTION&gt;Downloaded Document &lt;/ACTION&gt;&lt;DOCNAME&gt; {0} &lt;/DOCNAME&gt; &lt;FOLDER&gt; {1} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;, docName, HttpUtility.HtmlEncode(DocumentManager.Instance.GetFolderName(FolderId, getDisplayName: true)), FolderId, ProjectID));
                }
                UserDetail ud = UserDetail.GetCurrentUserDetail();
                string sesName = &quot;FileDownload&quot; + ud.UserID.ToString2();
                HttpContext.Current.Session[sesName] = docid;
                RegisterDownloadFileScript(docid, false, version, 1);
                //DocumentManager.Instance.WriteFiletoBrowser(Response, docid);
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Handles the ServerClick event of the btnView control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        /// &lt;exception cref=&quot;System.Exception&quot;&gt;This role doesn&#39;t have permission to view the document.&lt;/exception&gt;
        //protected void btnView_ServerClick(object sender, EventArgs e)
        //{
        //    try
        //    {
        //        string moduleID = Request.QueryString[&quot;MID&quot;].ToString2();
        //        if (permissions.Contains(&quot;ViewD&quot;))
        //        {
        //            int docid = GetSelectedItemsFromGrid().ToInt32_2();
        //            int VersionNo = GetActiveItemValue(&quot;VersionNo&quot;).ToInt32_2();
        //            string storageid = GetActiveItemValue(&quot;StorageId&quot;).ToString2();

        //            if (AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocumentViewer&quot;) &amp;&amp;
        //                AMP3ApplicationSettings.Instance.appSettings[&quot;DocumentViewer&quot;].ToUpper2() == &quot;VIEWONE&quot;)
        //            {
        //                if (permissions.Contains(&quot;AnotateDoc&quot;))
        //                    Response.Redirect(
        //                    string.Format(&quot;~/ViewOne.aspx?ModuleID={0}&amp;File={1}&amp;DocId={2}&amp;Version={3}&amp;PID={4}&amp;DocList={5}&quot;, moduleID, storageid,
        //                                  docid, VersionNo, Request.QueryString[&quot;PID&quot;], HttpContext.Current.Server.UrlEncode(Request.RawUrl)), false);
        //                else
        //                    Response.Redirect(
        //                string.Format(&quot;~/ViewOne.aspx?ae=0&amp;ModuleID={0}&amp;File={1}&amp;DocId={2}&amp;Version={3}&amp;DocList={4}&quot;, moduleID, storageid,
        //                              docid, VersionNo, HttpContext.Current.Server.UrlEncode(Request.RawUrl)), false);
        //            }
        //            else
        //            {
        //                DocumentManager.Instance.WriteFiletoBrowser(Response, docid);
        //            }

        //            //Log View action on Document
        //            List&lt;string&gt; CheckComponents = Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);
        //            if (CheckComponents.Contains(&quot;LogActivities&quot;))
        //            {
        //                string docName = GetActiveItemValue(&quot;DocName&quot;).ToString2() + &quot;.&quot; + GetActiveItemValue(&quot;DocType&quot;).ToString2().ToLower2();
        //                string fname = DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(), getDisplayName: true);
        //                DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docid, String.Format(&quot;&lt;ACTION&gt;Viewed Document&lt;/ACTION&gt;&lt;DOCNAME&gt;&lt;![CDATA[{0}]]&gt;&lt;/DOCNAME&gt;&lt;FOLDER&gt;{1}&lt;/FOLDER&gt;&lt;FOLDERID&gt;{2}&lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3}&lt;/PROJECTID&gt;&quot;, docName, fname, Request.QueryString[&quot;FID&quot;].ToInt32_2(), ProjectID), string.Format(&quot;Viewed Document {0} in folder {1}.&quot;, docName, fname));
        //            }
        //        }
        //        else
        //            throw new Exception(&quot;This role doesn&#39;t have permission to view the document.&quot;);
        //    }
        //    catch (Exception ex)
        //    {
        //        //lblerrormsg.Text = ex.Message;
        //        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
        //                     HttpContext.Current.CurrentHandler.GetType(), ex.Message,
        //                             &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
        //    }
        //}
        /// &lt;summary&gt;
        /// Handles the Click event of the lnkAutoAssociate control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        protected void lnkAutoAssociate_Click(object sender, EventArgs e)
        {
            Dictionary&lt;int, string&gt; dwgFiles = new Dictionary&lt;int, string&gt;();
            try
            {
                string selectedIds = GetSelectedIds();
                bool processOnlySelectedFiles = !string.IsNullOrEmpty(selectedIds);

                if (!selectedIds.EndsWith(&quot;,&quot;)) selectedIds += &quot;,&quot;;

                string[] selectedIdsArray = selectedIds.Split(&quot;,&quot;.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);

                for (int i = 0; i &lt; mwGrid.MasterTableView.Items.Count; i++)
                {
                    string type = mwGrid.MasterTableView.Items[i][&quot;DocType&quot;].Text;

                    if (processOnlySelectedFiles &amp;&amp;
                        !selectedIdsArray.Contains(mwGrid.MasterTableView.Items[i][&quot;DocId&quot;].Text))
                        continue;

                    if (type.ToLower() == &quot;dwg&quot;)
                    {
                        string storageid = mwGrid.MasterTableView.Items[i][&quot;StorageId&quot;].Text;
                        string docName = mwGrid.MasterTableView.Items[i][&quot;DocName&quot;].Text;
                        int docId = mwGrid.MasterTableView.Items[i][&quot;DocId&quot;].Text.ToInt16_2();
                        DocumentWebService docservice = new DocumentWebService();
                        byte[] fileBytes = docservice.OpenDocument(null, storageid, null);

                        //save the document to a temporary location
                        //once we get the xref, we need to delete it
                        string tempPath = Path.GetTempPath();
                        UserDetail ud = UserDetail.GetCurrentUserDetail();
                        string userid = &quot;&quot;;
                        if (ud != null)
                            userid = ud.UserID;

                        tempPath = Path.Combine(tempPath, userid);

                        if (!Directory.Exists(tempPath))
                            Directory.CreateDirectory(tempPath);

                        File.WriteAllBytes(Path.Combine(tempPath, docName), fileBytes);

                        Dictionary&lt;int, string&gt; file = new Dictionary&lt;int, string&gt;();
                        dwgFiles.Add(docId, Path.Combine(tempPath, docName));
                    }
                }

                if (dwgFiles.Count &gt; 0)
                {
                    GetAssoicationTypeIDs();

                    UpdateAssociatedDocsForDWG(dwgFiles);

                    UpdateAssociatedDocsForRenditions(dwgFiles);
                }
                else
                {
                    (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;DwgOnly&quot;,
                        &quot;ShowError(&#39;Please select files of DWG type only for Auto Association.&#39;);&quot;, true);

                    return;
                }
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), &quot;AutoAssociateSuccessful&quot;,
                    &quot;ShowSuccess(&#39;Finished auto associating documents.&#39;);&quot;, true);
            }
            catch (Exception ex)
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
            finally
            {
                ClearTemporaryFiles(dwgFiles.Values.ToList());
            }
        }

        /// &lt;summary&gt;
        /// Gets the assoication type i ds.
        /// &lt;/summary&gt;
        private void GetAssoicationTypeIDs()
        {
            DataSet assnTypes = DocumentManager.Instance.GetAllAssociationTypes();

            if (assnTypes == null || assnTypes.Tables.Count == 0 || assnTypes.Tables[0].Rows.Count == 0)
                return;

            var xref = from r in assnTypes.Tables[0].AsEnumerable()
                       where r.Field&lt;string&gt;(&quot;AssociationType&quot;).ToUpper() == &quot;XREF&quot;
                       select r.Field&lt;int&gt;(&quot;AssociationTypeID&quot;);

            if (xref != null &amp;&amp; xref.Count() &gt; 0)
                _xref = xref.First&lt;int&gt;();

            var rendition = from r in assnTypes.Tables[0].AsEnumerable()
                            where r.Field&lt;string&gt;(&quot;AssociationType&quot;).ToUpper() == &quot;RENDITION&quot;
                            select r.Field&lt;int&gt;(&quot;AssociationTypeID&quot;);

            if (rendition != null &amp;&amp; rendition.Count() &gt; 0)
                _rendition = rendition.First&lt;int&gt;();
        }

        /// &lt;summary&gt;
        /// Updates the associated docs for DWG.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dwgFiles&quot;&gt;The DWG files.&lt;/param&gt;
        private void UpdateAssociatedDocsForDWG(Dictionary&lt;int, string&gt; dwgFiles)
        {
            List&lt;DWGParseResult&gt; result = GetXrefPaths(dwgFiles);

            DataTable projectDocuments = DocumentManager.Instance.GetDocumentsByProject(ProjectID);

            if (projectDocuments == null || projectDocuments.Rows.Count == 0)
                return;

            int masterDocID;
            int? associatedDocID;

            foreach (DWGParseResult doc in result)
            {
                string masterDocName = doc.DocumentName;
                masterDocID = doc.DocumentID;

                DocumentManager.Instance.DeleteAllAssociatedDocs(masterDocID, _xref);

                foreach (AutoCadDrawingXRef xref in doc.Xrefs)
                {
                    string xrefDocName = xref.DocumentName;
                    string xrefDocPath = xref.DocumentPath;

                    DataRow[] xrefdrs = projectDocuments.Select(&quot;DocName=&#39;&quot; + xrefDocName + &quot;&#39;&quot;);

                    if (xrefdrs.Length == 0)
                    {
                        associatedDocID = null;
                    }
                    else
                    {
                        associatedDocID = xrefdrs[0].Field&lt;int&gt;(&quot;DocId&quot;);
                    }

                    DocumentManager.Instance.CreateAssociation(masterDocID, xrefDocPath, associatedDocID, _xref,
                        ProjectID.ToInt32_2());
                }
            }
        }

        /// &lt;summary&gt;
        /// Gets the xref paths.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dwgFiles&quot;&gt;The DWG files.&lt;/param&gt;
        /// &lt;returns&gt;List&amp;lt;DWGParseResult&amp;gt;.&lt;/returns&gt;
        private List&lt;DWGParseResult&gt; GetXrefPaths(Dictionary&lt;int, string&gt; dwgFiles)
        {
            List&lt;DWGParseResult&gt; result = new List&lt;DWGParseResult&gt;();

            CadLibDWGParser parser = new CadLibDWGParser();

            result = parser.GetAllXrefPaths(dwgFiles);

            return result;
        }

        /// &lt;summary&gt;
        /// Clears the temporary files.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dwgFiles&quot;&gt;The DWG files.&lt;/param&gt;
        private void ClearTemporaryFiles(List&lt;string&gt; dwgFiles)
        {
            dwgFiles.ForEach(x =&gt;
            {
                if (File.Exists(x))
                    File.Delete(x);
            });

            if (dwgFiles.Count &gt; 0)
            {
                string fullPath = dwgFiles.First();
                string fileName = Path.GetFileName(fullPath);
                string tempDir = fullPath.Replace(fileName, &quot;&quot;);

                if (Directory.Exists(tempDir))
                    ForceDeleteDirectory(tempDir);
            }
        }

        /// &lt;summary&gt;
        /// Forces the delete directory.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;path&quot;&gt;The path.&lt;/param&gt;
        private static void ForceDeleteDirectory(string path)
        {
            try
            {
                if (!Directory.Exists(path)) return;

                var directory = new DirectoryInfo(path) { Attributes = FileAttributes.Normal };

                foreach (var info in directory.GetFileSystemInfos(&quot;*&quot;, SearchOption.AllDirectories))
                {
                    info.Attributes = FileAttributes.Normal;
                }

                directory.Delete(true);
            }
            catch
            {
                //throws exception when the directory is being used by some other process
                //does not happen always
                //so keeping empty catch block
            }
        }

        /// &lt;summary&gt;
        /// Updates the associated docs for renditions.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dwgFiles&quot;&gt;The DWG files.&lt;/param&gt;
        private void UpdateAssociatedDocsForRenditions(Dictionary&lt;int, string&gt; dwgFiles)
        {
            DataTable projectDocuments = DocumentManager.Instance.GetDocumentsByProject(ProjectID);

            if (projectDocuments == null || projectDocuments.Rows.Count == 0)
                return;

            foreach (KeyValuePair&lt;int, string&gt; doc in dwgFiles)
            {
                string fileName = Path.GetFileNameWithoutExtension(doc.Value);
                int masterDocId = doc.Key;

                DataRow[] drs = projectDocuments.Select(&quot;DocName like &#39;&quot; + fileName + &quot;.%&#39; and DocId &lt;&gt;&quot; + doc.Key);

                if (drs == null || drs.Length == 0)
                    continue;

                DocumentManager.Instance.DeleteAllAssociatedDocs(masterDocId, _rendition);

                foreach (DataRow dr in drs)
                {
                    string fullFileName = dr[&quot;DocName&quot;].ToString();
                    string fileNameInGrid = fullFileName.Substring(0, fullFileName.LastIndexOf(&quot;.&quot;));

                    if (fileNameInGrid.ToLower() != fileName.ToLower() ||
                        Path.GetFileName(doc.Value).ToLower() == fullFileName.ToLower() ||
                        Path.GetExtension(fullFileName).ToLower() == &quot;.dwg&quot;)
                        continue;

                    int associatedDocId = dr[&quot;DocId&quot;].ToInt32_2();
                    string associatedDocPath = &quot;&quot;;

                    DocumentManager.Instance.CreateAssociation(masterDocId, associatedDocPath, associatedDocId,
                        _rendition, ProjectID.ToInt32_2());
                }
            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the lnkRemoveAssociation control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        protected void lnkRemoveAssociation_Click(object sender, EventArgs e)
        {
            string selectedIds = GetSelectedItemsFromGrid();

            RemoveAssociations(selectedIds);
            (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                HttpContext.Current.CurrentHandler.GetType(), &quot;Deletedassociation&quot;,
                &quot;ShowSuccess(&#39;Finished deleting all associations.&#39;);&quot;, true);
        }

        /// &lt;summary&gt;
        /// Removes the associations.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;selectedIds&quot;&gt;The selected ids.&lt;/param&gt;
        private void RemoveAssociations(string selectedIds)
        {
            DocumentManager.Instance.DeleteAllAssociationsForDocument(selectedIds);
            List&lt;string&gt; CheckComponents =
                Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);
            if (CheckComponents.Contains(&quot;LogActivities&quot;))
            {
                foreach (string docId in selectedIds.Split(&#39;,&#39;))
                {
                    Document document = DocumentManager.Instance.ViewDocumentDetails(docId.ToInt32_2());
                    Document masterDoc = DocumentManager.Instance.GetMasterDocDetails(docId.ToInt32_2());
                    if (masterDoc != null &amp;&amp; masterDoc.DocId != 0)
                    {
                        int folderID = Request.QueryString[&quot;FID&quot;].ToInt32_2();
                        string mfolder = DocumentManager.Instance.GetFolderName(masterDoc.FolderId, getDisplayName: true);
                        string folder = DocumentManager.Instance.GetFolderName(folderID, getDisplayName: true);
                        string message = &quot;Removed Associations for document &quot; + document.DocName;
                        string activity = &quot;Associations Removed&quot;;
                        Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                        int FolderId = Request.QueryString[&quot;FID&quot;].ToInt32_2();
                        additionalParam.Add(&quot;FolderId&quot;, FolderId.ToString());
                        Dictionary&lt;string, object&gt; resultObject =
                            DocumentManager.Instance.GetLogMessage(GetActiveItemValue(&quot;DocId&quot;).ToInt32_2(),
                                &quot;Disassociate&quot;, additionalParam);
                        if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                        {
                            message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                            activity = resultObject[&quot;activity&quot;].ToString();
                        }

                        DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, document.DocId,
                            String.Format(
                                &quot;&lt;ACTION&gt;{6}&lt;/ACTION&gt;&lt;DOCNAME&gt;&lt;![CDATA[{0}]]&gt;&lt;/DOCNAME&gt;&lt;MasterFile&gt;{1}&lt;/MasterFile&gt;&lt;MasterFolder&gt;{2}&lt;/MasterFolder&gt;&lt;FOLDER&gt;{3}&lt;/FOLDER&gt;&lt;FOLDERID&gt;{4}&lt;/FOLDERID&gt;&lt;PROJECTID&gt;{5}&lt;/PROJECTID&gt;&quot;,
                                document.DocName, masterDoc.DocName, mfolder, folder, folderID, ProjectID, activity),
                            message);
                        //DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, document.DocId, String.Format(&quot;&lt;ACTION&gt;Disassociated Document&lt;/ACTION&gt;&lt;DOCNAME&gt;{0}&lt;/DOCNAME&gt;&lt;MasterFile&gt;{1}&lt;/MasterFile&gt;&lt;MasterFolder&gt;{2}&lt;/MasterFolder&gt;&lt;FOLDER&gt;{3}&lt;/FOLDER&gt;&lt;FOLDERID&gt;{4}&lt;/FOLDERID&gt;&lt;PROJECTID&gt;{5}&lt;/PROJECTID&gt;&quot;, document.DocName, masterDoc.DocName, DocumentManager.Instance.GetFolderName(masterDoc.FolderId, getDisplayName: true), DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(), getDisplayName: true), Request.QueryString[&quot;FID&quot;].ToString(), ProjectID));
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the lnkGetPackage control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        /// &lt;exception cref=&quot;System.Exception&quot;&gt;Please select atleast one document to download.&lt;/exception&gt;
        private void lnkGetPackage_Click(object sender, EventArgs e)
        {
            List&lt;string&gt; filePathList = new List&lt;string&gt;();
            string baseTempFolder = Path.GetTempPath();

            try
            {
                UserDetail ud = UserDetail.GetCurrentUserDetail();
                string userid = &quot;&quot;;
                if (ud != null)
                    userid = ud.UserID;

                baseTempFolder = Path.Combine(baseTempFolder, userid);

                if (!Directory.Exists(baseTempFolder))
                    Directory.CreateDirectory(baseTempFolder);

                string selectdIds = GetSelectedItemsFromGrid();


                List&lt;string&gt; CheckComponents =
                    Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);

                if (!selectdIds.EndsWith(&quot;,&quot;)) selectdIds += &quot;,&quot;;

                string[] selectedIdsArray = selectdIds.Split(&quot;,&quot;.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);

                for (int i = 0; i &lt; mwGrid.MasterTableView.Items.Count; i++)
                {
                    if (!selectedIdsArray.Contains(mwGrid.MasterTableView.Items[i][&quot;DocId&quot;].Text))
                        continue;

                    string docType = mwGrid.MasterTableView.Items[i][&quot;DocType&quot;].Text;
                    string storageid = mwGrid.MasterTableView.Items[i][&quot;StorageId&quot;].Text;
                    string docName = mwGrid.MasterTableView.Items[i][&quot;DocName&quot;].Text;
                    int docId = mwGrid.MasterTableView.Items[i][&quot;DocId&quot;].Text.ToInt32_2();
                    string docfullName = mwGrid.MasterTableView.Items[i][&quot;DocName&quot;].ToString2() + &quot;.&quot; +
                                         mwGrid.MasterTableView.Items[i][&quot;DocType&quot;].Text.ToLower();
                    string tempFolder = baseTempFolder;

                    string fullPath = Path.Combine(tempFolder, docName + &quot;.&quot; + docType);

                    DocumentWebService docservice = new DocumentWebService();
                    byte[] fileBytes = docservice.OpenDocument(null, storageid, null);

                    if (docType.ToLower() == &quot;dwg&quot;)
                    {
                        GetAssoicationTypeIDs();
                        DataSet associatedDocuments = DocumentManager.Instance.GetAssociatedDocs(docId, _xref);

                        if (associatedDocuments == null || associatedDocuments.Tables.Count == 0 ||
                            associatedDocuments.Tables[0].Rows.Count == 0)
                        {
                            File.WriteAllBytes(fullPath, fileBytes);
                            filePathList.Add(fullPath);
                            if (CheckComponents.Contains(&quot;LogActivities&quot;))
                            {
                                string fname =
                                    HttpUtility.HtmlEncode(
                                        DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                                            getDisplayName: true));
                                string message = &quot;Document &quot; + docName + &quot;downloaded&quot;;
                                string activity = &quot;Downloaded Document&quot;;
                                Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                                int FolderId = Request.QueryString[&quot;FID&quot;].ToInt32_2();
                                additionalParam.Add(&quot;FolderId&quot;, FolderId.ToString());
                                Dictionary&lt;string, object&gt; resultObject =
                                    DocumentManager.Instance.GetLogMessage(GetActiveItemValue(&quot;DocId&quot;).ToInt32_2(),
                                        &quot;Download&quot;, additionalParam);
                                if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                                {
                                    message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                                    activity = resultObject[&quot;activity&quot;].ToString();
                                }

                                DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docId,
                                    String.Format(
                                        &quot;&lt;ACTION&gt;{4} &lt;/ACTION&gt;&lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt; {1} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                                        docfullName, fname, FolderId, ProjectID, activity), message);
                            }
                            continue;
                        }
                        else
                        {
                            tempFolder = Path.Combine(tempFolder, docName);

                            if (!Directory.Exists(tempFolder))
                                Directory.CreateDirectory(tempFolder);

                            fullPath = Path.Combine(tempFolder, docName);
                            File.WriteAllBytes(fullPath, fileBytes);
                            filePathList.Add(fullPath);
                            if (CheckComponents.Contains(&quot;LogActivities&quot;))
                            {
                                string fname =
                                    UIHelper.JavascriptEncode(
                                        DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                                            getDisplayName: true));

                                string message = &quot;Document &quot; + docName + &quot;downloaded&quot;;
                                string activity = &quot;Downloaded Document&quot;;
                                Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                                int FolderId = Request.QueryString[&quot;FID&quot;].ToInt32_2();
                                additionalParam.Add(&quot;FolderId&quot;, FolderId.ToString());
                                Dictionary&lt;string, object&gt; resultObject =
                                    DocumentManager.Instance.GetLogMessage(GetActiveItemValue(&quot;DocId&quot;).ToInt32_2(),
                                        &quot;Download&quot;, additionalParam);
                                if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                                {
                                    message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                                    activity = resultObject[&quot;activity&quot;].ToString();
                                }

                                DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docId,
                                    String.Format(
                                        &quot;&lt;ACTION&gt;{4} &lt;/ACTION&gt;&lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt; {1} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                                        docfullName, fname, FolderId, ProjectID, activity), message);
                                //DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docId, String.Format(&quot;&lt;ACTION&gt;Downloaded Document &lt;/ACTION&gt;&lt;DOCNAME&gt; {0} &lt;/DOCNAME&gt; &lt;FOLDER&gt; {1} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;, docfullName, HttpUtility.HtmlEncode(DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(), getDisplayName: true)), Request.QueryString[&quot;FID&quot;], ProjectID));
                            }
                        }

                        foreach (DataRow dr in associatedDocuments.Tables[0].Rows)
                        {
                            storageid = dr[&quot;StorageId&quot;].ToString();
                            docName = dr[&quot;DocName&quot;].ToString();
                            //docType = dr[&quot;TypeDesc&quot;].ToString();
                            fullPath = Path.Combine(tempFolder, docName);

                            fileBytes = docservice.OpenDocument(null, storageid, null);
                            File.WriteAllBytes(fullPath, fileBytes);

                            filePathList.Add(fullPath);
                            if (CheckComponents.Contains(&quot;LogActivities&quot;))
                            {
                                string fname =
                                    UIHelper.JavascriptEncode(
                                        DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                                            getDisplayName: true));
                                string message = &quot;Document &quot; + docName + &quot;downloaded&quot;;
                                string activity = &quot;Downloaded Document&quot;;
                                Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                                int FolderId = Request.QueryString[&quot;FID&quot;].ToInt32_2();
                                additionalParam.Add(&quot;FolderId&quot;, FolderId.ToString());
                                Dictionary&lt;string, object&gt; resultObject =
                                    DocumentManager.Instance.GetLogMessage(GetActiveItemValue(&quot;DocId&quot;).ToInt32_2(),
                                        &quot;Download&quot;, additionalParam);
                                if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                                {
                                    message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                                    activity = resultObject[&quot;activity&quot;].ToString();
                                }

                                DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docId,
                                    String.Format(
                                        &quot;&lt;ACTION&gt;{4} &lt;/ACTION&gt;&lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt; {1} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                                        docfullName, fname, FolderId, ProjectID, activity), message);
                            }
                        }
                    }
                    else
                    {
                        File.WriteAllBytes(fullPath, fileBytes);
                        filePathList.Add(fullPath);
                        if (CheckComponents.Contains(&quot;LogActivities&quot;))
                        {
                            string fname =
                                UIHelper.JavascriptEncode(
                                    DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                                        getDisplayName: true));
                            string message = &quot;Document &quot; + docName + &quot;downloaded&quot;;
                            string activity = &quot;Downloaded Document&quot;;
                            Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                            int FolderId = Request.QueryString[&quot;FID&quot;].ToInt32_2();
                            additionalParam.Add(&quot;FolderId&quot;, FolderId.ToString());
                            Dictionary&lt;string, object&gt; resultObject =
                                DocumentManager.Instance.GetLogMessage(GetActiveItemValue(&quot;DocId&quot;).ToInt32_2(),
                                    &quot;Download&quot;, additionalParam);
                            if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                            {
                                message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                                activity = resultObject[&quot;activity&quot;].ToString();
                            }

                            DocumentManager.Instance.UpdateActivityLog(&quot;Document&quot;, docId,
                                String.Format(
                                    &quot;&lt;ACTION&gt;{4}&lt;/ACTION&gt;&lt;DOCNAME&gt; &lt;![CDATA[{0}]]&gt; &lt;/DOCNAME&gt; &lt;FOLDER&gt; {1} &lt;/FOLDER&gt;&lt;FOLDERID&gt;  {2} &lt;/FOLDERID&gt;&lt;PROJECTID&gt;{3} &lt;/PROJECTID&gt;&quot;,
                                    docfullName, fname, Request.QueryString[&quot;FID&quot;], ProjectID, activity), message);
                        }
                    }
                }

                if (filePathList.Count == 0)
                    throw new Exception(&quot;Please select at least one document to download.&quot;);

                // DocumentManager.Instance.DownloadZipToBrowser(baseTempFolder);
                string sesName = &quot;PkgDownload&quot; + ud.UserID.ToString2() + &quot;FilePath&quot;;
                HttpContext.Current.Session[sesName] = baseTempFolder;
                HttpContext.Current.Session[sesName + &quot;PathList&quot;] = filePathList;
                RegisterDownloadFileScript(0, false, 0, 2);

                //ClearTemporaryFiles(filePathList);
                //ForceDeleteDirectory(baseTempFolder);
            }
            catch (Exception ex)
            {
                ClearTemporaryFiles(filePathList);
                ForceDeleteDirectory(baseTempFolder);
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), ex.Message,
                    &quot;ShowError(&#39;&quot; + ex.Message + &quot;&#39;);&quot;, true);
            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the btnDelFolder control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        protected void btnDelFolder_Click(object sender, EventArgs e)
        {
            string s;
            var foldername = DocumentManager.Instance.GetFolderName(Request.QueryString[&quot;FID&quot;].ToInt32_2());
            Folder thisFolder = DocumentManager.Instance.GetFolderDetails(Convert.ToInt32(Request.QueryString[&quot;FID&quot;]));
            if (
                !string.IsNullOrEmpty(
                    (s =
                        DocumentManager.Instance.DeleteFolderContents(
                            DocumentManager.Instance.GetFolderDetails(Request.QueryString[&quot;FID&quot;].ToInt32_2())))))
            {
                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                    HttpContext.Current.CurrentHandler.GetType(), s,
                    &quot;ShowError(&#39;&quot; + UIHelper.JavascriptEncode(s) + &quot;&#39;);&quot;, true);
            }
            else
            {
                List&lt;string&gt; CheckComponents =
                    Aurigo.AMP3.ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);

                //Log Folder created activity
                if (CheckComponents.Contains(&quot;LogActivities&quot;))
                {
                    string message = string.Format(&quot;Deleted folder {0} &quot;, foldername);
                    string activity = &quot;Deleted Folder&quot;;

                    Dictionary&lt;string, object&gt; additionalParam = new Dictionary&lt;string, object&gt;();
                    additionalParam.Add(&quot;folderName&quot;, thisFolder.FolderName);
                    additionalParam.Add(&quot;ParentId&quot;, thisFolder.ParentId.ToString());
                    Dictionary&lt;string, object&gt; resultObject =
                        DocumentManager.Instance.GetLogMessageForFolder(thisFolder.FolderId.ToInt32_2(), &quot;DeleteFolder&quot;, additionalParam);

                    if (resultObject.ContainsKey(&quot;message&quot;) &amp;&amp; resultObject.ContainsKey(&quot;activity&quot;))
                    {
                        message = HttpUtility.HtmlEncode(resultObject[&quot;message&quot;].ToString());
                        activity = resultObject[&quot;activity&quot;].ToString();
                    }

                    DocumentManager.Instance.UpdateActivityLog(&quot;Folder&quot;, Request.QueryString[&quot;FID&quot;].ToInt32_2(),
                        string.Format(&quot;&lt;ACTION&gt;{2} &lt;/ACTION&gt;&lt;OLDFOLDER&gt; {0}&lt;/OLDFOLDER&gt;&lt;PROJECTID&gt;{1} &lt;/PROJECTID&gt; &quot;,
                            UIHelper.JavascriptEncode(foldername), ProjectID, activity), message);
                }
            }
            //Response.Redirect(&quot;~/Common/BrixListPage.aspx&quot; + Request.Url.Query );
            string redirectFolderPath = string.Format(&quot;~/Common/BrixListPage.aspx?context=DOCMGMT&amp;FID={0}&amp;PID={1}&amp;IID={2}&amp;MID={3}&amp;nt=1&quot;,
                thisFolder.ParentId.ToString(), PID, IID, MID);

            Request.QueryString.AllKeys.ForEach(x =&gt;
            {
                if (!x.IsEqualToAny(&quot;context&quot;, &quot;FID&quot;, &quot;PID&quot;, &quot;IID&quot;, &quot;MID&quot;, &quot;nt&quot;))
                    redirectFolderPath = string.Format(&quot;{0}&amp;{1}={2}&quot;, redirectFolderPath, x, Request[x]);
            });

            Response.Redirect(redirectFolderPath, false);
        }

        /// &lt;summary&gt;
        /// Registers a javascript to download the required file.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;docId&quot;&gt;DocId of the file to be downloaded&lt;/param&gt;
        /// &lt;param name=&quot;isCheckOut&quot;&gt;Is the file being downloaded for checkout&lt;/param&gt;
        private void RegisterDownloadFileScript(int docId, bool isCheckOut, int version, int sesMode = 0)
        {
            if (sesMode == 0)
                Page.ClientScript.RegisterStartupScript(this.GetType(), &quot;DownloadDocument&quot;,
                    &quot;$(document).ready(function () { DownloadDocument(&quot; + UIHelper.JavascriptEncode(docId.ToString()) + &quot;,&quot; + (isCheckOut ? &quot;1&quot; : &quot;0&quot;) + &quot;,&quot; +
                    UIHelper.JavascriptEncode(version.ToString()) + &quot;,&quot; + UIHelper.JavascriptEncode(sesMode.ToString()) + &quot;); });&quot;, true);
            else
                Page.ClientScript.RegisterStartupScript(this.GetType(), &quot;GetDoc&quot;,
                    &quot;$(document).ready(function () { GetFile(&quot; + UIHelper.JavascriptEncode(sesMode.ToString()) + &quot;); });&quot;, true);
        }

        /// &lt;summary&gt;
        /// Use this method to register all javascript methods on Page_Load
        /// &lt;/summary&gt;
        private void RegisterJavaScriptFunctionDefinitions()
        {
            string script = @&quot;function DownloadDocument(docID, IsCheckOut,version) 
                            {
                                var iframe = document.createElement(&#39;iframe&#39;);
                                if(IsCheckOut == 1)
                                    iframe.src = &#39;/Modules/DOCMGMT/DocumentDownload.aspx?DD=&#39; + docID+&#39;&amp;IsCheckOut=1&amp;Version=&#39;+version;
                                else if (IsCheckOut == undefined || IsCheckOut &lt;= 0) 
                                    iframe.src = &#39;/Modules/DOCMGMT/DocumentDownload.aspx?DD=&#39; + docID+&#39;&amp;Version=&#39;+version;      

                                iframe.style.display = &#39;none&#39;;
	                            document.body.appendChild(iframe);
      
                                return false;
                            }
                            function GetFile(Mode)
                            {
                                var iframe;
                                iframe = document.getElementById(&#39;frameDownloadDoc&#39;);
                                if (iframe == null)
                                {
                                    iframe = document.createElement(&#39;iframe&#39;);
                                    iframe.id=&#39;frameDownloadDoc&#39;;
                                    iframe.style.display = &#39;none&#39;;
	                                document.body.appendChild(iframe);    
                                } 
                                iframe.src = &#39;/Modules/DOCMGMT/DocumentDownload.aspx?SesMode=&#39; + Mode;
                                return false;
                            }          
                            &quot;;

            Page.ClientScript.RegisterClientScriptBlock(this.GetType(), &quot;RegisterDownloadDocumentDefinitionScript&quot;,
                script, true);
        }

        public override string GetEditPageURL(string pID, string parentID, string instanceID, string context)
        {
            Document docDetails = DocumentManager.Instance.ViewDocumentDetails(instanceID.ToInt32_2());
            if (docDetails != null)
                return (&quot;~/Modules/DOCMGMT/Documents.aspx?FID=&quot; + docDetails.FolderId + &quot;&amp;PID=&quot; + pID + &quot;&amp;IID=&quot; +
                        docDetails.SrcID + &quot;&amp;MID=&quot; + docDetails.SrcModuleID + &quot;&amp;Mode=Edit&quot; + &quot;&amp;DocId=&quot; + instanceID);
            else
                return base.GetViewPageURL(pID, parentID, instanceID, context);
        }

        public override string GetViewPageURL(string pID, string parentID, string instanceID, string context)
        {
            Document docDetails = DocumentManager.Instance.ViewDocumentDetails(instanceID.ToInt32_2());
            if (docDetails != null)
                return (&quot;~/Modules/DOCMGMT/Documents.aspx?FID=&quot; + docDetails.FolderId + &quot;&amp;PID=&quot; + pID + &quot;&amp;IID=&quot; +
                        docDetails.SrcID + &quot;&amp;MID=&quot; + docDetails.SrcModuleID + &quot;&amp;Mode=Edit&quot; + &quot;&amp;DocId=&quot; + instanceID);
            else
                return base.GetViewPageURL(pID, parentID, instanceID, context);
        }

        #region DocuSign Integration
        void SignDocuments_Click(object sender, EventArgs e)
        {

            int docid; string Name, docType, docFullName;
            GridDataItem GridRow = MWGrid.GetSelectedRow&lt;RadGrid&gt;(mwGrid) as GridDataItem;

            if (GridRow == null)
            {
                throw new Exception(&quot;Please select a record.&quot;);
            }
            else
            {
                docid = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;DocId&quot;).ToInt32_2();
                Name = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;DocName&quot;).ToString();
                docType = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;DocType&quot;).ToString();
            }

            UserDetail ud = UserDetail.GetCurrentUserDetail();
            Document doc = DocumentManager.Instance.ViewDocumentDetails(docid);

            int signTimeout = 5;
            if (AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocuSignTimeOutMin&quot;))
                signTimeout = AMP3ApplicationSettings.Instance.appSettings[&quot;DocuSignTimeOutMin&quot;].ToInt32_2();

            if (doc.SignLockedOn.HasValue &amp;&amp; (doc.SignLockedBy.Trim() != ud.UserName))
            {
                double lockTime = DateTime.UtcNow.Subtract(doc.SignLockedOn.Value.ToDateTime_MWCulture()).Minutes;
                if (lockTime &lt; signTimeout)
                {
                    string message = string.Format(&quot;This document is locked for Signing by {0}, please retry after {1} mins&quot;, doc.SignLockedBy, (signTimeout - lockTime));
                    ShowError(message);
                    return;
                }
            }

            int masterDocID = docid;

            docFullName = Name + &quot;.&quot; + docType;
            if (doc.SignedDocID &gt; 0)
            {
                docid = doc.SignedDocID;
                docType = &quot;PDF&quot;;
            }
            string fullName = ud.FirstName + &quot; &quot; + ud.LastName;

            try
            {
                string envelopeId = DocuSignManager.Instance.CreateEnvelopeFromDocuments(docid, docFullName, docType, ud.Email, fullName);
                DocumentManager.Instance.LockDocumentForSigning(masterDocID, ud.UserName);

                string returnUrlKey = Guid.NewGuid().ToString();
                (HttpContext.Current.CurrentHandler as Page).Session[returnUrlKey] = Request.Url.ToString();
                string returnURL = Request.Url.Scheme + &quot;://&quot; + Request.Url.Authority + &quot;/Modules/DOCMGMT/DSSignComplete.aspx?envelopeID=&quot;
                    + envelopeId + &quot;&amp;&quot; + &quot;returnUrlKey=&quot; + returnUrlKey
                    + &quot;&amp;signedDocID=&quot; + docid + &quot;&amp;docID=&quot; + masterDocID;

                string pathToRedirect = DocuSignManager.Instance.GetSigningViewURL(envelopeId, returnURL, ud.Email, fullName);
                Response.Redirect(pathToRedirect);
            }
            catch
            {
                ShowError(&quot;Error occurred with DocuSign&quot;);
            }

        }
        void SendDocumentsForSign_Click(object sender, EventArgs e)
        {
            int docid; string Name, docFullName, docType;

            GridDataItem GridRow = MWGrid.GetSelectedRow&lt;RadGrid&gt;(mwGrid) as GridDataItem;

            if (GridRow == null)
            {
                throw new Exception(&quot;Please select a record.&quot;);
            }
            else
            {
                docid = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;DocId&quot;).ToInt32_2();
                Name = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;DocName&quot;).ToString();
                docType = MWGrid.GetCellValueForSelectedRow&lt;RadGrid&gt;(mwGrid, &quot;DocType&quot;).ToString();

                docFullName = Name + &quot;.&quot; + docType;
            }

            UserDetail ud = UserDetail.GetCurrentUserDetail();
            string fullName = ud.FirstName + &quot; &quot; + ud.LastName;

            string envelopURI = DocuSignManager.Instance.CreateEnvelopeFromDocuments(docid, docFullName, docType, ud.Email, fullName, true);
            string pathToRedirect = DocuSignManager.Instance.GetSendViewURL(envelopURI, Request.Url.ToString());

            Response.Redirect(pathToRedirect);
        }

        protected void DocuSignConsole_Click(object sender, EventArgs e)
        {
            Response.Redirect(DocuSignManager.Instance.GetConsoleURL());
        }
        #endregion

        #endregion


    }

    public enum OfflineSettingsType
    {
        Folder,
        Document
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[45,29,45,33,1],[45,34,45,38,1],[55,9,55,62,1],[56,9,56,56,1],[58,9,58,51,1],[59,9,59,42,1],[60,9,60,57,1],[81,9,81,30,1],[81,32,81,46,1],[86,17,86,18,1],[86,19,86,36,1],[86,37,86,38,1],[91,17,91,18,1],[91,19,91,42,1],[91,43,91,44,1],[97,13,97,14,0],[98,17,98,51,0],[100,13,100,14,0],[105,17,105,18,1],[105,19,105,71,1],[105,72,105,73,1],[110,17,110,18,0],[110,19,110,53,0],[110,54,110,55,0],[115,17,115,18,0],[115,19,115,52,0],[115,53,115,54,0],[121,13,121,14,1],[122,17,122,48,1],[123,21,123,104,1],[125,17,125,43,1],[126,13,126,14,1],[132,13,132,14,1],[133,17,133,54,1],[134,21,134,117,1],[136,17,136,49,1],[137,13,137,14,1],[143,13,143,14,1],[144,17,144,48,1],[145,21,145,131,1],[147,17,147,43,1],[148,13,148,14,1],[154,13,154,14,1],[155,17,155,34,1],[157,17,157,75,1],[158,21,158,80,1],[160,17,160,33,1],[161,13,161,14,1],[170,17,170,18,1],[170,19,170,34,1],[170,35,170,36,1],[179,17,179,18,1],[179,19,179,36,1],[179,37,179,38,1],[183,9,183,10,1],[184,13,184,75,1],[185,9,185,10,1],[193,17,193,18,1],[193,19,193,96,1],[193,97,193,98,1],[202,17,202,18,1],[202,19,202,36,1],[202,37,202,38,1],[203,17,203,18,1],[203,19,203,37,1],[203,38,203,39,1],[209,13,209,14,1],[210,17,210,40,1],[211,21,211,81,1],[213,17,213,35,1],[214,13,214,14,1],[220,13,220,14,1],[221,17,221,55,1],[222,21,222,56,1],[224,17,224,36,1],[225,13,225,14,1],[230,17,230,18,1],[230,19,230,32,1],[230,33,230,34,1],[236,13,236,14,1],[237,17,237,29,1],[238,13,238,14,1],[244,13,244,14,1],[245,17,245,60,1],[246,13,246,14,1],[249,49,249,53,1],[249,54,249,58,1],[250,64,250,68,0],[250,69,250,73,1],[259,13,259,14,0],[261,17,261,47,0],[265,17,265,63,0],[266,17,266,18,0],[267,21,269,78,0],[270,17,270,18,0],[274,17,274,67,0],[276,17,276,88,0],[277,17,277,18,0],[278,21,278,79,0],[279,21,279,22,0],[280,25,280,100,0],[281,25,282,82,0],[283,25,283,26,0],[284,29,284,181,0],[285,25,285,26,0],[286,21,286,22,0],[289,21,289,22,0],[290,25,290,153,0],[291,29,291,181,0],[292,21,292,22,0],[293,17,293,18,0],[295,17,295,43,0],[297,17,297,68,0],[301,17,301,67,0],[302,17,302,58,0],[303,21,303,91,0],[305,21,305,40,0],[307,17,307,57,0],[308,21,308,94,0],[310,21,310,41,0],[312,17,312,57,0],[313,17,313,18,0],[314,21,314,105,0],[315,17,315,18,0],[317,21,317,41,0],[320,17,320,108,0],[321,17,321,64,0],[323,17,323,100,0],[324,21,324,97,0],[325,17,325,100,0],[326,21,326,101,0],[327,17,327,108,0],[328,21,328,112,0],[329,17,329,102,0],[330,21,330,112,0],[332,17,332,83,0],[333,17,333,18,0],[334,21,334,130,0],[335,21,335,127,0],[336,17,336,18,0],[338,17,338,49,0],[339,21,339,59,0],[341,17,342,51,0],[343,21,343,98,0],[344,17,344,59,0],[345,21,345,100,0],[347,21,347,43,0],[349,17,349,72,0],[350,17,350,18,0],[352,21,352,94,0],[353,21,353,115,0],[354,21,354,53,0],[355,21,355,70,0],[356,25,356,111,0],[357,17,357,18,0],[359,17,359,117,0],[360,17,360,67,0],[361,17,361,60,0],[362,21,362,112,0],[363,17,363,60,0],[364,21,365,52,0],[366,17,366,59,0],[367,21,367,109,0],[368,17,368,52,0],[369,21,369,62,0],[371,17,371,66,0],[372,21,372,115,0],[376,17,376,113,0],[377,17,377,57,0],[378,17,378,18,0],[379,21,379,65,0],[380,21,380,22,0],[381,25,381,112,0],[382,21,382,22,0],[383,21,383,71,0],[384,25,384,109,0],[385,21,385,75,0],[386,25,386,114,0],[387,17,387,18,0],[390,17,391,149,0],[392,21,392,109,0],[397,17,397,108,0],[398,17,398,59,0],[399,17,399,57,0],[400,17,400,18,0],[401,21,401,118,0],[402,21,402,123,0],[403,17,403,18,0],[405,17,405,90,0],[406,17,406,18,0],[409,21,409,140,0],[410,21,410,149,0],[411,17,411,18,0],[413,17,413,77,0],[414,17,414,18,0],[415,21,415,54,0],[416,17,416,18,0],[418,17,418,57,0],[419,21,419,109,0],[424,17,424,76,0],[425,17,425,18,0],[426,21,426,69,0],[427,21,427,22,0],[428,25,428,122,0],[430,25,431,61,0],[432,25,432,66,0],[434,25,435,61,0],[436,25,436,70,0],[438,25,439,61,0],[440,25,440,70,0],[442,25,442,62,0],[443,21,443,22,0],[445,21,445,102,0],[446,21,446,22,0],[447,25,447,149,0],[448,25,448,58,0],[449,21,449,22,0],[450,17,450,18,0],[456,17,456,112,0],[457,17,457,18,0],[458,21,458,137,0],[459,21,459,50,0],[460,17,460,18,0],[462,17,462,129,0],[463,17,463,18,0],[464,21,464,149,0],[465,21,465,55,0],[466,17,466,18,0],[470,17,470,50,0],[471,21,471,50,0],[473,17,473,69,0],[474,17,474,57,0],[475,17,475,18,0],[476,21,476,112,0],[477,17,477,18,0],[479,17,479,179,0],[480,17,480,77,0],[481,17,481,18,0],[482,21,482,131,0],[483,17,483,18,0],[485,17,485,47,0],[491,17,491,67,0],[492,17,492,60,0],[493,21,493,104,0],[494,17,494,73,0],[495,21,495,103,0],[496,17,496,75,0],[497,21,497,109,0],[500,17,500,146,0],[501,21,501,115,0],[505,17,505,83,0],[506,17,506,18,0],[507,21,507,51,0],[508,25,508,132,0],[510,25,510,129,0],[511,17,511,18,0],[513,17,513,51,0],[514,21,514,51,0],[519,17,519,77,0],[520,17,520,18,0],[521,21,521,151,0],[522,21,522,22,0],[523,25,523,149,0],[524,25,524,65,0],[525,25,525,114,0],[527,25,527,79,0],[528,25,528,26,0],[529,29,529,117,0],[530,29,530,114,0],[531,25,531,26,0],[533,25,533,56,0],[534,21,534,22,0],[535,17,535,18,0],[538,17,538,71,0],[539,17,539,18,0],[540,21,540,56,0],[541,17,541,18,0],[542,17,542,35,0],[543,13,543,14,0],[549,13,549,14,0],[550,17,550,68,0],[551,13,551,14,0],[559,9,559,10,1],[560,13,560,35,1],[560,37,560,69,1],[562,13,563,109,1],[565,13,565,50,1],[566,13,566,80,1],[567,9,567,10,1],[570,9,570,10,1],[573,13,573,71,1],[574,17,574,28,1],[576,17,576,33,0],[578,13,580,80,1],[582,13,582,72,1],[583,17,583,29,1],[585,17,585,30,0],[586,9,586,10,1],[592,9,592,10,1],[593,13,593,33,1],[595,13,595,27,1],[597,13,597,77,1],[599,13,599,108,1],[600,13,600,97,1],[601,13,601,187,1],[602,13,602,192,1],[603,13,603,194,1],[607,13,607,109,1],[608,13,608,63,1],[609,13,609,84,1],[610,13,610,14,1],[611,17,611,70,1],[612,21,613,78,0],[614,13,614,14,1],[616,13,616,68,1],[617,13,617,138,1],[618,13,618,50,1],[619,13,619,46,1],[620,13,620,56,1],[621,13,621,60,1],[622,13,622,53,1],[624,13,624,106,1],[625,13,625,49,1],[627,13,627,104,1],[628,13,628,51,1],[629,13,629,94,1],[630,13,630,67,1],[631,13,631,69,1],[632,13,632,67,1],[633,13,633,68,1],[634,13,634,64,1],[635,13,635,52,1],[636,13,636,68,1],[637,13,637,66,1],[638,13,638,59,1],[640,13,640,104,1],[641,13,641,51,1],[642,13,642,94,1],[643,13,643,67,1],[644,13,644,69,1],[645,13,645,67,1],[646,13,646,68,1],[647,13,647,64,1],[648,13,648,52,1],[649,13,649,68,1],[650,13,650,66,1],[651,13,651,59,1],[653,13,653,108,1],[654,13,654,55,1],[655,13,655,98,1],[656,13,656,75,1],[657,13,657,73,1],[658,13,658,71,1],[659,13,659,72,1],[660,13,660,68,1],[661,13,661,56,1],[662,13,662,76,1],[663,13,663,70,1],[664,13,664,63,1],[666,13,666,110,1],[667,13,667,51,1],[668,13,668,134,1],[669,13,669,61,1],[670,13,670,107,1],[671,13,671,50,1],[672,13,672,201,1],[674,13,674,140,1],[675,13,675,91,1],[676,13,676,89,1],[677,13,677,64,1],[678,13,678,61,1],[679,13,679,75,1],[680,13,680,51,1],[681,13,681,66,1],[682,13,682,65,1],[683,13,683,58,1],[685,13,685,45,1],[686,13,686,54,1],[687,13,687,59,1],[688,13,688,52,1],[690,13,690,46,1],[691,13,691,56,1],[692,13,692,60,1],[693,13,693,53,1],[695,13,695,74,1],[696,13,696,48,1],[697,13,697,60,1],[698,13,698,62,1],[699,13,699,55,1],[701,13,701,77,1],[702,13,702,46,1],[703,13,703,60,1],[704,13,704,60,1],[705,13,705,50,1],[706,13,706,48,1],[708,13,708,56,1],[709,13,709,105,1],[710,17,710,131,0],[712,13,712,84,1],[713,13,713,14,0],[714,17,714,222,0],[715,17,715,102,0],[716,13,716,14,0],[718,13,718,124,1],[719,13,719,38,1],[720,13,720,14,1],[721,17,721,62,1],[722,17,722,50,1],[724,17,724,92,1],[725,13,725,14,1],[726,9,726,10,1],[729,9,729,10,1],[730,13,730,56,1],[732,13,732,53,1],[734,13,734,34,1],[735,13,735,14,1],[739,17,739,39,1],[740,17,742,42,1],[743,17,743,18,0],[744,21,744,104,0],[745,21,745,22,0],[746,25,746,119,0],[747,29,747,122,0],[749,25,749,26,0],[750,29,750,81,0],[751,25,751,26,0],[752,21,752,22,0],[754,25,754,127,0],[755,17,755,18,0],[757,17,757,77,1],[758,17,758,18,1],[759,21,759,55,1],[760,21,760,101,1],[761,25,761,118,0],[763,21,763,60,1],[764,21,764,22,0],[765,25,765,48,0],[766,25,766,100,0],[767,21,767,22,0],[768,17,768,18,1],[769,13,769,14,1],[770,9,770,10,1],[777,9,777,10,1],[778,13,778,214,1],[780,13,780,48,1],[782,13,782,61,1],[783,13,783,14,1],[784,17,790,75,1],[791,13,791,14,1],[792,13,792,61,1],[793,13,793,14,1],[794,17,794,120,1],[795,13,795,14,1],[797,13,797,63,1],[798,17,804,174,1],[806,13,806,69,1],[807,13,807,14,1],[808,17,810,136,1],[811,17,812,86,1],[813,17,814,118,1],[815,13,815,14,1],[817,13,817,67,1],[818,13,818,14,1],[819,17,821,134,1],[822,17,823,87,1],[824,13,824,14,1],[825,13,825,69,1],[826,13,826,14,1],[827,17,830,123,1],[831,17,831,89,1],[832,13,832,14,1],[833,13,833,72,1],[834,13,834,14,1],[835,17,835,66,1],[837,17,841,65,1],[843,17,844,85,1],[845,17,846,115,1],[847,13,847,14,1],[848,13,848,79,1],[849,13,849,14,1],[850,17,850,76,1],[852,17,855,55,1],[857,17,858,95,1],[859,17,861,71,1],[862,13,862,14,1],[863,13,863,65,1],[864,13,864,14,1],[865,17,870,97,1],[871,17,871,84,1],[872,13,872,14,1],[873,13,873,65,1],[874,13,874,14,1],[875,17,880,97,1],[881,17,881,90,1],[882,13,882,14,1],[884,13,884,69,1],[885,13,885,14,1],[886,17,891,101,1],[892,17,892,98,1],[893,13,893,14,1],[894,13,894,64,1],[895,17,900,96,1],[902,13,902,71,1],[903,13,903,14,1],[904,17,915,127,1],[916,17,917,83,1],[918,17,919,114,1],[920,13,920,14,1],[921,13,921,61,1],[922,13,922,14,0],[923,17,931,109,0],[934,17,935,82,0],[936,17,937,115,0],[939,13,939,14,0],[940,13,940,61,1],[941,13,941,14,0],[942,17,945,59,0],[947,17,953,116,0],[955,17,956,82,0],[957,17,958,115,0],[960,13,960,14,0],[961,13,961,65,1],[962,13,962,14,0],[963,17,966,63,0],[967,17,974,97,0],[975,17,976,90,0],[977,17,978,119,0],[980,13,980,14,0],[982,13,982,64,1],[983,17,988,96,1],[990,13,990,66,1],[991,17,991,101,1],[993,13,993,62,1],[994,13,994,14,1],[995,17,995,92,1],[996,13,996,14,1],[998,13,999,118,1],[1000,13,1000,60,1],[1001,13,1001,14,1],[1003,17,1003,70,1],[1004,17,1004,18,1],[1005,21,1010,102,1],[1011,21,1011,108,1],[1012,17,1012,18,1],[1013,13,1013,14,1],[1014,13,1014,68,1],[1015,17,1015,90,1],[1016,13,1016,67,1],[1017,17,1022,99,1],[1024,13,1024,62,1],[1025,13,1025,14,0],[1026,17,1031,94,0],[1032,13,1032,14,0],[1036,13,1036,70,1],[1037,13,1037,14,0],[1038,17,1039,167,0],[1040,17,1040,94,0],[1041,13,1041,14,0],[1042,13,1042,120,1],[1043,13,1043,46,1],[1044,13,1044,14,0],[1045,17,1051,92,0],[1053,17,1055,53,0],[1058,17,1060,76,0],[1061,13,1061,14,0],[1063,13,1063,74,1],[1064,13,1064,14,0],[1065,17,1072,214,0],[1073,17,1073,102,0],[1074,13,1074,14,0],[1075,13,1075,67,1],[1076,13,1076,14,0],[1077,17,1082,99,0],[1083,17,1083,88,0],[1084,13,1084,14,0],[1090,13,1090,114,1],[1091,13,1091,43,1],[1092,13,1092,14,0],[1093,17,1093,77,0],[1094,17,1094,68,0],[1095,13,1095,14,0],[1097,13,1097,108,1],[1098,13,1098,40,1],[1099,13,1099,14,0],[1100,17,1100,74,0],[1101,17,1101,62,0],[1102,13,1102,14,0],[1107,13,1107,73,1],[1108,13,1108,14,1],[1109,17,1109,107,1],[1110,17,1110,105,1],[1111,17,1111,97,1],[1113,17,1113,45,1],[1114,21,1114,84,1],[1116,17,1116,44,1],[1117,21,1117,90,0],[1119,17,1119,40,1],[1120,21,1120,81,0],[1121,13,1121,14,1],[1124,13,1124,71,1],[1125,13,1125,14,1],[1126,17,1131,98,1],[1132,17,1132,96,1],[1133,13,1133,14,1],[1135,13,1135,70,1],[1136,13,1136,14,1],[1137,17,1142,97,1],[1143,17,1143,94,1],[1144,13,1144,14,1],[1146,13,1146,74,1],[1147,13,1147,14,1],[1148,17,1148,102,1],[1149,13,1149,14,1],[1151,13,1151,73,1],[1152,13,1152,14,0],[1153,17,1153,100,0],[1154,13,1154,14,0],[1157,13,1157,66,1],[1158,17,1158,56,1],[1161,13,1161,68,1],[1162,13,1162,14,0],[1163,17,1168,99,0],[1169,17,1169,90,0],[1170,13,1170,14,0],[1172,9,1172,10,1],[1175,9,1175,10,0],[1179,13,1179,91,0],[1181,13,1181,33,0],[1182,13,1182,14,0],[1183,17,1183,54,0],[1184,13,1184,14,0],[1186,13,1186,14,0],[1187,17,1187,97,0],[1188,17,1188,105,0],[1189,17,1189,101,0],[1191,17,1191,83,0],[1192,17,1192,18,0],[1193,21,1193,166,0],[1194,21,1194,83,0],[1195,21,1195,42,0],[1196,21,1196,236,0],[1197,17,1197,18,0],[1199,17,1199,18,0],[1200,21,1200,82,0],[1201,17,1201,18,0],[1202,13,1202,14,0],[1203,9,1203,10,0],[1206,9,1206,10,0],[1207,13,1207,57,0],[1208,17,1208,99,0],[1210,13,1210,14,0],[1211,17,1212,131,0],[1213,17,1213,51,0],[1214,13,1214,14,0],[1215,9,1215,10,0],[1218,9,1218,10,0],[1219,13,1219,57,0],[1220,17,1220,99,0],[1222,13,1222,14,0],[1223,17,1224,130,0],[1225,17,1225,51,0],[1226,13,1226,14,0],[1227,9,1227,10,0],[1230,9,1230,10,0],[1231,13,1231,85,0],[1232,17,1232,98,0],[1234,13,1234,14,0],[1235,17,1236,136,0],[1237,17,1237,51,0],[1238,13,1238,14,0],[1239,9,1239,10,0],[1242,9,1242,10,0],[1243,13,1243,85,0],[1244,17,1244,98,0],[1246,13,1246,14,0],[1247,17,1248,139,0],[1249,17,1249,51,0],[1250,13,1250,14,0],[1251,9,1251,10,0],[1254,9,1254,10,1],[1256,13,1256,14,1],[1257,17,1257,52,1],[1257,52,1257,75,1],[1257,75,1257,96,1],[1257,96,1257,97,1],[1257,52,1257,97,1],[1257,97,1257,99,1],[1257,17,1257,99,1],[1259,17,1259,95,1],[1260,13,1260,14,1],[1261,13,1261,33,0],[1262,13,1262,14,0],[1263,13,1263,14,0],[1264,9,1264,10,1],[1267,9,1267,10,1],[1269,13,1269,14,1],[1270,17,1270,71,1],[1271,17,1271,18,1],[1272,21,1272,90,1],[1273,21,1273,70,1],[1274,21,1274,22,1],[1275,25,1275,107,1],[1277,25,1277,60,1],[1283,25,1283,69,1],[1284,21,1284,22,1],[1285,17,1285,18,1],[1286,13,1286,14,1],[1287,13,1287,33,0],[1288,13,1288,14,0],[1289,13,1289,14,0],[1290,9,1290,10,1],[1296,9,1296,10,1],[1297,13,1297,60,1],[1298,13,1298,35,1],[1299,13,1299,39,1],[1301,13,1302,122,1],[1303,13,1303,113,1],[1307,13,1309,81,1],[1313,13,1313,36,1],[1314,13,1314,99,1],[1315,13,1315,100,1],[1316,13,1316,73,1],[1317,13,1317,14,1],[1318,17,1318,116,1],[1319,13,1319,14,1],[1321,13,1321,14,1],[1322,17,1322,88,1],[1323,13,1323,14,1],[1325,13,1325,109,1],[1326,13,1326,126,1],[1328,13,1328,31,1],[1329,13,1329,14,0],[1331,17,1332,17,0],[1332,17,1332,18,0],[1332,18,1333,21,0],[1333,21,1333,66,0],[1333,66,1334,25,0],[1334,25,1338,138,0],[1338,138,1340,25,0],[1340,25,1343,138,0],[1343,138,1344,17,0],[1344,17,1344,18,0],[1344,18,1344,20,0],[1331,17,1344,20,0],[1345,13,1345,14,0],[1347,13,1347,108,1],[1348,13,1348,158,1],[1349,13,1349,109,1],[1350,13,1350,159,1],[1351,13,1351,99,1],[1353,13,1353,108,1],[1354,13,1354,115,1],[1355,13,1355,104,1],[1356,13,1356,116,1],[1358,13,1358,73,1],[1359,13,1359,14,1],[1360,17,1360,84,1],[1361,17,1361,89,1],[1362,17,1362,90,1],[1363,17,1363,87,1],[1364,17,1364,80,1],[1365,13,1365,14,1],[1367,13,1367,14,0],[1368,17,1368,97,0],[1369,17,1369,102,0],[1370,17,1370,103,0],[1371,17,1371,100,0],[1372,17,1372,93,0],[1373,13,1373,14,0],[1374,13,1374,94,1],[1375,13,1375,100,1],[1376,13,1376,100,1],[1378,13,1378,76,1],[1379,13,1379,80,1],[1380,13,1380,80,1],[1381,13,1381,79,1],[1382,13,1382,77,1],[1383,13,1383,80,1],[1384,13,1384,79,1],[1385,13,1385,77,1],[1386,13,1386,77,1],[1387,13,1387,82,1],[1388,13,1388,91,1],[1389,13,1389,80,1],[1390,13,1390,78,1],[1391,13,1391,78,1],[1392,13,1392,82,1],[1393,13,1393,81,1],[1394,9,1394,10,1],[1414,9,1414,10,1],[1415,13,1415,48,1],[1416,9,1416,10,1],[1428,9,1428,10,1],[1429,13,1429,31,1],[1431,13,1431,85,1],[1432,13,1432,83,1],[1433,13,1433,42,1],[1434,13,1434,31,1],[1436,13,1436,28,1],[1436,29,1436,45,1],[1438,13,1438,40,1],[1439,13,1439,31,1],[1440,13,1440,23,1],[1441,9,1441,10,1],[1444,9,1444,10,1],[1445,13,1445,67,1],[1445,67,1445,98,1],[1445,98,1445,156,1],[1445,13,1445,156,1],[1446,13,1446,27,1],[1447,9,1447,10,1],[1450,9,1450,10,1],[1451,13,1451,32,1],[1453,13,1453,72,1],[1454,13,1454,14,0],[1455,17,1455,75,0],[1456,17,1456,18,0],[1457,21,1457,111,0],[1458,21,1458,84,0],[1459,21,1459,64,0],[1460,21,1460,37,0],[1461,17,1461,18,0],[1463,17,1463,24,0],[1463,26,1463,43,0],[1463,44,1463,46,0],[1463,47,1463,75,0],[1464,17,1464,18,0],[1465,21,1465,80,0],[1466,25,1466,93,0],[1467,21,1467,102,0],[1468,25,1468,93,0],[1470,21,1470,49,0],[1471,21,1471,75,0],[1472,25,1472,45,0],[1473,26,1473,74,0],[1474,25,1474,46,0],[1475,26,1475,85,0],[1476,25,1476,43,0],[1477,26,1477,53,0],[1479,21,1479,58,0],[1480,17,1480,18,0],[1481,13,1481,14,0],[1482,9,1482,10,1],[1485,9,1485,10,0],[1486,13,1486,30,0],[1489,21,1489,110,0],[1491,21,1491,108,0],[1493,21,1493,113,0],[1495,21,1495,116,0],[1497,21,1498,130,0],[1500,21,1501,121,0],[1503,21,1503,117,0],[1505,21,1505,118,0],[1507,21,1507,118,0],[1509,13,1509,29,0],[1510,9,1510,10,0],[1516,9,1516,10,1],[1517,13,1519,112,1],[1520,9,1520,10,0],[1526,9,1526,10,0],[1528,13,1528,14,0],[1529,17,1529,58,0],[1530,17,1530,77,0],[1531,17,1531,79,0],[1532,17,1532,75,0],[1533,17,1533,75,0],[1535,17,1536,108,0],[1537,17,1537,18,0],[1538,21,1538,66,0],[1539,25,1543,123,0],[1545,25,1550,95,0],[1551,17,1551,18,0],[1552,22,1553,110,0],[1554,17,1554,18,0],[1555,21,1555,87,0],[1556,21,1556,22,0],[1557,25,1557,170,0],[1558,25,1558,48,0],[1559,25,1562,131,0],[1563,21,1563,22,0],[1565,21,1565,22,0],[1566,25,1566,83,0],[1567,21,1567,22,0],[1569,17,1569,18,0],[1571,17,1571,18,0],[1574,21,1574,71,0],[1575,21,1575,77,0],[1576,21,1576,66,0],[1577,21,1577,76,0],[1578,17,1578,18,0],[1579,17,1580,121,0],[1581,17,1581,63,0],[1582,17,1582,18,0],[1583,21,1583,72,0],[1584,21,1584,95,0],[1585,21,1585,107,0],[1586,21,1586,67,0],[1587,21,1587,55,0],[1588,21,1588,99,0],[1589,21,1589,74,0],[1590,21,1591,42,0],[1592,21,1592,101,0],[1593,21,1593,22,0],[1594,25,1594,94,0],[1595,25,1595,72,0],[1596,21,1596,22,0],[1598,21,1601,116,0],[1602,17,1602,18,0],[1603,13,1603,14,0],[1604,13,1604,33,0],[1605,13,1605,14,0],[1606,17,1608,63,0],[1609,13,1609,14,0],[1610,9,1610,10,0],[1616,9,1616,10,1],[1617,13,1617,42,1],[1618,13,1621,47,1],[1622,9,1622,10,0],[1629,9,1629,10,1],[1631,13,1631,14,1],[1633,17,1633,68,1],[1634,17,1634,45,1],[1635,17,1635,88,1],[1636,22,1636,31,1],[1636,33,1636,86,1],[1636,88,1636,91,1],[1637,17,1637,18,1],[1639,21,1639,95,1],[1640,21,1640,103,1],[1641,21,1641,97,1],[1642,21,1643,121,1],[1646,21,1646,22,1],[1647,25,1648,135,1],[1649,21,1649,22,1],[1650,21,1650,41,0],[1651,21,1651,22,0],[1652,25,1652,47,0],[1653,21,1653,22,0],[1655,17,1655,18,1],[1656,17,1656,36,1],[1657,21,1657,70,0],[1658,13,1658,14,1],[1659,13,1659,33,0],[1660,13,1660,14,0],[1661,17,1661,39,0],[1662,13,1662,14,0],[1663,13,1663,22,1],[1664,9,1664,10,1],[1668,9,1668,10,1],[1669,13,1669,36,1],[1672,13,1672,14,1],[1673,17,1673,80,1],[1674,17,1674,18,0],[1675,21,1676,109,0],[1678,17,1678,45,1],[1679,17,1679,51,1],[1680,17,1680,50,1],[1681,17,1681,90,1],[1683,17,1684,33,1],[1686,17,1686,24,1],[1686,26,1686,56,1],[1686,57,1686,59,1],[1686,60,1686,66,1],[1687,17,1687,18,1],[1688,21,1689,60,1],[1690,21,1690,79,1],[1691,21,1691,43,1],[1692,25,1692,84,1],[1693,17,1693,18,1],[1695,17,1695,48,1],[1696,17,1696,55,1],[1697,17,1697,18,0],[1698,21,1698,47,0],[1699,17,1699,18,0],[1700,22,1700,67,1],[1701,17,1701,18,1],[1702,21,1702,54,1],[1703,17,1703,18,1],[1704,17,1704,145,1],[1705,17,1705,62,1],[1706,17,1706,18,1],[1709,21,1709,125,1],[1712,21,1712,64,1],[1713,21,1713,22,1],[1714,25,1714,95,1],[1715,25,1715,89,1],[1716,21,1716,22,1],[1718,21,1718,57,1],[1719,21,1719,22,1],[1722,25,1722,26,1],[1723,29,1723,59,1],[1724,33,1724,166,0],[1725,25,1725,26,1],[1726,25,1726,30,0],[1727,25,1727,26,0],[1728,25,1728,26,0],[1731,25,1731,86,1],[1734,25,1734,43,1],[1735,25,1735,26,0],[1736,29,1736,106,0],[1737,29,1737,66,0],[1739,29,1739,107,0],[1740,29,1740,82,0],[1741,29,1743,64,0],[1744,29,1744,109,0],[1745,29,1745,30,0],[1746,33,1746,102,0],[1747,33,1747,80,0],[1748,29,1748,30,0],[1750,29,1752,109,0],[1753,29,1757,42,0],[1758,25,1758,26,0],[1759,25,1759,42,1],[1760,21,1760,22,1],[1762,21,1762,22,0],[1763,25,1763,74,0],[1765,17,1765,18,1],[1767,17,1767,18,0],[1768,21,1768,118,0],[1770,13,1770,14,1],[1771,13,1771,33,0],[1772,13,1772,14,0],[1773,17,1773,23,0],[1776,13,1776,30,1],[1777,9,1777,10,1],[1790,9,1790,10,1],[1791,13,1791,44,1],[1792,13,1792,43,1],[1793,13,1793,14,1],[1794,17,1794,46,1],[1796,17,1796,18,1],[1797,21,1797,67,1],[1798,21,1799,110,1],[1800,25,1802,120,0],[1805,26,1805,69,1],[1806,25,1808,104,1],[1811,25,1814,77,1],[1815,17,1815,18,1],[1816,17,1816,37,1],[1817,17,1817,18,1],[1818,21,1820,67,1],[1821,17,1821,18,1],[1822,17,1822,33,1],[1824,18,1824,51,1],[1825,13,1825,14,1],[1826,17,1826,58,1],[1827,17,1827,73,1],[1828,17,1828,71,1],[1829,17,1830,62,1],[1831,17,1831,62,1],[1833,17,1833,24,1],[1833,26,1833,34,1],[1833,35,1833,37,1],[1833,38,1833,48,1],[1834,17,1834,18,1],[1835,21,1835,66,1],[1836,25,1836,69,1],[1837,17,1837,18,1],[1838,17,1838,109,1],[1839,17,1839,33,1],[1841,18,1841,47,1],[1842,13,1842,14,1],[1844,17,1844,18,1],[1845,21,1845,76,1],[1846,21,1846,35,1],[1847,21,1847,36,1],[1848,21,1848,22,1],[1849,25,1849,61,1],[1850,30,1850,39,1],[1850,41,1850,94,1],[1850,96,1850,99,1],[1851,25,1851,26,1],[1852,29,1852,108,1],[1853,29,1854,108,1],[1855,29,1855,30,0],[1856,33,1856,123,0],[1858,25,1858,26,1],[1860,25,1863,111,1],[1864,25,1864,55,1],[1865,25,1865,55,1],[1866,25,1866,56,1],[1867,25,1867,78,1],[1868,25,1868,61,1],[1869,25,1869,61,1],[1870,25,1870,86,1],[1871,25,1871,88,1],[1872,25,1872,75,1],[1874,25,1874,86,1],[1875,25,1875,40,1],[1876,25,1876,26,1],[1877,29,1877,60,1],[1878,25,1878,26,1],[1880,25,1880,26,0],[1881,29,1885,147,0],[1886,29,1886,84,0],[1887,25,1887,26,0],[1888,21,1888,22,1],[1889,17,1889,18,1],[1891,17,1891,37,0],[1892,17,1892,18,0],[1893,21,1895,67,0],[1896,17,1896,18,0],[1898,17,1898,33,1],[1900,18,1900,118,1],[1901,13,1901,14,0],[1902,17,1902,62,0],[1903,17,1903,65,0],[1904,17,1904,53,0],[1905,17,1905,44,0],[1906,17,1906,45,0],[1907,17,1907,45,0],[1908,17,1908,81,0],[1909,17,1909,75,0],[1910,17,1910,33,0],[1912,18,1912,45,1],[1913,13,1913,14,0],[1915,17,1915,18,0],[1916,21,1916,65,0],[1917,21,1917,83,0],[1918,21,1918,79,0],[1919,21,1919,78,0],[1920,21,1920,83,0],[1922,21,1923,119,0],[1924,21,1924,59,0],[1925,25,1925,112,0],[1926,21,1926,105,0],[1928,21,1929,116,0],[1932,21,1933,35,0],[1934,21,1934,104,0],[1937,21,1937,108,0],[1940,21,1940,76,0],[1942,21,1943,90,0],[1944,21,1944,83,0],[1945,21,1945,88,0],[1946,21,1948,116,0],[1951,21,1951,97,0],[1952,21,1952,22,0],[1953,25,1956,93,0],[1957,21,1957,22,0],[1959,17,1959,18,0],[1960,17,1960,37,0],[1961,17,1961,18,0],[1962,21,1964,67,0],[1966,17,1966,18,0],[1967,17,1967,33,0],[1970,17,1970,57,1],[1971,9,1971,10,1],[1980,9,1980,10,1],[1981,13,1981,41,1],[1982,13,1982,33,1],[1986,21,1986,39,0],[1987,21,1987,122,0],[1988,21,1988,48,0],[1989,21,1989,83,0],[1990,21,1990,47,0],[1991,21,1991,27,0],[1993,21,1993,99,1],[1994,21,1994,27,1],[1997,13,1997,26,1],[1998,9,1998,10,1],[2011,9,2011,10,1],[2012,13,2012,63,1],[2015,13,2016,86,1],[2018,13,2018,42,1],[2019,13,2019,35,1],[2020,13,2020,14,1],[2022,17,2023,36,1],[2023,36,2023,59,1],[2023,59,2024,44,1],[2024,44,2024,68,0],[2024,68,2024,70,1],[2022,17,2024,70,1],[2025,13,2025,14,1],[2027,17,2027,33,1],[2031,13,2031,40,1],[2033,13,2033,43,1],[2034,13,2034,14,0],[2035,17,2035,36,0],[2037,17,2042,89,0],[2046,17,2046,55,0],[2047,17,2047,39,0],[2048,17,2048,53,0],[2049,17,2049,42,0],[2050,17,2050,50,0],[2051,17,2051,107,0],[2054,17,2054,60,0],[2061,17,2061,43,0],[2062,17,2062,18,0],[2063,21,2063,28,0],[2063,30,2063,44,0],[2063,45,2063,47,0],[2063,48,2063,70,0],[2064,21,2064,22,0],[2065,25,2065,55,0],[2066,25,2066,26,0],[2067,29,2067,95,0],[2068,29,2069,108,0],[2070,29,2070,30,0],[2071,33,2071,94,0],[2074,33,2074,46,0],[2075,33,2075,34,0],[2076,37,2078,82,0],[2079,33,2079,34,0],[2081,33,2081,34,0],[2083,37,2083,63,0],[2084,33,2084,34,0],[2088,33,2089,111,0],[2090,33,2090,34,0],[2091,37,2092,81,0],[2093,37,2093,66,0],[2094,37,2094,112,0],[2095,37,2095,78,0],[2096,37,2096,61,0],[2097,33,2097,34,0],[2099,33,2099,34,0],[2100,37,2100,64,0],[2101,33,2101,34,0],[2103,33,2103,61,0],[2104,33,2104,55,0],[2105,29,2105,30,0],[2106,25,2106,26,0],[2107,21,2107,22,0],[2108,17,2108,18,0],[2110,17,2110,39,0],[2112,17,2112,24,0],[2112,26,2112,37,0],[2112,38,2112,40,0],[2112,41,2112,58,0],[2113,17,2113,18,0],[2115,21,2115,53,0],[2118,21,2118,28,0],[2118,30,2118,49,0],[2118,50,2118,52,0],[2118,53,2118,73,0],[2119,25,2119,78,0],[2122,21,2122,61,0],[2124,21,2124,32,0],[2125,26,2125,35,0],[2125,37,2125,67,0],[2125,69,2125,72,0],[2126,21,2126,22,0],[2127,25,2127,77,0],[2128,25,2128,48,0],[2129,25,2129,26,0],[2130,29,2130,88,0],[2131,29,2132,108,0],[2133,29,2133,30,0],[2135,33,2136,111,0],[2137,33,2137,34,0],[2138,37,2138,54,0],[2139,37,2139,38,0],[2140,41,2140,79,0],[2141,41,2141,78,0],[2143,41,2143,86,0],[2144,41,2144,85,0],[2146,41,2146,48,0],[2146,50,2146,61,0],[2146,62,2146,64,0],[2146,65,2146,74,0],[2147,41,2147,42,0],[2148,45,2148,70,0],[2149,45,2149,46,0],[2150,49,2150,69,0],[2151,49,2151,67,0],[2152,49,2152,55,0],[2154,41,2154,42,0],[2156,41,2156,95,0],[2157,41,2157,94,0],[2158,37,2158,38,0],[2160,37,2160,38,0],[2161,41,2161,90,0],[2162,41,2162,89,0],[2163,37,2163,38,0],[2164,33,2164,34,0],[2166,33,2166,34,0],[2167,37,2167,54,0],[2168,41,2168,72,0],[2170,41,2170,77,0],[2171,33,2171,34,0],[2172,29,2172,30,0],[2173,25,2173,26,0],[2174,21,2174,22,0],[2175,17,2175,18,0],[2176,13,2176,14,0],[2178,17,2178,35,1],[2181,13,2181,49,1],[2187,13,2190,97,1],[2191,13,2191,14,0],[2192,17,2194,133,0],[2195,13,2195,14,0],[2197,17,2197,77,1],[2199,13,2199,35,1],[2200,13,2200,44,1],[2201,17,2201,49,1],[2203,17,2203,53,1],[2205,13,2205,32,1],[2205,33,2205,46,1],[2207,13,2207,32,1],[2208,13,2208,14,1],[2209,17,2209,45,1],[2209,45,2209,89,1],[2209,89,2209,101,1],[2209,17,2209,101,1],[2210,13,2210,14,1],[2212,13,2212,32,1],[2213,17,2213,49,1],[2215,17,2215,41,1],[2218,13,2218,112,1],[2219,13,2219,38,1],[2220,13,2220,14,1],[2221,17,2221,45,1],[2222,17,2222,24,1],[2222,26,2222,36,1],[2222,37,2222,39,1],[2222,40,2222,47,1],[2223,17,2223,18,1],[2224,21,2224,148,1],[2225,17,2225,18,1],[2226,13,2226,14,1],[2228,13,2228,26,1],[2229,13,2229,14,0],[2230,17,2230,24,0],[2230,26,2230,38,0],[2230,39,2230,41,0],[2230,42,2230,54,0],[2231,17,2231,18,0],[2232,21,2232,97,0],[2233,17,2233,18,0],[2234,13,2234,14,0],[2236,13,2236,28,1],[2237,9,2237,10,1],[2240,9,2240,10,1],[2241,13,2241,36,1],[2242,13,2242,92,1],[2243,13,2243,86,1],[2244,13,2244,29,1],[2245,13,2245,14,0],[2246,17,2246,100,0],[2247,17,2247,71,0],[2248,17,2249,65,0],[2250,17,2250,59,0],[2251,17,2251,18,0],[2252,21,2252,66,0],[2253,17,2253,18,0],[2254,13,2254,14,0],[2256,13,2256,32,1],[2257,13,2257,14,1],[2258,17,2259,119,1],[2260,13,2260,14,1],[2261,13,2261,27,1],[2262,9,2262,10,1],[2271,9,2271,10,0],[2272,13,2273,68,0],[2274,17,2274,54,0],[2276,17,2276,50,0],[2277,9,2277,10,0],[2300,9,2300,10,1],[2305,13,2305,107,1],[2306,13,2306,46,1],[2307,13,2307,14,0],[2309,17,2309,43,0],[2310,17,2310,116,0],[2312,17,2312,73,0],[2313,17,2313,18,0],[2314,21,2315,128,0],[2318,17,2318,18,0],[2319,21,2319,111,0],[2322,21,2325,75,0],[2326,21,2326,28,0],[2326,30,2326,55,0],[2326,56,2326,58,0],[2326,59,2326,72,0],[2327,21,2327,22,0],[2328,25,2329,75,0],[2330,25,2330,26,0],[2331,29,2331,63,0],[2332,29,2332,30,0],[2333,33,2333,87,0],[2334,33,2334,34,0],[2335,37,2337,85,0],[2339,37,2339,65,0],[2341,37,2341,44,0],[2341,46,2341,68,0],[2341,69,2341,71,0],[2341,72,2341,84,0],[2342,37,2342,38,0],[2343,41,2346,71,0],[2347,41,2347,60,0],[2347,61,2347,67,0],[2348,37,2348,38,0],[2350,37,2350,57,0],[2351,37,2351,38,0],[2352,41,2353,129,0],[2355,33,2355,34,0],[2357,33,2357,34,0],[2358,37,2359,73,0],[2361,33,2361,39,0],[2363,25,2363,26,0],[2364,30,2364,94,0],[2365,25,2365,26,0],[2366,29,2366,83,0],[2367,33,2368,69,0],[2370,29,2370,30,0],[2371,33,2371,61,0],[2372,33,2374,81,0],[2375,33,2375,40,0],[2375,42,2375,64,0],[2375,65,2375,67,0],[2375,68,2375,80,0],[2376,33,2376,34,0],[2377,37,2380,67,0],[2381,37,2381,56,0],[2381,57,2381,63,0],[2382,33,2382,34,0],[2384,33,2384,53,0],[2385,37,2386,64,0],[2387,29,2387,30,0],[2388,25,2388,26,0],[2389,30,2389,104,0],[2390,25,2390,26,0],[2391,29,2391,83,0],[2392,33,2393,69,0],[2395,29,2395,30,0],[2396,33,2396,61,0],[2397,33,2399,81,0],[2400,33,2400,58,0],[2401,33,2401,34,0],[2402,37,2402,44,0],[2402,46,2402,68,0],[2402,69,2402,71,0],[2402,72,2402,84,0],[2403,37,2403,38,0],[2404,41,2407,71,0],[2408,41,2408,60,0],[2408,61,2408,67,0],[2409,37,2409,38,0],[2410,33,2410,34,0],[2412,33,2412,53,0],[2413,37,2414,64,0],[2415,29,2415,30,0],[2416,25,2416,26,0],[2417,21,2417,22,0],[2418,17,2418,18,0],[2419,13,2419,14,0],[2420,9,2420,10,1],[2428,9,2428,10,0],[2429,13,2429,96,0],[2431,13,2431,33,0],[2432,13,2432,14,0],[2433,17,2433,100,0],[2434,17,2434,78,0],[2435,17,2436,110,0],[2437,17,2437,81,0],[2438,17,2438,38,0],[2441,13,2441,14,0],[2443,17,2443,63,0],[2445,9,2445,10,0],[2453,9,2453,10,0],[2454,13,2454,60,0],[2456,13,2456,44,0],[2458,13,2458,55,0],[2459,13,2459,45,0],[2460,13,2460,52,0],[2461,13,2461,14,0],[2462,17,2462,90,0],[2463,13,2463,14,0],[2464,13,2464,34,0],[2465,13,2465,14,0],[2466,17,2467,17,0],[2467,17,2467,18,0],[2467,18,2468,21,0],[2468,21,2469,58,0],[2469,58,2470,21,0],[2470,21,2470,22,0],[2470,22,2471,25,0],[2471,25,2471,62,0],[2471,62,2472,25,0],[2472,25,2474,65,0],[2474,65,2475,25,0],[2475,25,2475,63,0],[2475,63,2476,25,0],[2476,25,2476,56,0],[2476,56,2479,25,0],[2479,25,2479,54,0],[2479,54,2480,21,0],[2480,21,2480,22,0],[2480,22,2481,17,0],[2481,17,2481,18,0],[2481,18,2481,20,0],[2466,17,2481,20,0],[2482,13,2482,14,0],[2483,13,2483,29,0],[2484,9,2484,10,0],[2492,9,2492,10,0],[2493,13,2493,29,0],[2496,21,2496,51,0],[2497,21,2497,27,0],[2499,21,2499,56,0],[2500,21,2500,27,0],[2503,21,2503,54,0],[2504,21,2504,27,0],[2507,9,2507,10,0],[2515,9,2515,10,0],[2516,13,2516,44,0],[2517,13,2517,14,0],[2518,17,2518,38,0],[2519,13,2519,14,0],[2520,13,2520,39,0],[2521,13,2521,46,0],[2522,13,2522,14,0],[2523,17,2523,44,0],[2524,13,2524,14,0],[2525,9,2525,10,0],[2533,9,2533,10,0],[2535,13,2535,14,0],[2536,17,2536,61,0],[2538,17,2538,69,0],[2539,17,2539,57,0],[2540,17,2540,57,0],[2541,17,2541,57,0],[2543,17,2546,70,0],[2547,13,2547,14,0],[2548,13,2548,33,0],[2549,13,2549,14,0],[2550,17,2552,63,0],[2553,13,2553,14,0],[2554,9,2554,10,0],[2562,9,2562,10,0],[2563,13,2563,57,0],[2565,13,2565,14,0],[2566,17,2566,49,0],[2567,17,2567,18,0],[2568,21,2568,70,0],[2569,21,2569,28,0],[2571,22,2571,68,0],[2572,17,2572,18,0],[2573,21,2573,79,0],[2574,21,2574,28,0],[2577,17,2577,65,0],[2579,17,2579,40,0],[2579,42,2579,57,0],[2579,59,2579,71,0],[2580,17,2580,80,0],[2581,17,2581,50,0],[2582,17,2582,18,0],[2583,21,2583,73,0],[2584,21,2584,77,0],[2585,21,2585,73,0],[2586,17,2586,18,0],[2587,17,2587,48,0],[2588,17,2588,18,0],[2589,21,2589,77,0],[2590,21,2590,28,0],[2593,17,2597,57,0],[2599,17,2599,108,0],[2601,17,2602,106,0],[2603,13,2603,14,0],[2604,13,2604,33,0],[2605,13,2605,14,0],[2606,17,2608,63,0],[2609,17,2609,24,0],[2611,9,2611,10,0],[2619,9,2619,10,0],[2621,13,2621,14,0],[2622,17,2622,61,0],[2624,17,2624,49,0],[2625,17,2625,18,0],[2626,21,2628,83,0],[2629,21,2629,28,0],[2631,22,2631,68,0],[2632,17,2632,18,0],[2633,21,2633,86,0],[2634,21,2634,28,0],[2636,17,2636,70,0],[2639,17,2639,40,0],[2639,42,2639,57,0],[2639,59,2639,71,0],[2640,17,2640,80,0],[2641,17,2641,50,0],[2642,17,2642,18,0],[2643,21,2643,73,0],[2644,21,2644,77,0],[2645,21,2645,73,0],[2646,17,2646,18,0],[2648,17,2648,48,0],[2649,17,2649,18,0],[2650,21,2652,101,0],[2653,21,2653,28,0],[2656,17,2660,139,0],[2662,17,2662,108,0],[2664,17,2665,106,0],[2666,13,2666,14,0],[2667,13,2667,33,0],[2668,13,2668,14,0],[2669,17,2671,63,0],[2672,17,2672,24,0],[2674,9,2674,10,0],[2691,9,2691,10,0],[2692,13,2692,66,0],[2693,13,2693,58,0],[2694,13,2694,61,0],[2695,13,2695,86,0],[2695,86,2695,98,0],[2695,98,2695,109,0],[2695,13,2695,109,0],[2696,13,2696,93,0],[2697,13,2697,95,0],[2698,13,2698,46,0],[2699,13,2699,20,0],[2699,22,2699,36,0],[2699,37,2699,39,0],[2699,40,2699,53,0],[2700,13,2700,14,0],[2701,17,2701,110,0],[2702,21,2702,60,0],[2703,13,2703,14,0],[2704,13,2704,20,0],[2704,22,2704,39,0],[2704,40,2704,42,0],[2704,43,2704,61,0],[2705,13,2705,14,0],[2706,17,2706,102,0],[2707,21,2707,53,0],[2708,13,2708,14,0],[2709,9,2709,10,0],[2717,9,2717,10,0],[2721,13,2721,53,0],[2723,13,2723,43,0],[2725,13,2725,20,0],[2725,22,2725,36,0],[2725,37,2725,39,0],[2725,40,2725,54,0],[2726,13,2726,14,0],[2727,17,2727,76,0],[2728,17,2728,18,0],[2729,21,2729,73,0],[2730,21,2730,53,0],[2731,17,2731,18,0],[2732,13,2732,14,0],[2734,13,2734,20,0],[2734,22,2734,33,0],[2734,34,2734,36,0],[2734,37,2734,44,0],[2735,13,2735,14,0],[2736,17,2736,39,0],[2737,17,2737,24,0],[2737,26,2737,40,0],[2737,41,2737,43,0],[2737,44,2737,55,0],[2738,17,2738,18,0],[2740,21,2742,144,0],[2744,21,2744,22,0],[2745,17,2745,18,0],[2746,13,2746,14,0],[2747,13,2747,40,0],[2748,13,2748,43,0],[2749,13,2749,35,0],[2750,13,2750,41,0],[2751,13,2751,77,0],[2752,13,2752,71,0],[2753,9,2753,10,0],[2761,9,2761,10,0],[2762,13,2762,99,0],[2763,9,2763,10,0],[2771,9,2771,10,1],[2773,13,2773,14,1],[2774,17,2774,45,1],[2775,17,2775,39,1],[2776,17,2776,47,1],[2777,17,2777,47,1],[2778,17,2778,53,1],[2779,17,2779,48,1],[2780,17,2780,33,1],[2781,17,2781,31,1],[2782,17,2782,40,1],[2784,22,2784,31,1],[2784,33,2784,86,1],[2784,88,2784,91,1],[2785,17,2785,18,1],[2786,21,2786,29,1],[2788,21,2788,96,1],[2789,21,2790,102,1],[2791,21,2791,92,1],[2792,21,2792,100,1],[2793,21,2793,88,1],[2794,21,2794,94,1],[2795,21,2795,106,1],[2796,21,2796,89,1],[2797,21,2797,22,1],[2798,25,2798,42,1],[2799,25,2799,34,1],[2801,21,2801,71,1],[2803,21,2803,45,1],[2804,21,2804,22,1],[2805,25,2806,79,1],[2807,25,2807,36,1],[2808,25,2808,26,1],[2809,29,2811,62,1],[2814,29,2814,75,1],[2815,29,2815,30,0],[2816,33,2816,77,0],[2817,33,2817,69,0],[2818,33,2820,64,0],[2821,33,2822,44,0],[2823,33,2823,34,0],[2824,33,2824,74,0],[2825,33,2825,111,0],[2826,33,2826,86,0],[2827,33,2829,58,0],[2831,33,2831,113,0],[2832,33,2832,34,0],[2833,37,2833,106,0],[2834,37,2834,84,0],[2835,33,2835,34,0],[2837,33,2840,98,0],[2841,29,2841,30,0],[2842,25,2842,26,1],[2843,21,2843,22,1],[2844,17,2844,18,1],[2846,17,2846,55,1],[2847,21,2849,104,1],[2852,22,2852,59,1],[2853,21,2855,113,0],[2858,22,2858,60,1],[2859,17,2859,18,1],[2860,21,2860,82,1],[2861,17,2861,18,1],[2862,13,2862,14,1],[2863,13,2863,33,0],[2864,13,2864,14,0],[2865,17,2867,63,0],[2868,13,2868,14,0],[2869,9,2869,10,1],[2886,9,2886,10,1],[2888,13,2888,14,1],[2889,17,2889,40,1],[2890,17,2890,31,1],[2891,17,2891,43,1],[2892,17,2892,39,1],[2893,17,2893,43,1],[2895,22,2895,31,1],[2895,33,2895,86,1],[2895,88,2895,91,1],[2896,17,2896,18,1],[2897,21,2897,29,1],[2898,21,2898,96,1],[2899,21,2899,100,1],[2901,21,2901,61,1],[2902,21,2902,22,0],[2903,25,2903,42,0],[2904,25,2904,34,0],[2906,21,2907,98,1],[2908,21,2908,22,0],[2909,25,2909,45,0],[2910,25,2910,34,0],[2913,21,2914,36,1],[2915,17,2915,18,1],[2916,17,2916,32,1],[2917,17,2917,18,1],[2918,21,2918,45,1],[2919,21,2919,22,0],[2920,25,2920,100,0],[2922,26,2922,53,1],[2923,21,2923,22,0],[2924,25,2924,115,0],[2926,17,2926,18,1],[2927,22,2927,36,0],[2928,17,2928,18,0],[2929,21,2929,48,0],[2930,21,2930,22,0],[2931,25,2932,124,0],[2934,26,2934,50,0],[2935,21,2935,22,0],[2936,25,2936,107,0],[2938,17,2938,18,0],[2939,13,2939,14,1],[2940,13,2940,33,0],[2941,13,2941,14,0],[2942,17,2944,63,0],[2945,13,2945,14,0],[2946,9,2946,10,1],[2955,9,2955,10,0],[2956,13,2956,54,0],[2958,13,2958,29,0],[2961,21,2961,49,0],[2962,21,2962,51,0],[2963,21,2963,32,0],[2965,21,2965,53,0],[2966,21,2966,56,0],[2967,21,2967,32,0],[2969,21,2969,50,0],[2970,21,2970,51,0],[2971,21,2971,32,0],[2973,21,2973,49,0],[2974,21,2974,50,0],[2975,21,2975,27,0],[2977,13,2977,25,0],[2978,9,2978,10,0],[2993,9,2993,10,0],[2994,13,2994,33,0],[2996,13,2996,74,0],[2997,17,2997,116,0],[2998,13,2998,49,0],[2999,13,2999,38,0],[3000,13,3000,39,0],[3001,13,3002,35,0],[3003,13,3003,27,0],[3004,13,3004,42,0],[3005,13,3005,14,0],[3006,17,3007,121,0],[3008,17,3008,31,0],[3010,17,3010,63,0],[3011,17,3011,18,0],[3012,21,3012,73,0],[3013,21,3013,56,0],[3014,21,3014,99,0],[3015,21,3015,78,0],[3016,21,3016,78,0],[3017,21,3019,46,0],[3020,21,3020,101,0],[3021,21,3021,22,0],[3022,25,3022,94,0],[3023,25,3023,72,0],[3024,21,3024,22,0],[3026,21,3027,127,0],[3028,21,3030,52,0],[3031,21,3035,50,0],[3036,17,3036,18,0],[3037,13,3037,14,0],[3038,18,3038,49,0],[3039,13,3039,14,0],[3040,17,3040,39,0],[3041,13,3041,14,0],[3042,18,3042,49,0],[3043,13,3043,14,0],[3044,17,3044,34,0],[3045,17,3045,102,0],[3046,17,3046,32,0],[3047,13,3047,14,0],[3048,9,3048,10,0],[3056,9,3056,10,0],[3058,13,3058,14,0],[3059,17,3059,41,0],[3060,17,3060,61,0],[3062,17,3062,49,0],[3063,21,3065,82,0],[3068,17,3069,68,0],[3070,17,3070,18,0],[3071,21,3073,98,0],[3074,17,3074,18,0],[3076,17,3077,69,0],[3078,17,3078,18,0],[3079,21,3081,93,0],[3082,17,3082,18,0],[3085,17,3085,92,0],[3086,17,3086,44,0],[3087,17,3087,99,0],[3088,17,3088,88,0],[3089,17,3089,70,0],[3092,22,3092,31,0],[3092,33,3092,53,0],[3092,55,3092,58,0],[3093,17,3093,18,0],[3094,21,3094,64,0],[3097,21,3098,67,0],[3099,17,3099,18,0],[3100,13,3100,14,0],[3101,13,3101,33,0],[3102,13,3102,14,0],[3104,17,3106,63,0],[3107,13,3107,14,0],[3108,9,3108,10,0],[3119,9,3119,10,0],[3121,13,3121,14,0],[3122,17,3122,36,0],[3123,17,3123,45,0],[3124,17,3124,40,0],[3125,17,3125,37,0],[3126,17,3126,54,0],[3127,17,3127,50,0],[3128,17,3128,96,0],[3129,17,3129,79,0],[3131,17,3133,47,0],[3134,17,3134,86,0],[3135,17,3135,58,0],[3136,21,3136,107,0],[3137,17,3137,101,0],[3139,22,3139,31,0],[3139,33,3139,86,0],[3139,88,3139,91,0],[3140,17,3140,18,0],[3143,21,3143,35,0],[3144,21,3144,94,0],[3146,21,3146,63,0],[3147,21,3147,61,0],[3148,21,3148,22,0],[3149,25,3150,60,0],[3151,21,3151,22,0],[3152,26,3152,109,0],[3153,21,3153,22,0],[3154,25,3156,111,0],[3157,21,3157,22,0],[3158,17,3158,18,0],[3160,17,3160,51,0],[3161,17,3161,40,0],[3162,17,3164,41,0],[3166,17,3166,81,0],[3167,17,3167,18,0],[3168,21,3172,158,0],[3173,17,3173,18,0],[3174,17,3174,55,0],[3175,17,3175,18,0],[3176,21,3181,38,0],[3182,17,3182,18,0],[3183,22,3183,61,0],[3184,17,3184,18,0],[3185,21,3189,107,0],[3190,17,3190,18,0],[3191,22,3191,36,0],[3192,17,3192,18,0],[3193,21,3193,57,0],[3194,21,3194,22,0],[3195,25,3195,58,0],[3196,25,3196,109,0],[3197,25,3197,98,0],[3198,25,3198,76,0],[3199,25,3199,66,0],[3200,25,3200,61,0],[3201,25,3202,108,0],[3203,21,3203,22,0],[3205,21,3205,22,0],[3206,25,3208,93,0],[3209,21,3209,22,0],[3210,17,3210,18,0],[3211,17,3211,57,0],[3212,17,3212,18,0],[3213,21,3213,61,0],[3214,17,3214,18,0],[3215,22,3215,62,0],[3216,17,3216,18,0],[3217,21,3217,61,0],[3218,17,3218,18,0],[3219,22,3219,66,0],[3220,17,3220,18,0],[3221,21,3221,65,0],[3222,17,3222,18,0],[3223,13,3223,14,0],[3224,13,3224,33,0],[3225,13,3225,14,0],[3227,17,3229,63,0],[3230,13,3230,14,0],[3231,9,3231,10,0],[3238,9,3238,10,1],[3239,13,3239,41,1],[3240,13,3240,33,1],[3241,13,3241,33,1],[3243,13,3243,14,1],[3244,22,3244,31,1],[3244,33,3244,86,1],[3244,88,3244,91,1],[3245,17,3245,18,1],[3246,21,3246,94,1],[3247,21,3247,47,1],[3248,21,3248,22,0],[3249,25,3251,84,0],[3252,21,3252,22,0],[3253,21,3253,57,1],[3254,21,3254,46,1],[3255,21,3255,47,1],[3256,21,3258,47,1],[3259,21,3259,35,1],[3260,21,3260,52,1],[3261,21,3261,22,0],[3262,25,3262,47,0],[3263,21,3263,22,0],[3264,21,3266,54,1],[3269,21,3269,67,1],[3270,21,3270,22,0],[3271,25,3271,84,0],[3272,25,3272,68,0],[3273,25,3273,103,0],[3274,25,3274,82,0],[3275,25,3276,57,0],[3277,25,3277,105,0],[3278,25,3278,26,0],[3279,29,3279,98,0],[3280,29,3280,76,0],[3281,25,3281,26,0],[3283,25,3283,78,0],[3284,25,3289,118,0],[3290,21,3290,22,0],[3291,17,3291,18,1],[3293,17,3293,55,1],[3294,17,3294,18,0],[3295,21,3298,31,0],[3299,17,3299,18,0],[3300,22,3300,61,1],[3301,17,3301,18,0],[3302,21,3304,112,0],[3305,17,3305,18,0],[3307,17,3307,18,1],[3308,21,3310,110,1],[3311,17,3311,18,1],[3312,17,3312,88,1],[3313,13,3313,14,1],[3314,13,3314,33,0],[3315,13,3315,14,0],[3316,17,3318,63,0],[3319,13,3319,14,0],[3320,9,3320,10,1],[3329,9,3329,10,0],[3331,13,3331,14,0],[3332,17,3332,68,0],[3333,17,3333,75,0],[3334,17,3336,73,0],[3338,17,3338,76,0],[3339,17,3339,97,0],[3341,17,3342,121,0],[3345,17,3345,63,0],[3346,17,3346,18,0],[3347,21,3348,91,0],[3349,21,3349,79,0],[3350,21,3351,120,0],[3352,21,3352,112,0],[3353,21,3353,22,0],[3354,21,3354,61,0],[3356,21,3356,99,0],[3357,21,3357,74,0],[3358,21,3360,46,0],[3362,21,3362,101,0],[3363,21,3363,22,0],[3364,25,3364,94,0],[3365,25,3365,72,0],[3366,21,3366,22,0],[3368,21,3371,86,0],[3373,17,3373,18,0],[3374,17,3374,67,0],[3375,17,3375,73,0],[3376,17,3376,62,0],[3377,17,3377,70,0],[3379,13,3379,14,0],[3380,13,3380,33,0],[3381,13,3381,14,0],[3382,17,3384,63,0],[3385,13,3385,14,0],[3386,9,3386,10,0],[3448,9,3448,10,0],[3449,13,3449,78,0],[3451,13,3451,14,0],[3452,17,3452,55,0],[3453,17,3453,84,0],[3455,17,3455,48,0],[3455,49,3455,68,0],[3457,17,3457,121,0],[3459,22,3459,31,0],[3459,33,3459,71,0],[3459,73,3459,76,0],[3460,17,3460,18,0],[3461,21,3461,83,0],[3463,21,3464,99,0],[3465,25,3465,34,0],[3467,21,3467,49,0],[3468,21,3468,22,0],[3469,25,3469,94,0],[3470,25,3470,90,0],[3471,25,3471,95,0],[3472,25,3472,82,0],[3473,25,3473,91,0],[3477,25,3477,62,0],[3478,25,3478,75,0],[3479,25,3479,44,0],[3480,25,3480,40,0],[3481,29,3481,48,0],[3483,25,3483,67,0],[3485,25,3485,57,0],[3486,29,3486,65,0],[3488,25,3488,88,0],[3490,25,3490,86,0],[3491,25,3491,78,0],[3492,21,3492,22,0],[3493,17,3493,18,0],[3495,17,3495,40,0],[3496,17,3496,18,0],[3497,21,3497,45,0],[3499,21,3499,58,0],[3501,21,3501,65,0],[3502,17,3502,18,0],[3504,17,3504,18,0],[3505,21,3507,107,0],[3509,21,3509,28,0],[3511,17,3513,83,0],[3514,13,3514,14,0],[3515,13,3515,33,0],[3516,13,3516,14,0],[3517,17,3519,63,0],[3520,13,3520,14,0],[3522,13,3522,14,0],[3523,17,3523,63,0],[3524,13,3524,14,0],[3525,9,3525,10,0],[3531,9,3531,10,0],[3532,13,3532,83,0],[3534,13,3534,105,0],[3535,17,3535,24,0],[3537,13,3538,30,0],[3538,30,3538,84,0],[3538,84,3539,31,0],[3539,31,3539,64,0],[3539,64,3539,65,0],[3537,13,3539,65,0],[3541,13,3541,50,0],[3542,17,3542,43,0],[3544,13,3545,35,0],[3545,35,3545,94,0],[3545,94,3546,36,0],[3546,36,3546,69,0],[3546,69,3546,70,0],[3544,13,3546,70,0],[3548,13,3548,60,0],[3549,17,3549,53,0],[3550,9,3550,10,0],[3557,9,3557,10,0],[3558,13,3558,66,0],[3560,13,3560,100,0],[3562,13,3562,78,0],[3563,17,3563,24,0],[3568,13,3568,20,0],[3568,22,3568,40,0],[3568,41,3568,43,0],[3568,44,3568,50,0],[3569,13,3569,14,0],[3570,17,3570,57,0],[3571,17,3571,46,0],[3573,17,3573,86,0],[3575,17,3575,24,0],[3575,26,3575,49,0],[3575,50,3575,52,0],[3575,53,3575,62,0],[3576,17,3576,18,0],[3577,21,3577,60,0],[3578,21,3578,60,0],[3580,21,3580,98,0],[3582,21,3582,45,0],[3583,21,3583,22,0],[3584,25,3584,48,0],[3585,21,3585,22,0],[3587,21,3587,22,0],[3588,25,3588,74,0],[3589,21,3589,22,0],[3591,21,3592,48,0],[3593,17,3593,18,0],[3594,13,3594,14,0],[3595,9,3595,10,0],[3603,9,3603,10,0],[3604,13,3604,70,0],[3606,13,3606,60,0],[3608,13,3608,55,0],[3610,13,3610,27,0],[3611,9,3611,10,0],[3618,9,3618,10,0],[3619,13,3620,13,0],[3620,13,3620,14,0],[3620,14,3621,17,0],[3621,17,3621,36,0],[3621,36,3622,21,0],[3622,21,3622,36,0],[3622,36,3623,13,0],[3623,13,3623,14,0],[3623,14,3623,16,0],[3619,13,3623,16,0],[3625,13,3625,36,0],[3626,13,3626,14,0],[3627,17,3627,52,0],[3628,17,3628,62,0],[3629,17,3629,65,0],[3631,17,3631,47,0],[3632,21,3632,51,0],[3633,13,3633,14,0],[3634,9,3634,10,0],[3641,9,3641,10,0],[3643,13,3643,14,0],[3644,17,3644,45,0],[3644,46,3644,53,0],[3646,17,3646,96,0],[3648,17,3648,24,0],[3648,26,3648,34,0],[3648,35,3648,37,0],[3648,38,3648,100,0],[3649,17,3649,18,0],[3650,21,3650,61,0],[3651,17,3651,18,0],[3653,17,3653,40,0],[3654,13,3654,14,0],[3655,13,3655,18,0],[3656,13,3656,14,0],[3660,13,3660,14,0],[3661,9,3661,10,0],[3668,9,3668,10,0],[3669,13,3669,100,0],[3671,13,3671,78,0],[3672,17,3672,24,0],[3674,13,3674,20,0],[3674,22,3674,51,0],[3674,52,3674,54,0],[3674,55,3674,63,0],[3675,13,3675,14,0],[3676,17,3676,79,0],[3677,17,3677,43,0],[3679,17,3679,117,0],[3681,17,3681,52,0],[3682,21,3682,30,0],[3684,17,3684,91,0],[3686,17,3686,24,0],[3686,26,3686,36,0],[3686,37,3686,39,0],[3686,40,3686,43,0],[3687,17,3687,18,0],[3688,21,3688,68,0],[3689,21,3689,102,0],[3691,21,3693,77,0],[3694,25,3694,34,0],[3696,21,3696,67,0],[3697,21,3697,51,0],[3699,21,3700,60,0],[3701,17,3701,18,0],[3702,13,3702,14,0],[3703,9,3703,10,0],[3711,9,3711,10,0],[3712,13,3712,61,0],[3714,13,3714,45,0],[3715,13,3717,78,0],[3718,9,3718,10,0],[3725,9,3725,10,0],[3726,13,3726,84,0],[3727,13,3728,117,0],[3729,13,3729,59,0],[3730,13,3730,14,0],[3731,17,3731,24,0],[3731,26,3731,38,0],[3731,39,3731,41,0],[3731,42,3731,64,0],[3732,17,3732,18,0],[3733,21,3733,105,0],[3734,21,3734,106,0],[3735,21,3735,67,0],[3736,21,3736,22,0],[3737,25,3737,79,0],[3738,25,3738,123,0],[3739,25,3739,112,0],[3740,25,3740,98,0],[3741,25,3741,66,0],[3742,25,3742,103,0],[3743,25,3743,79,0],[3744,25,3744,78,0],[3745,25,3747,66,0],[3748,25,3748,105,0],[3749,25,3749,26,0],[3750,29,3750,98,0],[3751,29,3751,76,0],[3752,25,3752,26,0],[3754,25,3758,38,0],[3760,21,3760,22,0],[3761,17,3761,18,0],[3762,13,3762,14,0],[3763,9,3763,10,0],[3772,9,3772,10,0],[3773,13,3773,60,0],[3774,13,3774,56,0],[3777,13,3777,14,0],[3778,17,3778,67,0],[3779,17,3779,36,0],[3780,17,3780,32,0],[3781,21,3781,40,0],[3783,17,3783,71,0],[3785,17,3785,55,0],[3786,21,3786,63,0],[3788,17,3788,64,0],[3791,17,3792,121,0],[3794,17,3794,47,0],[3794,48,3794,66,0],[3796,17,3796,120,0],[3798,22,3798,31,0],[3798,33,3798,71,0],[3798,73,3798,76,0],[3799,17,3799,18,0],[3800,21,3800,99,0],[3801,25,3801,34,0],[3803,21,3803,86,0],[3804,21,3804,90,0],[3805,21,3805,86,0],[3806,21,3806,91,0],[3807,21,3808,100,0],[3809,21,3809,56,0],[3811,21,3811,89,0],[3813,21,3813,78,0],[3814,21,3814,87,0],[3816,21,3816,52,0],[3817,21,3817,22,0],[3818,25,3818,49,0],[3819,25,3819,112,0],[3821,25,3822,75,0],[3823,25,3823,26,0],[3824,29,3824,69,0],[3825,29,3825,56,0],[3826,29,3826,75,0],[3827,29,3827,30,0],[3828,33,3831,68,0],[3832,33,3832,87,0],[3833,33,3833,73,0],[3834,33,3834,111,0],[3835,33,3835,87,0],[3836,33,3836,86,0],[3837,33,3839,70,0],[3840,33,3840,113,0],[3841,33,3841,34,0],[3842,37,3842,106,0],[3843,37,3843,84,0],[3844,33,3844,34,0],[3846,33,3849,102,0],[3850,29,3850,30,0],[3851,29,3851,38,0],[3854,25,3854,26,0],[3855,29,3855,76,0],[3857,29,3857,63,0],[3858,33,3858,71,0],[3860,29,3860,74,0],[3861,29,3861,69,0],[3862,29,3862,56,0],[3863,29,3863,75,0],[3864,29,3864,30,0],[3865,33,3868,68,0],[3870,33,3870,87,0],[3871,33,3871,73,0],[3872,33,3872,111,0],[3873,33,3873,87,0],[3874,33,3874,86,0],[3875,33,3877,70,0],[3878,33,3878,113,0],[3879,33,3879,34,0],[3880,37,3880,106,0],[3881,37,3881,84,0],[3882,33,3882,34,0],[3884,33,3887,102,0],[3889,29,3889,30,0],[3890,25,3890,26,0],[3892,25,3892,32,0],[3892,34,3892,44,0],[3892,45,3892,47,0],[3892,48,3892,82,0],[3893,25,3893,26,0],[3894,29,3894,68,0],[3895,29,3895,64,0],[3897,29,3897,74,0],[3899,29,3899,88,0],[3900,29,3900,69,0],[3902,29,3902,56,0],[3903,29,3903,75,0],[3904,29,3904,30,0],[3905,33,3908,68,0],[3909,33,3909,87,0],[3910,33,3910,73,0],[3911,33,3911,111,0],[3912,33,3912,87,0],[3913,33,3913,86,0],[3914,33,3916,70,0],[3917,33,3917,113,0],[3918,33,3918,34,0],[3919,37,3919,106,0],[3920,37,3920,84,0],[3921,33,3921,34,0],[3923,33,3926,102,0],[3927,29,3927,30,0],[3928,25,3928,26,0],[3929,21,3929,22,0],[3931,21,3931,22,0],[3932,25,3932,65,0],[3933,25,3933,52,0],[3934,25,3934,71,0],[3935,25,3935,26,0],[3936,29,3939,64,0],[3940,29,3940,83,0],[3941,29,3941,69,0],[3942,29,3942,107,0],[3943,29,3943,83,0],[3944,29,3944,82,0],[3945,29,3947,66,0],[3948,29,3948,109,0],[3949,29,3949,30,0],[3950,33,3950,102,0],[3951,33,3951,80,0],[3952,29,3952,30,0],[3954,29,3957,116,0],[3958,25,3958,26,0],[3959,21,3959,22,0],[3960,17,3960,18,0],[3962,17,3962,45,0],[3963,21,3963,93,0],[3966,17,3966,85,0],[3967,17,3967,71,0],[3968,17,3968,82,0],[3969,17,3969,60,0],[3973,13,3973,14,0],[3974,13,3974,33,0],[3975,13,3975,14,0],[3976,17,3976,51,0],[3977,17,3977,54,0],[3978,17,3980,63,0],[3981,13,3981,14,0],[3982,9,3982,10,0],[3990,9,3990,10,0],[3992,13,3992,109,0],[3993,13,3993,120,0],[3994,13,3998,114,0],[3999,13,3999,14,0],[4000,17,4002,81,0],[4003,13,4003,14,0],[4005,13,4005,14,0],[4006,17,4007,121,0],[4010,17,4010,63,0],[4011,17,4011,18,0],[4012,21,4012,87,0],[4013,21,4013,56,0],[4015,21,4015,99,0],[4016,21,4016,78,0],[4017,21,4017,85,0],[4018,21,4019,139,0],[4021,21,4021,101,0],[4022,21,4022,22,0],[4023,25,4023,94,0],[4024,25,4024,72,0],[4025,21,4025,22,0],[4027,21,4029,99,0],[4030,17,4030,18,0],[4031,13,4031,14,0],[4033,13,4034,64,0],[4036,13,4037,13,0],[4037,13,4037,14,0],[4037,14,4038,17,0],[4038,17,4038,82,0],[4038,82,4039,21,0],[4039,21,4039,106,0],[4039,106,4040,13,0],[4040,13,4040,14,0],[4040,14,4040,16,0],[4036,13,4040,16,0],[4042,13,4042,58,0],[4043,9,4043,10,0],[4051,9,4051,10,1],[4052,13,4052,30,1],[4053,17,4055,139,1],[4057,17,4058,130,0],[4059,9,4059,10,1],[4065,9,4065,10,1],[4066,13,4093,31,1],[4095,13,4096,31,1],[4097,9,4097,10,1],[4100,9,4100,10,0],[4101,13,4101,104,0],[4102,13,4102,36,0],[4103,17,4104,118,0],[4106,17,4106,80,0],[4107,9,4107,10,0],[4110,9,4110,10,0],[4111,13,4111,104,0],[4112,13,4112,36,0],[4113,17,4114,118,0],[4116,17,4116,80,0],[4117,9,4117,10,0],[4121,9,4121,10,0],[4124,13,4124,91,0],[4126,13,4126,33,0],[4127,13,4127,14,0],[4128,17,4128,64,0],[4131,13,4131,14,0],[4132,17,4132,97,0],[4133,17,4133,97,0],[4134,17,4134,100,0],[4135,13,4135,14,0],[4137,13,4137,63,0],[4138,13,4138,80,0],[4140,13,4140,33,0],[4141,13,4141,96,0],[4142,17,4142,110,0],[4144,13,4144,87,0],[4145,13,4145,14,0],[4146,17,4146,115,0],[4147,17,4147,44,0],[4148,17,4148,18,0],[4149,21,4149,171,0],[4150,21,4150,40,0],[4151,21,4151,28,0],[4153,13,4153,14,0],[4155,13,4155,37,0],[4157,13,4157,48,0],[4158,13,4158,37,0],[4159,13,4159,14,0],[4160,17,4160,41,0],[4161,17,4161,33,0],[4162,13,4162,14,0],[4163,13,4163,64,0],[4166,13,4166,14,0],[4167,17,4167,139,0],[4168,17,4168,91,0],[4170,17,4170,65,0],[4171,17,4171,109,0],[4172,17,4174,73,0],[4176,17,4176,127,0],[4177,17,4177,51,0],[4178,13,4178,14,0],[4179,13,4179,18,0],[4180,13,4180,14,0],[4181,17,4181,59,0],[4182,13,4182,14,0],[4184,9,4184,10,0],[4186,9,4186,10,0],[4189,13,4189,91,0],[4191,13,4191,33,0],[4192,13,4192,14,0],[4193,17,4193,64,0],[4196,13,4196,14,0],[4197,17,4197,97,0],[4198,17,4198,97,0],[4199,17,4199,100,0],[4201,17,4201,52,0],[4202,13,4202,14,0],[4204,13,4204,63,0],[4205,13,4205,64,0],[4207,13,4207,141,0],[4208,13,4208,113,0],[4210,13,4210,47,0],[4211,9,4211,10,0],[4214,9,4214,10,0],[4215,13,4215,73,0],[4216,9,4216,10,0]]);
    </script>
  </body>
</html>