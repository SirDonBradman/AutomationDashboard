<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\WORKFLW\BrixWorkflow.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Web;
using System.Web.Script.Serialization;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Xml;
using System.Xml.Linq;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Evaluator;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.Common;
using Aurigo.Workflow;
using Infragistics.WebUI.UltraWebGrid;

namespace Aurigo.Brix.WorkflowUI
{
    public partial class BrixWorkflow : BrixPageBase
    {
        private IActivityInstance _CurrentlySelectedActivity;
        private IProvider _Provider;
        private ITemplateWFManager _TemplatesMgr;
        private string _WFFile = &quot;&quot;;
        private string _WFFileId = &quot;&quot;;
        private string _WFFormId = &quot;&quot;;
        private IProviderManager _WfProviderMgr;
        private StateMachineTemplate _wfTemplate;
        private StateMachineTemplate TempWfTemplate;
        private bool isEditMode;
        private bool isViewMode;
        private bool isOriginalViewMode;
        private bool isSystemWorkflow;
        private string strLinkedFormXML;
        private List&lt;IState&gt; Stages;

        protected override void CreateChildControls()
        {
            var menus = new List&lt;MenuGroup&gt;();
            MenuGroup standard = new MenuGroup(&quot;Standard&quot;);
            menus.Add(standard);
            standard.AddMenu(new LargeButton(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;));
            standard.AddMenu(new LargeButton(&quot;lnkClose&quot;, &quot;Close&quot;, &quot;Icn_Cancel.png&quot;));
            standard.AddMenu(new LargeButton(&quot;lnkCopy&quot;, &quot;Copy&quot;, &quot;Icn_Copy.png&quot;));
            MenuGroup workflow = new MenuGroup(&quot;Workflow&quot;);
            menus.Add(workflow);
            workflow.AddMenu(new TextIcon(&quot;lnkState&quot;, &quot;Add Stage&quot;, &quot;Icn_WF_AddStage.png&quot;));
            workflow.AddMenu(new TextIcon(&quot;lnkAction&quot;, &quot;Add Action&quot;, &quot;Icn_WF_AddAction.png&quot;));
            if (!isViewMode)
            {
                MenuGroup activities = new MenuGroup(&quot;Activities&quot;);
                activities.AddMenu(new TextIcon(&quot;lnkExtActivity&quot;, &quot;External Activity&quot;, &quot;Icn_WF_AddActivity.png&quot;));
                activities.AddMenu(new TextIcon(&quot;lnkIfBlock&quot;, &quot;If Block&quot;, &quot;Icn_WF_AddIfBlock.png&quot;));
                activities.AddMenu(new TextIcon(&quot;lnkIfElseBranch&quot;, &quot;If-Else Branch&quot;, &quot;Icn_WF_AddIfCondition.png&quot;));
                activities.AddMenu(new TextIcon(&quot;lnkSetStatus&quot;, &quot;Set Status&quot;, &quot;Icn_WF_AddSetStage.png&quot;));
                activities.AddMenu(new TextIcon(&quot;lnkSetFormStatus&quot;, &quot;Set Form Status&quot;, &quot;Icn_WF_AddSetFormStatus.png&quot;));
                activities.AddMenu(new TextIcon(&quot;lnkSendValidationMessage&quot;, &quot;Display Message&quot;, &quot;Icn_WF_AddMessage.png&quot;));
                activities.AddMenu(new TextIcon(&quot;lnkCreateLinkedForm&quot;, &quot;Create Linked Form&quot;, &quot;Icn_WF_AddMessage.png&quot;));
                menus.Add(activities);
            }
            workflow.AddMenu(new TextIcon(&quot;lnkRemove&quot;, &quot;Remove&quot;, &quot;Icn_WFRemove.png&quot;));
            workflow.AddMenu(new TextIcon(&quot;lnkMoveUp&quot;, &quot;Move Up&quot;, &quot;Icn_BtnUp_16.png&quot;));
            workflow.AddMenu(new TextIcon(&quot;lnkMoveDown&quot;, &quot;Move Down&quot;, &quot;Icn_BtnDown_16.png&quot;));
            if (_ModuleComponents.Contains(&quot;ImpExpWFXML&quot;))
                workflow.AddMenu(new TextIcon(&quot;lnkExport&quot;, &quot;Export To XML&quot;, &quot;Icn_export.png&quot;));
            //workflow.AddMenu(new TextIcon(&quot;lnkImport&quot;, &quot;Import From XML&quot;, &quot;Icn_export.png&quot;));
            CreateToolBarMenu(menus, null);
            base.CreateChildControls();
        }

        protected override void CustomizeToolBar()
        {
            if (null == MainToolBar) return;
            MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += btnSaveWorkflow_Click;
            MainToolBar.GetMenuReference(&quot;lnkCopy&quot;).Click += btnCopyWorkflow_Click;
            MainToolBar.GetMenuReference(&quot;lnkClose&quot;).Click += lnkClose_Click;
            MainToolBar.GetMenuReference(&quot;lnkClose&quot;).CausesValidation = false;
            string sScript = &quot;$(&#39;#{0}&#39;).val(&#39;{1}&#39;);$(&#39;#{2}&#39;).click(); return false;&quot;;
            MainToolBar.GetMenuReference(&quot;lnkState&quot;).OnClientClick = string.Format(sScript, hdnActivity.ClientID,
                &quot;AddState&quot;, hdnbtn.ClientID);
            MainToolBar.GetMenuReference(&quot;lnkAction&quot;).OnClientClick = string.Format(sScript, hdnActivity.ClientID,
                &quot;AddAction&quot;, hdnbtn.ClientID);

            if (!isViewMode)
            {
                MainToolBar.GetMenuReference(&quot;lnkExtActivity&quot;).OnClientClick = string.Format(sScript,
                    hdnActivity.ClientID, &quot;AddActivity&quot;, hdnbtn.ClientID);
                MainToolBar.GetMenuReference(&quot;lnkSendValidationMessage&quot;).OnClientClick = string.Format(sScript,
                    hdnActivity.ClientID, &quot;AddValidationMessage&quot;, hdnbtn.ClientID);
                MainToolBar.GetMenuReference(&quot;lnkIfBlock&quot;).OnClientClick = string.Format(sScript, hdnActivity.ClientID,
                    &quot;AddIfBlock&quot;, hdnbtn.ClientID);
                MainToolBar.GetMenuReference(&quot;lnkIfElseBranch&quot;).OnClientClick = string.Format(sScript,
                    hdnActivity.ClientID, &quot;AddIfBranch&quot;, hdnbtn.ClientID);
                MainToolBar.GetMenuReference(&quot;lnkSetStatus&quot;).OnClientClick = string.Format(sScript, hdnActivity.ClientID,
                    &quot;AddSetStateActivity&quot;, hdnbtn.ClientID);
                MainToolBar.GetMenuReference(&quot;lnkSetFormStatus&quot;).OnClientClick = string.Format(sScript,
                    hdnActivity.ClientID, &quot;AddSetFormStatus&quot;, hdnbtn.ClientID);
                MainToolBar.GetMenuReference(&quot;lnkCreateLinkedForm&quot;).OnClientClick = string.Format(sScript,
                    hdnActivity.ClientID, &quot;AddLinkedForm&quot;, hdnbtn.ClientID);
            }

            MainToolBar.GetMenuReference(&quot;lnkMoveUp&quot;).OnClientClick = string.Format(sScript, hdnActivity.ClientID,
                &quot;MoveUp&quot;, hdnbtn.ClientID);
            MainToolBar.GetMenuReference(&quot;lnkMoveDown&quot;).OnClientClick = string.Format(sScript, hdnActivity.ClientID,
                &quot;MoveDown&quot;, hdnbtn.ClientID);
            MainToolBar.GetMenuReference(&quot;lnkRemove&quot;).OnClientClick = string.Format(sScript, hdnActivity.ClientID,
                &quot;Remove&quot;, hdnbtn.ClientID);
            if (MainToolBar.GetMenuReference(&quot;lnkExport&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkExport&quot;).Click += lnkExport_Click;
            //MainToolBar.GetMenuReference(&quot;lnkImport&quot;).Click += lnkImport_Click;

            MainToolBar.GetMenuReference(&quot;lnkSave&quot;).ValidationGroup = &quot;SaveValidationGroup&quot;;
            MainToolBar.GetMenuReference(&quot;lnkCopy&quot;).ValidationGroup = &quot;SaveValidationGroup&quot;;

            InitSelectedActivity();
        }

        private void EnableDisableMenus()
        {
            HideMenu(&quot;lnkAction&quot;, !isViewMode);
            HideMenu(&quot;lnkRemove&quot;, !isViewMode);
            if (null == _CurrentlySelectedActivity) return;
            HideMenu(&quot;lnkAction&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanAddActionButton);
            if (!isViewMode)
            {
                HideMenu(&quot;Activities&quot;, !isViewMode);
                HideMenu(&quot;lnkExtActivity&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanAddActivity);
                HideMenu(&quot;lnkIfBlock&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanAddIfBlockActivity);
                HideMenu(&quot;lnkIfElseBranch&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanAddIfActivity);
                HideMenu(&quot;lnkSetStatus&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanAddSetStateActivity);
                HideMenu(&quot;lnkSetFormStatus&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanAddSetStateActivity);
                HideMenu(&quot;lnkSendValidationMessage&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanAddActivity);
                HideMenu(&quot;lnkCreateLinkedForm&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanAddActivity);
            }
            HideMenu(&quot;lnkMoveUp&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanMoveActivityUp);
            HideMenu(&quot;lnkMoveDown&quot;, !isViewMode &amp;&amp; _CurrentlySelectedActivity.CanMoveActivityDown);
        }

        private void InitSelectedActivity()
        {
            List&lt;string&gt; strPermList = Context.Items.Contains(Constants.MODULE_PERMISSIONS)
                ? (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS]
                : new List&lt;string&gt;();
            HideMenu(&quot;lnkSave&quot;, !isViewMode &amp;&amp; (strPermList.Contains(&quot;Create&quot;) || strPermList.Contains(&quot;Edit&quot;)));
            HideMenu(&quot;lnkCopy&quot;,
                (!isOriginalViewMode || isSystemWorkflow) &amp;&amp;
                (strPermList.Contains(&quot;Create&quot;) || strPermList.Contains(&quot;Edit&quot;)));
            HideMenu(&quot;lnkState&quot;, !isViewMode);
            MainToolBar.HideMenu(&quot;lnkAction&quot;);
            MainToolBar.HideMenu(&quot;lnkMoveUp&quot;);
            MainToolBar.HideMenu(&quot;lnkMoveDown&quot;);
            MainToolBar.HideMenu(&quot;lnkRemove&quot;);
            if (!isViewMode)
            {
                MainToolBar.HideMenu(&quot;Activities&quot;);
                MainToolBar.HideMenu(&quot;lnkExtActivity&quot;);
                MainToolBar.HideMenu(&quot;lnkIfBlock&quot;);
                MainToolBar.HideMenu(&quot;lnkIfElseBranch&quot;);
                MainToolBar.HideMenu(&quot;lnkSetStatus&quot;);
                MainToolBar.HideMenu(&quot;lnkSetFormStatus&quot;);
                MainToolBar.HideMenu(&quot;lnkSendValidationMessage&quot;);
                MainToolBar.HideMenu(&quot;lnkCreateLinkedForm&quot;);
            }
            string val = tvwStates.SelectedValue;
            if (null == val || &quot;&quot; == val) return;
            string[] sArr = val.Split(&#39;:&#39;);
            if (sArr == null || sArr.Length &lt; 2) return;
            string sType = sArr[0];
            string sName = sArr[1];
            _CurrentlySelectedActivity = _wfTemplate.GetActivity(sName);
            _wfTemplate.AssociatedFormId = cmbForms.SelectedValue;
            EnableDisableMenus();
        }

        private void tvwStates_SelectedNodeChanged(object sender, EventArgs e)
        {
            EnableDisableMenus();
            ucActivityUI.InitDefinition((IsPostBack &amp;&amp; hdnTreeClicked.Value == &quot;1&quot; &amp;&amp; tvwStates.SelectedNode != null)
                ? _CurrentlySelectedActivity
                : null, sender);
            hdnTreeClicked.Value = &quot;0&quot;;
        }

        private void lnkClose_Click(object sender, EventArgs e)
        {
            if (null != _TemplatesMgr &amp;&amp; null != _wfTemplate &amp;&amp; null != _wfTemplate.TemplateId)
                _TemplatesMgr.UnLoadTemplate(_wfTemplate.TemplateId.ToString());
            Response.Redirect(&quot;~/Common/BrixListPage.aspx?Context=WORKFLW&quot;, true);
        }

        protected override void OnPreInit(EventArgs e)
        {
            ModuleId = &quot;WORKFLW&quot;;
            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);

            if (!string.IsNullOrEmpty(Request.QueryString[&quot;mode&quot;]))
            {
                if (Request.QueryString[&quot;Mode&quot;].Equals(&quot;Edit&quot;, StringComparison.CurrentCultureIgnoreCase))
                    PermissionsToCheck.Add(Constants.MODFEAT_EDIT);
                else if (Request.QueryString[&quot;Mode&quot;].Equals(&quot;View&quot;, StringComparison.CurrentCultureIgnoreCase))
                    PermissionsToCheck.Add(Constants.MODFEAT_VIEW);
                else
                    PermissionsToCheck.Add(Constants.MODFEAT_CREATE); // Default is Create mode
            }
            else
            {
                // Default is Create mode
                PermissionsToCheck.Add(Constants.MODFEAT_CREATE);
            }

            MainToolBar.EnableUpdatePanelForToolBar();
            PageUniqueID = &quot;MODMGMT&quot;;
            base.OnInit(e);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                string sInitTree = @&quot;
            InitTree();
            if(Sys != null &amp;&amp; Sys.WebForms != undefined) Sys.WebForms.PageRequestManager.getInstance().add_endRequest(InitTree);
            function InitTree() {{
                var treeLinks = document.getElementById(&#39;{0}&#39;).getElementsByTagName(&#39;A&#39;);
                for (var i = 0; i &lt; treeLinks.length; i++){{
                    var ref = treeLinks[i].href;
                    ref = ref.replace(/javascript:__doPostBack/, &#39;javascript:MarkTreeClicked();__doPostBack&#39;);
                    treeLinks[i].href = ref;
                }}
            }}
            function MarkTreeClicked() {{ document.getElementById(&#39;{1}&#39;).value = &#39;1&#39;; }}&quot;;
                sInitTree = string.Format(sInitTree, tvwStates.ClientID, hdnTreeClicked.ClientID);
                this.ClientScript.RegisterStartupScript(this.GetType(), &quot;InitWFTree&quot;, sInitTree, true);

                ucActivityUI.ExpPickerIsBeingLaunched += ucActivityUI_ExpPickerIsBeingLaunched;
                _WfProviderMgr = AppProviderManager.Instance;
                _CompanyId = ConnectionHelper.GetCurrentCompany();
                _Provider = _WfProviderMgr.GetProvider(&quot;BRIXProvider&quot;, _CompanyId);
                _TemplatesMgr = ((BrixCoreDataProvider)_Provider).GetTemplateWFManager();
                InitializeActivityDef();


                ucActivityUI.UpdateDisplay += ucActivityUI_UpdateDisplay;
                ucActivityUI.GetActivityEvent += ucActivityUI_GetActivityEvent;
                ucActivityUI.GetWorkflowEvent += ucActivityUI_GetWorkflowEvent;
                ucActivityUI.GetProviderEvent += ucActivityUI_GetProviderEvent;
                isEditMode = !string.IsNullOrEmpty(Request.QueryString[&quot;mode&quot;]) &amp;&amp; Request.QueryString[&quot;mode&quot;] == &quot;Edit&quot;;
                Session[&quot;isEditMode&quot;] = isEditMode;
                isOriginalViewMode =
                    isViewMode =
                        !string.IsNullOrEmpty(Request.QueryString[&quot;mode&quot;]) &amp;&amp; Request.QueryString[&quot;mode&quot;] == &quot;View&quot;;
                string sSelectedTemplate = Request.QueryString[&quot;tid&quot;];
                if (null == _PostConnectors) _PostConnectors = new Dictionary&lt;string, PostConnector&gt;();
                if (isEditMode || isViewMode)
                {
                    DataTable dt = WFTemplateManager.GetWorkflowDetails(Request.QueryString[&quot;ID&quot;]);
                    if (dt.Rows.Count == 1)
                    {
                        sSelectedTemplate = dt.Rows[0][&quot;WorkflowGUID&quot;].ToString();
                        _WFFile = dt.Rows[0][&quot;DefinitionFilePath&quot;].ToString();
                        _WFFileId = dt.Rows[0][&quot;FileId&quot;].ToString();
                        _WFFormId = dt.Rows[0][&quot;AssociatedForm&quot;].ToString();
                        isSystemWorkflow = null == dt.Rows[0][&quot;IsValidation&quot;] ||
                                           DBNull.Value == dt.Rows[0][&quot;IsValidation&quot;]
                            ? false
                            : (bool)dt.Rows[0][&quot;IsValidation&quot;];
                        strLinkedFormXML = dt.Rows[0][&quot;LinkedFormXML&quot;].ToString();
                    }
                    else
                        throw new InvalidOperationException(&quot;None or More than one workflows for the given Id.&quot;);
                }
                if (isSystemWorkflow) isViewMode = true;
                PageTitle = isViewMode ? &quot; View Workflow&quot; : isEditMode ? &quot; Edit Workflow&quot; : &quot; New Workflow&quot;;
                chkViewPermissions.Enabled = cmbForms.Enabled = !(isViewMode || isEditMode);
                txtWorkflowName.Enabled = txtWorkflowDescription.Enabled = !isViewMode;
                UIHelper.DisableRoleSelection(Page);
                if (!IsPostBack)
                {
                    InitWorkflow(sSelectedTemplate);
                    return;
                }
                _wfTemplate =
                    (StateMachineTemplate)
                        _TemplatesMgr.GetOrLoadWFTemplate((string)ViewState[&quot;wfid&quot;], _WFFile, _WFFileId);
                if (null == _wfTemplate) return;
                _wfTemplate.Name = string.Empty == txtWorkflowName.Text ? _wfTemplate.Name : txtWorkflowName.Text;
                _wfTemplate.LinkedFormXML =
                    hdnLinkedFormInfo.Value =
                        string.IsNullOrEmpty(hdnLinkedFormInfo.Value) ? &quot;&lt;XML&gt;&lt;/XML&gt;&quot; : hdnLinkedFormInfo.Value;
                _wfTemplate.ViewPermissions = chkViewPermissions.Checked;
                _wfTemplate.Unlock();
                InitSelectedActivity();
                if (Page.IsCallback) return;
                chkViewPermissions.Enabled =
                    cmbForms.Enabled = (null == _wfTemplate.ActivitiesList || _wfTemplate.ActivitiesList.Count &lt; 1);
                FillExpressions(ExpressionDataSource.Instance);

                if (IsPostBack &amp;&amp; hdnTreeClicked.Value == &quot;1&quot;)
                {
                    tvwStates_SelectedNodeChanged(tvwStates, null);
                }
            }
            catch (System.Exception ex)
            {
                this.Page.ClientScript.RegisterStartupScript(this.GetType(),
                    &quot;ShowAlert&quot;,
                    &quot;ShowError(&#39;Error initializing workflow / form: &quot; +
                    ex.Message.Replace(&quot;&#39;&quot;, &quot;\&#39;&quot;).Replace(&quot;\n&quot;, &quot;&quot;).Replace(&quot;\r&quot;, &quot;&quot;) + &quot;&#39;);&quot;,
                    true);
                string msg = string.Format(&quot;Error Initializing Workflow: {0}\nStackTrace: {1}&quot;, ex.Message,
                    ex.StackTrace);
                Utilities.LogToFile(AppConfig.LogFile(),
                    msg,
                    MethodBase.GetCurrentMethod());
            }
        }

        protected override void OnLoadComplete(EventArgs e)
        {
            HandleActions();
            try
            {
                base.OnLoadComplete(e);
                if (!IsPostBack) return;
                ParseActivitiesExplicitly();
                InitWorkflowForPreview(_Connectors);
            }
            catch (System.Exception ex)
            {
                string msg = string.Format(&quot;Error Rendering Workflow Preview: {0}\nStackTrace: {1}&quot;, ex.Message,
                    ex.StackTrace);
                Utilities.LogToFile(AppConfig.LogFile(),
                    msg,
                    MethodBase.GetCurrentMethod());
            }
        }

        private void HandleActions()
        {
            string actn = hdnActivity.Value;
            hdnActivity.Value = &quot;&quot;;
            if (string.IsNullOrEmpty(actn)) return;
            mnuStates_MenuItemClickHandler(null, actn);
        }

        #region fill preview UI

        const string STATEPREVIEWPREFIX = &quot;StPrev&quot;;
        CLocation _LastStateLocation;
        CLocation _NextButtonLocation;
        string _ParentState;
        string _ParentButton;
        string _TransitButton;
        string _TransitActivity;
        string _Connectors;
        Dictionary&lt;string, PostConnector&gt; _PostConnectors;

        string AjaxOnLoadFunction
        {
            get { return string.Format(&quot;{0}OnLoad&quot;, divChart.ClientID); }
        }

        string ActionConnectorColor
        {
            get { return &quot;#594933&quot;; }
        }

        string ActionOverLay
        {
            get { return &quot;#E4EEEE&quot;; }
        }

        string TransitionOverLay
        {
            get { return &quot;#A9A0A3&quot;; }
        }

        string StartStateColor
        {
            get { return &quot;#19CF32&quot;; }
        }

        string EndStateColor
        {
            get { return &quot;#E30613&quot;; }
        }

        string StateColor
        {
            get { return &quot;#FDDF1F&quot;; }
        }

        string ButtonColor
        {
            get { return &quot;#fEf8f4&quot;; }
        }

        string StartStateClass
        {
            get { return &quot;StartWindow&quot;; }
        }

        string EndStateClass
        {
            get { return &quot;EndWindow&quot;; }
        }

        string StateClass
        {
            get { return &quot;StateWindow&quot;; }
        }

        string ButtonClass
        {
            get { return &quot;ButtonWindow&quot;; }
        }

        private string GetStateColor(bool isStart = false, bool isEnd = false)
        {
            return isStart ? StartStateColor : isEnd ? EndStateColor : StateColor;
        }

        private string GetStateClass(bool isStart = false, bool isEnd = false)
        {
            return isStart ? StartStateClass : isEnd ? EndStateClass : StateClass;
        }

        private void InitWorkflowForPreview(string connectors)
        {
            string svr = @&quot;
            var isDone{0} = false;
            function Reset{0}(){{
                isDone{0} = false;
            }}
            function {0}(data,context){{
                if (context == null || context == undefined || context.Key != &#39;Preview&#39;) return;
                if (isDone{0}) return false;
                jsPlumb.Defaults.Connector = new jsPlumb.Connectors.Bezier(50);
                jsPlumb.Defaults.DragOptions = {{ cursor: &#39;pointer&#39;, zIndex: 2000 }};
                jsPlumb.Defaults.PaintStyle = {{ strokeStyle: &#39;{3}&#39;, lineWidth: 1 }};
                jsPlumb.Defaults.EndpointStyle = {{ radius: 6, fillStyle: &#39;gray&#39; }};
                jsPlumb.Defaults.Anchors = [&quot;&quot;RightMiddle&quot;&quot;, &quot;&quot;LeftMiddle&quot;&quot;, &quot;&quot;BottomRight&quot;&quot;, &quot;&quot;TopLeft&quot;&quot;];
                jsPlumb.Defaults.Container = &#39;{1}&#39;;
                var transitionConnector = new jsPlumb.Connectors.Bezier(200);
                var _makeOverlays = function (colo, text) {{
                    return [ new jsPlumb.Overlays.Arrow({{ foldback: 0.7, fillStyle: colo, location: 0.8, width: 14 }}),
                             new jsPlumb.Overlays.Label({{label:text, location:0.3}}) ];
                }};
                var getEndPoints = function (div1, div2) {{
                    var v1 = $(&#39;#&#39;+div1); var v2 = $(&#39;#&#39;+div2);
                    var d1Top = v1.position().top; var d1Left = v1.position().left;
                    var d2Top = v2.position().top; var d2Left = v2.position().left;
                    var fep1 = d1Left &gt; d2Left ? &#39;Left&#39; : &#39;Right&#39;;
                    var fep2 = &#39;Middle&#39;;
                    var tep1 = d2Top &gt; d1Top ? &#39;Top&#39; : &#39;Bottom&#39;;
                    var tep2 = d2Left &gt; d1Left ? &#39;Right&#39; : &#39;Left&#39;;
                    return [fep1 + fep2, tep1 + tep2];
                }};
                {2}
                isDone{0} = true;
            }}
            &quot;;
            if (uwtWorkflow.SelectedTabIndex == 3)
                svr += @&quot; $(document).ready(function() {{  {0}(&#39;&#39;,{{Key:&#39;Preview&#39;}});
                if(Sys != null &amp;&amp; Sys.WebForms != undefined) Sys.WebForms.PageRequestManager.getInstance().add_endRequest(Reset{0}); }});&quot;;
            else
            {
                uwtWorkflow.ClientSideEvents.AfterSelectedTabChange = AjaxOnLoadFunction;
                // string.Format(&quot;{0}(&#39;&#39;,&#39;&#39;);&quot;, AjaxOnLoadFunction);
                svr += @&quot; Reset{0}();
                if(Sys != null &amp;&amp; Sys.WebForms != undefined) Sys.WebForms.PageRequestManager.getInstance().add_endRequest(Reset{0});&quot;;
            }
            Page.ClientScript.RegisterStartupScript(this.GetType(), &quot;plumberscript&quot;,
                string.Format(svr, AjaxOnLoadFunction, divChart.ClientID, connectors, ActionConnectorColor), true);
            //ScriptManager.RegisterStartupScript(this.GetType(), &quot;plumberscript&quot;, string.Format(svr, AjaxOnLoadFunction, divChart.ClientID, connectors, ActionConnectorColor), true);
        }

        private void ParseActivitiesExplicitly()
        {
            foreach (string s in _wfTemplate.ActivitiesList)
            {
                string sName = s.Split(&#39;|&#39;)[1];
                var ai = (StateInfo)_wfTemplate.GetActivity(sName);
                _ParentState = AddStatePreview(STATEPREVIEWPREFIX + ai.InstanceId, ai.DisplayName,
                    null != ai.ActionButtons ? ai.ActionButtons.Count : 0, ai.IsStartState, ai.IsEndState);
                if (!_PostConnectors.ContainsKey(ai.InstanceId))
                    _PostConnectors.Add(ai.InstanceId, new PostConnector { buttonDivIds = new List&lt;ConnectInfo&gt;() });
                _PostConnectors[ai.InstanceId].stateDivId = _ParentState;
                _PostConnectors[ai.InstanceId].isStart = ai.IsStartState;
                _PostConnectors[ai.InstanceId].isEnd = ai.IsEndState;
                _ParentButton = &quot;&quot;;
                _TransitActivity = &quot;&quot;;
                ParseActivities(ai);
            }
            foreach (string s in _PostConnectors.Keys)
            {
                foreach (ConnectInfo ci in _PostConnectors[s].buttonDivIds)
                {
                    _Connectors += Connect(ci.btnDivId, _PostConnectors[s].stateDivId, _PostConnectors[s].isTransit,
                        _PostConnectors[s].isStart, _PostConnectors[s].isEnd, ci.transitActivity);
                }
            }
        }

        private string AddStatePreview(string sId, string sName, int numButtons, bool isStart = false,
            bool isEnd = false)
        {
            const int distXBetweenStates = 140;
            const int distYBetweenStates = 70;
            HtmlGenericControl contentDiv;
            //string sStateColor = GetStateColor(isStart, isEnd);
            AddInnerContent(sName, &quot;&quot;, GetStateClass(isStart, isEnd), out contentDiv);
            HtmlGenericControl d = new HtmlGenericControl(&quot;div&quot;);
            if (_LastStateLocation.X == 0)
            {
                _LastStateLocation.X = 30;
                _LastStateLocation.Y = 30;
                //_NextButtonLocation.X = 200; _NextButtonLocation.Y = _NextButtonLocation.YY = 0;
            }
            else
            {
                _LastStateLocation.X += distXBetweenStates; //_NextButtonLocation.X + distBetweenStates;
                //int val = _NextButtonLocation.YY;
                //_NextButtonLocation.YY = _NextButtonLocation.Y - 100;
                _LastStateLocation.YY = _LastStateLocation.Y;
                //_NextButtonLocation.Y = val + 100;
                //_LastStateLocation.Y = Math.Min(Math.Max(val + 80, _LastStateLocation.Y + 80), _NextButtonLocation.Y + ((100 * numButtons) / 2));
                _LastStateLocation.Y += distYBetweenStates;
                //_NextButtonLocation.X = _LastStateLocation.X &gt; 10 ? _LastStateLocation.X + 190 : 200;
            }
            d.Attributes.Add(&quot;class&quot;, &quot;window&quot;);
            d.Attributes.Add(&quot;style&quot;,
                &quot;Top:&quot; + _LastStateLocation.Y.ToString() + &quot;px;Left:&quot; + _LastStateLocation.X.ToString() + &quot;px&quot;);
            d.ID = sId;
            d.Controls.Add(contentDiv);
            divChart.Controls.Add(d);
            _ParentState = d.ClientID;
            return d.ClientID;
        }

        private string AddPreviewButton(string btnId, string btnDisplay, string parentStateNode)
        {
            HtmlGenericControl contentDiv;
            AddInnerContent(btnDisplay, ButtonColor, ButtonClass, out contentDiv);
            HtmlGenericControl d = new HtmlGenericControl(&quot;div&quot;);
            d.Attributes.Add(&quot;class&quot;, &quot;window&quot;);
            d.Attributes.Add(&quot;style&quot;,
                &quot;Top:&quot; + _NextButtonLocation.Y.ToString() + &quot;px;Left:&quot; + _NextButtonLocation.X.ToString() + &quot;px&quot;);
            d.ID = btnId;
            d.Controls.Add(contentDiv);
            divChart.Controls.Add(d);
            _ParentButton = d.ClientID;
            _Connectors += Connect(parentStateNode, d.ClientID);
            _NextButtonLocation.Y += 100;
            return d.ClientID;
        }

        private static void AddInnerContent(string str, string image, string sClass, out HtmlGenericControl contentDiv)
        {
            contentDiv = new HtmlGenericControl(&quot;div&quot;);
            contentDiv.Attributes.Add(&quot;class&quot;, sClass);
            //To fix XSS attack using HTMLEncoding
            contentDiv.InnerHtml =  HttpUtility.HtmlEncode(str);
        }

        private string Connect(string sWindow, string sWindow2, bool isTransition = false, bool isStart = false,
            bool isEnd = false, string sTransitionOn = &quot;&quot;)
        {
            string sVal = isTransition
                ? string.Format(
                    &quot;jsPlumb.connect({{ source: &#39;{0}&#39;, target: &#39;{1}&#39;, overlays: _makeOverlays(&#39;{3}&#39;, &#39;{4}&#39;), connector: transitionConnector, anchors: getEndPoints(&#39;{0}&#39;, &#39;{1}&#39;),  paintStyle: {{ strokeStyle: &#39;{2}&#39;, lineWidth: 1 }}, endpointStyle:{{radius: 3, fillStyle:&#39;violet&#39;}} }});\n&quot;,
                    sWindow, sWindow2, GetStateColor(isStart, isEnd), TransitionOverLay, sTransitionOn)
                : string.Format(
                    &quot;jsPlumb.connect({{ source: &#39;{0}&#39;, target: &#39;{1}&#39;, overlays: _makeOverlays(&#39;{2}&#39;, &#39;{3}&#39;), anchors: getEndPoints(&#39;{0}&#39;, &#39;{1}&#39;) }});\n&quot;,
                    sWindow, sWindow2, ActionOverLay, sTransitionOn);
            return sVal;
        }

        #endregion

        private void InitWorkflow(string sSelectedTemplate)
        {
            DataTable dt = ModuleManager.Instance.GetModules();
            cmbForms.Items.Clear();
            foreach (DataRow module in dt.Rows)
            {
                if (module[&quot;NavigateURL&quot;].ToString().StartsWith(&quot;xmlform&quot;, StringComparison.CurrentCultureIgnoreCase))
                    cmbForms.Items.Add(new ListItem(module[&quot;ModuleName&quot;].ToString(),
                        module[&quot;ModuleId&quot;].ToString().ToLower()));
            }

            int? userId = UserDetail.GetCurrentUserDetail()?.UID;

            string sFileSavedTo = string.Empty;
            if (null == sSelectedTemplate || &quot;&quot; == sSelectedTemplate)
            {
                _wfTemplate = (StateMachineTemplate)_TemplatesMgr.GetNewStateMachineTemplate(&quot;NewWF1&quot;);
                _TemplatesMgr.SaveWFTemplate(_wfTemplate, false, ref sFileSavedTo, false, userId);
            }
            else
            {
                _wfTemplate =
                    (StateMachineTemplate)_TemplatesMgr.GetOrLoadWFTemplate(sSelectedTemplate, _WFFile, _WFFileId);
                if (null == _wfTemplate)
                {
                    _wfTemplate = (StateMachineTemplate)_TemplatesMgr.GetNewStateMachineTemplate(&quot;NewWF1&quot;);
                    //_wfTemplate.DBId = (isEditMode || isViewMode) ? Int32.Parse(Request.QueryString[&quot;ID&quot;]) : 0;
                    _TemplatesMgr.SaveWFTemplate(_wfTemplate, false, ref sFileSavedTo, false, userId);
                }
                else
                {
                    FillWorkflowDetailsUI();
                }
            }
            if (!isEditMode &amp;&amp; !isViewMode)
                rGUID.Visible = false;
            else
            {
                rGUID.Visible = true;
                txtWFGUID.Text = _wfTemplate.InstanceId;
            }
            HttpContext.Current.Session[&quot;wfid&quot;] = _wfTemplate.TemplateId.ToString();
            ViewState[&quot;wfid&quot;] = _wfTemplate.TemplateId.ToString();
            _wfTemplate.Name = string.Empty == txtWorkflowName.Text ? _wfTemplate.Name : txtWorkflowName.Text;
            _wfTemplate.LinkedFormXML =
                hdnLinkedFormInfo.Value = string.IsNullOrEmpty(strLinkedFormXML) ? &quot;&lt;XML&gt;&lt;/XML&gt;&quot; : strLinkedFormXML;
            ucActivityUI.InitDefinition(_CurrentlySelectedActivity);
            InitWorkflowForPreview(_Connectors);
            FillExpressions(ExpressionDataSource.Instance);
        }

        private void FillWorkflowDetailsUI()
        {
            //_wfTemplate.DBId = (isEditMode || isViewMode) ? Int32.Parse(Request.QueryString[&quot;ID&quot;]) : 0;
            _wfTemplate.OnDeserialize();
            txtWorkflowName.Text = _wfTemplate.Name;
            txtWorkflowDescription.Text = _wfTemplate.Description;
            chkViewPermissions.Checked = _wfTemplate.ViewPermissions;
            //cmbTriggerPoints.SelectedValue = _wfTemplate.TriggerData.Action;
            Utilities.LogToFile(AppConfig.LogFile(),
                &quot;WORKFLOW-ComboValue-&quot; + _wfTemplate.TriggerData.FormSchemaId.ToLower(),
                MethodBase.GetCurrentMethod());
            string formId = string.IsNullOrEmpty(_WFFormId)
                ? _wfTemplate.TriggerData.FormSchemaId.ToLower()
                : _WFFormId.ToLower();
            if (cmbForms.Items.FindByValue(formId) != null)
                cmbForms.Items.FindByValue(formId).Selected = true;
            chkViewPermissions.Enabled =
                cmbForms.Enabled = (null == _wfTemplate.ActivitiesList || _wfTemplate.ActivitiesList.Count &lt; 1);

            TreeNode nd = null;
            string strGetError = &quot;&quot;;
            foreach (string s in _wfTemplate.ActivitiesList)
            {
                string sName = s.Split(&#39;|&#39;)[1];
                var ai = (StateInfo)_wfTemplate.GetActivity(sName);
                nd = CreateSafeTreeNode(ai.DisplayName, &quot;ST:&quot; + sName,
                    ai.IsEndState
                        ? WfUIIcons.EndWorkflow()
                        : ai.IsStartState ? WfUIIcons.StartWorkflow() : WfUIIcons.State());
                tvwStates.Nodes.Add(nd);
                _ParentState = AddStatePreview(STATEPREVIEWPREFIX + ai.InstanceId, ai.DisplayName,
                    null != ai.ActionButtons ? ai.ActionButtons.Count : 0, ai.IsStartState, ai.IsEndState);
                if (!_PostConnectors.ContainsKey(ai.InstanceId))
                    _PostConnectors.Add(ai.InstanceId, new PostConnector { buttonDivIds = new List&lt;ConnectInfo&gt;() });
                _PostConnectors[ai.InstanceId].stateDivId = _ParentState;
                _PostConnectors[ai.InstanceId].isStart = ai.IsStartState;
                _PostConnectors[ai.InstanceId].isEnd = ai.IsEndState;
                _ParentButton = &quot;&quot;;
                _TransitActivity = &quot;&quot;;
                try
                {
                    LoadInstance(ai, nd);
                }
                catch (Exception)
                {
                    JavaScriptSerializer JS = new JavaScriptSerializer();
                    strGetError = (string.IsNullOrEmpty(strGetError)
                        ? &quot;Error in stage: &quot; + ai.DisplayName
                        : &quot;\n&quot; + strGetError + &quot;,&quot; + &quot;Error in stage: &quot; + ai.DisplayName + &quot;\n&quot;);
                    this.Page.ClientScript.RegisterStartupScript(this.GetType(),
                        &quot;ShowAlertError&quot;,
                        &quot;ShowError(&quot; + &quot;Error : &quot; + JS.Serialize(strGetError) + &quot;);&quot;,
                        true);
                }
            }
            foreach (string s in _PostConnectors.Keys)
            {
                foreach (ConnectInfo ci in _PostConnectors[s].buttonDivIds)
                {
                    _Connectors += Connect(ci.btnDivId, _PostConnectors[s].stateDivId, _PostConnectors[s].isTransit,
                        _PostConnectors[s].isStart, _PostConnectors[s].isEnd, ci.transitActivity);
                }
            }
            tvwStates.ExpandAll();
            _wfTemplate.Unlock();
        }

        private string ucActivityUI_ExpPickerIsBeingLaunched(bool bVal)
        {
            hdnTreeClicked.Value = &quot;1&quot;;
            return &quot;OK&quot;;
        }

        private void LoadInstance(IActivityInstance ai, TreeNode tn)
        {
            foreach (string s in ai.ActivitiesList)
            {
                IActivityInstance aInstance = ai.GetActivity(s);
                if (null == aInstance) continue;
                TreeNode nd = GetNodeOfType(aInstance);
                if (null == nd) continue;
                tn.ChildNodes.Add(nd);
                if (aInstance.IsContainerActivity) LoadInstance(aInstance, nd);
            }
        }

        private void ParseActivities(IActivityInstance ai)
        {
            foreach (string s in ai.ActivitiesList)
            {
                IActivityInstance aInstance = ai.GetActivity(s);
                if (null == aInstance) continue;
                TreeNode nd = GetNodeOfType(aInstance);
                if (null == nd) continue;
                if (aInstance.IsContainerActivity) ParseActivities(aInstance);
            }
        }

        /// &lt;summary&gt;
        /// To avoid XSS attack, use this method to create safe TreeNode
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;imageUrl&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private TreeNode CreateSafeTreeNode(string name, string value, string imageUrl)
        {
            return new TreeNode(HttpUtility.HtmlEncode(name), value, imageUrl);
        }

        private TreeNode GetNodeOfType(IActivityInstance a)
        {
            if (null == a) return null;
            string sType = a.GetType().FullName;
            TreeNode nd = null;
            string sName = null;
            if (sType == &quot;Aurigo.Workflow.ExternalCallInstance&quot;)
            {
                var extCall = (ExternalCallInstance)a;
                sName = extCall.DisplayName;
                if (null == sName) sName = a.InstanceId;
                nd = CreateSafeTreeNode(sName, &quot;Ext:&quot; + a.InstanceId, WfUIIcons.Activity());
                return nd;
            }
            if (sType == &quot;Aurigo.Workflow.ConditionsBlock&quot;)
            {
                var ifElse = (ConditionsBlock)a;
                nd = CreateSafeTreeNode(&quot;Conditions Block&quot;, &quot;IFB:&quot; + a.InstanceId, WfUIIcons.IfBlock());
                nd.ToolTip = &quot;Select First From Below Conditions&quot;;
                return nd;
            }
            if (sType == &quot;Aurigo.Workflow.FormAction&quot;)
            {
                var fa = (FormAction)a;
                nd = CreateSafeTreeNode(fa.ActionName, &quot;BTN:&quot; + a.InstanceId, WfUIIcons.Button());
                string content = fa.ActionName + &quot;&lt;br/&gt;&quot; + fa.ActionDisplayName;
                //AddPreviewButton(BUTTONPREVIEWPREFIX + a.InstanceId, fa.ActionName, _ParentState);
                _TransitActivity = fa.ActionName;
                _TransitButton = fa.ActionName;
                return nd;
            }
            if (sType == &quot;Aurigo.Workflow.IfCondition&quot;)
            {
                var ifElseBranch = (IfCondition)a;
                sName = &quot;If &quot; +
                        (string.IsNullOrWhiteSpace(ifElseBranch.DisplayName) ? a.InstanceId : ifElseBranch.DisplayName);
                nd = CreateSafeTreeNode(sName, &quot;IF:&quot; + a.InstanceId, WfUIIcons.IfCondition());
                _TransitActivity = _TransitButton + &quot;: &quot; + sName;
                return nd;
            }
            if (sType == &quot;Aurigo.Workflow.StateInfo&quot;)
            {
                var si = (StateInfo)a;
                nd = CreateSafeTreeNode(si.DisplayName, &quot;ST:&quot; + a.InstanceId,
                    si.IsEndState
                        ? WfUIIcons.EndWorkflow()
                        : si.IsStartState ? WfUIIcons.StartWorkflow() : WfUIIcons.State());
                return nd;
            }
            if (sType == &quot;Aurigo.Workflow.SetStateActivityEx&quot;)
            {
                var sst = (SetStateActivityEx)a;
                var st = (StateInfo)_wfTemplate.GetActivity(sst.TargetState);
                sName = st.DisplayName;
                nd = CreateSafeTreeNode(&quot;Set Stage To &quot; + sName, &quot;SST:&quot; + a.InstanceId, WfUIIcons.SetState());
                if (!_PostConnectors.ContainsKey(st.InstanceId))
                    _PostConnectors.Add(st.InstanceId, new PostConnector { buttonDivIds = new List&lt;ConnectInfo&gt;() });
                //_PostConnectors[st.InstanceId].buttonDivIds.Add(new ConnectInfo { btnDivId = _ParentButton, transitActivity = _TransitActivity });
                _PostConnectors[st.InstanceId].buttonDivIds.Add(new ConnectInfo
                {
                    btnDivId = _ParentState,
                    transitActivity = _TransitActivity
                });
                _PostConnectors[st.InstanceId].isTransit = true;
                return nd;
            }
            if (sType == &quot;Aurigo.Workflow.SetFormStatus&quot;)
            {
                var sfa = (SetFormStatus)a;
                sName = (null != sfa.DisplayName) ? sfa.DisplayName : &quot;Set Form Status to &quot;;
                nd = CreateSafeTreeNode(sName, &quot;SFA:&quot; + a.InstanceId, WfUIIcons.SetFormState());
                return nd;
            }
            if (sType == &quot;Aurigo.Workflow.SendValidationMessage&quot;)
            {
                var svm = (SendValidationMessage)a;
                sName = (null != svm.DisplayName) ? svm.DisplayName : &quot;Display A Message&quot;;
                nd = CreateSafeTreeNode(sName, &quot;SVM:&quot; + a.InstanceId, WfUIIcons.DisplayMessage());
                return nd;
            }
            if (sType == &quot;Aurigo.Workflow.LinkedForm&quot;)
            {
                var svm = (LinkedForm)a;
                sName = (null != svm.DisplayName) ? svm.DisplayName : &quot;Create Form&quot;;
                nd = CreateSafeTreeNode(sName, &quot;SLF:&quot; + a.InstanceId, WfUIIcons.DisplayMessage());
                return nd;
            }
            return null;
        }

        private StateMachineTemplate ucActivityUI_GetWorkflowEvent()
        {
            return _wfTemplate;
        }

        private IProvider ucActivityUI_GetProviderEvent()
        {
            return _Provider;
        }

        private IActivityInstance ucActivityUI_GetActivityEvent()
        {
            return _CurrentlySelectedActivity;
        }

        private void ucActivityUI_UpdateDisplay(string sDisplayName, string sTooltip, IActivityInstance ai)
        {
            if (null == tvwStates.SelectedNode) return;
            //To fix XSS attack
            tvwStates.SelectedNode.Text = HttpUtility.HtmlEncode(sDisplayName);
            tvwStates.SelectedNode.ImageUrl = WfUIIcons.GetIconFor(ai);
        }

        private void btnSaveWorkflow_Click(object sender, EventArgs e)
        {
            SaveWorkflow(sender, e, false);
        }

        private void btnCopyWorkflow_Click(object sender, EventArgs e)
        {
            SaveWorkflow(sender, e, true);
        }

        private void SaveWorkflow(object sender, EventArgs e, bool bCopy)
        {
            try
            {
                if (isSystemWorkflow &amp;&amp; !bCopy)
                    throw new Exception(&quot;System workflow cannot be modified. Please make a copy in order to modify.&quot;);

                _wfTemplate.Name = bCopy ? (&quot;Copy of &quot; + _wfTemplate.Name) : txtWorkflowName.Text;
                _wfTemplate.Description = txtWorkflowDescription.Text;
                _wfTemplate.ViewPermissions = chkViewPermissions.Checked;
                _wfTemplate.TriggerData = new TriggerPoint(TriggerPoint.TriggerActions[0], cmbForms.SelectedItem.Text,
                    cmbForms.SelectedValue.ToLower());
                string deleteValidator;
                _wfTemplate.GetPossibleDeleteValidators(out deleteValidator);
                _wfTemplate.DeleteValidator = deleteValidator;
                _wfTemplate.LinkedFormXML = hdnLinkedFormInfo.Value;
                _wfTemplate.WorkflowJSON = string.Empty;

                string errMessages = &quot;&quot;;
                if (!_wfTemplate.CanLockAndSave(ref errMessages))
                {
                    JavaScriptSerializer JS = new JavaScriptSerializer();
                    string errMessage = JS.Serialize(errMessages.Replace(&quot;|&quot;, &quot;\\n&quot;));
                    ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;, &quot;ShowError(&quot; + errMessage + &quot;);&quot;, true);
                    return;
                }

                string sFileSavedTo = string.Empty;
                if (isEditMode) sFileSavedTo = _WFFile;
                _wfTemplate.LockDesign();
                _TemplatesMgr.SaveWFTemplate(_wfTemplate, true, ref sFileSavedTo, bCopy, UserDetail.GetCurrentUserDetail()?.UID);
                ViewState[&quot;wfid&quot;] = _wfTemplate.TemplateId.ToString();
                _TemplatesMgr.UnLoadTemplate(_wfTemplate.TemplateId.ToString());
            }
            catch (Exception err)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                    &quot;ShowError(&quot; + JS.Serialize(err.Message.Replace(&quot;|&quot;, &quot;\\n&quot;)) + &quot;);&quot;, true);
                return;
            }
            Response.Redirect(ResolveClientUrl(&quot;~/Common/BrixListPage.aspx&quot;) + &quot;?Context=WORKFLW&quot;);
        }

        protected void mnuStates_MenuItemClick(object sender, MenuEventArgs e)
        {
            mnuStates_MenuItemClickHandler(sender, e.Item.Value);
        }

        protected void mnuStates_MenuItemClickHandler(object sender, string value)
        {
            try
            {
                string sName = &quot;&quot;;
                string sType = &quot;&quot;;
                string val = tvwStates.SelectedValue;
                if (&quot;&quot; != val)
                {
                    sName = val.Split(&#39;:&#39;)[1];
                    sType = val.Split(&#39;:&#39;)[0];
                }
                string sParentName = &quot;&quot;;
                string sParentType = &quot;&quot;;
                val = (null == tvwStates.SelectedNode)
                    ? &quot;&quot;
                    : (null == tvwStates.SelectedNode.Parent) ? &quot;&quot; : tvwStates.SelectedNode.Parent.Value;
                if (&quot;&quot; != val)
                {
                    sParentName = val.Split(&#39;:&#39;)[1];
                    sParentType = val.Split(&#39;:&#39;)[0];
                }
                string sTreeName;
                TreeNode nd;
                IActivityInstance ai = null;
                IActivityInstance newai = null;
                ucActivityUI.ClearUI();
                switch (value)
                {
                    case &quot;AddState&quot;:
                        IState st = _wfTemplate.AddAStateToWF(&quot;New Stage Name&quot;, cmbForms.SelectedValue);
                        sTreeName = &quot;ST:&quot; + st.InstanceId;
                        nd = CreateSafeTreeNode(st.DisplayName, sTreeName, WfUIIcons.State());
                        tvwStates.Nodes.Add(nd);
                        chkViewPermissions.Enabled =
                            cmbForms.Enabled =
                                (null == _wfTemplate.ActivitiesList || _wfTemplate.ActivitiesList.Count &lt; 1);
                        break;
                    case &quot;AddAction&quot;:
                        if (&quot;ST&quot; != sType) break;
                        ai = _wfTemplate.GetActivity(sName);
                        var si = (StateInfo)ai;
                        IActivityInstance action = si.AddAction();
                        sTreeName = &quot;BTN:&quot; + action.InstanceId;
                        nd = CreateSafeTreeNode(&quot;btnDefault&quot;, sTreeName, WfUIIcons.Button());
                        tvwStates.SelectedNode.ChildNodes.AddAt(0, nd);
                        tvwStates.SelectedNode.Expand();
                        break;
                    case &quot;AddActivity&quot;:
                        ai = _wfTemplate.GetActivity(sName);
                        newai = ai.AddActivity();
                        sTreeName = &quot;EXT:&quot; + newai.InstanceId;
                        var ext = (ExternalCallInstance)newai;
                        ext.DisplayName = &quot;Application Activity&quot;;
                        nd = CreateSafeTreeNode(ext.DisplayName, sTreeName, WfUIIcons.Activity());
                        tvwStates.SelectedNode.ChildNodes.Add(nd);
                        tvwStates.SelectedNode.Expand();
                        break;
                    case &quot;AddValidationMessage&quot;:
                        ai = _wfTemplate.GetActivity(sName);
                        newai = ai.AddValidationMessage();
                        sTreeName = &quot;SVM:&quot; + newai.InstanceId;
                        var svm = (SendValidationMessage)newai;
                        svm.DisplayName = &quot;Display A Message&quot;;
                        nd = CreateSafeTreeNode(svm.DisplayName, sTreeName, WfUIIcons.DisplayMessage());
                        tvwStates.SelectedNode.ChildNodes.Add(nd);
                        tvwStates.SelectedNode.Expand();
                        break;
                    case &quot;AddIfBlock&quot;:
                        ai = _wfTemplate.GetActivity(sName);
                        newai = ai.AddIfBlockActivity();
                        sTreeName = &quot;IFB:&quot; + newai.InstanceId;
                        nd = CreateSafeTreeNode(&quot;Conditions Block&quot;, sTreeName, WfUIIcons.IfBlock());
                        nd.ToolTip = &quot;Select First From Below Conditions&quot;;
                        tvwStates.SelectedNode.ChildNodes.Add(nd);
                        tvwStates.SelectedNode.Expand();
                        break;
                    case &quot;AddIfBranch&quot;:
                        ai = _wfTemplate.GetActivity(sName);
                        newai = ai.AddIfActivity();
                        sTreeName = &quot;IF:&quot; + newai.InstanceId;
                        nd = CreateSafeTreeNode(&quot;If Condition&quot;, sTreeName, WfUIIcons.IfCondition());
                        tvwStates.SelectedNode.ChildNodes.AddAt(0, nd);
                        tvwStates.SelectedNode.Expand();
                        break;
                    case &quot;AddSetStateActivity&quot;:
                        ai = _wfTemplate.GetActivity(sName);
                        newai = ai.AddSetStateActivity();
                        sTreeName = &quot;SST:&quot; + newai.InstanceId;
                        nd = CreateSafeTreeNode(&quot;Set Workflow Stage To&quot;, sTreeName, WfUIIcons.SetState());
                        tvwStates.SelectedNode.ChildNodes.Add(nd);
                        tvwStates.SelectedNode.Expand();
                        break;
                    case &quot;AddSetFormStatus&quot;:
                        ai = _wfTemplate.GetActivity(sName);
                        newai = ai.AddSetFormStatus();
                        sTreeName = &quot;SST:&quot; + newai.InstanceId;
                        nd = CreateSafeTreeNode(&quot;Set Form Status to &quot;, sTreeName, WfUIIcons.SetFormState());
                        tvwStates.SelectedNode.ChildNodes.Add(nd);
                        tvwStates.SelectedNode.Expand();
                        break;
                    case &quot;MoveUp&quot;:
                        bool bMovedUp = false;
                        if (null == _CurrentlySelectedActivity) break;
                        if (!string.IsNullOrEmpty(sParentName))
                        {
                            ai = _wfTemplate.GetActivity(sParentName);
                            bMovedUp = ai.MoveActivity(_CurrentlySelectedActivity.InstanceId, true);
                        }
                        else bMovedUp = _wfTemplate.MoveActivity(_CurrentlySelectedActivity.InstanceId, true);
                        if (!bMovedUp) break;
                        MoveSelectedNode(tvwStates, true);
                        break;
                    case &quot;MoveDown&quot;:
                        bool bMovedDown = false;
                        if (null == _CurrentlySelectedActivity) break;
                        if (!string.IsNullOrEmpty(sParentName))
                        {
                            ai = _wfTemplate.GetActivity(sParentName);
                            bMovedDown = ai.MoveActivity(_CurrentlySelectedActivity.InstanceId, false);
                        }
                        else bMovedDown = _wfTemplate.MoveActivity(_CurrentlySelectedActivity.InstanceId, false);
                        if (!bMovedDown) break;
                        MoveSelectedNode(tvwStates, false);
                        break;
                    case &quot;Remove&quot;:
                        bool bRemoved = false;
                        if (null == _CurrentlySelectedActivity) break;
                        if (!string.IsNullOrEmpty(sParentName))
                        {
                            ai = _wfTemplate.GetActivity(sParentName);
                            bRemoved = ai.RemoveActivity(_CurrentlySelectedActivity.InstanceId);
                        }
                        else bRemoved = _wfTemplate.RemoveActivity(_CurrentlySelectedActivity.InstanceId);
                        if (!bRemoved) break;
                        RemoveSelectedNode(tvwStates);
                        InitSelectedActivity();
                        chkViewPermissions.Enabled =
                            cmbForms.Enabled =
                                (null == _wfTemplate.ActivitiesList || _wfTemplate.ActivitiesList.Count &lt; 1);
                        break;
                    case &quot;AddLinkedForm&quot;:
                        ai = _wfTemplate.GetActivity(sName);
                        newai = ai.AddLinkedForm();
                        sTreeName = &quot;SLF:&quot; + newai.InstanceId;
                        nd = CreateSafeTreeNode(&quot;Create Form&quot;, sTreeName, WfUIIcons.LinkedForm());
                        tvwStates.SelectedNode.ChildNodes.Add(nd);
                        tvwStates.SelectedNode.Expand();
                        break;
                }
            }
            catch (System.Exception ex)
            {
                string msg = string.Format(&quot;Error In Workflow Menu Handler: {0}\nStackTrace: {1}&quot;, ex.Message,
                    ex.StackTrace);
                Utilities.LogToFile(AppConfig.LogFile(),
                    msg,
                    MethodBase.GetCurrentMethod());
            }
        }

        private bool MoveSelectedNode(TreeView tvw, bool bMoveUp)
        {
            TreeNodeCollection tnc = (null == tvw.SelectedNode)
                ? null
                : (null == tvw.SelectedNode.Parent)
                    ? tvw.Nodes
                    : tvw.SelectedNode.Parent.ChildNodes;
            if (null == tnc) return false;
            TreeNode nd = tvw.SelectedNode;
            int pos = tnc.IndexOf(nd);
            if ((pos == 0 &amp;&amp; bMoveUp) || (pos == tnc.Count - 1 &amp;&amp; !bMoveUp)) return false;
            tnc.RemoveAt(pos);
            tnc.AddAt(bMoveUp ? pos - 1 : pos + 1, nd);
            nd.Select();
            return true;
        }

        private bool RemoveSelectedNode(TreeView tvw)
        {
            TreeNodeCollection tnc = (null == tvw.SelectedNode)
                ? null
                : (null == tvw.SelectedNode.Parent)
                    ? tvw.Nodes
                    : tvw.SelectedNode.Parent.ChildNodes;
            if (null == tnc) return false;
            TreeNode nd = tvw.SelectedNode;
            int pos = tnc.IndexOf(nd);
            nd = tvw.SelectedNode.Parent;
            tnc.RemoveAt(pos);
            if (null != nd) nd.Select();
            return true;
        }

        private void FillExpressions(ExpressionDataSource eds, bool bSetColumns = false)
        {
            exprList.Visible = false;
            exprList.Clear();
            if (null != eds)
            {
                exprList.Visible = true;
                lblExpressionsList.Visible = true;
                if (bSetColumns)
                {
                }
                IDictionary&lt;string, IResource&gt; dicExpForThisWorkflow = eds.GetResources(_wfTemplate.InstanceId);
                foreach (IResource res in dicExpForThisWorkflow.Values)
                {
                    IParams pms = res.GetOutputParamNames();
                    string sType = &quot;System.Boolean&quot;;
                    bool bIsArray = false;
                    GetResourceType(pms, ref sType, ref bIsArray);
                    object[] values = new object[] { res.Id, res.Name, sType, bIsArray, res.Description };
                    UltraGridRow row = new UltraGridRow(values);
                    exprList.Rows.Add(row);
                }
            }

            btnEditExpression.Disabled = true;
            btnEditExpression.Attributes.Add(&quot;onclick&quot;,
                &quot;javascript:LaunchExpressionDesigner(&#39;?ID=&quot; + Request.QueryString[&quot;ID&quot;] +
                &quot;&#39;, GetSelectedExpression(), &#39;&quot; + btnEditExpression.ClientID + &quot;&#39;); return false;&quot;);
            btnAddExpression.Attributes.Add(&quot;onclick&quot;,
                &quot;javascript:LaunchExpressionDesigner(&#39;?ID=&quot; + Request.QueryString[&quot;ID&quot;] +
                &quot;&#39;,undefined, &#39;&quot; + btnAddExpression.ClientID + &quot;&#39;); return false;&quot;);
            btnEditExpression.Visible = !isViewMode;
            btnAddExpression.Visible = !isViewMode;
            string sSelectScript = string.Format(@&quot;
            function OnExpressionsRowClick(gridName, cellId, button){{ 
                try{{ GetID(&#39;{2}&#39;).disabled = false; }} catch(e){{ }}
            }}
            function GetSelectedExpression() {{
                var g = igtbl_getGridById(&#39;{0}&#39;);
                if (undefined == g) return &#39;&#39;;
                var selectedVal = &#39;&#39;;
                for(var id in g.SelectedRows){{
                    var row = igtbl_getRowById(id);
                    if (undefined==row || null == row) continue;
                    selectedVal = row.getCellFromKey(&#39;{1}&#39;);
                    selectedVal = null == selectedVal.getValue() ? &#39;&#39; : selectedVal.getValue(); break;
                }}
                return selectedVal;
            }}&quot;, exprList.ClientID, &quot;exprId&quot;, btnEditExpression.ClientID);
            Page.ClientScript.RegisterStartupScript(this.GetType(), &quot;GetSelectedExpression&quot;, sSelectScript, true);
        }

        private static void GetResourceType(IParams pms, ref string sType, ref bool bIsArray)
        {
            if (null == pms) return;
            string[] outParams = pms.GetKeys();
            if (null == outParams || outParams.Length &lt; 1) return;
            IParam p = pms.GetParam(outParams[0]);
            if (null == p) return;
            sType = p.Type;
            bIsArray = p.IsArrayType;
        }

        protected void cmbForms_OnSelectedIndexChanged(object sender, EventArgs e)
        {
        }

        private void HideMenu(string buttonID, bool bUnHide)
        {
            if (bUnHide) MainToolBar.ShowMenu(buttonID);
            else MainToolBar.HideMenu(buttonID);
        }

        #region XML Import/Export Functionality

        /// &lt;summary&gt;
        /// For Exporting the current Workflow details to XML format.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        private void lnkExport_Click(object sender, EventArgs e)
        {
            Response.Clear();
            Response.Buffer = true;
            Response.ContentType = &quot;text/xml&quot;;
            Response.AddHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=WorkFlowDetails.xml&quot;);
            TempWfTemplate = _wfTemplate;
            SerializeWFToXML(_wfTemplate, true);
            Response.End();
        }

        /// &lt;summary&gt;
        /// For Importing the current Workflow details from XML format.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        //private void lnkImport_Click(object sender, EventArgs e)
        //{
        //    string sSelectedTemplate;
        //    string wfGUID = &quot;2&quot;;
        //    DataTable dt = WFTemplateManager.GetWorkflowDetails(wfGUID);
        //    if (dt.Rows.Count == 1)
        //    {
        //        sSelectedTemplate = dt.Rows[0][&quot;WorkflowGUID&quot;].ToString();
        //        _WFFile = dt.Rows[0][&quot;DefinitionFilePath&quot;].ToString();
        //        _WFFileId = dt.Rows[0][&quot;FileId&quot;].ToString();
        //        _WFFormId = dt.Rows[0][&quot;AssociatedForm&quot;].ToString();
        //    }
        //    else
        //        throw new InvalidOperationException(&quot;None or More than one workflows for the given Id.&quot;);
        //    TempWfTemplate = (StateMachineTemplate)_TemplatesMgr.GetOrLoadWFTemplate(sSelectedTemplate, _WFFile, _WFFileId);
        //    TempWfTemplate.OnDeserialize();
        //    InitWorkflow(string.Empty);
        //    string sWFXML = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&lt;WorkflowDetails Name=\&quot;1\&quot; Description=\&quot;Central (Road User Safety, Work By Others, Minor Capital)\&quot; AssociatedFormId=\&quot;planing\&quot;&gt;&lt;Stage Name=\&quot;Draft\&quot; Roles=\&quot;Regional Programming,Operations Programming\&quot; CanDelete=\&quot;AllowDelete\&quot; CreateTask=\&quot;True\&quot; DaysToComplete=\&quot;0\&quot; MailAlert=\&quot;False\&quot; IsStart=\&quot;True\&quot; IsEnd=\&quot;False\&quot;&gt;&lt;SectionDisplayInfo&gt;&lt;Section Name=\&quot;\&quot; Value=\&quot;\&quot; /&gt;&lt;/SectionDisplayInfo&gt;&lt;Action Name=\&quot;Submit\&quot; ToolTip=\&quot;Submit\&quot;&gt;&lt;SetStateActivity TargetStateName=\&quot;Recommend for Approval (TSS)\&quot; /&gt;&lt;/Action&gt;&lt;/Stage&gt;&lt;Stage Name=\&quot;Recommend for Approval (TSS)\&quot; Roles=\&quot;Technical Services Supervisor\&quot; CanDelete=\&quot;AllowDelete\&quot; CreateTask=\&quot;True\&quot; DaysToComplete=\&quot;0\&quot; MailAlert=\&quot;True\&quot; IsStart=\&quot;False\&quot; IsEnd=\&quot;False\&quot;&gt;&lt;SectionDisplayInfo&gt;&lt;Section Name=\&quot;\&quot; Value=\&quot;\&quot; /&gt;&lt;/SectionDisplayInfo&gt;&lt;Action Name=\&quot;Approve\&quot; ToolTip=\&quot;Approve\&quot;&gt;&lt;SetStateActivity TargetStateName=\&quot;Final Approval (HPD)\&quot; /&gt;&lt;/Action&gt;&lt;/Stage&gt;&lt;Stage Name=\&quot;Final Approval (HPD)\&quot; Roles=\&quot;Head Planning and Design\&quot; CanDelete=\&quot;AllowDelete\&quot; CreateTask=\&quot;True\&quot; DaysToComplete=\&quot;0\&quot; MailAlert=\&quot;True\&quot; IsStart=\&quot;False\&quot; IsEnd=\&quot;False\&quot;&gt;&lt;SectionDisplayInfo&gt;&lt;Section Name=\&quot;\&quot; Value=\&quot;\&quot; /&gt;&lt;/SectionDisplayInfo&gt;&lt;Action Name=\&quot;Approve\&quot; ToolTip=\&quot;Approve\&quot;&gt;&lt;SetFormStatus Name=\&quot;Set Form Status to Approved\&quot; FormStatus=\&quot;Approved\&quot; CanDeleteInStatus=\&quot;DonotDelete\&quot; /&gt;&lt;SetStateActivity TargetStateName=\&quot;Approved\&quot; /&gt;&lt;/Action&gt;&lt;/Stage&gt;&lt;Stage Name=\&quot;Approved\&quot; Roles=\&quot;\&quot; CanDelete=\&quot;DonotDelete\&quot; CreateTask=\&quot;True\&quot; DaysToComplete=\&quot;0\&quot; MailAlert=\&quot;True\&quot; IsStart=\&quot;False\&quot; IsEnd=\&quot;True\&quot;&gt;&lt;SectionDisplayInfo&gt;&lt;Section Name=\&quot;\&quot; Value=\&quot;\&quot; /&gt;&lt;/SectionDisplayInfo&gt;&lt;/Stage&gt;&lt;/WorkflowDetails&gt;&quot;;
        //    //string sWFXML = SerializeWFToXML(TempWfTemplate, false);
        //    if (!string.IsNullOrEmpty(sWFXML))
        //        DeserializeFromXML(sWFXML);

        //    FillWorkflowDetailsUI();
        //}
        /// &lt;summary&gt;
        /// Convert WF Object to XML.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;wfTemplate&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;bIsExport&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string SerializeWFToXML(StateMachineTemplate wfTemplate, bool bIsExport)
        {
            StringWriter sw = null;
            XmlWriter writer = null;
            if (bIsExport)
                writer = XmlWriter.Create(Response.OutputStream);
            else
            {
                sw = new StringWriter();
                writer = XmlWriter.Create(sw);
            }

            //Start Creating XML.
            writer.WriteStartDocument();

            //Create Root Node.
            writer.WriteStartElement(&quot;WorkflowDetails&quot;);

            //Add attributes to root node.
            writer.WriteAttributeString(&quot;Name&quot;, wfTemplate.Name);
            writer.WriteAttributeString(&quot;Description&quot;, wfTemplate.Description);
            writer.WriteAttributeString(&quot;AssociatedFormId&quot;, wfTemplate.AssociatedFormId);
            if (!string.IsNullOrEmpty(wfTemplate.LinkedFormXML))
                strLinkedFormXML = wfTemplate.LinkedFormXML;
            //Create Stages.
            foreach (IState si in wfTemplate.GetStates())
            {
                //Create Stage element.
                StateInfo state = (StateInfo)si;
                writer.WriteStartElement(&quot;Stage&quot;);

                //Create Attributes for Stage element.

                #region Set Stage attributes

                writer.WriteAttributeString(&quot;Name&quot;, state.DisplayName);
                writer.WriteAttributeString(&quot;Roles&quot;, state.ActionsMustBePerformedBy);
                writer.WriteAttributeString(&quot;ViewStakeHolders&quot;, state.ViewStakeHolders);
                writer.WriteAttributeString(&quot;CanDelete&quot;, state.AdditionalInfo.CanDelete);
                writer.WriteAttributeString(&quot;CreateTask&quot;, state.AdditionalInfo.ShowInMyTasks.ToString());
                writer.WriteAttributeString(&quot;DaysToComplete&quot;, state.DaysToComplete.ToString());
                writer.WriteAttributeString(&quot;MailAlert&quot;, state.SendMailToStakeholders.ToString());
                writer.WriteAttributeString(&quot;IsStart&quot;, state.IsStartState.ToString());
                writer.WriteAttributeString(&quot;IsEnd&quot;, state.IsEndState.ToString());

                writer.WriteAttributeString(&quot;HelpDescription&quot;, state.HelpDescription);
                //Create SectionDisplayInfo element

                #region Set SectionDisplayInfo element and attributes

                writer.WriteStartElement(&quot;SectionDisplayInfo&quot;);
                writer.WriteStartElement(&quot;Section&quot;);
                writer.WriteAttributeString(&quot;Name&quot;, string.Empty);
                writer.WriteAttributeString(&quot;Value&quot;, string.Empty);
                writer.WriteEndElement();
                writer.WriteEndElement();

                #endregion

                //Create ActionButtons

                #region Set Actionbuttons

                if (si.ActionButtons.Count &gt; 0)
                {
                    foreach (IActivityInstance action in si.ActionButtons)
                    {
                        #region Set Actions

                        writer.WriteStartElement(&quot;Action&quot;);
                        writer.WriteAttributeString(&quot;Name&quot;, ((Aurigo.Workflow.FormAction)action).ActionName);
                        writer.WriteAttributeString(&quot;ToolTip&quot;, ((Aurigo.Workflow.FormAction)action).ActionDisplayName);
                        ParseActivities(action, writer);
                        writer.WriteEndElement();

                        #endregion
                    }
                }

                #endregion

                writer.WriteEndElement();

                #endregion
            }

            writer.WriteEndElement();
            writer.WriteEndDocument();
            writer.Close();
            if (bIsExport)
                return string.Empty;
            else return sw.ToString();
        }

        /// &lt;summary&gt;
        /// Convert XML to WF Object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xml&quot;&gt;&lt;/param&gt;
        public void DeserializeFromXML(string xml)
        {
            XElement xelement = XElement.Parse(xml, LoadOptions.PreserveWhitespace);
            Object obj = null;
            ParseXMLNodes(xelement, ref obj);
        }

        /// &lt;summary&gt;
        /// Recursively parse all activities inside WF object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ai&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;writer&quot;&gt;&lt;/param&gt;
        private void ParseActivities(IActivityInstance ai, XmlWriter writer)
        {
            foreach (string s in ai.ActivitiesList)
            {
                Boolean bIsNodeForXML = true;
                IActivityInstance aInstance = ai.GetActivity(s);
                if (null == aInstance) continue;

                //Create Activity Node.
                switch (aInstance.ActivityType)
                {
                    case &quot;Aurigo.Workflow.LinkedForm&quot;:
                        writer.WriteStartElement(&quot;LinkedForm&quot;);
                        writer.WriteAttributeString(&quot;Name&quot;, ((Aurigo.Workflow.LinkedForm)aInstance).DisplayName);
                        writer.WriteAttributeString(&quot;LinkedForm&quot;,
                            ((Aurigo.Workflow.LinkedForm)aInstance).Associatedform);
                        if (!string.IsNullOrEmpty(strLinkedFormXML))
                        {
                            XmlDocument xml = new XmlDocument();
                            xml.LoadXml(strLinkedFormXML);
                            XmlNodeList xnList = xml.SelectNodes(&quot;XML/Activity&quot;);
                            foreach (XmlNode xn in xnList)
                                writer.WriteRaw(xn.InnerXml);
                        }
                        break;
                    case &quot;Aurigo.Workflow.SetStateActivityEx&quot;:
                        writer.WriteStartElement(&quot;SetStateActivity&quot;);
                        //writer.WriteAttributeString(&quot;Name&quot;, aInstance.DisplayName);
                        writer.WriteAttributeString(&quot;TargetStateName&quot;,
                            GetStateName(((Aurigo.Workflow.SetStateActivityEx)aInstance.RootActivity).TargetState));
                        break;
                    case &quot;Aurigo.Workflow.SetFormStatus&quot;:
                        writer.WriteStartElement(&quot;SetFormStatus&quot;);
                        writer.WriteAttributeString(&quot;Name&quot;, ((Aurigo.Workflow.SetFormStatus)aInstance).DisplayName);
                        writer.WriteAttributeString(&quot;FormStatus&quot;, ((Aurigo.Workflow.SetFormStatus)aInstance).FormStatus);
                        writer.WriteAttributeString(&quot;CanDeleteInStatus&quot;,
                            ((Aurigo.Workflow.SetFormStatus)aInstance).CanDeleteInStatus);
                        break;
                    case &quot;Aurigo.Workflow.SendValidationMessage&quot;:
                        writer.WriteStartElement(&quot;DisplayMessage&quot;);
                        writer.WriteAttributeString(&quot;Name&quot;,
                            ((Aurigo.Workflow.SendValidationMessage)aInstance).DisplayName);
                        //writer.WriteAttributeString(&quot;SendMessage&quot;, ((Aurigo.Workflow.SendValidationMessage)aInstance).SendMessage);
                        writer.WriteAttributeString(&quot;MessageType&quot;,
                            ((Aurigo.Workflow.SendValidationMessage)aInstance).SendMessageType.ToString());
                        writer.WriteStartElement(&quot;Message&quot;);
                        writer.WriteAttributeString(&quot;SendMessage&quot;,
                            ((Aurigo.Workflow.SendValidationMessage)aInstance).SendMessage.ToString());
                        writer.WriteStartElement(&quot;Resource&quot;);
                        writer.WriteAttributeString(&quot;Name&quot;, aInstance.ResourceInstance.InstanceName);
                        writer.WriteAttributeString(&quot;Type&quot;, &quot;DisplayMessage&quot;);
                        writer.WriteAttributeString(&quot;DataSourceId&quot;, aInstance.ResourceInstance.DataSourceId);
                        writer.WriteAttributeString(&quot;ProviderId&quot;, aInstance.ResourceInstance.ProviderId);
                        writer.WriteStartElement(&quot;InputParameters&quot;);
                        if (aInstance.ResourceInstance.InParams.Contents.Count &gt; 0)
                        {
                            SerializeParameters(writer, aInstance.ResourceInstance.InParams);
                        }
                        writer.WriteEndElement();
                        writer.WriteStartElement(&quot;OutputParameters&quot;);
                        if (aInstance.ResourceInstance.SelectedOutParams.Contents.Count &gt; 0)
                        {
                            SerializeParameters(writer, aInstance.ResourceInstance.SelectedOutParams);
                        }
                        writer.WriteEndElement();
                        writer.WriteEndElement();
                        writer.WriteEndElement();

                        break;
                    case &quot;Aurigo.Workflow.ExternalCallInstance&quot;:
                        writer.WriteStartElement(&quot;Resource&quot;);
                        writer.WriteAttributeString(&quot;Name&quot;, aInstance.ResourceInstance.InstanceName);
                        writer.WriteAttributeString(&quot;Type&quot;, &quot;ExternalActivity&quot;);
                        writer.WriteAttributeString(&quot;DataSourceId&quot;, aInstance.ResourceInstance.DataSourceId);
                        writer.WriteAttributeString(&quot;ProviderId&quot;, aInstance.ResourceInstance.ProviderId);
                        writer.WriteStartElement(&quot;InputParameters&quot;);
                        if (aInstance.ResourceInstance.InParams.Contents.Count &gt; 0)
                        {
                            SerializeParameters(writer, aInstance.ResourceInstance.InParams);
                        }
                        writer.WriteEndElement();
                        writer.WriteStartElement(&quot;OutputParameters&quot;);
                        if (aInstance.ResourceInstance.SelectedOutParams.Contents.Count &gt; 0)
                        {
                            SerializeParameters(writer, aInstance.ResourceInstance.SelectedOutParams);
                        }
                        writer.WriteEndElement();
                        break;
                    case &quot;Aurigo.Workflow.IfCondition&quot;:
                        writer.WriteStartElement(&quot;If&quot;);
                        writer.WriteAttributeString(&quot;Name&quot;, ((Aurigo.Workflow.IfCondition)aInstance).DisplayName);
                        if (aInstance.ResourceInstance != null)
                        {
                            writer.WriteStartElement(&quot;Condition&quot;);
                            writer.WriteStartElement(&quot;Resource&quot;);
                            writer.WriteAttributeString(&quot;Name&quot;, aInstance.ResourceInstance.InstanceName);
                            writer.WriteAttributeString(&quot;Type&quot;, &quot;IfCondition&quot;);
                            writer.WriteAttributeString(&quot;DataSourceId&quot;, aInstance.ResourceInstance.DataSourceId);
                            writer.WriteAttributeString(&quot;ProviderId&quot;, aInstance.ResourceInstance.ProviderId);
                            writer.WriteStartElement(&quot;InputParameters&quot;);
                            if (aInstance.ResourceInstance.InParams.Contents.Count &gt; 0)
                            {
                                SerializeParameters(writer, aInstance.ResourceInstance.InParams);
                            }
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;OutputParameters&quot;);
                            if (aInstance.ResourceInstance.SelectedOutParams.Contents.Count &gt; 0)
                            {
                                SerializeParameters(writer, aInstance.ResourceInstance.SelectedOutParams);
                            }
                            writer.WriteEndElement();
                            writer.WriteEndElement();
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;Do&quot;);
                            if (aInstance.IsContainerActivity)
                                ParseActivities(aInstance, writer);
                            writer.WriteEndElement();
                        }
                        break;
                    case &quot;Aurigo.Workflow.ConditionsBlock&quot;:
                        if (aInstance.IsContainerActivity)
                            ParseActivities(aInstance, writer);
                        bIsNodeForXML = false;
                        break;
                    default:
                        bIsNodeForXML = false;
                        break;
                }
                //Add attributes to root node.
                if (bIsNodeForXML)
                    writer.WriteEndElement();
            }
        }

        /// &lt;summary&gt;
        /// Recursively parse all nodes in XML to buil WF Template object.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;element&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;parent&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private Object ParseXMLNodes(XElement element, ref Object parent)
        {
            StateInfo si = null;
            IActivityInstance ai = null;
            StateAdditionalInfo sai = null;
            //StateMachineTemplate wfTemplate = null;
            IActivityInstance action = null;
            Object aref = null;
            Param param = null;
            if (element.NodeType == XmlNodeType.Element)
            {
                switch (element.Name.LocalName)
                {
                    case &quot;WorkflowDetails&quot;:

                        #region Set Workflow Object

                        //wfTemplate = new StateMachineTemplate();
                        _wfTemplate.Name = element.Attribute(&quot;Name&quot;).Value;
                        _wfTemplate.Description = element.Attribute(&quot;Description&quot;).Value;
                        _wfTemplate.AssociatedFormId = element.Attribute(&quot;AssociatedFormId&quot;).Value;
                        _wfTemplate.TriggerData = new TriggerPoint(TriggerPoint.TriggerActions[0], string.Empty,
                            _wfTemplate.AssociatedFormId);
                        aref = (Object)_wfTemplate;
                        if (element.HasElements)
                        {
                            foreach (XElement child in element.Elements())
                            {
                                _wfTemplate.Activities.Add((StateInfo)ParseXMLNodes(child, ref aref));
                            }
                        }

                        _wfTemplate.OnDeserialize();
                        SetWFTargetStates();
                        //return _wfTemplate;
                        break;

                        #endregion

                    case &quot;Stage&quot;:

                        #region Set Stage objects

                        si = new StateInfo();
                        si.DisplayName = element.Attribute(&quot;Name&quot;).Value;
                        si.ActionsMustBePerformedBy = element.Attribute(&quot;Roles&quot;).Value;
                        sai = new StateAdditionalInfo();
                        sai.CanDelete = element.Attribute(&quot;CanDelete&quot;).Value;
                        sai.ShowInMyTasks = Convert.ToBoolean(element.Attribute(&quot;CreateTask&quot;).Value);
                        si.SetAdditionalInfo(sai);
                        si.DaysToComplete = Convert.ToInt32(element.Attribute(&quot;DaysToComplete&quot;).Value);
                        si.SendMailToStakeholders = Convert.ToBoolean(element.Attribute(&quot;MailAlert&quot;).Value);
                        si.IsStartState = Convert.ToBoolean(element.Attribute(&quot;IsStart&quot;).Value);
                        si.IsEndState = Convert.ToBoolean(element.Attribute(&quot;IsEnd&quot;).Value);
                        if (Stages == null)
                            Stages = new List&lt;IState&gt;();
                        Stages.Add(si);
                        aref = (IActivityInstance)si;
                        if (element.HasElements)
                        {
                            foreach (XElement child in element.Elements())
                            {
                                if (child.Name.LocalName == &quot;Action&quot;)
                                    ParseXMLNodes(child, ref aref);
                            }
                        }
                        return si;

                        #endregion

                    case &quot;Action&quot;:

                        #region Set ActionButtons

                        action = ((StateInfo)parent).AddAction();
                        ai = null;
                        ((FormAction)action).ActionName = element.Attribute(&quot;Name&quot;).Value;
                        ((FormAction)action).ActionDisplayName = element.Attribute(&quot;ToolTip&quot;).Value;
                        ((FormAction)action).InitNew(((IActivityInstance)parent).InstanceId);
                        if (element.HasElements)
                        {
                            foreach (XElement child in element.Elements())
                            {
                                if (child.Name.LocalName == &quot;SetStateActivity&quot;)
                                {
                                    ai = action.AddSetStateActivity();
                                    ((SetStateActivityEx)ai).Modify(child.Attribute(&quot;TargetStateName&quot;).Value);
                                }
                                else if (child.Name.LocalName == &quot;SetFormStatus&quot;)
                                {
                                    ai = action.AddSetFormStatus();
                                    ((SetFormStatus)ai).FormStatus = child.Attribute(&quot;FormStatus&quot;).Value;
                                    ((SetFormStatus)ai).CanDeleteInStatus = child.Attribute(&quot;CanDeleteInStatus&quot;).Value;
                                    ((SetFormStatus)ai).DisplayName = child.Attribute(&quot;Name&quot;).Value;
                                }
                                else if (child.Name.LocalName == &quot;If&quot;)
                                {
                                    ai = action.AddIfBlockActivity();
                                    aref = (Object)ai;
                                    ParseXMLNodes(child, ref aref);
                                }
                                else if (child.Name.LocalName == &quot;Resource&quot;)
                                {
                                    aref = (Object)action;
                                    ParseXMLNodes(child, ref aref);
                                }
                            }
                        }
                        return action;

                        #endregion

                    case &quot;Resource&quot;:

                        #region Get Resource Details.

                        //Build Resource Object.
                        StringWriter sw = new StringWriter();
                        XmlWriter writer;
                        XmlWriterSettings Settings = new XmlWriterSettings();
                        Settings.ConformanceLevel = ConformanceLevel.Fragment;
                        Settings.OmitXmlDeclaration = true;
                        writer = XmlWriter.Create(sw, Settings);
                        if (element.Attribute(&quot;Type&quot;).Value == &quot;ExternalActivity&quot;)
                        {
                            if (((IActivityInstance)parent).ActivityType == &quot;Aurigo.Workflow.FormAction&quot;)
                                ai = ((FormAction)parent).AddActivity();
                            else if (((IActivityInstance)parent).ActivityType == &quot;Aurigo.Workflow.IfCondition&quot;)
                                ai = ((IfCondition)parent).AddActivity();
                            ((ExternalCallInstance)ai).DisplayName = element.Attribute(&quot;Name&quot;).Value;

                            writer.WriteStartElement(&quot;T&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;Aurigo.Workflow.XMLResourceInstance&quot;);
                            writer.WriteStartElement(&quot;IID&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;N&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteValue(element.Attribute(&quot;Name&quot;).Value);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;DN&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;Res&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;Prv&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteValue(element.Attribute(&quot;ProviderId&quot;).Value);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;DS&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteValue(element.Attribute(&quot;DataSourceId&quot;).Value);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;IsP&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteValue(false);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;IP&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;OP&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;Sub&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteEndElement();
                            writer.Close();
                            ((ExternalCallInstance)ai).ResInstance = sw.ToString();
                        }
                        else if (element.Attribute(&quot;Type&quot;).Value == &quot;IfCondition&quot;)
                        {
                            ai = (IfCondition)parent;
                            writer.WriteStartElement(&quot;T&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;Aurigo.Workflow.WFResourceInstance&quot;);
                            writer.WriteStartElement(&quot;IID&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;N&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteValue(element.Attribute(&quot;Name&quot;).Value);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;DN&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;Res&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;Prv&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteValue(element.Attribute(&quot;ProviderId&quot;).Value);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;DS&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteValue(element.Attribute(&quot;DataSourceId&quot;).Value);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;IsP&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteValue(false);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;IP&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;OP&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteStartElement(&quot;Sub&quot;);
                            writer.WriteAttributeString(&quot;type&quot;, &quot;System.String&quot;);
                            writer.WriteEndElement();
                            writer.WriteEndElement();
                            writer.Close();
                            ((IfCondition)ai).UpdateCondition(
                                (ResourceInstance)WorkflowUtilities.DeserializeFromString(sw.ToString()));
                        }
                        break;

                        #endregion

                    case &quot;InputParameters&quot;:

                        #region Get Input Parameter Details.

                        if (element.HasElements)
                        {
                            foreach (XElement child in element.Elements())
                            {
                                if (child.Name.LocalName == &quot;Param&quot;)
                                {
                                    param = (Param)ParseXMLNodes(child, ref parent);
                                    ((ExternalCallInstance)parent).InParams.SetParam(param.Name, string.Empty,
                                        param.Type, true);
                                }
                            }
                        }
                        break;

                        #endregion

                    case &quot;OutputParameters&quot;:

                        #region Get Output Parameters Details.

                        if (element.HasElements)
                        {
                            foreach (XElement child in element.Elements())
                            {
                                if (child.Name.LocalName == &quot;Param&quot;)
                                {
                                    param = (Param)ParseXMLNodes(child, ref parent);
                                    if (((ExternalCallInstance)parent).OutParams == null)
                                        ((ExternalCallInstance)parent).OutParams = new Params(new Guid());
                                    ((ExternalCallInstance)parent).OutParams.SetParam(param.Name, string.Empty,
                                        param.Type, true);
                                }
                            }
                        }
                        break;

                        #endregion

                    case &quot;Param&quot;:

                        #region Get Parameter Details.

                        param = new Param();
                        param.Name = element.Attribute(&quot;Name&quot;).Value;
                        param.Type = element.Attribute(&quot;Type&quot;).Value;
                        param.IsArrayType = Convert.ToBoolean(element.Attribute(&quot;IsArray&quot;).Value);
                        param.IsDerived = Convert.ToBoolean(element.Attribute(&quot;IsDerived&quot;).Value);
                        return param;

                        #endregion

                    case &quot;SetStateActivity&quot;:
                        //sst = new SetStateActivityEx();
                        //sst.InitNew();
                        //sst.Modify(element.Attribute(&quot;TargetStateName&quot;).Value);
                        //return sst;
                        break;
                    case &quot;SetFormStatus &quot;:
                        //fs = new SetFormStatus();
                        //fs.Init();
                        //fs.FormStatus = element.Attribute(&quot;FormStatus&quot;).Value;
                        //fs.CanDeleteInStatus = element.Attribute(&quot;CanDeleteInStatus&quot;).Value;
                        //fs.DisplayName = element.Attribute(&quot;Name&quot;).Value;
                        //return fs;
                        break;
                    case &quot;If&quot;:
                        ai = ((ConditionsBlock)parent).AddIfActivity();
                        ((IfCondition)ai).OnDeserialize();
                        if (element.HasElements)
                        {
                            aref = (Object)ai;
                            foreach (XElement child in element.Elements())
                            {
                                ParseXMLNodes(child, ref aref);
                            }
                        }
                        ((IfCondition)ai).DisplayName = element.Attribute(&quot;Name&quot;).Value;
                        break;
                    case &quot;Condition&quot;:
                        if (element.HasElements)
                        {
                            aref = (Object)parent;
                            foreach (XElement child in element.Elements())
                            {
                                ParseXMLNodes(child, ref aref);
                            }
                        }
                        break;
                    case &quot;Do&quot;:
                        if (element.HasElements)
                        {
                            foreach (XElement child in element.Elements())
                            {
                                if (child.Name.LocalName == &quot;SetStateActivity&quot;)
                                {
                                    ai = ((IfCondition)parent).AddSetStateActivity();
                                    ((SetStateActivityEx)ai).Modify(child.Attribute(&quot;TargetStateName&quot;).Value);
                                }
                                if (child.Name.LocalName == &quot;SetFormStatus&quot;)
                                {
                                    ai = ((IfCondition)parent).AddSetFormStatus();
                                    ((SetFormStatus)ai).FormStatus = child.Attribute(&quot;FormStatus&quot;).Value;
                                    ((SetFormStatus)ai).CanDeleteInStatus = child.Attribute(&quot;CanDeleteInStatus&quot;).Value;
                                    ((SetFormStatus)ai).DisplayName = child.Attribute(&quot;Name&quot;).Value;
                                }
                                if (child.Name.LocalName == &quot;If&quot;)
                                {
                                    ai = ((IfCondition)parent).AddIfBlockActivity();
                                    aref = (Object)ai;
                                    ParseXMLNodes(child, ref aref);
                                }
                                if (child.Name.LocalName == &quot;Resource&quot;)
                                {
                                    aref = (Object)parent;
                                    ParseXMLNodes(child, ref aref);
                                }
                            }
                        }
                        break;
                    case &quot;SectionDisplayInfo&quot;:
                        break;
                    case &quot;Section&quot;:
                        break;
                    case &quot;Value&quot;:
                        break;
                }
            }
            return null;
        }

        /// &lt;summary&gt;
        /// Set correct TargetStates for actions.
        /// &lt;/summary&gt;
        private void SetWFTargetStates()
        {
            string sTargetState = string.Empty;
            IActivityInstance ai = null;
            //For each stage, check the set state activity and set the target name.
            foreach (StateInfo stage in _wfTemplate.GetStates())
            {
                ai = (IActivityInstance)stage;
                SetWFTargetStates(ref ai);
            }
        }

        /// &lt;summary&gt;
        /// replace all target states with state guids.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ai&quot;&gt;&lt;/param&gt;
        private void SetWFTargetStates(ref IActivityInstance ai)
        {
            string sTargetState = string.Empty;
            foreach (string activity in ai.ActivitiesList)
            {
                IActivityInstance aInstance = ai.GetActivity(activity);
                if (null == aInstance) continue;

                if (aInstance.ActivityType == &quot;Aurigo.Workflow.SetStateActivityEx&quot;)
                {
                    sTargetState =
                        (from s in Stages
                            where s.DisplayName.Equals(((Aurigo.Workflow.SetStateActivityEx)(aInstance)).TargetState)
                            select s).First().InstanceId;
                    ((SetStateActivityEx)aInstance).Modify(sTargetState);
                }
                else if (aInstance.IsContainerActivity)
                    SetWFTargetStates(ref aInstance);
            }
        }

        /// &lt;summary&gt;
        /// Get the Name of the stage based on GUID.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stateId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private string GetStateName(string stateId)
        {
            var name =
                (from stage in TempWfTemplate.GetStates() where stage.InstanceId.Equals(stateId) select stage).First()
                    .DisplayName;
            return name.ToString();
        }

        /// &lt;summary&gt;
        /// Serialize input/output parameters for generating XML.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;writer&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;parameters&quot;&gt;&lt;/param&gt;
        private void SerializeParameters(XmlWriter writer, IParams parameters)
        {
            foreach (KeyValuePair&lt;string, IParam&gt; input in parameters.Contents)
            {
                writer.WriteStartElement(&quot;Param&quot;);
                writer.WriteAttributeString(&quot;Name&quot;, input.Value.Name);
                writer.WriteAttributeString(&quot;Type&quot;, input.Value.Type);
                writer.WriteAttributeString(&quot;IsArray&quot;, input.Value.IsArrayType.ToString());
                writer.WriteAttributeString(&quot;IsDerived&quot;, input.Value.IsDerived.ToString());
                writer.WriteStartElement(&quot;Value&quot;);
                writer.WriteEndElement();
                writer.WriteEndElement();
            }
        }

        #endregion

        protected void InitializeActivityDef()
        {
            //ucActivityUI = (ActivityDefinition)LoadControl(&quot;~/Modules/UserControls/ActivityDefinition.ascx&quot;);
            ucActivityUI.ExpPickerIsBeingLaunched += ucActivityUI_ExpPickerIsBeingLaunched;
            ucActivityUI.UpdateDisplay += ucActivityUI_UpdateDisplay;
            ucActivityUI.GetActivityEvent += ucActivityUI_GetActivityEvent;
            ucActivityUI.GetWorkflowEvent += ucActivityUI_GetWorkflowEvent;
            ucActivityUI.GetProviderEvent += ucActivityUI_GetProviderEvent;
        }
    }

    public struct CLocation
    {
        public int X;
        public int Y;
        public int YY;
    }

    public class PostConnector
    {
        public List&lt;ConnectInfo&gt; buttonDivIds;
        public string stateDivId;
        public bool isTransit;
        public bool isStart;
        public bool isEnd;
    }

    public class ConnectInfo
    {
        public string btnDivId;
        public string transitActivity;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,37,0],[32,9,32,39,0],[33,9,33,39,0],[45,9,45,10,0],[46,13,46,47,0],[47,13,47,60,0],[48,13,48,33,0],[49,13,49,82,0],[50,13,50,86,0],[51,13,51,82,0],[52,13,52,60,0],[53,13,53,33,0],[54,13,54,92,0],[55,13,55,95,0],[56,13,56,29,0],[57,13,57,14,0],[58,17,58,68,0],[59,17,59,115,0],[60,17,60,101,0],[61,17,61,116,0],[62,17,62,106,0],[63,17,63,120,0],[64,17,64,122,0],[65,17,65,120,0],[66,17,66,39,0],[67,13,67,14,0],[68,13,68,87,0],[69,13,69,88,0],[70,13,70,94,0],[71,13,71,59,0],[72,17,72,96,0],[74,13,74,44,0],[75,13,75,40,0],[76,9,76,10,0],[79,9,79,10,0],[80,13,80,37,0],[80,38,80,45,0],[81,13,81,84,0],[82,13,82,84,0],[83,13,83,78,0],[84,13,84,79,0],[85,13,85,86,0],[86,13,87,46,0],[88,13,89,47,0],[91,13,91,29,0],[92,13,92,14,0],[93,17,94,75,0],[95,17,96,84,0],[97,17,98,52,0],[99,17,100,75,0],[101,17,102,61,0],[103,17,104,80,0],[105,17,106,77,0],[107,13,107,14,0],[109,13,110,44,0],[111,13,112,46,0],[113,13,114,44,0],[115,13,115,67,0],[116,17,116,84,0],[119,13,119,93,0],[120,13,120,93,0],[122,13,122,36,0],[123,9,123,10,0],[126,9,126,10,0],[127,13,127,48,0],[128,13,128,48,0],[129,13,129,52,0],[129,53,129,60,0],[130,13,130,97,0],[131,13,131,29,0],[132,13,132,14,0],[133,17,133,53,0],[134,17,134,102,0],[135,17,135,105,0],[136,17,136,105,0],[137,17,137,108,0],[138,17,138,112,0],[139,17,139,112,0],[140,17,140,107,0],[141,13,141,14,0],[142,13,142,96,0],[143,13,143,100,0],[144,9,144,10,0],[147,9,147,10,0],[148,13,150,38,0],[151,13,151,114,0],[152,13,154,83,0],[155,13,155,47,0],[156,13,156,47,0],[157,13,157,47,0],[158,13,158,49,0],[159,13,159,47,0],[160,13,160,29,0],[161,13,161,14,0],[162,17,162,52,0],[163,17,163,56,0],[164,17,164,52,0],[165,17,165,57,0],[166,17,166,54,0],[167,17,167,58,0],[168,17,168,66,0],[169,17,169,61,0],[170,13,170,14,0],[171,13,171,50,0],[172,13,172,42,0],[172,43,172,50,0],[173,13,173,44,0],[174,13,174,49,0],[174,50,174,57,0],[175,13,175,36,0],[176,13,176,36,0],[177,13,177,73,0],[178,13,178,67,0],[179,13,179,34,0],[180,9,180,10,0],[183,9,183,10,0],[184,13,184,34,0],[185,13,187,33,0],[188,13,188,40,0],[189,9,189,10,0],[192,9,192,10,0],[193,13,193,96,0],[194,17,194,81,0],[195,13,195,83,0],[196,9,196,10,0],[199,9,199,10,0],[200,13,200,34,0],[201,13,201,31,0],[202,9,202,10,0],[205,9,205,10,0],[206,13,206,66,0],[208,13,208,68,0],[209,13,209,14,0],[210,17,210,107,0],[211,21,211,68,0],[212,22,212,112,0],[213,21,213,68,0],[215,21,215,70,0],[216,13,216,14,0],[218,13,218,14,0],[220,17,220,66,0],[221,13,221,14,0],[223,13,223,55,0],[224,13,224,38,0],[225,13,225,28,0],[226,9,226,10,0],[229,9,229,10,0],[231,13,231,14,0],[232,17,243,91,0],[244,17,244,99,0],[245,17,245,104,0],[247,17,247,96,0],[248,17,248,62,0],[249,17,249,67,0],[250,17,250,84,0],[251,17,251,90,0],[252,17,252,41,0],[255,17,255,74,0],[256,17,256,80,0],[257,17,257,80,0],[258,17,258,80,0],[259,17,259,122,0],[260,17,260,52,0],[261,17,263,117,0],[264,17,264,71,0],[265,17,265,45,0],[265,46,265,104,0],[266,17,266,46,0],[267,17,267,18,0],[268,21,268,100,0],[269,21,269,44,0],[270,21,270,22,0],[271,25,271,83,0],[272,25,272,79,0],[273,25,273,69,0],[274,25,274,77,0],[275,25,278,64,0],[279,25,279,83,0],[280,21,280,22,0],[282,25,282,114,0],[283,17,283,18,0],[284,17,284,38,0],[284,39,284,57,0],[285,17,285,109,0],[286,17,286,93,0],[287,17,287,88,0],[288,17,288,53,0],[289,17,289,33,0],[290,17,290,18,0],[291,21,291,53,0],[292,21,292,28,0],[294,17,296,106,0],[297,17,297,41,0],[297,42,297,49,0],[298,17,298,115,0],[299,17,301,113,0],[302,17,302,74,0],[303,17,303,38,0],[304,17,304,40,0],[305,17,305,37,0],[305,38,305,45,0],[306,17,307,117,0],[308,17,308,64,0],[310,17,310,63,0],[311,17,311,18,0],[312,21,312,68,0],[313,17,313,18,0],[314,13,314,14,0],[315,13,315,40,0],[316,13,316,14,0],[317,17,321,27,0],[322,17,323,36,0],[324,17,326,52,0],[327,13,327,14,0],[328,9,328,10,0],[331,9,331,10,0],[332,13,332,29,0],[334,13,334,14,0],[335,17,335,40,0],[336,17,336,33,0],[336,34,336,41,0],[337,17,337,45,0],[338,17,338,53,0],[339,13,339,14,0],[340,13,340,40,0],[341,13,341,14,0],[342,17,343,36,0],[344,17,346,52,0],[347,13,347,14,0],[348,9,348,10,0],[351,9,351,10,0],[352,13,352,45,0],[353,13,353,36,0],[354,13,354,44,0],[354,45,354,52,0],[355,13,355,56,0],[356,9,356,10,0],[372,17,372,18,0],[372,19,372,72,0],[372,73,372,74,0],[377,17,377,18,0],[377,19,377,36,0],[377,37,377,38,0],[382,17,382,18,0],[382,19,382,36,0],[382,37,382,38,0],[387,17,387,18,0],[387,19,387,36,0],[387,37,387,38,0],[392,17,392,18,0],[392,19,392,36,0],[392,37,392,38,0],[397,17,397,18,0],[397,19,397,36,0],[397,37,397,38,0],[402,17,402,18,0],[402,19,402,36,0],[402,37,402,38,0],[407,17,407,18,0],[407,19,407,36,0],[407,37,407,38,0],[412,17,412,18,0],[412,19,412,40,0],[412,41,412,42,0],[417,17,417,18,0],[417,19,417,38,0],[417,39,417,40,0],[422,17,422,18,0],[422,19,422,40,0],[422,41,422,42,0],[427,17,427,18,0],[427,19,427,41,0],[427,42,427,43,0],[431,9,431,10,0],[432,13,432,83,0],[433,9,433,10,0],[436,9,436,10,0],[437,13,437,83,0],[438,9,438,10,0],[441,9,441,10,0],[442,13,474,15,0],[475,13,475,51,0],[476,17,477,140,0],[479,13,479,14,0],[480,17,480,90,0],[482,17,483,135,0],[484,13,484,14,0],[485,13,486,116,0],[488,9,488,10,0],[491,9,491,10,0],[492,13,492,20,0],[492,22,492,30,0],[492,31,492,33,0],[492,34,492,60,0],[493,13,493,14,0],[494,17,494,48,0],[495,17,495,68,0],[496,17,497,108,0],[498,17,498,65,0],[499,21,499,118,0],[500,17,500,74,0],[501,17,501,74,0],[502,17,502,70,0],[503,17,503,36,0],[504,17,504,39,0],[505,17,505,37,0],[506,13,506,14,0],[507,13,507,20,0],[507,22,507,30,0],[507,31,507,33,0],[507,34,507,54,0],[508,13,508,14,0],[509,17,509,24,0],[509,26,509,40,0],[509,41,509,43,0],[509,44,509,75,0],[510,17,510,18,0],[511,21,512,99,0],[513,17,513,18,0],[514,13,514,14,0],[515,9,515,10,0],[519,9,519,10,0],[524,13,524,87,0],[525,13,525,66,0],[526,13,526,43,0],[527,13,527,14,0],[528,17,528,43,0],[529,17,529,43,0],[531,13,531,14,0],[533,13,533,14,0],[534,17,534,60,0],[537,17,537,62,0],[540,17,540,60,0],[542,13,542,14,0],[543,13,543,49,0],[544,13,545,113,0],[546,13,546,24,0],[547,13,547,40,0],[548,13,548,38,0],[549,13,549,39,0],[550,13,550,31,0],[551,9,551,10,0],[554,9,554,10,0],[556,13,556,83,0],[557,13,557,66,0],[558,13,558,49,0],[559,13,560,115,0],[561,13,561,26,0],[562,13,562,40,0],[563,13,563,38,0],[564,13,564,40,0],[565,13,565,65,0],[566,13,566,42,0],[567,13,567,31,0],[568,9,568,10,0],[571,9,571,10,0],[572,13,572,56,0],[573,13,573,56,0],[575,13,575,65,0],[576,9,576,10,0],[580,9,580,10,0],[581,13,587,70,0],[588,13,588,25,0],[589,9,589,10,0],[594,9,594,10,0],[595,13,595,64,0],[596,13,596,36,0],[597,13,597,20,0],[597,22,597,36,0],[597,37,597,39,0],[597,40,597,47,0],[598,13,598,14,0],[599,17,599,119,0],[600,21,601,67,0],[602,13,602,14,0],[604,13,604,66,0],[606,13,606,48,0],[607,13,607,70,0],[608,13,608,14,0],[609,17,609,104,0],[610,17,610,99,0],[611,13,611,14,0],[613,13,613,14,0],[614,17,615,116,0],[616,17,616,41,0],[617,17,617,18,0],[618,21,618,108,0],[620,21,620,103,0],[621,17,621,18,0],[623,17,623,18,0],[624,21,624,45,0],[625,17,625,18,0],[626,13,626,14,0],[627,13,627,44,0],[628,17,628,39,0],[630,13,630,14,0],[631,17,631,38,0],[632,17,632,57,0],[633,13,633,14,0],[634,13,634,85,0],[635,13,635,67,0],[636,13,636,111,0],[637,13,638,117,0],[639,13,639,69,0],[640,13,640,49,0],[641,13,641,60,0],[642,9,642,10,0],[645,9,645,10,0],[647,13,647,41,0],[648,13,648,53,0],[649,13,649,67,0],[650,13,650,70,0],[652,13,654,48,0],[655,13,657,39,0],[658,13,658,60,0],[659,17,659,68,0],[660,13,661,113,0],[663,13,663,32,0],[664,13,664,37,0],[665,13,665,20,0],[665,22,665,30,0],[665,31,665,33,0],[665,34,665,60,0],[666,13,666,14,0],[667,17,667,48,0],[668,17,668,68,0],[669,17,672,92,0],[673,17,673,41,0],[674,17,675,108,0],[676,17,676,65,0],[677,21,677,118,0],[678,17,678,74,0],[679,17,679,74,0],[680,17,680,70,0],[681,17,681,36,0],[682,17,682,39,0],[684,17,684,18,0],[685,21,685,42,0],[686,17,686,18,0],[687,17,687,34,0],[688,17,688,18,0],[689,21,689,74,0],[690,21,692,98,0],[693,21,696,31,0],[697,17,697,18,0],[698,13,698,14,0],[699,13,699,20,0],[699,22,699,30,0],[699,31,699,33,0],[699,34,699,54,0],[700,13,700,14,0],[701,17,701,24,0],[701,26,701,40,0],[701,41,701,43,0],[701,44,701,75,0],[702,17,702,18,0],[703,21,704,99,0],[705,17,705,18,0],[706,13,706,14,0],[707,13,707,35,0],[708,13,708,34,0],[709,9,709,10,0],[712,9,712,10,0],[713,13,713,40,0],[714,13,714,25,0],[715,9,715,10,0],[718,9,718,10,0],[719,13,719,20,0],[719,22,719,30,0],[719,31,719,33,0],[719,34,719,51,0],[720,13,720,14,0],[721,17,721,65,0],[722,17,722,39,0],[722,40,722,49,0],[723,17,723,56,0],[724,17,724,32,0],[724,33,724,42,0],[725,17,725,39,0],[726,17,726,51,0],[726,52,726,80,0],[727,13,727,14,0],[728,9,728,10,0],[731,9,731,10,0],[732,13,732,20,0],[732,22,732,30,0],[732,31,732,33,0],[732,34,732,51,0],[733,13,733,14,0],[734,17,734,65,0],[735,17,735,39,0],[735,40,735,49,0],[736,17,736,56,0],[737,17,737,32,0],[737,33,737,42,0],[738,17,738,51,0],[738,52,738,79,0],[739,13,739,14,0],[740,9,740,10,0],[750,9,750,10,0],[751,13,751,80,0],[752,9,752,10,0],[755,9,755,10,0],[756,13,756,27,0],[756,28,756,40,0],[757,13,757,49,0],[758,13,758,32,0],[759,13,759,33,0],[760,13,760,65,0],[761,13,761,14,0],[762,17,762,55,0],[763,17,763,45,0],[764,17,764,35,0],[764,36,764,57,0],[765,17,765,93,0],[766,17,766,27,0],[768,13,768,60,0],[769,13,769,14,0],[770,17,770,49,0],[771,17,771,105,0],[772,17,772,67,0],[773,17,773,27,0],[775,13,775,55,0],[776,13,776,14,0],[777,17,777,40,0],[778,17,778,99,0],[779,17,779,81,0],[781,17,781,50,0],[782,17,782,48,0],[783,17,783,27,0],[785,13,785,56,0],[786,13,786,14,0],[787,17,787,51,0],[788,17,789,121,0],[790,17,790,95,0],[791,17,791,66,0],[792,17,792,27,0],[794,13,794,54,0],[795,13,795,14,0],[796,17,796,39,0],[797,17,800,92,0],[801,17,801,27,0],[803,13,803,63,0],[804,13,804,14,0],[805,17,805,49,0],[806,17,806,78,0],[807,17,807,40,0],[808,17,808,111,0],[809,17,809,65,0],[810,21,810,118,0],[812,17,816,20,0],[817,17,817,65,0],[818,17,818,27,0],[820,13,820,58,0],[821,13,821,14,0],[822,17,822,44,0],[823,17,823,93,0],[824,17,824,97,0],[825,17,825,27,0],[827,13,827,66,0],[828,13,828,14,0],[829,17,829,52,0],[830,17,830,91,0],[831,17,831,99,0],[832,17,832,27,0],[834,13,834,55,0],[835,13,835,14,0],[836,17,836,41,0],[837,17,837,85,0],[838,17,838,99,0],[839,17,839,27,0],[841,13,841,25,0],[842,9,842,10,0],[845,9,845,10,0],[846,13,846,32,0],[847,9,847,10,0],[850,9,850,10,0],[851,13,851,30,0],[852,9,852,10,0],[855,9,855,10,0],[856,13,856,47,0],[857,9,857,10,0],[860,9,860,10,0],[861,13,861,48,0],[861,49,861,56,0],[863,13,863,80,0],[864,13,864,72,0],[865,9,865,10,0],[868,9,868,10,0],[869,13,869,44,0],[870,9,870,10,0],[873,9,873,10,0],[874,13,874,43,0],[875,9,875,10,0],[878,9,878,10,0],[880,13,880,14,0],[881,17,881,48,0],[882,21,882,119,0],[884,17,884,99,0],[885,17,885,71,0],[886,17,886,74,0],[887,17,888,55,0],[890,17,890,78,0],[891,17,891,63,0],[892,17,892,69,0],[893,17,893,57,0],[895,17,895,41,0],[896,17,896,66,0],[897,17,897,18,0],[898,21,898,74,0],[899,21,899,87,0],[900,21,900,120,0],[901,21,901,28,0],[904,17,904,52,0],[905,17,905,32,0],[905,33,905,56,0],[906,17,906,42,0],[907,17,907,130,0],[908,17,908,71,0],[909,17,909,81,0],[910,13,910,14,0],[911,13,911,34,0],[912,13,912,14,0],[913,17,913,70,0],[914,17,915,96,0],[916,17,916,24,0],[918,13,918,100,0],[919,9,919,10,0],[922,9,922,10,0],[923,13,923,66,0],[924,9,924,10,0],[927,9,927,10,0],[929,13,929,14,0],[930,17,930,35,0],[931,17,931,35,0],[932,17,932,54,0],[933,17,933,31,0],[934,17,934,18,0],[935,21,935,47,0],[936,21,936,47,0],[937,17,937,18,0],[938,17,938,41,0],[939,17,939,41,0],[940,17,942,106,0],[943,17,943,31,0],[944,17,944,18,0],[945,21,945,53,0],[946,21,946,53,0],[947,17,947,18,0],[950,17,950,45,0],[951,17,951,48,0],[952,17,952,40,0],[953,17,953,31,0],[956,25,956,105,0],[957,25,957,59,0],[958,25,958,95,0],[959,25,959,49,0],[960,25,962,110,0],[963,25,963,31,0],[965,25,965,43,0],[965,44,965,50,0],[966,25,966,61,0],[967,25,967,48,0],[968,25,968,67,0],[969,25,969,64,0],[970,25,970,94,0],[971,25,971,72,0],[972,25,972,57,0],[973,25,973,31,0],[975,25,975,61,0],[976,25,976,50,0],[977,25,977,63,0],[978,25,978,63,0],[979,25,979,66,0],[980,25,980,99,0],[981,25,981,67,0],[982,25,982,57,0],[983,25,983,31,0],[985,25,985,61,0],[986,25,986,59,0],[987,25,987,63,0],[988,25,988,64,0],[989,25,989,63,0],[990,25,990,105,0],[991,25,991,67,0],[992,25,992,57,0],[993,25,993,31,0],[995,25,995,61,0],[996,25,996,57,0],[997,25,997,63,0],[998,25,998,101,0],[999,25,999,75,0],[1000,25,1000,67,0],[1001,25,1001,57,0],[1002,25,1002,31,0],[1004,25,1004,61,0],[1005,25,1005,52,0],[1006,25,1006,62,0],[1007,25,1007,101,0],[1008,25,1008,72,0],[1009,25,1009,57,0],[1010,25,1010,31,0],[1012,25,1012,61,0],[1013,25,1013,58,0],[1014,25,1014,63,0],[1015,25,1015,107,0],[1016,25,1016,67,0],[1017,25,1017,57,0],[1018,25,1018,31,0],[1020,25,1020,61,0],[1021,25,1021,55,0],[1022,25,1022,63,0],[1023,25,1023,109,0],[1024,25,1024,67,0],[1025,25,1025,57,0],[1026,25,1026,31,0],[1028,25,1028,47,0],[1029,25,1029,64,0],[1029,65,1029,71,0],[1030,25,1030,64,0],[1031,25,1031,26,0],[1032,29,1032,71,0],[1033,29,1033,101,0],[1034,25,1034,26,0],[1035,30,1035,111,0],[1036,25,1036,39,0],[1036,40,1036,46,0],[1037,25,1037,59,0],[1038,25,1038,31,0],[1040,25,1040,49,0],[1041,25,1041,64,0],[1041,65,1041,71,0],[1042,25,1042,64,0],[1043,25,1043,26,0],[1044,29,1044,71,0],[1045,29,1045,104,0],[1046,25,1046,26,0],[1047,30,1047,114,0],[1048,25,1048,41,0],[1048,42,1048,48,0],[1049,25,1049,60,0],[1050,25,1050,31,0],[1052,25,1052,47,0],[1053,25,1053,64,0],[1053,65,1053,71,0],[1054,25,1054,64,0],[1055,25,1055,26,0],[1056,29,1056,71,0],[1057,29,1057,97,0],[1058,25,1058,26,0],[1059,30,1059,107,0],[1060,25,1060,39,0],[1060,40,1060,46,0],[1061,25,1061,55,0],[1062,25,1062,48,0],[1063,25,1065,110,0],[1066,25,1066,31,0],[1068,25,1068,61,0],[1069,25,1069,52,0],[1070,25,1070,63,0],[1071,25,1071,99,0],[1072,25,1072,67,0],[1073,25,1073,57,0],[1074,25,1074,31,0],[1076,13,1076,14,0],[1077,13,1077,40,0],[1078,13,1078,14,0],[1079,17,1080,36,0],[1081,17,1083,52,0],[1084,13,1084,14,0],[1085,9,1085,10,0],[1088,9,1088,10,0],[1089,13,1093,58,0],[1094,13,1094,29,0],[1094,30,1094,43,0],[1095,13,1095,44,0],[1096,13,1096,39,0],[1097,13,1097,77,0],[1097,78,1097,91,0],[1098,13,1098,31,0],[1099,13,1099,56,0],[1100,13,1100,25,0],[1101,13,1101,25,0],[1102,9,1102,10,0],[1105,9,1105,10,0],[1106,13,1110,58,0],[1111,13,1111,29,0],[1111,30,1111,43,0],[1112,13,1112,44,0],[1113,13,1113,39,0],[1114,13,1114,42,0],[1115,13,1115,31,0],[1116,13,1116,28,0],[1116,29,1116,41,0],[1117,13,1117,25,0],[1118,9,1118,10,0],[1121,9,1121,10,0],[1122,13,1122,38,0],[1123,13,1123,30,0],[1124,13,1124,29,0],[1125,13,1125,14,0],[1126,17,1126,41,0],[1127,17,1127,51,0],[1128,17,1128,33,0],[1129,17,1129,18,0],[1130,17,1130,18,0],[1131,17,1131,113,0],[1132,17,1132,24,0],[1132,26,1132,39,0],[1132,40,1132,42,0],[1132,43,1132,71,0],[1133,17,1133,18,0],[1134,21,1134,61,0],[1135,21,1135,53,0],[1136,21,1136,43,0],[1137,21,1137,67,0],[1138,21,1138,107,0],[1139,21,1139,65,0],[1140,21,1140,44,0],[1141,17,1141,18,0],[1142,13,1142,14,0],[1144,13,1144,47,0],[1145,13,1147,101,0],[1148,13,1150,85,0],[1151,13,1151,53,0],[1152,13,1152,52,0],[1153,13,1168,75,0],[1169,13,1169,115,0],[1170,9,1170,10,0],[1173,9,1173,10,0],[1174,13,1174,29,0],[1174,30,1174,37,0],[1175,13,1175,48,0],[1176,13,1176,59,0],[1176,60,1176,67,0],[1177,13,1177,51,0],[1178,13,1178,27,0],[1178,28,1178,35,0],[1179,13,1179,28,0],[1180,13,1180,38,0],[1181,9,1181,10,0],[1184,9,1184,10,0],[1185,9,1185,10,0],[1188,9,1188,10,0],[1189,13,1189,25,0],[1189,26,1189,57,0],[1190,18,1190,49,0],[1191,9,1191,10,0],[1201,9,1201,10,0],[1202,13,1202,30,0],[1203,13,1203,36,0],[1204,13,1204,47,0],[1205,13,1205,99,0],[1206,13,1206,42,0],[1207,13,1207,49,0],[1208,13,1208,28,0],[1209,9,1209,10,0],[1247,9,1247,10,0],[1248,13,1248,36,0],[1249,13,1249,37,0],[1250,13,1250,27,0],[1251,17,1251,66,0],[1253,13,1253,14,0],[1254,17,1254,41,0],[1255,17,1255,47,0],[1256,13,1256,14,0],[1259,13,1259,41,0],[1262,13,1262,57,0],[1265,13,1265,66,0],[1266,13,1266,80,0],[1267,13,1267,90,0],[1268,13,1268,65,0],[1269,17,1269,61,0],[1271,13,1271,20,0],[1271,22,1271,31,0],[1271,32,1271,34,0],[1271,35,1271,57,0],[1272,13,1272,14,0],[1274,17,1274,49,0],[1275,17,1275,51,0],[1281,17,1281,72,0],[1282,17,1282,86,0],[1283,17,1283,89,0],[1284,17,1284,90,0],[1285,17,1285,106,0],[1286,17,1286,96,0],[1287,17,1287,99,0],[1288,17,1288,87,0],[1289,17,1289,83,0],[1291,17,1291,87,0],[1296,17,1296,64,0],[1297,17,1297,53,0],[1298,17,1298,67,0],[1299,17,1299,68,0],[1300,17,1300,42,0],[1301,17,1301,42,0],[1309,17,1309,48,0],[1310,17,1310,18,0],[1311,21,1311,28,0],[1311,30,1311,54,0],[1311,55,1311,57,0],[1311,58,1311,74,0],[1312,21,1312,22,0],[1315,25,1315,60,0],[1316,25,1316,110,0],[1317,25,1317,120,0],[1318,25,1318,57,0],[1319,25,1319,50,0],[1322,21,1322,22,0],[1323,17,1323,18,0],[1327,17,1327,42,0],[1330,13,1330,14,0],[1332,13,1332,38,0],[1333,13,1333,39,0],[1334,13,1334,28,0],[1335,13,1335,27,0],[1336,17,1336,37,0],[1337,18,1337,39,0],[1338,9,1338,10,0],[1345,9,1345,10,0],[1346,13,1346,85,0],[1347,13,1347,31,0],[1348,13,1348,46,0],[1349,9,1349,10,0],[1357,9,1357,10,0],[1358,13,1358,20,0],[1358,22,1358,30,0],[1358,31,1358,33,0],[1358,34,1358,51,0],[1359,13,1359,14,0],[1360,17,1360,46,0],[1361,17,1361,65,0],[1362,17,1362,39,0],[1362,40,1362,49,0],[1365,17,1365,48,0],[1368,25,1368,64,0],[1369,25,1369,114,0],[1370,25,1371,85,0],[1372,25,1372,69,0],[1373,25,1373,26,0],[1374,29,1374,65,0],[1375,29,1375,59,0],[1376,29,1376,82,0],[1377,29,1377,36,0],[1377,38,1377,48,0],[1377,49,1377,51,0],[1377,52,1377,58,0],[1378,33,1378,62,0],[1379,25,1379,26,0],[1380,25,1380,31,0],[1382,25,1382,70,0],[1384,25,1385,117,0],[1386,25,1386,31,0],[1388,25,1388,67,0],[1389,25,1389,117,0],[1390,25,1390,122,0],[1391,25,1392,91,0],[1393,25,1393,31,0],[1395,25,1395,68,0],[1396,25,1397,93,0],[1399,25,1400,108,0],[1401,25,1401,61,0],[1402,25,1403,104,0],[1404,25,1404,62,0],[1405,25,1405,102,0],[1406,25,1406,79,0],[1407,25,1407,110,0],[1408,25,1408,106,0],[1409,25,1409,69,0],[1410,25,1410,84,0],[1411,25,1411,26,0],[1412,29,1412,94,0],[1413,25,1413,26,0],[1414,25,1414,50,0],[1415,25,1415,70,0],[1416,25,1416,93,0],[1417,25,1417,26,0],[1418,29,1418,103,0],[1419,25,1419,26,0],[1420,25,1420,50,0],[1421,25,1421,50,0],[1422,25,1422,50,0],[1424,25,1424,31,0],[1426,25,1426,62,0],[1427,25,1427,102,0],[1428,25,1428,81,0],[1429,25,1429,110,0],[1430,25,1430,106,0],[1431,25,1431,69,0],[1432,25,1432,84,0],[1433,25,1433,26,0],[1434,29,1434,94,0],[1435,25,1435,26,0],[1436,25,1436,50,0],[1437,25,1437,70,0],[1438,25,1438,93,0],[1439,25,1439,26,0],[1440,29,1440,103,0],[1441,25,1441,26,0],[1442,25,1442,50,0],[1443,25,1443,31,0],[1445,25,1445,56,0],[1446,25,1446,115,0],[1447,25,1447,64,0],[1448,25,1448,26,0],[1449,29,1449,67,0],[1450,29,1450,66,0],[1451,29,1451,106,0],[1452,29,1452,80,0],[1453,29,1453,114,0],[1454,29,1454,110,0],[1455,29,1455,73,0],[1456,29,1456,88,0],[1457,29,1457,30,0],[1458,33,1458,98,0],[1459,29,1459,30,0],[1460,29,1460,54,0],[1461,29,1461,74,0],[1462,29,1462,97,0],[1463,29,1463,30,0],[1464,33,1464,107,0],[1465,29,1465,30,0],[1466,29,1466,54,0],[1467,29,1467,54,0],[1468,29,1468,54,0],[1469,29,1469,60,0],[1470,29,1470,63,0],[1471,33,1471,68,0],[1472,29,1472,54,0],[1473,25,1473,26,0],[1474,25,1474,31,0],[1476,25,1476,59,0],[1477,29,1477,64,0],[1478,25,1478,47,0],[1479,25,1479,31,0],[1481,25,1481,47,0],[1482,25,1482,31,0],[1485,17,1485,35,0],[1486,21,1486,46,0],[1487,13,1487,14,0],[1488,9,1488,10,0],[1497,9,1497,10,0],[1498,13,1498,33,0],[1499,13,1499,41,0],[1500,13,1500,44,0],[1502,13,1502,45,0],[1503,13,1503,32,0],[1504,13,1504,32,0],[1505,13,1505,57,0],[1506,13,1506,14,0],[1507,17,1507,48,0],[1514,25,1514,76,0],[1515,25,1515,90,0],[1516,25,1516,100,0],[1517,25,1518,59,0],[1519,25,1519,52,0],[1520,25,1520,49,0],[1521,25,1521,26,0],[1522,29,1522,36,0],[1522,38,1522,52,0],[1522,53,1522,55,0],[1522,56,1522,74,0],[1523,29,1523,30,0],[1524,33,1524,103,0],[1525,29,1525,30,0],[1526,25,1526,26,0],[1528,25,1528,53,0],[1529,25,1529,45,0],[1531,25,1531,31,0],[1539,25,1539,46,0],[1540,25,1540,74,0],[1541,25,1541,88,0],[1542,25,1542,57,0],[1543,25,1543,78,0],[1544,25,1544,102,0],[1545,25,1545,51,0],[1546,25,1546,104,0],[1547,25,1547,109,0],[1548,25,1548,97,0],[1549,25,1549,93,0],[1550,25,1550,44,0],[1551,29,1551,57,0],[1552,25,1552,40,0],[1553,25,1553,54,0],[1554,25,1554,49,0],[1555,25,1555,26,0],[1556,29,1556,36,0],[1556,38,1556,52,0],[1556,53,1556,55,0],[1556,56,1556,74,0],[1557,29,1557,30,0],[1558,33,1558,70,0],[1559,37,1559,68,0],[1560,29,1560,30,0],[1561,25,1561,26,0],[1562,25,1562,35,0],[1570,25,1570,66,0],[1571,25,1571,35,0],[1572,25,1572,91,0],[1573,25,1573,101,0],[1574,25,1574,94,0],[1575,25,1575,49,0],[1576,25,1576,26,0],[1577,29,1577,36,0],[1577,38,1577,52,0],[1577,53,1577,55,0],[1577,56,1577,74,0],[1578,29,1578,30,0],[1579,33,1579,80,0],[1580,33,1580,34,0],[1581,37,1581,71,0],[1582,37,1582,111,0],[1583,33,1583,34,0],[1584,38,1584,82,0],[1585,33,1585,34,0],[1586,37,1586,68,0],[1587,37,1587,106,0],[1588,37,1588,120,0],[1589,37,1589,101,0],[1590,33,1590,34,0],[1591,38,1591,71,0],[1592,33,1592,34,0],[1593,37,1593,70,0],[1594,37,1594,55,0],[1595,37,1595,68,0],[1596,33,1596,34,0],[1597,38,1597,77,0],[1598,33,1598,34,0],[1599,37,1599,59,0],[1600,37,1600,68,0],[1601,33,1601,34,0],[1602,29,1602,30,0],[1603,25,1603,26,0],[1604,25,1604,39,0],[1613,25,1613,62,0],[1615,25,1615,78,0],[1616,25,1616,79,0],[1617,25,1617,60,0],[1618,25,1618,65,0],[1619,25,1619,83,0],[1620,25,1620,26,0],[1621,29,1621,106,0],[1622,33,1622,73,0],[1623,34,1623,112,0],[1624,33,1624,74,0],[1625,29,1625,102,0],[1627,29,1627,59,0],[1628,29,1628,104,0],[1629,29,1629,61,0],[1630,29,1630,82,0],[1631,29,1631,54,0],[1632,29,1632,59,0],[1633,29,1633,82,0],[1634,29,1634,80,0],[1635,29,1635,54,0],[1636,29,1636,60,0],[1637,29,1637,82,0],[1638,29,1638,54,0],[1639,29,1639,61,0],[1640,29,1640,82,0],[1641,29,1641,54,0],[1642,29,1642,61,0],[1643,29,1643,82,0],[1644,29,1644,86,0],[1645,29,1645,54,0],[1646,29,1646,60,0],[1647,29,1647,82,0],[1648,29,1648,88,0],[1649,29,1649,54,0],[1650,29,1650,61,0],[1651,29,1651,82,0],[1652,29,1652,54,0],[1653,29,1653,54,0],[1654,29,1654,60,0],[1655,29,1655,82,0],[1656,29,1656,54,0],[1657,29,1657,60,0],[1658,29,1658,82,0],[1659,29,1659,54,0],[1660,29,1660,61,0],[1661,29,1661,82,0],[1662,29,1662,54,0],[1663,29,1663,54,0],[1664,29,1664,44,0],[1665,29,1665,84,0],[1666,25,1666,26,0],[1667,30,1667,83,0],[1668,25,1668,26,0],[1669,29,1669,54,0],[1670,29,1670,59,0],[1671,29,1671,103,0],[1672,29,1672,61,0],[1673,29,1673,82,0],[1674,29,1674,54,0],[1675,29,1675,59,0],[1676,29,1676,82,0],[1677,29,1677,80,0],[1678,29,1678,54,0],[1679,29,1679,60,0],[1680,29,1680,82,0],[1681,29,1681,54,0],[1682,29,1682,61,0],[1683,29,1683,82,0],[1684,29,1684,54,0],[1685,29,1685,61,0],[1686,29,1686,82,0],[1687,29,1687,86,0],[1688,29,1688,54,0],[1689,29,1689,60,0],[1690,29,1690,82,0],[1691,29,1691,88,0],[1692,29,1692,54,0],[1693,29,1693,61,0],[1694,29,1694,82,0],[1695,29,1695,54,0],[1696,29,1696,54,0],[1697,29,1697,60,0],[1698,29,1698,82,0],[1699,29,1699,54,0],[1700,29,1700,60,0],[1701,29,1701,82,0],[1702,29,1702,54,0],[1703,29,1703,61,0],[1704,29,1704,82,0],[1705,29,1705,54,0],[1706,29,1706,54,0],[1707,29,1707,44,0],[1708,29,1709,107,0],[1710,25,1710,26,0],[1711,25,1711,31,0],[1719,25,1719,49,0],[1720,25,1720,26,0],[1721,29,1721,36,0],[1721,38,1721,52,0],[1721,53,1721,55,0],[1721,56,1721,74,0],[1722,29,1722,30,0],[1723,33,1723,69,0],[1724,33,1724,34,0],[1725,37,1725,85,0],[1726,37,1727,59,0],[1728,33,1728,34,0],[1729,29,1729,30,0],[1730,25,1730,26,0],[1731,25,1731,31,0],[1739,25,1739,49,0],[1740,25,1740,26,0],[1741,29,1741,36,0],[1741,38,1741,52,0],[1741,53,1741,55,0],[1741,56,1741,74,0],[1742,29,1742,30,0],[1743,33,1743,69,0],[1744,33,1744,34,0],[1745,37,1745,85,0],[1746,37,1746,90,0],[1747,41,1747,107,0],[1748,37,1749,59,0],[1750,33,1750,34,0],[1751,29,1751,30,0],[1752,25,1752,26,0],[1753,25,1753,31,0],[1761,25,1761,45,0],[1762,25,1762,70,0],[1763,25,1763,70,0],[1764,25,1764,99,0],[1765,25,1765,99,0],[1766,25,1766,38,0],[1775,25,1775,31,0],[1783,25,1783,31,0],[1785,25,1785,72,0],[1786,25,1786,59,0],[1787,25,1787,49,0],[1788,25,1788,26,0],[1789,29,1789,47,0],[1790,29,1790,36,0],[1790,38,1790,52,0],[1790,53,1790,55,0],[1790,56,1790,74,0],[1791,29,1791,30,0],[1792,33,1792,64,0],[1793,29,1793,30,0],[1794,25,1794,26,0],[1795,25,1795,89,0],[1796,25,1796,31,0],[1798,25,1798,49,0],[1799,25,1799,26,0],[1800,29,1800,51,0],[1801,29,1801,36,0],[1801,38,1801,52,0],[1801,53,1801,55,0],[1801,56,1801,74,0],[1802,29,1802,30,0],[1803,33,1803,64,0],[1804,29,1804,30,0],[1805,25,1805,26,0],[1806,25,1806,31,0],[1808,25,1808,49,0],[1809,25,1809,26,0],[1810,29,1810,36,0],[1810,38,1810,52,0],[1810,53,1810,55,0],[1810,56,1810,74,0],[1811,29,1811,30,0],[1812,33,1812,80,0],[1813,33,1813,34,0],[1814,37,1814,86,0],[1815,37,1815,111,0],[1816,33,1816,34,0],[1817,33,1817,77,0],[1818,33,1818,34,0],[1819,37,1819,83,0],[1820,37,1820,106,0],[1821,37,1821,120,0],[1822,37,1822,101,0],[1823,33,1823,34,0],[1824,33,1824,66,0],[1825,33,1825,34,0],[1826,37,1826,85,0],[1827,37,1827,55,0],[1828,37,1828,68,0],[1829,33,1829,34,0],[1830,33,1830,72,0],[1831,33,1831,34,0],[1832,37,1832,59,0],[1833,37,1833,68,0],[1834,33,1834,34,0],[1835,29,1835,30,0],[1836,25,1836,26,0],[1837,25,1837,31,0],[1839,25,1839,31,0],[1841,25,1841,31,0],[1843,25,1843,31,0],[1845,13,1845,14,0],[1846,13,1846,25,0],[1847,9,1847,10,0],[1853,9,1853,10,0],[1854,13,1854,48,0],[1855,13,1855,41,0],[1857,13,1857,20,0],[1857,22,1857,37,0],[1857,38,1857,40,0],[1857,41,1857,64,0],[1858,13,1858,14,0],[1859,17,1859,47,0],[1860,17,1860,43,0],[1861,13,1861,14,0],[1862,9,1862,10,0],[1869,9,1869,10,0],[1870,13,1870,48,0],[1871,13,1871,20,0],[1871,22,1871,37,0],[1871,38,1871,40,0],[1871,41,1871,58,0],[1872,13,1872,14,0],[1873,17,1873,72,0],[1874,17,1874,39,0],[1874,40,1874,49,0],[1876,17,1876,84,0],[1877,17,1877,18,0],[1878,21,1880,35,0],[1880,35,1880,118,0],[1880,118,1881,58,0],[1878,21,1881,58,0],[1882,21,1882,74,0],[1883,17,1883,18,0],[1884,22,1884,56,0],[1885,21,1885,54,0],[1886,13,1886,14,0],[1887,9,1887,10,0],[1895,9,1895,10,0],[1896,13,1897,65,0],[1897,65,1897,97,0],[1897,97,1898,34,0],[1896,13,1898,34,0],[1899,13,1899,36,0],[1900,9,1900,10,0],[1908,9,1908,10,0],[1909,13,1909,20,0],[1909,22,1909,56,0],[1909,57,1909,59,0],[1909,60,1909,79,0],[1910,13,1910,14,0],[1911,17,1911,51,0],[1912,17,1912,71,0],[1913,17,1913,71,0],[1914,17,1914,92,0],[1915,17,1915,92,0],[1916,17,1916,51,0],[1917,17,1917,42,0],[1918,17,1918,42,0],[1919,13,1919,14,0],[1920,9,1920,10,0],[1925,9,1925,10,0],[1927,13,1927,92,0],[1928,13,1928,70,0],[1929,13,1929,76,0],[1930,13,1930,76,0],[1931,13,1931,76,0],[1932,9,1932,10,0]]);
    </script>
  </body>
</html>