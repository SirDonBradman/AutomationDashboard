<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\DOCMGMT\SearchDocuments.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Web;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.DocumentManagementBL;
using Aurigo.AMP3.DocumentManagementDTO;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.ProjectBL;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;

namespace Aurigo.Brix.Platform.UI.Modules.DOCMGMT
{
    public partial class SearchDocuments : BrixPageBase
    {
        BrixFormModel model;

        public string ProjectID
        {
            get { return Request[&quot;PID&quot;]; }
        }

        string sessionSearchKey = &quot;SerachResults&quot;;

        protected override void OnInit(EventArgs e)
        {
            PageTitle = &quot;Search Documents&quot;;
            ModuleId = &quot;DOCMGMT&quot;;
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);

            List&lt;MenuGroup&gt; menuGroups = new List&lt;MenuGroup&gt;();
            MenuGroup generalGroup = new MenuGroup(&quot;General&quot;);
            generalGroup.AddMenu(new LargeButton(&quot;lnkSearch&quot;, &quot;Search&quot;, &quot;Icn_Search.png&quot;));
            generalGroup.AddMenu(new LargeButton(&quot;lnkView&quot;, &quot;View&quot;, &quot;Icn_View.png&quot;));
            generalGroup.AddMenu(new LargeButton(&quot;lnkReset&quot;, &quot;Reset&quot;, &quot;IcnFilterRem.png&quot;));

            if (generalGroup.Menus.Count &gt; 0)
                menuGroups.Add(generalGroup);

            CreateToolBarMenu(menuGroups, null);

            RenderDocumentMetadata();

            base.OnInit(e);
        }

        private void RenderDocumentMetadata()
        {
            model = ProjectManager.Instance.GetProjectMetadataXMLModel(ProjectID.ToInt32_2());
            if (model != null)
            {
                model.form.ProcessAllControlsDeeply(
                    xc =&gt;
                    {
                        if (xc.Type == ControlType.DropDownList)
                        {
                            xc.ListItems = &quot;All:-1;None:0;&quot; + xc.ListItems;
                        }
                        if (xc.Type == ControlType.Numeric || xc.Type == ControlType.Date)
                        {
                            xc.AllowNull = true;
                        }
                        if (xc.Type == ControlType.AutoIncrement)
                        {
                            xc.Type = ControlType.TextBox;
                        }
                    });
                XMLRenderingEngine engine = new XMLRenderingEngine(this, model, PageMainDiv);
                engine.Initialize();
                engine.Render(RenderFormat.RenderHtml);
            }
        }

        //private BrixFormModel GetXMLModel()
        //{
        //    string path = HttpRuntime.BinDirectory + &quot;../Modules/PROJECT/XMLControls/&quot;;

        //    string[] filePaths = Directory.GetFiles(path, &quot;PRJ*0&quot; + ProjectID + &quot;.xml&quot;);

        //    if (filePaths.Length &gt; 0)
        //    {
        //        string filePath = filePaths[0];

        //        XmlDocument xmlDoc = new XmlDocument();
        //        try
        //        {
        //            xmlDoc.Load(filePath);
        //        }
        //        catch (XmlException e)
        //        {
        //            Console.WriteLine(e.Message);
        //        }
        //        // Now create StringWriter object to get data from xml document.
        //        StringWriter sw = new StringWriter();
        //        XmlTextWriter xw = new XmlTextWriter(sw);
        //        xmlDoc.WriteTo(xw);
        //        string desXML = sw.ToString();
        //        return new BrixFormModel(desXML); ;
        //    }
        //    else
        //        return null;
        //}

        protected override void CustomizeToolBar()
        {
            if (MainToolBar.GetMenuReference(&quot;lnkView&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkView&quot;).OnClientClick = &quot;return ValidateView();&quot;;
                MainToolBar.GetMenuReference(&quot;lnkView&quot;).Click += new EventHandler(lnkView_Click);
            }

            if (MainToolBar.GetMenuReference(&quot;lnkSearch&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkSearch&quot;).OnClientClick = &quot;return searchDocs();&quot;;

            if (MainToolBar.GetMenuReference(&quot;lnkReset&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkReset&quot;).OnClientClick = &quot;return ClearSearch();&quot;;
        }

        protected void lnkView_Click(object sender, EventArgs e)
        {
            if (docgrid.DisplayLayout.SelectedRows.Count &gt; 0)
            {
                UltraGridRow GridRow = docgrid.DisplayLayout.SelectedRows[0];
                if (GridRow == null)
                {
                    lblerrormsg.Text = &quot;Please select a record.&quot;;
                    return;
                }
                int docid = GridRow.Cells.FromKey(&quot;DocId&quot;).Value.ToInt32_2();
                int VersionNo = GridRow.Cells.FromKey(&quot;VersionNo&quot;).Value.ToInt32_2();
                string storageid = GridRow.Cells.FromKey(&quot;StorageId&quot;).Value.ToString2();

                if (AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocumentViewer&quot;) &amp;&amp;
                    AMP3ApplicationSettings.Instance.appSettings[&quot;DocumentViewer&quot;].ToUpper2() == &quot;VIEWONE&quot;)
                {
                    Response.Redirect(
                        string.Format(&quot;~/ViewOne.aspx?File={0}&amp;DocId={1}&amp;Version={2}&amp;DocList={3}&quot;, storageid, docid,
                            VersionNo, Server.UrlEncode(Request.RawUrl)), false);
                }
                else if (AMP3ApplicationSettings.Instance.appSettings.ContainsKey(&quot;DocumentViewer&quot;) &amp;&amp;
                   AMP3ApplicationSettings.Instance.appSettings[&quot;DocumentViewer&quot;].ToUpper2() == &quot;LEADTOOLS&quot;)
                {
                    string docType = GridRow.Cells.FromKey(&quot;DocType&quot;).Value.ToString2();
                    Document documentDTO = DocumentManager.Instance.GetDocumentDetails(storageid);

                    if (DocumentManager.Instance.DocTypes.Contains(docType.ToLower()))
                    {
                        int linkId = DocumentManager.Instance.GetLinkIdForDocument(docid,
                            !string.IsNullOrEmpty(documentDTO.FolderDetails.ParentModuleId) ? documentDTO.FolderDetails.ParentModuleId : documentDTO.FolderDetails.ModuleId,
                            documentDTO.FolderDetails.ParentInstanceId != null ? documentDTO.FolderDetails.ParentInstanceId.ToInt32_2() : documentDTO.FolderDetails.InstanceId.ToInt32_2());

                        string mode = &quot;View&quot;;
                        Response.Redirect(
                                string.Format(
                                    &quot;~/Modules/DOCMGMT/DocumentViewer.aspx?DocID={0}&amp;VersionNo={1}&amp;Mode={2}&amp;LinkID={3}&amp;BackURL={4}&quot;,
                                    docid, VersionNo, mode, linkId, HttpContext.Current.Server.UrlEncode(Request.RawUrl)), false);
                    }
                    else
                    {
                        DocumentManager.Instance.WriteFiletoBrowser(Response, docid);
                    }
                }
                else
                {
                    DocumentManager.Instance.WriteFiletoBrowser(Response, docid);
                }
            }
            else
            {
                lblerrormsg.Text = &quot;Please select a record.&quot;;
                return;
            }
        }

        protected void lnkSearch_Click(object sender, EventArgs e)
        {
            StringBuilder sbMD = new StringBuilder();
            if (model != null)
            {
                model.form.ProcessAllControlsDeeply(
                    xc =&gt;
                    {
                        bool buildQuery = true;
                        string value = xc.GetServerValue();
                        if (xc.Type == ControlType.Date)
                        {
                            buildQuery = false;
                            DateTime dt;
                            if (DateTime.TryParse(value, out dt))
                            {
                                DateTime dateVal = value.ToMWDateTime();
                                string toDate = dateVal.AddDays(1).ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE);
                                value = dateVal.ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE);
                                sbMD.AppendFormat(&quot; [{0}] &gt;= &#39;{1}&#39; AND [{0}] &lt; &#39;{2}&#39; and&quot;, xc.Name, value, toDate);
                            }
                        }

                        if (xc.Type == ControlType.DropDownList &amp;&amp; value == &quot;-1&quot;) //-1 is for all documents
                        {
                            buildQuery = false;
                        }
                        else if (xc.Type == ControlType.DropDownList &amp;&amp; value == &quot;0&quot;) //0 for all attachments
                        {
                            buildQuery = false;
                            sbMD.AppendFormat(&quot; [{0}] = &#39;{1}&#39; and&quot;, xc.Name, &quot;0&quot;);
                        }
                        else if (xc.Type == ControlType.Listbox &amp;&amp; value == &quot;&quot;) //0 for all attachments
                        {
                            buildQuery = false;
                        }
                        else if (xc.Type == ControlType.Numeric || xc.Type == ControlType.CheckBox)
                        {
                            buildQuery = false;
                            if (value != &quot;_DBNULL_&quot;)
                                sbMD.AppendFormat(&quot; [{0}] = &#39;{1}&#39; and&quot;, xc.Name, value);
                        }

                        else if (xc.Type == ControlType.Integer)
                        {
                            buildQuery = false;
                            if (value != &quot;_DBNULL_&quot;)
                                sbMD.AppendFormat(&quot; CAST([{0}] AS NVARCHAR(50)) like &#39;%{1}%&#39; and&quot;, xc.Name, value);
                        }


                        if (!string.IsNullOrEmpty(value) &amp;&amp; buildQuery)
                        {
                            if (xc.Type == ControlType.DropDownList || xc.Type == ControlType.RadioButtonList)
                                sbMD.AppendFormat(&quot; [{0}] = &#39;{1}&#39; and&quot;, xc.Name, value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;));
                            else if (xc.Type == ControlType.Listbox)
                                sbMD.AppendFormat(&quot; [{0}] in (&#39;{1}&#39;) and&quot;, xc.Name, value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;).Replace(&quot;,&quot;,&quot;&#39;,&#39;&quot;));
                            else if (xc.Type == ControlType.Hidden &amp;&amp; xc.DBType == &quot;Int&quot;)
                                sbMD.AppendFormat(&quot; [{0}] = &#39;{1}&#39; and&quot;, xc.Name, value);
                            else
                                sbMD.AppendFormat(&quot; [{0}] like &#39;%{1}%&#39; and&quot;, xc.Name, value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;));
                        }
                    });
            }

            //Before calling BindGrid(), kill the session when user clicks on &#39;Search&#39; button. 
            //BindGrid() will set the session based on the input search criteria.
            Session[sessionSearchKey] = null;
            BindGrid(string.IsNullOrEmpty(sbMD.ToString()) ? &quot;&quot; : sbMD.ToString().TrimEnd(&quot; and&quot;.ToCharArray()));
        }

        protected void btnReset_Click(object sender, EventArgs e)
        {
            docgrid.Bands.Clear();
            Session[sessionSearchKey] = null;
            BindGrid();
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                DataSet ds = ProjectManager.Instance.GetAssociatedProjectDetails(ProjectID.ToInt32_2());
                if (ds.Tables.Count &gt; 0)
                {
                    Dictionary&lt;string, string&gt; dicts = new Dictionary&lt;string, string&gt;();
                    dicts.Add(&quot;-1&quot;, &quot;All Users&quot;);

                    foreach (DataRow row in ds.Tables[0].Rows)
                    {
                        string key = row[&quot;UserID&quot;].ToString();
                        string val = String.Format(&quot;{0} {1} {2}&quot;, row[&quot;FirstName&quot;], row[&quot;MiddleName&quot;], row[&quot;LastName&quot;]);
                        if (!dicts.ContainsKey(key))
                            dicts.Add(key, val);
                    }

                    ddlCreatedBy.DataSource = dicts;
                    ddlCreatedBy.DataTextField = &quot;Value&quot;;
                    ddlCreatedBy.DataValueField = &quot;Key&quot;;
                    ddlCreatedBy.DataBind();
                }

                //Always bind the grid based on the session values.
                //If no session, BindGrid() will take default values from the controls.
                BindGrid();
            }
        }

        protected void BindGrid(string metadataSearchCrieteria = &quot;&quot;)
        {
            try
            {
                int roleId = 0;

                if (ModuleManager.Instance.IsEffectivePermissionOfRoles())
                {
                    if (UserManager.Instance.IsUserAdministrator(UserDetail.GetCurrentUserDetail().UID))
                    {
                        roleId = Constants.USRMGMT_ADMIN_RID;
                    }
                    else
                    {
                        roleId = 0;
                    }
                }
                else
                {
                    roleId = UserDetail.GetCurrentUserDetail().RID;
                }

                lblerrormsg.Text = &quot;&quot;;

                docgrid.Bands.Clear();
                //List&lt;Document&gt; DocColl = DocumentManager.Instance.GetFolderDocuments(this.FolderID);

                object[] parameters = new object[9];//Nine live parameters are there
                if (Session[sessionSearchKey] is object[] &amp;&amp;
                    Convert.ToString((Session[sessionSearchKey] as object[])[0]) == ProjectID)
                {
                    object[] paraAll = Session[sessionSearchKey] as object[];

                    txtFileName.Text = Convert.ToString(paraAll[1]);
                    txtDesc.Text = Convert.ToString(paraAll[2]);
                    ddlCreatedBy.SelectedIndex = paraAll[3] != null ? Convert.ToInt32(paraAll[3]) : 0;

                    parameters[0] = paraAll[0];
                    parameters[1] = paraAll[1] == null ? null : paraAll[1];
                    parameters[2] = paraAll[2] == null ? null : paraAll[2];
                    parameters[3] = paraAll[3] == null ? null : paraAll[3];
                    parameters[4] = paraAll[4];
                    parameters[5] = paraAll[5];
                }
                else
                {
                    parameters[0] = ProjectID;
                    parameters[1] = string.IsNullOrEmpty(txtFileName.Text) ? null : txtFileName.Text;
                    parameters[2] = string.IsNullOrEmpty(txtDesc.Text) ? null : txtDesc.Text;
                    parameters[3] = ddlCreatedBy.SelectedIndex &lt;= 0 || ddlCreatedBy.SelectedValue == &quot;-1&quot; ? null : ddlCreatedBy.SelectedValue;
                    parameters[4] = roleId;
                    parameters[5] = UserDetail.GetCurrentUserDetail().UID;

                    Session[sessionSearchKey] = parameters;
                }

                List&lt;string&gt; projectComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_ESTMATE);
                //these params are similar to params used for GetAllDocumentFolders
                parameters[6] = !AMP3ApplicationSettings.Instance.IsSingleProjectMode; //, @IsFetch_ProjectDoc BIT = 0
                parameters[7] = projectComponents.Any(t =&gt; t == &quot;ShowEstimateDocuments&quot;);//, @IsFetch_EstimateDoc BIT = 0
                parameters[8] = 1;//always contract mode//, @IsFetch_ContractDoc BIT = 1

                DataTable dt = ComponentHelper.Instance.ExecuteDataSet(DocumentStoredProcedure.usp_DOCMGMTGetDocumentsByProjectID, null, parameters).Tables[0];

                if (dt.Rows.Count &gt; 0)
                {
                    string docIDs = dt.AsEnumerable()
                        .Select(row =&gt; row[&quot;DocID&quot;].ToString())
                        .Aggregate((s1, s2) =&gt; String.Join(&quot;,&quot;, s1, s2));

                    DataTable newDt;

                    DataSet ds = new DataSet();


                    BrixFormModel model = ProjectManager.Instance.GetProjectMetadataXMLModel(ProjectID.ToInt32_2());
                    Dictionary&lt;string, object&gt; colTypeNames = new Dictionary&lt;string, object&gt;();

                    if (model != null)
                    {
                        newDt = dt.Clone();

                        DataSet dsMD =
                            ComponentHelper.Instance.ExecuteDataSet(&quot;select * from &quot; + model.form.TableName +
                                                                    &quot; where DocId in (&quot; + docIDs + &quot;) &quot;);
                        //+ (string.IsNullOrEmpty(metadataSearchCrieteria) ? &quot;&quot; : &quot; and &quot; + metadataSearchCrieteria));

                        //DataSet dsMD = ComponentHelper.Instance.ExecuteDataSet(&quot;select * from &quot; + model.form.TableName + &quot; where 1=1&quot;);
                        if (dsMD.Tables.Count &gt; 0 &amp;&amp; dsMD.Tables[0] != null) //&amp;&amp; dsMD.Tables[0].Rows.Count &gt; 0)
                        {
                            DataTable dtMetadata = dsMD.Tables[0];
                            dt.TableName = &quot;Main&quot;;
                            dtMetadata.TableName = &quot;Properties&quot;;
                            //string mids = dtMetadata.AsEnumerable()
                            //        .Select(row =&gt; row[&quot;DocID&quot;].ToString())
                            //        .Aggregate((s1, s2) =&gt; String.Join(&quot;,&quot;, s1, s2));\


                            //ds.Tables.Add(dt.Select(&quot;DocId IN (&quot; + mids + &quot;)&quot;).CopyToDataTable());
                            ds.Tables.Add(dt.Copy());
                            ds.Tables.Add(dtMetadata.Copy());
                            ds.Relations.Add(&quot;RelMD&quot;, ds.Tables[0].Columns[&quot;DocId&quot;], ds.Tables[1].Columns[&quot;DocId&quot;]);
                        }
                        else
                        {
                            docgrid.Bands.Clear();
                        }

                        List&lt;string&gt; colNames = new List&lt;string&gt;();


                        if (dsMD.Tables.Count &gt; 0 &amp;&amp; dsMD.Tables[0] != null) //&amp;&amp; dsMD.Tables[0].Rows.Count &gt; 0)
                        {
                            foreach (DataColumn col in dsMD.Tables[0].Columns)
                            {
                                if (col.ColumnName != &quot;DocId&quot;)
                                {
                                    xControl ctrl = model.form.GetControl(col.ColumnName);

                                    if (ctrl == null)
                                        continue;

                                    DataColumn dc = new DataColumn(col.ColumnName, col.DataType);
                                    //NULL CHECK FOR THE CAPTION
                                    string newColumnName = !string.IsNullOrEmpty(ctrl.Caption) ? ctrl.ParseDynamicString(ctrl.Caption.Replace(&quot;:&quot;, &quot;&quot;)) : ctrl.Name;

                                    dc.ColumnName = newColumnName;
                                    //Temporary fix for Drop down list in Documents metadata - TODO: find  abetter way - Akila
                                    if (ctrl != null &amp;&amp;
                                        ctrl.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList)
                                    {
                                        metadataSearchCrieteria = metadataSearchCrieteria.Replace(&quot;[&quot; + ctrl.Name + &quot;]&quot;, &quot;[&quot; + dc.ColumnName + &quot;_ValueColumn&quot; + &quot;]&quot;);
                                        dc.DataType = typeof(string);
                                        DataColumn dcId = new DataColumn(dc.ColumnName + &quot;_ValueColumn&quot;, col.DataType);
                                        colNames.Add(dc.ColumnName + &quot;_ValueColumn&quot;);
                                        newDt.Columns.Add(dcId);
                                    }
                                    else
                                    {
                                        metadataSearchCrieteria = metadataSearchCrieteria.Replace(&quot;[&quot; + ctrl.Name + &quot;]&quot;, &quot;[&quot; + newColumnName + &quot;]&quot;);
                                        dc.DataType = col.DataType;
                                        if (ctrl.Type == ControlType.Date) colTypeNames.Add(ctrl.Name, ctrl.Type);
                                    }

                                    colNames.Add(dc.ColumnName);
                                    newDt.Columns.Add(dc);
                                }
                            }
                        }

                        newDt.AcceptChanges();


                        if (ds.Tables.Count &gt; 0 &amp;&amp; ds.Tables[0] != null &amp;&amp; ds.Tables[0].Rows.Count &gt; 0)
                        {
                            foreach (DataRow row in ds.Tables[0].Rows)
                            {
                                DataRow newR = newDt.Rows.Add();
                                foreach (DataColumn myColumn in ds.Tables[0].Columns)
                                    newR[myColumn.ColumnName] = row[myColumn.ColumnName];

                                //One document can have only one entry. Hence we are reading r[0] always.
                                DataRow[] r = row.GetChildRows(&quot;RelMD&quot;);

                                int cc = 0;
                                for (int i = 0; i &lt; ds.Tables[1].Columns.Count; i++)
                                {
                                    string colName = ds.Tables[1].Columns[i].ColumnName;
                                    if (ds.Tables[1].Columns[i].ColumnName != &quot;DocId&quot;)
                                    {
                                        xControl ctrl = model.form.GetControl(colName);
                                        if (ctrl == null)
                                            continue;

                                        //Temporary fix for Drop down list in Documents metadata - TODO: find  abetter way - Akila
                                        if (ctrl.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList)
                                        {
                                            if (r.Length &gt; 0)
                                            {
                                                DropDownList ddl = new DropDownList();
                                                HtmlRenderer.BindDropDown(ctrl, ddl);

                                                string colValue = (r[0][i] ?? &quot;&quot;).ToString();
                                                string colText = (r[0][i] ?? &quot;&quot;).ToString();

                                                foreach (ListItem li in ddl.Items)
                                                {
                                                    if (li.Value == colValue)
                                                    {
                                                        colValue = li.Value;
                                                        colText = li.Text;
                                                        break;
                                                    }
                                                }

                                                newR[colNames[cc++]] = colValue;
                                                newR[colNames[cc++]] = colText;
                                            }
                                            else
                                            {
                                                newR[colNames[cc++]] = &quot;0&quot;;
                                                newR[colNames[cc++]] = &quot;None&quot;;
                                            }
                                        }
                                        else
                                        {
                                            if (r.Length &gt; 0)
                                                newR[colNames[cc++]] = r[0][i];
                                            else
                                                newR[colNames[cc++]] = DBNull.Value;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                        newDt = dt;

                    if (metadataSearchCrieteria.Contains(&quot;&#39;_DBNULL_&#39;&quot;))
                    {
                        metadataSearchCrieteria = metadataSearchCrieteria.Replace(&quot;&#39;_DBNULL_&#39;&quot;, &quot;NULL&quot;);
                    }

                    //Filter the datatable
                    DataTable finalDt = new DataTable();
                    DataRow[] drs = newDt.Select(metadataSearchCrieteria);
                    if (drs.Length &gt; 0)
                    {
                        finalDt = newDt.Select(metadataSearchCrieteria).CopyToDataTable();
                    }

                    if (finalDt != null &amp;&amp; finalDt.Rows.Count &gt; 0)
                    {
                        docgrid.Visible = true;
                        docgrid.DataSource = finalDt.ToMWDateTime();
                        //BrixListPage.AddWorkflowColumns(&quot;DocId&quot;, &quot;XDOCMGT&quot;, ref finalDt);
                        docgrid.DataBind();
                        _formatColumn(colTypeNames);
                        SetGridColumns();
                    }
                }

                else
                {
                    if (MainToolBar.GetMenuReference(&quot;lnkView&quot;) != null)
                        MainToolBar.GetMenuReference(&quot;lnkView&quot;).Enabled = false;
                    if (MainToolBar.GetMenuReference(&quot;lnkDelete&quot;) != null)
                        MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).Enabled = false;
                }
            }
            catch (Exception ex)
            {
                lblerrormsg.Text = ex.Message;
            }
        }

        private void AddDocumentType(DataTable dtSoource, DataTable dtTarget)
        {
        }

        private void SetUIDetails()
        {
            if (MainToolBar.GetMenuReference(&quot;lnkView&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkView&quot;).Enabled = false;
            if (MainToolBar.GetMenuReference(&quot;lnkDelete&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).Enabled = false;
        }

        private void BindTable(DataTable dt)
        {
            docgrid.Visible = true;
            docgrid.DataSource = dt;
            BrixListPage.AddWorkflowColumns(&quot;DocId&quot;, &quot;XDOCMGT&quot;, ref dt);
            docgrid.DataBind();
            SetGridColumns();
        }
        private void _formatColumn(Dictionary&lt;string, object&gt; dateCols)
        {
            for (int i = 0; i &lt; dateCols.Count; i++)
            {
                switch (dateCols.ElementAt(i).Value.ToString2())
                {
                    case &quot;Date&quot;:
                        docgrid.Columns.FromKey(dateCols.ElementAt(i).Key).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
                        break;
                    default:
                        break;
                }
            }
        }

        private void SetGridColumns()
        {
            try
            {
                docgrid.DisplayLayout.FrameStyle.Height = Unit.Percentage(100);
                docgrid.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
                docgrid.DisplayLayout.RowStyleDefault.Wrap = true;
                docgrid.DisplayLayout.RowSizingDefault = AllowSizing.Free;
                docgrid.DisplayLayout.AllowColSizingDefault = AllowSizing.Fixed;

                if (docgrid.Columns.Exists(&quot;DocName&quot;))
                {
                    docgrid.Columns.FromKey(&quot;DocName&quot;).Header.Caption = &quot;Document Name&quot;;
                    docgrid.Columns.FromKey(&quot;DocName&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;DocDesc&quot;))
                {
                    docgrid.Columns.FromKey(&quot;DocDesc&quot;).Header.Caption = &quot;Title&quot;;
                    docgrid.Columns.FromKey(&quot;DocDesc&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;DocType&quot;))
                {
                    docgrid.Columns.FromKey(&quot;DocType&quot;).Header.Caption = &quot;Type&quot;;
                    docgrid.Columns.FromKey(&quot;DocType&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;DocSize&quot;))
                    docgrid.Columns.FromKey(&quot;DocSize&quot;).Header.Caption = &quot;Size&quot;;
                if (docgrid.Columns.Exists(&quot;AuthorName&quot;))
                {
                    docgrid.Columns.FromKey(&quot;AuthorName&quot;).Header.Caption = &quot;Created By&quot;;
                    docgrid.Columns.FromKey(&quot;AuthorName&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;CreationDate&quot;))
                    docgrid.Columns.FromKey(&quot;CreationDate&quot;).Header.Caption = &quot;Created Date&quot;;
                if (docgrid.Columns.Exists(&quot;CreationDate&quot;))
                    docgrid.Columns.FromKey(&quot;CreationDate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
                if (docgrid.Columns.Exists(&quot;DocId&quot;))
                    docgrid.Columns.FromKey(&quot;DocId&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;StorageId&quot;))
                    docgrid.Columns.FromKey(&quot;StorageId&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;DocStatus&quot;))
                {
                    docgrid.Columns.FromKey(&quot;DocStatus&quot;).Hidden = true;
                    docgrid.Columns.FromKey(&quot;DocStatus&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;ParentId&quot;))
                    docgrid.Columns.FromKey(&quot;ParentId&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;Author&quot;))
                {
                    docgrid.Columns.FromKey(&quot;Author&quot;).Hidden = true;
                    docgrid.Columns.FromKey(&quot;Author&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;CheckedBy&quot;))
                {
                    docgrid.Columns.FromKey(&quot;CheckedBy&quot;).Hidden = true;
                    docgrid.Columns.FromKey(&quot;CheckedBy&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;FolderId&quot;))
                    docgrid.Columns.FromKey(&quot;FolderId&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;LinkID&quot;))
                    docgrid.Columns.FromKey(&quot;LinkID&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;TypeId&quot;))
                    docgrid.Columns.FromKey(&quot;TypeId&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;SrcModuleID&quot;))
                    docgrid.Columns.FromKey(&quot;SrcModuleID&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;WorkflowInstanceGuid&quot;))
                    docgrid.Columns.FromKey(&quot;WorkflowInstanceGuid&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;WF_FileID&quot;))
                    docgrid.Columns.FromKey(&quot;WF_FileID&quot;).Hidden = true;

                if (docgrid.Columns.Exists(&quot;WF_Status&quot;))
                {
                    docgrid.Columns.FromKey(&quot;WF_Status&quot;).Hidden = true;
                    docgrid.Columns.FromKey(&quot;WF_Status&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;WF_PendingOnRole&quot;))
                    docgrid.Columns.FromKey(&quot;WF_PendingOnRole&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;Buttons&quot;))
                    docgrid.Columns.FromKey(&quot;Buttons&quot;).Hidden = true;
                //if (DocumentManager.Instance.IsSharePoint)
                //{
                if (docgrid.Columns.Exists(&quot;CheckedByName&quot;))
                {
                    docgrid.Columns.FromKey(&quot;CheckedByName&quot;).Header.Caption = &quot;Checked Out To&quot;;
                    docgrid.Columns.FromKey(&quot;CheckedByName&quot;).HTMLEncodeContent = true;
                }
                if (docgrid.Columns.Exists(&quot;VersionNo&quot;))
                    docgrid.Columns.FromKey(&quot;VersionNo&quot;).Header.Caption = &quot;Version&quot;;
                if (docgrid.Columns.Exists(&quot;XMLInfo&quot;))
                    docgrid.Columns.FromKey(&quot;XMLInfo&quot;).Hidden = true;
                if (docgrid.Columns.Exists(&quot;PID&quot;))
                    docgrid.Columns.FromKey(&quot;PID&quot;).Hidden = true;
                //}
                //else
                //{
                //    if (docgrid.Columns.Exists(&quot;CheckedByName&quot;))
                //        docgrid.Columns.FromKey(&quot;CheckedByName&quot;).Hidden = true;
                //    if (docgrid.Columns.Exists(&quot;VersionNo&quot;))
                //        docgrid.Columns.FromKey(&quot;VersionNo&quot;).Hidden = true;
                //    if (docgrid.Columns.Exists(&quot;XMLInfo&quot;))
                //        docgrid.Columns.FromKey(&quot;XMLInfo&quot;).Hidden = true;
                //}
                foreach (UltraGridColumn col in docgrid.Columns)
                {
                    if (col.Header.Caption.Contains(&quot;_ValueColumn&quot;))
                        col.Hidden = true;
                }
            }
            catch (Exception ex)
            {
                throw new Exception(&quot;Documents Page Bind Grid &quot; + ex, ex);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[32,17,32,18,0],[32,19,32,41,0],[32,42,32,43,0],[35,9,35,51,0],[38,9,38,10,0],[39,13,39,44,0],[40,13,40,34,0],[41,13,41,66,0],[43,13,43,64,0],[44,13,44,63,0],[45,13,45,92,0],[46,13,46,86,0],[47,13,47,92,0],[49,13,49,46,0],[50,17,50,46,0],[52,13,52,49,0],[54,13,54,38,0],[56,13,56,28,0],[57,9,57,10,0],[60,9,60,10,0],[61,13,61,95,0],[62,13,62,31,0],[63,13,63,14,0],[64,17,66,21,0],[66,21,66,22,0],[66,22,67,25,0],[67,25,67,65,0],[67,65,68,25,0],[68,25,68,26,0],[68,26,69,29,0],[69,29,69,76,0],[69,76,70,25,0],[70,25,70,26,0],[70,26,71,25,0],[71,25,71,91,0],[71,91,72,25,0],[72,25,72,26,0],[72,26,73,29,0],[73,29,73,49,0],[73,49,74,25,0],[74,25,74,26,0],[74,26,75,25,0],[75,25,75,66,0],[75,66,76,25,0],[76,25,76,26,0],[76,26,77,29,0],[77,29,77,59,0],[77,59,78,25,0],[78,25,78,26,0],[78,26,79,21,0],[79,21,79,22,0],[79,22,79,24,0],[64,17,79,24,0],[80,17,80,94,0],[81,17,81,37,0],[82,17,82,56,0],[83,13,83,14,0],[84,9,84,10,0],[117,9,117,10,0],[118,13,118,65,0],[119,13,119,14,0],[120,17,120,98,0],[121,17,121,98,0],[122,13,122,14,0],[124,13,124,67,0],[125,17,125,98,0],[127,13,127,66,0],[128,17,128,98,0],[129,9,129,10,0],[132,9,132,10,0],[133,13,133,62,0],[134,13,134,14,0],[135,17,135,78,0],[136,17,136,37,0],[137,17,137,18,0],[138,21,138,66,0],[139,21,139,28,0],[141,17,141,78,0],[142,17,142,86,0],[143,17,143,89,0],[145,17,146,108,0],[147,17,147,18,0],[148,21,150,82,0],[151,17,151,18,0],[152,22,153,109,0],[154,17,154,18,0],[155,21,155,89,0],[156,21,156,99,0],[158,21,158,87,0],[159,21,159,22,0],[160,25,162,189,0],[164,25,164,46,0],[165,25,168,131,0],[169,21,169,22,0],[171,21,171,22,0],[172,25,172,86,0],[173,21,173,22,0],[174,17,174,18,0],[176,17,176,18,0],[177,21,177,82,0],[178,17,178,18,0],[179,13,179,14,0],[181,13,181,14,0],[182,17,182,62,0],[183,17,183,24,0],[185,9,185,10,0],[188,9,188,10,0],[189,13,189,54,0],[190,13,190,31,0],[191,13,191,14,0],[192,17,194,21,0],[194,21,194,22,0],[194,22,195,25,0],[195,25,195,48,0],[195,48,196,25,0],[196,25,196,60,0],[196,60,197,25,0],[197,25,197,57,0],[197,57,198,25,0],[198,25,198,26,0],[198,26,199,29,0],[199,29,199,48,0],[199,48,201,29,0],[201,29,201,66,0],[201,66,202,29,0],[202,29,202,30,0],[202,30,203,33,0],[203,33,203,73,0],[203,73,204,33,0],[204,33,204,123,0],[204,123,205,33,0],[205,33,205,104,0],[205,104,206,33,0],[206,33,206,116,0],[206,116,207,29,0],[207,29,207,30,0],[207,30,208,25,0],[208,25,208,26,0],[208,26,210,25,0],[210,25,210,82,0],[210,82,211,25,0],[211,25,211,26,0],[211,26,212,29,0],[212,29,212,48,0],[212,48,213,25,0],[213,25,213,26,0],[213,26,214,30,0],[214,30,214,86,0],[214,86,215,25,0],[215,25,215,26,0],[215,26,216,29,0],[216,29,216,48,0],[216,48,217,29,0],[217,29,217,83,0],[217,83,218,25,0],[218,25,218,26,0],[218,26,219,30,0],[219,30,219,80,0],[219,80,220,25,0],[220,25,220,26,0],[220,26,221,29,0],[221,29,221,48,0],[221,48,222,25,0],[222,25,222,26,0],[222,26,223,30,0],[223,30,223,100,0],[223,100,224,25,0],[224,25,224,26,0],[224,26,225,29,0],[225,29,225,48,0],[225,48,226,29,0],[226,29,226,53,0],[226,53,227,33,0],[227,33,227,89,0],[227,89,228,25,0],[228,25,228,26,0],[228,26,230,30,0],[230,30,230,65,0],[230,65,231,25,0],[231,25,231,26,0],[231,26,232,29,0],[232,29,232,48,0],[232,48,233,29,0],[233,29,233,53,0],[233,53,234,33,0],[234,33,234,116,0],[234,116,235,25,0],[235,25,235,26,0],[235,26,238,25,0],[238,25,238,72,0],[238,72,239,25,0],[239,25,239,26,0],[239,26,240,29,0],[240,29,240,111,0],[240,111,241,33,0],[241,33,241,108,0],[241,108,242,34,0],[242,34,242,69,0],[242,69,243,33,0],[243,33,243,130,0],[243,130,244,34,0],[244,34,244,90,0],[244,90,245,33,0],[245,33,245,89,0],[245,89,247,33,0],[247,33,247,113,0],[247,113,248,25,0],[248,25,248,26,0],[248,26,249,21,0],[249,21,249,22,0],[249,22,249,24,0],[192,17,249,24,0],[250,13,250,14,0],[254,13,254,46,0],[255,13,255,114,0],[256,9,256,10,0],[259,9,259,10,0],[260,13,260,35,0],[261,13,261,46,0],[262,13,262,24,0],[263,9,263,10,0],[266,9,266,10,0],[267,13,267,29,0],[268,13,268,14,0],[269,17,269,105,0],[270,17,270,41,0],[271,17,271,18,0],[272,21,272,89,0],[273,21,273,50,0],[275,21,275,28,0],[275,30,275,41,0],[275,42,275,44,0],[275,45,275,62,0],[276,21,276,22,0],[277,25,277,63,0],[278,25,278,121,0],[279,25,279,53,0],[280,29,280,49,0],[281,21,281,22,0],[283,21,283,53,0],[284,21,284,58,0],[285,21,285,57,0],[286,21,286,45,0],[287,17,287,18,0],[291,17,291,28,0],[292,13,292,14,0],[293,9,293,10,0],[296,9,296,10,0],[298,13,298,14,0],[299,17,299,32,0],[301,17,301,75,0],[302,17,302,18,0],[303,21,303,105,0],[304,21,304,22,0],[305,25,305,62,0],[306,21,306,22,0],[308,21,308,22,0],[309,25,309,36,0],[310,21,310,22,0],[311,17,311,18,0],[313,17,313,18,0],[314,21,314,68,0],[315,17,315,18,0],[317,17,317,39,0],[319,17,319,39,0],[322,17,322,53,0],[323,17,324,95,0],[325,17,325,18,0],[326,21,326,78,0],[328,21,328,69,0],[329,21,329,65,0],[330,21,330,103,0],[332,21,332,48,0],[333,21,333,76,0],[334,21,334,76,0],[335,21,335,76,0],[336,21,336,48,0],[337,21,337,48,0],[338,17,338,18,0],[340,17,340,18,0],[341,21,341,47,0],[342,21,342,102,0],[343,21,343,94,0],[344,21,344,143,0],[345,21,345,44,0],[346,21,346,75,0],[348,21,348,60,0],[349,17,349,18,0],[351,17,351,119,0],[353,17,353,87,0],[354,17,354,60,0],[354,60,354,88,0],[354,88,354,90,0],[354,17,354,90,0],[355,17,355,35,0],[357,17,357,160,0],[359,17,359,39,0],[360,17,360,18,0],[361,21,362,40,0],[362,40,362,63,0],[362,63,363,48,0],[363,48,363,72,0],[363,72,363,74,0],[361,21,363,74,0],[367,21,367,48,0],[370,21,370,117,0],[371,21,371,96,0],[373,21,373,39,0],[374,21,374,22,0],[375,25,375,44,0],[377,25,379,106,0],[383,25,383,77,0],[384,25,384,26,0],[385,29,385,67,0],[386,29,386,51,0],[387,29,387,65,0],[394,29,394,54,0],[395,29,395,62,0],[396,29,396,117,0],[397,25,397,26,0],[399,25,399,26,0],[400,29,400,51,0],[401,25,401,26,0],[403,25,403,68,0],[406,25,406,77,0],[407,25,407,26,0],[408,29,408,36,0],[408,38,408,52,0],[408,53,408,55,0],[408,56,408,78,0],[409,29,409,30,0],[410,33,410,63,0],[411,33,411,34,0],[412,37,412,91,0],[414,37,414,54,0],[415,41,415,50,0],[417,37,417,98,0],[419,37,419,165,0],[421,37,421,67,0],[423,37,424,115,0],[425,37,425,38,0],[426,41,426,166,0],[427,41,427,70,0],[428,41,428,120,0],[429,41,429,86,0],[430,41,430,65,0],[431,37,431,38,0],[433,37,433,38,0],[434,41,434,149,0],[435,41,435,68,0],[436,41,436,75,0],[436,76,436,115,0],[437,37,437,38,0],[439,37,439,65,0],[440,37,440,59,0],[441,33,441,34,0],[442,29,442,30,0],[443,25,443,26,0],[445,25,445,47,0],[448,25,448,104,0],[449,25,449,26,0],[450,29,450,36,0],[450,38,450,49,0],[450,50,450,52,0],[450,53,450,70,0],[451,29,451,30,0],[452,33,452,65,0],[453,33,453,40,0],[453,42,453,61,0],[453,62,453,64,0],[453,65,453,85,0],[454,37,454,90,0],[457,33,457,73,0],[459,33,459,44,0],[460,38,460,47,0],[460,49,460,79,0],[460,81,460,84,0],[461,33,461,34,0],[462,37,462,89,0],[463,37,463,87,0],[464,37,464,38,0],[465,41,465,88,0],[466,41,466,58,0],[467,45,467,54,0],[470,41,470,119,0],[471,41,471,42,0],[472,45,472,62,0],[473,45,473,46,0],[474,49,474,87,0],[475,49,475,86,0],[477,49,477,94,0],[478,49,478,93,0],[480,49,480,56,0],[480,58,480,69,0],[480,70,480,72,0],[480,73,480,82,0],[481,49,481,50,0],[482,53,482,78,0],[483,53,483,54,0],[484,57,484,77,0],[485,57,485,75,0],[486,57,486,63,0],[488,49,488,50,0],[490,49,490,81,0],[491,49,491,80,0],[492,45,492,46,0],[494,45,494,46,0],[495,49,495,76,0],[496,49,496,79,0],[497,45,497,46,0],[498,41,498,42,0],[500,41,500,42,0],[501,45,501,62,0],[502,49,502,80,0],[504,49,504,85,0],[505,41,505,42,0],[506,37,506,38,0],[507,33,507,34,0],[508,29,508,30,0],[509,25,509,26,0],[510,21,510,22,0],[512,25,512,36,0],[514,21,514,72,0],[515,21,515,22,0],[516,25,516,105,0],[517,21,517,22,0],[520,21,520,57,0],[521,21,521,75,0],[522,21,522,40,0],[523,21,523,22,0],[524,25,524,91,0],[525,21,525,22,0],[527,21,527,67,0],[528,21,528,22,0],[529,25,529,48,0],[530,25,530,69,0],[532,25,532,44,0],[533,25,533,53,0],[534,25,534,42,0],[535,21,535,22,0],[536,17,536,18,0],[539,17,539,18,0],[540,21,540,73,0],[541,25,541,81,0],[542,21,542,75,0],[543,25,543,83,0],[544,17,544,18,0],[545,13,545,14,0],[546,13,546,33,0],[547,13,547,14,0],[548,17,548,47,0],[549,13,549,14,0],[550,9,550,10,0],[553,9,553,10,0],[554,9,554,10,0],[557,9,557,10,0],[558,13,558,65,0],[559,17,559,73,0],[560,13,560,67,0],[561,17,561,75,0],[562,9,562,10,0],[565,9,565,10,0],[566,13,566,36,0],[567,13,567,37,0],[568,13,568,73,0],[569,13,569,32,0],[570,13,570,30,0],[571,9,571,10,0],[573,9,573,10,0],[574,18,574,27,0],[574,29,574,47,0],[574,49,574,52,0],[575,13,575,14,0],[576,17,576,65,0],[579,25,579,130,0],[580,25,580,31,0],[582,25,582,31,0],[584,13,584,14,0],[585,9,585,10,0],[588,9,588,10,0],[590,13,590,14,0],[591,17,591,80,0],[592,17,592,85,0],[593,17,593,67,0],[594,17,594,75,0],[595,17,595,81,0],[597,17,597,55,0],[598,17,598,18,0],[599,21,599,89,0],[600,21,600,81,0],[601,17,601,18,0],[602,17,602,55,0],[603,17,603,18,0],[604,21,604,81,0],[605,21,605,81,0],[606,17,606,18,0],[607,17,607,55,0],[608,17,608,18,0],[609,21,609,80,0],[610,21,610,81,0],[611,17,611,18,0],[612,17,612,55,0],[613,21,613,80,0],[614,17,614,58,0],[615,17,615,18,0],[616,21,616,89,0],[617,21,617,84,0],[618,17,618,18,0],[619,17,619,60,0],[620,21,620,93,0],[621,17,621,60,0],[622,21,622,115,0],[623,17,623,53,0],[624,21,624,68,0],[625,17,625,57,0],[626,21,626,72,0],[627,17,627,57,0],[628,17,628,18,0],[629,21,629,72,0],[630,21,630,83,0],[631,17,631,18,0],[632,17,632,56,0],[633,21,633,71,0],[634,17,634,54,0],[635,17,635,18,0],[636,21,636,69,0],[637,21,637,80,0],[638,17,638,18,0],[639,17,639,57,0],[640,17,640,18,0],[641,21,641,72,0],[642,21,642,83,0],[643,17,643,18,0],[644,17,644,56,0],[645,21,645,71,0],[646,17,646,54,0],[647,21,647,69,0],[648,17,648,54,0],[649,21,649,69,0],[650,17,650,59,0],[651,21,651,74,0],[652,17,652,68,0],[653,21,653,83,0],[654,17,654,57,0],[655,21,655,72,0],[657,17,657,57,0],[658,17,658,18,0],[659,21,659,72,0],[660,21,660,83,0],[661,17,661,18,0],[662,17,662,64,0],[663,21,663,79,0],[664,17,664,55,0],[665,21,665,70,0],[668,17,668,61,0],[669,17,669,18,0],[670,21,670,96,0],[671,21,671,87,0],[672,17,672,18,0],[673,17,673,57,0],[674,21,674,85,0],[675,17,675,55,0],[676,21,676,70,0],[677,17,677,51,0],[678,21,678,66,0],[689,17,689,24,0],[689,26,689,45,0],[689,46,689,48,0],[689,49,689,64,0],[690,17,690,18,0],[691,21,691,69,0],[692,25,692,43,0],[693,17,693,18,0],[694,13,694,14,0],[695,13,695,33,0],[696,13,696,14,0],[697,17,697,75,0],[699,9,699,10,0]]);
    </script>
  </body>
</html>