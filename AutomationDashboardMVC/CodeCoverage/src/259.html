<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Quantity Planning\ConcreateModels\QuantityPlanningListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.UI;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI.BL;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.Documents.Excel;
using Infragistics.WebUI.UltraWebGrid;
using Infragistics.WebUI.UltraWebGrid.ExcelExport;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Telerik.Web.UI;
using Aurigo.Common.Utility;

namespace Aurigo.Brix.Construction.ContractManager.QuantityPlanningUI
{
    [ListModelContext(Name = &quot;QTYPLAN&quot;, Table = &quot;QTYPLANListView&quot;)]
    [ContextElement(Name = &quot;Quantity Planning List&quot;)]
    public class QuantityPlanningListModel : ListModel, IWorkflowEnabledList
    {
        private const string sessionVarErrorLogDS = &quot;QTYERRLOG&quot;;
        private string ParentModuleID;
        private List&lt;string&gt; _permissions = null;
        private List&lt;string&gt; permissions
        {
            get
            {
                if (_permissions == null)
                    _permissions = ModuleManager.Instance.GetPermissionByUserOrRole(Constants.MODID_QTYPLAN, UserDetail.GetCurrentUserDetail().UID,
                                                                                  UserDetail.GetCurrentUserDetail().RID, Request.QueryString[&quot;PID&quot;].ToInt32_2());
                return _permissions;
            }
        }

        public override int GetProjectIdFromInstanceId()
        {
            if (Request.QueryString[&quot;context&quot;] != null &amp;&amp; Request.QueryString[&quot;context&quot;] == &quot;QTYPLAN&quot; &amp;&amp; string.IsNullOrEmpty(Request.QueryString[&quot;ParentModuleId&quot;]))
                return Aurigo.AMP3.ContractManager.BusinessLayer.BL.Instance.GetProjectIdOfContract(Request[&quot;ContractID&quot;].ToInt32_2());
            else
                return base.GetProjectIdFromInstanceId();
        }

        public override void OnInit()
        {
            DataTable dt;

            if (Request.QueryString[&quot;ParentModuleId&quot;] != null &amp;&amp; !string.IsNullOrEmpty(Request.QueryString[&quot;ParentModuleId&quot;]))
                ParentModuleID = Request.QueryString[&quot;ParentModuleId&quot;].ToString();

            else if (Request.QueryString[&quot;context&quot;] != null &amp;&amp; Request.QueryString[&quot;context&quot;] == &quot;QTYPLAN&quot;)
                ParentModuleID = &quot;CONTMGT&quot;;

            else
            {
                dt = ComponentHelper.Instance.ExecuteDataSet(QuantityPlanningStoredProcedure.usp_getModuleIDFORITEM, null, Request[&quot;ContractID&quot;]).Tables[0];

                if (dt.Rows.Count &gt; 0)
                {
                    ParentModuleID = dt.Rows[0][&quot;ModuleID&quot;].ToString();
                }
            }

            base.OnInit();
        }

        private int contractID;
        private bool isContractLocked;

        public override string ModuleId
        {
            get { return Constants.MODID_QTYPLAN; }
        }

        public override string[] DataSourceFilters
        {
            get { return new[] { &quot;ContractID&quot; }; }
        }

        public override string QueryStringName
        {
            get { return &quot;QPID&quot;; }
        }

        public override MenuArray Menus
        {
            get
            {
                //DisplayNew = false;
                MenuArray m = base.Menus;
                var newMenu = new BrixMenu(&quot;lnkAddNew&quot;, &quot;New&quot;, &quot;Icn_New.png&quot;, 55, 200);


                newMenu.subMenus.Add(new BrixMenu(&quot;lnkNew&quot;, &quot;New&quot;, &quot;Icn_New_16.png&quot;));
                newMenu.subMenus.Add(new BrixMenu(&quot;lnkCopyPlanning&quot;, &quot;Copy from Existing&quot;, &quot;Icn_Addexistingrecord_16.png&quot;));
                m.Insert(0, newMenu);

                return m;
            }
        }

        public override string ParentIDKey
        {
            get { return &quot;ContractID&quot;; }
        }

        public override string DocumentUrl
        {
            get
            {
                return string.Format(&quot;~/Modules/DOCMGMT/DocumentView.aspx?PID={0}&amp;parent={1}&amp;context=CONTMGT&amp;module=QTYPLAN&quot;, Request[&quot;PID&quot;], Request[&quot;ContractID&quot;]);
            }
        }

        #region IWorkflowEnabledList Members

        public string FormName
        {
            get { return &quot;XQTYPLN&quot;; }
        }

        public string ListPrimaryKey
        {
            get { return &quot;QPID&quot;; }
        }

        public int PID
        {
            get { return Request[&quot;PID&quot;].ToInt32_2(); }
        }

        public int ParentModuleId
        {
            get { return Request[&quot;ContractID&quot;].ToInt32_2(); }
        }

        #endregion

        public override List&lt;MenuGroup&gt; MenuGroups
        {
            get
            {
                List&lt;string&gt; components = ModuleManager.Instance.GetModuleComponenets(&quot;QTYPLAN&quot;);

                DisplayNew = false;
                List&lt;MenuGroup&gt; menuGroups = base.MenuGroups;
                MenuGroup otherGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_OTHERS);
                if (otherGroup == null)
                {
                    otherGroup = new MenuGroup(GROUP_OTHERS);
                    menuGroups.Add(otherGroup);
                }
                if (displayErrorLog)
                {

                    otherGroup.AddMenu(new LargeButton(&quot;lnkViewLog&quot;, &quot;Error Log&quot;, &quot;Icn_tables.png&quot;));
                }

                if (displaySettings &amp;&amp; components.Contains(&quot;ShowSettings&quot;) &amp;&amp; ParentModuleID != &quot;BDGTEST&quot;)
                    otherGroup.AddMenu(new TextIcon(&quot;lnkSettings&quot;, &quot;Settings&quot;, &quot;Icn_Settings_16.png&quot;));


                MenuGroup generalGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_GENERAL);
                if (generalGroup == null)
                {
                    generalGroup = new MenuGroup(GROUP_GENERAL);
                    menuGroups.Add(generalGroup);
                }
                LargeButton newButton = (LargeButton)generalGroup.Menus.Find(m =&gt; m.ID == MENU_NEW_ID);
                if (newButton != null)
                {
                    generalGroup.Menus.Remove(newButton);
                }

                MenuButton newQPButton = new MenuButton(MENU_NEW_ID, MENU_NEW, &quot;Icn_New.png&quot;);
                newQPButton.AddSubMenu(new TextIcon(&quot;lnkAddNew&quot;, &quot;New&quot;, &quot;Icn_New_16.png&quot;));
                newQPButton.AddSubMenu(new TextIcon(&quot;lnkCopyPlanning&quot;, &quot;Copy from Existing&quot;, &quot;Icn_Addexistingrecord_16.png&quot;));
                generalGroup.AddMenu(newQPButton, 0);

                if (CoreModuleComponents.Contains(&quot;Forecast&quot;) &amp;&amp; ParentModuleID != &quot;BDGTEST&quot;)
                {
                    LargeButton forecastMenu = new LargeButton(&quot;lnkForecast&quot;, &quot;Forecast&quot;, &quot;Icn_Forecast_32.png&quot;);
                    generalGroup.AddMenu(forecastMenu);
                }

                if (ParentModuleID == &quot;BDGTEST&quot; &amp;&amp; !string.IsNullOrWhiteSpace(Request.QueryString[&quot;ReturnURL&quot;]))
                {
                    LargeButton BackMenu = new LargeButton(&quot;lnkBack&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;);
                    generalGroup.AddMenu(BackMenu);
                }

                return menuGroups;
            }
        }

        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int CurrentPage,
                                      out int count)
        {
            sortOrder = DefaultSortColumn + &quot; DESC&quot;;
            count = 0;
            var attribs = (ListModelContextAttribute[])
                         GetType().GetCustomAttributes(typeof(ListModelContextAttribute), true);
            DataSet dsReturn = null;
            if (attribs.Length &gt; 0)
            {
                var dicDataSourceFilter = new Dictionary&lt;string, string&gt;();
                if (DataSourceFilters != null)
                {
                    foreach (string key in DataSourceFilters)
                    {
                        dicDataSourceFilter.Add(key, string.IsNullOrEmpty(Request[key]) ? &quot;0&quot; : Request[key]);
                    }
                }

                if(!string.IsNullOrEmpty(ParentModuleID))
                    dicDataSourceFilter.Add(&quot;ModuleID&quot;, ParentModuleID);

                dsReturn = CoreDatabaseHelper.GetODSData(attribs[0].Table, pageSize, sortOrder, filter, filter.Trim().StartsWith(&quot;&lt;&quot;),
                                                        ref CurrentPage, out count, dicDataSourceFilter, null, null,
                                                        null, false, FormName, ListPrimaryKey, null, (Request[&quot;PID&quot;] ?? &quot;0&quot;).ToInt32_2(),
                                                        filterOrSortHasPendingOnUser: FilterOrSortHasPendingOnUser);
            }

            return dsReturn;

        }

        public override void SetUIDetails()
        {
            header = &quot;&quot; + LocalizationManager.GetString(&quot;LOC_QuantityPlanning&quot;) + &quot; List&quot;;

            #region Hidden Columns
            ModifyColumnProperties(&quot;QPID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ContractID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Multi&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ProjectID&quot;, true, null, null, null, false);
            //ModifyColumnProperties(&quot;QPDescription&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RefCostVersionID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RefQPID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;IsLatestApproved&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Status&quot;, true, null, null, null, false);
            #endregion

            #region Visible Columns

            ModifyColumnProperties(&quot;LineNo&quot;, false, 1, null, &quot;75&quot;, false, &quot;Forecast ID&quot;);
            ModifyColumnProperties(&quot;QPDescription&quot;, false, 2, null, &quot;300&quot;, false, &quot;Forecast Description&quot;);
            ModifyColumnProperties(&quot;StartDate&quot;, false, 3, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;Start Date&quot;, true);
            ModifyColumnProperties(&quot;EndDate&quot;, false, 4, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;End Date&quot;, true);
            ModifyColumnProperties(&quot;CreatedOn&quot;, false, 5, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;Created On&quot;,true);
            ModifyColumnProperties(&quot;CreatedBy&quot;, false, 6, null, null, false, &quot;Created By&quot;);
            ModifyColumnProperties(&quot;ApprovalVersion&quot;, false, 7, null, &quot;200&quot;, false, &quot;Sequence No.&quot;);
            ModifyColumnProperties(&quot;ApprovedOn&quot;, false, 8, AMP3ApplicationSettings.Instance.FORMAT_DATE, null, false, &quot;Approved On&quot;, true);
            ModifyColumnProperties(&quot;ApprovedBy&quot;, false, 9, null, null, false, &quot;Approved By&quot;);

            #endregion

            if (Request != null)
            {
                if (!String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                    Int32.TryParse(Request[&quot;ContractID&quot;], out contractID);


                EnableGridDblClick = displayApplyFilter = true;
                displaySettings = EnableNew;
            }

            #region Setting Error Log Button Visibility

            if (HttpContext.Current != null &amp;&amp; HttpContext.Current.Handler != null &amp;&amp; HttpContext.Current.Handler.GetType() == typeof(Page))
            {
                var currPage = (Page)HttpContext.Current.Handler;
                //Store the Error DataSet in Session
                if (currPage.Session[sessionVarErrorLogDS] != null)
                    displayErrorLog = true;
                else
                    displayErrorLog = false;
            }

            #endregion

            instanceIDColumn = &quot;QPID&quot;;
            createDateColumn = &quot;CreatedOn&quot;;

            displayDocuments = true;
            displayReport = true;
            ShowListPageReport = false;
        }

        List&lt;string&gt; _CoreModuleComponents = null;
        private List&lt;string&gt; CoreModuleComponents
        {
            get
            {
                if (_CoreModuleComponents == null)
                    _CoreModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
                return _CoreModuleComponents;
            }
        }

        public override void ApplyToolBarCustomisation(ToolBar toolBarArg)
        {
            bool hasNonApprovedRecord = true;
            base.ApplyToolBarCustomisation(toolBarArg);
            if (mwGrid.DataSource != null)
            {
                foreach (var row in MWGrid.GetRows(mwGrid))
                {
                    if (MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Draft&quot;) ||
                        MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Complete&quot;) ||
                        MWGrid.GetCellValue(row, &quot;Status&quot;).Equals(&quot;Submitted&quot;))
                    {
                        hasNonApprovedRecord = false;
                        break;
                    }
                }
            }

            if (mwGrid.DataSource != null &amp;&amp; MWGrid.GetRows(mwGrid).Count &gt; 0)
                toolBarArg.EnableMenu(&quot;lnkCopyPlanning&quot;);
            else
                toolBarArg.DisableMenu(&quot;lnkCopyPlanning&quot;);

            bool showForecastBeforeLock = CoreModuleComponents.Contains(&quot;ForecastBeforeLock&quot;);

            if (ParentModuleID == Constants.MODID_CONTMGT)
                isContractLocked = AMP3.ContractManager.BusinessLayer.BL.Instance.GetLockStatus(contractID);

            //for the forecast button to be visible the contract shd be locked or the before lock component shd be active
            if (!(isContractLocked || (!isContractLocked &amp;&amp; showForecastBeforeLock)) || ParentModuleID == &quot;BDGTEST&quot;)
                toolBarArg.DisableMenu(&quot;lnkForecast&quot;);

            EnableEdit = EnableDelete = (isContractLocked || (!isContractLocked &amp;&amp; showForecastBeforeLock));
            if ((!(isContractLocked || (!isContractLocked &amp;&amp; showForecastBeforeLock)) || !hasNonApprovedRecord) &amp;&amp; ParentModuleID != &quot;BDGTEST&quot;)
            {

                toolBarArg.DisableMenu(&quot;lnkAddNew&quot;);
                toolBarArg.DisableMenu(&quot;lnkNew&quot;);
                toolBarArg.DisableMenu(&quot;lnkCopyPlanning&quot;);

            }
            else
            {
                toolBarArg.EnableMenu(&quot;lnkAddNew&quot;);
                toolBarArg.EnableMenu(&quot;lnkNew&quot;);
                toolBarArg.EnableMenu(&quot;lnkCopyPlanning&quot;);
            }

            //if (toolBarArg.GetMenuReference(&quot;lnkForecast&quot;) != null)
            //{
            //    toolBarArg.GetMenuReference(&quot;lnkForecast&quot;).Click += new EventHandler(lnkForecast_Click);
            //}

            //permissions = ModuleManager.Instance.GetPermissionByRole(Constants.MODID_QTYPLAN,
            //                                                                                   UserDetail.
            //                                                                                       GetCurrentUserDetail()
            //                                                                                       .RID);
            // If permission is View, then only the Approval History can be enabled
            if (!permissions.Contains(&quot;View&quot;))
                toolBarArg.GetMenuReference(&quot;lnkWorkFlow&quot;).Enabled = false;
        }

        void lnkForecast_Click(object sender, EventArgs e)
        {
            string msg = string.Empty;
            //Create Schedule
            //ScheduleUpdationModel model = ScheduleUpdationModel.GetInstance(&quot;CONTMGT&quot;);
            //if (model != null)
            //    model.CreateForecast(Request[&quot;ContractID&quot;].ToInt32_2(), Request[Constants.QRY_PROJECTID].ToInt32_2(), UserDetail.GetCurrentUserDetail().UID);
            ScheduleUpdationModel model = ScheduleUpdationModel.GetInstance(&quot;QTYPLAN&quot;);
            if (model != null)
            {

                if (model.CreateForecast(Request[&quot;ContractID&quot;].ToInt32_2(), Request[Constants.QRY_PROJECTID].ToInt32_2(), UserDetail.GetCurrentUserDetail().UID))
                    (HttpContext.Current.Handler as Page).Session[&quot;WorkflowSuccessOnLastPage&quot;] = &quot;Forecast created successfully.&quot;;
                else
                    (HttpContext.Current.Handler as Page).Session[&quot;WorkflowErrOnLastPage&quot;] = &quot;An unexpected error has occurred. Forecast is not created.&quot;;
            }


            if (HttpContext.Current != null &amp;&amp; HttpContext.Current.Handler != null)
                (HttpContext.Current.Handler as BrixPageBase).UpdateTree = true;

            string url = Request.RawUrl;
            if (!url.Contains(&quot;nt=1&quot;))
                url = url + &quot;&amp;nt=1&quot;;
            Response.Redirect(url);
        }

        public override void CustomizeToolBarMenu(ToolBar toolBar)
        {
            base.CustomizeToolBarMenu(toolBar);
            ApplyToolBarCustomisation(toolBar);
        }

        public override BrixFilter[] GetApplyFilterLabels()
        {
            var filter = new BrixFilter[7];

            filter[0] = new BrixFilter();
            filter[0].FilterType = BrixFilter.Type.Text;
            filter[0].Name = &quot;LineNo&quot;;
            filter[0].Title = &quot;QuantityPlanningID&quot;;

            filter[1] = new BrixFilter();
            filter[1].FilterType = BrixFilter.Type.Text;
            filter[1].Name = &quot;QPDescription&quot;;
            filter[1].Title = &quot;Description&quot;;

            filter[2] = new BrixFilter();
            filter[2].FilterType = BrixFilter.Type.Combo;
            filter[2].Name = filter[2].Title = &quot;Status&quot;;
            filter[2].DataSource = new DataTable();
            var dicValues = new Dictionary&lt;string, string&gt;();
            dicValues.Add(&quot;Draft&quot;, &quot;Draft&quot;);
            dicValues.Add(&quot;Complete&quot;, &quot;Complete&quot;);
            dicValues.Add(&quot;Approved&quot;, &quot;Approved&quot;);
            dicValues.Add(&quot;All&quot;, null);
            filter[2].Values = dicValues;

            filter[3] = new BrixFilter();
            filter[3].FilterType = BrixFilter.Type.Date;
            filter[3].Name = &quot;CreatedOn&quot;;
            filter[3].Title = &quot;Created On&quot;;

            filter[4] = new BrixFilter();
            filter[4].FilterType = BrixFilter.Type.Text;
            filter[4].Name = &quot;CreatedBy&quot;;
            filter[4].Title = &quot;Created By&quot;;


            filter[5] = new BrixFilter();
            filter[5].FilterType = BrixFilter.Type.Date;
            filter[5].Name = &quot;ApprovedOn&quot;;
            filter[5].Title = &quot;Approved On&quot;;

            filter[6] = new BrixFilter();
            filter[6].FilterType = BrixFilter.Type.Text;
            filter[6].Name = &quot;ApprovedBy&quot;;
            filter[6].Title = &quot;Approved By&quot;;
            return filter;
        }

        public override string NewURL
        {
            get
            {

                if (!string.IsNullOrEmpty(ParentModuleID))
                {
                    string returnURL = !string.IsNullOrWhiteSpace(Request[&quot;ReturnURL&quot;]) == true ? Request[&quot;ReturnURL&quot;] : &quot;&quot;;
                    return String.Format(
                        &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?ParentID={0}&amp;PID={1}&amp;Mode=New&amp;Context=QTYPLAN&amp;ParentModuleId={3}&amp;ReturnURL={4}&quot;,
                        Request[&quot;ContractID&quot;], Request[&quot;PID&quot;], Request[&quot;PID&quot;], ParentModuleID, returnURL);
                }
                else
                {
                    return String.Format(
                        &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?ParentID={0}&amp;PID={1}&amp;Mode=New&amp;Context=QTYPLAN&quot;,
                        Request[&quot;ContractID&quot;], Request[&quot;PID&quot;]);

                }
            }
        }

        public override void HandleNew()
        {
            if (permissions.Contains(&quot;Create&quot;))
                Response.Redirect(NewURL, false);

            else
            {
                if (HttpContext.Current != null &amp;&amp; HttpContext.Current.Handler != null)
                {
                    var currPage = (Page)HttpContext.Current.Handler;
                    UIHelper.RedirectURL(MessageResourceManager.GetString(&quot;E_USRMGMT_NO_PERMISSIONS_TO_VIEW_PAGE&quot;,
                                                                          Enumerations.MessageType.ErrorMessage),
                                         currPage.ResolveUrl(Constants.URL_ENTERPRISE), null, HttpContext.Current);
                }
            }
        }

        public override void HandleEdit()
        {
            if (MWGrid.GetSelectedRow(mwGrid) != null)
            {
                if (MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Inactive&quot;))
                    throw new Exception(&quot;Inactive planning can not be edited.&quot;);

                string selQtyPlanningID = GetSelectedItemFromGrid();
                string returnURL = !string.IsNullOrWhiteSpace(Request[&quot;ReturnURL&quot;]) == true ? Request[&quot;ReturnURL&quot;] : &quot;&quot;;
                    if (!String.IsNullOrEmpty(selQtyPlanningID))
                    Response.Redirect(
                        String.Format(
                            &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?ParentID={0}&amp;PID={1}&amp;QPID={2}&amp;Mode=Edit&amp;Context=QTYPLAN&amp;ParentModuleId={3}&amp;ReturnURL={4}&quot;,
                            Request[&quot;ContractID&quot;], Request[&quot;PID&quot;], selQtyPlanningID, ParentModuleID, returnURL), false);
            }
        }

        public override void HandleView()
        {
            string selQtyPlanningID = GetSelectedItemFromGrid();
            string returnURL = !string.IsNullOrWhiteSpace(Request[&quot;ReturnURL&quot;]) == true ? Request[&quot;ReturnURL&quot;] : &quot;&quot;;
            if (!String.IsNullOrEmpty(selQtyPlanningID))
                Response.Redirect(
                    String.Format(
                        &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?ParentID={0}&amp;PID={1}&amp;QPID={2}&amp;Mode=View&amp;Context=QTYPLAN&amp;ParentModuleId={3}&amp;ReturnURL={4}&quot;,
                        Request[&quot;ContractID&quot;], Request[&quot;PID&quot;], selQtyPlanningID, ParentModuleID, returnURL), false);
        }

        public override int HandleDelete()
        {
            if (MWGrid.GetSelectedRow(mwGrid) != null)
            {
                if (MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Approved&quot;) ||
                   MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Inactive&quot;) ||
                   MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Rejected&quot;) ||
                   MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;Status&quot;).Equals(&quot;Submitted&quot;))
                    throw new Exception(&quot;Only draft/complete records can be deleted.&quot;);
            }

            string selQtyPlanningID = GetSelectedItemFromGrid();
            selQtyPlanningID = FilterIdsToDeleteBasedOnWFDefinitions(FormName, PID.ToString2(), Request.QueryString[&quot;ContractID&quot;], selQtyPlanningID);

            //selQtyPlanningID contains Duplicate id&#39;s , so need to select single ID.
            string[] strPlanningID = selQtyPlanningID.Split(&#39;,&#39;);
            int selQtyPlanningIDInt = 0;
            if (strPlanningID.Length &gt; 0)
            {
                Int32.TryParse(strPlanningID[0].ToString(), out selQtyPlanningIDInt);
            }
            int retStatus = 0;
            if (selQtyPlanningIDInt &gt; 0)
            {
                retStatus = QuantityPlanningManager.Instance.DeletePlanningDetails(selQtyPlanningIDInt);

                if (retStatus == -1)
                    ForceDeleteWorkflowsForThisForm(selQtyPlanningID, FormName);

                if (HttpContext.Current != null &amp;&amp; HttpContext.Current.Handler != null)
                    (HttpContext.Current.Handler as BrixPageBase).UpdateTree = true;
            }
            string url = Request.RawUrl;
            if (!url.Contains(&quot;nt=1&quot;))
                url = url + &quot;&amp;nt=1&quot;;
            Response.Redirect(url);
            return retStatus;
        }

        public override string HandleMenuItem(string eventString)
        {
            if (eventString.Equals(&quot;Settings&quot;))
            {
                if (permissions.Contains(&quot;Settings&quot;))
                    Response.Redirect(&quot;~/Modules/QTYPLAN/Settings.aspx?Type=Q&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] +
                                      &quot;&amp;ContractID=&quot; + Request[&quot;ContractID&quot;] + &quot;&amp;ParentID=&quot; + Request[&quot;ContractID&quot;] + &quot;&amp;Context=&quot; + Request[&quot;Context&quot;]);
                else
                {
                    if (HttpContext.Current != null &amp;&amp; HttpContext.Current.Handler != null)
                    {
                        var currPage = (Page)HttpContext.Current.Handler;
                        UIHelper.RedirectURL(MessageResourceManager.GetString(&quot;E_USRMGMT_NO_PERMISSIONS_TO_VIEW_PAGE&quot;,
                                                                              Enumerations.MessageType.ErrorMessage),
                                             currPage.ResolveUrl(Constants.URL_ENTERPRISE), null, HttpContext.Current);
                    }
                }
            }
            else if (eventString.Equals(&quot;Copy from Existing&quot;))
            {
                string returnURL = !string.IsNullOrWhiteSpace(Request[&quot;ReturnURL&quot;]) == true ? Request[&quot;ReturnURL&quot;] : &quot;&quot;;
                if (string.IsNullOrEmpty(Request[&quot;ParentModuleId&quot;]))
                    Response.Redirect(
                    String.Format(
                        &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?ParentID={0}&amp;PID={1}&amp;Mode=New&amp;Copy=Yes&amp;Context=QTYPLAN&amp;ReturnURL={2}&quot;,
                        Request[&quot;ContractID&quot;], Request[&quot;PID&quot;], returnURL), false);
                else

                    Response.Redirect(
                        String.Format(
                            &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?ParentID={0}&amp;PID={1}&amp;Mode=New&amp;Copy=Yes&amp;Context=QTYPLAN&amp;ParentModuleId={2}&amp;ReturnURL={3}&quot;,
                            Request[&quot;ContractID&quot;], Request[&quot;PID&quot;], Request[&quot;ParentModuleId&quot;], returnURL), false);
            }
            else if (eventString.Equals(&quot;New&quot;))
            {
                HandleNew();
            }
            else if (eventString.Equals(&quot;Forecast&quot;))
            {
                lnkForecast_Click(this, new EventArgs());
                ApplyToolBarCustomisation(mainToolBar);
            }
            else if (eventString.Equals(&quot;Back&quot;))
            {
                if(!string.IsNullOrWhiteSpace(Request[&quot;ReturnURL&quot;]))
                {
                    string returnUrl = Request[&quot;ReturnURL&quot;];

                    string decryptedBackURL = SecurityHelpers.Decrypt_Simple(returnUrl);

                    Response.Redirect(decryptedBackURL);
                }
                else
                {
                    var currPage = (Page)HttpContext.Current.Handler;
                    UIHelper.RedirectURL(&quot;Back Button incorrectly configured&quot;,currPage.ResolveUrl(Constants.URL_ENTERPRISE), null, HttpContext.Current);
                }
            }
            else
            {
                return base.HandleMenuItem(eventString);
            }
            return string.Empty;
        }
  
        public override void HandleGridRowInitialization&lt;T&gt;(object sender, T row)
        {
            if (row is GridDataItem &amp;&amp; MWGrid.GetCellValue(row, &quot;IsLatestApproved&quot;).Equals(&quot;1&quot;))
                MWGrid.SetRowBackColor(row, Color.LightGray);
        }

        public override string HandleLogView(UltraWebGridExcelExporter UltraWebGridExcelExporter1)
        {
            string retMsg = String.Empty;
            try
            {
                #region Exporting Error Log

                var grid = new UltraWebGrid(&quot;grd_Temp&quot;);
                UltraWebGridExcelExporter1.DownloadName = &quot;QuantityPlanErrorLog.XLS&quot;;
                var book = new Workbook();

                var currPage = (Page)HttpContext.Current.Handler;
                var errorLogData = (DataSet)currPage.Session[sessionVarErrorLogDS];

                if (errorLogData == null || errorLogData.Tables == null || errorLogData.Tables.Count &lt; 1)
                    return String.Empty;

                #region Naming of tables

                DataTable dtItems = errorLogData.Tables[0];
                DataTable dtSubContractingResources = errorLogData.Tables[1];
                DataTable dtOverheads = errorLogData.Tables[2];

                #endregion

                QuantityPlanningManager.Instance.ExportGridData(dtItems, &quot;Invalid &quot; + ItemNameAbbr + &quot;s&quot;, book, grid,
                                                                UltraWebGridExcelExporter1);
                QuantityPlanningManager.Instance.ExportGridData(dtSubContractingResources,
                                                                &quot;Invalid Subcontracting Resources&quot;, book, grid,
                                                                UltraWebGridExcelExporter1);
                QuantityPlanningManager.Instance.ExportGridData(dtOverheads, &quot;Invalid Overheads&quot;, book, grid,
                                                                UltraWebGridExcelExporter1);

                #endregion
            }
            catch (Exception ex)
            {
                retMsg = ex.Message;
            }

            return retMsg;
        }

        public override string GetEditPageURL(string pID, string parentID, string instanceID, string context)
        {
            string parentModuleID = QuantityPlanningManager.Instance.GetparentModuleID(instanceID.ToInt32_2());
            return
                string.Format(
                    &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?Context=QTYPLAN&amp;Mode=Edit&amp;PID={0}&amp;ParentID={1}&amp;QPID={2}&amp;ParentModuleId={3}&quot;,
                    pID, parentID, instanceID, parentModuleID);
        }

        public override string GetViewPageURL(string pID, string parentID, string instanceID, string context)
        {
            string parentModuleID = QuantityPlanningManager.Instance.GetparentModuleID(instanceID.ToInt32_2());
            return
                string.Format(
                    &quot;~/Modules/QTYPLAN/CreatePlanning.aspx?Context=QTYPLAN&amp;Mode=View&amp;PID={0}&amp;ParentID={1}&amp;QPID={2}&amp;ParentModuleId={3}&quot;,
                    pID, parentID, instanceID, parentModuleID);
        }

        public override void HandleDataFromWorkFlow()
        {
            if (HttpContext.Current != null &amp;&amp; HttpContext.Current.Handler != null)
                (HttpContext.Current.Handler as BrixPageBase).UpdateTree = true;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,50,1],[37,13,37,14,1],[38,17,38,42,1],[39,21,40,162,1],[41,17,41,37,1],[42,13,42,14,1],[46,9,46,10,1],[47,13,47,166,1],[48,17,48,136,1],[50,17,50,58,1],[51,9,51,10,1],[54,9,54,10,1],[57,13,57,127,1],[58,17,58,83,1],[60,18,60,108,1],[61,17,61,44,1],[64,13,64,14,0],[65,17,65,157,0],[67,17,67,39,0],[68,17,68,18,0],[69,21,69,72,0],[70,17,70,18,0],[71,13,71,14,0],[73,13,73,27,1],[74,9,74,10,1],[81,17,81,18,1],[81,19,81,50,1],[81,51,81,52,1],[86,17,86,18,1],[86,19,86,49,1],[86,50,86,51,1],[91,17,91,18,1],[91,19,91,33,1],[91,34,91,35,1],[97,13,97,14,0],[99,17,99,42,0],[100,17,100,88,0],[103,17,103,87,0],[104,17,104,125,0],[105,17,105,38,0],[107,17,107,26,0],[108,13,108,14,0],[113,17,113,18,0],[113,19,113,39,0],[113,40,113,41,0],[119,13,119,14,0],[120,17,120,166,0],[121,13,121,14,0],[128,17,128,18,1],[128,19,128,36,1],[128,37,128,38,1],[133,17,133,18,1],[133,19,133,33,1],[133,34,133,35,1],[138,17,138,18,1],[138,19,138,53,1],[138,54,138,55,1],[143,17,143,18,0],[143,19,143,60,0],[143,61,143,62,0],[151,13,151,14,1],[152,17,152,98,1],[154,17,154,36,1],[155,17,155,62,1],[156,17,156,62,1],[156,62,156,86,1],[156,86,156,88,1],[156,17,156,88,1],[157,17,157,40,1],[158,17,158,18,0],[159,21,159,62,0],[160,21,160,48,0],[161,17,161,18,0],[162,17,162,37,1],[163,17,163,18,0],[165,21,165,102,0],[166,17,166,18,0],[168,17,168,107,1],[169,21,169,104,0],[172,17,172,64,1],[172,64,172,89,1],[172,89,172,91,1],[172,17,172,91,1],[173,17,173,42,1],[174,17,174,18,0],[175,21,175,65,0],[176,21,176,50,0],[177,17,177,18,0],[178,17,178,83,1],[178,83,178,102,1],[178,102,178,104,1],[178,17,178,104,1],[179,17,179,39,1],[180,17,180,18,0],[181,21,181,58,0],[182,17,182,18,0],[184,17,184,95,1],[185,17,185,92,1],[186,17,186,127,1],[187,17,187,54,1],[189,17,189,94,1],[190,17,190,18,1],[191,21,191,114,1],[192,21,192,56,1],[193,17,193,18,1],[195,17,195,113,1],[196,17,196,18,1],[197,21,197,95,1],[198,21,198,52,1],[199,17,199,18,1],[201,17,201,35,1],[202,13,202,14,1],[207,9,207,10,1],[208,13,208,53,1],[209,13,209,23,1],[210,13,211,97,1],[212,13,212,37,1],[213,13,213,36,1],[214,13,214,14,1],[215,17,215,76,1],[216,17,216,47,1],[217,17,217,18,1],[218,21,218,28,1],[218,30,218,40,1],[218,41,218,43,1],[218,44,218,61,1],[219,21,219,22,1],[220,25,220,111,1],[221,21,221,22,1],[222,17,222,18,1],[224,17,224,58,1],[225,21,225,73,1],[227,17,230,117,1],[231,13,231,14,1],[233,13,233,29,1],[235,9,235,10,1],[238,9,238,10,1],[239,13,239,91,1],[242,13,242,75,1],[243,13,243,81,1],[244,13,244,76,1],[245,13,245,80,1],[247,13,247,87,1],[248,13,248,78,1],[249,13,249,77,1],[250,13,250,87,1],[251,13,251,79,1],[252,13,252,77,1],[257,13,257,90,1],[258,13,258,107,1],[259,13,259,138,1],[260,13,260,134,1],[261,13,261,137,1],[262,13,262,92,1],[263,13,263,101,1],[264,13,264,140,1],[265,13,265,94,1],[269,13,269,33,1],[270,13,270,14,1],[271,17,271,66,1],[272,21,272,75,1],[275,17,275,64,1],[276,17,276,45,1],[277,13,277,14,1],[281,13,281,141,1],[282,13,282,14,0],[283,17,283,66,0],[285,17,285,68,0],[286,21,286,44,0],[288,21,288,45,0],[289,13,289,14,0],[293,13,293,39,1],[294,13,294,44,1],[296,13,296,37,1],[297,13,297,34,1],[298,13,298,40,1],[299,9,299,10,1],[301,9,301,51,1],[305,13,305,14,1],[306,17,306,51,1],[307,21,307,111,1],[308,17,308,46,1],[309,13,309,14,1],[313,9,313,10,1],[314,13,314,46,1],[315,13,315,56,1],[316,13,316,43,1],[317,13,317,14,1],[318,17,318,24,1],[318,26,318,33,1],[318,34,318,36,1],[318,37,318,59,1],[319,17,319,18,1],[320,21,322,80,1],[323,21,323,22,1],[324,25,324,54,1],[325,25,325,31,1],[327,17,327,18,1],[328,13,328,14,1],[330,13,330,79,1],[331,17,331,58,1],[333,17,333,59,1],[335,13,335,95,1],[337,13,337,59,1],[338,17,338,109,1],[341,13,341,117,1],[342,17,342,55,1],[344,13,344,109,1],[345,13,345,144,1],[346,13,346,14,1],[348,17,348,53,1],[349,17,349,50,1],[350,17,350,59,1],[352,13,352,14,1],[354,13,354,14,1],[355,17,355,52,1],[356,17,356,49,1],[357,17,357,58,1],[358,13,358,14,1],[370,13,370,47,1],[371,17,371,76,0],[372,9,372,10,1],[375,9,375,10,1],[376,13,376,39,1],[381,13,381,88,1],[382,13,382,31,1],[383,13,383,14,1],[385,17,385,162,1],[386,21,386,131,1],[388,21,388,155,0],[389,13,389,14,1],[392,13,392,84,1],[393,17,393,81,1],[395,13,395,41,1],[396,13,396,39,1],[397,17,397,37,1],[398,13,398,36,1],[399,9,399,10,0],[402,9,402,10,1],[403,13,403,48,1],[404,13,404,48,1],[405,9,405,10,1],[408,9,408,10,1],[409,13,409,44,1],[411,13,411,42,1],[412,13,412,57,1],[413,13,413,39,1],[414,13,414,52,1],[416,13,416,42,1],[417,13,417,57,1],[418,13,418,46,1],[419,13,419,45,1],[421,13,421,42,1],[422,13,422,58,1],[423,13,423,57,1],[424,13,424,52,1],[425,13,425,62,1],[426,13,426,45,1],[427,13,427,51,1],[428,13,428,51,1],[429,13,429,40,1],[430,13,430,42,1],[432,13,432,42,1],[433,13,433,57,1],[434,13,434,42,1],[435,13,435,44,1],[437,13,437,42,1],[438,13,438,57,1],[439,13,439,42,1],[440,13,440,44,1],[443,13,443,42,1],[444,13,444,57,1],[445,13,445,43,1],[446,13,446,45,1],[448,13,448,42,1],[449,13,449,57,1],[450,13,450,43,1],[451,13,451,45,1],[452,13,452,27,1],[453,9,453,10,1],[458,13,458,14,0],[460,17,460,59,0],[461,17,461,18,0],[462,21,462,125,0],[463,21,465,107,0],[468,17,468,18,0],[469,21,471,64,0],[474,13,474,14,0],[478,9,478,10,1],[479,13,479,48,1],[480,17,480,50,1],[483,13,483,14,0],[484,17,484,88,0],[485,17,485,18,0],[486,21,486,70,0],[487,21,489,116,0],[490,17,490,18,0],[491,13,491,14,0],[492,9,492,10,1],[495,9,495,10,0],[496,13,496,55,0],[497,13,497,14,0],[498,17,498,101,0],[499,21,499,81,0],[501,17,501,69,0],[502,17,502,121,0],[503,21,503,65,0],[504,21,507,121,0],[508,13,508,14,0],[509,9,509,10,0],[512,9,512,10,0],[513,13,513,65,0],[514,13,514,117,0],[515,13,515,57,0],[516,17,519,117,0],[520,9,520,10,0],[523,9,523,10,1],[524,13,524,55,1],[525,13,525,14,1],[526,17,529,101,1],[530,21,530,88,0],[531,13,531,14,1],[533,13,533,65,1],[534,13,534,150,1],[537,13,537,66,1],[538,13,538,41,1],[539,13,539,42,1],[540,13,540,14,1],[541,17,541,86,1],[542,13,542,14,1],[543,13,543,31,1],[544,13,544,41,1],[545,13,545,14,1],[546,17,546,105,1],[548,17,548,37,1],[549,21,549,81,1],[551,17,551,88,1],[552,21,552,85,1],[553,13,553,14,1],[554,13,554,41,1],[555,13,555,39,1],[556,17,556,37,1],[557,13,557,36,1],[558,13,558,30,0],[559,9,559,10,0],[562,9,562,10,0],[563,13,563,48,0],[564,13,564,14,0],[565,17,565,54,0],[566,21,567,153,0],[569,17,569,18,0],[570,21,570,92,0],[571,21,571,22,0],[572,25,572,74,0],[573,25,575,120,0],[576,21,576,22,0],[577,17,577,18,0],[578,13,578,14,0],[579,18,579,63,0],[580,13,580,14,0],[581,17,581,121,0],[582,17,582,69,0],[583,21,586,83,0],[589,21,592,114,0],[593,13,593,14,0],[594,18,594,48,0],[595,13,595,14,0],[596,17,596,29,0],[597,13,597,14,0],[598,18,598,53,0],[599,13,599,14,0],[600,17,600,58,0],[601,17,601,56,0],[602,13,602,14,0],[603,18,603,49,0],[604,13,604,14,0],[605,17,605,69,0],[606,17,606,18,0],[607,21,607,61,0],[609,21,609,89,0],[611,21,611,57,0],[612,17,612,18,0],[614,17,614,18,0],[615,21,615,70,0],[616,21,616,153,0],[617,17,617,18,0],[618,13,618,14,0],[620,13,620,14,0],[621,17,621,57,0],[623,13,623,33,0],[624,9,624,10,0],[627,9,627,10,1],[628,13,628,97,1],[629,17,629,62,1],[630,9,630,10,1],[633,9,633,10,0],[634,13,634,42,0],[636,13,636,14,0],[639,17,639,57,0],[640,17,640,86,0],[641,17,641,43,0],[643,17,643,66,0],[644,17,644,84,0],[646,17,646,106,0],[647,21,647,41,0],[651,17,651,60,0],[652,17,652,78,0],[653,17,653,64,0],[657,17,658,93,0],[659,17,661,93,0],[662,17,663,93,0],[666,13,666,14,0],[667,13,667,33,0],[668,13,668,14,0],[669,17,669,37,0],[670,13,670,14,0],[672,13,672,27,0],[673,9,673,10,0],[676,9,676,10,1],[677,13,677,112,1],[678,13,681,64,1],[682,9,682,10,1],[685,9,685,10,0],[686,13,686,112,0],[687,13,690,64,0],[691,9,691,10,0],[694,9,694,10,1],[695,13,695,84,1],[696,17,696,81,1],[697,9,697,10,1]]);
    </script>
  </body>
</html>