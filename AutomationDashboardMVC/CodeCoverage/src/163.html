<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Item Postings\ItemPostingControl.ascx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;
using Aurigo.AMP3.Core.UserControls;
using System.Globalization;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.AMP3.CONTMGTITMPOSTDTO;
using Aurigo.Brix.Construction.ContractManager.BusinessLayer.BL;
using Aurigo.AMP3.ContractManager;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.BusinessLayer.DTO;
using Infragistics.WebUI.WebSchedule;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.ContmgtDTO;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Telerik.Web.UI;
using Newtonsoft.Json.Linq;
using Newtonsoft.Json;
using System.Collections;
using Aurigo.Brix.Core.WebUiHelper;
using ContBL = Aurigo.AMP3.ContractManager.BusinessLayer.BL;

using System.Reflection;

namespace Aurigo.Brix.Construction.ContractManager.ItemPostingUI
{
    public partial class ItemPostingControl : BrixUserControlBase
    {
        protected global::Telerik.Web.UI.RadGrid MWDataGrid;
        protected global::Aurigo.AMP3.Core.UserControls.RateAnalysisControl ucRateAnalysis;
        protected global::Infragistics.WebUI.WebSchedule.WebDateChooser dtPostedDate;
        protected global::Aurigo.AMP3.Core.UserControls.ItemPickerControl ipc;

        //Page Mode - New, Edit and View
        private ModeTypes Mode
        {
            get
            {

                if (!string.IsNullOrEmpty(Request[&quot;Mode&quot;]))
                    return (ModeTypes)Enum.Parse(typeof(ModeTypes), Request[&quot;Mode&quot;]);

                return ModeTypes.New;

            }
        }

        //Reference to Brix Page Base
        //private BrixPageBase PageBase { get { return Page as BrixPageBase; } }

        //Data table which will hold all the IPs
        private DataTable _ItemPostingsSchema { get; set; }

        private int ContractID { get { return Request[&quot;ContractID&quot;].ToInt32_2(); } }
        private int PID { get { return Request[&quot;PID&quot;].ToInt32_2(); } }
        private int? DWRID { get { return string.IsNullOrEmpty(Request[&quot;DWRID&quot;]) ? (int?)null : Request[&quot;DWRID&quot;].ToInt32_2(); } }
        private string ModuleID = &quot;ITMPOST&quot;;
        private int WOID { get { return string.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? 0 : Request[&quot;WOID&quot;].ToInt32_2(); } }

        public string ClearItemsScript = &quot;ItemPostingControl_ClearItems()&quot;;
        public string SavePostingScript { get { return $&quot; ItemPostingControl_SavePosting(&#39;{btnSavePosting.ClientID}&#39;)&quot;; } }
        public string AddItemsScript { get { return $&quot; ItemPostingControl_AddNewItem(&#39;{btnItemPicker.ClientID}&#39;); &quot;; } }
        public string DeleteItemsScript = &quot;ItemPostingControl_DeleteItems()&quot;;
        public string AddItemsFromLastPostingScript { get { return $&quot; ItemPostingControl_ClickButton(&#39;{btnAddItemsFromLast.ClientID}&#39;)&quot;; } }


        /// &lt;summary&gt;
        /// Gets all the active core module components
        /// &lt;/summary&gt;
        private List&lt;string&gt; CoreModuleComponents
        {
            get
            {
                if (ViewState[&quot;IPControl_ModuleComponents&quot;] == null)
                    ViewState[&quot;IPControl_ModuleComponents&quot;] = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
                return ((List&lt;string&gt;)ViewState[&quot;IPControl_ModuleComponents&quot;]);
            }
        }

        private string _ITEM_ResourceText = null;

        public string ITEM_ResourceText
        {
            get
            {
                if (_ITEM_ResourceText == null) _ITEM_ResourceText = LocalizationManager.GetString(KeyConstants.LOC_ITEM);
                return _ITEM_ResourceText;
            }
        }

        private readonly IEnumerable&lt;string&gt; _editableColumnsOfItemPosting = new List&lt;string&gt;(new[] { &quot;PostedDate&quot;, &quot;PostedQty&quot;, &quot;Number&quot;, &quot;Dimension1&quot;, &quot;Dimension2&quot;, &quot;Dimension3&quot;, &quot;Remarks&quot;, &quot;FromStn&quot;, &quot;ToStn&quot;, &quot;PercentComplete&quot;, &quot;IsComplete&quot;, &quot;Attention&quot; });
        
        public override void InclueScriptAndStyleFiles()
        {
            base.InclueScriptAndStyleFiles();
            base.RegisterClientScriptInclude(&quot;~/Scripts/bundle.brixitem.*.js&quot;);

            string javascriptVariables = $&quot;var ItemPostingMWDataGrid_ClientID = &#39;{MWDataGrid.ClientID}&#39;; var hdnMWGridData_ClientID = &#39;{hdnMWGridData.ClientID}&#39;; var hdnDeletedRows_ClientID = &#39;{hdnDeletedRows.ClientID}&#39;;&quot;;
            base.RegisterClientScriptBlock(javascriptVariables, this, &quot;ItemPosting_Variables&quot;);

            base.RegisterClientScriptInclude(&quot;~/Modules/CONTDWR/Scripts/ItemPosting_20170224.js&quot;);

            if (IsPostBack)
                base.RegisterClientScriptBlock(&quot;$(document).ready(function () { EnableCheckBox();});&quot;, MWDataGrid, &quot;EnableCheckBox&quot;);
        }

        protected override void OnInit(EventArgs e)
        {
            //Initializing the Item Picker Control and rate analysis control
            #region Item Picker Control
            ipc_InitItemPickerParams();
            ipc.ModuleID = WOID &gt; 0 ? Constants.MODID_WORKORD : ModuleID;
            ipc.HideAll = true;
            ipc.ParentInstanceID = WOID &gt; 0 ? WOID : ContractID;
            ipc.MultipleSelectedIndexChanged += new Infragistics.WebUI.UltraWebGrid.ClickEventHandler(ipc_MultipleSelectedIndexChanged);
            //ipc.InitItemPickerParams += new ItemPickerControl.InitParams(ipc_InitItemPickerParams);
            ipc.CustomizeGridColumns += new ItemPickerControl.CustomizeColumns(ipc_CustomizeGridColumns);

            #endregion

            #region Rate Analysis Control

            ucRateAnalysis.isOverheadsShown = false;
            ucRateAnalysis.BackClicked += new EventHandler(ucRateAnalysis_BackClicked);
            ucRateAnalysis.ReadOnly = Mode.Equals(&quot;View&quot;);

            #endregion

            //Setting the culture for the date control
            dtPostedDate.CalendarLayout.Culture = DateFormatCulture.GetDateFormatCulture();

            base.OnInit(e);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            ipc.InitializeGrid();
            ipc.GridItems = GetPostingIDs();
            btnItemPicker.Attributes.Add(&quot;onclick&quot;, &quot;$(&#39;#&quot; + ipc.PickerButton.ClientID + &quot;&#39;).click();return false;&quot;);
            hdnAmountDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT).ToString2();
            hdnCulture.Value = AMP3ApplicationSettings.Instance.Culture.ToString2();
            hdnCurrencySymbol.Value = LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL);
            hdnITEM_ResourceText.Value = ITEM_ResourceText;
        }

        bool ipc_InitItemPickerParams()
        {
            ipc.EnableMultipleSelect = true;
            ipc.DoPostBackAfterSelect = true;
            ipc.Currency = LocalizationManager.GetModuleCurrency(&quot;LIBRARY&quot;, null, Session[&quot;AXCompany&quot;].ToString2());
            return true;
        }

        void ipc_CustomizeGridColumns(ref List&lt;Aurigo.Brix.Platform.BusinessLayer.UserControls.PickerColumnDetails&gt; lst)
        {
            //If Unit cost and over head cost are not anabled then it should not be visible in Item PickerMultipleSelectedIndexChanged
            for (int i = 0; i &lt; lst.Count; i++)
            {
                if (lst[i].ColumnName == &quot;UnitCost&quot; &amp;&amp; !CoreModuleComponents.Contains(&quot;ItemUnitCost&quot;))
                {
                    lst.RemoveAt(i);
                    i--;
                }
                if (lst[i].ColumnName == &quot;OverheadCost&quot; &amp;&amp; !CoreModuleComponents.Contains(&quot;ItemOverheadCost&quot;))
                {
                    lst.RemoveAt(i);
                    i--;
                }
                //Remove Multi Column
                if (lst[i].ColumnName == &quot;Multi&quot;)
                {
                    lst.RemoveAt(i);
                    i--;
                }
            }
        }

        void ipc_MultipleSelectedIndexChanged(object sender, ClickEventArgs e)
        {
            List&lt;Aurigo.AMP3.Core.BusinessLayer.DTO.Item&gt; stdItemsList = ipc.GetMultipleDTOFromHTTP();
            FillItemPostingGridWithItems(stdItemsList);
            ipc.PickerText.Text = ipc.PickerValue.Text = ipc.Text = &quot;&quot;;
        }

        private void FillItemPostingGridWithItems(List&lt;Item&gt; stdItemsList)
        {
            UserDetail ud = UserDetail.GetCurrentUserDetail();
            bool hasActivities = CoreModuleComponents.Contains(&quot;Activities&quot;);
            Posting dtoPosting = new Posting();

            if (_ItemPostingsSchema == null)
                GetItemPostings();

            DataTable dtItemPostings = _ItemPostingsSchema.Clone();

            if (ViewState[&quot;ItemPostingsInGrid&quot;] != null)
                dtItemPostings = (ViewState[&quot;ItemPostingsInGrid&quot;] as DataTable).Copy();

            List&lt;ItemPostingEditableObject&gt; originalDataTableFromClient = null;
            if (!string.IsNullOrEmpty(hdnMWGridData.Value))
            {
                try
                {
                    JArray array = JArray.Parse(hdnMWGridData.Value);
                    originalDataTableFromClient = JsonConvert.DeserializeObject&lt;List&lt;ItemPostingEditableObject&gt;&gt;(array.ToString());//Note: translating to DataTable directly we cannot infer the dataType of the column. Hence cast it into concrete class

                    //Bugfix: We were not persisting existing changes on client when add items was refreshing page.

                    #region Restore back User changes from client
                    if (originalDataTableFromClient != null || originalDataTableFromClient.Count &gt; 0)
                    {
                        foreach (DataRow curDataRow in dtItemPostings.Rows)
                        {
                            int itemId = curDataRow[&quot;ItemID&quot;].ToInt32_2();
                            int id = curDataRow[&quot;ID&quot;].ToInt32_2();

                            ItemPostingEditableObject dataRowFromClient = originalDataTableFromClient.Where(t =&gt; (t.ItemID == itemId &amp;&amp; t.ID == id)).FirstOrDefault();//.Select($&quot;ItemID=&#39;{itemId}&#39;&quot;).FirstOrDefault();

                            if (dataRowFromClient == null)
                                continue;

                            bool isModified = false;
                            foreach (string editableColNames in _editableColumnsOfItemPosting)
                            {
                                try
                                {
                                    if (dtItemPostings.Columns[editableColNames] == null)
                                        continue;

                                    PropertyInfo pi = dataRowFromClient.GetType().GetProperty(editableColNames);

                                    if (pi == null)
                                        continue;

                                    object objValue = pi.GetValue(dataRowFromClient);

                                    if (objValue == null &amp;&amp; (curDataRow[editableColNames] == DBNull.Value || curDataRow[editableColNames] == null))
                                        continue;

                                    if (!object.Equals(objValue, curDataRow[editableColNames]))
                                    {
                                        curDataRow[editableColNames] = objValue;
                                        isModified = true;
                                    }
                                }
                                catch (Exception ex)
                                {
                                    AMP3.Logging.Logger.Log(&quot;ITEMPOSTING&quot;, ex);
                                }
                            }

                            if (isModified)
                                curDataRow.AcceptChanges();
                        }
                    }
                    #endregion Restore back User changes from client
                }
                catch (Exception ex)
                {
                    AMP3.Logging.Logger.Log(&quot;ITEMPOSTING&quot;, ex);
                }
            }

            int ctr = 1;
            foreach (Item stdItem in stdItemsList)
            {
                //Get all the sub items and activities for the selected item
                //if (!IsDuplicate(stdItem.ItemID.ToInt32_2(), dtItemPostings))
                //{
                    int ID = -(MWDataGrid.Items.Count + ctr++); //Create negative valued item id for new record
                    dtoPosting.PostingID = ID;
                    DataRow[] drSubItems = ItemManager.Instance.GetSubItemData(&quot;CONTMGT&quot;, ContractID, stdItem.ItemID.Value).Tables[0].Select();

                    DataRow itemFromPickerDataRow = dtItemPostings.NewRow();
                    AddPostingsToGrid(ud, hasActivities, stdItem, dtoPosting, drSubItems, ref itemFromPickerDataRow);
                    dtItemPostings.Rows.Add(itemFromPickerDataRow);
               // }
            }

            ViewState[&quot;ItemPostingsInGrid&quot;] = dtItemPostings;

            MWDataGrid.DataSource = dtItemPostings;
            MWDataGrid.DataBind();
        }

        /// &lt;summary&gt;
        /// Adds Item, Sub Item and Activities to the posting grid.
        /// &lt;/summary&gt;
        private void AddPostingsToGrid(UserDetail ud, bool hasActivities, Item stdItem, Posting dtoPosting, DataRow[] drSubItems, ref DataRow itemPostingDataRow)
        {
            //Adding Item, Sub Item and Activity rows to the grid if it exists. 

            if (drSubItems != null &amp;&amp; drSubItems.Length &gt; 0)
            {
                //Add BOQ for each SI and then add Actitivities foreach SI
                for (int idx = 0; idx &lt; drSubItems.Length; idx++)
                {
                    CreateItemOrSubItemsWithActivities(ud, hasActivities, stdItem, dtoPosting, drSubItems[idx], ref itemPostingDataRow);
                }
            }
            else
            {
                //Add BOQ then add Actitivities - No SI
                CreateItemOrSubItemsWithActivities(ud, hasActivities, stdItem, dtoPosting, null, ref itemPostingDataRow);
            }
        }

        /// &lt;summary&gt;
        /// Creates an Item row or a sub item row with activities
        /// &lt;/summary&gt;
        private void CreateItemOrSubItemsWithActivities(UserDetail ud, bool hasActivities, Item stdItem,
            Posting dtoPosting, DataRow subItemdr, ref DataRow itemPostingDataRow)
        {
            // Create the item or subitem row first
            AddItemOrSIRowInGrid(ud, stdItem, dtoPosting, subItemdr, ref itemPostingDataRow);

            decimal remainingItemQty = 0, woCoeff = 1, coefficient = 1, itemQty = 0;
            string moduleID = dtoPosting.PostingID &lt; 0 ? Constants.MODID_CONTMGT : &quot;ITMPOST&quot;;
            int parentInstanceID = dtoPosting.PostingID.ToInt32_2() &lt; 0 ? Request[&quot;ContractID&quot;].ToInt32_2() : dtoPosting.PostingID.ToInt32_2();

            int? subItemID = subItemdr == null ? null : (int?)subItemdr[&quot;SubItemID&quot;].ToInt32_2();

            DataTable dtActivities = ITMPOSTBL.Instance.GetActivitiesForPostings(moduleID, parentInstanceID, (int)stdItem.ItemID,
                    subItemID, null, WOID, dtoPosting.PostingID.ToInt32_2() &lt; 0 ? 0 : dtoPosting.PostingID.ToInt32_2()).Tables[0];

            // add activities below the subitem/item
            if (dtActivities != null &amp;&amp; dtActivities.Rows.Count &gt; 0)
            {
                if (WOID &gt; 0)
                {
                    decimal.TryParse(dtActivities.Rows[0][&quot;WOCoeff&quot;].ToString2(), out woCoeff);
                }

                if (stdItem.Quantity != 0)
                {
                    //dividing activity quanityt accross subitems
                    if (dtoPosting.PostingID.ToInt32_2() &lt;= 0)
                    {
                        //stdItem.Quantity is coming as WO qty
                        itemQty = stdItem.Quantity / woCoeff;
                        coefficient = subItemdr == null ?
                            woCoeff :
                            ((subItemdr[&quot;Quantity&quot;].ToDecimal2() / itemQty) * woCoeff);
                    }
                    else
                    {
                        coefficient = subItemdr == null ?
                            woCoeff :
                            ((subItemdr[&quot;Quantity&quot;].ToDecimal2() / stdItem.Quantity) * woCoeff);
                    }
                }
                else
                {
                    coefficient = 0;
                    woCoeff = 0;
                }

                for (int index = 0; index &lt; dtActivities.Rows.Count; index++)
                {
                    //AddItemOrSIRowInGrid(ud, stdItem, dtoPosting, subItemdr, ref itemPostingDataRow);

                    AddActivityDetailsRowInGrid(dtActivities.Rows[index], ref itemPostingDataRow, (subItemdr == null ? 0 : subItemdr[&quot;SubItemID&quot;].ToInt32_2()), coefficient);

                    if (dtActivities.Rows[index][&quot;Original Quantity&quot;].ToDecimal2() != 0)
                        remainingItemQty += (dtActivities.Rows[index][&quot;ItemQuantity&quot;].ToDecimal2() * dtActivities.Rows[index][&quot;Percentage&quot;].ToDecimal2() * dtActivities.Rows[index][&quot;RemainingQty&quot;].ToDecimal2() / (dtActivities.Rows[index][&quot;Original Quantity&quot;].ToDecimal2() * 100));

                    //Hide the row if activies are not enabled
                    //newARow.Hidden = !hasActivities;
                }

                if (subItemdr != null || dtoPosting.PostingID.ToInt32_2() &gt; 0)
                    itemPostingDataRow[&quot;Quantity&quot;] = (itemPostingDataRow[&quot;Quantity&quot;].ToDecimal2() * woCoeff).ToString();

                itemPostingDataRow[&quot;RemainingQty&quot;] = remainingItemQty;
            }
        }

        /// &lt;summary&gt;
        /// Adds Item row or Sub Item row to the grid.
        /// &lt;/summary&gt;
        private void AddItemOrSIRowInGrid(UserDetail ud, Item stdItem, Posting dtoPosting, DataRow subItemdr, ref DataRow itemPostingDataRow)
        {
            List&lt;string&gt; coreCmpnts = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);

            #region Assigning Values to the newly created row&#39;s Column
            itemPostingDataRow[&quot;LineNo&quot;] = stdItem.LineNo;
            itemPostingDataRow[&quot;Description&quot;] = stdItem.Description;
            itemPostingDataRow[&quot;StandardItemNo&quot;] = stdItem.StandardItemNo;
            itemPostingDataRow[&quot;ItemID&quot;] = stdItem.ItemID;
            itemPostingDataRow[&quot;Unit&quot;] = stdItem.Unit;
            itemPostingDataRow[&quot;PostingID&quot;] = (dtoPosting.PostingID &lt; 0 ? 0 : dtoPosting.PostingID);
            itemPostingDataRow[&quot;Quantity&quot;] = stdItem.Quantity;
            itemPostingDataRow[&quot;RemainingQty&quot;] = stdItem.Quantity;
            itemPostingDataRow[&quot;UserName&quot;] = ud.UserID;
            itemPostingDataRow[&quot;IsNonContract&quot;] = stdItem.IsNonContract;
            itemPostingDataRow[&quot;Status&quot;] = &quot;D&quot;;
            itemPostingDataRow[&quot;SubItem&quot;] = &quot;NA&quot;;
            itemPostingDataRow[&quot;RowNum&quot;] = stdItem.ItemID + &quot;-0-0&quot;;// ItemID-SubItemID-ActivityID
            itemPostingDataRow[&quot;ID&quot;] = dtoPosting.PostingID;          

            if (itemPostingDataRow.Table.Columns.Contains(&quot;IPResConsumption&quot;))
                itemPostingDataRow[&quot;IPResConsumption&quot;] = &quot;...&quot;;

            if(dtoPosting.NegativeApprovedPostedQuantity != null)
                itemPostingDataRow[&quot;NegativeApprovedPostedQuantity&quot;] = dtoPosting.NegativeApprovedPostedQuantity;
            else
                itemPostingDataRow[&quot;NegativeApprovedPostedQuantity&quot;] = DBNull.Value;
            if (dtoPosting.PositiveApprovedPostedQuantity != null)
                itemPostingDataRow[&quot;PositiveApprovedPostedQuantity&quot;] = dtoPosting.PositiveApprovedPostedQuantity;
            else
                itemPostingDataRow[&quot;PositiveApprovedPostedQuantity&quot;] = DBNull.Value;
            if (dtoPosting.PostedQty != null)
            {
                itemPostingDataRow[&quot;PostedQty&quot;] = dtoPosting.PostedQty;
                itemPostingDataRow[&quot;OriginalPostedQty&quot;] = dtoPosting.PostedQty;
            }
            else
            {
                itemPostingDataRow[&quot;PostedQty&quot;] = DBNull.Value;
                itemPostingDataRow[&quot;OriginalPostedQty&quot;] = DBNull.Value;
            }

            if (itemPostingDataRow.Table.Columns.Contains(&quot;MBookQty&quot;))
                itemPostingDataRow[&quot;MBookQty&quot;] = dtoPosting.MBookQty;

            itemPostingDataRow[&quot;Remarks&quot;] = dtoPosting.Remarks;
            itemPostingDataRow[&quot;FromStn&quot;] = dtoPosting.FromStn;
            itemPostingDataRow[&quot;ToStn&quot;] = dtoPosting.ToStn;

            if (dtoPosting.PercentComplete != null)
                itemPostingDataRow[&quot;PercentComplete&quot;] = dtoPosting.PercentComplete;
            else
                itemPostingDataRow[&quot;PercentComplete&quot;] = DBNull.Value;

            if (dtoPosting.Cost != null)
                itemPostingDataRow[&quot;Cost&quot;] = dtoPosting.Cost;
            else
                itemPostingDataRow[&quot;Cost&quot;] = DBNull.Value;

            if (dtoPosting.UnitCost != null)
                itemPostingDataRow[&quot;UnitCost&quot;] = dtoPosting.UnitCost;
            else
                itemPostingDataRow[&quot;UnitCost&quot;] = DBNull.Value;

            #endregion

            DateTime postedDate = MWDateTimeHelper.MWToday;
            if (coreCmpnts.Contains(&quot;PostedDateIsWorkDate&quot;))
            {
                DataSet dsDWR = GetDWRDetails();
                if (dsDWR != null &amp;&amp; dsDWR.Tables[0].Rows.Count &gt; 0)
                {
                    DataRow drDWR = dsDWR.Tables[0].Rows[0];
                    if (!drDWR[&quot;WorkDate&quot;].Equals(DBNull.Value))
                    {
                        postedDate = drDWR[&quot;WorkDate&quot;].ToMWDateTime();
                    }
                }
            }

            if (dtoPosting.PostingID &lt;= 0)
            {
                //If the Item is new - not added previously

                itemPostingDataRow[&quot;PostedDate&quot;] = postedDate;
                itemPostingDataRow[&quot;IsComplete&quot;] = false;
                itemPostingDataRow[&quot;Attention&quot;] = false;
            }
            else
            {
                itemPostingDataRow[&quot;PostedDate&quot;] = dtoPosting.PostedDate.ToDateTime_MWCulture();
                if (Mode == ModeTypes.View)
                {
                    itemPostingDataRow[&quot;IsComplete&quot;] = (dtoPosting.BidItemComplete.Equals(&quot;True&quot;) ? true : false);
                    itemPostingDataRow[&quot;Attention&quot;] = (dtoPosting.Attention.Equals(&quot;True&quot;) ? true : false);
                }
                else
                {
                    itemPostingDataRow[&quot;IsComplete&quot;] = (dtoPosting.BidItemComplete.Equals(&quot;True&quot;) ? true : false);
                    itemPostingDataRow[&quot;Attention&quot;] = (dtoPosting.Attention.Equals(&quot;True&quot;) ? true : false);
                }
            }
            if (subItemdr != null)
            {
                //If sub items are present then add the sub item details
                itemPostingDataRow[&quot;SubItemID&quot;] = subItemdr[&quot;SubItemID&quot;];
                itemPostingDataRow[&quot;SubItem&quot;] = subItemdr[&quot;Description&quot;];
                itemPostingDataRow[&quot;Quantity&quot;] = subItemdr[&quot;Quantity&quot;];
                itemPostingDataRow[&quot;RowNum&quot;] = &quot;{0}-{1}-0&quot;.Format2(stdItem.ItemID, subItemdr[&quot;SubItemID&quot;]);// ItemID-SubItemID-ActivityID
            }
        }

        private List&lt;Aurigo.AMP3.Core.BusinessLayer.DTO.Item&gt; GetPreviousDPRItems()
        {
            List&lt;Item&gt; preItems = new List&lt;Item&gt;();
            DataSet ds = ComponentHelper.Instance.ExecuteDataSet(ItemPostingStoredProcedure.usp_CONTDWRGetItemsFromPreviousDPR, null, DWRID);

            if (ds.Tables[0].Rows.Count &lt;= 0)
            {
                ShowError(&quot;There are no records to add.&quot;);
            }

            foreach (DataRow row in ds.Tables[0].Rows)
            {
                Item itm = new Item();
                row.FillDTO(itm);
                preItems.Add(itm);
            }

            return preItems;

        }

        /// &lt;summary&gt;
        /// Checks if the selected item is already added to the postings grid
        /// &lt;/summary&gt;
        private bool IsDuplicate(int itemId, DataTable sourceDataTable)
        {
            DataRow[] drs = sourceDataTable.Select(&quot;ItemID=&#39;&quot; + itemId + &quot;&#39;&quot;);
            return drs.Length &gt; 0;
        }

        protected void btnRateAnalysis_Click(object sender, EventArgs e)
        {
            ShowDiv(ItemDivEnums.RateAnalysis);
            //permissions
            Aurigo.AMP3.ContmgtDTO.DTO contractDTO = null;
            if (ViewState[&quot;ContractDTO&quot;] == null)
                ViewState[&quot;ContractDTO&quot;] = Aurigo.AMP3.ContractManager.BusinessLayer.BL.Instance.GetContract(ContractID, Aurigo.AMP3.ContmgtDTO.FetchSet.All);
            contractDTO = (Aurigo.AMP3.ContmgtDTO.DTO)ViewState[&quot;ContractDTO&quot;];
            ucRateAnalysis.MeasSysID = (contractDTO.MeasSysID == null) ? 0 : Convert.ToInt32(contractDTO.MeasSysID);
            DataTable dtUnits = Aurigo.AMP3.ContractManager.BusinessLayer.BL.Instance.GetMeasSys(Session[Constants.EIS_ADDITIONAL_INFO].ToString2(), contractDTO.MeasSysID);
            ucRateAnalysis.BindUnits(dtUnits, &quot;Unit&quot;, &quot;ID&quot;);
            ucRateAnalysis.ModuleID = ModuleID;
            ucRateAnalysis.LoadItem(ModuleID, hdnCurrentPostingID.Value.ToInt32_2(), hdnItemID.Value.ToInt32_2());
            RegisterStartupScript($&quot; ItemPostingControl_HideToorBar(&#39;{hdnHideToolBar.ClientID}&#39;); &quot;, btnRateAnalysis, &quot;HideToorBar&quot;);
        }

        private decimal GetCost()
        {
            return ItemManager.Instance.GetUnitCost(hdnItemID.Value.ToInt32_2(), ModuleID, hdnCurrentPostingID.Value.ToInt32_2()).ToDecimal2();
        }

        private void ucRateAnalysis_BackClicked(object sender, EventArgs e)
        {
            ShowDiv(ItemDivEnums.CreatePosting);
            hdnItemID.Value = hdnCurrentPostingID.Value = hdnCurrentDataKey.Value = &quot;&quot;;
            RegisterStartupScript($&quot; ItemPostingControl_HideToorBar(&#39;{hdnHideToolBar.ClientID}&#39;); &quot;, btnRateAnalysis, &quot;HideToorBar&quot;);
        }

        protected void btnDeletePostings_Click(object sender, EventArgs e)
        {
            string selectedIds = hdnDeletedRows.Value.TrimEnd(&#39;,&#39;);
            selectedIds = selectedIds.Replace(&quot;\n&quot;, &quot;&quot;).Replace(&quot;\t&quot;, &quot;&quot;);
            if (!string.IsNullOrEmpty(selectedIds))
                ITMPOSTBL.Instance.UpdatePostingStatus(selectedIds, Constants.MODFEAT_DELETE, false, UserDetail.GetCurrentUserDetail().UID);
            foreach (GridDataItem row in MWDataGrid.Items)
                row[&quot;RowNum&quot;].Text = (row.ItemIndex + 1).ToString();
            ListModel.ForceDeleteWorkflowsForThisForm(selectedIds, &quot;XITMPOS&quot;);

            String[] selectIds = selectedIds.Split(&#39;,&#39;);

            if (hdnMWGridData.Value != string.Empty)
            {
                JArray array = JArray.Parse(hdnMWGridData.Value);

                DataTable originalDataTableFromClient = JsonConvert.DeserializeObject&lt;DataTable&gt;(array.ToString());

                DataTable dtNew = originalDataTableFromClient.Clone();

                dtNew.Columns[&quot;IsComplete&quot;].DataType = typeof(System.Boolean);
                dtNew.Columns[&quot;Attention&quot;].DataType = typeof(System.Boolean);
                dtNew.Columns[&quot;PostedDate&quot;].DataType = typeof(System.DateTime);
                dtNew.Columns[&quot;RemainingQty&quot;].DataType = typeof(System.Decimal);
                dtNew.Columns[&quot;Quantity&quot;].DataType = typeof(System.Decimal);

                foreach (DataRow row in originalDataTableFromClient.Rows)
                {
                    DataRow dr = dtNew.NewRow();
                    foreach (DataColumn dc in dtNew.Columns)
                    {
                        if (dc.ColumnName == &quot;IsComplete&quot; &amp;&amp; row[&quot;IsComplete&quot;].ToString() == &quot;false&quot;)
                            dr[&quot;IsComplete&quot;] = false;

                        else if (dc.ColumnName == &quot;IsComplete&quot; &amp;&amp; row[&quot;IsComplete&quot;].ToString() == &quot;true&quot;)
                            dr[&quot;IsComplete&quot;] = true;

                        else if (dc.ColumnName == &quot;Attention&quot; &amp;&amp; row[&quot;Attention&quot;].ToString() == &quot;false&quot;)
                            dr[&quot;Attention&quot;] = false;

                        else if (dc.ColumnName == &quot;Attention&quot; &amp;&amp; row[&quot;Attention&quot;].ToString() == &quot;true&quot;)
                            dr[&quot;Attention&quot;] = true;

                        else
                            dr[dc.ColumnName] = row[dc.ColumnName];
                    }
                    dtNew.Rows.Add(dr);
                }

                for (var s = 0; s &lt; selectIds.Length; s++)
                {
                    for (int r = 0; r &lt; dtNew.Rows.Count; r++)
                    {
                        DataRow dr = dtNew.Rows[r];
                        if (dr[&quot;ID&quot;].ToString() == selectIds[s].ToString())
                        {
                            dr.Delete();
                            break;
                        }

                    }
                }

                dtNew.AcceptChanges();

                LoadGrid(true, dtNew);
            }

        }

        private DataSet GetDWRDetails()
        {
            DataSet dsDWR = null;
            if (DWRID.HasValue)
            {
                BaseStoredProcedure usp_CONTDWRGetDWRDetails = new BaseStoredProcedure { Name = &quot;usp_CONTDWRGetDWRDetails&quot;, Input = &quot;DWRID&quot; };
                dsDWR = ComponentHelper.Instance.ExecuteDataSet(usp_CONTDWRGetDWRDetails, null, new object[] { DWRID.Value });
            }
            return dsDWR;
        }

        protected void btnSavePostingAndOpenRA_Click(object sender, EventArgs e)
        {

        }

        List&lt;int&gt; savedPostinsIDs;

        public string GetCellTextValue(DataRow row, String Column)
        {
            if (row[Column].ToString() == &quot;&amp;nbsp;&quot;)
            {
                return &quot;&quot;;
            }
            else
            {
                return row[Column].ToString();
            }
        }

        //public bool IsContractQuantityChecked()
        //{
        //    var dsPrepayRules = new DataSet();
        //    dsPrepayRules = ContBL.Instance.GetPESettings(ContractID, Constants.MODID_CONTMGT);
        //    DataTable dtTemp = null;
        //    if (dsPrepayRules.Tables != null)
        //    {
        //        DataTable dtPrepayRules = dsPrepayRules.Tables[1];
        //        dtTemp = dsPrepayRules.Tables[0];
        //    }
        //    if (dtTemp != null &amp;&amp; dtTemp.Rows != null)
        //    {
        //        return bool.Parse(dtTemp.Rows[0][&quot;ValidateRABContractQty&quot;].ToString());
        //    }
        //    return false;
        //}

        private bool IsValidatePostedQtyForItem(Dictionary&lt;int, ITMPOSTBL.PostedItemDto&gt; lookupPostedItems, int itemId, string itemIdentifierText, Dictionary&lt;int,decimal&gt; userPostedQty, decimal contractTotalQty, out string errorMessage)
        {
            //itemIdentifierText = row[&quot;StandardItemNo&quot;].ToString()
            //ScriptManager.RegisterStartupScript(btnAddItemsFromLast, btnAddItemsFromLast.GetType(), &quot;FirstDPRNegativeItem&quot;, string.Format(&quot;ShowError(&#39;{0}&#39;)&quot;, errorMsg), true);
            errorMessage = null;

            ITMPOSTBL.PostedItemDto postedItemDataFromDb = null;

            if (lookupPostedItems.ContainsKey(itemId))
                postedItemDataFromDb = lookupPostedItems[itemId];

            if (postedItemDataFromDb == null)
                postedItemDataFromDb = new ITMPOSTBL.PostedItemDto() { ContractId = ContractID, ItemId = itemId };

            //Note the below validaiton is not required now. The validation below is to be done only upon &quot;Approve&quot; workflow action.
            ////requirement: if PostBeyondContractQuantity is not allowed then check for validation
            //if (userPostedQty &gt; 0 &amp;&amp; !isAllowPostBeyondContractQuantity)
            //{
            //    decimal projectedNewPostedQty = userPostedQty + postedItemDataFromDb.TotalPostedQty;

            //    if (projectedNewPostedQty &gt; contractTotalQty)
            //    {
            //        errorMessage = string.Format(&quot;For {0} [{1}], posting quantity of {2} is not allowed since the total posted quantity will exceed the total contract quantity of {3}. &quot;,
            //                             ITEM_ResourceText, itemIdentifierText, userPostedQty, contractTotalQty);

            //        return false;
            //    }
            //}

            //New requirement: Where total of ABSOLUTE(negative posting) cannot be less than total positive posted
            if (userPostedQty.ContainsKey(itemId) &amp;&amp; userPostedQty[itemId] &lt; 0)
            {
                decimal totalNegative = userPostedQty[itemId] + postedItemDataFromDb.NegativePostedQty;
                if (Math.Abs(totalNegative) &gt; postedItemDataFromDb.PositivePostedQty)
                {
                    string str_userPostedQty = userPostedQty[itemId].ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, CultureInfo.CurrentCulture);
                    string str_PositivePostedQty = postedItemDataFromDb.PositivePostedQty.ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, CultureInfo.CurrentCulture);

                    errorMessage = string.Format(&quot;For {0} [{1}], posting quantity of {2} is not allowed since it will exceed the total positive posted quantity of {3}.&quot;,
                                        ITEM_ResourceText, itemIdentifierText, str_userPostedQty, str_PositivePostedQty);

                    return false;
                }
            }

            return true;
        }

        protected void btnSavePosting_Click(object sender, EventArgs e)
        {

            if (Mode != ModeTypes.View)
            {
                DataSet dsDWR = GetDWRDetails();
                savedPostinsIDs = new List&lt;int&gt;();
                DateTime IPDate = DateTime.UtcNow;

                if (Page.IsPostBack &amp;&amp; hdnMWGridData.Value != string.Empty)
                {
                    DataTable dt = new DataTable();
                    try
                    {
                        JArray array = JArray.Parse(hdnMWGridData.Value);
                        dt = JsonConvert.DeserializeObject&lt;DataTable&gt;(array.ToString());
                        
                        List&lt;int&gt; itemIdList = new List&lt;int&gt;();

                        foreach (DataRow row in dt.Rows)
                        {
                            int itemId_Out = 0;
                            string itemIdString = row[&quot;ItemID&quot;].ToString();

                            if (itemIdString != &quot;&amp;nbsp;&quot; &amp;&amp; !string.IsNullOrEmpty(itemIdString) &amp;&amp; int.TryParse(itemIdString, out itemId_Out))
                                itemIdList.Add(itemId_Out);

                            if (!string.IsNullOrEmpty(GetCellTextValue(row, &quot;PostedDate&quot;).ToString()))
                            {
                                IPDate = GetCellTextValue(row, &quot;PostedDate&quot;).ToUtc();
                                if (IPDate.Date &gt; MWDateTimeHelper.UtcNow.Date)
                                {
                                    ShowError(&quot;Posted date cannot be future date!&quot;);
                                    return;
                                }
                            }

                        }
                        itemIdList = itemIdList.Distinct().ToList&lt;int&gt;();
                        Dictionary&lt;int, ITMPOSTBL.PostedItemDto&gt; lookupPostedItems = ITMPOSTBL.Instance.GetApprovedPostedQtyForItemsInDWR(itemIdList, ContractID);

                        #region Validation block : First validate all records
                        Dictionary&lt;int,string&gt; errorList = new Dictionary&lt;int, string&gt;();
                        Dictionary&lt;int, decimal&gt; postedQty = new Dictionary&lt;int, decimal&gt;();

                        foreach (DataRow row in dt.Rows)
                        {
                            int itemId_Out = 0;
                            string itemIdString = row[&quot;ItemID&quot;].ToString();

                            if (itemIdString != &quot;&amp;nbsp;&quot; &amp;&amp; !string.IsNullOrEmpty(itemIdString) &amp;&amp; int.TryParse(itemIdString, out itemId_Out))
                            {
                                string itemIdentifier = row[&quot;StandardItemNo&quot;].ToString();

                                decimal totalQty = GetCellTextValue(row, &quot;Quantity&quot;).ToDecimal2();
                                
                                string errorMsg = string.Empty;
                                string postedQtyVal = GetCellTextValue(row, &quot;PostedQty&quot;);
                                decimal decPostedQty = 0;
                                if(postedQtyVal != &quot;&quot; &amp;&amp; decimal.TryParse(postedQtyVal,out decPostedQty) &amp;&amp; decPostedQty &lt;0)
                                {
                                    if (postedQty.ContainsKey(itemId_Out))
                                        postedQty[itemId_Out] += decPostedQty;
                                    else postedQty.Add(itemId_Out, decPostedQty);
                                }
                                

                                if (!IsValidatePostedQtyForItem(lookupPostedItems, itemId_Out, itemIdentifier, postedQty, totalQty, out errorMsg)) {
                                    if (errorList.ContainsKey(itemId_Out)) errorList[itemId_Out] = errorMsg; 
                                    else errorList.Add(itemId_Out, errorMsg);
                                }
                            }
                        }

                        if (errorList.Any())
                        {
                            ShowError(string.Join(&quot;,&quot;, errorList));
                            return;
                        }

                        #endregion Validation block : First validate all records

                        //This is not required on save. It is required on &quot;Approve&quot; workflow action only
                        //bool isAllowPostBeyondContractQuantity = ContBL.Instance.DWRSettings_Check_IsAllowPostBeyondContractQuantity(PID, ContractID);
                        bool ShowSuccessMessageFlag = false;
                        foreach (DataRow row in dt.Rows)
                        {
                            ////Skipping all activities
                            //if (row.Table.Columns.Contains(&quot;ActivityID&quot;))
                            //    continue;
                            int postingID = 0;
                            int.TryParse(GetCellTextValue(row, &quot;ID&quot;), out postingID);
                            if (postingID &lt; 0)
                                postingID = 0;

                            if (!GetCellTextValue(row, &quot;Status&quot;).Equals(&quot;A&quot;) &amp;&amp; !savedPostinsIDs.Contains(postingID))
                            {
                                int ItemID = 0;
                                int.TryParse(GetCellTextValue(row, &quot;ItemID&quot;), out ItemID);
                                int SubItemID = 0;
                                int.TryParse(GetCellTextValue(row, &quot;SubItemID&quot;), out SubItemID);
                                UserDetail ud = UserDetail.GetCurrentUserDetail();
                                DTOItemPosting dto = new DTOItemPosting();
                                if (postingID &gt; 0)
                                    dto.Postings.PostingID = postingID;
                                if (SubItemID &gt; 0)
                                    dto.Postings.SubItemID = SubItemID;
                                dto.ID = ItemID;
                                dto.ContractID = ContractID;
                                dto.Postings.PostingID = postingID;
                                dto.Postings.Remarks = GetCellTextValue(row, &quot;Remarks&quot;);
                                dto.Postings.Status = GetCellTextValue(row, &quot;Status&quot;);
                                dto.Postings.ToStn = GetCellTextValue(row, &quot;ToStn&quot;);
                                dto.Postings.FromStn = GetCellTextValue(row, &quot;FromStn&quot;);
                                dto.Postings.Attention = GetCellTextValue(row, &quot;Attention&quot;).ToString2().ToLower2().Equals(&quot;true&quot;) ? &quot;Y&quot; : &quot;N&quot;;
                                dto.Postings.BidItemComplete = GetCellTextValue(row, &quot;IsComplete&quot;).ToString2().ToLower2().Equals(&quot;true&quot;) ? &quot;Y&quot; : &quot;N&quot;;

                                if (GetCellTextValue(row, &quot;PercentComplete&quot;) == &quot;&quot;)
                                    dto.Postings.PercentComplete = 0;
                                else
                                    dto.Postings.PercentComplete = decimal.Parse(GetCellTextValue(row, &quot;PercentComplete&quot;));

                                if (GetCellTextValue(row, &quot;PostedQty&quot;) == &quot;&quot;)
                                    dto.Postings.PostedQty = 0;
                                else
                                    dto.Postings.PostedQty = decimal.Parse(GetCellTextValue(row, &quot;PostedQty&quot;));

                                dto.Postings.QtyRemaining = 0;
                                dto.Postings.QtyPlacedToDate = 0;
                                dto.Postings.PostedBy = ud.UID;

                                if (dsDWR != null &amp;&amp; dsDWR.Tables[0].Rows.Count &gt; 0)
                                {
                                    DataRow drDWR = dsDWR.Tables[0].Rows[0];
                                    if (!drDWR[&quot;WorkOrderID&quot;].Equals(DBNull.Value))
                                    {
                                        dto.Postings.WOID = drDWR[&quot;WorkOrderID&quot;].ToInt32_2();
                                        dto.Postings.WorkOrderNo = drDWR[&quot;WorkOrderNo&quot;].ToString2();
                                    }
                                    dto.Postings.DWRID = DWRID.Value;
                                    if (!drDWR[&quot;ContractorValueType&quot;].Equals(DBNull.Value))
                                    {
                                        string hdnCONTID = drDWR[&quot;ContractorValueType&quot;].ToString2();
                                        //------------------CHECK THIS CONTRACTORID FORMAT
                                        string[] strContr = hdnCONTID.Split(&#39;,&#39;);
                                        dto.Postings.ContractorID = strContr[0].ToInt32_2();
                                        dto.Postings.ContractorType = strContr[1];
                                    }
                                    else
                                    {
                                        dto.Postings.ContractorID = null;
                                        dto.Postings.ContractorType = null;
                                    }
                                }
                                else
                                {
                                    dto.Postings.ContractorID = null;
                                    dto.Postings.ContractorType = null;
                                }
                                if (!string.IsNullOrEmpty(GetCellTextValue(row, &quot;PostedDate&quot;).ToString()))
                                    IPDate = GetCellTextValue(row, &quot;PostedDate&quot;).ToUtc();
                                dto.Postings.PostedDate = IPDate;
                                DataSet ds = ComponentHelper.Instance.ExecuteDataSet(ItemPostingStoredProcedure.usp_CONTMGTGetItemPosting,
                                                                                     null,
                                                                                     new object[] { ContractID, ItemID, postingID, Mode.ToString(), dto.Postings.WOID });
                                if (ds.Tables[0].Rows.Count &gt; 0 &amp;&amp; ds.Tables[0].Rows[0][&quot;Status&quot;].ToString() == &quot;A&quot;)
                                {
                                    //row[&quot;PostingID&quot;].Text = PostingID;
                                }
                                else
                                {
                                    int newPostingID = ITMPOSTBL.Instance.CreatePosting(dto, (postingID &gt; 0) ? Mode.ToString() : &quot;New&quot;, ud.UserName, ud.UserID);
                                    if (newPostingID == -1)
                                        throw new Exception(string.Format(&quot;Cannot update the {0} Posting. The {0} Posting has been deleted.&quot;, ITEM_ResourceText));
                                    if (newPostingID == -2)
                                        throw new Exception(string.Format(&quot;Cannot update the {0} Posting. The {0} Posting has already been Approved.&quot;, ITEM_ResourceText));

                                    if (dto.ID.HasValue &amp;&amp; dto.Postings.PostingID.GetValueOrDefault(0) == 0)
                                    {
                                        row[&quot;PostingID&quot;] = newPostingID.ToString();
                                        postingID = newPostingID;
                                        var sParams = new string[] { };
                                        StartWorkflowInstancesFor.SimulateWorkflowAction(true, false, &quot;XITMPOS&quot;, postingID.ToString(), ContractID.ToString2(),
                                         PID.ToString(), &quot;New IP Created&quot;, &quot;None&quot;, 1, &quot;&quot;, sParams);

                                        //ItemManager.Instance.CopyRateAnalysisFromSrcItem(Constants.MODID_CONTMGT, ContractID,
                                        //                                                 dto.ID.GetValueOrDefault(0), ModuleID, newPostingID,
                                        //                                                 dto.ID.GetValueOrDefault(0), false);
                                    }
                                    savedPostinsIDs.Add(postingID);
                                    UpdateActivities(postingID, row[&quot;ID&quot;].ToInt32_2(), SubItemID, dto.Postings.PostedQty, dt);
                                    ShowSuccessMessageFlag = true;
                                }

                                dto.ItemPostingNo = postingID.ToString();
                            }
                        }
                        if(ShowSuccessMessageFlag)
                            ShowSuccess(&quot;Posting Saved Successfully.&quot;);
                    }
                    catch (Exception ex)
                    {
                        AMP3.Logging.Logger.Log(&quot;ItemPosting&quot;, ex);
                        dt = new DataTable();
                        hdnMWGridData.Value = string.Empty;
                        ViewState[&quot;ItemPostingsInGrid&quot;] = null;
                        ShowError(&quot;Error Occurred While Saving Posting.&quot;);
                    }
                }
            }

            LoadGrid(true, null);
        }

        private void UpdateActivities(int PostingID, int ID, int SubItemID, decimal? itemPostedQty, DataTable dt)
        {
            foreach (DataRow row in dt.Rows)
            {
                int ActivityID = 0;
                int.TryParse(row[&quot;ActivityID&quot;].ToString(), out ActivityID);
                int SubItemID1 = 0;
                int.TryParse(row[&quot;SubItemID&quot;].ToString(), out SubItemID1);

                if (row[&quot;ActivityID&quot;] != null &amp;&amp; Convert.ToInt32(row[&quot;ID&quot;].ToString()) == ID &amp;&amp; SubItemID1 == SubItemID)
                {
                    Aurigo.AMP3.Core.BusinessLayer.DTO.Activity dto = new Aurigo.AMP3.Core.BusinessLayer.DTO.Activity();
                    if (ActivityID &gt; 0)
                        dto.ActivityID = ActivityID;

                    dto.Description = (row[&quot;ADescription&quot;] != null &amp;&amp; &quot;&amp;nbsp;&quot; != row[&quot;ADescription&quot;].ToString() &amp;&amp; &quot;&quot; != row[&quot;ADescription&quot;].ToString())
                                          ? row[&quot;ADescription&quot;].ToString()
                                          : row[&quot;Description&quot;].ToString();

                    dto.Name = (row[&quot;AName&quot;] != null &amp;&amp; &quot;&amp;nbsp;&quot; != row[&quot;AName&quot;].ToString() &amp;&amp; &quot;&quot; != row[&quot;AName&quot;].ToString())
                                   ? row[&quot;AName&quot;].ToString()
                                   : row[&quot;StandardItemNo&quot;].ToString();

                    dto.ModuleID = ModuleID;
                    row[&quot;PostingID&quot;] = PostingID.ToString();
                    dto.ParentInstanceID = PostingID;
                    dto.ItemID = Convert.ToInt32(row[&quot;ItemID&quot;].ToString());

                    if (row[&quot;IsComplete&quot;].ToString() == &quot;&amp;nbsp;&quot; || (row[&quot;IsComplete&quot;] != null &amp;&amp; row[&quot;IsComplete&quot;].ToString() == &quot;false&quot;))
                        dto.IsComplete = false;

                    else if (row[&quot;IsComplete&quot;] != null &amp;&amp; row[&quot;IsComplete&quot;].ToString() == &quot;true&quot;)
                        dto.IsComplete = true;

                    dto.Percentage = (row[&quot;Percentage&quot;] != null &amp;&amp; &quot;&amp;nbsp;&quot; != row[&quot;Percentage&quot;].ToString() &amp;&amp; &quot;&quot; != row[&quot;Percentage&quot;].ToString())
                                      ? Convert.ToDecimal(row[&quot;Percentage&quot;].ToDecimal2()) : 100;

                    dto.ReferenceActivityID = (row[&quot;ReferenceActivityID&quot;] != null &amp;&amp; &quot;&amp;nbsp;&quot; != row[&quot;ReferenceActivityID&quot;].ToString() &amp;&amp; &quot;&quot; != row[&quot;ReferenceActivityID&quot;].ToString())
                    ? Convert.ToInt32(row[&quot;ReferenceActivityID&quot;].ToString()) : ActivityID;


                    dto.UnitID = (row[&quot;AUnitID&quot;] != null &amp;&amp; &quot;&amp;nbsp;&quot; != row[&quot;AUnitID&quot;].ToString() &amp;&amp; &quot;&quot; != row[&quot;AUnitID&quot;].ToString())
                                     ? Convert.ToInt32(row[&quot;AUnitID&quot;].ToString()) : 0;

                    dto.Unit = (row[&quot;AUnit&quot;] != null) ? row[&quot;AUnit&quot;].ToString() : String.Empty;

                    if (!string.IsNullOrEmpty(row[&quot;Number&quot;].ToString2()) &amp;&amp; row[&quot;Number&quot;].ToString() != &quot;&amp;nbsp;&quot;)
                        dto.Number = Convert.ToDecimal(row[&quot;Number&quot;].ToString());

                    if (!string.IsNullOrEmpty(row[&quot;Dimension1&quot;].ToString2()) &amp;&amp; row[&quot;Dimension1&quot;].ToString() != &quot;&amp;nbsp;&quot;)
                        dto.Dimension1 = Convert.ToDecimal(row[&quot;Dimension1&quot;].ToString());

                    if (!string.IsNullOrEmpty(row[&quot;Dimension2&quot;].ToString2()) &amp;&amp; row[&quot;Dimension2&quot;].ToString() != &quot;&amp;nbsp;&quot;)
                        dto.Dimension2 = Convert.ToDecimal(row[&quot;Dimension2&quot;].ToString());

                    if (!string.IsNullOrEmpty(row[&quot;Dimension3&quot;].ToString2()) &amp;&amp; row[&quot;Dimension3&quot;].ToString() != &quot;&amp;nbsp;&quot;)
                        dto.Dimension3 = Convert.ToDecimal(row[&quot;Dimension3&quot;].ToString());

                    if (CoreModuleComponents.Contains(&quot;Activities&quot;))
                    {
                        decimal number = dto.Number == null ? 0 : row[&quot;Number&quot;].ToDecimal2();
                        decimal dim1 = dto.Dimension1 == null ? 0 : row[&quot;Dimension1&quot;].ToDecimal2();
                        decimal dim2 = dto.Dimension2 == null ? 0 : row[&quot;Dimension2&quot;].ToDecimal2();
                        decimal dim3 = dto.Dimension3 == null ? 0 : row[&quot;Dimension3&quot;].ToDecimal2();
                        dto.Quantity = number * (dim1 == 0 ? 1 : dim1) * (dim2 == 0 ? 1 : dim2) * (dim3 == 0 ? 1 : dim3);
                    }
                    else
                        dto.Quantity = itemPostedQty ?? 0;
                    dto.IsAfterLock = false;

                    int newActivityID = ItemManager.Instance.SaveActivity(dto);
                    if (ActivityID == 0 &amp;&amp; newActivityID &gt; 0)
                    {
                        row[&quot;ActivityID&quot;] = newActivityID.ToString();
                        row[&quot;RowNum&quot;] = &quot;{0}-{1}-{2}&quot;.Format2(row[&quot;ItemID&quot;].ToString(), SubItemID, newActivityID);// ItemID-SubItemID-ActivityID
                    }
                }
            }
        }

        protected void btnAddItems_Click(object sender, EventArgs e)
        {
        }

        protected void btnAddItemsFromLast_Click(object sender, EventArgs e)
        {
            // If grid is not empty just skip.
            if (MWDataGrid.Items.Count &gt; 0)
            {
                ShowError(&quot;Cannot add &quot; + LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR) + &quot;s from previous DPR.Record(s) already exists&quot;);
                return;
            }
            else
                FillItemPostingGridWithItems(GetPreviousDPRItems());
        }

        protected override void OnPreRender(EventArgs e)
        {
            PageBase.MainToolBar.Visible = !hdnHideToolBar.Value.Equals(&quot;True&quot;);
            base.OnPreRender(e);
        }

        private DataTable GetItemPostings()
        {
            DataSet ds = ITMPOSTBL.Instance.GetIPsByDWRID(ContractID, DWRID);

            _ItemPostingsSchema = ds.Tables[0].Clone();

            _ItemPostingsSchema.Columns[&quot;IsComplete&quot;].DataType = typeof(System.Boolean);
            _ItemPostingsSchema.Columns[&quot;Attention&quot;].DataType = typeof(System.Boolean);
            _ItemPostingsSchema.Columns[&quot;PostedDate&quot;].DataType = typeof(System.DateTime);
            _ItemPostingsSchema.Columns[&quot;RemainingQty&quot;].DataType = typeof(System.Decimal);
            _ItemPostingsSchema.Columns[&quot;PostedQty&quot;].DataType = typeof(System.Decimal);

            DataTable dtNew = _ItemPostingsSchema;

            foreach (DataRow row in ds.Tables[0].Rows)
            {
                DataRow dr = dtNew.NewRow();
                foreach (DataColumn dc in dtNew.Columns)
                {
                    if (dc.ColumnName == &quot;IsComplete&quot; &amp;&amp; row[&quot;IsComplete&quot;].ToString() == &quot;N&quot;)
                        dr[&quot;IsComplete&quot;] = false;

                    else if (dc.ColumnName == &quot;IsComplete&quot; &amp;&amp; row[&quot;IsComplete&quot;].ToString() == &quot;Y&quot;)
                        dr[&quot;IsComplete&quot;] = true;

                    else if (dc.ColumnName == &quot;Attention&quot; &amp;&amp; row[&quot;Attention&quot;].ToString() == &quot;N&quot;)
                        dr[&quot;Attention&quot;] = false;

                    else if (dc.ColumnName == &quot;Attention&quot; &amp;&amp; row[&quot;Attention&quot;].ToString() == &quot;Y&quot;)
                        dr[&quot;Attention&quot;] = true;

                    else
                        dr[dc.ColumnName] = row[dc.ColumnName];
                }
                dtNew.Rows.Add(dr);
            }

            return dtNew;
        }

        private DataTable LoadPostings()
        {
            // if activity component is enabled - we need to insert items before activities
            //if (CoreModuleComponents.Contains(&quot;Activities&quot;))
            {
                DataTable dtItemPostings = GetItemPostings();
                DataTable postingItemsSchema = dtItemPostings.Clone();

                UserDetail ud = UserDetail.GetCurrentUserDetail();
                bool isActivities = CoreModuleComponents.Contains(&quot;Activities&quot;);
                bool hasSubItem = false;
                DataTable dtSubItems = new DataTable();

                dtSubItems.Columns.AddRange(new DataColumn[] {
                    new DataColumn(&quot;SubItemID&quot;),
                    new DataColumn(&quot;Description&quot;),
                    new DataColumn(&quot;Quantity&quot;)
                });

                foreach (DataRow drPosting in dtItemPostings.Select())
                {
                    //Create Posting DTO
                    Posting dtoPosting = new Posting();
                    dtoPosting.PostingID = drPosting[&quot;PostingID&quot;].ToInt32_2();
                    dtoPosting.PostedDate = drPosting[&quot;PostedDate&quot;].ToMWDateTime();
                    dtoPosting.PostedQty = drPosting[&quot;PostedQty&quot;].ToDecimal2();
                    dtoPosting.MBookQty = drPosting.Table.Columns.Contains(&quot;MBookQty&quot;) ? drPosting[&quot;MBookQty&quot;].Equals(DBNull.Value) ? (decimal?)null : drPosting[&quot;MBookQty&quot;].ToDecimal2() : (decimal?)null;
                    dtoPosting.Remarks = drPosting[&quot;Remarks&quot;].ToString2();
                    dtoPosting.FromStn = drPosting[&quot;FromStn&quot;].ToString2();
                    dtoPosting.ToStn = drPosting[&quot;ToStn&quot;].ToString2();
                    dtoPosting.Status = drPosting[&quot;Status&quot;].ToString2();
                    dtoPosting.PercentComplete = drPosting[&quot;PercentComplete&quot;].ToDecimal2();
                    dtoPosting.BidItemComplete = drPosting[&quot;IsComplete&quot;].ToString2();
                    dtoPosting.Attention = drPosting[&quot;Attention&quot;].ToString2();
                    dtoPosting.SubItemID = drPosting[&quot;SubItemID&quot;].ToInt32_2();
                    dtoPosting.Cost = drPosting[&quot;Cost&quot;].ToDecimal2();
                    dtoPosting.UnitCost = drPosting[&quot;UnitCost&quot;].ToDecimal2();
                    dtoPosting.NegativeApprovedPostedQuantity = drPosting[&quot;NegativeApprovedPostedQuantity&quot;].ToDecimal2();
                    dtoPosting.PositiveApprovedPostedQuantity = drPosting[&quot;PositiveApprovedPostedQuantity&quot;].ToDecimal2();
                    //drPosting.FillDTO(dtoPosting);

                    //Create Item DTO
                    Item dtoItem = new Item();
                    //drPosting.FillDTO(dtoItem);
                    dtoItem.ItemID = drPosting[&quot;ItemID&quot;].ToInt32_2();
                    dtoItem.StandardItemNo = drPosting[&quot;StandardItemNo&quot;].ToString2();
                    dtoItem.Description = drPosting[&quot;Description&quot;].ToString2();
                    dtoItem.Quantity = drPosting[&quot;Quantity&quot;].ToDecimal2();
                    dtoItem.Unit = drPosting[&quot;Unit&quot;].ToString2();
                    dtoItem.UnitID = drPosting[&quot;UnitID&quot;].ToInt32_2();
                    dtoItem.LineNo = drPosting[&quot;LineNo&quot;].ToInt32_2();
                    dtoItem.IsNonContract = drPosting[&quot;IsNonContract&quot;].ToBoolean2();

                    DataRow drSubItem = dtSubItems.NewRow();
                    hasSubItem = false;

                    if (drPosting[&quot;SubItemID&quot;] != null &amp;&amp; drPosting[&quot;SubItemID&quot;].ToString2() != &quot;0&quot;)
                    {
                        hasSubItem = true;
                        drSubItem[&quot;SubItemID&quot;] = drPosting[&quot;SubItemID&quot;];
                        drSubItem[&quot;Description&quot;] = drPosting[&quot;SubItem&quot;];
                        drSubItem[&quot;Quantity&quot;] = drPosting[&quot;SubItemQuantity&quot;];
                    }

                    DataRow itemPostingDataRow = postingItemsSchema.NewRow();
                    AddPostingsToGrid(ud, isActivities, dtoItem, dtoPosting, hasSubItem ? new DataRow[] { drSubItem } : null, ref itemPostingDataRow);
                    postingItemsSchema.Rows.Add(itemPostingDataRow);
                }

                return postingItemsSchema;
            }
        }

        public bool LoadGrid(bool showItemColumns, DataTable knownItemPostingFrom = null)
        {
            bool rtnValue = true;
            bool IsEdit = Mode != ModeTypes.View;
            try
            {
                DataTable itemPostings = knownItemPostingFrom ?? LoadPostings();

                ViewState[&quot;ItemPostingsInGrid&quot;] = itemPostings;

                MWDataGrid.DataSource = itemPostings;
                MWDataGrid.DataBind();

                List&lt;string&gt; contractModuleComponenets = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CONTMGT);
                List&lt;string&gt; coreCmpnts = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);

                //if (CoreModuleComponents.Contains(&quot;RateAnalysis&quot;) &amp;&amp; contractModuleComponenets.Contains(&quot;IPResConsumption&quot;))
                //{
                //    cols.Add(&quot;IPResConsumption&quot;);
                //    cols.FromKey(&quot;IPResConsumption&quot;).Type = ColumnType.Button;
                //    cols.FromKey(&quot;IPResConsumption&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Center;
                //    cols.FromKey(&quot;IPResConsumption&quot;).Header.Caption = &quot;Resource&quot;;
                //    cols.FromKey(&quot;IPResConsumption&quot;).Width = new Unit(&quot;80px&quot;);
                //    gridPostings.DisplayLayout.ClientSideEvents.ClickCellButtonHandler = &quot;IPControl_GridClickCellButton&quot;;
                //}


                // RIGHT ALLIGN 
                string[] NumericColumns = { &quot;Percentage&quot;, &quot;Quantity&quot;, &quot;Original Quantity&quot;, &quot;Number&quot;, &quot;Dimension1&quot;, &quot;Dimension2&quot;, &quot;Dimension3&quot;, &quot;RemainingQty&quot;, &quot;MBookQty&quot; };

                foreach (string column in NumericColumns)
                {
                    if (MWDataGrid.MasterTableView.GetColumnSafe(column) != null)
                    {
                        MWDataGrid.MasterTableView.GetColumnSafe(column).HeaderStyle.HorizontalAlign = HorizontalAlign.Right;
                        MWDataGrid.MasterTableView.GetColumnSafe(column).ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        //cols.FromKey(column).Format = (column.Equals(&quot;Percentage&quot;)) ? &quot;##0.00&quot; : AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                    }
                }


                // ADD ALL THE HIDDEN COLUMNS&#39; NAMES TO THE FOLLOWING LIST 
                var columnsToHide = new List&lt;string&gt;(new[]
                        {
                            &quot;ID&quot;,
                            &quot;ItemID&quot;,
                            &quot;SubItemID&quot;,
                            &quot;PostingID&quot;,
                            &quot;ContractID&quot;,
                            &quot;IsNonContract&quot;,
                            &quot;Status&quot;,
                            &quot;OriginalQuantity&quot;,
                            &quot;OriginalPostedQty&quot;,
                            &quot;AQuantity&quot;,
                            &quot;ADescription&quot;,
                            &quot;AName&quot;,
                            &quot;AUnitID&quot;,
                            &quot;AUnit&quot;,
                            &quot;AIsComplete&quot;,
                            &quot;ActivityID&quot;,
                            &quot;ReferenceActivityID&quot;,
                            &quot;UserName&quot;,
                            &quot;RowNum&quot;,
                            &quot;UnitID&quot;,
                            &quot;PercentComplete&quot;,
                            &quot;SubItemQuantity&quot;,
                            &quot;NegativeApprovedPostedQuantity&quot;,
                            &quot;PositiveApprovedPostedQuantity&quot;
                        });

                // Is Posted Date Is Work Date.
                if (coreCmpnts.Contains(&quot;PostedDateIsWorkDate&quot;))
                {
                    columnsToHide.AddRange(new List&lt;string&gt;() { &quot;PostedDate&quot; });
                }

                //Set this to true if we have to show all item related columns such as Name, Description etc. 
                //Set this to false if we have to show only basic columns such as Original Quantity, Remaining quantity and Posting Quantity.
                if (!showItemColumns)
                    columnsToHide.AddRange(new[] { &quot;StandardItemNo&quot;, &quot;Description&quot;, &quot;Unit&quot;, &quot;SubItem&quot;, &quot;Quantity&quot;, &quot;RemainingQty&quot; });

                if (MWDataGrid.MasterTableView.GetColumnSafe(&quot;Percentage&quot;) != null &amp;&amp; !CoreModuleComponents.Contains(&quot;Activities&quot;))
                    columnsToHide.Add(&quot;Percentage&quot;);
                if (MWDataGrid.MasterTableView.GetColumnSafe(&quot;SubItem&quot;) != null &amp;&amp; !CoreModuleComponents.Contains(&quot;SubItems&quot;))
                    columnsToHide.Add(&quot;SubItem&quot;);
                if (!CoreModuleComponents.Contains(&quot;RateAnalysis&quot;))
                    columnsToHide.AddRange(new string[] { &quot;IPResConsumption&quot; });

                if (CoreModuleComponents.Contains(&quot;Activities&quot;))
                {
                    // gridPostings.DisplayLayout.ClientSideEvents.AfterExitEditModeHandler = &quot;gridPostings_AfterExitEditMode&quot;;
                }

                if (!CoreModuleComponents.Contains(&quot;ItemNumber&quot;))
                    columnsToHide.Add(&quot;Number&quot;);
                if (!CoreModuleComponents.Contains(&quot;ItemDimension1&quot;))
                    columnsToHide.Add(&quot;Dimension1&quot;);
                if (!CoreModuleComponents.Contains(&quot;ItemDimension2&quot;))
                    columnsToHide.Add(&quot;Dimension2&quot;);
                if (!CoreModuleComponents.Contains(&quot;ItemDimension3&quot;))
                    columnsToHide.Add(&quot;Dimension3&quot;);
                if (!contractModuleComponenets.Contains(&quot;AddMeasurementBook&quot;))
                    columnsToHide.Add(&quot;MBookQty&quot;);

                foreach (var col in columnsToHide)
                {
                    if (MWDataGrid.MasterTableView.GetColumnSafe(col) != null)
                        MWDataGrid.MasterTableView.GetColumnSafe(col).Display = false;
                }

                if (IsEdit)
                {
                    List&lt;string&gt; editableCols = _editableColumnsOfItemPosting.ToList();//this will clone this list
                    List&lt;string&gt; nonEditableCols = new List&lt;string&gt;(new[] { &quot;LineNo&quot;, &quot;StandardItemNo&quot;, &quot;Description&quot;, &quot;SubItem&quot;, &quot;Quantity&quot;, &quot;RemainingQty&quot;, &quot;UnitDim1&quot;, &quot;UnitDim2&quot;, &quot;UnitDim3&quot;, &quot;Unit&quot; });
                    List&lt;string&gt; numericEditableCols = new List&lt;string&gt;(new[] { &quot;Number&quot;, &quot;Dimension1&quot;, &quot;Dimension2&quot;, &quot;Dimension3&quot;, &quot;PercentComplete&quot; });

                    if (!CoreModuleComponents.Contains(&quot;Activities&quot;) &amp;&amp; !CoreModuleComponents.Contains(&quot;ItemNumber&quot;))
                        editableCols.Add(&quot;PostedQty&quot;);

                    foreach (string nonEditableCol in nonEditableCols)
                    {
                        GridColumn nonEdiColumn = MWDataGrid.MasterTableView.GetColumnSafe(nonEditableCol);
                        if (nonEdiColumn != null)
                        {
                            (nonEdiColumn as GridBoundColumn).ReadOnly = true;
                        }
                    }

                    foreach (string editableCol in editableCols)
                    {
                        GridColumn ediColumn = MWDataGrid.MasterTableView.GetColumnSafe(editableCol);
                        if (editableCol == &quot;IsComplete&quot; &amp;&amp; ediColumn != null &amp;&amp; ediColumn is GridCheckBoxColumn)
                        {
                            (ediColumn as GridCheckBoxColumn).ItemStyle.BackColor = Color.Yellow;
                        }
                        else if (editableCol == &quot;Attention&quot; &amp;&amp; ediColumn != null &amp;&amp; ediColumn is GridCheckBoxColumn)
                        {
                            (ediColumn as GridCheckBoxColumn).ItemStyle.BackColor = Color.Yellow;
                        }
                        else if (ediColumn != null)
                        {
                            (ediColumn as GridBoundColumn).ItemStyle.BackColor = Color.Yellow;
                        }
                    }
                }
                else
                {
                    List&lt;string&gt; allCols = new List&lt;string&gt;(new[] { &quot;PostedDate&quot;, &quot;Number&quot;, &quot;Dimension1&quot;, &quot;Dimension2&quot;, &quot;Dimension3&quot;, &quot;Remarks&quot;, &quot;FromStn&quot;, &quot;ToStn&quot;, &quot;PercentComplete&quot;, &quot;IsComplete&quot;, &quot;Attention&quot;, &quot;LineNo&quot;, &quot;StandardItemNo&quot;, &quot;Description&quot;, &quot;SubItem&quot;, &quot;Quantity&quot;, &quot;RemainingQty&quot;, &quot;UnitDim1&quot;, &quot;UnitDim2&quot;, &quot;UnitDim3&quot;, &quot;PostedQty&quot; });

                    foreach (string allCol in allCols)
                    {
                        GridColumn Column = MWDataGrid.MasterTableView.GetColumnSafe(allCol);
                        if (allCol == &quot;IsComplete&quot; &amp;&amp; Column != null)
                        {
                            (Column as GridCheckBoxColumn).ReadOnly = true;
                        }
                        else if (allCol == &quot;Attention&quot; &amp;&amp; Column != null)
                        {
                            (Column as GridCheckBoxColumn).ReadOnly = true;
                        }
                        else if (Column != null)
                        {
                            (Column as GridBoundColumn).ReadOnly = true;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                rtnValue = false;
            }
            return rtnValue;
        }

        /// &lt;summary&gt;
        /// Add Activity details to the grid
        /// &lt;/summary&gt;
        private void AddActivityDetailsRowInGrid(DataRow activityDataRow, ref DataRow itemPostingDataRow, int subItemID, decimal coefficient)
        {
            itemPostingDataRow[&quot;StandardItemNo&quot;] = activityDataRow[&quot;Name&quot;];
            itemPostingDataRow[&quot;Description&quot;] = activityDataRow[&quot;Description&quot;];
            itemPostingDataRow[&quot;Percentage&quot;] = activityDataRow[&quot;Percentage&quot;];

            itemPostingDataRow[&quot;Quantity&quot;] = activityDataRow[&quot;Original Quantity&quot;].ToDecimal2() * coefficient;
            itemPostingDataRow[&quot;OriginalQuantity&quot;] = activityDataRow[&quot;Original Quantity&quot;].ToDecimal2();
            itemPostingDataRow[&quot;NegativeApprovedPostedQuantity&quot;] = activityDataRow[&quot;NegativeApprovedPostedQuantity&quot;].ToDecimal2();
            itemPostingDataRow[&quot;PositiveApprovedPostedQuantity&quot;] = activityDataRow[&quot;PositiveApprovedPostedQuantity&quot;].ToDecimal2();
            itemPostingDataRow[&quot;AQuantity&quot;] = activityDataRow[&quot;ItemQuantity&quot;].ToDecimal2();
            itemPostingDataRow[&quot;RemainingQty&quot;] = activityDataRow[&quot;RemainingQty&quot;];
            itemPostingDataRow[&quot;AUnitID&quot;] = activityDataRow[&quot;UnitID&quot;];
            itemPostingDataRow[&quot;RowNum&quot;] = &quot;{0}-{1}-{2}&quot;.Format2(itemPostingDataRow[&quot;ItemID&quot;], subItemID, activityDataRow[&quot;ActivityID&quot;]);

            if (itemPostingDataRow[&quot;ID&quot;].ToInt32_2() &gt; 0)
            {
                itemPostingDataRow[&quot;ReferenceActivityID&quot;] = activityDataRow[&quot;ReferenceActivityID&quot;];
                itemPostingDataRow[&quot;ActivityID&quot;] = activityDataRow[&quot;ActivityID&quot;]; ;
            }
            else
            {
                itemPostingDataRow[&quot;ReferenceActivityID&quot;] = activityDataRow[&quot;ActivityID&quot;];
                itemPostingDataRow[&quot;ActivityID&quot;] = 0;
            }
        }

        private void ShowDiv(ItemDivEnums divType)
        {
            DivPosting.Visible = (ItemDivEnums.CreatePosting == divType);
            DivRateAnalysis.Visible = (ItemDivEnums.RateAnalysis == divType);
            hdnHideToolBar.Value = &quot;False&quot;;
            switch (divType)
            {
                case ItemDivEnums.CreatePosting:
                    PageBase.PageTitle = Mode + &quot; &quot; + LocalizationManager.GetString(KeyConstants.LOC_ITEM_POSTING);
                    break;
                case ItemDivEnums.RateAnalysis:
                    PageBase.PageTitle = &quot;Resource Consumption&quot;;
                    hdnHideToolBar.Value = &quot;True&quot;;
                    break;
                case ItemDivEnums.ResourcePicker:
                    PageBase.PageTitle = &quot;Select Resource&quot;;
                    break;
            }
        }

        private List&lt;int&gt; GetPostingIDs()
        {
            List&lt;int&gt; postIDs = new List&lt;int&gt;();
            foreach (GridDataItem row in MWDataGrid.Items)
            {
                if (row[&quot;ItemID&quot;] != null)
                    postIDs.Add(row[&quot;ItemID&quot;].Text.ToInt32_2());
            }
            return postIDs;
        }

        protected void mwDataGrid_PreRender(object sender, EventArgs e)
        {
            var grid = sender as RadGrid;
            GridTableView masterTable = (sender as RadGrid).MasterTableView;

            GridNumericColumnEditor gridNumericColumnEditor = null;
            gridNumericColumnEditor = masterTable.GetBatchColumnEditor(&quot;PostedQty&quot;) as GridNumericColumnEditor;

            if (gridNumericColumnEditor != null)
            {
                gridNumericColumnEditor.NumericTextBox.IncrementSettings.InterceptArrowKeys = false;
            }
        }

        protected void mwDataGrid_ColumnCreated(object sender, Telerik.Web.UI.GridColumnCreatedEventArgs e)
        {
            Telerik.Web.UI.GridBoundColumn boundColumn = e.Column as Telerik.Web.UI.GridBoundColumn;
            GridCheckBoxColumn checkBoundColumn = e.Column as GridCheckBoxColumn;
            GridNumericColumn numericBoundColumn = e.Column as GridNumericColumn;

            if (numericBoundColumn != null &amp;&amp; numericBoundColumn is GridNumericColumn)
            {
                if (numericBoundColumn.DataField == &quot;PostedQty&quot;)
                {
                    GridNumericColumn postedQty = (e.Column as GridNumericColumn);
                    postedQty.HeaderText = &quot;Posting Qty&quot;;
                    postedQty.DataType = typeof(System.Decimal);
                    var format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                    postedQty.DecimalDigits = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY);
                    postedQty.DataFormatString = &quot;{0:&quot; + format + &quot;}&quot;;
                }
            }

            if (checkBoundColumn != null &amp;&amp; checkBoundColumn is GridCheckBoxColumn)
            {
                if (checkBoundColumn.DataField == &quot;IsComplete&quot;)
                {
                    (e.Column as GridCheckBoxColumn).HeaderText = &quot;Is Complete ?&quot;;
                    (e.Column as GridCheckBoxColumn).DataType = typeof(System.Boolean);
                }
            }

            if (boundColumn != null &amp;&amp; boundColumn is GridBoundColumn)
            {
                boundColumn.HtmlEncode = true;

                string[] gridColumns = new string[] { &quot;Percentage&quot;, &quot;Weightage %&quot;
                    , &quot;LineNo&quot;,&quot;Line No.&quot;
                    , &quot;Cost&quot; ,&quot;Cost in &quot; + LocalizationManager.GetModuleCurrency(&quot;LIBRARY&quot;, null, Session[&quot;AXCompany&quot;].ToString2())
                    , &quot;SubItem&quot;, &quot;Sub Item&quot;
                    , &quot;Number&quot;, &quot;Posting Number&quot;
                    , &quot;FromStn&quot;, &quot;From Station&quot;
                    , &quot;ToStn&quot; ,&quot;To Station&quot;
                    , &quot;PercentComplete&quot;, &quot;Percent Complete&quot;
                    , &quot;MBookQty&quot;, &quot;Measurement Book Qty&quot;
                    , &quot;Dimension1&quot;, AMP3ApplicationSettings.Instance.Dim1Title
                    , &quot;Dimension2&quot;, AMP3ApplicationSettings.Instance.Dim2Title
                    , &quot;Dimension3&quot;, AMP3ApplicationSettings.Instance.Dim3Title
                    , &quot;UnitDim1&quot;, &quot;Unit &quot; + AMP3ApplicationSettings.Instance.Dim1Title
                    , &quot;UnitDim2&quot;, &quot;Unit &quot; + AMP3ApplicationSettings.Instance.Dim2Title
                    , &quot;UnitDim3&quot;, &quot;Unit &quot; + AMP3ApplicationSettings.Instance.Dim3Title
                    , &quot;UnitCost&quot;, &quot;Unit Cost&quot;
            };

                for (int i = 0; i &lt; gridColumns.Length; i += 2)
                {
                    if (boundColumn.DataField == gridColumns[i])
                        (e.Column as GridBoundColumn).HeaderText = gridColumns[i + 1];
                }

                if (boundColumn.DataField == &quot;PostedDate&quot;)
                {
                    GridBoundColumn PostedDate = (e.Column as GridBoundColumn);
                    PostedDate.HeaderText = &quot;Posted Date&quot;;
                    PostedDate.DataType = typeof(System.DateTime);
                    PostedDate.HeaderStyle.Width = 200;
                    var format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
                    PostedDate.DataFormatString = &quot;{0:&quot; + format + &quot;}&quot;;
                }
                else if (boundColumn.DataField == &quot;StandardItemNo&quot;)
                {
                    (e.Column as GridBoundColumn).HeaderText = LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO_ABBR) +
                     (CoreModuleComponents.Contains(&quot;Activities&quot;) ? &quot;/Activity Name&quot; : &quot;&quot;);
                }
                else if (boundColumn.DataField == &quot;Quantity&quot;)
                {
                    GridBoundColumn Quantity = (e.Column as GridBoundColumn);
                    Quantity.HeaderText = &quot;Total Qty&quot;;
                    Quantity.DataType = typeof(System.Decimal);
                    var format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                    Quantity.DataFormatString = &quot;{0:&quot; + format + &quot;}&quot;;
                }
                else if (boundColumn.DataField == &quot;RemainingQty&quot;)
                {
                    GridBoundColumn RemainingQty = (e.Column as GridBoundColumn);
                    RemainingQty.HeaderText = &quot;Remaining Qty&quot;;
                    RemainingQty.DataType = typeof(System.Decimal);
                    var format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                    RemainingQty.DataFormatString = &quot;{0:&quot; + format + &quot;}&quot;;
                }
            }
        }
    }

    #region ItemDivEnums enum

    public enum ItemDivEnums
    {
        ItemPicker = 1,
        CreatePosting = 2,
        RateAnalysis = 3,
        SubItems = 4,
        ResourcePicker = 5,
        ItemActivity = 6
    }

    #endregion

    /// &lt;summary&gt;
    /// Class to be used when deserializing the hidden field containing edited values of the dataGrid
    /// &lt;/summary&gt;
    internal class ItemPostingEditableObject
    {
        public int ItemID { get; set; }
        public int ID { get; set; }
        public DateTime? PostedDate { get; set; }
        public decimal? PostedQty { get; set; }

        public decimal? Number { get; set; }
        public decimal? Dimension1 { get; set; }
        public decimal? Dimension2 { get; set; }
        public decimal? Dimension3 { get; set; }
        public string Remarks { get; set; }
        public string FromStn { get; set; }
        public string ToStn { get; set; }
        public bool IsComplete { get; set; }
        public bool Attention { get; set; }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[52,13,52,14,1],[54,17,54,60,1],[55,21,55,86,1],[57,17,57,38,0],[59,13,59,14,1],[66,49,66,53,1],[66,54,66,58,1],[68,38,68,39,1],[68,40,68,81,1],[68,82,68,83,1],[69,31,69,32,1],[69,33,69,67,1],[69,68,69,69,1],[70,34,70,35,1],[70,36,70,126,1],[70,127,70,128,1],[71,9,71,45,1],[72,32,72,33,1],[72,34,72,113,1],[72,114,72,115,1],[74,9,74,76,1],[75,47,75,48,1],[75,49,75,120,1],[75,121,75,122,1],[76,44,76,45,1],[76,46,76,117,1],[76,118,76,119,1],[77,9,77,78,1],[78,59,78,60,1],[78,61,78,137,1],[78,138,78,139,1],[87,13,87,14,1],[88,17,88,69,1],[89,21,89,129,1],[90,17,90,80,1],[91,13,91,14,1],[94,9,94,50,1],[99,13,99,14,1],[100,17,100,48,1],[100,49,100,123,1],[101,17,101,43,1],[102,13,102,14,1],[105,9,105,261,1],[108,9,108,10,1],[109,13,109,46,1],[110,13,110,80,1],[112,13,112,223,1],[113,13,113,96,1],[115,13,115,99,1],[117,13,117,28,1],[118,17,118,134,1],[119,9,119,10,1],[122,9,122,10,1],[125,13,125,40,1],[126,13,126,74,1],[127,13,127,32,1],[128,13,128,65,1],[129,13,129,137,1],[131,13,131,106,1],[137,13,137,53,1],[138,13,138,88,1],[139,13,139,59,1],[144,13,144,92,1],[146,13,146,28,1],[147,9,147,10,1],[150,9,150,10,1],[151,13,151,34,1],[152,13,152,45,1],[153,13,153,118,1],[154,13,154,138,1],[155,13,155,85,1],[156,13,156,100,1],[157,13,157,60,1],[158,9,158,10,1],[161,9,161,10,1],[162,13,162,45,1],[163,13,163,46,1],[164,13,164,117,1],[165,13,165,25,1],[166,9,166,10,1],[169,9,169,10,1],[171,18,171,27,1],[171,29,171,42,1],[171,44,171,47,1],[172,13,172,14,1],[173,17,173,103,1],[174,17,174,18,1],[175,21,175,37,1],[176,21,176,25,1],[177,17,177,18,1],[178,17,178,111,1],[179,17,179,18,1],[180,21,180,37,1],[181,21,181,25,1],[182,17,182,18,1],[184,17,184,50,1],[185,17,185,18,1],[186,21,186,37,1],[187,21,187,25,1],[188,17,188,18,1],[189,13,189,14,1],[190,9,190,10,1],[193,9,193,10,1],[194,13,194,103,1],[195,13,195,56,1],[196,13,196,72,1],[197,9,197,10,1],[200,9,200,10,1],[201,13,201,63,1],[202,13,202,78,1],[203,13,203,48,1],[205,13,205,45,1],[206,17,206,35,1],[208,13,208,68,1],[210,13,210,57,1],[211,17,211,88,1],[213,13,213,80,1],[214,13,214,60,1],[215,13,215,14,1],[217,17,217,18,1],[218,21,218,70,1],[219,21,219,132,1],[224,21,224,102,1],[225,21,225,22,1],[226,25,226,32,1],[226,34,226,52,0],[226,53,226,55,1],[226,56,226,75,1],[227,25,227,26,0],[228,29,228,75,0],[229,29,229,67,0],[231,29,231,114,0],[231,114,231,148,0],[231,148,231,167,0],[231,29,231,167,0],[233,29,233,59,0],[234,33,234,42,0],[236,29,236,53,0],[237,29,237,36,0],[237,38,237,61,0],[237,62,237,64,0],[237,65,237,94,0],[238,29,238,30,0],[240,33,240,34,0],[241,37,241,90,0],[242,41,242,50,0],[244,37,244,113,0],[246,37,246,52,0],[247,41,247,50,0],[249,37,249,86,0],[251,37,251,148,0],[252,41,252,50,0],[254,37,254,96,0],[255,37,255,38,0],[256,41,256,81,0],[257,41,257,59,0],[258,37,258,38,0],[259,33,259,34,0],[260,33,260,53,0],[261,33,261,34,0],[262,37,262,80,0],[263,33,263,34,0],[264,29,264,30,0],[266,29,266,44,0],[267,33,267,60,0],[268,25,268,26,0],[269,21,269,22,1],[271,17,271,18,1],[272,17,272,37,0],[273,17,273,18,0],[274,21,274,64,0],[275,17,275,18,0],[276,13,276,14,1],[278,13,278,25,1],[279,13,279,20,1],[279,22,279,34,1],[279,35,279,37,1],[279,38,279,50,1],[280,13,280,14,1],[284,21,284,64,1],[285,21,285,47,1],[286,21,286,144,1],[288,21,288,77,1],[289,21,289,118,1],[290,21,290,68,1],[292,13,292,14,1],[294,13,294,62,1],[296,13,296,52,1],[297,13,297,35,1],[298,9,298,10,1],[304,9,304,10,1],[307,13,307,61,1],[308,13,308,14,0],[310,22,310,33,0],[310,35,310,58,0],[310,60,310,65,0],[311,17,311,18,0],[312,21,312,137,0],[313,17,313,18,0],[314,13,314,14,0],[316,13,316,14,1],[318,17,318,122,1],[319,13,319,14,1],[320,9,320,10,1],[327,9,327,10,1],[329,13,329,94,1],[331,13,331,41,1],[331,43,331,54,1],[331,56,331,71,1],[331,73,331,84,1],[332,13,332,94,1],[333,13,333,144,1],[335,13,335,98,1],[337,13,338,131,1],[341,13,341,69,1],[342,13,342,14,1],[343,17,343,30,1],[344,17,344,18,0],[345,21,345,96,0],[346,17,346,18,0],[348,17,348,43,1],[349,17,349,18,1],[351,21,351,63,1],[352,21,352,22,1],[354,25,354,62,1],[355,25,357,88,1],[358,21,358,22,1],[360,21,360,22,1],[361,25,363,97,1],[364,21,364,22,1],[365,17,365,18,1],[367,17,367,18,1],[368,21,368,37,1],[369,21,369,33,1],[370,17,370,18,1],[372,22,372,35,1],[372,37,372,68,1],[372,70,372,77,1],[373,17,373,18,1],[376,21,376,174,1],[378,21,378,89,1],[379,25,379,280,1],[383,17,383,18,1],[385,17,385,79,1],[386,21,386,121,1],[388,17,388,71,1],[389,13,389,14,1],[390,9,390,10,1],[396,9,396,10,0],[397,13,397,105,0],[400,13,400,59,0],[401,13,401,69,0],[402,13,402,75,0],[403,13,403,59,0],[404,13,404,55,0],[405,13,405,101,0],[406,13,406,63,0],[407,13,407,67,0],[408,13,408,56,0],[409,13,409,73,0],[410,13,410,48,0],[411,13,411,50,0],[412,13,412,68,0],[413,13,413,61,0],[415,13,415,79,0],[416,17,416,64,0],[418,13,418,66,0],[419,17,419,114,0],[421,17,421,85,0],[422,13,422,67,0],[423,17,423,114,0],[425,17,425,85,0],[426,13,426,46,0],[427,13,427,14,0],[428,17,428,72,0],[429,17,429,80,0],[430,13,430,14,0],[432,13,432,14,0],[433,17,433,64,0],[434,17,434,72,0],[435,13,435,14,0],[437,13,437,71,0],[438,17,438,70,0],[440,13,440,64,0],[441,13,441,64,0],[442,13,442,60,0],[444,13,444,52,0],[445,17,445,84,0],[447,17,447,70,0],[449,13,449,41,0],[450,17,450,62,0],[452,17,452,59,0],[454,13,454,45,0],[455,17,455,70,0],[457,17,457,63,0],[461,13,461,60,0],[462,13,462,61,0],[463,13,463,14,0],[464,17,464,49,0],[465,17,465,69,0],[466,17,466,18,0],[467,21,467,61,0],[468,21,468,65,0],[469,21,469,22,0],[470,25,470,71,0],[471,21,471,22,0],[472,17,472,18,0],[473,13,473,14,0],[475,13,475,43,0],[476,13,476,14,0],[479,17,479,63,0],[480,17,480,58,0],[481,17,481,57,0],[482,13,482,14,0],[484,13,484,14,0],[485,17,485,97,0],[486,17,486,44,0],[487,17,487,18,0],[488,21,488,115,0],[489,21,489,108,0],[490,17,490,18,0],[492,17,492,18,0],[493,21,493,115,0],[494,21,494,108,0],[495,17,495,18,0],[496,13,496,14,0],[497,13,497,35,0],[498,13,498,14,0],[500,17,500,74,0],[501,17,501,74,0],[502,17,502,72,0],[503,17,503,108,0],[504,13,504,14,0],[505,9,505,10,0],[508,9,508,10,0],[509,13,509,52,0],[510,13,510,142,0],[512,13,512,46,0],[513,13,513,14,0],[514,17,514,59,0],[515,13,515,14,0],[517,13,517,20,0],[517,22,517,33,0],[517,34,517,36,0],[517,37,517,54,0],[518,13,518,14,0],[519,17,519,39,0],[520,17,520,34,0],[521,17,521,35,0],[522,13,522,14,0],[524,13,524,29,0],[526,9,526,10,0],[532,9,532,10,0],[533,13,533,79,0],[534,13,534,35,0],[535,9,535,10,0],[538,9,538,10,0],[539,13,539,48,0],[541,13,541,59,0],[542,13,542,50,0],[543,17,543,159,0],[544,13,544,80,0],[545,13,545,117,0],[546,13,546,173,0],[547,13,547,61,0],[548,13,548,48,0],[549,13,549,115,0],[550,13,550,134,0],[551,9,551,10,0],[554,9,554,10,0],[555,13,555,144,0],[556,9,556,10,0],[559,9,559,10,0],[560,13,560,49,0],[561,13,561,88,0],[562,13,562,134,0],[563,9,563,10,0],[566,9,566,10,0],[567,13,567,68,0],[568,13,568,75,0],[569,13,569,52,0],[570,17,570,141,0],[571,13,571,20,0],[571,22,571,38,0],[571,39,571,41,0],[571,42,571,58,0],[572,17,572,69,0],[573,13,573,79,0],[575,13,575,57,0],[577,13,577,53,0],[578,13,578,14,0],[579,17,579,66,0],[581,17,581,116,0],[583,17,583,71,0],[585,17,585,79,0],[586,17,586,78,0],[587,17,587,80,0],[588,17,588,81,0],[589,17,589,77,0],[591,17,591,24,0],[591,26,591,37,0],[591,38,591,40,0],[591,41,591,73,0],[592,17,592,18,0],[593,21,593,49,0],[594,21,594,28,0],[594,30,594,43,0],[594,44,594,46,0],[594,47,594,60,0],[595,21,595,22,0],[596,25,596,102,0],[597,29,597,54,0],[599,30,599,106,0],[600,29,600,53,0],[602,30,602,105,0],[603,29,603,53,0],[605,30,605,104,0],[606,29,606,52,0],[609,29,609,68,0],[610,21,610,22,0],[611,21,611,40,0],[612,17,612,18,0],[614,22,614,31,0],[614,33,614,53,0],[614,55,614,58,0],[615,17,615,18,0],[616,26,616,35,0],[616,37,616,57,0],[616,59,616,62,0],[617,21,617,22,0],[618,25,618,52,0],[619,25,619,76,0],[620,25,620,26,0],[621,29,621,41,0],[622,29,622,35,0],[625,21,625,22,0],[626,17,626,18,0],[628,17,628,39,0],[630,17,630,39,0],[631,13,631,14,0],[633,9,633,10,0],[636,9,636,10,1],[637,13,637,34,1],[638,13,638,32,1],[639,13,639,14,1],[640,17,640,143,1],[641,17,641,127,1],[642,13,642,14,1],[643,13,643,26,1],[644,9,644,10,1],[647,9,647,10,0],[649,9,649,10,0],[654,9,654,10,1],[655,13,655,52,1],[656,13,656,14,0],[657,17,657,27,0],[660,13,660,14,1],[661,17,661,47,1],[663,9,663,10,1],[683,9,683,10,1],[686,13,686,33,1],[688,13,688,65,1],[690,13,690,55,1],[691,17,691,66,1],[693,13,693,46,1],[694,17,694,115,1],[712,13,712,80,1],[713,13,713,14,0],[714,17,714,104,0],[715,17,715,86,0],[716,17,716,18,0],[717,21,717,157,0],[718,21,718,178,0],[720,21,721,122,0],[723,21,723,34,0],[725,13,725,14,0],[727,13,727,25,1],[728,9,728,10,1],[731,9,731,10,0],[733,13,733,40,0],[734,13,734,14,0],[735,17,735,49,0],[736,17,736,51,0],[737,17,737,51,0],[739,17,739,76,0],[740,17,740,18,0],[741,21,741,52,0],[743,21,743,22,0],[744,25,744,74,0],[745,25,745,89,0],[747,25,747,64,0],[749,25,749,32,0],[749,34,749,45,0],[749,46,749,48,0],[749,49,749,56,0],[750,25,750,26,0],[751,29,751,48,0],[752,29,752,76,0],[754,29,754,143,0],[755,33,755,60,0],[757,29,757,103,0],[758,29,758,30,0],[759,33,759,86,0],[760,33,760,80,0],[761,33,761,34,0],[762,37,762,85,0],[763,37,763,44,0],[765,29,765,30,0],[767,25,767,26,0],[768,25,768,74,0],[769,25,769,163,0],[772,25,772,90,0],[773,25,773,93,0],[775,25,775,32,0],[775,34,775,45,0],[775,46,775,48,0],[775,49,775,56,0],[776,25,776,26,0],[777,29,777,48,0],[778,29,778,76,0],[780,29,780,143,0],[781,29,781,30,0],[782,33,782,90,0],[784,33,784,99,0],[786,33,786,64,0],[787,33,787,90,0],[788,33,788,58,0],[789,33,789,125,0],[790,33,790,34,0],[791,37,791,75,0],[792,41,792,79,0],[793,42,793,82,0],[794,33,794,34,0],[797,33,797,147,0],[797,148,797,149,0],[798,37,798,75,0],[798,76,798,109,0],[799,42,799,78,0],[800,33,800,34,0],[801,29,801,30,0],[802,25,802,26,0],[804,25,804,45,0],[805,25,805,26,0],[806,29,806,68,0],[807,29,807,36,0],[814,25,814,61,0],[815,25,815,32,0],[815,34,815,45,0],[815,46,815,48,0],[815,49,815,56,0],[816,25,816,26,0],[820,29,820,47,0],[821,29,821,86,0],[822,29,822,47,0],[823,33,823,47,0],[825,29,825,118,0],[826,29,826,30,0],[827,33,827,48,0],[828,33,828,91,0],[829,33,829,51,0],[830,33,830,97,0],[831,33,831,83,0],[832,33,832,75,0],[833,33,833,51,0],[834,37,834,72,0],[835,33,835,51,0],[836,37,836,72,0],[837,33,837,49,0],[838,33,838,61,0],[839,33,839,68,0],[840,33,840,89,0],[841,33,841,87,0],[842,33,842,85,0],[843,33,843,89,0],[844,33,844,143,0],[845,33,845,150,0],[847,33,847,84,0],[848,37,848,70,0],[850,37,850,124,0],[852,33,852,78,0],[853,37,853,64,0],[855,37,855,112,0],[857,33,857,63,0],[858,33,858,66,0],[859,33,859,64,0],[861,33,861,85,0],[862,33,862,34,0],[863,37,863,77,0],[864,37,864,84,0],[865,37,865,38,0],[866,41,866,94,0],[867,41,867,101,0],[868,37,868,38,0],[869,37,869,70,0],[870,37,870,92,0],[871,37,871,38,0],[872,41,872,101,0],[874,41,874,82,0],[875,41,875,93,0],[876,41,876,83,0],[877,37,877,38,0],[879,37,879,38,0],[880,41,880,74,0],[881,41,881,76,0],[882,37,882,38,0],[883,33,883,34,0],[885,33,885,34,0],[886,37,886,70,0],[887,37,887,72,0],[888,33,888,34,0],[889,33,889,107,0],[890,37,890,90,0],[891,33,891,66,0],[892,33,894,170,0],[895,33,895,117,0],[896,33,896,34,0],[898,33,898,34,0],[900,33,900,34,0],[901,37,901,161,0],[902,37,902,60,0],[903,41,903,163,0],[904,37,904,60,0],[905,41,905,172,0],[907,37,907,109,0],[908,37,908,38,0],[909,41,909,84,0],[910,41,910,66,0],[911,41,911,72,0],[912,41,913,100,0],[918,37,918,38,0],[919,37,919,68,0],[920,37,920,127,0],[921,37,921,67,0],[922,33,922,34,0],[924,33,924,74,0],[925,29,925,30,0],[926,25,926,26,0],[927,25,927,51,0],[928,29,928,72,0],[929,21,929,22,0],[930,21,930,41,0],[931,21,931,22,0],[932,25,932,68,0],[933,25,933,46,0],[934,25,934,60,0],[935,25,935,64,0],[936,25,936,75,0],[937,21,937,22,0],[938,17,938,18,0],[939,13,939,14,0],[941,13,941,34,0],[942,9,942,10,0],[945,9,945,10,1],[946,13,946,20,1],[946,22,946,33,1],[946,34,946,36,1],[946,37,946,44,1],[947,13,947,14,1],[948,17,948,36,1],[949,17,949,76,1],[950,17,950,36,1],[951,17,951,75,1],[953,17,953,121,1],[954,17,954,18,1],[955,21,955,121,1],[956,21,956,40,1],[957,25,957,53,0],[959,21,961,75,1],[963,21,965,71,1],[967,21,967,45,1],[968,21,968,61,1],[969,21,969,54,1],[970,21,970,76,1],[972,21,972,140,1],[973,25,973,48,1],[975,26,975,98,0],[976,25,976,47,0],[978,21,979,97,1],[981,21,982,91,1],[985,21,986,87,1],[988,21,988,96,1],[990,21,990,114,1],[991,25,991,82,0],[993,21,993,122,1],[994,25,994,90,0],[996,21,996,122,1],[997,25,997,90,0],[999,21,999,122,1],[1000,25,1000,90,0],[1002,21,1002,69,1],[1003,21,1003,22,0],[1004,25,1004,94,0],[1005,25,1005,100,0],[1006,25,1006,100,0],[1007,25,1007,100,0],[1008,25,1008,122,0],[1009,21,1009,22,0],[1011,25,1011,59,1],[1012,21,1012,45,1],[1014,21,1014,80,1],[1015,21,1015,62,1],[1016,21,1016,22,1],[1017,25,1017,70,1],[1018,25,1018,115,1],[1019,21,1019,22,1],[1020,17,1020,18,1],[1021,13,1021,14,1],[1022,9,1022,10,1],[1025,9,1025,10,0],[1026,9,1026,10,0],[1029,9,1029,10,0],[1031,13,1031,44,0],[1032,13,1032,14,0],[1033,17,1033,151,0],[1034,17,1034,24,0],[1037,17,1037,69,0],[1038,9,1038,10,0],[1041,9,1041,10,1],[1042,13,1042,81,1],[1043,13,1043,33,1],[1044,9,1044,10,1],[1047,9,1047,10,1],[1048,13,1048,78,1],[1050,13,1050,56,1],[1052,13,1052,89,1],[1053,13,1053,88,1],[1054,13,1054,90,1],[1055,13,1055,91,1],[1056,13,1056,88,1],[1058,13,1058,51,1],[1060,13,1060,20,1],[1060,22,1060,33,1],[1060,34,1060,36,1],[1060,37,1060,54,1],[1061,13,1061,14,1],[1062,17,1062,45,1],[1063,17,1063,24,1],[1063,26,1063,39,1],[1063,40,1063,42,1],[1063,43,1063,56,1],[1064,17,1064,18,1],[1065,21,1065,94,1],[1066,25,1066,50,1],[1068,26,1068,99,1],[1069,25,1069,49,0],[1071,26,1071,97,1],[1072,25,1072,49,1],[1074,26,1074,97,1],[1075,25,1075,48,0],[1078,25,1078,64,1],[1079,17,1079,18,1],[1080,17,1080,36,1],[1081,13,1081,14,1],[1083,13,1083,26,1],[1084,9,1084,10,1],[1087,9,1087,10,0],[1090,13,1090,14,0],[1091,17,1091,62,0],[1092,17,1092,71,0],[1094,17,1094,67,0],[1095,17,1095,81,0],[1096,17,1096,41,0],[1097,17,1097,56,0],[1099,17,1103,20,0],[1105,17,1105,24,0],[1105,26,1105,43,0],[1105,44,1105,46,0],[1105,47,1105,70,0],[1106,17,1106,18,0],[1108,21,1108,56,0],[1109,21,1109,79,0],[1110,21,1110,84,0],[1111,21,1111,80,0],[1112,21,1112,204,0],[1113,21,1113,75,0],[1114,21,1114,75,0],[1115,21,1115,71,0],[1116,21,1116,73,0],[1117,21,1117,92,0],[1118,21,1118,86,0],[1119,21,1119,79,0],[1120,21,1120,79,0],[1121,21,1121,70,0],[1122,21,1122,78,0],[1123,21,1123,122,0],[1124,21,1124,122,0],[1128,21,1128,47,0],[1130,21,1130,70,0],[1131,21,1131,86,0],[1132,21,1132,80,0],[1133,21,1133,75,0],[1134,21,1134,66,0],[1135,21,1135,70,0],[1136,21,1136,70,0],[1137,21,1137,85,0],[1139,21,1139,61,0],[1140,21,1140,40,0],[1142,21,1142,101,0],[1143,21,1143,22,0],[1144,25,1144,43,0],[1145,25,1145,73,0],[1146,25,1146,73,0],[1147,25,1147,78,0],[1148,21,1148,22,0],[1150,21,1150,78,0],[1151,21,1151,151,0],[1152,21,1152,69,0],[1153,17,1153,18,0],[1155,17,1155,43,0],[1157,9,1157,10,0],[1160,9,1160,10,1],[1161,13,1161,34,1],[1162,13,1162,50,1],[1164,13,1164,14,1],[1165,17,1165,81,1],[1167,17,1167,64,1],[1169,17,1169,54,1],[1170,17,1170,39,1],[1172,17,1172,127,1],[1173,17,1173,109,1],[1187,17,1187,173,1],[1189,17,1189,24,1],[1189,26,1189,39,1],[1189,40,1189,42,1],[1189,43,1189,57,1],[1190,17,1190,18,1],[1191,21,1191,82,1],[1192,21,1192,22,1],[1193,25,1193,126,1],[1194,25,1194,124,1],[1196,21,1196,22,1],[1197,17,1197,18,1],[1201,17,1227,28,1],[1230,17,1230,65,1],[1231,17,1231,18,0],[1232,21,1232,81,0],[1233,17,1233,18,0],[1237,17,1237,38,1],[1238,21,1238,134,0],[1240,17,1240,132,1],[1241,21,1241,53,1],[1242,17,1242,127,1],[1243,21,1243,50,0],[1244,17,1244,68,1],[1245,21,1245,81,1],[1247,17,1247,65,1],[1248,17,1248,18,0],[1250,17,1250,18,0],[1252,17,1252,66,1],[1253,21,1253,49,1],[1254,17,1254,70,1],[1255,21,1255,53,1],[1256,17,1256,70,1],[1257,21,1257,53,1],[1258,17,1258,70,1],[1259,21,1259,53,1],[1260,17,1260,79,1],[1261,21,1261,51,1],[1263,17,1263,24,1],[1263,26,1263,33,1],[1263,34,1263,36,1],[1263,37,1263,50,1],[1264,17,1264,18,1],[1265,21,1265,79,1],[1266,25,1266,87,1],[1267,17,1267,18,1],[1269,17,1269,28,1],[1270,17,1270,18,1],[1271,21,1271,88,1],[1272,21,1272,205,1],[1273,21,1273,154,1],[1275,21,1275,118,1],[1276,25,1276,55,1],[1278,21,1278,28,1],[1278,30,1278,51,1],[1278,52,1278,54,1],[1278,55,1278,70,1],[1279,21,1279,22,1],[1280,25,1280,108,1],[1281,25,1281,50,1],[1282,25,1282,26,1],[1283,29,1283,79,1],[1284,25,1284,26,1],[1285,21,1285,22,1],[1287,21,1287,28,1],[1287,30,1287,48,1],[1287,49,1287,51,1],[1287,52,1287,64,1],[1288,21,1288,22,1],[1289,25,1289,102,1],[1290,25,1290,113,1],[1291,25,1291,26,1],[1292,29,1292,98,1],[1293,25,1293,26,1],[1294,30,1294,117,1],[1295,25,1295,26,1],[1296,29,1296,98,1],[1297,25,1297,26,1],[1298,30,1298,52,1],[1299,25,1299,26,1],[1300,29,1300,95,1],[1301,25,1301,26,1],[1302,21,1302,22,1],[1303,17,1303,18,1],[1305,17,1305,18,1],[1306,21,1306,345,1],[1308,21,1308,28,1],[1308,30,1308,43,1],[1308,44,1308,46,1],[1308,47,1308,54,1],[1309,21,1309,22,1],[1310,25,1310,94,1],[1311,25,1311,70,1],[1312,25,1312,26,1],[1313,29,1313,76,1],[1314,25,1314,26,1],[1315,30,1315,74,1],[1316,25,1316,26,1],[1317,29,1317,76,1],[1318,25,1318,26,1],[1319,30,1319,49,1],[1320,25,1320,26,1],[1321,29,1321,73,1],[1322,25,1322,26,1],[1323,21,1323,22,1],[1324,17,1324,18,1],[1325,13,1325,14,1],[1326,13,1326,33,0],[1327,13,1327,14,0],[1328,17,1328,34,0],[1329,13,1329,14,0],[1330,13,1330,29,1],[1331,9,1331,10,1],[1337,9,1337,10,1],[1338,13,1338,76,1],[1339,13,1339,80,1],[1340,13,1340,78,1],[1342,13,1342,110,1],[1343,13,1343,104,1],[1344,13,1344,131,1],[1345,13,1345,131,1],[1346,13,1346,92,1],[1347,13,1347,82,1],[1348,13,1348,71,1],[1349,13,1349,138,1],[1351,13,1351,58,1],[1352,13,1352,14,1],[1353,17,1353,100,1],[1354,17,1354,82,1],[1354,83,1354,84,1],[1355,13,1355,14,1],[1357,13,1357,14,1],[1358,17,1358,91,1],[1359,17,1359,54,1],[1360,13,1360,14,1],[1361,9,1361,10,1],[1364,9,1364,10,0],[1365,13,1365,74,0],[1366,13,1366,78,0],[1367,13,1367,44,0],[1368,13,1368,29,0],[1371,21,1371,116,0],[1372,21,1372,27,0],[1374,21,1374,65,0],[1375,21,1375,51,0],[1376,21,1376,27,0],[1378,21,1378,60,0],[1379,21,1379,27,0],[1381,9,1381,10,0],[1384,9,1384,10,1],[1385,13,1385,49,1],[1386,13,1386,20,1],[1386,22,1386,38,1],[1386,39,1386,41,1],[1386,42,1386,58,1],[1387,13,1387,14,1],[1388,17,1388,43,1],[1389,21,1389,65,1],[1390,13,1390,14,1],[1391,13,1391,28,1],[1392,9,1392,10,1],[1395,9,1395,10,1],[1396,13,1396,42,1],[1397,13,1397,77,1],[1399,13,1399,68,1],[1400,13,1400,112,1],[1402,13,1402,49,1],[1403,13,1403,14,1],[1404,17,1404,101,1],[1405,13,1405,14,1],[1406,9,1406,10,1],[1409,9,1409,10,1],[1410,13,1410,101,1],[1411,13,1411,82,1],[1412,13,1412,82,1],[1414,13,1414,87,1],[1415,13,1415,14,1],[1416,17,1416,65,1],[1417,17,1417,18,1],[1418,21,1418,83,1],[1419,21,1419,58,1],[1420,21,1420,65,1],[1421,21,1421,83,1],[1422,21,1422,138,1],[1423,21,1423,71,1],[1424,17,1424,18,1],[1425,13,1425,14,1],[1427,13,1427,84,1],[1428,13,1428,14,1],[1429,17,1429,64,1],[1430,17,1430,18,1],[1431,21,1431,83,1],[1432,21,1432,88,1],[1433,17,1433,18,1],[1434,13,1434,14,1],[1436,13,1436,71,1],[1437,13,1437,14,1],[1438,17,1438,47,1],[1440,17,1456,15,1],[1458,22,1458,31,1],[1458,33,1458,55,1],[1458,57,1458,63,1],[1459,17,1459,18,1],[1460,21,1460,65,1],[1461,25,1461,87,1],[1462,17,1462,18,1],[1464,17,1464,59,1],[1465,17,1465,18,1],[1466,21,1466,80,1],[1467,21,1467,59,1],[1468,21,1468,67,1],[1469,21,1469,56,1],[1470,21,1470,79,1],[1471,21,1471,72,1],[1472,17,1472,18,1],[1473,22,1473,68,1],[1474,17,1474,18,1],[1475,21,1476,92,1],[1477,17,1477,18,1],[1478,22,1478,62,1],[1479,17,1479,18,1],[1480,21,1480,78,1],[1481,21,1481,55,1],[1482,21,1482,64,1],[1483,21,1483,83,1],[1484,21,1484,70,1],[1485,17,1485,18,1],[1486,22,1486,66,1],[1487,17,1487,18,1],[1488,21,1488,82,1],[1489,21,1489,63,1],[1490,21,1490,68,1],[1491,21,1491,83,1],[1492,21,1492,74,1],[1493,17,1493,18,1],[1494,13,1494,14,1],[1495,9,1495,10,1],[1517,29,1517,33,0],[1517,34,1517,38,0],[1518,25,1518,29,0],[1518,30,1518,34,0],[1519,39,1519,43,0],[1519,44,1519,48,0],[1520,37,1520,41,0],[1520,42,1520,46,0],[1522,34,1522,38,0],[1522,39,1522,43,0],[1523,38,1523,42,0],[1523,43,1523,47,0],[1524,38,1524,42,0],[1524,43,1524,47,0],[1525,38,1525,42,0],[1525,43,1525,47,0],[1526,33,1526,37,0],[1526,38,1526,42,0],[1527,33,1527,37,0],[1527,38,1527,42,0],[1528,31,1528,35,0],[1528,36,1528,40,0],[1529,34,1529,38,0],[1529,39,1529,43,0],[1530,33,1530,37,0],[1530,38,1530,42,0]]);
    </script>
  </body>
</html>