<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\USRMGMT\EditUser.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Reflection;
using System.Globalization;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.AMP3.UserManagementDTO;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DTO;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common.Utility;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Platform.UI.Common.Helpers;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using System.Web;
using System.Web.UI;

namespace Aurigo.AMP3.UserManagementUI
{
    public partial class EditUser : BrixPageBase, IXMLControl
    {
        private int rrid; // Real User RID
        private int uid; // UID of the user being edited

        private string pg; /*This page could be reached from 2 paths
                               1. pg=profile When the user clicks on his own id. 
                               2. pg=user    When the Administrator selects a user in the UserAccounts grid*/

        private XMLFormManagerModel managerModel;
        private BrixFormModel model;
        private const string FORM_NAME = &quot;USRMADU&quot;;

        public BrixFormModel Model
        {
            get { return model; }
            set { model = value; }
        }

        private List&lt;string&gt; permissions
        {
            get { return (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS]; }
        }

        #region IXMLControl Members
        public bool SkipDefaultXMLInjectionSave
        {
            get;
            set;
        }

        private int userIDForIXMLControl = 0;

        public object[] ParentFormInstanceID
        {
            get { return new object[] { userIDForIXMLControl }; }
        }

        public HtmlGenericControl XMLContainterDiv
        {
            get { return additionaldiv; }
            set { }
        }

        public void HandleInjectionSaveException(object model, Exception ex, string parentFormInstanceId)
        {
            try
            {
                if (managerModel != null)
                    managerModel.HandleInjectionSaveException((model as BrixFormModel), ex, parentFormInstanceId);
            }
            catch (Exception ex1)
            {
                throw ex1;
            }
        }

        public void HandleInjectionAfterSave(object model, string parentFormInstanceId)
        {
            try
            {
                if (managerModel != null)
                    managerModel.HandleInjectionAfterSave((model as BrixFormModel), parentFormInstanceId);
            }
            catch (Exception ex1)
            {
                throw ex1;
            }
        }

        #endregion        

        public override void InclueScriptAndStyleFiles()
        {
            base.InclueScriptAndStyleFiles();
            RegisterClientScriptInclude(&quot;~/Scripts/usermgmt/AddOrEditUser.js&quot;);
        }

        protected override void OnPreInit(EventArgs e)
        {
            if (!string.IsNullOrEmpty(Request[&quot;UID&quot;]))
                userIDForIXMLControl = Request[&quot;UID&quot;].ToInt32_2();

            base.OnPreInit(e);
            SetManagerModel();
            if (managerModel != null)
                managerModel.OnPreInit(model, new XmlFormArgs());
        }

        private void SetManagerModel()
        {
            model = BrixFormModel.GetInstance(&quot;XUSRMGT&quot;, &quot;XUSRMGT&quot;, Request, Response);

            if (model != null &amp;&amp; !string.IsNullOrEmpty(model.form.ManagerDLL) &amp;&amp; !string.IsNullOrEmpty(model.form.FormManagerClass))
            {
                managerModel = AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(model.form.ManagerDLL,
                                                                                 model.form.FormManagerClass);
                // managerModel.PageViewState = ViewState;
            }
        }
        /// &lt;summary&gt;
        /// aspx method shall be calling this method through scriptlet
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string GetInitilize_ClientId_ForUseInJavascript()
        {
            JavascriptRenderFramework jrf = new JavascriptRenderFramework(&quot;CONST_AddEditUser&quot;);

            jrf.Add_ClientId(
                 leftlist
                 , rightlist
                 , hdnroleid
                 , chlListUType
            );

            jrf.Add_Message(&quot;hdnSelectRoleFromAvailableRoles&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_SELECT_ROLE_FROM_AVAILABLE_ROLES&quot;, Enumerations.MessageType.WarningMessage));

            jrf.Add_Message(&quot;hdnSelectRoleFromSavedRoles&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_SELECT_ROLE_FROM_SAVED_ROLES&quot;, Enumerations.MessageType.WarningMessage));
            jrf.Add_Message(&quot;hdnExpiryDateVerification&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_VERIFY_ACCOUNT_EXPIRY_DATE&quot;, Enumerations.MessageType.WarningMessage));
            jrf.Add_Message(&quot;hdnSelectRoleToAssociateWithUser&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_SELECT_ROLE_TO_ASSOCIATE_WITH_USER&quot;, Enumerations.MessageType.WarningMessage));

            //The below two does not seems to have been used.But maintaining it to prevent breaking of any code
            jrf.Add_Message(&quot;hdnNoRolesAvailable&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_NO_ROLES_AVAILABLE&quot;, Enumerations.MessageType.WarningMessage));
            jrf.Add_Message(&quot;hdnUpdateDetails&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_CONFIRM_UPDATE_DETAILS&quot;, Enumerations.MessageType.WarningMessage));

            string scriptString = jrf.Generate();

            return scriptString;
        }

        protected override void OnInit(EventArgs e)
        {
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);
            PermissionsToCheck.Add(Constants.MODFEAT_EDIT);
            base.OnInit(e);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                UserDetail ud = UserDetail.GetCurrentUserDetail();

                uid = (Request.QueryString.Get(&quot;uid&quot;) != null)
                    ? Request.QueryString.Get(&quot;uid&quot;).ToInt32_2()
                    : ud.UID;
                rrid = ud.RID;
                pg = (Request.QueryString[&quot;pg&quot;] != null) ? Request.QueryString.Get(&quot;pg&quot;).ToString2() : &quot;&quot;;
                if (_ModuleComponents != null &amp;&amp; _ModuleComponents.Contains(&quot;EnableADASupport&quot;))
                    trIsADACompliant.Visible = true;
                else
                    trIsADACompliant.Visible = false;
                msg.Text = &quot;&quot;;
                if (!Page.IsPostBack)
                {
                    // Disable the Roles dropdown list
                    UIHelper.DisableRoleSelection(Page);

                    // Specify the default button for the page
                    var myForm = (HtmlForm)Page.Master.FindControl(&quot;form1&quot;);


                    hdnNoRolesAvailable.Value = MessageResourceManager.GetString(&quot;W_USRMGMT_NO_ROLES_AVAILABLE&quot;, Enumerations.MessageType.WarningMessage);
                    hdnUpdateDetails.Value = MessageResourceManager.GetString(&quot;W_USRMGMT_CONFIRM_UPDATE_DETAILS&quot;, Enumerations.MessageType.WarningMessage);

                    //display the userdetails from database for uid
                    User UserDTO = UserManager.Instance.GetAUser(uid);

                    txtFirstName.Text = UserDTO.FirstName.ToString2();
                    txtMiddleName.Text = UserDTO.MiddleName.ToString2();
                    txtLastName.Text = UserDTO.LastName.ToString2();
                    txtCompany.Text = UserDTO.CompanyName.ToString2();
                    txtUserID.Text = UserDTO.UserName.ToString2();
                    hdnEmailID.Value = txtEmailID.Text = UserDTO.Email.ToString2();
                    txtTelephone.Text = UserDTO.Telephone.ToString2();
                    txtFax.Text = UserDTO.Fax.ToString2();
                    txtAddressLine1.Text = UserDTO.Address1.ToString2();
                    txtAddressLine2.Text = UserDTO.Address2.ToString2();
                    txtAddressLine3.Text = UserDTO.Address3.ToString2();
                    txtCity.Text = UserDTO.City.ToString2();
                    txtState.Text = UserDTO.State.ToString2();
                    txtCountry.Text = UserDTO.Country.ToString2();
                    txtZIP.Text = UserDTO.Zipcode.ToString2();
                    txtCertNo.Text = UserDTO.CertNo;
                    chlListUType.Items[0].Selected = (UserDTO.WebUser == 1) ? true : false;
                    chlListUType.Items[1].Selected = (UserDTO.MobileUser == 1) ? true : false;
                    txtMobile.Text = UserDTO.MobileNo;
                    chkSMSNotification.Checked = UserDTO.IsSMS;
                    chkIsADACompliant.Checked = UserDTO.IsADACompliant;

                    ViewState[&quot;MobileUser&quot;] = UserDTO.MobileUser;

                    //if(UserDTO.SendEmail)
                    //    chksend.Checked = true;
                    //else
                    //    chksend.Checked = false;

                    if (UserDTO.IsActive)
                    {
                        cmbstatus.Items[0].Selected = true;
                        hdnstat.Value = &quot;true&quot;;
                    }
                    else
                    {
                        cmbstatus.Items[1].Selected = true;
                        hdnstat.Value = &quot;false&quot;;
                    }
                    
                    if (UserDTO.IsADUser)
                    {
                        //hode controls for AD Users
                        lnkChangePassword.Style.Value = &quot;display:none&quot;;
                        lblChangePassword.Style.Value = &quot;display:none&quot;;

                        lblPasswordExpiry.Style.Value = &quot;display:none&quot;;
                        lblPasswordExpiry1.Style.Value = &quot;display:none&quot;;

                        lblPasswordLastChangedOn.Style.Value = &quot;display:none&quot;;
                        lblPasswordLastChangedOn1.Style.Value = &quot;display:none&quot;;

                        lblAccountExpiryDate.Style.Value = &quot;display:none&quot;;
                        webExpiryDate.Style.Value = &quot;display:none&quot;;

                        //disable controls for AD Users                       
                        txtEmailID.Enabled = false;
                        cmbstatus.Enabled = false;

                        var model = new BrixFormModel(FORM_NAME, FORM_NAME + &quot;.xml&quot;, Brix.Platform.BusinessLayer.XmlForm_Framework.XMLType.Form);
                        var properties = typeof(User).GetProperties();
                        foreach (var p in properties)
                        {
                            if (model.form.GetControl(p.Name) != null)
                            {
                                if(!p.Name.Equals(&quot;UserName&quot;))
                                {
                                    TextBox textBox = (TextBox)((Page)HttpContext.Current.Handler).Form.FindControl(&quot;C1&quot;).FindControl(&quot;txt&quot; + p.Name);
                                    if(textBox != null)
                                    {
                                        textBox.Enabled = false;
                                    }
                                }                                
                            }
                        }                                                  
                    }


                    webExpiryDate.Value = UserDTO.ExpiryDate.ToMWDateTime();

                    tblrole.Visible = true;
                    lblSendEmailNotification.Visible = true;
                    chksend.Visible = true;
                    lblStatus.Visible = true;
                    cmbstatus.Visible = true;
                    lblAccountExpiryDate.Visible = true;
                    webExpiryDate.Visible = true;
                    //calimg.Visible = true;

                    Dictionary&lt;int, string&gt; ActiveRoles = UserManager.Instance.GetUnassignedRolesOfUser(uid);
                    Dictionary&lt;int, string&gt; SavedRoles = UserManager.Instance.GetAssignedRolesOfUser(uid);

                    leftlist.Items.Clear();
                    rightlist.Items.Clear();

                    foreach (var kvp in ActiveRoles)
                        leftlist.Items.Add(new ListItem(kvp.Value, kvp.Key.ToString2()));

                    foreach (var kvp in SavedRoles)
                        rightlist.Items.Add(new ListItem(kvp.Value, kvp.Key.ToString2()));

                    // Set enabled for Addbutton/Removebutton based on whether a user is associated with contractors or not

                    var roleEdit = UserManager.Instance.IsUserAssociatedWithContractor(uid);
                    Addbutton.Visible = Removebutton.Visible = (roleEdit &amp;&amp; permissions.Contains(&quot;ManageUsers&quot;));

                    switch (pg)
                    {
                        case &quot;user&quot;:
                            // The user &quot;Administrator&quot; is special
                            if ((uid == Constants.USRMGMT_ADMIN_UID) &amp;&amp; (rrid != Constants.USRMGMT_ADMIN_UID))
                            {
                                lnkChangePassword.Enabled = true;
                            }
                            else
                            {
                                lnkChangePassword.NavigateUrl = &quot;ChangePassword.aspx?uid=&quot; + uid.ToString2() +
                                                                &quot;&amp;pg=user&quot;;
                            }
                            break;
                        case &quot;profile&quot;:
                        default:

                            lnkChangePassword.NavigateUrl = &quot;ChangePassword.aspx?uid=&quot; + uid.ToString2() +
                                                            &quot;&amp;pg=profile&quot;;
                            break;
                    }

                    List&lt;string&gt; USRMGMTcomponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_USRMGMT);
                    if (!USRMGMTcomponents.Contains(&quot;ShowMandatoryLastName&quot;))
                    {
                        errlastname.Style.Value = &quot;display:none&quot;;
                        RequiredFieldValidatorLastName.Enabled = false;
                    }
                    if (USRMGMTcomponents.Contains(&quot;ADAuthentication&quot;))
                        txtCertNo.Enabled = lnkChangePassword.Enabled = false;

                    DataTable dt = UserManager.Instance.GetPasswordStatusDetails(UserDTO.UserId);
                    int passwordExpiryDays = 0;
                    DateTime? passwordLastChangedOn = null;

                    if (dt != null &amp; dt.Rows.Count &gt; 0)
                    {
                        passwordExpiryDays = dt.Rows[0][&quot;PasswordExpiryDays&quot;].ToInt32_2();
                        passwordLastChangedOn = (!string.IsNullOrEmpty(dt.Rows[0][&quot;PasswordLastChangedOn&quot;].ToString())
                            &amp;&amp; dt.Rows[0][&quot;PasswordLastChangedOn&quot;].ToString() != &quot;0&quot;)
                            ? (DateTime?)dt.Rows[0][&quot;PasswordLastChangedOn&quot;].ToString().ToMWDateTime()
                            : (DateTime?)null;

                        bool mustChangePasswordOnFirstLogin = dt.Rows[0][&quot;PasswordLastChangedOn&quot;].ToString() == &quot;0&quot;
                            ? false
                            : true;
                    }

                    if (passwordLastChangedOn.HasValue &amp;&amp; passwordExpiryDays != 0)
                        lblPasswordExpiry.Text =
                            passwordLastChangedOn.Value.AddDays(passwordExpiryDays)
                                .ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE);
                    else if (!passwordLastChangedOn.HasValue &amp;&amp; passwordExpiryDays != 0)
                        lblPasswordExpiry.Text =
                            UserDTO.RegDate.AddDays(passwordExpiryDays)
                                .ToMWDateTimeString_FormatDate();
                    else
                        lblPasswordExpiry.Text = &quot;Never&quot;;

                    if (passwordLastChangedOn.HasValue)
                        lblPasswordLastChangedOn.Text =
                            UserDTO.PasswordLastChangedOn.Value.ToMWDateTimeString_FormatDate();
                    else
                        lblPasswordLastChangedOn.Text = &quot;Never&quot;;

                    GetBusinessUnits(uid);

                    lblBusinessUnit.Text = LocalizationManager.GetString(&quot;BusinessUnit&quot;) + &quot; :&quot;;
                }
                XmlFormArgs args = new XmlFormArgs();
                if (managerModel != null)
                    managerModel.OnPageLoad(model, args);
            }
            catch (Exception ex)
            {
                Logger.Log(Enumerations.LogType.Error, ex.Message, Constants.MODID_USRMGMT);
                throw;
            }

            PageTitle = &quot;Edit User&quot;;
            List&lt;string&gt; UTILITYcomponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_UTILITY);
            if (!UTILITYcomponents.Contains(&quot;EnableMobile&quot;))
            {
                lblSMSAlert.Style.Add(&quot;display&quot;, &quot;none&quot;);
                chkSMSNotification.Style.Add(&quot;display&quot;, &quot;none&quot;);

                chlListUType.Items.FindByText(&quot;Mobile user&quot;).Attributes.CssStyle.Add(&quot;display&quot;, &quot;none&quot;);
                chlListUType.Items.FindByText(&quot;Web user&quot;).Selected = true;
            }
        }
        

        /// &lt;summary&gt;       
        /// Comments : Get Business Units and Bind for Edituser
        /// &lt;/summary&gt;
        private void GetBusinessUnits(int uid)
        {
            DataTable dt_AllBusinessUnit = UserManager.Instance.GetBusinessUnits_ActiveOnly();
            // to fix XSS
            foreach(DataRow row in dt_AllBusinessUnit.Rows)
            {
                row[&quot;Name&quot;] = System.Web.HttpUtility.HtmlEncode(row[&quot;Name&quot;].ToString());
            }

            radddlBusinessUnitTree.DataTextField = &quot;Name&quot;;
            radddlBusinessUnitTree.DataValueField = &quot;ID&quot;;
            radddlBusinessUnitTree.DataFieldID = &quot;ID&quot;;
            radddlBusinessUnitTree.DataFieldParentID = &quot;ParentID&quot;;
            radddlBusinessUnitTree.DataSource = dt_AllBusinessUnit;
            radddlBusinessUnitTree.DataBind();
            radddlBusinessUnitTree.ExpandAllDropDownNodes();

            DataTable dt = UserManager.Instance.GetBusinessUnitForUser(uid);

            if (dt != null &amp;&amp; dt.Rows.Count &gt; 0)
            {
                List&lt;int&gt; businessUnit_IdList = new List&lt;int&gt;();
                for (int i = 0; i &lt; dt.Rows.Count; i++)
                { businessUnit_IdList.Add(dt.Rows[i][&quot;BusinessUnitId&quot;].ToInt32_2()); }

                if (businessUnit_IdList.Count &gt; 0)
                {
                    radddlBusinessUnitTree.SelectedValue = string.Join(&quot;,&quot;, businessUnit_IdList);
                }
            }
            else
                radddlBusinessUnitTree.SelectedValue = &quot;0&quot;;
        }

        protected void save_Click(object sender, EventArgs e)
        {
            try
            {
                Page.Validate();
                if (Page.IsValid)
                {
                    List&lt;string&gt; USRMGMTcomponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_USRMGMT);
                    if (USRMGMTcomponents.Contains(&quot;AllowDuplicateEmailID&quot;) ||
                        (UserManager.Instance.CheckForUniqueEmail(txtEmailID.Text.Trim(), txtUserID.Text.Trim())))
                    {
                        XmlFormArgs args = new XmlFormArgs();
                        if (managerModel != null)
                            managerModel.BeforeSave(model, args);
                        if (managerModel == null || args.IsValid)
                        {   //instantiate DTO class
                            User UserDTO = UserManager.Instance.GetAUser(uid);

                            //assign values to DTO properties
                            UserDTO.UserId = uid;
                            // Retain UserID and Password
                            UserDTO.FirstName = txtFirstName.Text.Trim();
                            UserDTO.MiddleName = txtMiddleName.Text.Trim();
                            UserDTO.LastName = txtLastName.Text.Trim();

                            UserDTO.CompanyName = txtCompany.Text.Trim();
                            UserDTO.Address1 = txtAddressLine1.Text.Trim();
                            UserDTO.Address2 = txtAddressLine2.Text.Trim();
                            UserDTO.Address3 = txtAddressLine3.Text.Trim();
                            UserDTO.City = txtCity.Text.Trim();
                            UserDTO.State = txtState.Text.Trim();
                            UserDTO.Country = txtCountry.Text.Trim();
                            UserDTO.Zipcode = txtZIP.Text.Trim();
                            UserDTO.Telephone = txtTelephone.Text.Trim();
                            UserDTO.Email = txtEmailID.Text.Trim();
                            UserDTO.Fax = txtFax.Text.Trim();

                            UserDTO.IsActive = (cmbstatus.SelectedValue == &quot;1&quot;) ? true : false;
                            UserDTO.WebUser = (chlListUType.Items[0].Selected) ? 1 : 0;
                            UserDTO.MobileUser = (chlListUType.Items[1].Selected) ? 1 : 0;
                            //UserDTO.SendEmail = chksend.Checked;

                            string ridlist = hdnroleid.Value.ToString2();

                            if (uid == Constants.USRMGMT_ADMIN_UID)
                            // The default administrator is always active &amp; has the Administrator role
                            {
                                UserDTO.IsActive = true;
                                ridlist = ridlist + &quot;,&quot; + Constants.USRMGMT_ADMIN_RID;
                            }

                            UserDTO.ExpiryDate = Convert.ToDateTime(webExpiryDate.Value.ToString2(),
                                CultureInfo.InvariantCulture).ToMWUtcDateTime();
                            UserDTO.CertNo = (txtCertNo.Text.Trim() == &quot;&quot;) ? &quot;NA&quot; : txtCertNo.Text;

                            UserDTO.MobileNo = txtMobile.Text.Trim();
                            UserDTO.IsSMS = chkSMSNotification.Checked;
                            UserDTO.IsADACompliant = chkIsADACompliant.Checked;
                            UserDTO.AUR_ModifiedBy = UserDetail.GetCurrentUserDetail().UID;
                            UserDTO.AUR_ModifiedOn = DateTime.UtcNow;

                            //call the BL createuser method

                            // Checking for the license
                            string errMsg = string.Empty;
                            if (!LicenseManager.Instance.ValidateLicense(ref errMsg, &quot;0&quot;, &quot;MobileLicense&quot;))
                            {
                                lblMessage.Text = errMsg;
                                return;
                            }

                            //if success in adding, check for type of page
                            int returnvalue;
                            if ((returnvalue = UserManager.Instance.UpdateUser(UserDTO)) &gt; 0)
                            {
                                // Call Save BusinessUnit Method
                                int rowAffected = UserManager.Instance.AddMultipleBusinessUnitIdsToUser(radddlBusinessUnitTree.SelectedValue, uid);

                                int result = 0;

                                UserMapping tempDto = SignUpManager.Instance.GetUserMapping(hdnEmailID.Value.Trim());
                                if (tempDto == null)
                                {
                                    UserMapping mappingdto = new UserMapping();
                                    mappingdto.EmailID = UserDTO.Email;
                                    mappingdto.UserName = UserDTO.UserName;
                                    mappingdto.CompanyCode = ConnectionHelper.GetCurrentCompany();
                                    mappingdto.IsCompanyActive = true;
                                    mappingdto.IsAdmin = false;

                                    mappingdto.Mode = &quot;C&quot;;
                                    SignUpManager.Instance.CUDUserMapping(mappingdto);
                                }
                                else
                                {
                                    //if (!(tempDto.UserName == UserDTO.UserName &amp;&amp; tempDto.CompanyCode == ConnectionHelper.GetCurrentCompany()))
                                    //{
                                    //    lblMessage.Text = &quot;Please enter a unique Email ID&quot;;
                                    //    return;
                                    //}
                                    tempDto.EmailID = UserDTO.Email;
                                    tempDto.Mode = &quot;U&quot;;
                                    SignUpManager.Instance.CUDUserMapping(tempDto);
                                }
                                if (rrid == Constants.USRMGMT_ADMIN_RID || permissions.Contains(&quot;ManageUsers&quot;))
                                {
                                    Dictionary&lt;int, string&gt; savedRoles = UserManager.Instance.GetAssignedRolesOfUser(uid);

                                    if (!String.IsNullOrEmpty(ridlist))
                                    {
                                        string[] val = ridlist.Split(&#39;,&#39;);
                                        for (int i = 0; i &lt; val.Length; i++)
                                        {
                                            if (savedRoles.ContainsKey(val[i].ToInt32_2()))
                                            {
                                                savedRoles.Remove(val[i].ToInt32_2());
                                            }
                                            else
                                            {
                                                result = UserManager.Instance.AddRolesToUser(uid, val[i].ToInt32_2());
                                            }
                                        }
                                    }
                                    else
                                    {
                                        result = UserManager.Instance.AddRolesToUser(uid, Constants.USRMGMT_USER_RID);
                                    }

                                    // remove the roles
                                    foreach (int rId in savedRoles.Keys)
                                    {
                                        // Ensure that the default administrator is always part of the Administrator group
                                        if (rId == Constants.USRMGMT_ADMIN_RID &amp;&amp; uid == Constants.USRMGMT_ADMIN_RID)
                                            continue;

                                        UserManager.Instance.DeleteUserRole(uid, rId);
                                    }

                                    // Clear information in the cache, if it exists.
                                    UserManager.Instance.ClearCachedRoles();
                                    (this as BrixPageBase).UpdateWebFarmData(&quot;CacheOfRoles&quot;);

                                    if (result &gt; 0)
                                    {
                                        if (chkSMSNotification.Checked &amp;&amp; !string.IsNullOrEmpty(txtMobile.Text.Trim()))
                                            SMSManager.SendSMS(txtMobile.Text.Trim(),
                                                &quot;Your &quot; + AMP3ApplicationSettings.Instance.AppName +
                                                &quot; account login details have been updated.&quot;);
                                        if (chksend.Checked)
                                        {
                                            try
                                            {
                                                Mailer.SendEmail(txtEmailID.Text.Trim(),
                                                    AMP3ApplicationSettings.Instance.AppName + &quot; Account Updated&quot;,
                                                    &quot;Your &quot; + AMP3ApplicationSettings.Instance.AppName +
                                                    &quot;  account login details have been updated.&quot;);
                                            }
                                            catch (Exception ex)
                                            {
                                                Logger.Log(Enumerations.LogType.Error, ex.ToString2(),
                                                    Constants.MODID_USRMGMT);
                                            }
                                        }

                                        if (UserDTO.UserId == UserDetail.GetCurrentUserDetail().UID)
                                            UpdateUserSession(UserDTO);
                                    }
                                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=USRMGMT&amp;IsRegistered=1&quot;, false);
                                }
                                else
                                {
                                    Response.Redirect(&quot;ViewUserDetails.aspx?pg=profile&quot;, false);
                                }
                            }
                            else if (returnvalue == -1)
                            {
                                msg.Text = MessageResourceManager.GetString(&quot;W_USRMGMT_EMAILID_ALREADY_EXISTS&quot;,
                                    Enumerations.MessageType.WarningMessage);
                                SkipDefaultXMLInjectionSave = true;
                            }
                            else
                            {
                                msg.Text = &quot;Cert. No. already exists.&quot;;
                                SkipDefaultXMLInjectionSave = true;
                            }
                        }
                    }
                    else
                    {
                        lblMessage.Text = &quot;Please enter a unique Email ID&quot;;
                        SkipDefaultXMLInjectionSave = true;
                    }
                }
                else
                {
                    SkipDefaultXMLInjectionSave = true;
                }
            }
            catch (Exception ex)
            {
                SkipDefaultXMLInjectionSave = true;
                Logger.Log(Enumerations.LogType.Error, ex.Message, Constants.MODID_USRMGMT);
                throw;
            }
        }

        /// &lt;summary&gt;
        /// updating the Session for UserDetail
        /// (if the loggedin user edits his own details)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;UserDTO&quot;&gt;&lt;/param&gt;
        private void UpdateUserSession(User UserDTO)
        {
            UserDetail ud = UserDetail.GetCurrentUserDetail();
            ud.FirstName = UserDTO.FirstName;
            ud.MiddleName = UserDTO.MiddleName;
            ud.LastName = UserDTO.LastName;
            ud.UserName = UserDTO.FirstName
                          + ((!String.IsNullOrEmpty(UserDTO.MiddleName))
                              ? &quot; &quot; + UserDTO.MiddleName
                              : &quot;&quot;)
                          + ((!String.IsNullOrEmpty(UserDTO.LastName))
                              ? &quot; &quot; + UserDTO.LastName
                              : &quot;&quot;);
            ud.CertificateNo = UserDTO.CertNo;
            ud.Email = UserDTO.Email;
        }

        protected void btnReset_Click(object sender, EventArgs e)
        {
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=USRMGMT&amp;IsRegistered=1&quot;, false);
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            menus.Add(new BrixMenu(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;, 55));
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            if (MainToolBar.GetMenuReference(&quot;lnkSave&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).OnClientClick = &quot;return fnSave_ForEditUserPage()&quot;;
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += save_Click;
            }
            if (MainToolBar.GetMenuReference(&quot;lnkCancel&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += btnCancel_Click;
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;
            }
            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.AfterCustomizeToolbar(model, MainToolBar, args);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[46,17,46,18,0],[46,19,46,32,0],[46,33,46,34,0],[47,17,47,18,0],[47,19,47,33,0],[47,34,47,35,0],[52,17,52,18,1],[52,19,52,84,1],[52,85,52,86,1],[58,13,58,17,0],[59,13,59,17,0],[62,9,62,46,1],[66,17,66,18,1],[66,19,66,64,1],[66,65,66,66,1],[71,17,71,18,0],[71,19,71,40,0],[71,41,71,42,0],[72,17,72,18,0],[72,19,72,20,0],[76,9,76,10,0],[78,13,78,14,0],[79,17,79,42,0],[80,21,80,115,0],[81,13,81,14,0],[82,13,82,34,0],[83,13,83,14,0],[84,17,84,27,0],[86,9,86,10,0],[89,9,89,10,0],[91,13,91,14,0],[92,17,92,42,0],[93,21,93,107,0],[94,13,94,14,0],[95,13,95,34,0],[96,13,96,14,0],[97,17,97,27,0],[99,9,99,10,0],[104,9,104,10,1],[105,13,105,46,1],[106,13,106,80,1],[107,9,107,10,1],[110,9,110,10,1],[111,13,111,55,1],[112,17,112,67,1],[114,13,114,31,1],[115,13,115,31,1],[116,13,116,38,1],[117,17,117,66,0],[118,9,118,10,1],[121,9,121,10,1],[122,13,122,88,1],[124,13,124,133,1],[125,13,125,14,0],[126,17,127,111,0],[129,13,129,14,0],[130,9,130,10,1],[136,9,136,10,1],[137,13,137,96,1],[139,13,144,15,1],[146,13,146,185,1],[148,13,148,177,1],[149,13,149,173,1],[150,13,150,188,1],[153,13,153,159,1],[154,13,154,160,1],[156,13,156,50,1],[158,13,158,33,1],[159,9,159,10,1],[162,9,162,10,1],[163,13,163,66,1],[164,13,164,60,1],[165,13,165,28,1],[166,9,166,10,1],[169,9,169,10,1],[171,13,171,14,1],[172,17,172,67,1],[174,17,176,30,1],[177,17,177,31,1],[178,17,178,107,1],[179,17,179,97,1],[180,21,180,53,0],[182,21,182,54,1],[183,17,183,31,1],[184,17,184,38,1],[185,17,185,18,1],[187,21,187,57,1],[190,21,190,77,1],[193,21,193,155,1],[194,21,194,156,1],[197,21,197,71,1],[199,21,199,71,1],[200,21,200,73,1],[201,21,201,69,1],[202,21,202,71,1],[203,21,203,67,1],[204,21,204,84,1],[205,21,205,71,1],[206,21,206,59,1],[207,21,207,73,1],[208,21,208,73,1],[209,21,209,73,1],[210,21,210,61,1],[211,21,211,63,1],[212,21,212,67,1],[213,21,213,63,1],[214,21,214,53,1],[215,21,215,92,1],[216,21,216,95,1],[217,21,217,55,1],[218,21,218,64,1],[219,21,219,72,1],[221,21,221,66,1],[228,21,228,42,1],[229,21,229,22,1],[230,25,230,60,1],[231,25,231,48,1],[232,21,232,22,1],[234,21,234,22,0],[235,25,235,60,0],[236,25,236,49,0],[237,21,237,22,0],[239,21,239,42,1],[240,21,240,22,0],[242,25,242,72,0],[243,25,243,72,0],[245,25,245,72,0],[246,25,246,73,0],[248,25,248,79,0],[249,25,249,80,0],[251,25,251,75,0],[252,25,252,68,0],[255,25,255,52,0],[256,25,256,51,0],[258,25,258,146,0],[259,25,259,71,0],[260,25,260,32,0],[260,34,260,39,0],[260,40,260,42,0],[260,43,260,53,0],[261,25,261,26,0],[262,29,262,71,0],[263,29,263,30,0],[264,33,264,63,0],[265,33,265,34,0],[266,37,266,151,0],[267,37,267,56,0],[268,37,268,38,0],[269,41,269,65,0],[270,37,270,38,0],[271,33,271,34,0],[272,29,272,30,0],[273,25,273,26,0],[274,21,274,22,0],[277,21,277,77,1],[279,21,279,44,1],[280,21,280,61,1],[281,21,281,44,1],[282,21,282,46,1],[283,21,283,46,1],[284,21,284,57,1],[285,21,285,50,1],[288,21,288,110,1],[289,21,289,107,1],[291,21,291,44,1],[292,21,292,45,1],[294,21,294,28,1],[294,30,294,37,1],[294,38,294,40,1],[294,41,294,52,1],[295,25,295,90,1],[297,21,297,28,1],[297,30,297,37,1],[297,38,297,40,1],[297,41,297,51,1],[298,25,298,91,1],[302,21,302,93,1],[303,21,303,114,1],[305,21,305,32,1],[309,29,309,111,1],[310,29,310,30,0],[311,33,311,66,0],[312,29,312,30,0],[314,29,314,30,1],[315,33,316,76,1],[317,29,317,30,1],[318,29,318,35,1],[322,29,323,75,0],[324,29,324,35,0],[327,21,327,123,1],[328,21,328,78,1],[329,21,329,22,1],[330,25,330,66,1],[331,25,331,72,1],[332,21,332,22,1],[333,21,333,72,1],[334,25,334,79,0],[336,21,336,98,1],[337,21,337,48,1],[338,21,338,60,1],[340,21,340,56,1],[341,21,341,22,1],[342,25,342,91,1],[343,25,346,47,1],[348,25,350,36,1],[351,21,351,22,1],[353,21,353,83,1],[354,25,356,89,0],[357,26,357,89,1],[358,25,360,66,0],[362,25,362,58,1],[364,21,364,56,1],[365,25,366,97,0],[368,25,368,65,1],[370,21,370,43,1],[372,21,372,97,1],[373,17,373,18,1],[374,17,374,54,1],[375,17,375,42,1],[376,21,376,58,0],[377,13,377,14,1],[378,13,378,33,0],[379,13,379,14,0],[380,17,380,93,0],[381,17,381,23,0],[384,13,384,37,1],[385,13,385,115,1],[386,13,386,61,1],[387,13,387,14,0],[388,17,388,58,0],[389,17,389,65,0],[391,17,391,105,0],[392,17,392,75,0],[393,13,393,14,0],[394,9,394,10,1],[401,9,401,10,1],[402,13,402,95,1],[404,13,404,20,1],[404,21,404,32,1],[404,33,404,35,1],[404,36,404,59,1],[405,13,405,14,1],[406,17,406,89,1],[407,13,407,14,1],[409,13,409,59,1],[410,13,410,58,1],[411,13,411,55,1],[412,13,412,67,1],[413,13,413,68,1],[414,13,414,47,1],[415,13,415,61,1],[417,13,417,77,1],[419,13,419,49,1],[420,13,420,14,1],[421,17,421,65,1],[422,22,422,31,1],[422,33,422,50,1],[422,52,422,55,1],[423,17,423,18,1],[423,19,423,85,1],[423,86,423,87,1],[425,17,425,51,1],[426,17,426,18,1],[427,21,427,98,1],[428,17,428,18,1],[429,13,429,14,1],[431,17,431,60,1],[432,9,432,10,1],[435,9,435,10,1],[437,13,437,14,1],[438,17,438,33,1],[439,17,439,34,1],[440,17,440,18,1],[441,21,441,123,1],[442,21,443,115,1],[444,21,444,22,1],[445,25,445,62,1],[446,25,446,50,1],[447,29,447,66,0],[448,25,448,66,1],[449,25,449,26,1],[450,29,450,79,1],[453,29,453,50,1],[455,29,455,74,1],[456,29,456,76,1],[457,29,457,72,1],[459,29,459,74,1],[460,29,460,76,1],[461,29,461,76,1],[462,29,462,76,1],[463,29,463,64,1],[464,29,464,66,1],[465,29,465,70,1],[466,29,466,66,1],[467,29,467,74,1],[468,29,468,68,1],[469,29,469,62,1],[471,29,471,96,1],[472,29,472,88,1],[473,29,473,91,1],[476,29,476,74,1],[478,29,478,68,1],[480,29,480,30,0],[481,33,481,57,0],[482,33,482,87,0],[483,29,483,30,0],[485,29,486,81,1],[487,29,487,100,1],[489,29,489,70,1],[490,29,490,72,1],[491,29,491,80,1],[492,29,492,92,1],[493,29,493,70,1],[498,29,498,58,1],[499,29,499,108,1],[500,29,500,30,0],[501,33,501,58,0],[502,33,502,40,0],[507,29,507,94,1],[508,29,508,30,1],[510,33,510,148,1],[512,33,512,48,1],[514,33,514,118,1],[515,33,515,53,1],[516,33,516,34,0],[517,37,517,80,0],[518,37,518,72,0],[519,37,519,76,0],[520,37,520,99,0],[521,37,521,71,0],[522,37,522,64,0],[524,37,524,59,0],[525,37,525,87,0],[526,33,526,34,0],[528,33,528,34,1],[534,37,534,69,1],[535,37,535,56,1],[536,37,536,84,1],[537,33,537,34,1],[538,33,538,112,1],[539,33,539,34,1],[540,37,540,123,1],[542,37,542,72,1],[543,37,543,38,1],[544,41,544,75,1],[545,46,545,55,1],[545,57,545,71,1],[545,73,545,76,1],[546,41,546,42,1],[547,45,547,92,1],[548,45,548,46,1],[549,49,549,87,1],[550,45,550,46,1],[552,45,552,46,0],[553,49,553,119,0],[554,45,554,46,0],[555,41,555,42,1],[556,37,556,38,1],[558,37,558,38,0],[559,41,559,119,0],[560,37,560,38,0],[563,37,563,44,1],[563,46,563,53,0],[563,54,563,56,1],[563,57,563,72,1],[564,37,564,38,0],[566,41,566,118,0],[567,45,567,54,0],[569,41,569,87,0],[570,37,570,38,0],[573,37,573,77,1],[574,37,574,94,1],[576,37,576,52,1],[577,37,577,38,0],[578,41,578,120,0],[579,45,581,94,0],[582,41,582,61,0],[583,41,583,42,0],[585,45,585,46,0],[586,49,589,99,0],[590,45,590,46,0],[591,45,591,65,0],[592,45,592,46,0],[593,49,594,78,0],[595,45,595,46,0],[596,41,596,42,0],[598,41,598,101,0],[599,45,599,72,0],[600,37,600,38,0],[601,37,601,123,1],[602,33,602,34,1],[604,33,604,34,0],[605,37,605,97,0],[606,33,606,34,0],[607,29,607,30,1],[608,34,608,56,0],[609,29,609,30,0],[610,33,611,78,0],[612,33,612,68,0],[613,29,613,30,0],[615,29,615,30,0],[616,33,616,72,0],[617,33,617,68,0],[618,29,618,30,0],[619,25,619,26,1],[620,21,620,22,1],[622,21,622,22,0],[623,25,623,76,0],[624,25,624,60,0],[625,21,625,22,0],[626,17,626,18,1],[628,17,628,18,0],[629,21,629,56,0],[630,17,630,18,0],[631,13,631,14,1],[632,13,632,33,0],[633,13,633,14,0],[634,17,634,52,0],[635,17,635,93,0],[636,17,636,23,0],[638,9,638,10,1],[646,9,646,10,0],[647,13,647,63,0],[648,13,648,46,0],[649,13,649,48,0],[650,13,650,44,0],[651,13,657,37,0],[658,13,658,47,0],[659,13,659,38,0],[660,9,660,10,0],[663,9,663,10,0],[664,9,664,10,0],[667,9,667,10,1],[668,13,668,99,1],[669,9,669,10,1],[672,9,672,10,1],[673,13,673,41,1],[674,13,674,76,1],[675,13,675,82,1],[676,13,676,44,1],[677,9,677,10,1],[680,9,680,10,1],[681,13,681,65,1],[682,13,682,14,1],[683,17,683,107,1],[684,17,684,77,1],[685,13,685,14,1],[686,13,686,67,1],[687,13,687,14,1],[688,17,688,84,1],[689,17,689,84,1],[690,13,690,14,1],[691,13,691,50,1],[692,13,692,38,1],[693,17,693,78,0],[694,9,694,10,1]]);
    </script>
  </body>
</html>