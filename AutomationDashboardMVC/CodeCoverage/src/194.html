<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Pre-Payment\NewMOH.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.Configuration;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ContmgtDTO;
using Aurigo.AMP3.CONTMOHBL;
using Aurigo.AMP3.CONTMOHDTO;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.AMP3.WORKORDBL;
using Aurigo.AMP3.WORKORDDTO;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.WebUI.UltraWebGrid;
using Infragistics.WebUI.WebDataInput;
using System.Web.Script.Serialization;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.AMP3.CONTMOHUI
{
    [Serializable]
    public class StateMgmtMOHItems : StateManagementBase
    {
        public StateMgmtMOHItems(string constStr)
            : base(constStr)
        {
        }

        public int ContractID { get; set; }

        public void MaintainState(int ContractId, int pageIdx, string sortKey, SortIndicator sortOrder, string filterCriterion)
        {
            ContractID = ContractId;
            PageIndex = pageIdx;
            SortKey = sortKey;
            SortOrder = base.GetSortOrder(sortOrder);
            FilterCriterion = filterCriterion;
            UIHelper.UpdateModuleStateBag(&quot;MOHITEMS&quot;, this, HttpContext.Current);
        }
    }

    public partial class NewMOH : BrixPageBase, IWorkflowEnabled
    {
        private static string contractorType;
        private static int contractorID;
        private readonly string item = LocalizationManager.GetString(KeyConstants.LOC_ITEM);
        private readonly string stditem = GlobalizationUtility.SetResource(&quot;Item&quot;, false);
        protected ModalPopupExtender PopupExtender;
        private int _contractID;
        private GenericPickerControl matPicker;
        private StateMgmtMOHItems pageState;
        private int workOrderId;

        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid masterGrid;
        protected global::Infragistics.WebUI.WebSchedule.WebDateChooser wdcCreatedOn;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid G1;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneAmount;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneTotalAmt;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneRemAmt;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneAdvAmnt;
        protected global::Infragistics.WebUI.WebSchedule.WebDateChooser dtMOHDate;

        /// &lt;summary&gt;
        /// Gets the Integration Cutoff Date
        /// &lt;/summary&gt;
        private DateTime IntegrationCutoffDate
        {
            get { return ((DateTime)Session[Constants.APP_IntegrationCutoffDate]).AddDays(-1); }
        }

        /// &lt;summary&gt;
        /// Gets the Default Record Date
        /// &lt;/summary&gt;
        private DateTime DefaultRecordDate
        {
            get { return (DateTime)Session[Constants.APP_DefaultRecordDate]; }
        }

        private string ProjectMode
        {
            get { return (CacheManager.Instance.IsIntegrated(Request[Constants.QRY_PROJECTID].ToInt32_2()) ? &quot;I&quot; : &quot;L&quot;); }
        }

        #region IWorkflowEnabled Members

        public bool SaveHandler(object sender, out string sSavedInstanceToken, out string sErrors,
                                out string sRedirectTo)
        {
            sSavedInstanceToken = &quot;&quot;;
            sErrors = &quot;&quot;;
            sRedirectTo = &quot;&quot;;
            bool tranComplete = false;

            try
            {
                if (Convert.ToDateTime(dtMOHDate.Value, DateFormatCulture.GetDateFormatCulture()) &gt;
                    Convert.ToDateTime(wdcCreatedOn.Value, DateFormatCulture.GetDateFormatCulture()))
                    throw new Exception(LocalizationManager.GetString(&quot;MOHDate&quot;) + &quot; can not be above created date&quot;);
                
                string prePayment_Legend = GlobalizationUtility.SetResource(&quot;PrePayment&quot;, false);
                DTO dtoCntrct = BL.Instance.GetContract(Request[&quot;ContractID&quot;].ToInt32_2(), FetchSet.Default);

                if (dtoCntrct.Locked != &quot;Y&quot;)
                    throw new Exception(item + &quot;s are not locked. &quot; + prePayment_Legend + &quot; cannot be created before &quot; + item +
                                        &quot; are locked&quot;);

                string qtyChanged = &quot;N&quot;;
                string mohRet = string.Empty;


                if (contractorType == &quot;S&quot; || contractorType == &quot;P&quot;)
                {
                    if (ddlPrePaymentClassification.SelectedIndex == 0)
                        throw new Exception(&quot;Please select pre-payment type.&quot;);
                    decimal availableAmt = 0;
                    int mohID = (Request[&quot;MOHID&quot;] != null) ? Convert.ToInt32(Request[&quot;MOHID&quot;]) : 0;

                    DataRow drAvailableAmt =
                        MOHManager.Instance.GetWOAvailableAmt(Request[&quot;ContractID&quot;].ToInt32_2(),
                                                              (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? workOrderId : 0),
                                                              ddlPrePaymentClassification.SelectedItem.Value.ToInt32_2(),
                                                              mohID).Tables[0].Rows[0];
                    decimal usedPrePaymentvalue = drAvailableAmt[&quot;UsedPrepaymentValue&quot;].ToString().ToDecimal2();
                    decimal usedPrePaymentForRule = drAvailableAmt[&quot;UsedPrepaymentValueForRule&quot;].ToString().ToDecimal2();
                    decimal usedPrePaymentForPPTypeID =
                        drAvailableAmt[&quot;UsedPrepaymentValueForPPTypeID&quot;].ToString().ToDecimal2();
                    decimal totalPrePaymentValue = drAvailableAmt[&quot;TotalPrepaymentValue&quot;].ToString().ToDecimal2();
                    int countOfPPTypeIDMappedToWO = drAvailableAmt[&quot;PPTypeIDCount&quot;].ToString().ToInt32_2();
                    decimal maxPrepaymentAmount = drAvailableAmt[&quot;MAXPrepaymentValue&quot;].ToString().ToDecimal2();

                    if (countOfPPTypeIDMappedToWO == 0)
                    {
                        //if (totalPrePaymentValue - usedPrePaymentvalue - usedPrePaymentForRule &lt;= 0)
                        //    availableAmt = 0.0M;
                        //else
                        //    availableAmt = totalPrePaymentValue - usedPrePaymentvalue - usedPrePaymentForRule;
                        availableAmt = maxPrepaymentAmount - usedPrePaymentForPPTypeID;
                    }
                    else
                    {
                        if (totalPrePaymentValue - usedPrePaymentvalue - usedPrePaymentForRule &lt;= 0)
                        {
                            availableAmt = 0.0M;
                        }
                        else
                        {
                            decimal maxPrepaymentForPPTypeID =
                                drAvailableAmt[&quot;MAXPrepaymentValue&quot;].ToString().ToDecimal2();

                            decimal totalAvailableAmt = totalPrePaymentValue - usedPrePaymentvalue -
                                                        usedPrePaymentForRule;

                            if (maxPrepaymentForPPTypeID - usedPrePaymentForPPTypeID &gt; 0)
                                availableAmt = maxPrepaymentForPPTypeID - usedPrePaymentForPPTypeID;

                            availableAmt = (totalAvailableAmt &lt; availableAmt) ? totalAvailableAmt : availableAmt;
                            availableAmt = (availableAmt &lt; 0) ? 0 : availableAmt;
                        }
                    }
                    if (contractorType == &quot;S&quot;)
                    {
                        if (rbtnConMOH.Checked &amp;&amp; Math.Round(wneAdvAmnt.ValueDecimal, CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT), MidpointRounding.AwayFromZero) &gt; Math.Round(availableAmt, CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT), MidpointRounding.AwayFromZero))
                        {
                            throw new Exception(&quot;Contract advance amount for work order :&quot; + ViewState[&quot;WorkOrderNo&quot;] +
                                                &quot; and pre-payment classification :&quot; +
                                                ddlPrePaymentClassification.SelectedItem.Text + &quot; should not exceed &quot; +
                                                availableAmt + &quot;.&quot;);
                        }
                        else if (Math.Round(wneAmount.ValueDecimal, CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT),
                                             MidpointRounding.AwayFromZero) &gt; Math.Round(availableAmt, CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT),
                                             MidpointRounding.AwayFromZero))
                        {
                            throw new Exception(
                                &quot;Material advance amount exceeds available WorkOrder PrepaymentRule amount.&quot;);
                        }
                    }
                    else
                    {
                        if (rbtnConMOH.Checked &amp;&amp; Math.Round(wneAdvAmnt.ValueDecimal, CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT),
                                             MidpointRounding.AwayFromZero) &gt; Math.Round(availableAmt, CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT),
                                             MidpointRounding.AwayFromZero))
                        {
                            throw new Exception(&quot;Contract advance amount &quot; + &quot; and pre-payment classification :&quot; +
                                                ddlPrePaymentClassification.SelectedItem.Text + &quot; should not exceed &quot; +
                                                availableAmt + &quot;.&quot;);
                        }
                        else if (wneAmount.ValueDecimal &gt; Math.Round(availableAmt, CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT), MidpointRounding.AwayFromZero))
                        {
                            throw new Exception(&quot;Advance amount exceeds available  PrepaymentRule amount.&quot;);
                        }
                    }
                }

                if (rbtnMatMOH.Checked)
                {
                    if ((G1.Rows.Count == 0) &amp;&amp;
                        (String.IsNullOrEmpty(txtMaterialID.Value.Trim()) ||
                         String.IsNullOrEmpty(txtMaterialDesc.Text.Trim())))
                        throw new Exception(&quot;Please select a material.&quot;);

                    DataTable dt = new BrixDataTable(&quot;CONTMOHItems&quot;);
                    if (ViewState[&quot;CONTMOHItems&quot;] != null)
                        dt = ((DataTable)ViewState[&quot;CONTMOHItems&quot;]);

                    if (Request[&quot;MOHID&quot;] != null &amp;&amp; Request[&quot;ContractID&quot;] != null)
                    {
                        DataSet ds = MOHManager.Instance.GetMOH(Request[&quot;MOHID&quot;].ToInt32_2(),
                                                                Request[&quot;ContractID&quot;].ToInt32_2());
                        if (ds.Tables[0].Rows.Count &gt; 0)
                        {
                            DataRow dr = ds.Tables[0].Rows[0];
                            if (dr[&quot;Status&quot;].ToInt32_2() &gt; 1)
                            {
                                throw new Exception(prePayment_Legend + &quot; cannot be edited as it is closed by another user.&quot;);
                            }
                        }
                    }

                    Decimal amount = 0m;

                    foreach (UltraGridRow row in G1.DisplayLayout.Rows)
                    {
                        CellsCollection cells = row.Cells;

                        DataRow dr = dt.Select(&quot;ItemID=&#39;&quot; + cells.FromKey(&quot;ItemID&quot;).Value + &quot;&#39;&quot;)[0];

                        if (dr[&quot;Amount&quot;].ToDecimal2() != cells.FromKey(&quot;Amount&quot;).Value.ToDecimal2()
                            || dr[&quot;RecoveryQty&quot;].ToDecimal2() != cells.FromKey(&quot;RecoveryQty&quot;).Value.ToDecimal2())
                        {
                            qtyChanged = &quot;Y&quot;;
                        }

                        amount += Math.Round(cells.FromKey(&quot;Amount&quot;).Value.ToDecimal2(),
                                             CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT),
                                             MidpointRounding.AwayFromZero);
                        decimal rngLow = cells.FromKey(&quot;RangeLow&quot;).Value.ToDecimal2();
                        decimal rngHigh = cells.FromKey(&quot;RangeHigh&quot;).Value.ToDecimal2();
                        decimal qtyRec = cells.FromKey(&quot;RecoveryQty&quot;).Value.ToDecimal2();
                        decimal qtyRem = row.Cells.FromKey(&quot;Quantity&quot;).Value.ToDecimal2();
                        decimal recAmt = row.Cells.FromKey(&quot;Amount&quot;).Value.ToDecimal2();
                        decimal qtyRecd = cells.FromKey(&quot;RecoveredQty&quot;).Value.ToDecimal2();
                        decimal amtRecd = cells.FromKey(&quot;RecoveredAmt&quot;).Value.ToDecimal2();

                        if (recAmt &lt;= 0)
                            throw new Exception(&quot;Recovery Amount of &quot; + stditem +
                                                &quot;s cannot be negative or zero.\nRequest Denied&quot;);

                        if (qtyRec &lt;= 0)
                            throw new Exception(&quot;Recovery Quantity of &quot; + stditem +
                                                &quot;s cannot be negative or zero.\nRequest Denied&quot;);

                        if (cells.FromKey(&quot;RowChanged&quot;).Value == null ||
                            cells.FromKey(&quot;RowChanged&quot;).Value.ToString2() == &quot;N&quot; ||
                            (qtyRec == qtyRecd &amp;&amp; recAmt == amtRecd))
                            continue;
                        if (qtyRec == qtyRecd &amp;&amp; recAmt != amtRecd)
                            throw new Exception(&quot;One or more &quot; + stditem +
                                                &quot;s have been completely recovered. Quantity or Amount cannot be changed.\nRequest Denied.&quot;);
                        if (qtyRec != qtyRecd &amp;&amp; recAmt == amtRecd)
                            throw new Exception(&quot;One or more &quot; + stditem +
                                                &quot;s have been completely recovered. Quantity or Amount cannot be changed.\nRequest Denied.&quot;);

                        //throw new Exception(&quot;One or Pay Items have been completely recovered. Quantity or Amount cannot be changed.\nRequest Denied.&quot;);

                        if (qtyRem &lt; (qtyRec - qtyRecd))
                            throw new Exception(&quot;One or more &quot; + stditem +
                                                &quot;&#39;s Recovery Quantity is greater than Remaining Quantity.\nRequest Denied.&quot;);
                        if (cells.FromKey(&quot;MaxAmt&quot;).Value.ToDecimal2() &lt; (recAmt - amtRecd))
                            throw new Exception(&quot;One or more &quot; + stditem +
                                                &quot;&#39;s Recovery Amount is greater than the Pay Item Amount.\nRequest Denied.&quot;);

                        if (rngLow &lt; rngHigh)
                        {
                            if (qtyRec &lt; rngLow || qtyRec &gt; rngHigh)
                                throw new Exception(&quot;One or more &quot; + stditem +
                                                    &quot;&#39;s Recovery Quantity is not within the Recovery Range.\nRequest Denied.&quot;);
                        }
                        else if (qtyRec &gt; rngLow || qtyRec &lt; rngHigh)
                            throw new Exception(&quot;One or more &quot; + stditem +
                                                &quot;&#39;s Recovery Quantity is not within the Recovery Range.\nRequest Denied.&quot;);

                        if (qtyRec &lt; cells.FromKey(&quot;RecoveredQty&quot;).Value.ToDecimal2())
                            throw new Exception(&quot;One or more &quot; + stditem +
                                                &quot;&#39;s Recovery Quantity is less than the Recovered Quantity.\nRequest Denied.&quot;);
                        if (recAmt &lt; cells.FromKey(&quot;RecoveredAmt&quot;).Value.ToDecimal2())
                            throw new Exception(&quot;One or more &quot; + stditem +
                                                &quot;&#39;s Recovery Amount is less than the Recovered Amount.\nRequest Denied.&quot;);
                        //if (qtyRem &lt; qtyRec)
                        //    throw new Exception(&quot;One or more Pay Item&#39;s Recovery Quantity is greater than the Pay Item&#39;s Remaining Quantity.\nRequest Denied.&quot;);
                    }
                    if (
                        !((wneAmount.ValueDecimal == amount) ||
                          (wneAmount.ValueDecimal.ToString2().Equals(
                              Math.Round(amount, CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT),
                                         MidpointRounding.AwayFromZero).ToString2()))))
                        throw new Exception(&quot;The sum of all the amounts entered for the &quot; + stditem +
                                            &quot;s must equal the total transaction amount.&quot;);
                }
                if (ViewState[&quot;canBeSaved&quot;].ToBoolean2())
                {
                    var dto = new MOHDTO();
                    if (Request[&quot;MOHID&quot;] != null)
                    {
                        dto.MOHID = Request[&quot;MOHID&quot;].ToInt32_2();
                        if (ViewState[&quot;DeletedItems&quot;] != null)
                            dto.MOHDeletedItems = (List&lt;MOHDeletedItem&gt;)(ViewState[&quot;DeletedItems&quot;]);
                    }

                    if (contractorType == &quot;P&quot;)
                        dto.IsPrimeContractor = true;
                    else
                        dto.IsPrimeContractor = false;

                    if (!dto.IsPrimeContractor)
                    {
                        dto.WorkOrderNo = ViewState[&quot;WorkOrderNo&quot;].ToString2();
                    }

                    dto.ContractorID = contractorID;
                    dto.Contractor = lblContractorName.Text;
                    dto.ContractID = Request[&quot;ContractID&quot;].ToInt32_2();
                    //dto.MOHType = (contractorType == &quot;P&quot;) ? null : (ddlPrePaymentClassification.SelectedItem.Value).ToString2();
                    dto.MOHType = (ddlPrePaymentClassification.SelectedItem.Value).ToString2();
                    dto.MOHDate = dtMOHDate.Value.ToDateTime_MWCulture();
                    dto.Comments = txtComments.Text;
                    dto.PrepayDesc = txtPrepayDesc.Text;
                    //dto.Comments = txtComments.varchar; ;

                    dto.CreatedBy = UserDetail.GetCurrentUserDetail().UID;
                    dto.CreatedDate = Convert.ToDateTime(wdcCreatedOn.Value, DateFormatCulture.GetDateFormatCulture());
                    dto.Status = 0;
                    dto.IsContractPrePayment = rbtnConMOH.Checked;
                    if (dto.IsContractPrePayment)
                    {
                        dto.Amount = wneAdvAmnt.ValueDecimal;
                    }
                    else
                    {
                        dto.Amount = wneAmount.ValueDecimal;

                        // TODO : Clean Up Hack
                        int nTemp = 0;
                        dto.MaterialID = Int32.TryParse(txtMaterialID.Value, out nTemp)
                                             ? txtMaterialID.Value.ToInt32_2()
                                             : 0;
                        dto.MaterialDesc = Request[txtMaterialDesc.UniqueID]; // txtMaterialDesc.Text;

                        dto.RemainingAmount = dto.Amount;
                        foreach (UltraGridRow row in G1.DisplayLayout.Rows)
                        {
                            CellsCollection cells = row.Cells;
                            var item1 = new MOHItem();
                            item1.ItemID = cells.FromKey(&quot;ItemID&quot;).Value.ToInt32_2();
                            item1.GroupID = -1;
                            item1.Amount = cells.FromKey(&quot;Amount&quot;).Value.ToDecimal2();
                            item1.RecoveryQty = cells.FromKey(&quot;RecoveryQty&quot;).Value.ToDecimal2();
                            dto.MOHItems.Add(item1);
                        }
                    }

                    try
                    {
                        //To Store IntegrationMode
                        dto.IsIntegrationMode = ProjectMode == null ? true : (ProjectMode.Equals(&quot;I&quot;)) ? true : false;

                        if (Request[&quot;WOID&quot;] != null)
                            dto.WorkOrdID = Request[&quot;WOID&quot;].ToInt32_2();

                        mohRet = MOHManager.Instance.CreateMOH(dto, qtyChanged);

                        sSavedInstanceToken = dto.MOHID.ToString();

                        _formkey = string.Format(&quot;Prepayment ID : {0}, Contractor : {1}&quot;, sSavedInstanceToken, lblContractorName.Text);

                        if (mohRet.Equals(&quot;error&quot;))
                            throw new Exception(&quot;Creation of &quot; + prePayment_Legend + &quot; failed&quot;);
                        else if (mohRet.Equals(&quot;greater&quot;))
                            throw new Exception(&quot;Pre-payment amount exceeds total contract amount&quot;);
                        else if (mohRet.Equals(&quot;Final&quot;))
                            throw new Exception(&quot;Final &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; exists for the &quot; +
                                                ((String.IsNullOrEmpty(dto.WorkOrderNo)) ? &quot;workorder&quot; : &quot;contract&quot;) +
                                                &quot;. Request denied.&quot;);
                    }
                    catch (Exception ex)
                    {
                        if (ex.Message.Contains(&quot;marked as complete&quot;) ||
                            ex.Message.Equals(&quot;Pre-payment amount exceeds total contract amount&quot;) ||
                            ex.Message.Contains(&quot;Final &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; exists for the&quot;))
                            throw ex;
                    }
                    tranComplete = true;
                    if (tranComplete)
                    {
                        //if (!string.IsNullOrEmpty(ViewState[&quot;WorkOrderNo&quot;].ToString2()))
                        //    Response.Redirect(BrixDatatypeHelper.Format2(&quot;~/Common/BrixListPage.aspx?context=CONTMOH&amp;PID={0}&amp;ContractID={1}&amp;&quot; + Constants.QRY_PROJECTMODE + &quot;={2}&amp;WOID=&quot; + workOrderId, Request[&quot;PID&quot;], Request[&quot;ContractID&quot;], PMode), false);
                        //else
                        //    Response.Redirect(BrixDatatypeHelper.Format2(&quot;~/Common/BrixListPage.aspx?context=CONTMOH&amp;PID={0}&amp;ContractID={1}&amp;&quot; + Constants.QRY_PROJECTMODE + &quot;={2}&quot; + (workOrderId != 0 ? &quot;&amp;WOID=&quot; + workOrderId : string.Empty), Request[&quot;PID&quot;], Request[&quot;ContractID&quot;], PMode), false);
                        return true;
                    }
                    else
                        return false;
                }
                else
                    tranComplete = true;
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                Page.ClientScript.RegisterStartupScript(GetType(), &quot;showAlert&quot;,
                                                        &quot;ShowError(&quot; + JS.Serialize(ex.Message) + &quot;);&quot;, true);
            }

            return tranComplete;
        }

        public void CancelHandler(object sender, bool bAfterSave, out string sRedirectTo)
        {
            throw new NotImplementedException();
        }

        public string FormInstanceId
        {
            get
            {
                int id = (String.IsNullOrEmpty(Request.QueryString[&quot;MOHID&quot;]) ||
                          Request.QueryString[&quot;MOHID&quot;].ToString2() == &quot;0&quot;)
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;MOHID&quot;], out id) ? id : -1;
                return id.ToString();
            }
        }

        protected string _formkey = string.Empty;
        public string FormKey
        {
            get { return _formkey; }
        }

        public string FormName
        {
            get { return &quot;XMOHFRM&quot;; }
        }

        public bool IsOldWorkflow
        {
            get { return true; }
        }

        public string ClientValidationFunction
        {
            get { return &quot;Validate()&quot;; }
        }

        public int PID
        {
            get { return Request.QueryString[&quot;PID&quot;].ToInt32_2(); }
        }

        public int ParentModuleId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;ContractID&quot;])
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;ContractID&quot;], out id) ? id : -1;
                return id;
            }
        }

        public string PostCancelRedirectUrl
        {
            get
            {
                return ((!string.IsNullOrEmpty(ViewState[&quot;WorkOrderNo&quot;].ToString2()))
                            ? (&quot;~/Common/BrixListPage.aspx?context=CONTMOH&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID=&quot; + workOrderId)
                                  .Format2(Request[&quot;PID&quot;], Request[&quot;ContractID&quot;])
                            : (&quot;~/Common/BrixListPage.aspx?context=CONTMOH&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&quot; +
                               (workOrderId != 0 ? &quot;&amp;WOID=&quot; + workOrderId : string.Empty)).Format2(Request[&quot;PID&quot;],
                                                                                                   Request[&quot;ContractID&quot;]));
            }
        }

        public string PostSaveRedirectUrl(string sSavedToken = &quot;&quot;)
        {
            if (!string.IsNullOrEmpty(Request[&quot;Mode&quot;]))
                return &quot;NewMOH.aspx?ContractID={0}&amp;ParentID={0}&amp;PID={1}&amp;ParentContext=CONTMGT&quot;.Format2(Request[&quot;ContractID&quot;],
                                                                                          Request[&quot;PID&quot;]);
            return ((!string.IsNullOrEmpty(ViewState[&quot;WorkOrderNo&quot;].ToString2()))
                        ? (&quot;~/Common/BrixListPage.aspx?context=CONTMOH&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID=&quot; + workOrderId).
                              Format2(Request[&quot;PID&quot;], Request[&quot;ContractID&quot;])
                        : (&quot;~/Common/BrixListPage.aspx?context=CONTMOH&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&quot; +
                           (workOrderId != 0 ? &quot;&amp;WOID=&quot; + workOrderId : string.Empty)).Format2(Request[&quot;PID&quot;],
                                                                                               Request[&quot;ContractID&quot;]));
        }

        #endregion

        //BrixFilter filters;
        //private int _MOHID = 0;
        protected override void OnInit(EventArgs e)
        {
            // set the list of permissions to be checked.
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);

            if (!string.IsNullOrEmpty(Request.QueryString[&quot;Type&quot;]))
            {
                if (Request.QueryString[&quot;Type&quot;].Equals(&quot;E&quot;, StringComparison.CurrentCultureIgnoreCase))
                    PermissionsToCheck.Add(Constants.MODFEAT_EDIT);
                else if (Request.QueryString[&quot;Type&quot;].Equals(&quot;N&quot;, StringComparison.CurrentCultureIgnoreCase))
                    PermissionsToCheck.Add(Constants.MODFEAT_CREATE);
            }

            (mypager as PagerControl).ItemClicked += HandlePagerEvent;
            mypager.EnableViewState = true;
            masterGrid.SortColumn += masterGrid_SortColumn;

            //ModalPopupExtender PopupExtender = (ModalPopupExtender)this.Master.FindControl(&quot;filterExtender&quot;);
            PopupExtender.Visible = true;
            PopupExtender.AddNewPopup(pnlContrctItems.ClientID, btnAddItemTmp.ClientID, btnItemsCancel.ClientID, 400,
                                      500, &quot;Apply Filter&quot;);

            matPicker = (MaterialPicker as GenericPickerControl);
            matPicker.DisplayFilter = matPicker.IsFilterXml = true;


            var filter = new BrixFilter[2];
            filter[0] = new BrixFilter();
            filter[0].FilterType = BrixFilter.Type.Text;
            filter[0].MaxLength = 100;
            filter[0].Name = &quot;Description&quot;;
            filter[0].Title = &quot;Description&quot;;

            filter[1] = new BrixFilter();
            filter[1].FilterType = BrixFilter.Type.Text;
            filter[1].MaxLength = 100;
            filter[1].Name = &quot;Unit&quot;;
            filter[1].Title = &quot;Unit&quot;;

            matPicker.Filters = filter;

            hdnQuantityDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY).ToString2();
            hdnAmountDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT).ToString2();

            base.OnInit(e);
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            AddSaveButton(menus);
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
            base.CreateChildControls();

            if (IsWorkflowAssociated(FormName))
            {
                if (Request[&quot;Type&quot;] == &quot;E&quot;)
                {
                    DataSet ds = MOHManager.Instance.GetMOH(Request[&quot;MOHID&quot;].ToInt32_2(),
                                                            Request[&quot;ContractID&quot;].ToInt32_2());

                    if (ds.Tables[0].Rows[0][&quot;StatusName&quot;].ToString() == &quot;Approved&quot; || ds.Tables[0].Rows[0][&quot;StatusName&quot;].ToString() == &quot;Fully Recovered&quot;)
                    {
                        if (HasSaveButton)
                        {
                            Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                            if (null != lnkSave)
                            {
                                MainToolBar.HideMenu(&quot;lnkSave&quot;);
                            }
                        }
                    }
                }
            }
        }

        protected override void CustomizeToolBar()
        {
            if (HasSaveButton)
            {
                Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                if (null != lnkSave)
                {
                    lnkSave.Click += Save_Click;
                    if (_WorkflowsInitiated != null &amp;&amp; _WorkflowsInitiated.Count&gt;0)
                        lnkSave.OnClientClick = &quot;javascript: DisableControlsOnSaveAndWFAction(&#39;&quot; + _WorkflowsInitiated[0].ToString() + &quot;&#39;); var result= Validate(); if(!result) {EnableControlsOnSaveAndWFAction(&#39;&quot; + _WorkflowsInitiated[0].ToString() + &quot;&#39;); return false;} else return true;&quot;;
                    else
                    lnkSave.OnClientClick = &quot;javascript: return Validate();&quot;;
                    lnkSave.ToolTip = &quot;Save&quot;;
                }
            }
            if (MainToolBar.GetMenuReference(&quot;lnkCancel&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += Cncl_Click;
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).OnClientClick += &quot;javascript: return CancelMOH(this);&quot;;
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;
            }
        }

        public void HandlePagerEvent(object sender, ItemClickEventArgs e)
        {
            BindData();

            masterGrid.DisplayLayout.Pager.CurrentPageIndex = 1;

            pageState.MaintainState(Request[&quot;ContractID&quot;].ToInt32_2(),
                (mypager.FindControl(&quot;currentPage&quot;) as HtmlInputHidden).Value.ToInt32_2(),
                pageState.SortKey, UIHelper.GetSortIndicator(ViewState[Constants.ODS_SORTORDER]),
                ViewState[Constants.ODS_FILTER] == null ? null : ViewState[Constants.ODS_FILTER].ToString2());
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            //rbtnPC.Attributes.Add(&quot;onclick&quot;, &quot;ContractorChosen(&#39;P&#39;);&quot;);
            //rbtnSC.Attributes.Add(&quot;onclick&quot;, &quot;ContractorChosen(&#39;S&#39;);&quot;);

            rbtnConMOH.Attributes.Add(&quot;onclick&quot;, &quot;javascript:return ChooseMOHType(&#39;C&#39;);&quot;);
            rbtnMatMOH.Attributes.Add(&quot;onclick&quot;, &quot;javascript:return ChooseMOHType(&#39;M&#39;);&quot;);

            //ddlSubContractors.SelectedIndexChanged += new EventHandler(LoadWorkOrders);

            btnReset.Attributes.Add(&quot;onClick&quot;, &quot;return resetFilters();&quot;);
            lblErr.Text = &quot;&quot;;
            if (String.IsNullOrEmpty(Request[MOHConstants.QRY_CONTRACTID]) ||
                String.IsNullOrEmpty(Request[Constants.QRY_PROJECTID]))
                Response.Redirect(
                    &quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] ?? String.Empty,
                    true);

            _contractID = Request.QueryString[MOHConstants.QRY_CONTRACTID].ToInt32_2();

            workOrderId = 0;
            if (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]))
                int.TryParse(Request[&quot;WOID&quot;].Replace(&quot;,&quot;, &quot;&quot;), out workOrderId);

            ViewState[&quot;canBeSaved&quot;] = true;

            if (!IsPostBack)
            {
                wdcCreatedOn.CalendarLayout.Culture = DateFormatCulture.GetDateFormatCulture();
                wdcCreatedOn.MinDate = ProjectMode.Equals(&quot;L&quot;) ? MWDateTimeHelper.MWNow : DefaultRecordDate.ToMWDateTime();
                wdcCreatedOn.MaxDate = ProjectMode.Equals(&quot;L&quot;) ? MWDateTimeHelper.MWNow : IntegrationCutoffDate.ToMWDateTime();
                wdcCreatedOn.Value = ProjectMode.Equals(&quot;L&quot;) ? MWDateTimeHelper.MWNow : DefaultRecordDate.ToMWDateTime();
                wdcCreatedOn.Enabled = !ProjectMode.Equals(&quot;L&quot;);
                dtMOHDate.MaxDate = ProjectMode.Equals(&quot;L&quot;) ? MWDateTimeHelper.MWNow : IntegrationCutoffDate.ToMWDateTime();

                DataSet dsContractor = MOHManager.Instance.GetContractor(Request[&quot;ContractID&quot;].ToInt32_2(), workOrderId);
                lblContractorName.Text = dsContractor.Tables[0].Rows[0][&quot;Contractor&quot;].ToString2();
                contractorType = dsContractor.Tables[0].Rows[0][&quot;ContractorType&quot;].ToString2();
                hdnContractorType.Value = contractorType;
                //if (contractorType == &quot;P&quot;)
                //{
                //trPPType.Style.Add(&quot;display&quot;, &quot;none&quot;);
                //trTotalAmt.Style.Add(&quot;display&quot;, &quot;none&quot;);
                //trRemAmt.Style.Add(&quot;display&quot;, &quot;none&quot;);
                //}
                contractorID = int.Parse(dsContractor.Tables[0].Rows[0][&quot;ContractorID&quot;].ToString2());
                if (workOrderId != 0)
                {
                    WorkOrderDTO WODTO = WORKORDManager.Instance.GetWorkOrderDetails(workOrderId);
                    string workOrdNo = WODTO.WorkOrderNo;
                    ViewState[&quot;WorkOrderNo&quot;] = workOrdNo;
                    if (!string.IsNullOrEmpty(workOrdNo))
                    {
                        trWOno.Style.Add(&quot;display&quot;, &quot;block&quot;);
                        lblWorkOrderNo.Text = ViewState[&quot;WorkOrderNo&quot;].ToString2();
                    }
                }
                ddlPrePaymentClassification.DataSource = dsContractor.Tables[1];
                ddlPrePaymentClassification.DataValueField = &quot;ID&quot;;
                ddlPrePaymentClassification.DataTextField = &quot;MOHType&quot;;
                ddlPrePaymentClassification.DataBind();
                ddlPrePaymentClassification.Items.Insert(0, &quot;Select-One&quot;);

                /* to disable the role dropdown in the master page*/
                UIHelper.DisableRoleSelection(Page);
                wneAmount.ValueDecimal = 0;
                txtPrepayDesc.Attributes.Add(&quot;maxlength&quot;, &quot;8000&quot;);
                txtComments.Attributes.Add(&quot;maxLength&quot;, &quot;8000&quot;);
                divCon.Style.Add(&quot;display&quot;, &quot;none&quot;);
                fsCon.Style.Add(&quot;display&quot;, &quot;none&quot;);
                divMat.Style.Add(&quot;display&quot;, &quot;none&quot;);
                fsMat.Style.Add(&quot;display&quot;, &quot;none&quot;);
                try
                {
                    DTO dtoCntrct = BL.Instance.GetContract(Request[&quot;ContractID&quot;].ToInt32_2(), FetchSet.Default);

                    if (dtoCntrct.Locked != &quot;Y&quot;)
                        throw new Exception(item + &quot;s not locked&quot;);
                }
                catch
                {
                    Response.Redirect(
                        &quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] ??
                        String.Empty, true);
                }

                ApplyFormattoWne(wneTotalAmt, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                ApplyFormattoWne(wneRemAmt, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                ApplyFormattoWne(wneAdvAmnt, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
            }

            UltraGridColumn column;

            if (!masterGrid.Columns.Exists(&quot;CompleteText&quot;))
            {
                column = new UltraGridColumn();
                column.Header.Caption = &quot;Complete&quot;;
                column.Hidden = true;
                column.Key = &quot;CompleteText&quot;;
                masterGrid.Columns.Add(column);
            }

            if (!masterGrid.Columns.Exists(&quot;NCText&quot;))
            {
                column = new UltraGridColumn();
                column.Header.Caption = &quot;Non-Contract&quot;;
                column.Hidden = true;
                column.Key = &quot;NCText&quot;;
                masterGrid.Columns.Add(column);
            }

            if (!masterGrid.Columns.Exists(&quot;LSText&quot;))
            {
                column = new UltraGridColumn();
                column.Header.Caption = &quot;Lumpsum&quot;;
                column.Hidden = true;
                column.Key = &quot;LSText&quot;;
                masterGrid.Columns.Add(column);
            }

            if (
                (pageState =
                 UIHelper.GetModuleFromStateBag(MOHConstants.GSTATE_CONTRCT_ITEM, Context) as StateMgmtMOHItems) == null)
            {
                pageState = new StateMgmtMOHItems(MOHConstants.GSTATE_CONTRCT_ITEM);
                UIHelper.UpdateModuleStateBag(MOHConstants.GSTATE_CONTRCT_ITEM, pageState, Context);
            }
            else if (!WebConfigurationManager.AppSettings[&quot;StateMgmtGlobal&quot;].ToBoolean2()
                     &amp;&amp; Request.UrlReferrer != null
                     &amp;&amp; !Array.Exists(Request.UrlReferrer.Segments,
                                      delegate (string s)
                                      {
                                          return (s != null &amp;&amp;
                                                  s.StartsWith(MOHConstants.MODULE_NAME,
                                                               StringComparison.OrdinalIgnoreCase));
                                      }
                             ) || pageState.ContractID != Request[&quot;ContractID&quot;].ToInt32_2())
            {
                pageState.ClearState();
            }
            else
            {
                ViewState[Constants.ODS_SORTORDER] = pageState.SortOrder;
                ViewState[Constants.ODS_FILTER] = (pageState.FilterCriterion != null
                                                       ? pageState.FilterCriterion
                                                       : UIHelper.GenerateFilterXML(aspPnlFilter).ToString2());
                (mypager.FindControl(&quot;currentPage&quot;) as HtmlInputHidden).Value = pageState.PageIndex.ToString2();
                if (ViewState[Constants.ODS_FILTER] != null &amp;&amp; !IsPostBack)
                {
                    pageState.RestoreFilterState(Page, ViewState[Constants.ODS_FILTER].ToString2());
                }
                else if (ViewState[Constants.ODS_FILTER] == null &amp;&amp; pageState.PageIndex == 0)
                {
                    // Page.ClientScript.RegisterStartupScript(GetType(), &quot;resetFilters&quot;, &quot;resetFilters();&quot;, true);
                }
            }
            if (ViewState[Constants.ODS_FILTER] != null)
            {
                //Page.ClientScript.RegisterStartupScript(GetType(), &quot;showHideFilterButtons&quot;, &quot;showHideFilterButtons();&quot;, true);
            }
            if (!IsPostBack) // need to figure why this part || (IsPostBack &amp;&amp; pageState.PageIndex == 0))
            {
                //LoadMaterialsList();
                LoadSubContractorsList();
                GetPageCount();
                if (!string.IsNullOrEmpty(pageState.SortKey))
                {
                    ApplyFilter();
                }
                else
                {
                    ViewState[Constants.ODS_SORTORDER] =
                        Regex.Replace(
                            ViewState[Constants.ODS_SORTORDER] == null
                                ? String.Empty
                                : ViewState[Constants.ODS_SORTORDER].ToString2(), &quot;(ASC|DESC)$&quot;,
                            ViewState[Constants.ODS_SORTORDER].ToString2().EndsWith(&quot;ASC&quot;,
                                                                                    StringComparison.OrdinalIgnoreCase)
                                ? &quot;DESC&quot;
                                : &quot;ASC&quot;);

                    //if (masterGrid.Columns.Count &lt;= 0 || masterGrid.Columns[pageState.SortColIdx] == null)
                    BindData();

                    ApplySort(pageState.SortKey);
                }
                pageState.setPagerProperties(mypager);
                if (Request[&quot;Type&quot;] != null &amp;&amp; Request[&quot;Type&quot;].Trim().ToUpper2() == &quot;E&quot;)
                {
                    if (Request[&quot;MOHID&quot;] != null)
                        BindMOHData(Request[&quot;MOHID&quot;].ToInt32_2(), Request[&quot;ContractID&quot;].ToInt32_2());
                }
                else
                {
                    DataTable dt = new BrixDataTable(&quot;CONTMOHItems&quot;);
                    SetupColumns(dt);
                    ViewState[&quot;CONTMOHItems&quot;] = dt;
                    G1.DataSource = dt;
                    G1.DataBind();
                    FormatGridColumns();
                    dtMOHDate.Value = MWDateTimeHelper.MWToday;
                }
            }

            //Making Contract Prepayment is default and disabling Material prepayment
            rbtnConMOH.Checked = true;

            if (rbtnConMOH.Checked)
            {
                divCon.Style.Add(&quot;display&quot;, &quot;block&quot;);
                fsCon.Style.Add(&quot;display&quot;, &quot;block&quot;);

                divMat.Style.Add(&quot;display&quot;, &quot;none&quot;);
                fsMat.Style.Add(&quot;display&quot;, &quot;none&quot;);
            }
            else if (rbtnMatMOH.Checked)
            {
                divCon.Style.Add(&quot;display&quot;, &quot;none&quot;);
                fsCon.Style.Add(&quot;display&quot;, &quot;none&quot;);
                divMat.Style.Add(&quot;display&quot;, &quot;block&quot;);
                fsMat.Style.Add(&quot;display&quot;, &quot;block&quot;);
            }

            if (rbtnSC.Checked)
            {
                trSC.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trWONos.Style.Add(&quot;display&quot;, &quot;none&quot;);
            }
            else
            {
                trSC.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trWONos.Style.Add(&quot;display&quot;, &quot;none&quot;);
            }


            SetLocalizedStrings();
            if (divMaterialPicker.Visible)
            {
                LoadMaterialsList(false);
            }
        }

        protected override void OnPreRender(EventArgs e)
        {
            if (divMaterialPicker.Visible)
                PageTitle = &quot;Select a Material&quot;;
            else
                PageTitle = ((String.IsNullOrEmpty(Request[&quot;MOHID&quot;])) || (Request[&quot;MOHID&quot;].ToDecimal2() == 0)
                                 ? &quot;New &quot;
                                 : &quot;Edit &quot;) + &quot;Pre-Payment&quot;;
            // tdHeader.InnerText = &quot;new&quot; + GlobalizationUtility.SetResource(&quot;MOH&quot;,true);

            if (!String.IsNullOrEmpty(Request[&quot;Mode&quot;]) &amp;&amp; Request[&quot;Mode&quot;] == &quot;View&quot;)
            {
                if (HasSaveButton)
                {
                    Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        MainToolBar.HideMenu(&quot;lnkSave&quot;);
                    }
                }
            }

            base.OnPreRender(e);
        }

        private void ShowHideDiv(DivTypes div)
        {
            divMOH.Visible = (div == DivTypes.MOHDiv);
            divMaterialPicker.Visible = (div == DivTypes.MaterialPickerDiv);
        }


        private bool LoadMaterialsList(bool Reload)
        {
            matPicker = (MaterialPicker as GenericPickerControl);
            var dsFilter = new Dictionary&lt;string, string&gt;();
            if (!rbtnPC.Checked &amp;&amp; !rbtnSC.Checked)
            {
                Page.ClientScript.RegisterStartupScript(GetType(), &quot;NoContractorsForMOH&quot;,
                                                        &quot;ShowError(&#39;No Contractors associated.&#39;);&quot;, true);
                return false;
            }
            else if (rbtnPC.Checked)
            {
                dsFilter.Add(&quot;ParentInstanceID&quot;, _contractID.ToString2());
                matPicker.DataSourceFilter = dsFilter;
                matPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
                matPicker.ModifyColumnProperties(&quot;ResourceDetailID&quot;, true, null, null, null, false);
                matPicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
                if (Reload)
                    matPicker.ChangeTableOrViewAndBind(&quot;vwContractMaterialList&quot;);
                else
                    matPicker.TableOrViewName = &quot;vwContractMaterialList&quot;;
            }
            else
            {
                //Load only materials associated with items that are part of Work Order
                if (ddlSubContractors.SelectedItem != null &amp;&amp; !ddlSubContractors.SelectedItem.Text.Equals(&quot;Select-One&quot;)
                    &amp;&amp; ddlWorkOrderList.SelectedItem != null &amp;&amp; !ddlWorkOrderList.SelectedItem.Text.Equals(&quot;Select-One&quot;))
                {
                    int workOrderID = ddlWorkOrderList.SelectedItem.Value.ToInt32_2();
                    matPicker.DataSourceFilter = dsFilter;
                    matPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
                    matPicker.ModifyColumnProperties(&quot;ResourceDetailID&quot;, true, null, null, null, false);
                    matPicker.ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);

                    if (Reload)
                        matPicker.ChangeTableOrViewAndBind(&quot;dbo.fnCONTMOHGetWorkOrderMaterialsList(&quot; +
                                                           workOrderID.ToString2() + &quot;)&quot;);
                    else
                        matPicker.TableOrViewName = &quot;dbo.fnCONTMOHGetWorkOrderMaterialsList(&quot; + workOrderID.ToString2() +
                                                    &quot;)&quot;;
                    if (!matPicker.IsRecordsExists &amp;&amp; Reload)
                    {
                        Page.ClientScript.RegisterStartupScript(GetType(), &quot;NoMaterialsForWorkOrder&quot;,
                                                                &quot;ShowError(&#39;No Materials associated with the Work Order!&#39;);&quot;,
                                                                true);
                        return false;
                    }
                }
                else
                {
                    ShowHideDiv(DivTypes.MOHDiv);
                    return false;
                }
            }
            txtMaterialDesc.Text = string.Empty;
            return true;
        }

        private void LoadSubContractorsList()
        {
            ddlSubContractors.DataSource = MOHManager.Instance.GetSubContractorsList(_contractID);
            ddlSubContractors.DataTextField = &quot;Contact&quot;;
            ddlSubContractors.DataValueField = &quot;ContractorID&quot;;
            ddlSubContractors.DataBind();
            ddlSubContractors.Items.Insert(0, &quot;Select-One&quot;);
        }

        private void LoadWorkOrders(object obj, EventArgs e)
        {
            if (ddlSubContractors.SelectedItem != null &amp;&amp; !ddlSubContractors.SelectedItem.Text.Equals(&quot;Select-One&quot;))
            {
                ViewState[&quot;WorkOrderData&quot;] =
                    WORKORDManager.Instance.GetWOOrContractor(_contractID, null,
                                                              ddlSubContractors.SelectedItem.Value.ToInt32_2()).DataSet.
                        Tables[1];
                if (ViewState[&quot;WorkOrderData&quot;] != null)
                {
                    ddlWorkOrderList.DataSource = ViewState[&quot;WorkOrderData&quot;];
                    ddlWorkOrderList.DataTextField = &quot;WorkOrderNo&quot;;
                    ddlWorkOrderList.DataValueField = &quot;WorkOrderID&quot;;
                }
                ddlWorkOrderList.DataBind();
                ddlWorkOrderList.Items.Insert(0, &quot;Select-One&quot;);
                for (int i = 0; i &lt; ddlWorkOrderList.Items.Count; i++)
                {
                    ddlWorkOrderList.Items[i].Attributes.Add(&quot;title&quot;, ddlWorkOrderList.Items[i].Text);
                }
            }
        }

        private void SetLocalizedStrings()
        {
            tdPnItems.InnerText = &quot;Add Item&quot;;
            //hdnItem.Value = LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR);
            tdItem.InnerText = &quot;Item Type :&quot;;
            //hdnPI.Value = LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO).Replace(&quot; No.&quot;, &quot;&quot;);
            tdPI.InnerText = &quot;Pay Item No. :&quot;;
            tdSec.InnerText = &quot;Section&quot;;
            tdPI2.InnerText = &quot;Contract Items&quot;;

            var info = new NumberFormatInfo();
            info.CurrencySymbol = LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL);

            wneAmount.NumberFormat = info;
            string[] str = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT.Split(&quot;.&quot;.ToCharArray());

            MinDecimalPlaces enumDec = (MinDecimalPlaces)(Enum.ToObject(typeof(MinDecimalPlaces), CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT)));
            wneAmount.MinDecimalPlaces = enumDec;
            hdnDecimal.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT).ToString();
        }

        private void BindMOHData(int MOHID, int ContractID)
        {
            DataSet ds = MOHManager.Instance.GetMOH(MOHID, ContractID);

            if (ds.Tables[0].Rows.Count &gt; 0)
            {
                DataRow dr = ds.Tables[0].Rows[0];

                ddlPrePaymentClassification.SelectedValue = dr[&quot;MOHTypeID&quot;].ToString();

                bool IsContractAdvance = dr[&quot;PrePaymentType&quot;].ToString2().ToBoolean2();
                (IsContractAdvance ? rbtnConMOH : rbtnMatMOH).Checked = true;
                if (IsContractAdvance)
                {
                    decimal availableAmt = 0;
                    decimal MaxAmt = Convert.ToDecimal(((dr[&quot;TypeMaxPrepayAmount&quot;] == DBNull.Value)
                                         ? 0
                                         : dr[&quot;TypeMaxPrepayAmount&quot;].ToDecimal2()).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                              CultureInfo.CurrentCulture));
                    decimal PaidAmt = Convert.ToDecimal(dr[&quot;AmountPaid&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                              CultureInfo.CurrentCulture));
                    wneAdvAmnt.Value = dr[&quot;Amount&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                              CultureInfo.CurrentCulture);
                    wneTotalAmt.Value = ((dr[&quot;TypeMaxPrepayAmount&quot;] == DBNull.Value)
                                            ? 0
                                            : dr[&quot;TypeMaxPrepayAmount&quot;].ToDecimal2()).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                                                              CultureInfo.CurrentCulture);
                    availableAmt = MaxAmt - PaidAmt;
                    wneRemAmt.Value = availableAmt;

                    divCon.Style.Add(&quot;display&quot;, &quot;block&quot;);
                    fsCon.Style.Add(&quot;display&quot;, &quot;block&quot;);

                    divMat.Style.Add(&quot;display&quot;, &quot;none&quot;);
                    fsMat.Style.Add(&quot;display&quot;, &quot;none&quot;);

                    DataTable dt = new BrixDataTable(&quot;CONTMOHItems&quot;);
                    SetupColumns(dt);
                    ViewState[&quot;CONTMOHItems&quot;] = dt;
                    G1.DataSource = dt;
                    G1.DataBind();
                    FormatGridColumns();
                }
                else
                {
                    wneAmount.Value = dr[&quot;Amount&quot;];
                    //LoadMaterialsList();
                    LoadMasterGrid();

                    G1.DataSource = ds.Tables[1];
                    G1.DataBind();
                    FormatGridColumns();

                    if (ds.Tables[1].Select(&quot;RecoveredAmt &gt; 0&quot;).Length &gt; 0)
                    {
                        ///Recovery has already started on one the items.
                        ///So, attributes like Contractor Type, WO No, Pre-PaymentType should not be changed hence forth.

                        rbtnPC.Enabled =
                            rbtnSC.Enabled =
                            rbtnConMOH.Enabled =
                            rbtnMatMOH.Enabled =
                            ddlSubContractors.Enabled =
                            ddlWorkOrderList.Enabled = false;
                    }

                    ds.Tables[1].TableName = &quot;CONTMOHItems&quot;;
                    ViewState[&quot;CONTMOHItems&quot;] = ds.Tables[&quot;CONTMOHItems&quot;];
                    ViewState[&quot;MOHID&quot;] = MOHID;

                    divCon.Style.Add(&quot;display&quot;, &quot;none&quot;);
                    fsCon.Style.Add(&quot;display&quot;, &quot;none&quot;);

                    divMat.Style.Add(&quot;display&quot;, &quot;block&quot;);
                    fsMat.Style.Add(&quot;display&quot;, &quot;block&quot;);
                }

                dtMOHDate.Value = dr[&quot;MOHDate&quot;].ToMWDateTime();
                txtComments.Text = dr[&quot;Comments&quot;].ToString2();
                txtPrepayDesc.Text = dr[&quot;PrepayDesc&quot;].ToString2();
                //txtComments.Var(8000) = dr[&quot;Comments&quot;].ToString2();


                if (dr[&quot;Status&quot;].ToInt32_2() &gt; 1)
                {
                    rbtnMatMOH.Enabled =
                        rbtnConMOH.Enabled =
                        rbtnPC.Enabled =
                        rbtnSC.Enabled =
                        ddlWorkOrderList.Enabled =
                        ddlSubContractors.Enabled =
                        wneAdvAmnt.Enabled =
                        dtMOHDate.Enabled = false;
                    wneAmount.Enabled = false;
                    txtComments.Enabled = false;
                    txtPrepayDesc.Enabled = false;
                    txtMaterialDesc.Enabled = false;
                    btnSave.Enabled = false;
                    btnAddItem.Enabled = false;
                    btnDeleteItem.Enabled = false;
                    btnAddMaterial.Enabled = false;

                    ViewState[&quot;canBeSaved&quot;] = false;
                    dtMOHDate.ReadOnly = true;
                }
            }
            else
            {
                btnSave.Enabled = false;
                Page.ClientScript.RegisterStartupScript(GetType(), &quot;MOH_DELETED&quot;,
                                                        &quot;ShowError(&#39;The &lt;%=Aurigo.AMP3.Resources.TerminologyResources.ResourceFactory.Instance.GetString(&#39;MOH&#39;)%&gt; you are trying to Edit has been deleted by another user.&#39;);&quot;,
                                                        true);
            }
        }

        private void FormatGridColumns()
        {
            // to fix XSS attack
            foreach (UltraGridColumn col in G1.Columns)
            {
                col.HTMLEncodeContent = true;
            }

            G1.Columns.FromKey(&quot;StandardItemNo&quot;).Header.Caption = &quot;Standard Item No.&quot;;
            G1.Columns.FromKey(&quot;UnitPrice&quot;).Header.Caption = &quot;Unit Price&quot;;
            G1.Columns.FromKey(&quot;UnitPrice&quot;).Hidden = true;
            //G1.Columns.FromKey(&quot;UnitCost&quot;).Header.Caption = &quot;Unit Cost&quot;;
            G1.Columns.FromKey(&quot;IsComplete&quot;).Header.Caption = &quot;Is Complete&quot;;

            G1.Columns.FromKey(&quot;UCAmount&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;UCRecoveryQty&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;RowChanged&quot;).Hidden = true;

            //G1.Columns.FromKey(&quot;OrigRecQty&quot;).Hidden = true;
            //G1.Columns.FromKey(&quot;OrigAmt&quot;).Hidden = true;
            //G1.Columns.FromKey(&quot;OrigRecRate&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;Quantity&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;Unit&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;StandardItemNo&quot;).Hidden = true;

            G1.Columns.FromKey(&quot;RecoveryQty&quot;).Header.Caption = &quot;Recovery Quantity&quot;;
            G1.Columns.FromKey(&quot;RecoveryRange&quot;).Header.Caption = &quot;Recovery Range&quot;;
            G1.Columns.FromKey(&quot;RecoveryRate&quot;).Header.Caption = &quot;Recovery Rate&quot;;
            G1.Columns.FromKey(&quot;ItemID&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;RangeLow&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;RangeHigh&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;MaxAmt&quot;).Hidden = true;
            G1.Columns.FromKey(&quot;MaxAmt&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;

            G1.Columns.FromKey(&quot;Amount&quot;).AllowUpdate = AllowUpdate.Yes;
            G1.Columns.FromKey(&quot;Amount&quot;).FieldLen = 14;
            G1.Columns.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;

            G1.Columns.FromKey(&quot;Amount&quot;).Header.Caption = &quot;Amount&quot;;
            G1.Columns.FromKey(&quot;RecoveryQty&quot;).AllowUpdate = AllowUpdate.Yes;
            G1.Columns.FromKey(&quot;RecoveryQty&quot;).FieldLen = 14;
            G1.Columns.FromKey(&quot;RecoveryQty&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;

            G1.Columns.FromKey(&quot;RecoveryRate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            G1.Columns.FromKey(&quot;RecoveredQty&quot;).Header.Caption = &quot;Recovered Quantity&quot;;
            G1.Columns.FromKey(&quot;RecoveredAmt&quot;).Header.Caption = &quot;Recovered Amount&quot;;
            G1.Columns.FromKey(&quot;RecoveredAmt&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;

            G1.Columns.FromKey(&quot;Amount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            G1.Columns.FromKey(&quot;Amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            G1.Columns.FromKey(&quot;RecoveryRange&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            G1.Columns.FromKey(&quot;RecoveryRange&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            G1.Columns.FromKey(&quot;RecoveryQty&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            G1.Columns.FromKey(&quot;RecoveryQty&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            G1.Columns.FromKey(&quot;RecoveryRate&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            G1.Columns.FromKey(&quot;RecoveryRate&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            G1.Columns.FromKey(&quot;RecoveredQty&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            G1.Columns.FromKey(&quot;RecoveredQty&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            G1.Columns.FromKey(&quot;RecoveredAmt&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            G1.Columns.FromKey(&quot;RecoveredAmt&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            // setting the width of the columns
            G1.Columns.FromKey(&quot;Amount&quot;).Width = Unit.Pixel(160);
            G1.Columns.FromKey(&quot;RecoveredQty&quot;).Width = Unit.Pixel(110);
            G1.Columns.FromKey(&quot;RecoveredAmt&quot;).Width = Unit.Pixel(110);
            G1.Columns.FromKey(&quot;RecoveryRate&quot;).Width = Unit.Pixel(110);
            G1.Columns.FromKey(&quot;RecoveryQty&quot;).Width = Unit.Pixel(110);
            G1.Columns.FromKey(&quot;RecoveryRange&quot;).Width = Unit.Pixel(110);
            G1.Columns.FromKey(&quot;Description&quot;).Width = Unit.Pixel(170);
            G1.Columns.FromKey(&quot;Line No.&quot;).Width = Unit.Pixel(75);
            G1.Columns.FromKey(&quot;IsComplete&quot;).Width = Unit.Pixel(100);
        }

        protected void Cncl_Click(object sender, EventArgs e)
        {
            if (!string.IsNullOrEmpty(ViewState[&quot;WorkOrderNo&quot;].ToString2()))
            {
                Response.Redirect(
                    &quot;~/Common/BrixListPage.aspx?context=CONTMOH&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID={2}&quot;.Format2(
                        Request[&quot;PID&quot;], Request[&quot;ContractID&quot;], workOrderId), true);
            }
            else
            {
                Response.Redirect(
                    &quot;~/Common/BrixListPage.aspx?context=CONTMOH&amp;PID={0}&amp;ContractID={1}{2}&amp;ParentID={1}{2}&quot;.Format2(Request[&quot;PID&quot;],
                                                                                                   Request[&quot;ContractID&quot;],
                                                                                                   (workOrderId != 0
                                                                                                        ? &quot;&amp;WOID=&quot; +
                                                                                                          workOrderId
                                                                                                        : string.Empty)),
                    true);
            }
        }

        protected void Save_Click(object sender, EventArgs e)
        {
            WorkflowEnabledSaveHandler();
        }

        protected void ChangePrepaymentType(object sender, EventArgs e)
        {
            //if(rbtnMatMOH.Checked)
            //    LoadMaterialsList();
            RowsCollection rows = G1.Rows;
            string moh = GlobalizationUtility.SetResource(&quot;Pre-Payment&quot;, false);

            if (rbtnSC.Checked &amp;&amp; rbtnMatMOH.Checked &amp;&amp; ddlWorkOrderList.SelectedItem != null &amp;&amp;
                !ddlWorkOrderList.SelectedItem.Text.Equals(&quot;Select-One&quot;) &amp;&amp; (G1.Rows.Count &gt; 0))
            {
                //Work Order Chosen and the Pre Payment Type is Material. 
                DataTable dt = new BrixDataTable(&quot;CONTMOHItems&quot;);
                if (ViewState[&quot;CONTMOHItems&quot;] != null)
                    dt = ((DataTable)ViewState[&quot;CONTMOHItems&quot;]);
                else
                    SetupColumns(dt);

                dt.Columns[&quot;Quantity&quot;].DataType =
                    dt.Columns[&quot;RecoveredAmt&quot;].DataType =
                    dt.Columns[&quot;RecoveredQty&quot;].DataType =
                    dt.Columns[&quot;RecoveryRate&quot;].DataType =
                    dt.Columns[&quot;Amount&quot;].DataType = Type.GetType(&quot;System.Decimal&quot;);

                if (ViewState[&quot;DeletedItems&quot;] == null)
                    ViewState[&quot;DeletedItems&quot;] = new List&lt;MOHDeletedItem&gt;();
                var deletedItems = (List&lt;MOHDeletedItem&gt;)(ViewState[&quot;DeletedItems&quot;]);

                int workOrderID = ddlWorkOrderList.SelectedItem.Value.ToInt32_2();
                WorkOrderDTO WODTO = WORKORDManager.Instance.GetWorkOrderDetails(workOrderID);
                if (WODTO != null)
                {
                    DataTable woItems = WODTO.WorkOrderItems.Tables[0];

                    for (int i = 0; i &lt; rows.Count;)
                    {
                        CellsCollection cells = rows[i].Cells;
                        string itemID = cells.FromKey(&quot;ItemID&quot;).Value.ToString2();

                        if (woItems.Select(&quot;ItemID = &quot; + itemID).Length == 0)
                        {
                            if (rows[i].Cells.FromKey(&quot;RecoveredAmt&quot;).Value.ToDecimal2() &gt; 0)
                                throw new Exception(moh + &quot; Recovery has been initatied for one or more &quot; + stditem +
                                                    &quot;s.Request Denied&quot;);
                            else
                            {
                                var delItem = new MOHDeletedItem();
                                delItem.ItemID = itemID.ToInt32_2();
                                deletedItems.Add(delItem);
                                DataRow dr = ((dt.Select(&quot;ItemID=&#39;&quot; + itemID + &quot;&#39;&quot;).Length == 0)
                                                  ? null
                                                  : dt.Select(&quot;ItemID=&#39;&quot; + itemID + &quot;&#39;&quot;)[0]);
                                if (dr != null)
                                    dt.Rows.Remove(dr);

                                rows[i].Delete();
                            }
                        }
                        else
                        {
                            //TODO need to re-fresh the amount and other values.
                            DataTable dtWO = MOHManager.Instance.GetWOAvailableQuantity(WODTO.WorkOrderID.Value,
                                                                                        itemID.ToInt32_2());
                            if (dtWO.Rows.Count &gt; 0)
                            {
                                DataRow dr = dtWO.Rows[0];
                                Decimal qty = dr[&quot;AvailableQuantity&quot;].ToString2().ToDecimal2();
                                Decimal up = dr[&quot;UnitPrice&quot;].ToString2().ToDecimal2();

                                cells.FromKey(&quot;Amount&quot;).Value = qty * up;
                                cells.FromKey(&quot;RecoveryQty&quot;).Value = qty.ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                  CultureInfo.CurrentCulture);
                                cells.FromKey(&quot;RecoveryRange&quot;).Value = &quot;[{0:0.0000} - {1:0.0000}]&quot;.Format2(qty, qty);
                                cells.FromKey(&quot;RecoveryRate&quot;).Value = up.ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                                  CultureInfo.CurrentCulture);
                                cells.FromKey(&quot;RangeLow&quot;).Value =
                                    cells.FromKey(&quot;RangeHigh&quot;).Value = qty;
                                cells.FromKey(&quot;MaxAmt&quot;).Value = qty * up;
                            }

                            i++;
                        }
                    }
                }
            }
            else
            {
                if (rbtnMatMOH.Checked &amp;&amp; ViewState[&quot;WorkOrderData&quot;] != null &amp;&amp;
                    !ddlWorkOrderList.SelectedItem.Text.Equals(&quot;Select-One&quot;) &amp;&amp;
                    ((DataTable)ViewState[&quot;WorkOrderData&quot;]).Select(&quot;workordertype=&#39;A&#39; AND workorderid=&quot; +
                                                                    Convert.ToInt32(ddlWorkOrderList.SelectedValue) + &quot;&quot;)
                        .Length &gt; 0)
                {
                    ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                                       &quot;ShowError(&#39;Activity Based WO cannot be used for the Material level advance&#39;);&quot;,
                                                       true);
                }


                for (int i = 0; i &lt; rows.Count; i++)
                {
                    CellsCollection cells = rows[i].Cells;
                    string itemID = cells.FromKey(&quot;ItemID&quot;).Value.ToString2();


                    DataTable dtItems =
                        ItemManager.Instance.GetItemPickerData(&quot;CONTMGT&quot;, _contractID, null, null).Tables[1];
                    //Aurigo.AMP3.Core.BusinessLayer.DTO.Item item = GetItemDEtails(&quot;CONTMGT&quot;,_contractID,BrixDatatypeHelper.ToInt32_2(itemID));

                    DataRow dr = null;
                    if (dtItems.Select(&quot;ItemID = &quot; + itemID).Length &gt; 0 &amp;&amp;
                        ((dr = dtItems.Select(&quot;ItemID = &quot; + itemID)[0]) != null))
                    {
                        decimal qty = dr[&quot;Quantity&quot;].ToString2().ToDecimal2();
                        decimal up = dr[&quot;UnitPrice&quot;].ToString2().ToDecimal2();

                        cells.FromKey(&quot;Amount&quot;).Value = qty * up;
                        cells.FromKey(&quot;RecoveryQty&quot;).Value = qty.ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                          CultureInfo.CurrentCulture);
                        cells.FromKey(&quot;RecoveryRange&quot;).Value = &quot;[{0:0.0000} - {1:0.0000}]&quot;.Format2(qty, qty);
                        cells.FromKey(&quot;RecoveryRate&quot;).Value = up.ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY,
                                                                          CultureInfo.CurrentCulture);
                        cells.FromKey(&quot;RangeLow&quot;).Value =
                            cells.FromKey(&quot;RangeHigh&quot;).Value = qty;
                        cells.FromKey(&quot;MaxAmt&quot;).Value = qty * up;
                    }
                }
            }
        }

        private void LoadMasterGrid()
        {
            string desc = txtMaterialDesc.Text;

            DataTable dtItems = null;

            if (rbtnPC.Checked)
            {
                dtItems = MOHManager.Instance.GetItemsForMaterialInContract(_contractID, desc);
            }
            else
            {
                int workOrderID = ddlWorkOrderList.SelectedItem.Value.ToInt32_2();
                dtItems = MOHManager.Instance.GetItemsForWorkOrderMaterial(workOrderID, desc);
            }


            masterGrid.DataSource = dtItems;
            masterGrid.DataBind();

            // to fix XSS attack
            foreach (UltraGridColumn col in masterGrid.Columns)
            {
                col.HTMLEncodeContent = true;
            }

            ColumnsCollection cols = masterGrid.Columns;

            cols.FromKey(&quot;ItemID&quot;).Hidden =
                cols.FromKey(&quot;IsComplete&quot;).Hidden =
                cols.FromKey(&quot;IsNonContract&quot;).Hidden =
                //cols.FromKey(&quot;AvailableQuantity&quot;).Hidden =
                cols.FromKey(&quot;ProRated&quot;).Hidden = true;

            cols.FromKey(&quot;StandardItemNo&quot;).Header.Caption = &quot;Standard Item No.&quot;;
            cols.FromKey(&quot;UnitPrice&quot;).Header.Caption = &quot;Unit Price&quot;;
            cols.FromKey(&quot;UnitPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            cols.FromKey(&quot;UnitPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            cols.FromKey(&quot;UnitCost&quot;).Header.Caption = &quot;Unit Cost&quot;;
            cols.FromKey(&quot;UnitCost&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            cols.FromKey(&quot;UnitCost&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
            cols.FromKey(&quot;Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            cols.FromKey(&quot;Quantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            cols.FromKey(&quot;AvailableQuantity&quot;).Header.Caption = &quot;Available Quantity&quot;;
            cols.FromKey(&quot;AvailableQuantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            cols.FromKey(&quot;AvailableQuantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

            cols.FromKey(&quot;AccountingCode&quot;).Header.Caption = &quot;Accounting Code&quot;;

            masterGrid.DisplayLayout.Pager.AllowPaging = false;
            masterGrid.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
            masterGrid.DisplayLayout.FrameStyle.Height = Unit.Pixel(400);
        }


        protected void btnMaterialGhost_OnClick(object sender, EventArgs e)
        {
        }

        protected void btnDeleteItemGhost_Click(object sender, EventArgs e)
        {
            if (ViewState[&quot;CONTMOHItems&quot;] != null)
            {
                var dt = (DataTable)ViewState[&quot;CONTMOHItems&quot;];
                if (ViewState[&quot;DeletedItems&quot;] == null)
                    ViewState[&quot;DeletedItems&quot;] = new List&lt;MOHDeletedItem&gt;();
                var deletedItems = (List&lt;MOHDeletedItem&gt;)(ViewState[&quot;DeletedItems&quot;]);
                for (int rowIdx = 0; rowIdx &lt; G1.DisplayLayout.Rows.Count; rowIdx++)
                {
                    UltraGridRow row = G1.DisplayLayout.Rows[rowIdx];
                    CellsCollection cells = row.Cells;
                    DataRow dr = dt.Select(&quot;ItemID=&#39;&quot; + cells.FromKey(&quot;ItemID&quot;).Value + &quot;&#39;&quot;)[0];
                    if (cells.FromKey(&quot;To&quot;).Value.ToBoolean2())
                    {
                        if (cells.FromKey(&quot;RecoveredAmt&quot;).Value.ToDecimal2() &gt; 0)
                            throw new Exception(&quot;Pre-Payment Recovery has been initatied for one or more &quot; + stditem +
                                                &quot;s.\n Request Denied&quot;);

                        var delItem = new MOHDeletedItem();
                        delItem.ItemID = dr[&quot;ItemID&quot;].ToString2().ToInt32_2();
                        deletedItems.Add(delItem);
                        dt.Rows.Remove(dr);
                    }
                    else
                    {
                        dr[&quot;Amount&quot;] = cells.FromKey(&quot;Amount&quot;).Value;
                        dr[&quot;RecoveryQty&quot;] = cells.FromKey(&quot;RecoveryQty&quot;).Value;
                        dr[&quot;RecoveryRange&quot;] = cells.FromKey(&quot;RecoveryRange&quot;).Value;
                        dr[&quot;RecoveryRate&quot;] = cells.FromKey(&quot;RecoveryRate&quot;).Value;
                        dr[&quot;RangeLow&quot;] = cells.FromKey(&quot;RangeLow&quot;).Value;
                        dr[&quot;RangeHigh&quot;] = cells.FromKey(&quot;RangeHigh&quot;).Value;
                    }
                }

                G1.DataSource = dt;
                G1.DataBind();
                FormatGridColumns();
                ViewState[&quot;CONTMOHItems&quot;] = dt;
                ViewState[&quot;DeletedItems&quot;] = deletedItems;
            }
        }

        protected void btnStdItemGhost_Click(object sender, EventArgs e)
        {
            DataTable dt = new BrixDataTable(&quot;CONTMOHItems&quot;);
            if (ViewState[&quot;CONTMOHItems&quot;] != null)
                dt = ((DataTable)ViewState[&quot;CONTMOHItems&quot;]);
            else
                SetupColumns(dt);

            dt.Columns[&quot;Quantity&quot;].DataType =
                dt.Columns[&quot;RecoveredAmt&quot;].DataType =
                dt.Columns[&quot;RecoveredQty&quot;].DataType =
                dt.Columns[&quot;RecoveryRate&quot;].DataType =
                dt.Columns[&quot;Amount&quot;].DataType = Type.GetType(&quot;System.Decimal&quot;);


            bool IsDelItems = false;
            List&lt;MOHDeletedItem&gt; deletedItems = null;
            if (ViewState[&quot;DeletedItems&quot;] != null)
            {
                IsDelItems = true;
                deletedItems = (List&lt;MOHDeletedItem&gt;)(ViewState[&quot;DeletedItems&quot;]);
            }

            string itemList = string.Empty;
            foreach (UltraGridRow row in masterGrid.DisplayLayout.Rows)
                if (row.Cells.FromKey(&quot;To&quot;).Value.ToBoolean2())
                    itemList += row.Cells.FromKey(&quot;ItemID&quot;).Value + &quot;,&quot;;

            if (String.IsNullOrEmpty(itemList))
                throw new Exception(&quot;Please select an &quot; + item + &quot;.&quot;);

            if (itemList.EndsWith(&quot;,&quot;, StringComparison.OrdinalIgnoreCase))
                itemList = itemList.Substring(0, itemList.Length - 1);

            foreach (UltraGridRow row in masterGrid.DisplayLayout.Rows)
            {
                CellsCollection cells = row.Cells;

                if (cells.FromKey(&quot;To&quot;).Value.ToBoolean2())
                {
                    if (dt.Rows.Count == 0 || dt.Select(&quot;ItemID=&#39;&quot; + cells.FromKey(&quot;ItemID&quot;).Value + &quot;&#39;&quot;).Length == 0)
                    {
                        decimal qty = 0;
                        decimal up = 0;

                        qty = cells.FromKey(&quot;AvailableQuantity&quot;).Value.ToDecimal2(); //RemainingQty
                        up = cells.FromKey(&quot;UnitPrice&quot;).Value.ToDecimal2();


                        if (up &lt;= 0)
                            continue;

                        decimal amt = qty * up;

                        dt.Rows.Add(
                            new[]
                                {
                                    &quot;{0:0}&quot;.Format2(cells.FromKey(&quot;LineNo&quot;).Value), //Line No.
                                    cells.FromKey(&quot;ItemID&quot;).Value, //ItemID
                                    cells.FromKey(&quot;StandardItemNo&quot;).Value, //StdItemID
                                    cells.FromKey(&quot;Description&quot;).Value, //Description
                                    qty, //Quantity
                                    cells.FromKey(&quot;Unit&quot;).Value, //Unit
                                    up, //UnitPrice
                                    amt.ToString2(), //Amount
                                    qty.ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, CultureInfo.CurrentCulture), //RecoveryQty
                                    &quot;[{0:0.0000} - {1:0.0000}]&quot;.Format2(qty, qty),
                                    //Math.Min(up, qty), Math.Max(up, qty)      //RecoveryRange
                                    up.ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, CultureInfo.CurrentCulture), //RecoveryRate
                                    qty, //Math.Min(up, qty)                                        //RangeLow
                                    qty, //Math.Max(up, qty)                                        //RangeHigh
                                    amt, //MaxAmt
                                    0.0000.ToString(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, CultureInfo.CurrentCulture),
                                    //Recovered Qty
                                    0.00.ToString2(), //Recovered amount
                                    0,
                                    0,
                                    0,
                                    (cells.FromKey(&quot;IsComplete&quot;).Value.ToString2().ToLower2().Equals(&quot;true&quot;) ? 1 : 0)
                                });

                        //if (IsDelItems)
                        //{
                        //    MOHDeletedItem delItem = new MOHDeletedItem();
                        //    delItem.ItemID = BrixDatatypeHelper.ToInt32_2(cells.FromKey(&quot;ItemID&quot;).Value);
                        //    delItem.GroupID = BrixDatatypeHelper.ToInt32_2(itemGroup[&quot;GroupID&quot;]);
                        //    if (deletedItems.Contains(delItem))
                        //        deletedItems.Remove(delItem);
                        //}
                    }
                }
                cells.FromKey(&quot;To&quot;).Value = false;
            }

            bool fndChange = false;
            foreach (UltraGridRow grdRow in G1.Rows)
            {
                DataRow dr = dt.Select(&quot;ItemID=&#39;&quot; + grdRow.Cells.FromKey(&quot;ItemID&quot;).Value + &quot;&#39; &quot;)[0];

                if (dr[&quot;Amount&quot;].ToDecimal2() != grdRow.Cells.FromKey(&quot;Amount&quot;).Value.ToDecimal2()
                    || dr[&quot;RecoveryQty&quot;].ToDecimal2() != grdRow.Cells.FromKey(&quot;RecoveryQty&quot;).Value.ToDecimal2())
                {
                    fndChange = true;
                    dr[&quot;Amount&quot;] = grdRow.Cells.FromKey(&quot;Amount&quot;).Value;
                    dr[&quot;RecoveryQty&quot;] = grdRow.Cells.FromKey(&quot;RecoveryQty&quot;).Value;
                    dr[&quot;RecoveryRange&quot;] = grdRow.Cells.FromKey(&quot;RecoveryRange&quot;).Value;
                    dr[&quot;RecoveryRate&quot;] = grdRow.Cells.FromKey(&quot;RecoveryRate&quot;).Value;
                    dr[&quot;RangeLow&quot;] = grdRow.Cells.FromKey(&quot;RangeLow&quot;).Value;
                    dr[&quot;RangeHigh&quot;] = grdRow.Cells.FromKey(&quot;RangeHigh&quot;).Value;
                }
                if (fndChange)
                    dt.AcceptChanges();
            }

            G1.DataSource = dt;
            G1.DataBind();
            FormatGridColumns();

            ViewState[&quot;CONTMOHItems&quot;] = dt;

            if (IsDelItems)
                ViewState[&quot;DeletedItems&quot;] = deletedItems;
        }

        private void SetupColumns(DataTable dt)
        {
            if (!dt.Columns.Contains(&quot;Line No.&quot;))
                dt.Columns.Add(&quot;Line No.&quot;);
            if (!dt.Columns.Contains(&quot;ItemID&quot;))
                dt.Columns.Add(&quot;ItemID&quot;);
            if (!dt.Columns.Contains(&quot;StandardItemNo&quot;))
                dt.Columns.Add(&quot;StandardItemNo&quot;);
            if (!dt.Columns.Contains(&quot;Description&quot;))
                dt.Columns.Add(&quot;Description&quot;);

            if (!dt.Columns.Contains(&quot;Quantity&quot;))
                dt.Columns.Add(&quot;Quantity&quot;);
            if (!dt.Columns.Contains(&quot;Unit&quot;))
                dt.Columns.Add(&quot;Unit&quot;);
            if (!dt.Columns.Contains(&quot;UnitPrice&quot;))
                dt.Columns.Add(&quot;UnitPrice&quot;);
            if (!dt.Columns.Contains(&quot;Amount&quot;))
                dt.Columns.Add(&quot;Amount&quot;);
            if (!dt.Columns.Contains(&quot;Amount&quot;))
                dt.Columns.Add(&quot;Amount&quot;);
            if (!dt.Columns.Contains(&quot;RecoveryQty&quot;))
                dt.Columns.Add(&quot;RecoveryQty&quot;);
            if (!dt.Columns.Contains(&quot;RecoveryRange&quot;))
                dt.Columns.Add(&quot;RecoveryRange&quot;);
            if (!dt.Columns.Contains(&quot;RecoveryRate&quot;))
                dt.Columns.Add(&quot;RecoveryRate&quot;);
            if (!dt.Columns.Contains(&quot;RangeLow&quot;))
                dt.Columns.Add(&quot;RangeLow&quot;);
            if (!dt.Columns.Contains(&quot;RangeHigh&quot;))
                dt.Columns.Add(&quot;RangeHigh&quot;);

            if (!dt.Columns.Contains(&quot;MaxAmt&quot;))
                dt.Columns.Add(&quot;MaxAmt&quot;);
            if (!dt.Columns.Contains(&quot;RecoveredQty&quot;))
                dt.Columns.Add(&quot;RecoveredQty&quot;);
            if (!dt.Columns.Contains(&quot;RecoveredAmt&quot;))
                dt.Columns.Add(&quot;RecoveredAmt&quot;);
            if (!dt.Columns.Contains(&quot;UCAmount&quot;))
                dt.Columns.Add(&quot;UCAmount&quot;);
            if (!dt.Columns.Contains(&quot;UCRecoveryQty&quot;))
                dt.Columns.Add(&quot;UCRecoveryQty&quot;);
            if (!dt.Columns.Contains(&quot;RowChanged&quot;))
                dt.Columns.Add(&quot;RowChanged&quot;);
            if (!dt.Columns.Contains(&quot;IsComplete&quot;))
                dt.Columns.Add(&quot;IsComplete&quot;);
        }


        protected void G1_InitializeRow(object sender, RowEventArgs e)
        {
            if (e.Row.HasCells &amp;&amp; e.Row.Cells.FromKey(&quot;IsComplete&quot;).Value.ToString2() == &quot;0&quot;)
            {
                e.Row.Cells.FromKey(&quot;Amount&quot;).Style.BackColor = Color.Yellow;
                e.Row.Cells.FromKey(&quot;RecoveryQty&quot;).Style.BackColor = Color.Yellow;
            }

            if (e.Row.Cells.FromKey(&quot;IsComplete&quot;).Value.ToString2() == &quot;1&quot; ||
                e.Row.Cells.FromKey(&quot;IsComplete&quot;).Value.ToString2() == &quot;Yes&quot;)
            {
                e.Row.Cells.FromKey(&quot;RecoveryQty&quot;).AllowEditing = AllowEditing.No;
                e.Row.Cells.FromKey(&quot;RecoveryQty&quot;).Title = item + &quot; is marked complete. Cannot edit the quantity.&quot;;

                e.Row.Cells.FromKey(&quot;Amount&quot;).AllowEditing = AllowEditing.No;
                e.Row.Cells.FromKey(&quot;Amount&quot;).Title = item + &quot; is marked complete. Cannot edit the amount.&quot;;
            }

            e.Row.Cells.FromKey(&quot;IsComplete&quot;).Value = (e.Row.Cells.FromKey(&quot;IsComplete&quot;).Value.ToString2() == &quot;1&quot; ||
                                                       e.Row.Cells.FromKey(&quot;IsComplete&quot;).Value.ToString2() == &quot;Yes&quot;)
                                                          ? &quot;Yes&quot;
                                                          : &quot;No&quot;;
        }

        protected void masterGrid_InitializeRow(object sender, RowEventArgs e)
        {
            UltraGridCell cell = e.Row.Cells.FromKey(&quot;CompleteText&quot;);

            if (Convert.ToString(e.Row.Cells.FromKey(&quot;IsComplete&quot;).Value, CultureInfo.CurrentCulture) == &quot;Y&quot;)
                cell.Text = &quot;Yes&quot;;
            else
                cell.Text = &quot;No&quot;;

            cell = e.Row.Cells.FromKey(&quot;NCText&quot;);

            if (Convert.ToString(e.Row.Cells.FromKey(&quot;IsNonContract&quot;).Value, CultureInfo.CurrentCulture) == &quot;Y&quot;)
                cell.Text = &quot;Yes&quot;;
            else
                cell.Text = &quot;No&quot;;

            cell = e.Row.Cells.FromKey(&quot;LSText&quot;);


            if (Convert.ToString(e.Row.Cells.FromKey(&quot;ProRated&quot;).Value, CultureInfo.CurrentCulture) == &quot;N&quot;)
                cell.Text = &quot;Yes&quot;;
            else
                cell.Text = &quot;No&quot;;
        }

        public void btnFilterGhost_Click(object sender, EventArgs e)
        {
            ApplyFilter();
        }

        protected void masterGrid_SortColumn(object sender, SortColumnEventArgs e)
        {
            //ApplySort(e.ColumnNo);
            //pageState.MaintainState(BrixDatatypeHelper.ToInt32_2(Request[&quot;ContractID&quot;]),
            //                        BrixDatatypeHelper.ToInt32_2((mypager.FindControl(&quot;currentPage&quot;) as HtmlInputHidden).Value),
            //                        e.ColumnNo,
            //                        ViewState[Constants.ODS_SORTORDER] == null
            //                            ? null
            //                            : ViewState[Constants.ODS_SORTORDER].ToString2(),
            //                        ViewState[Constants.ODS_FILTER] == null
            //                            ? null
            //                            : ViewState[Constants.ODS_FILTER].ToString2());
        }

        protected void ddlPrePaymentClassification_SelectedIndexChanged(object sender, EventArgs e)
        {

            if (ddlPrePaymentClassification.SelectedIndex &gt; 0)
            {
                decimal availableAmt = 0;
                int mohID = (Request[&quot;MOHID&quot;] != null) ? Convert.ToInt32(Request[&quot;MOHID&quot;]) : 0;
                DataRow drAvailableAmt =
                    MOHManager.Instance.GetWOAvailableAmt(Request[&quot;ContractID&quot;].ToInt32_2(),
                                                          (!string.IsNullOrEmpty(Request[&quot;WOID&quot;]) ? workOrderId : 0),
                                                          ddlPrePaymentClassification.SelectedItem.Value.ToInt32_2(),
                                                          mohID).Tables[0].Rows[0];
                decimal usedPrePaymentForPPTypeID =
                    Convert.ToDecimal(drAvailableAmt[&quot;UsedPrepaymentValueForPPTypeID&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture));
                decimal maxPrepaymentForPPTypeID = Convert.ToDecimal(drAvailableAmt[&quot;MAXPrepaymentValue&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture));
                availableAmt = maxPrepaymentForPPTypeID - usedPrePaymentForPPTypeID;
                wneRemAmt.Text = availableAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                wneRemAmt.ReadOnly = true;
                wneTotalAmt.Text = maxPrepaymentForPPTypeID.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                wneTotalAmt.ReadOnly = true;
            }
        }

        protected override void SetModes()
        {
            _IsEdit = !string.IsNullOrEmpty(Request.QueryString[&quot;Type&quot;]) &amp;&amp; Request.QueryString[&quot;Type&quot;].ToLower() == &quot;e&quot;;
            _IsView = !string.IsNullOrEmpty(Request.QueryString[&quot;Type&quot;]) &amp;&amp; Request.QueryString[&quot;Type&quot;].ToLower() == &quot;v&quot;;
            _IsNew = !string.IsNullOrEmpty(Request.QueryString[&quot;Type&quot;])
                         ? Request.QueryString[&quot;Type&quot;].ToLower() == &quot;n&quot;
                         : !IsEdit &amp;&amp; !IsView;
            _IsList = !string.IsNullOrEmpty(Request.QueryString[&quot;Type&quot;]) &amp;&amp;
                      Request.QueryString[&quot;Type&quot;].ToLower() == &quot;list&quot;;
        }

        private void ApplyFormattoWne(WebNumericEdit wne, String format)
        {
            int DecimalLength = format.Length -
                                (format.LastIndexOf(&#39;.&#39;) == -1 ? format.Length - 1 : format.LastIndexOf(&#39;.&#39;)) - 1;
            wne.NumberFormat.NumberDecimalDigits = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
            wne.MinDecimalPlaces = (MinDecimalPlaces)(Enum.ToObject(typeof(MinDecimalPlaces), CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT)));
        }

        public override int GetProjectIdFromInstanceId()
        {
            if (!string.IsNullOrEmpty(Request[&quot;MOHID&quot;]) &amp;&amp; Request[&quot;MOHID&quot;] != &quot;0&quot;)
                return MOHManager.Instance.GetPIDFromMOHID(Request[&quot;MOHID&quot;].ToInt32_2());
            else
                return base.GetProjectIdFromInstanceId();
        }

        #region &quot;Custom Functions&quot;

        private void GetPageCount()
        {
            //double rCnt;

            //rCnt = BL.Instance.GetContractItemsCount(BrixDatatypeHelper.ToInt32_2(Request[&quot;ContractID&quot;]),
            //                                           ViewState[Constants.ODS_FILTER] == null
            //                                               ? null
            //                                               : ViewState[Constants.ODS_FILTER].ToString2());

            //if (pageState.PageIndex != 0 &amp;&amp;
            //    Math.Ceiling(rCnt / masterGrid.DisplayLayout.Pager.PageSize) &gt;= pageState.PageIndex)
            //{
            //    (mypager.FindControl(&quot;currentPage&quot;) as HtmlInputHidden).Value =
            //        pageState.PageIndex &gt; 0 ? pageState.PageIndex.ToString2() : &quot;0&quot;;
            //}
            //else
            //{
            //    (mypager.FindControl(&quot;currentPage&quot;) as HtmlInputHidden).Value = rCnt &gt; 0 ? &quot;1&quot; : &quot;0&quot;;
            //}

            //(mypager.FindControl(&quot;pageCount&quot;) as HtmlInputHidden).Value =
            //    rCnt &gt; masterGrid.DisplayLayout.Pager.PageSize
            //        ?
            //    Convert.ToString(Math.Ceiling(rCnt / masterGrid.DisplayLayout.Pager.PageSize))
            //        : rCnt &gt; 0 ? &quot;1&quot; : &quot;0&quot;;

            //pageState.MaintainState(BrixDatatypeHelper.ToInt32_2(Request[&quot;ContractID&quot;]),
            //                        BrixDatatypeHelper.ToInt32_2((mypager.FindControl(&quot;currentPage&quot;) as HtmlInputHidden).Value),
            //                        pageState.SortColIdx,
            //                        ViewState[Constants.ODS_SORTORDER] == null
            //                            ? null
            //                            : ViewState[Constants.ODS_SORTORDER].ToString2(),
            //                        ViewState[Constants.ODS_FILTER] == null
            //                            ? null
            //                            : ViewState[Constants.ODS_FILTER].ToString2());
        }

        public void BindData()
        {
            //int startIdx = (startIdx = BrixDatatypeHelper.ToInt32_2((mypager.FindControl(&quot;currentPage&quot;) as HtmlInputHidden).Value) - 1) ==
            //               -1
            //                   ? 0
            //                   : startIdx;

            //startIdx = 1 + (masterGrid.DisplayLayout.Pager.PageSize * startIdx);

            //DataTable dTable = BL.Instance.GetContractItems(BrixDatatypeHelper.ToInt32_2(Request[&quot;ContractID&quot;]),
            //                                                  startIdx, masterGrid.DisplayLayout.Pager.PageSize,
            //                                                  ViewState[Constants.ODS_SORTORDER] == null
            //                                                      ? null
            //                                                      : ViewState[Constants.ODS_SORTORDER].ToString2(),
            //                                                  ViewState[Constants.ODS_FILTER] == null
            //                                                      ? null
            //                                                      : ViewState[Constants.ODS_FILTER].ToString2(), null);


            //masterGrid.DataSource = dTable;
            //masterGrid.DataBind();
            //SetGridColumns();
        }

        private void SetGridColumns()
        {
            ColumnsCollection cols;
            UltraGridColumn c;

            (cols = masterGrid.Bands[0].Columns).FromKey(&quot;StdItemID&quot;).Header.Caption = &quot;Pay Item No&quot;;

            cols.FromKey(&quot;Lumpsum&quot;).Hidden = true;
            cols.FromKey(&quot;IsComplete&quot;).Hidden = true;
            cols.FromKey(&quot;IsDeleted&quot;).Hidden = true;
            cols.FromKey(&quot;IsNC&quot;).Hidden = true;
            cols.FromKey(&quot;AccountingCode&quot;).Hidden = true;
            cols.FromKey(&quot;ItemID&quot;).Hidden = true;
            cols.FromKey(&quot;SumAmount&quot;).Hidden = true;
            cols.FromKey(&quot;OrigSumAmount&quot;).Hidden = true;
            cols.FromKey(&quot;RowNum&quot;).Hidden = true;
            cols.FromKey(&quot;ContractID&quot;).Hidden = true;
            cols.FromKey(&quot;Section&quot;).Hidden = true;
            cols.FromKey(&quot;QRemaining&quot;).Hidden = true;
            cols.FromKey(&quot;LSText&quot;).Hidden = true;
            cols.FromKey(&quot;NCText&quot;).Hidden = true;
            cols.FromKey(&quot;ByDimension&quot;).Hidden = true;
            if (cols.Exists(&quot;DimensionID&quot;))
            {
                cols.FromKey(&quot;DimensionID&quot;).Hidden = true;
            }
            cols.FromKey(&quot;Amount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            cols.FromKey(&quot;UnitPrice&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            cols.FromKey(&quot;Cost&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            cols.FromKey(&quot;Quantity&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
            cols.FromKey(&quot;PRemaining&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;

            cols.FromKey(&quot;CompleteText&quot;).Move(masterGrid.Bands[0].Columns.Count - 1);

            cols.FromKey(&quot;IsLocked&quot;).Hidden = true;
            cols.FromKey(&quot;IsInCo&quot;).Hidden = true;

            (c = cols.FromKey(&quot;Quantity&quot;)).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            c.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            (c = cols.FromKey(&quot;UnitPrice&quot;)).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            c.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            c.Header.Caption = &quot;Unit Price&quot;;

            (c = cols.FromKey(&quot;Cost&quot;)).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            c.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            c.Header.Caption = &quot;Unit Cost&quot;;

            (c = cols.FromKey(&quot;Amount&quot;)).FooterTotal = SummaryInfo.Sum;
            c.Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;

            c.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            (c = cols.FromKey(&quot;PRemaining&quot;)).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            c.CellStyle.HorizontalAlign = HorizontalAlign.Right;
            c.Header.Caption = &quot;% Remaining&quot;;

            masterGrid.DisplayLayout.ScrollBar = ScrollBar.Auto;
            masterGrid.DisplayLayout.FrameStyle.Height = Unit.Percentage(100);
            masterGrid.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
        }

        protected void ApplyFilter()
        {
            ViewState[Constants.ODS_FILTER] = UIHelper.GenerateFilterXML(aspPnlFilter);
            GetPageCount();
            BindData();
            pageState.setPagerProperties(mypager);
        }

        protected void ApplySort(string sortKey)
        {
            //string sortKey = masterGrid.Columns[colNo].Key;

            //foreach (UltraGridColumn uwgcol in masterGrid.DisplayLayout.Bands[0].Columns)
            //{
            //    if (uwgcol.SortIndicator != SortIndicator.None)
            //        uwgcol.SortIndicator = SortIndicator.None;
            //}
            //if (ViewState[Constants.ODS_SORTORDER] != null
            //    &amp;&amp; ViewState[Constants.ODS_SORTORDER].ToString2().EndsWith(&quot;ASC&quot;)
            //    &amp;&amp;
            //    ViewState[Constants.ODS_SORTORDER].ToString2().StartsWith(sortKey,
            //                                                             StringComparison.InvariantCultureIgnoreCase))
            //{
            //    ViewState[Constants.ODS_SORTORDER] = sortKey + &quot; DESC&quot;;
            //    masterGrid.Bands[0].Columns[colNo].SortIndicator = SortIndicator.Descending;
            //}
            //else
            //{
            //    ViewState[Constants.ODS_SORTORDER] = sortKey + &quot; ASC&quot;;
            //    masterGrid.Bands[0].Columns[colNo].SortIndicator = SortIndicator.Ascending;
            //}
            //BindData();
        }

        #endregion

        #region Material Picker Event handlers

        protected void btnAddMaterial_Click(object sender, EventArgs e)
        {
            bool result = LoadMaterialsList(true);
            if (result)
                ShowHideDiv(DivTypes.MaterialPickerDiv);
            else
                ShowHideDiv(DivTypes.MOHDiv);
        }

        protected void MaterialPicker_BackClicked(object sender, EventArgs e)
        {
            ShowHideDiv(DivTypes.MOHDiv);
        }

        protected void MaterialPicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            ShowHideDiv(DivTypes.MOHDiv);
            if (e.SelectedItems != null &amp;&amp; e.SelectedItems.Rows.Count &gt; 0)
            {
                txtMaterialDesc.Text = e.SelectedItems.Rows[0][&quot;Description&quot;].ToString2();
                txtMaterialID.Value = e.SelectedItems.Rows[0][&quot;ResourceDetailID&quot;].ToString2();
            }
            divCon.Style.Add(&quot;display&quot;, &quot;none&quot;);
            fsCon.Style.Add(&quot;display&quot;, &quot;none&quot;);

            divMat.Style.Add(&quot;display&quot;, &quot;block&quot;);
            fsMat.Style.Add(&quot;display&quot;, &quot;block&quot;);
            LoadMasterGrid();
        }

        #endregion
    }

    public enum DivTypes
    {
        MOHDiv,
        MaterialPickerDiv,
        ItemPickerDiv
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[36,15,36,29,1],[37,9,37,10,1],[38,9,38,10,1],[40,33,40,37,1],[40,38,40,42,0],[43,9,43,10,0],[44,13,44,37,0],[45,13,45,33,0],[46,13,46,31,0],[47,13,47,54,0],[48,13,48,47,0],[49,13,49,82,0],[50,9,50,10,0],[57,9,57,93,1],[58,9,58,91,1],[79,17,79,18,0],[79,19,79,95,0],[79,96,79,97,0],[87,17,87,18,0],[87,19,87,77,0],[87,78,87,79,0],[92,17,92,18,1],[92,19,92,121,1],[92,122,92,123,1],[99,9,99,10,1],[100,13,100,38,1],[101,13,101,26,1],[102,13,102,30,1],[103,13,103,39,1],[106,13,106,14,1],[107,17,108,102,1],[109,21,109,118,0],[111,17,111,98,1],[112,17,112,110,1],[114,17,114,45,1],[115,21,116,56,0],[118,17,118,41,1],[119,17,119,46,1],[122,17,122,68,1],[123,17,123,18,1],[124,21,124,72,1],[125,25,125,80,1],[126,21,126,46,1],[127,21,127,100,1],[129,21,133,88,1],[134,21,134,113,1],[135,21,135,122,1],[136,21,137,98,1],[138,21,138,115,1],[139,21,139,108,1],[140,21,140,112,1],[142,21,142,56,1],[143,21,143,22,0],[148,25,148,88,0],[149,21,149,22,0],[151,21,151,22,1],[152,25,152,101,1],[153,25,153,26,0],[154,29,154,49,0],[155,25,155,26,0],[157,25,157,26,1],[158,29,159,94,1],[161,29,162,79,1],[164,29,164,90,1],[165,33,165,101,1],[167,29,167,114,1],[168,29,168,82,1],[169,25,169,26,1],[170,21,170,22,1],[171,21,171,47,1],[172,21,172,22,0],[173,25,173,356,0],[174,25,174,26,0],[175,29,178,69,0],[180,30,182,77,0],[183,25,183,26,0],[184,29,185,111,0],[187,21,187,22,0],[189,21,189,22,1],[190,25,192,77,1],[193,25,193,26,1],[194,29,196,69,1],[198,30,198,205,1],[199,25,199,26,0],[200,29,200,109,0],[202,21,202,22,1],[203,17,203,18,1],[205,17,205,40,1],[206,17,206,18,0],[207,21,209,77,0],[210,25,210,74,0],[212,21,212,70,0],[213,21,213,59,0],[214,25,214,69,0],[216,21,216,83,0],[217,21,217,22,0],[218,25,219,100,0],[220,25,220,57,0],[221,25,221,26,0],[222,29,222,63,0],[223,29,223,62,0],[224,29,224,30,0],[225,33,225,127,0],[227,25,227,26,0],[228,21,228,22,0],[230,21,230,41,0],[232,21,232,28,0],[232,30,232,46,0],[232,47,232,49,0],[232,50,232,71,0],[233,21,233,22,0],[234,25,234,59,0],[236,25,236,101,0],[238,25,239,114,0],[240,25,240,26,0],[241,29,241,46,0],[242,25,242,26,0],[244,25,246,77,0],[247,25,247,87,0],[248,25,248,89,0],[249,25,249,90,0],[250,25,250,91,0],[251,25,251,89,0],[252,25,252,92,0],[253,25,253,92,0],[255,25,255,41,0],[256,29,257,98,0],[259,25,259,41,0],[260,29,261,98,0],[263,25,265,70,0],[266,29,266,38,0],[267,25,267,68,0],[268,29,269,141,0],[270,25,270,68,0],[271,29,272,141,0],[276,25,276,57,0],[277,29,278,126,0],[279,25,279,93,0],[280,29,281,125,0],[283,25,283,46,0],[284,25,284,26,0],[285,29,285,69,0],[286,33,287,128,0],[288,25,288,26,0],[289,30,289,70,0],[290,29,291,124,0],[293,25,293,87,0],[294,29,295,127,0],[296,25,296,87,0],[297,29,298,123,0],[301,21,301,22,0],[302,21,306,88,0],[307,25,308,91,0],[309,17,309,18,0],[310,17,310,58,1],[311,17,311,18,1],[312,21,312,44,1],[313,21,313,50,1],[314,21,314,22,1],[315,25,315,66,1],[316,25,316,63,1],[317,29,317,101,0],[318,21,318,22,1],[320,21,320,47,1],[321,25,321,54,1],[323,25,323,55,0],[325,21,325,48,1],[326,21,326,22,0],[327,25,327,80,0],[328,21,328,22,0],[330,21,330,53,1],[331,21,331,61,1],[332,21,332,72,1],[334,21,334,96,1],[335,21,335,74,1],[336,21,336,53,1],[337,21,337,57,1],[340,21,340,75,1],[341,21,341,120,1],[342,21,342,36,1],[343,21,343,67,1],[344,21,344,50,1],[345,21,345,22,1],[346,25,346,62,1],[347,21,347,22,1],[349,21,349,22,0],[350,25,350,61,0],[353,25,353,39,0],[354,25,356,50,0],[357,25,357,78,0],[359,25,359,58,0],[360,25,360,32,0],[360,34,360,50,0],[360,51,360,53,0],[360,54,360,75,0],[361,25,361,26,0],[362,29,362,63,0],[363,29,363,55,0],[364,29,364,86,0],[365,29,365,48,0],[366,29,366,87,0],[367,29,367,97,0],[368,29,368,53,0],[369,25,369,26,0],[370,21,370,22,0],[373,21,373,22,1],[375,25,375,119,1],[377,25,377,53,1],[378,29,378,73,0],[380,25,380,81,1],[382,25,382,68,1],[384,25,384,136,1],[386,25,386,52,1],[387,29,387,97,0],[388,30,388,59,1],[389,29,389,101,0],[390,30,390,57,1],[391,29,393,70,0],[394,21,394,22,1],[395,21,395,41,0],[396,21,396,22,0],[397,25,399,142,0],[400,29,400,38,0],[401,21,401,22,0],[402,21,402,41,1],[403,21,403,38,1],[404,21,404,22,1],[409,25,409,37,1],[412,25,412,38,0],[415,21,415,41,0],[416,13,416,14,0],[417,13,417,33,1],[418,13,418,14,1],[419,17,419,70,1],[420,17,421,111,1],[422,13,422,14,1],[424,13,424,33,1],[425,9,425,10,1],[428,9,428,10,0],[429,13,429,49,0],[435,13,435,14,1],[436,17,439,93,1],[440,17,440,38,1],[441,13,441,14,1],[444,9,444,50,1],[447,17,447,18,1],[447,19,447,35,1],[447,36,447,37,1],[452,17,452,18,1],[452,19,452,36,1],[452,37,452,38,1],[457,17,457,18,0],[457,19,457,31,0],[457,32,457,33,0],[462,17,462,18,1],[462,19,462,39,1],[462,40,462,41,1],[467,17,467,18,1],[467,19,467,65,1],[467,66,467,67,1],[473,13,473,14,1],[474,17,476,98,1],[477,17,477,27,1],[478,13,478,14,1],[484,13,484,14,0],[485,17,490,124,0],[491,13,491,14,0],[495,9,495,10,1],[496,13,496,56,1],[497,17,498,107,0],[499,13,504,120,1],[505,9,505,10,1],[512,9,512,10,1],[514,13,514,66,1],[516,13,516,68,1],[517,13,517,14,1],[518,17,518,104,1],[519,21,519,68,1],[520,22,520,109,1],[521,21,521,70,1],[522,13,522,14,1],[524,13,524,71,1],[525,13,525,44,1],[526,13,526,60,1],[529,13,529,42,1],[530,13,531,60,1],[533,13,533,66,1],[534,13,534,68,1],[537,13,537,44,1],[538,13,538,42,1],[539,13,539,57,1],[540,13,540,39,1],[541,13,541,44,1],[542,13,542,45,1],[544,13,544,42,1],[545,13,545,57,1],[546,13,546,39,1],[547,13,547,37,1],[548,13,548,38,1],[550,13,550,40,1],[552,13,552,142,1],[553,13,553,138,1],[555,13,555,28,1],[556,9,556,10,1],[559,9,559,10,1],[560,13,560,41,1],[561,13,561,34,1],[562,13,562,82,1],[563,13,563,44,1],[564,13,564,40,1],[566,13,566,48,1],[567,13,567,14,1],[568,17,568,44,1],[569,17,569,18,1],[570,21,571,96,1],[573,21,573,155,1],[574,21,574,22,1],[575,25,575,43,1],[576,25,576,26,1],[577,29,577,90,1],[578,29,578,49,1],[579,29,579,30,1],[580,33,580,65,1],[581,29,581,30,1],[582,25,582,26,1],[583,21,583,22,1],[584,17,584,18,1],[585,13,585,14,1],[586,9,586,10,1],[589,9,589,10,1],[590,13,590,31,1],[591,13,591,14,1],[592,17,592,78,1],[593,17,593,37,1],[594,17,594,18,1],[595,21,595,49,1],[596,21,596,84,1],[597,25,597,290,1],[599,21,599,78,0],[600,21,600,46,1],[601,17,601,18,1],[602,13,602,14,1],[603,13,603,67,1],[604,13,604,14,1],[605,17,605,79,1],[606,17,606,114,1],[607,17,607,84,1],[608,13,608,14,1],[609,9,609,10,1],[612,9,612,10,0],[613,13,613,24,0],[615,13,615,65,0],[617,13,620,111,0],[621,9,621,10,0],[624,9,624,10,1],[628,13,628,91,1],[629,13,629,91,1],[633,13,633,74,1],[634,13,634,30,1],[635,13,636,72,1],[637,17,639,27,0],[641,13,641,88,1],[643,13,643,29,1],[644,13,644,56,1],[645,17,645,81,0],[647,13,647,44,1],[649,13,649,29,1],[650,13,650,14,1],[651,17,651,96,1],[652,17,652,124,1],[653,17,653,128,1],[654,17,654,122,1],[655,17,655,65,1],[656,17,656,125,1],[658,17,658,122,1],[659,17,659,99,1],[660,17,660,95,1],[661,17,661,58,1],[668,17,668,102,1],[669,17,669,38,1],[670,17,670,18,0],[671,21,671,99,0],[672,21,672,58,0],[673,21,673,58,0],[674,21,674,58,0],[675,21,675,22,0],[676,25,676,62,0],[677,25,677,84,0],[678,21,678,22,0],[679,17,679,18,0],[680,17,680,81,1],[681,17,681,67,1],[682,17,682,71,1],[683,17,683,56,1],[684,17,684,75,1],[687,17,687,53,1],[688,17,688,44,1],[689,17,689,67,1],[690,17,690,65,1],[691,17,691,53,1],[692,17,692,52,1],[693,17,693,53,1],[694,17,694,52,1],[696,17,696,18,1],[697,21,697,114,1],[699,21,699,49,1],[700,25,700,68,0],[701,17,701,18,1],[702,17,702,22,0],[703,17,703,18,0],[704,21,706,45,0],[707,17,707,18,0],[709,17,709,95,1],[710,17,710,93,1],[711,17,711,94,1],[712,13,712,14,1],[716,13,716,60,1],[717,13,717,14,1],[718,17,718,48,1],[719,17,719,52,1],[720,17,720,38,1],[721,17,721,45,1],[722,17,722,48,1],[723,13,723,14,1],[725,13,725,54,1],[726,13,726,14,1],[727,17,727,48,1],[728,17,728,56,1],[729,17,729,38,1],[730,17,730,39,1],[731,17,731,48,1],[732,13,732,14,1],[734,13,734,54,1],[735,13,735,14,1],[736,17,736,48,1],[737,17,737,51,1],[738,17,738,38,1],[739,17,739,39,1],[740,17,740,48,1],[741,13,741,14,1],[743,13,745,122,1],[746,13,746,14,1],[747,17,747,85,1],[748,17,748,101,1],[749,13,749,14,1],[750,18,754,39,1],[754,39,754,40,1],[754,40,755,43,1],[755,43,757,101,1],[757,101,758,39,1],[758,39,758,40,1],[758,40,759,93,1],[750,18,759,93,1],[760,13,760,14,1],[761,17,761,40,1],[762,13,762,14,1],[764,13,764,14,0],[765,17,765,74,0],[766,17,768,112,0],[769,17,769,113,0],[770,17,770,76,0],[771,17,771,18,0],[772,21,772,101,0],[773,17,773,18,0],[774,22,774,94,0],[775,17,775,18,0],[777,17,777,18,0],[778,13,778,14,0],[779,13,779,57,1],[780,13,780,14,0],[782,13,782,14,0],[783,13,783,29,1],[784,13,784,14,1],[786,17,786,42,1],[787,17,787,32,1],[788,17,788,62,1],[789,17,789,18,0],[790,21,790,35,0],[791,17,791,18,0],[793,17,793,18,1],[794,21,802,42,1],[805,21,805,32,1],[807,21,807,50,1],[808,17,808,18,1],[809,17,809,55,1],[810,17,810,89,1],[811,17,811,18,1],[812,21,812,50,1],[813,25,813,102,1],[814,17,814,18,1],[816,17,816,18,1],[817,21,817,70,1],[818,21,818,38,1],[819,21,819,52,1],[820,21,820,40,1],[821,21,821,35,1],[822,21,822,41,1],[823,21,823,64,1],[824,17,824,18,1],[825,13,825,14,1],[828,13,828,39,1],[830,13,830,36,1],[831,13,831,14,1],[832,17,832,54,1],[833,17,833,53,1],[835,17,835,53,1],[836,17,836,52,1],[837,13,837,14,1],[838,18,838,41,0],[839,13,839,14,0],[840,17,840,53,0],[841,17,841,52,0],[842,17,842,54,0],[843,17,843,53,0],[844,13,844,14,0],[846,13,846,32,1],[847,13,847,14,0],[848,17,848,51,0],[849,17,849,54,0],[850,13,850,14,0],[852,13,852,14,1],[853,17,853,51,1],[854,17,854,54,1],[855,13,855,14,1],[858,13,858,35,1],[859,13,859,43,1],[860,13,860,14,0],[861,17,861,42,0],[862,13,862,14,0],[863,9,863,10,1],[866,9,866,10,1],[867,13,867,43,1],[868,17,868,49,0],[870,17,872,61,1],[875,13,875,85,1],[876,13,876,14,0],[877,17,877,35,0],[878,17,878,18,0],[879,21,879,82,0],[880,21,880,41,0],[881,21,881,22,0],[882,25,882,57,0],[883,21,883,22,0],[884,17,884,18,0],[885,13,885,14,0],[887,13,887,33,1],[888,9,888,10,1],[891,9,891,10,0],[892,13,892,55,0],[893,13,893,77,0],[894,9,894,10,0],[898,9,898,10,0],[899,13,899,66,0],[900,13,900,61,0],[901,13,901,52,0],[902,13,902,14,0],[903,17,904,107,0],[905,17,905,30,0],[907,18,907,37,0],[908,13,908,14,0],[909,17,909,75,0],[910,17,910,55,0],[911,17,911,101,0],[912,17,912,101,0],[913,17,913,91,0],[914,17,914,28,0],[915,21,915,82,0],[917,21,917,74,0],[918,13,918,14,0],[920,13,920,14,0],[922,17,923,122,0],[924,17,924,18,0],[925,21,925,87,0],[926,21,926,59,0],[927,21,927,105,0],[928,21,928,105,0],[929,21,929,95,0],[931,21,931,32,0],[932,25,933,91,0],[935,25,936,57,0],[937,21,937,62,0],[938,21,938,22,0],[939,25,941,71,0],[942,25,942,38,0],[944,17,944,18,0],[946,17,946,18,0],[947,21,947,50,0],[948,21,948,34,0],[950,13,950,14,0],[951,13,951,49,0],[952,13,952,25,0],[953,9,953,10,0],[956,9,956,10,1],[957,13,957,99,1],[958,13,958,57,1],[959,13,959,63,1],[960,13,960,42,1],[961,13,961,61,1],[962,9,962,10,1],[965,9,965,10,0],[966,13,966,117,0],[967,13,967,14,0],[968,17,971,35,0],[972,17,972,56,0],[973,17,973,18,0],[974,21,974,78,0],[975,21,975,68,0],[976,21,976,69,0],[977,17,977,18,0],[978,17,978,45,0],[979,17,979,64,0],[980,22,980,31,0],[980,33,980,65,0],[980,67,980,70,0],[981,17,981,18,0],[982,21,982,103,0],[983,17,983,18,0],[984,13,984,14,0],[985,9,985,10,0],[988,9,988,10,1],[989,13,989,46,1],[991,13,991,46,1],[993,13,993,47,1],[994,13,994,41,1],[995,13,995,48,1],[997,13,997,47,1],[998,13,998,99,1],[1000,13,1000,43,1],[1001,13,1001,100,1],[1003,13,1003,190,1],[1004,13,1004,50,1],[1005,13,1005,132,1],[1006,9,1006,10,1],[1009,9,1009,10,1],[1010,13,1010,72,1],[1012,13,1012,45,1],[1013,13,1013,14,1],[1014,17,1014,51,1],[1016,17,1016,88,1],[1018,17,1018,88,1],[1019,17,1019,78,1],[1020,17,1020,39,1],[1021,17,1021,18,1],[1022,21,1022,46,1],[1023,21,1026,124,1],[1027,21,1028,124,1],[1029,21,1030,123,1],[1031,21,1034,123,1],[1035,21,1035,53,1],[1036,21,1036,52,1],[1038,21,1038,58,1],[1039,21,1039,57,1],[1041,21,1041,57,1],[1042,21,1042,56,1],[1044,21,1044,70,1],[1045,21,1045,38,1],[1046,21,1046,52,1],[1047,21,1047,40,1],[1048,21,1048,35,1],[1049,21,1049,41,1],[1050,17,1050,18,1],[1052,17,1052,18,0],[1053,21,1053,52,0],[1055,21,1055,38,0],[1057,21,1057,50,0],[1058,21,1058,35,0],[1059,21,1059,41,0],[1061,21,1061,76,0],[1062,21,1062,22,0],[1066,25,1071,62,0],[1072,21,1072,22,0],[1074,21,1074,61,0],[1075,21,1075,75,0],[1076,21,1076,48,0],[1078,21,1078,57,0],[1079,21,1079,56,0],[1081,21,1081,58,0],[1082,21,1082,57,0],[1083,17,1083,18,0],[1085,17,1085,64,1],[1086,17,1086,63,1],[1087,17,1087,67,1],[1091,17,1091,50,1],[1092,17,1092,18,1],[1093,21,1100,51,1],[1101,21,1101,47,1],[1102,21,1102,49,1],[1103,21,1103,51,1],[1104,21,1104,53,1],[1105,21,1105,45,1],[1106,21,1106,48,1],[1107,21,1107,51,1],[1108,21,1108,52,1],[1110,21,1110,53,1],[1111,21,1111,47,1],[1112,17,1112,18,1],[1113,13,1113,14,1],[1115,13,1115,14,0],[1116,17,1116,41,0],[1117,17,1119,63,0],[1120,13,1120,14,0],[1121,9,1121,10,1],[1124,9,1124,10,1],[1126,13,1126,20,1],[1126,22,1126,41,1],[1126,42,1126,44,1],[1126,45,1126,55,1],[1127,13,1127,14,1],[1128,17,1128,46,1],[1129,13,1129,14,1],[1131,13,1131,87,1],[1132,13,1132,75,1],[1133,13,1133,59,1],[1135,13,1135,77,1],[1137,13,1137,58,1],[1138,13,1138,63,1],[1139,13,1139,60,1],[1144,13,1144,58,1],[1145,13,1145,54,1],[1146,13,1146,64,1],[1148,13,1148,84,1],[1149,13,1149,83,1],[1150,13,1150,81,1],[1151,13,1151,56,1],[1152,13,1152,58,1],[1153,13,1153,59,1],[1154,13,1154,56,1],[1155,13,1155,98,1],[1157,13,1157,72,1],[1158,13,1158,56,1],[1159,13,1159,98,1],[1161,13,1161,68,1],[1162,13,1162,77,1],[1163,13,1163,61,1],[1164,13,1164,105,1],[1166,13,1166,108,1],[1167,13,1167,86,1],[1168,13,1168,84,1],[1169,13,1169,104,1],[1171,13,1171,95,1],[1172,13,1172,92,1],[1174,13,1174,102,1],[1175,13,1175,99,1],[1177,13,1177,100,1],[1178,13,1178,97,1],[1180,13,1180,101,1],[1181,13,1181,98,1],[1183,13,1183,101,1],[1184,13,1184,98,1],[1186,13,1186,101,1],[1187,13,1187,98,1],[1190,13,1190,66,1],[1191,13,1191,72,1],[1192,13,1192,72,1],[1193,13,1193,72,1],[1194,13,1194,71,1],[1195,13,1195,73,1],[1196,13,1196,71,1],[1197,13,1197,67,1],[1198,13,1198,70,1],[1199,9,1199,10,1],[1202,9,1202,10,1],[1203,13,1203,77,1],[1204,13,1204,14,0],[1205,17,1207,84,0],[1208,13,1208,14,0],[1210,13,1210,14,1],[1211,17,1218,27,1],[1219,13,1219,14,0],[1220,9,1220,10,0],[1223,9,1223,10,1],[1224,13,1224,42,1],[1225,9,1225,10,1],[1228,9,1228,10,0],[1231,13,1231,43,0],[1232,13,1232,81,0],[1234,13,1235,97,0],[1236,13,1236,14,0],[1238,17,1238,66,0],[1239,17,1239,55,0],[1240,21,1240,65,0],[1242,21,1242,38,0],[1244,17,1248,84,0],[1250,17,1250,55,0],[1251,21,1251,76,0],[1252,17,1252,86,0],[1254,17,1254,83,0],[1255,17,1255,95,0],[1256,17,1256,35,0],[1257,17,1257,18,0],[1258,21,1258,72,0],[1260,26,1260,35,0],[1260,37,1260,51,0],[1261,21,1261,22,0],[1262,25,1262,63,0],[1263,25,1263,83,0],[1265,25,1265,78,0],[1266,25,1266,26,0],[1267,29,1267,94,0],[1268,33,1269,73,0],[1271,29,1271,30,0],[1272,33,1272,68,0],[1273,33,1273,69,0],[1274,33,1274,59,0],[1275,33,1277,94,0],[1278,33,1278,48,0],[1279,37,1279,56,0],[1281,33,1281,50,0],[1282,29,1282,30,0],[1283,25,1283,26,0],[1285,25,1285,26,0],[1287,29,1288,109,0],[1289,29,1289,53,0],[1290,29,1290,30,0],[1291,33,1291,59,0],[1292,33,1292,96,0],[1293,33,1293,87,0],[1295,33,1295,74,0],[1296,33,1297,111,0],[1298,33,1298,118,0],[1299,33,1300,111,0],[1301,33,1302,76,0],[1303,33,1303,74,0],[1304,29,1304,30,0],[1306,29,1306,33,0],[1307,25,1307,26,0],[1308,21,1308,22,0],[1309,17,1309,18,0],[1310,13,1310,14,0],[1312,13,1312,14,0],[1313,17,1317,37,0],[1318,17,1318,18,0],[1319,21,1321,62,0],[1322,17,1322,18,0],[1325,22,1325,31,0],[1325,33,1325,47,0],[1325,49,1325,52,0],[1326,17,1326,18,0],[1327,21,1327,59,0],[1328,21,1328,79,0],[1331,21,1332,110,0],[1335,21,1335,39,0],[1336,21,1337,82,0],[1338,21,1338,22,0],[1339,25,1339,79,0],[1340,25,1340,79,0],[1342,25,1342,66,0],[1343,25,1344,103,0],[1345,25,1345,110,0],[1346,25,1347,103,0],[1348,25,1349,68,0],[1350,25,1350,66,0],[1351,21,1351,22,0],[1352,17,1352,18,0],[1353,13,1353,14,0],[1354,9,1354,10,0],[1357,9,1357,10,0],[1358,13,1358,48,0],[1360,13,1360,38,0],[1362,13,1362,32,0],[1363,13,1363,14,0],[1364,17,1364,96,0],[1365,13,1365,14,0],[1367,13,1367,14,0],[1368,17,1368,83,0],[1369,17,1369,95,0],[1370,13,1370,14,0],[1373,13,1373,45,0],[1374,13,1374,35,0],[1377,13,1377,20,0],[1377,22,1377,41,0],[1377,42,1377,44,0],[1377,45,1377,63,0],[1378,13,1378,14,0],[1379,17,1379,46,0],[1380,13,1380,14,0],[1382,13,1382,57,0],[1384,13,1388,56,0],[1390,13,1390,81,0],[1391,13,1391,69,0],[1392,13,1392,99,0],[1393,13,1393,89,0],[1395,13,1395,67,0],[1396,13,1396,98,0],[1397,13,1397,88,0],[1398,13,1398,96,0],[1399,13,1399,88,0],[1401,13,1401,85,0],[1402,13,1402,105,0],[1403,13,1403,97,0],[1405,13,1405,79,0],[1407,13,1407,64,0],[1408,13,1408,84,0],[1409,13,1409,74,0],[1410,9,1410,10,0],[1414,9,1414,10,0],[1415,9,1415,10,0],[1418,9,1418,10,0],[1419,13,1419,51,0],[1420,13,1420,14,0],[1421,17,1421,63,0],[1422,17,1422,55,0],[1423,21,1423,76,0],[1424,17,1424,86,0],[1425,22,1425,36,0],[1425,38,1425,74,0],[1425,76,1425,84,0],[1426,17,1426,18,0],[1427,21,1427,70,0],[1428,21,1428,55,0],[1429,21,1429,97,0],[1430,21,1430,64,0],[1431,21,1431,22,0],[1432,25,1432,82,0],[1433,29,1434,72,0],[1436,25,1436,60,0],[1437,25,1437,79,0],[1438,25,1438,51,0],[1439,25,1439,44,0],[1440,21,1440,22,0],[1442,21,1442,22,0],[1443,25,1443,70,0],[1444,25,1444,80,0],[1445,25,1445,84,0],[1446,25,1446,82,0],[1447,25,1447,74,0],[1448,25,1448,76,0],[1449,21,1449,22,0],[1450,17,1450,18,0],[1452,17,1452,36,0],[1453,17,1453,31,0],[1454,17,1454,37,0],[1455,17,1455,48,0],[1456,17,1456,58,0],[1457,13,1457,14,0],[1458,9,1458,10,0],[1461,9,1461,10,0],[1462,13,1462,62,0],[1463,13,1463,51,0],[1464,17,1464,61,0],[1466,17,1466,34,0],[1468,13,1472,80,0],[1475,13,1475,37,0],[1476,13,1476,54,0],[1477,13,1477,51,0],[1478,13,1478,14,0],[1479,17,1479,35,0],[1480,17,1480,82,0],[1481,13,1481,14,0],[1483,13,1483,44,0],[1484,13,1484,20,0],[1484,22,1484,38,0],[1484,39,1484,41,0],[1484,42,1484,71,0],[1485,17,1485,64,0],[1486,21,1486,73,0],[1488,13,1488,48,0],[1489,17,1489,71,0],[1491,13,1491,76,0],[1492,17,1492,71,0],[1494,13,1494,20,0],[1494,22,1494,38,0],[1494,39,1494,41,0],[1494,42,1494,71,0],[1495,13,1495,14,0],[1496,17,1496,51,0],[1498,17,1498,60,0],[1499,17,1499,18,0],[1500,21,1500,119,0],[1501,21,1501,22,0],[1502,25,1502,41,0],[1503,25,1503,40,0],[1505,25,1505,85,0],[1506,25,1506,76,0],[1509,25,1509,37,0],[1510,29,1510,38,0],[1512,25,1512,48,0],[1514,25,1539,36,0],[1549,21,1549,22,0],[1550,17,1550,18,0],[1551,17,1551,51,0],[1552,13,1552,14,0],[1554,13,1554,36,0],[1555,13,1555,20,0],[1555,22,1555,41,0],[1555,42,1555,44,0],[1555,45,1555,52,0],[1556,13,1556,14,0],[1557,17,1557,101,0],[1559,17,1560,113,0],[1561,17,1561,18,0],[1562,21,1562,38,0],[1563,21,1563,73,0],[1564,21,1564,83,0],[1565,21,1565,87,0],[1566,21,1566,85,0],[1567,21,1567,77,0],[1568,21,1568,79,0],[1569,17,1569,18,0],[1570,17,1570,31,0],[1571,21,1571,40,0],[1572,13,1572,14,0],[1574,13,1574,32,0],[1575,13,1575,27,0],[1576,13,1576,33,0],[1578,13,1578,44,0],[1580,13,1580,28,0],[1581,17,1581,58,0],[1582,9,1582,10,0],[1585,9,1585,10,1],[1586,13,1586,50,1],[1587,17,1587,44,1],[1588,13,1588,48,1],[1589,17,1589,42,1],[1590,13,1590,56,1],[1591,17,1591,50,1],[1592,13,1592,53,1],[1593,17,1593,47,1],[1595,13,1595,50,1],[1596,17,1596,44,1],[1597,13,1597,46,1],[1598,17,1598,40,1],[1599,13,1599,51,1],[1600,17,1600,45,1],[1601,13,1601,48,1],[1602,17,1602,42,1],[1603,13,1603,48,1],[1604,17,1604,42,0],[1605,13,1605,53,1],[1606,17,1606,47,1],[1607,13,1607,55,1],[1608,17,1608,49,1],[1609,13,1609,54,1],[1610,17,1610,48,1],[1611,13,1611,50,1],[1612,17,1612,44,1],[1613,13,1613,51,1],[1614,17,1614,45,1],[1616,13,1616,48,1],[1617,17,1617,42,1],[1618,13,1618,54,1],[1619,17,1619,48,1],[1620,13,1620,54,1],[1621,17,1621,48,1],[1622,13,1622,50,1],[1623,17,1623,44,1],[1624,13,1624,55,1],[1625,17,1625,49,1],[1626,13,1626,52,1],[1627,17,1627,46,1],[1628,13,1628,52,1],[1629,17,1629,46,1],[1630,9,1630,10,1],[1634,9,1634,10,0],[1635,13,1635,94,0],[1636,13,1636,14,0],[1637,17,1637,78,0],[1638,17,1638,83,0],[1639,13,1639,14,0],[1641,13,1642,78,0],[1643,13,1643,14,0],[1644,17,1644,83,0],[1645,17,1645,116,0],[1647,17,1647,78,0],[1648,17,1648,109,0],[1649,13,1649,14,0],[1651,13,1654,66,0],[1655,9,1655,10,0],[1658,9,1658,10,0],[1659,13,1659,70,0],[1661,13,1661,110,0],[1662,17,1662,35,0],[1664,17,1664,34,0],[1666,13,1666,50,0],[1668,13,1668,113,0],[1669,17,1669,35,0],[1671,17,1671,34,0],[1673,13,1673,50,0],[1676,13,1676,108,0],[1677,17,1677,35,0],[1679,17,1679,34,0],[1680,9,1680,10,0],[1683,9,1683,10,0],[1684,13,1684,27,0],[1685,9,1685,10,0],[1688,9,1688,10,0],[1699,9,1699,10,0],[1702,9,1702,10,1],[1704,13,1704,63,1],[1705,13,1705,14,1],[1706,17,1706,42,1],[1707,17,1707,96,1],[1708,17,1712,84,1],[1713,17,1714,187,1],[1715,17,1715,206,1],[1716,17,1716,85,1],[1717,17,1717,132,1],[1718,17,1718,43,1],[1719,17,1719,146,1],[1720,17,1720,45,1],[1721,13,1721,14,1],[1722,9,1722,10,1],[1725,9,1725,10,1],[1726,13,1726,122,1],[1727,13,1727,122,1],[1728,13,1730,47,1],[1731,13,1732,71,1],[1733,9,1733,10,1],[1736,9,1736,10,1],[1737,13,1738,115,1],[1739,13,1739,141,1],[1740,13,1740,186,1],[1741,9,1741,10,1],[1744,9,1744,10,1],[1745,13,1745,84,1],[1746,17,1746,90,1],[1748,17,1748,58,1],[1749,9,1749,10,1],[1754,9,1754,10,1],[1788,9,1788,10,1],[1791,9,1791,10,1],[1812,9,1812,10,1],[1815,9,1815,10,0],[1819,13,1819,102,0],[1821,13,1821,51,0],[1822,13,1822,54,0],[1823,13,1823,53,0],[1824,13,1824,48,0],[1825,13,1825,58,0],[1826,13,1826,50,0],[1827,13,1827,53,0],[1828,13,1828,57,0],[1829,13,1829,50,0],[1830,13,1830,54,0],[1831,13,1831,51,0],[1832,13,1832,54,0],[1833,13,1833,50,0],[1834,13,1834,50,0],[1835,13,1835,55,0],[1836,13,1836,44,0],[1837,13,1837,14,0],[1838,17,1838,59,0],[1839,13,1839,14,0],[1840,13,1840,89,0],[1841,13,1841,92,0],[1842,13,1842,87,0],[1843,13,1843,91,0],[1844,13,1844,93,0],[1846,13,1846,86,0],[1848,13,1848,52,0],[1849,13,1849,50,0],[1851,13,1851,102,0],[1852,13,1852,65,0],[1853,13,1853,105,0],[1854,13,1854,65,0],[1855,13,1855,45,0],[1857,13,1857,100,0],[1858,13,1858,65,0],[1859,13,1859,44,0],[1861,13,1861,72,0],[1862,13,1862,71,0],[1864,13,1864,65,0],[1865,13,1865,104,0],[1866,13,1866,65,0],[1867,13,1867,46,0],[1869,13,1869,65,0],[1870,13,1870,79,0],[1871,13,1871,84,0],[1872,9,1872,10,0],[1875,9,1875,10,0],[1876,13,1876,88,0],[1877,13,1877,28,0],[1878,13,1878,24,0],[1879,13,1879,51,0],[1880,9,1880,10,0],[1883,9,1883,10,1],[1906,9,1906,10,1],[1913,9,1913,10,0],[1914,13,1914,51,0],[1915,13,1915,24,0],[1916,17,1916,57,0],[1918,17,1918,46,0],[1919,9,1919,10,0],[1922,9,1922,10,0],[1923,13,1923,42,0],[1924,9,1924,10,0],[1927,9,1927,10,0],[1928,13,1928,42,0],[1929,13,1929,75,0],[1930,13,1930,14,0],[1931,17,1931,91,0],[1932,17,1932,95,0],[1933,13,1933,14,0],[1934,13,1934,49,0],[1935,13,1935,48,0],[1937,13,1937,50,0],[1938,13,1938,49,0],[1939,13,1939,30,0],[1940,9,1940,10,0]]);
    </script>
  </body>
</html>