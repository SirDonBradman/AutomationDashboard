<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\Controller\ModuleApiController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Globalization;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Threading;
using System.Web.Http;
using System.Web.Script.Serialization;
using System.Xml;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.Brix.Platform.BusinessLayer.XmlForm_Framework;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;

namespace Aurigo.Brix.Platform.BusinessLayer.Controller
{
    public class ModuleApiController : ApiController
    {
        BrixFormModel model;

        [HttpGet]
        public HttpResponseMessage Instances(string moduleId, string jsonParameters)
        {
            UserDetail ud = CurrentUser.CurrentUserDetail;

            JavaScriptSerializer js = new JavaScriptSerializer();
            Dictionary&lt;string, object&gt; filters = string.IsNullOrEmpty(jsonParameters)
                ? new Dictionary&lt;string, object&gt;()
                : js.Deserialize&lt;Dictionary&lt;string, object&gt;&gt;(jsonParameters);

            CultureInfo ci = new CultureInfo(AMP3ApplicationSettings.Instance.Culture);
            Thread.CurrentThread.CurrentCulture = ci;
            Thread.CurrentThread.CurrentUICulture = ci;

            model = new BrixFormModel(XMLForms.GetXMLFormModuleID(moduleId), moduleId + &quot;.xml&quot;, XMLType.Form, null, null);

            Dictionary&lt;string, object&gt; formParams = filters.ContainsKey(moduleId)
                ? filters[moduleId] as Dictionary&lt;string, object&gt;
                : new Dictionary&lt;string, object&gt;();
            Dictionary&lt;string, object&gt; filterFields = filters.ContainsKey(&quot;filters&quot;)
                ? filters[&quot;filters&quot;] as Dictionary&lt;string, object&gt;
                : new Dictionary&lt;string, object&gt;();

            if (!filters.ContainsKey(&quot;pid&quot;) &amp;&amp; formParams.ContainsKey(&quot;pid&quot;)) filters.Add(&quot;pid&quot;, formParams[&quot;pid&quot;]);
            if (!filters.ContainsKey(&quot;parentid&quot;) &amp;&amp; formParams.ContainsKey(&quot;parentid&quot;))
                filters.Add(&quot;parentid&quot;, formParams[&quot;parentid&quot;]);
            if (!filters.ContainsKey(&quot;parentmodule&quot;)) filters.Add(&quot;parentmodule&quot;, model.form.ParentModuleID);

            List&lt;string&gt; permissions =
                ModuleManager.Instance.GetPermissionByUserOrRole(
                    string.IsNullOrEmpty(model.form.AssociatedModuleID) ? moduleId : model.form.AssociatedModuleID,
                    ud.UID, ud.RID, (filters.ContainsKey(&quot;pid&quot;) ? filters[&quot;pid&quot;].ToInt32_2() : 0));

            if (permissions == null) throw new Exception(&quot;The user does not have permissions.&quot;);
            if (!permissions.Contains(&quot;View&quot;)) throw new Exception(&quot;The user does not have permissions.&quot;);


            int pageSize = 50;
            if (filters.ContainsKey(&quot;pagesize&quot;) &amp;&amp; null != filters[&quot;pagesize&quot;])
                Int32.TryParse(filters[&quot;pagesize&quot;].ToString(), out pageSize);

            int pageToGet = 1;
            if (filters.ContainsKey(&quot;pagetoget&quot;) &amp;&amp; null != filters[&quot;pagetoget&quot;])
                Int32.TryParse(filters[&quot;pagetoget&quot;].ToString(), out pageToGet);

            bool isStringDataTable = false;
            if (filters.ContainsKey(&quot;stringtypes&quot;) &amp;&amp; null != filters[&quot;stringtypes&quot;])
                Boolean.TryParse(filters[&quot;stringtypes&quot;].ToString(), out isStringDataTable);

            bool returnjson = false;
            if (filters.ContainsKey(&quot;returnjson&quot;) &amp;&amp; null != filters[&quot;returnjson&quot;])
                Boolean.TryParse(filters[&quot;returnjson&quot;].ToString(), out returnjson);

            int pageCount = 0;
            ListModel listModel = ListModel.GetXMLInstance(null, null, &quot;&quot;, moduleId, filters);
            XMLRenderingEngine engine = null;
            ArrayList cols = null;
            if (listModel != null)
            {
                engine = new XMLRenderingEngine(null, listModel.xmlModel, null);
                engine.Initialize();
            }
            DataSet ds = GetDataSet(listModel, ref pageToGet, null, filterFields, pageSize, false, out cols,
                out pageCount);
            if (ds.Tables.Count &gt; 0)
            {
                DataColumn dc = new DataColumn(&quot;PageCount&quot;, Type.GetType(&quot;System.Int32&quot;));
                dc.DefaultValue = pageCount;
                ds.Tables[0].Columns.Add(dc);
                ds.Tables[0].AcceptChanges();
                DataTable dt = !isStringDataTable ? ds.Tables[0] : ApiControllerHelper.GetStringDataTable(ds.Tables[0]);
                if (dt.Rows.Count &gt; 0)
                {
                    if (returnjson)
                    {
                        List&lt;Dictionary&lt;string, object&gt;&gt; rtn = new List&lt;Dictionary&lt;string, object&gt;&gt;();
                        foreach (DataRow dr in dt.Rows)
                        {
                            Dictionary&lt;string, object&gt; rows = new Dictionary&lt;string, object&gt;();
                            foreach (DataColumn col in dt.Columns)
                                rows.Add(col.ColumnName, dr[col.ColumnName]);
                            rtn.Add(rows);
                        }
                        return Request.CreateResponse&lt;List&lt;Dictionary&lt;string, object&gt;&gt;&gt;(HttpStatusCode.OK, rtn);
                    }
                    else
                        return Request.CreateResponse&lt;DataTable&gt;(HttpStatusCode.OK, dt);
                }
            }
            return Request.CreateResponse&lt;string&gt;(HttpStatusCode.OK, null);
        }

        [HttpGet]
        public HttpResponseMessage InstanceDetails(string moduleId, string Id, string jsonParameters)
        {
            try
            {
                UserDetail ud = CurrentUser.CurrentUserDetail;

                JavaScriptSerializer js = new JavaScriptSerializer();
                Dictionary&lt;string, object&gt; filters = string.IsNullOrEmpty(jsonParameters)
                    ? new Dictionary&lt;string, object&gt;()
                    : js.Deserialize&lt;Dictionary&lt;string, object&gt;&gt;(jsonParameters);

                CultureInfo ci = new CultureInfo(AMP3ApplicationSettings.Instance.Culture);
                Thread.CurrentThread.CurrentCulture = ci;
                Thread.CurrentThread.CurrentUICulture = ci;

                XmlDocument root;
                model = new BrixFormModel(XMLForms.GetXMLFormModuleID(moduleId), moduleId + &quot;.xml&quot;, XMLType.Form, null,
                    null);
                //model.form.RequestParameters = requestParams;
                model.form.GetHostValue += new GetVal(form_GetHostValue);
                model.form.GetHostGridValue += new GetValFromGrid(form_GetHostGridValue);
                model.form.SetHostValue += new SetVal(form_SetHostValue);
                model.form.SetHostGridValue += new SetValInGrid(form_SetHostGridValue);

                List&lt;string&gt; permissions =
                    ModuleManager.Instance.GetPermissionByUserOrRole(
                        string.IsNullOrEmpty(model.form.AssociatedModuleID) ? moduleId : model.form.AssociatedModuleID,
                        ud.UID, ud.RID, (filters.ContainsKey(&quot;PID&quot;) ? filters[&quot;PID&quot;].ToInt32_2() : 0));

                if (permissions == null) throw new Exception(&quot;The user does not have permissions.&quot;);
                if (!permissions.Contains(&quot;View&quot;)) throw new Exception(&quot;The user does not have permissions.&quot;);

                var engine = new XMLRenderingEngine(null, model, null);
                model.form.instanceID = Id;
                engine.Render(RenderFormat.RenderXml);
                root = (model.form.Renderer as XmlRenderer).MasterDoc;

                var dffd = Request.CreateResponse&lt;XmlElement&gt;(HttpStatusCode.Created, root.DocumentElement);
                return dffd;
            }
            catch (Exception ex)
            {
                XmlDocument xmlDoc = new XmlDocument();
                xmlDoc.LoadXml(&quot;&lt;Error&gt;&quot; + ex.Message + &quot;&lt;/Error&gt;&quot;);
                return Request.CreateResponse&lt;XmlElement&gt;(HttpStatusCode.BadRequest, xmlDoc.DocumentElement);
            }
        }


        object form_GetHostValue(string ctrlName, string fieldName, out string datatype, out string errors)
        {
            datatype = null;
            errors = null;
            object val = null;
            xControl ctl = model.form.GetControl(ctrlName);
            if (null != ctl &amp;&amp; ctl.ControlReference.Count &gt; 0) val = ctl.ControlReference[0];
            else
            {
                ControlContainer cnt = model.form.GetContainer(ctrlName);
                if (null != cnt &amp;&amp; cnt.ControlReference.Count &gt; 0) val = cnt.ControlReference[0];
            }
            return val;
        }

        object form_GetHostGridValue(string gridName, string fieldName, string instance, string pid, string parentid,
            string parentmodule, out string datatype, out string errors)
        {
            datatype = null;
            errors = null;
            object val = null;
            if (string.IsNullOrEmpty(gridName)) return null;
            ControlContainer ctl = model.form.GetContainer(gridName);
            XmlElement x = null;
            if (null != ctl &amp;&amp; ctl.ControlReference.Count &gt; 0) x = ctl.ControlReference[0] as XmlElement;
            if (null == x || x.ChildNodes.Count &lt; 1) return val;

            DynamicGrid dg = ctl as DynamicGrid;

            XmlNodeList nl = (&quot;0&quot; == instance)
                ? x.SelectNodes(&quot;Row&quot;)
                : x.SelectNodes(&quot;Row[&quot; + dg.PrimaryKeyName + &quot;=&quot; + instance + &quot;]&quot;);
            if (null == nl || nl.Count &lt; 1) return val;

            XmlNode nd = nl[0].SelectSingleNode(fieldName);
            if (null == nd) return val;

            val = nd.InnerXml;
            return val;
        }

        bool form_SetHostValue(string gridName, string fieldName, string datatype, object val, out string errors)
        {
            errors = null;
            bool bIsSet = false;
            string error = &quot;&quot;;
            SetControlValue(model, gridName, val, ref error);
            bIsSet = string.IsNullOrEmpty(error);
            return bIsSet;
        }

        bool form_SetHostGridValue(string gridName, string fieldName, string instance, string pid, string parentid,
            string parentmodule, string datatype, object val, out string errors)
        {
            errors = null;
            bool bIsSet = false;
            DynamicGrid dg = (model.form.GetContainer(gridName) as DynamicGrid);
            if (null == dg || !(dg is DynamicGrid) || dg.ControlReference == null || dg.ControlReference.Count &lt; 1)
            {
                errors += (&quot;Grid not found to set value: Grid=&quot; + gridName + &quot;,Field=&quot; + fieldName + &quot;,Instance=&quot; +
                           instance + &quot;,Pid=&quot; + pid + &quot;,Parent=&quot; + parentid + &quot;,ParentMod=&quot; + parentmodule);
                return false;
            }
            XmlElement allrows = (dg.ControlReference[0] as XmlElement);
            if (null == allrows)
            {
                errors += (&quot;Grid not found to set value: Grid=&quot; + gridName + &quot;,Field=&quot; + fieldName + &quot;,Instance=&quot; +
                           instance + &quot;,Pid=&quot; + pid + &quot;,Parent=&quot; + parentid + &quot;,ParentMod=&quot; + parentmodule);
                return false;
            }
            if (string.IsNullOrEmpty(instance))
            {
                errors += (&quot;Cannot set value for an null instance row: Grid=&quot; + gridName + &quot;,Field=&quot; + fieldName +
                           &quot;,Instance=&quot; + instance + &quot;,Pid=&quot; + pid + &quot;,Parent=&quot; + parentid + &quot;,ParentMod=&quot; +
                           parentmodule);
                return false;
            }
            XmlElement parentRow = null;
            if (&quot;0&quot; == instance)
            {
                XmlNodeList nl = allrows.SelectNodes(&quot;Row&quot;);
                parentRow = null == nl || nl.Count &lt; 1 ? null : (nl[0] as XmlElement);
            }
            else
            {
                XmlNode ndToUpdate = null;
                ndToUpdate = allrows.SelectSingleNode(&quot;Row[&quot; + dg.PrimaryKeyName + &quot; = &quot; + instance + &quot;]&quot;);
                parentRow = null == ndToUpdate ? null : ndToUpdate as XmlElement;
            }
            XmlNode cell = parentRow.SelectSingleNode(fieldName);
            if (null == cell)
                errors += (&quot;Error updating grid - cell not found: Grid=&quot; + gridName + &quot;,Field=&quot; + fieldName +
                           &quot;,Instance=&quot; + instance + &quot;,Pid=&quot; + pid + &quot;,Parent=&quot; + parentid + &quot;,ParentMod=&quot; +
                           parentmodule);
            else
                cell.InnerText = null == val ? &quot;&quot; : val.ToString();
            return bIsSet;
        }

        [HttpPost]
        public HttpResponseMessage NewOrUpdateInstance(string moduleId, [FromBody] string jsonParameters)
        {
            try
            {
                UserDetail ud = CurrentUser.CurrentUserDetail;

                CultureInfo ci = new CultureInfo(AMP3ApplicationSettings.Instance.Culture);
                Thread.CurrentThread.CurrentCulture = ci;
                Thread.CurrentThread.CurrentUICulture = ci;

                model = new BrixFormModel(XMLForms.GetXMLFormModuleID(moduleId), moduleId + &quot;.xml&quot;, XMLType.Form, null,
                    null);
                model.form.GetHostValue += new GetVal(form_GetHostValue);
                model.form.GetHostGridValue += new GetValFromGrid(form_GetHostGridValue);
                model.form.SetHostValue += new SetVal(form_SetHostValue);
                model.form.SetHostGridValue += new SetValInGrid(form_SetHostGridValue);


                JavaScriptSerializer js = new JavaScriptSerializer();
                Dictionary&lt;string, object&gt; jsonParams = string.IsNullOrEmpty(jsonParameters)
                    ? new Dictionary&lt;string, object&gt;()
                    : js.Deserialize&lt;Dictionary&lt;string, object&gt;&gt;(jsonParameters);
                Dictionary&lt;string, object&gt; formParams = null;
                if (jsonParams.Count &gt; 0)
                    formParams = jsonParams[moduleId] as Dictionary&lt;string, object&gt;;
                string id = null != formParams &amp;&amp; formParams.ContainsKey(model.form.PrimaryKeyName)
                    ? formParams[model.form.PrimaryKeyName].ToString()
                    : null;
                bool IsCreate = string.IsNullOrEmpty(id);

                string sPid = formParams.ContainsKey(&quot;pid&quot;)
                    ? formParams[&quot;pid&quot;].ToString()
                    : (jsonParams.ContainsKey(&quot;pid&quot;) ? jsonParams[&quot;pid&quot;].ToString() : &quot;0&quot;);
                string sParentId = formParams.ContainsKey(&quot;parentid&quot;)
                    ? formParams[&quot;parentid&quot;].ToString()
                    : (jsonParams.ContainsKey(&quot;parentid&quot;) ? jsonParams[&quot;parentid&quot;].ToString() : &quot;0&quot;);
                string sParentMod = formParams.ContainsKey(&quot;parentmodule&quot;)
                    ? formParams[&quot;parentmodule&quot;].ToString()
                    : model.form.ParentModuleID;
                string sTriggerPid = jsonParams.ContainsKey(&quot;triggerpid&quot;) ? formParams[&quot;triggerpid&quot;].ToString() : sPid;
                string sTriggerParentId = jsonParams.ContainsKey(&quot;triggerparent&quot;)
                    ? formParams[&quot;triggerparent&quot;].ToString()
                    : sParentId;
                string sTriggerParentModule = jsonParams.ContainsKey(&quot;triggerparentmodule&quot;)
                    ? formParams[&quot;triggerparentmodule&quot;].ToString()
                    : sParentMod;
                string sTriggerModule = jsonParams.ContainsKey(&quot;triggermodule&quot;)
                    ? formParams[&quot;triggermodule&quot;].ToString()
                    : model.form.ModuleID;

                List&lt;string&gt; permissions =
                    ModuleManager.Instance.GetPermissionByUserOrRole(
                        string.IsNullOrEmpty(model.form.AssociatedModuleID) ? moduleId : model.form.AssociatedModuleID,
                        ud.UID, ud.RID, sPid.ToInt32_2());
                if (permissions == null) throw new Exception(&quot;The user does not have permissions.&quot;);
                if (IsCreate &amp;&amp; !permissions.Contains(&quot;Create&quot;))
                    throw new Exception(&quot;The user does not have permissions.&quot;);
                if (!IsCreate &amp;&amp; !permissions.Contains(&quot;Edit&quot;))
                    throw new Exception(&quot;The user does not have permissions.&quot;);


                Dictionary&lt;string, object&gt; req = new Dictionary&lt;string, object&gt;();
                req.Add(&quot;pid&quot;, sPid);
                req.Add(&quot;parentid&quot;, sParentId);
                req.Add(&quot;parentmodule&quot;, sParentMod);
                req.Add(&quot;iswebapi&quot;, &quot;true&quot;);
                model.form.RequestParameters = req;

                //see if the user is a stakeholder of the stage
                if (!IsCreate)
                {
                    bool bCanSave = AllowSave(moduleId, id, sPid, sParentId, IsCreate);
                    if (!bCanSave)
                        throw new Exception(&quot;The logged on user is not authorised to update this record at this stage.&quot;);
                }

                XmlElement root;
                var engine = new XMLRenderingEngine(null, model, null);
                if (!IsCreate) model.form.instanceID = id;
                engine.Render(RenderFormat.RenderXml);
                root = (model.form.Renderer as XmlRenderer).MasterDoc.DocumentElement;
                string err = &quot;&quot;;
                SetValuesFromJson(formParams, model, ref err);
                model.form.Renderer.DataSource = root.OuterXml;

                XMLFormManagerModel managerModel =
                    AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(model.form.ManagerDLL,
                        model.form.FormManagerClass);
                var formEvent = new XmlFormArgs();
                string sSavedInstanceToken = &quot;&quot;;
                if (managerModel != null)
                {
                    // &amp;&amp; managerModel is IFormManagerNonUI){
                    managerModel.BeforeSave(model, formEvent);
                }
                if (managerModel == null || (managerModel != null &amp;&amp; formEvent.IsValid))
                {
                    try
                    {
                        engine.SaveData(((model.form.Renderer as XmlRenderer).MasterDoc.OuterXml),
                            RenderFormat.RenderXml);
                        sSavedInstanceToken = model.form.instanceID;
                        if (IsCreate)
                        {
                            XmlNode nd = root.SelectSingleNode(&quot;/&quot; + moduleId + &quot;/&quot; + model.form.PrimaryKeyName);
                            if (null != nd) nd.InnerText = sSavedInstanceToken;
                        }
                    }
                    catch (Exception ex)
                    {
                        string sErrors = ex.Message.Replace(&quot;&#39;&quot;, &quot;&quot;).Replace(&quot;\n&quot;, &quot;&quot;).Replace(&quot;\r&quot;, &quot;&quot;);
                        if (sErrors.ToLower().Contains(&quot;violation of unique key constraint&quot;))
                            throw new Exception(&quot;This record already exists.&quot;);
                        else
                            throw new Exception(sErrors);
                    }
                }
                else if (!string.IsNullOrEmpty(formEvent.ErrorMessage))
                    throw new Exception(formEvent.ErrorMessage);
                else
                    throw new Exception(&quot;Cannot save the data.&quot;);

                try
                {
                    if (managerModel != null)
                    {
                        // &amp;&amp; managerModel is IFormManagerNonUI) {
                        managerModel.AfterSave(model, new XmlFormArgs());
                    }
                }
                catch (Exception)
                {
                }
                string sTriggerInstance = formParams.ContainsKey(&quot;triggerinstance&quot;)
                    ? formParams[&quot;triggerinstance&quot;].ToString()
                    : sSavedInstanceToken;

                //below is the code to associate new workflow instance in case of new form instance
                string refInfo = &quot;Referenced/Created from: &quot; + sTriggerModule + &quot;, PID: &quot; + sTriggerPid + &quot;, ParentId: &quot; +
                                 sTriggerParentId + &quot;, CUD Instance: &quot; + sSavedInstanceToken;
                List&lt;Guid&gt; _WorkflowsInitiated = null;
                if (IsCreate &amp;&amp; !string.IsNullOrEmpty(sSavedInstanceToken))
                {
                    _WorkflowsInitiated = BrixWorkflowManager.Instance.TriggerWorkflow(TriggerPoint.TriggerActions[0],
                        model.form.Name, sPid, sParentId, &quot;&quot;, sSavedInstanceToken);
                    if (null != _WorkflowsInitiated &amp;&amp; _WorkflowsInitiated.Count &gt; 0)
                    {
                        string userInfo = &quot;Created By: &quot;;
                        userInfo += ud.UserName;
                        int uid = ud.UID;
                        refInfo += userInfo;
                        BrixWorkflowManager.Instance.CreateWorkflowNotes(0, refInfo,
                            IsCreate ? &quot;Created New Form Resource&quot; : &quot;Updated Resource&quot;,
                            uid, null, _WorkflowsInitiated[0].ToString(), DateTime.UtcNow);
                    }
                }
                BrixWorkflowManager.Instance.UpdateReferences(null, IsCreate ? &quot;Created&quot; : &quot;Updated&quot;,
                    sTriggerModule, sTriggerInstance, sTriggerPid, sTriggerParentId, model.form.Name,
                    sSavedInstanceToken, sPid, sParentId,
                    DateTime.UtcNow, &quot;&quot;,
                    null != _WorkflowsInitiated &amp;&amp; _WorkflowsInitiated.Count &gt; 0
                        ? _WorkflowsInitiated[0].ToString()
                        : &quot;&quot;,
                    IsCreate ? &quot;Creates&quot; : &quot;Update&quot;);

                return Request.CreateResponse&lt;XmlElement&gt;(HttpStatusCode.Created, root);
            }
            catch (Exception ex)
            {
                XmlDocument xmlDoc = new XmlDocument();
                xmlDoc.LoadXml(&quot;&lt;Error&gt;&quot; + ex.Message + &quot;&lt;/Error&gt;&quot;);
                return Request.CreateResponse&lt;XmlElement&gt;(HttpStatusCode.BadRequest, xmlDoc.DocumentElement);
            }
        }

        [HttpDelete]
        public HttpResponseMessage DeleteInstance(string moduleId, string ids, [FromBody] string jsonParameters)
        {
            try
            {
                UserDetail ud = CurrentUser.CurrentUserDetail;

                CultureInfo ci = new CultureInfo(AMP3ApplicationSettings.Instance.Culture);
                Thread.CurrentThread.CurrentCulture = ci;
                Thread.CurrentThread.CurrentUICulture = ci;

                model = new BrixFormModel(XMLForms.GetXMLFormModuleID(moduleId), moduleId + &quot;.xml&quot;, XMLType.Form, null,
                    null);
                model.form.GetHostValue += new GetVal(form_GetHostValue);
                model.form.GetHostGridValue += new GetValFromGrid(form_GetHostGridValue);
                model.form.SetHostValue += new SetVal(form_SetHostValue);
                model.form.SetHostGridValue += new SetValInGrid(form_SetHostGridValue);

                JavaScriptSerializer js = new JavaScriptSerializer();
                Dictionary&lt;string, object&gt; jsonParams = string.IsNullOrEmpty(jsonParameters)
                    ? new Dictionary&lt;string, object&gt;()
                    : js.Deserialize&lt;Dictionary&lt;string, object&gt;&gt;(jsonParameters);

                string sPid = jsonParams.ContainsKey(&quot;pid&quot;) ? jsonParams[&quot;pid&quot;].ToString() : &quot;0&quot;;
                string sParentId = jsonParams.ContainsKey(&quot;parentid&quot;) ? jsonParams[&quot;parentid&quot;].ToString() : &quot;0&quot;;
                string sParentMod = jsonParams.ContainsKey(&quot;parentmodule&quot;)
                    ? jsonParams[&quot;parentmodule&quot;].ToString()
                    : model.form.ParentModuleID;

                List&lt;string&gt; permissions =
                    ModuleManager.Instance.GetPermissionByUserOrRole(
                        string.IsNullOrEmpty(model.form.AssociatedModuleID) ? moduleId : model.form.AssociatedModuleID,
                        ud.UID, ud.RID, sPid.ToInt32_2());

                if (permissions == null) throw new Exception(&quot;The user does not have permissions.&quot;);
                if (!permissions.Contains(&quot;Delete&quot;)) throw new Exception(&quot;The user does not have permissions.&quot;);


                Dictionary&lt;string, object&gt; req = new Dictionary&lt;string, object&gt;();
                req.Add(&quot;pid&quot;, sPid);
                req.Add(&quot;parentid&quot;, sParentId);
                req.Add(&quot;parentmodule&quot;, sParentMod);
                req.Add(&quot;iswebapi&quot;, &quot;true&quot;);

                model.form.RequestParameters = req;

                string errors;
                HandleDelete(model, ids, moduleId, sPid, sParentId, out errors);

                XmlDocument xmlDoc = new XmlDocument();
                if (!string.IsNullOrEmpty(errors)) xmlDoc.LoadXml(&quot;&lt;Result&gt;&quot; + errors + &quot;&lt;/Result&gt;&quot;);
                else xmlDoc.LoadXml(&quot;&lt;Result&gt;Delete succeeded with no errors&lt;/Result&gt;&quot;);

                return Request.CreateResponse&lt;XmlDocument&gt;(HttpStatusCode.Accepted, xmlDoc);
            }
            catch (Exception ex)
            {
                XmlDocument xmlDoc = new XmlDocument();
                xmlDoc.LoadXml(&quot;&lt;Error&gt;&quot; + ex.Message + &quot;&lt;/Error&gt;&quot;);
                return Request.CreateResponse&lt;XmlElement&gt;(HttpStatusCode.BadRequest, xmlDoc.DocumentElement);
            }
        }

        public static void HandleDelete(BrixFormModel xmlModel, string selectedIds, string ModuleId, string pid,
            string parentid, out string errors)
        {
            errors = &quot;&quot;;
            selectedIds = ListModel.FilterIdsToDeleteBasedOnWFDefinitions(ModuleId, pid, parentid, selectedIds);

            string toBeDeleted = string.Empty;
            if (null == ConfigurationManager.AppSettings[&quot;DonotDeleteFormsInWorkflow&quot;])
                toBeDeleted = selectedIds;
            else
            {
                string[] allIds = selectedIds.Trim(&#39;,&#39;).Split(&#39;,&#39;);
                DataTable dt = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(selectedIds, ModuleId);
                DataRow[] dRows = dt.Select(&quot;IsCompleted=False&quot;);
                string notToBeDeleted = &quot;,&quot;;
                foreach (DataRow dr in dRows)
                {
                    if (null != dr[&quot;FormInstanceID&quot;]) notToBeDeleted += dr[&quot;FormInstanceID&quot;] + &quot;,&quot;;
                }

                foreach (string id in allIds)
                {
                    if (!notToBeDeleted.Contains(&quot;,&quot; + id + &quot;,&quot;)) toBeDeleted += id + &quot;,&quot;;
                }

                if (!string.IsNullOrEmpty(notToBeDeleted.Trim(&#39;,&#39;)))
                    errors = &quot;Instances running under workflow can not be deleted.&quot;;
            }
            foreach (ControlContainer c in xmlModel.form.Containers)
            {
                DeleteChildTableRows(toBeDeleted, c);
            }

            if (xmlModel.form.AllowAttachments)
            {
                string[] ids = toBeDeleted.Trim(&#39;,&#39;).Split(new[] { &#39;,&#39; });
                foreach (string id in ids)
                    ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                        StoredProcedure.usp_LINKMODDeleteALink, null, id, xmlModel.form.Name, 1);
            }
            int iDeleted =
                CoreDatabaseHelper.GenericLibraryDelete(xmlModel.form.ActualTableNameInDatabase, xmlModel.form.PrimaryKeyName, toBeDeleted.Trim(&#39;,&#39;));
            ListModel.ForceDeleteWorkflowsForThisForm(toBeDeleted, ModuleId);
        }

        public static void DeleteChildTableRows(string toBeDeleted, ControlContainer c)
        {
            if (c.GetType().IsSubclassOf(typeof (DataBaseContainer)))
                DeleteRows(toBeDeleted, c);
            else
                foreach (ControlContainer cc in c.Containers) DeleteChildTableRows(toBeDeleted, cc);
        }

        public static void DeleteRows(string toBeDeleted, ControlContainer c)
        {
            var dc = c as DataBaseContainer;
            List&lt;xControl&gt; fks = dc.GetForeignKeyControls();
            string foriegnKey = string.Empty;

            if (fks != null)
                foreach (xControl xc in fks)
                {
                    if (xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden &amp;&amp; xc.ForeignKey)
                    {
                        foriegnKey = xc.Name;
                        break;
                    }
                }
            if (!string.IsNullOrEmpty(foriegnKey))
                CoreDatabaseHelper.GenericLibraryDelete(dc.TableName, foriegnKey, toBeDeleted.Trim(&#39;,&#39;));
        }

        private void SetValuesFromJson(Dictionary&lt;string, object&gt; instance, BrixFormModel model, ref string err)
        {
            foreach (string element in instance.Keys)
            {
                object obj = instance[element];
                if (obj == null) continue;
                if (obj.GetType().IsGenericType)
                {
                    DynamicGrid dg = (model.form.GetContainer(element) as DynamicGrid);
                    if (null != dg &amp;&amp; dg is DynamicGrid)
                    {
                        XmlElement allrows = (dg.ControlReference[0] as XmlElement);
                        //dg.ControlReference.Count &lt;1 ? new XmlElement() :
                        if (instance[element] is List&lt;object&gt;)
                        {
                            List&lt;object&gt; rowsToBeUpdated1 = instance[element] as List&lt;object&gt;;
                            foreach (object row in rowsToBeUpdated1)
                                UpdateRow(dg, allrows, row);
                        }
                        else
                        {
                            Dictionary&lt;string, object&gt; rowsToBeUpdated2 =
                                instance[element] as Dictionary&lt;string, object&gt;;
                            foreach (string rowKey in rowsToBeUpdated2.Keys)
                            {
                                if (rowsToBeUpdated2[rowKey] is ArrayList)
                                {
                                    ArrayList al = rowsToBeUpdated2[rowKey] as ArrayList;
                                    foreach (object rw in al) UpdateRow(dg, allrows, rw);
                                }
                                else
                                    UpdateRow(dg, allrows, rowsToBeUpdated2[rowKey]);
                            }
                        }
                        XmlNodeList nl = null == allrows ? null : allrows.SelectNodes(&quot;Row&quot;);
                        if (null != nl &amp;&amp; nl.Count &gt; 0)
                        {
                            List&lt;string&gt; primariesToRemove = new List&lt;string&gt;();
                            foreach (XmlNode nd in nl)
                            {
                                XmlNode pr = nd.SelectSingleNode(dg.PrimaryKeyName);
                                if (null == pr) continue;

                                string primaryKeyVal = pr.InnerText;
                                bool bRemove = true;
                                Dictionary&lt;string, object&gt; dRow = null;
                                if (instance[element] is List&lt;object&gt;)
                                {
                                    List&lt;object&gt; rowsToBeUpdated1 = instance[element] as List&lt;object&gt;;
                                    foreach (object row in rowsToBeUpdated1)
                                    {
                                        dRow = row as Dictionary&lt;string, object&gt;;
                                        if (primaryKeyVal.Equals(dRow[dg.PrimaryKeyName] as string,
                                            StringComparison.CurrentCultureIgnoreCase))
                                        {
                                            bRemove = false;
                                            break;
                                        }
                                    }
                                    if (bRemove) primariesToRemove.Add(primaryKeyVal);
                                    break;
                                }
                                else
                                {
                                    Dictionary&lt;string, object&gt; rowsToBeUpdated2 =
                                        instance[element] as Dictionary&lt;string, object&gt;;
                                    foreach (string rowKey in rowsToBeUpdated2.Keys)
                                    {
                                        if (rowsToBeUpdated2[rowKey] is ArrayList)
                                        {
                                            ArrayList al = rowsToBeUpdated2[rowKey] as ArrayList;
                                            foreach (object rw in al)
                                            {
                                                dRow = rw as Dictionary&lt;string, object&gt;;
                                                if (primaryKeyVal.Equals(dRow[dg.PrimaryKeyName] as string,
                                                    StringComparison.CurrentCultureIgnoreCase))
                                                {
                                                    bRemove = false;
                                                    break;
                                                }
                                            }
                                            if (bRemove) primariesToRemove.Add(primaryKeyVal);
                                            break;
                                        }
                                        else
                                        {
                                            dRow = rowsToBeUpdated2[rowKey] as Dictionary&lt;string, object&gt;;
                                            if (primaryKeyVal.Equals(dRow[dg.PrimaryKeyName] as string,
                                                StringComparison.CurrentCultureIgnoreCase))
                                                bRemove = false;
                                            if (bRemove) primariesToRemove.Add(primaryKeyVal);
                                        }
                                    }
                                }
                            }
                            foreach (string toRemove in primariesToRemove)
                            {
                                XmlNode nd =
                                    allrows.SelectSingleNode(&quot;Row[&quot; + dg.PrimaryKeyName + &quot; = &quot; + toRemove + &quot;]&quot;);
                                if (null != nd) allrows.RemoveChild(nd);
                            }
                        }
                    }
                    else
                        SetValuesFromJson(instance[element] as Dictionary&lt;string, object&gt;, model, ref err);
                }
                else
                {
                    SetControlValue(model, element, obj, ref err);
                }
            }
        }

        private static void SetControlValue(BrixFormModel model, string element, object obj, ref string err)
        {
            ControlContainer ct = model.form.GetControl(element);
            XmlElement ele = null == ct || null == ct.ControlReference || ct.ControlReference.Count &lt; 1
                ? null
                : (ct.ControlReference[0] as XmlElement);
            if (null == ele) err += &quot;element &#39;&quot; + element + &quot;&#39; not found&quot;;
            else
            {
                string value = obj.ToString();
                if (value.Equals(&quot;EvaluateField&quot;) &amp;&amp; ct is xControl)
                    value = (ct as xControl).EvaluateControlValue();
                ele.InnerText = value;
            }
        }

        private static void UpdateRow(DynamicGrid dg, XmlElement allrows, object row)
        {
            Dictionary&lt;string, object&gt; rowDic = row as Dictionary&lt;string, object&gt;;
            object pkToBeUpdated = rowDic.ContainsKey(dg.PrimaryKeyName) ? rowDic[dg.PrimaryKeyName] : null;
            bool bCreateNew = false;
            if (null != pkToBeUpdated &amp;&amp; !string.IsNullOrEmpty(pkToBeUpdated.ToString()))
            {
                XmlNode rowToUpdate =
                    allrows.SelectSingleNode(&quot;Row[&quot; + dg.PrimaryKeyName + &quot; = &quot; + pkToBeUpdated.ToString() + &quot;]&quot;);
                if (null == rowToUpdate) bCreateNew = true;
                else
                    foreach (string colKey in rowDic.Keys)
                    {
                        XmlNode cell = rowToUpdate.SelectSingleNode(colKey);
                        if (null != rowDic[colKey]) cell.InnerText = rowDic[colKey].ToString();
                    }
            }
            else bCreateNew = true;
            if (bCreateNew)
            {
                XmlElement rowToUpdate = allrows.OwnerDocument.CreateElement(&quot;Row&quot;);
                foreach (string colKey in rowDic.Keys)
                {
                    XmlNode cell = allrows.OwnerDocument.CreateElement(colKey);
                    if (null != rowDic[colKey]) cell.InnerText = rowDic[colKey].ToString();
                    rowToUpdate.AppendChild(cell);
                }
                allrows.AppendChild(rowToUpdate);
            }
        }

        public static DataSet GetDataSet(ListModel lm, ref int pageno, string SortKey,
            Dictionary&lt;string, object&gt; FilterCriterion, int PageSize, bool sortAsc, out ArrayList columns,
            out int pagecount)
        {
            if (!String.IsNullOrEmpty(SortKey) &amp;&amp;
                (SortKey.Contains(&quot;WF_Status&quot;) || SortKey.Contains(&quot;WF_PendingOnRole&quot;)))
            {
                SortKey = &quot;&quot;;
            }

            string filter = GetFilterString(lm, FilterCriterion);

            string sortOrder = string.IsNullOrEmpty(SortKey)
                ? &quot;&quot;
                : ((SortKey.Contains(&quot;[&quot;) ? SortKey : (&quot; [&quot; + SortKey + &quot;]&quot;)) + (sortAsc ? &quot; ASC &quot; : &quot; DESC &quot;));
            DataSet dtSet = lm.GetList(PageSize, sortOrder, filter, ref pageno, out pagecount);
            if (dtSet == null)
                dtSet = (DataSet)lm.GetList(PageSize, sortOrder, filter, ref pageno, out pagecount, true);

            columns = null;
            if (dtSet != null &amp;&amp; dtSet.Tables.Count &gt; 0)
            {
                ArrayList dataBaseColumns = new ArrayList();
                foreach (DataColumn dc in dtSet.Tables[0].Columns)
                    dataBaseColumns.Add(dc.ColumnName);
                columns = dataBaseColumns;
            }
            return dtSet;
        }

        public static string GetFilterString(ListModel lm, Dictionary&lt;string, object&gt; dFilter)
        {
            StringBuilder filter = new StringBuilder();
            Dictionary&lt;string, object&gt; andFilters = dFilter.ContainsKey(&quot;andfilters&quot;)
                ? dFilter[&quot;andfilters&quot;] as Dictionary&lt;string, object&gt;
                : new Dictionary&lt;string, object&gt;();
            Dictionary&lt;string, object&gt; orFilters = dFilter.ContainsKey(&quot;orfilters&quot;)
                ? dFilter[&quot;orfilters&quot;] as Dictionary&lt;string, object&gt;
                : new Dictionary&lt;string, object&gt;();
            filter.Append(&quot;&lt;XMLRoot&gt;&quot;);
            foreach (string flStr in andFilters.Keys)
            {
                BrixFilter f1 = new BrixFilter();
                f1.Name = flStr;
                lm.CreateFilterXml(filter, f1, andFilters[flStr] as string, &quot;txt&quot;);
            }

            filter.Append(&quot;&lt;/XMLRoot&gt;&quot;);

            return filter.ToString();
        }

        public static bool AllowSave(string formName, string instancid, string pid, string parentid, bool bIsCreate)
        {
            if (string.IsNullOrEmpty(formName)) return false;

            if (string.IsNullOrEmpty(instancid) || instancid == &quot;-1&quot; || bIsCreate)
            {
                //For New Case we need to show the save button only if user has create permission
                bool bHasPerm = false;
                try
                {
                    ///we need a better solution here - the form value will return 
                    ///xcontext while permissions are defined on legacy context
                    //List&lt;string&gt; perms = ModuleManager.Instance.GetPermissionByRole(form, UserDetail.GetCurrentUserDetail().RID);
                    //if (null != perms &amp;&amp; perms.Contains(&quot;Create&quot;)) bHasPerm = true;
                    bHasPerm = true;
                }
                catch
                {
                }
                return bHasPerm;
            }

            bool bIsWorkflowAssociatedatFormLevel = BrixWorkflowManager.Instance.IsWorkflowAssociated(formName, pid,
                parentid);
            if (!bIsWorkflowAssociatedatFormLevel)
            {
                //If workflow is not attach then we need to show the save button
                return true;
            }

            //UserDetail.GetCurrentUserDetail().RoleName
            DataTable dt = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(instancid, formName);
            List&lt;string&gt; stakeHolders = new List&lt;string&gt;();
            if (dt.Rows.Count &gt; 0)
                for (int i = 0; i &lt; dt.Rows.Count; i++)
                {
                    bool bIsComplete = DBNull.Value == dt.Rows[i][&quot;IsCompleted&quot;]
                        ? false
                        : dt.Rows[i][&quot;IsCompleted&quot;].ToString() == &quot;True&quot;;
                    if (bIsComplete) continue;
                    string[] roles = DBNull.Value == dt.Rows[i][&quot;CurrentRole&quot;]
                        ? null
                        : dt.Rows[i][&quot;CurrentRole&quot;].ToString().Split(&#39;,&#39;);
                    if (null == roles) continue;
                    stakeHolders.AddRange(roles);
                }
            Dictionary&lt;string, bool?&gt; dicHasRoleToPlay = new Dictionary&lt;string, bool?&gt;();
            bool _CanAddSaveButton = false;

            foreach (string stakeHolderRole in stakeHolders)
            {
                if (string.IsNullOrEmpty(stakeHolderRole)) continue;
                if (dicHasRoleToPlay.ContainsKey(stakeHolderRole.ToLower()))
                {
                    if (dicHasRoleToPlay[stakeHolderRole.ToLower()] == true)
                        _CanAddSaveButton = true;
                    continue;
                }

                bool bHasRoleToPlay = UserManager.Instance.IsUserRole(CurrentUser.CurrentUserDetail.UID,
                    UserManager.Instance.GetUsersRoleId(stakeHolderRole));
                dicHasRoleToPlay.Add(stakeHolderRole.ToLower(), bHasRoleToPlay);
                if (bHasRoleToPlay) _CanAddSaveButton = true;
            }
            return _CanAddSaveButton;
        }

        /// &lt;summary&gt;
        /// API method to fetch details by module and instanceid
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;moduleId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;Id&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string GetInstanceDetails(string moduleId, string Id)
        {
            try
            {
                UserDetail ud = CurrentUser.CurrentUserDetail;
                JavaScriptSerializer js = new JavaScriptSerializer();

                CultureInfo ci = new CultureInfo(AMP3ApplicationSettings.Instance.Culture);
                Thread.CurrentThread.CurrentCulture = ci;
                Thread.CurrentThread.CurrentUICulture = ci;

                XmlDocument root;
                model = new BrixFormModel(XMLForms.GetXMLFormModuleID(moduleId), moduleId + &quot;.xml&quot;, XMLType.Form, null,
                    null);
                //model.form.RequestParameters = requestParams;
                model.form.GetHostValue += new GetVal(form_GetHostValue);
                model.form.GetHostGridValue += new GetValFromGrid(form_GetHostGridValue);
                model.form.SetHostValue += new SetVal(form_SetHostValue);
                model.form.SetHostGridValue += new SetValInGrid(form_SetHostGridValue);

                List&lt;string&gt; permissions =
                    ModuleManager.Instance.GetPermissionByUserOrRole(
                        string.IsNullOrEmpty(model.form.AssociatedModuleID) ? moduleId : model.form.AssociatedModuleID,
                        ud.UID, ud.RID,
                        (model.form.RequestParameters.ContainsKey(&quot;PID&quot;)
                            ? model.form.RequestParameters[&quot;PID&quot;].ToInt32_2()
                            : 0));

                if (permissions == null) throw new Exception(&quot;The user does not have permissions.&quot;);
                if (!permissions.Contains(&quot;View&quot;)) throw new Exception(&quot;The user does not have permissions.&quot;);

                var engine = new XMLRenderingEngine(null, model, null);
                model.form.instanceID = Id;
                engine.Render(RenderFormat.RenderXml);
                root = (model.form.Renderer as XmlRenderer).MasterDoc;
                return root.InnerXml;
            }
            catch (Exception ex)
            {
                XmlDocument xmlDoc = new XmlDocument();
                xmlDoc.LoadXml(&quot;&lt;Error&gt;&quot; + ex.Message + &quot;&lt;/Error&gt;&quot;);
                return xmlDoc.InnerXml;
            }
        }

        /// &lt;summary&gt;
        /// API method to create new form with info from existing form.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;moduleId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;xdoc&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Boolean CreateFormInstance(string moduleId, Dictionary&lt;string, object&gt; dicFields)
        {
            try
            {
                UserDetail ud = CurrentUser.CurrentUserDetail;
                CultureInfo ci = new CultureInfo(AMP3ApplicationSettings.Instance.Culture);
                Thread.CurrentThread.CurrentCulture = ci;
                Thread.CurrentThread.CurrentUICulture = ci;

                model = new BrixFormModel(XMLForms.GetXMLFormModuleID(moduleId), moduleId + &quot;.xml&quot;, XMLType.Form, null,
                    null);
                model.form.GetHostValue += new GetVal(form_GetHostValue);
                model.form.GetHostGridValue += new GetValFromGrid(form_GetHostGridValue);
                model.form.SetHostValue += new SetVal(form_SetHostValue);
                model.form.SetHostGridValue += new SetValInGrid(form_SetHostGridValue);


                if (dicFields.Count &gt; 0)
                {
                    bool IsCreate = true;
                    string id = &quot;0&quot;;

                    string sPid = dicFields.ContainsKey(&quot;pid&quot;) ? dicFields[&quot;pid&quot;].ToString() : &quot;0&quot;;
                    //string sParentId = dicFields.ContainsKey(&quot;associatedforminstance&quot;) ? dicFields[&quot;associatedforminstance&quot;].ToString() : &quot;0&quot;;//formParams.ContainsKey(&quot;parentid&quot;) ? formParams[&quot;parentid&quot;].ToString() : (jsonParams.ContainsKey(&quot;parentid&quot;) ? jsonParams[&quot;parentid&quot;].ToString() : &quot;0&quot;);
                    //parentid is contractid not the parent record id. 
                    //TODO: Need to see if it causes any problem.
                    string sParentId = dicFields.ContainsKey(&quot;parentid&quot;) ? dicFields[&quot;parentid&quot;].ToString() : &quot;0&quot;;
                    string sParentMod = dicFields.ContainsKey(&quot;parentmodule&quot;)
                        ? dicFields[&quot;parentmodule&quot;].ToString()
                        : model.form.ParentModuleID;
                    //formParams.ContainsKey(&quot;parentmodule&quot;) ? formParams[&quot;parentmodule&quot;].ToString() : model.form.ParentModuleID;
                    string sTriggerPid = dicFields.ContainsKey(&quot;triggerpid&quot;) ? dicFields[&quot;triggerpid&quot;].ToString() : sPid;
                    //jsonParams.ContainsKey(&quot;triggerpid&quot;) ? formParams[&quot;triggerpid&quot;].ToString() : sPid;
                    string sTriggerParentId = sParentId;
                    // dicFields.ContainsKey(&quot;associatedforminstance&quot;) ? dicFields[&quot;associatedforminstance&quot;].ToString() : sParentId;// jsonParams.ContainsKey(&quot;triggerparent&quot;) ? formParams[&quot;triggerparent&quot;].ToString() : sParentId;
                    string sTriggerParentModule = sParentMod;
                    //dicFields.ContainsKey(&quot;triggerparentmodule&quot;) ? dicFields[&quot;triggerparentmodule&quot;].ToString() : sParentMod;// jsonParams.ContainsKey(&quot;triggerparentmodule&quot;) ? formParams[&quot;triggerparentmodule&quot;].ToString() : sParentMod;
                    string sTriggerModule = model.form.ModuleID;
                    //dicFields.ContainsKey(&quot;triggermodule&quot;) ? dicFields[&quot;triggermodule&quot;].ToString() : model.form.ModuleID; //jsonParams.ContainsKey(&quot;triggermodule&quot;) ? formParams[&quot;triggermodule&quot;].ToString() : model.form.ModuleID;

                    List&lt;string&gt; permissions =
                        ModuleManager.Instance.GetPermissionByUserOrRole(
                            string.IsNullOrEmpty(model.form.AssociatedModuleID)
                                ? moduleId
                                : model.form.AssociatedModuleID,
                            ud.UID, ud.RID, sPid.ToInt32_2());
                    if (permissions == null) throw new Exception(&quot;The user does not have permissions.&quot;);
                    if (IsCreate &amp;&amp; !permissions.Contains(&quot;Create&quot;))
                        throw new Exception(&quot;The user does not have permissions.&quot;);

                    LinkedInstanceDetails linkedInstanceDetails = new LinkedInstanceDetails();
                    BrixFormModel parentModel = null;

                    string parentFormHeader = string.Empty;
                    string parentFormModuleID = dicFields.ContainsKey(&quot;associatedform&quot;)
                        ? dicFields[&quot;associatedform&quot;].ToString()
                        : null;
                    if (!string.IsNullOrEmpty(parentFormModuleID))
                    {
                        parentModel = new BrixFormModel(XMLForms.GetXMLFormModuleID(parentFormModuleID),
                            parentFormModuleID + &quot;.xml&quot;, XMLType.Form, null, null);
                        if (parentModel != null)
                        {
                            parentFormHeader = parentModel.form.Header;

                            parentModel.form.instanceID = dicFields.ContainsKey(&quot;associatedforminstance&quot;)
                                ? dicFields[&quot;associatedforminstance&quot;].ToString()
                                : null;
                            ;
                            XMLRenderingEngine parentModelEngine = new XMLRenderingEngine(null, parentModel, null);
                            parentModelEngine.Render(RenderFormat.RenderXml);
                            parentModel.form.Renderer.DataSource =
                                ((parentModel.form.Renderer as XmlRenderer).MasterDoc.OuterXml);

                            linkedInstanceDetails.SourceModuleID = parentModel.form.ModuleID;
                            linkedInstanceDetails.SourceInstanceId = parentModel.form.instanceID;
                            linkedInstanceDetails.SourceData = parentModel.form.GetReferenceModuleColumnValues();
                            linkedInstanceDetails.InstanceType = LinkedInstanceType.Chained;
                            linkedInstanceDetails.SourceUrl = &quot;BrixForm.aspx?Context=&quot; + parentModel.form.ModuleID +
                                                              &quot;&amp;PID=&quot; + parentModel.form.FromRequest(&quot;PID&quot;)
                                                              + &quot;&amp;ParentID=&quot; + parentModel.form.FromRequest(&quot;ParentID&quot;) +
                                                              &quot;&amp;Mode=View&amp;InstanceID=&quot; + parentModel.form.instanceID;
                        }
                    }

                    Dictionary&lt;string, object&gt; req = new Dictionary&lt;string, object&gt;();
                    req.Add(&quot;pid&quot;, sPid);
                    req.Add(&quot;parentid&quot;, sParentId);
                    req.Add(&quot;parentmodule&quot;, sParentMod);
                    req.Add(&quot;iswebapi&quot;, &quot;true&quot;);
                    model.form.RequestParameters = req;

                    //see if the user is a stakeholder of the stage
                    if (!IsCreate)
                    {
                        bool bCanSave = AllowSave(moduleId, id, sPid, sParentId, IsCreate);
                        if (!bCanSave)
                            throw new Exception(
                                &quot;The logged on user is not authorised to update this record at this stage.&quot;);
                    }

                    XmlElement root;
                    var engine = new XMLRenderingEngine(null, model, null);
                    if (!IsCreate) model.form.instanceID = id;
                    engine.Render(RenderFormat.RenderXml);
                    root = (model.form.Renderer as XmlRenderer).MasterDoc.DocumentElement;
                    string err = &quot;&quot;;

                    model.form.SessionParameters.Add(&quot;UserDetail&quot;, ud);
                    SetValuesFromJson(dicFields, model, ref err);
                    model.form.Renderer.DataSource = root.OuterXml;

                    XMLFormManagerModel managerModel =
                        AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(model.form.ManagerDLL,
                            model.form.FormManagerClass);
                    var formEvent = new XmlFormArgs();
                    string sSavedInstanceToken = &quot;&quot;;
                    if (managerModel != null)
                    {
                        managerModel.BeforeSave(model, formEvent);
                    }
                    if (managerModel == null || (managerModel != null &amp;&amp; formEvent.IsValid))
                    {
                        try
                        {
                            engine.SaveData(((model.form.Renderer as XmlRenderer).MasterDoc.OuterXml),
                                RenderFormat.RenderXml);
                            sSavedInstanceToken = model.form.instanceID;
                            if (IsCreate)
                            {
                                XmlNode nd = root.SelectSingleNode(&quot;/&quot; + moduleId + &quot;/&quot; + model.form.PrimaryKeyName);
                                if (null != nd) nd.InnerText = sSavedInstanceToken;
                            }
                        }
                        catch (Exception ex)
                        {
                            string sErrors = ex.Message.Replace(&quot;&#39;&quot;, &quot;&quot;).Replace(&quot;\n&quot;, &quot;&quot;).Replace(&quot;\r&quot;, &quot;&quot;);
                            if (sErrors.ToLower().Contains(&quot;violation of unique key constraint&quot;))
                                throw new Exception(&quot;This record already exists.&quot;);
                            else
                                throw new Exception(sErrors);
                        }
                    }
                    else if (!string.IsNullOrEmpty(formEvent.ErrorMessage))
                        throw new Exception(formEvent.ErrorMessage);
                    else
                        throw new Exception(&quot;Cannot save the data.&quot;);

                    if (parentModel != null)
                    {
                        LinkedInstance chainedInstance = new LinkedInstance()
                        {
                            CustomMessage = &quot;Created from &quot; + parentFormHeader,
                            DestinationModuleID = model.form.ModuleID,
                            DestinationInstanceIds = new List&lt;string&gt;() { model.form.instanceID }
                        };
                        linkedInstanceDetails.LinkedDestinationInstances = new List&lt;LinkedInstance&gt;();
                        linkedInstanceDetails.LinkedDestinationInstances.Add(chainedInstance);
                        ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                            StoredProcedure.usp_CORESaveLinkedInstances, null, linkedInstanceDetails.SerializeDTO());
                    }

                    try
                    {
                        if (managerModel != null)
                        {
                            managerModel.AfterSave(model, new XmlFormArgs());
                        }
                    }
                    catch (Exception)
                    {
                    }
                    string sTriggerInstance = dicFields.ContainsKey(&quot;triggerinstance&quot;)
                        ? dicFields[&quot;triggerinstance&quot;].ToString()
                        : sSavedInstanceToken;

                    //below is the code to associate new workflow instance in case of new form instance

                    string refInfo = &quot;Created from &quot; + parentFormHeader + &quot; record.&quot;;
                    string sParentInfo = model.form.ParseDynamicString(model.form.Header) + &quot; record was created.&quot;;
                    //string refInfo = &quot;Created from Title: &quot; + dicFields[&quot;Title&quot;].ToString() + &quot;, Module:&quot; + sParentMod + &quot;, PID: &quot; + sTriggerPid + &quot;, ParentId: &quot; + sTriggerParentId + &quot;. &quot;;
                    //string sParentInfo = &quot;Created Instance of Module: &quot; + sTriggerModule + &quot;, Instance ID: &quot; + sSavedInstanceToken + &quot;, PID: &quot; + sTriggerPid + &quot;, ParentId: &quot; + sTriggerParentId + &quot;. &quot;;
                    List&lt;Guid&gt; _WorkflowsInitiated = null;
                    if (IsCreate &amp;&amp; !string.IsNullOrEmpty(sSavedInstanceToken))
                    {
                        _WorkflowsInitiated =
                            BrixWorkflowManager.Instance.TriggerWorkflow(TriggerPoint.TriggerActions[0], model.form.Name,
                                sPid, sParentId, &quot;&quot;, sSavedInstanceToken);
                        string userInfo = &quot;Created By: &quot;;
                        userInfo += ud.UserName;
                        int uid = ud.UID;
                        refInfo += userInfo;
                        sParentInfo += userInfo;
                        var waitForWFToStart = new AutoResetEvent(false);
                        waitForWFToStart.WaitOne(500);
                        if (null != _WorkflowsInitiated &amp;&amp; _WorkflowsInitiated.Count &gt; 0)
                        {
                            BrixWorkflowManager.Instance.CreateWorkflowNotes(0, refInfo, &quot;Created New Form&quot;,
                                uid, null, _WorkflowsInitiated[0].ToString(), DateTime.UtcNow);
                        }
                        else
                        {
                            BrixWorkflowManager.Instance.CreateFormNotes(Convert.ToInt32(sSavedInstanceToken), refInfo,
                                uid, sTriggerModule);
                        }

                        BrixWorkflowManager.Instance.CreateWorkflowNotes(0, sParentInfo, &quot;Created New Linked Form&quot;,
                            uid, null, dicFields[&quot;workflowinstanceid&quot;].ToString(), DateTime.UtcNow);

                        BrixWorkflowManager.Instance.CreateFormChainingMapping(sParentMod,
                            Convert.ToInt32(sTriggerParentId), sTriggerModule, Convert.ToInt32(sSavedInstanceToken));
                    }
                    BrixWorkflowManager.Instance.UpdateReferences(null, IsCreate ? &quot;Created&quot; : &quot;Updated&quot;,
                        sTriggerModule, sTriggerInstance, sTriggerPid, sTriggerParentId, model.form.Name,
                        sSavedInstanceToken, sPid, sParentId,
                        DateTime.UtcNow, &quot;&quot;,
                        null != _WorkflowsInitiated &amp;&amp; _WorkflowsInitiated.Count &gt; 0
                            ? _WorkflowsInitiated[0].ToString()
                            : &quot;&quot;,
                        IsCreate ? &quot;Create&quot; : &quot;Update&quot;);
                }
            }
            catch (Exception)
            {
                throw;
            }
            return true;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[35,9,35,10,0],[36,13,36,59,0],[38,13,38,66,0],[39,13,41,78,0],[43,13,43,88,0],[44,13,44,54,0],[45,13,45,56,0],[47,13,47,123,0],[49,13,51,52,0],[52,13,54,52,0],[56,13,56,78,0],[56,79,56,117,0],[57,13,57,88,0],[58,17,58,65,0],[59,13,59,54,0],[59,55,59,110,0],[61,13,64,100,0],[66,13,66,37,0],[66,38,66,97,0],[67,13,67,47,0],[67,48,67,107,0],[70,13,70,31,0],[71,13,71,80,0],[72,17,72,78,0],[74,13,74,31,0],[75,13,75,82,0],[76,17,76,80,0],[78,13,78,44,0],[79,13,79,86,0],[80,17,80,92,0],[82,13,82,37,0],[83,13,83,84,0],[84,17,84,84,0],[86,13,86,31,0],[87,13,87,95,0],[88,13,88,46,0],[89,13,89,35,0],[90,13,90,35,0],[91,13,91,14,0],[92,17,92,81,0],[93,17,93,37,0],[94,13,94,14,0],[95,13,96,32,0],[97,13,97,37,0],[98,13,98,14,0],[99,17,99,91,0],[100,17,100,45,0],[101,17,101,46,0],[102,17,102,46,0],[103,17,103,121,0],[104,17,104,39,0],[105,17,105,18,0],[106,21,106,36,0],[107,21,107,22,0],[108,25,108,103,0],[109,25,109,32,0],[109,34,109,44,0],[109,45,109,47,0],[109,48,109,55,0],[110,25,110,26,0],[111,29,111,96,0],[112,29,112,36,0],[112,38,112,52,0],[112,53,112,55,0],[112,56,112,66,0],[113,33,113,78,0],[114,29,114,43,0],[115,25,115,26,0],[116,25,116,113,0],[119,25,119,89,0],[121,13,121,14,0],[122,13,122,76,0],[123,9,123,10,0],[127,9,127,10,0],[129,13,129,14,0],[130,17,130,63,0],[132,17,132,70,0],[133,17,135,82,0],[137,17,137,92,0],[138,17,138,58,0],[139,17,139,60,0],[142,17,143,27,0],[145,17,145,74,0],[146,17,146,90,0],[147,17,147,74,0],[148,17,148,88,0],[150,17,153,104,0],[155,17,155,41,0],[155,42,155,101,0],[156,17,156,51,0],[156,52,156,111,0],[158,17,158,72,0],[159,17,159,44,0],[160,17,160,55,0],[161,17,161,71,0],[163,17,163,109,0],[164,17,164,29,0],[166,13,166,33,0],[167,13,167,14,0],[168,17,168,56,0],[169,17,169,69,0],[170,17,170,110,0],[172,9,172,10,0],[176,9,176,10,0],[177,13,177,29,0],[178,13,178,27,0],[179,13,179,31,0],[180,13,180,60,0],[181,13,181,63,0],[181,64,181,94,0],[183,13,183,14,0],[184,17,184,74,0],[185,17,185,67,0],[185,68,185,98,0],[186,13,186,14,0],[187,13,187,24,0],[188,9,188,10,0],[192,9,192,10,0],[193,13,193,29,0],[194,13,194,27,0],[195,13,195,31,0],[196,13,196,48,0],[196,49,196,61,0],[197,13,197,70,0],[198,13,198,33,0],[199,13,199,63,0],[199,64,199,106,0],[200,13,200,53,0],[200,54,200,65,0],[202,13,202,49,0],[204,13,206,84,0],[207,13,207,44,0],[207,45,207,56,0],[209,13,209,60,0],[210,13,210,28,0],[210,29,210,40,0],[212,13,212,31,0],[213,13,213,24,0],[214,9,214,10,0],[217,9,217,10,0],[218,13,218,27,0],[219,13,219,33,0],[220,13,220,31,0],[221,13,221,62,0],[222,13,222,50,0],[223,13,223,27,0],[224,9,224,10,0],[228,9,228,10,0],[229,13,229,27,0],[230,13,230,33,0],[231,13,231,81,0],[232,13,232,116,0],[233,13,233,14,0],[234,17,235,109,0],[236,17,236,30,0],[238,13,238,73,0],[239,13,239,33,0],[240,13,240,14,0],[241,17,242,109,0],[243,17,243,30,0],[245,13,245,48,0],[246,13,246,14,0],[247,17,249,42,0],[250,17,250,30,0],[252,13,252,41,0],[253,13,253,33,0],[254,13,254,14,0],[255,17,255,61,0],[256,17,256,87,0],[257,13,257,14,0],[259,13,259,14,0],[260,17,260,43,0],[261,17,261,108,0],[262,17,262,82,0],[263,13,263,14,0],[264,13,264,66,0],[265,13,265,30,0],[266,17,268,42,0],[270,17,270,68,0],[271,13,271,27,0],[272,9,272,10,0],[276,9,276,10,0],[278,13,278,14,0],[279,17,279,63,0],[281,17,281,92,0],[282,17,282,58,0],[283,17,283,60,0],[285,17,286,27,0],[287,17,287,74,0],[288,17,288,90,0],[289,17,289,74,0],[290,17,290,88,0],[293,17,293,70,0],[294,17,296,82,0],[297,17,297,62,0],[298,17,298,42,0],[299,21,299,85,0],[300,17,302,28,0],[303,17,303,58,0],[305,17,307,92,0],[308,17,310,102,0],[311,17,313,49,0],[314,17,314,120,0],[315,17,317,33,0],[318,17,320,34,0],[321,17,323,43,0],[325,17,328,59,0],[329,17,329,41,0],[329,42,329,101,0],[330,17,330,65,0],[331,21,331,80,0],[332,17,332,64,0],[333,21,333,80,0],[336,17,336,83,0],[337,17,337,38,0],[338,17,338,48,0],[339,17,339,53,0],[340,17,340,45,0],[341,17,341,52,0],[344,17,344,31,0],[345,17,345,18,0],[346,21,346,88,0],[347,21,347,35,0],[348,25,348,122,0],[349,17,349,18,0],[352,17,352,72,0],[353,17,353,31,0],[353,32,353,59,0],[354,17,354,55,0],[355,17,355,87,0],[356,17,356,33,0],[357,17,357,63,0],[358,17,358,64,0],[360,17,362,54,0],[363,17,363,51,0],[364,17,364,49,0],[365,17,365,42,0],[366,17,366,18,0],[368,21,368,63,0],[369,17,369,18,0],[370,17,370,89,0],[371,17,371,18,0],[373,21,373,22,0],[374,25,375,53,0],[376,25,376,69,0],[377,25,377,38,0],[378,25,378,26,0],[379,29,379,114,0],[380,29,380,44,0],[380,45,380,80,0],[381,25,381,26,0],[382,21,382,22,0],[383,21,383,41,0],[384,21,384,22,0],[385,25,385,106,0],[386,25,386,94,0],[387,29,387,80,0],[389,29,389,58,0],[391,17,391,18,0],[392,22,392,72,0],[393,21,393,65,0],[395,21,395,66,0],[398,17,398,18,0],[399,21,399,46,0],[400,21,400,22,0],[402,25,402,74,0],[403,21,403,22,0],[404,17,404,18,0],[405,17,405,34,0],[406,17,406,18,0],[407,17,407,18,0],[408,17,410,43,0],[413,17,414,94,0],[415,17,415,55,0],[416,17,416,76,0],[417,17,417,18,0],[418,21,419,84,0],[420,21,420,86,0],[421,21,421,22,0],[422,25,422,58,0],[423,25,423,49,0],[424,25,424,42,0],[425,25,425,45,0],[426,25,428,92,0],[429,21,429,22,0],[430,17,430,18,0],[431,17,438,54,0],[440,17,440,89,0],[442,13,442,33,0],[443,13,443,14,0],[444,17,444,56,0],[445,17,445,69,0],[446,17,446,110,0],[448,9,448,10,0],[452,9,452,10,0],[454,13,454,14,0],[455,17,455,63,0],[457,17,457,92,0],[458,17,458,58,0],[459,17,459,60,0],[461,17,462,27,0],[463,17,463,74,0],[464,17,464,90,0],[465,17,465,74,0],[466,17,466,88,0],[468,17,468,70,0],[469,17,471,82,0],[473,17,473,98,0],[474,17,474,113,0],[475,17,477,49,0],[479,17,482,59,0],[484,17,484,41,0],[484,42,484,101,0],[485,17,485,53,0],[485,54,485,113,0],[488,17,488,83,0],[489,17,489,38,0],[490,17,490,48,0],[491,17,491,53,0],[492,17,492,45,0],[494,17,494,52,0],[497,17,497,81,0],[499,17,499,56,0],[500,17,500,51,0],[500,52,500,102,0],[501,22,501,89,0],[503,17,503,93,0],[505,13,505,33,0],[506,13,506,14,0],[507,17,507,56,0],[508,17,508,69,0],[509,17,509,110,0],[511,9,511,10,0],[515,9,515,10,0],[516,13,516,25,0],[517,13,517,113,0],[519,13,519,47,0],[520,13,520,88,0],[521,17,521,43,0],[523,13,523,14,0],[524,17,524,68,0],[525,17,525,110,0],[526,17,526,66,0],[527,17,527,45,0],[528,17,528,24,0],[528,26,528,36,0],[528,37,528,39,0],[528,40,528,45,0],[529,17,529,18,0],[530,21,530,54,0],[530,55,530,100,0],[531,17,531,18,0],[533,17,533,24,0],[533,26,533,35,0],[533,36,533,38,0],[533,39,533,45,0],[534,17,534,18,0],[535,21,535,66,0],[535,67,535,91,0],[536,17,536,18,0],[538,17,538,69,0],[539,21,539,85,0],[540,13,540,14,0],[541,13,541,20,0],[541,22,541,40,0],[541,41,541,43,0],[541,44,541,68,0],[542,13,542,14,0],[543,17,543,54,0],[544,13,544,14,0],[546,13,546,48,0],[547,13,547,14,0],[548,17,548,75,0],[549,17,549,24,0],[549,26,549,35,0],[549,36,549,38,0],[549,39,549,42,0],[550,21,551,98,0],[552,13,552,14,0],[553,13,554,151,0],[555,13,555,78,0],[556,9,556,10,0],[559,9,559,10,0],[560,13,560,70,0],[561,17,561,44,0],[563,17,563,24,0],[563,26,563,45,0],[563,46,563,48,0],[563,49,563,61,0],[563,63,563,101,0],[564,9,564,10,0],[567,9,567,10,0],[568,13,568,45,0],[569,13,569,61,0],[570,13,570,46,0],[572,13,572,29,0],[573,17,573,24,0],[573,26,573,37,0],[573,38,573,40,0],[573,41,573,44,0],[574,17,574,18,0],[575,21,575,108,0],[576,21,576,22,0],[577,25,577,46,0],[578,25,578,31,0],[580,17,580,18,0],[581,13,581,51,0],[582,17,582,106,0],[583,9,583,10,0],[586,9,586,10,0],[587,13,587,20,0],[587,22,587,36,0],[587,37,587,39,0],[587,40,587,53,0],[588,13,588,14,0],[589,17,589,48,0],[590,17,590,33,0],[590,34,590,43,0],[591,17,591,49,0],[592,17,592,18,0],[593,21,593,88,0],[594,21,594,57,0],[595,21,595,22,0],[596,25,596,85,0],[598,25,598,63,0],[599,25,599,26,0],[600,29,600,95,0],[601,29,601,36,0],[601,38,601,48,0],[601,49,601,51,0],[601,52,601,68,0],[602,33,602,61,0],[603,25,603,26,0],[605,25,605,26,0],[606,29,607,81,0],[608,29,608,36,0],[608,38,608,51,0],[608,52,608,54,0],[608,55,608,76,0],[609,29,609,30,0],[610,33,610,75,0],[611,33,611,34,0],[612,37,612,90,0],[613,37,613,44,0],[613,46,613,55,0],[613,56,613,58,0],[613,59,613,61,0],[613,63,613,90,0],[614,33,614,34,0],[616,37,616,86,0],[617,29,617,30,0],[618,25,618,26,0],[619,25,619,94,0],[620,25,620,56,0],[621,25,621,26,0],[622,29,622,81,0],[623,29,623,36,0],[623,38,623,48,0],[623,49,623,51,0],[623,52,623,54,0],[624,29,624,30,0],[625,33,625,85,0],[626,33,626,48,0],[626,49,626,58,0],[628,33,628,69,0],[629,33,629,53,0],[630,33,630,72,0],[631,33,631,71,0],[632,33,632,34,0],[633,37,633,103,0],[634,37,634,44,0],[634,46,634,56,0],[634,57,634,59,0],[634,60,634,76,0],[635,37,635,38,0],[636,41,636,82,0],[637,41,638,88,0],[639,41,639,42,0],[640,45,640,61,0],[641,45,641,51,0],[643,37,643,38,0],[644,37,644,49,0],[644,50,644,87,0],[645,37,645,43,0],[648,33,648,34,0],[649,37,650,89,0],[651,37,651,44,0],[651,46,651,59,0],[651,60,651,62,0],[651,63,651,84,0],[652,37,652,38,0],[653,41,653,83,0],[654,41,654,42,0],[655,45,655,98,0],[656,45,656,52,0],[656,54,656,63,0],[656,64,656,66,0],[656,67,656,69,0],[657,45,657,46,0],[658,49,658,89,0],[659,49,660,96,0],[661,49,661,50,0],[662,53,662,69,0],[663,53,663,59,0],[665,45,665,46,0],[666,45,666,57,0],[666,58,666,95,0],[667,45,667,51,0],[670,41,670,42,0],[671,45,671,107,0],[672,45,673,92,0],[674,49,674,65,0],[675,45,675,57,0],[675,58,675,95,0],[676,41,676,42,0],[677,37,677,38,0],[678,33,678,34,0],[679,29,679,30,0],[680,29,680,36,0],[680,38,680,53,0],[680,54,680,56,0],[680,57,680,74,0],[681,29,681,30,0],[682,33,683,115,0],[684,33,684,48,0],[684,49,684,73,0],[685,29,685,30,0],[686,25,686,26,0],[687,21,687,22,0],[689,25,689,108,0],[690,17,690,18,0],[692,17,692,18,0],[693,21,693,67,0],[694,17,694,18,0],[695,13,695,14,0],[696,9,696,10,0],[699,9,699,10,0],[700,13,700,66,0],[701,13,703,58,0],[704,13,704,29,0],[704,30,704,75,0],[706,13,706,14,0],[707,17,707,47,0],[708,17,708,69,0],[709,21,709,69,0],[710,17,710,39,0],[711,13,711,14,0],[712,9,712,10,0],[715,9,715,10,0],[716,13,716,83,0],[717,13,717,109,0],[718,13,718,37,0],[719,13,719,90,0],[720,13,720,14,0],[721,17,722,115,0],[723,17,723,41,0],[723,42,723,60,0],[725,21,725,28,0],[725,30,725,43,0],[725,44,725,46,0],[725,47,725,58,0],[726,21,726,22,0],[727,25,727,77,0],[728,25,728,52,0],[728,53,728,96,0],[729,21,729,22,0],[730,13,730,14,0],[731,18,731,36,0],[732,13,732,28,0],[733,13,733,14,0],[734,17,734,85,0],[735,17,735,24,0],[735,26,735,39,0],[735,40,735,42,0],[735,43,735,54,0],[736,17,736,18,0],[737,21,737,80,0],[738,21,738,48,0],[738,49,738,92,0],[739,21,739,51,0],[740,17,740,18,0],[741,17,741,50,0],[742,13,742,14,0],[743,9,743,10,0],[748,9,748,10,0],[749,13,750,89,0],[751,13,751,14,0],[752,17,752,30,0],[753,13,753,14,0],[755,13,755,66,0],[757,13,759,113,0],[760,13,760,96,0],[761,13,761,31,0],[762,17,762,107,0],[764,13,764,28,0],[765,13,765,57,0],[766,13,766,14,0],[767,17,767,61,0],[768,17,768,24,0],[768,26,768,39,0],[768,40,768,42,0],[768,43,768,66,0],[769,21,769,56,0],[770,17,770,43,0],[771,13,771,14,0],[772,13,772,26,0],[773,9,773,10,0],[776,9,776,10,0],[777,13,777,56,0],[778,13,780,52,0],[781,13,783,52,0],[784,13,784,40,0],[785,13,785,20,0],[785,22,785,34,0],[785,35,785,37,0],[785,38,785,53,0],[786,13,786,14,0],[787,17,787,50,0],[788,17,788,33,0],[789,17,789,84,0],[790,13,790,14,0],[792,13,792,41,0],[794,13,794,38,0],[795,9,795,10,0],[798,9,798,10,0],[799,13,799,48,0],[799,49,799,62,0],[801,13,801,83,0],[802,13,802,14,0],[804,17,804,39,0],[806,17,806,18,0],[811,21,811,37,0],[812,17,812,18,0],[813,17,813,22,0],[814,17,814,18,0],[815,17,815,18,0],[816,17,816,33,0],[819,13,820,27,0],[821,13,821,51,0],[822,13,822,14,0],[824,17,824,29,0],[828,13,828,104,0],[829,13,829,60,0],[830,13,830,35,0],[831,22,831,31,0],[831,33,831,50,0],[831,52,831,55,0],[832,17,832,18,0],[833,21,835,74,0],[836,21,836,37,0],[836,38,836,47,0],[837,21,839,75,0],[840,21,840,39,0],[840,40,840,49,0],[841,21,841,50,0],[842,17,842,18,0],[843,13,843,90,0],[844,13,844,44,0],[846,13,846,20,0],[846,22,846,44,0],[846,45,846,47,0],[846,48,846,60,0],[847,13,847,14,0],[848,17,848,59,0],[848,60,848,69,0],[849,17,849,77,0],[850,17,850,18,0],[851,21,851,77,0],[852,25,852,50,0],[853,21,853,30,0],[856,17,857,75,0],[858,17,858,81,0],[859,17,859,36,0],[859,37,859,62,0],[860,13,860,14,0],[861,13,861,38,0],[862,9,862,10,0],[871,9,871,10,0],[873,13,873,14,0],[874,17,874,63,0],[875,17,875,70,0],[877,17,877,92,0],[878,17,878,58,0],[879,17,879,60,0],[882,17,883,27,0],[885,17,885,74,0],[886,17,886,90,0],[887,17,887,74,0],[888,17,888,88,0],[890,17,896,35,0],[898,17,898,41,0],[898,42,898,101,0],[899,17,899,51,0],[899,52,899,111,0],[901,17,901,72,0],[902,17,902,44,0],[903,17,903,55,0],[904,17,904,71,0],[905,17,905,38,0],[907,13,907,33,0],[908,13,908,14,0],[909,17,909,56,0],[910,17,910,69,0],[911,17,911,40,0],[913,9,913,10,0],[922,9,922,10,0],[924,13,924,14,0],[925,17,925,63,0],[926,17,926,92,0],[927,17,927,58,0],[928,17,928,60,0],[930,17,931,27,0],[932,17,932,74,0],[933,17,933,90,0],[934,17,934,74,0],[935,17,935,88,0],[938,17,938,41,0],[939,17,939,18,0],[940,21,940,42,0],[941,21,941,37,0],[943,21,943,100,0],[947,21,947,115,0],[948,21,950,53,0],[952,21,952,122,0],[954,21,954,57,0],[956,21,956,62,0],[958,21,958,65,0],[961,21,966,63,0],[967,21,967,45,0],[967,46,967,105,0],[968,21,968,69,0],[969,25,969,84,0],[971,21,971,95,0],[972,21,972,54,0],[974,21,974,60,0],[975,21,977,32,0],[978,21,978,67,0],[979,21,979,22,0],[980,25,981,84,0],[982,25,982,49,0],[983,25,983,26,0],[984,29,984,72,0],[986,29,988,40,0],[989,29,989,30,0],[990,29,990,116,0],[991,29,991,78,0],[992,29,993,97,0],[995,29,995,94,0],[996,29,996,98,0],[997,29,997,114,0],[998,29,998,93,0],[999,29,1002,118,0],[1003,25,1003,26,0],[1004,21,1004,22,0],[1006,21,1006,87,0],[1007,21,1007,42,0],[1008,21,1008,52,0],[1009,21,1009,57,0],[1010,21,1010,49,0],[1011,21,1011,56,0],[1014,21,1014,35,0],[1015,21,1015,22,0],[1016,25,1016,92,0],[1017,25,1017,39,0],[1018,29,1019,110,0],[1020,21,1020,22,0],[1023,21,1023,76,0],[1024,21,1024,35,0],[1024,36,1024,63,0],[1025,21,1025,59,0],[1026,21,1026,91,0],[1027,21,1027,37,0],[1029,21,1029,72,0],[1030,21,1030,66,0],[1031,21,1031,68,0],[1033,21,1035,58,0],[1036,21,1036,55,0],[1037,21,1037,53,0],[1038,21,1038,46,0],[1039,21,1039,22,0],[1040,25,1040,67,0],[1041,21,1041,22,0],[1042,21,1042,93,0],[1043,21,1043,22,0],[1045,25,1045,26,0],[1046,29,1047,57,0],[1048,29,1048,73,0],[1049,29,1049,42,0],[1050,29,1050,30,0],[1051,33,1051,118,0],[1052,33,1052,48,0],[1052,49,1052,84,0],[1053,29,1053,30,0],[1054,25,1054,26,0],[1055,25,1055,45,0],[1056,25,1056,26,0],[1057,29,1057,110,0],[1058,29,1058,98,0],[1059,33,1059,84,0],[1061,33,1061,62,0],[1063,21,1063,22,0],[1064,26,1064,76,0],[1065,25,1065,69,0],[1067,25,1067,70,0],[1069,21,1069,45,0],[1070,21,1070,22,0],[1071,25,1076,27,0],[1077,25,1077,103,0],[1078,25,1078,95,0],[1079,25,1080,118,0],[1081,21,1081,22,0],[1084,21,1084,22,0],[1085,25,1085,50,0],[1086,25,1086,26,0],[1087,29,1087,78,0],[1088,25,1088,26,0],[1089,21,1089,22,0],[1090,21,1090,38,0],[1091,21,1091,22,0],[1092,21,1092,22,0],[1093,21,1095,47,0],[1099,21,1099,86,0],[1100,21,1100,116,0],[1103,21,1103,59,0],[1104,21,1104,80,0],[1105,21,1105,22,0],[1106,25,1108,75,0],[1109,25,1109,58,0],[1110,25,1110,49,0],[1111,25,1111,42,0],[1112,25,1112,45,0],[1113,25,1113,49,0],[1114,25,1114,74,0],[1115,25,1115,55,0],[1116,25,1116,90,0],[1117,25,1117,26,0],[1118,29,1119,96,0],[1120,25,1120,26,0],[1122,25,1122,26,0],[1123,29,1124,54,0],[1125,25,1125,26,0],[1127,25,1128,101,0],[1130,25,1131,118,0],[1132,21,1132,22,0],[1133,21,1140,57,0],[1141,17,1141,18,0],[1142,13,1142,14,0],[1143,13,1143,30,0],[1144,13,1144,14,0],[1145,17,1145,23,0],[1147,13,1147,25,0],[1148,9,1148,10,0]]);
    </script>
  </body>
</html>