<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Work Order\WOList.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.Configuration;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ContmgtDTO;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.AMP3.WORKORDBL;
using Aurigo.AMP3.WORKORDDTO;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.Documents.Excel;
using Infragistics.WebUI.UltraWebGrid;

namespace Aurigo.AMP3.WORKORDUI
{
    public partial class WOList : BrixPageBase
    {
        private StateMgmtWOItems pageState;

        private int PageSize
        {
            get { return grdWOList.DisplayLayout.Pager.PageSize; }
        }

        protected override void OnInit(EventArgs e)
        {
            (mypager).ItemClicked += HandlePagerEvent;
            mypager.EnableViewState = true;
            grdWOList.SortColumn += grdWOList_SortColumn;
            base.OnInit(e);
        }

        public void HandlePagerEvent(object sender, ItemClickEventArgs e)
        {
            BindData();
            grdWOList.DisplayLayout.Pager.CurrentPageIndex = 1;
            pageState.MaintainState(((HtmlInputHidden) mypager.FindControl(&quot;currentPage&quot;)).Value.ToInt32_2(),
                pageState.SortKey, pageState.GetSortOrder(UIHelper.GetSortIndicator(ViewState[Constants.ODS_SORTORDER])),
                ViewState[Constants.ODS_FILTER] == null ? null : ViewState[Constants.ODS_FILTER].ToString2());
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                /* to disable the role dropdown in the master page*/
                UIHelper.DisableRoleSelection(Page);
                SetPermissions();
                lblError.Text = &quot;&quot;;
                //Page.ClientScript.RegisterStartupScript(GetType(), &quot;rowCount&quot;, &quot;DeActivateCM();&quot;, true);
                if (!IsPostBack)
                {
                    btnReset.Attributes.Add(&quot;onClick&quot;,
                                            &quot;document.getElementById(&#39;&quot; + btnCancel.ClientID +
                                            &quot;&#39;).click();return resetFilters();&quot;);
                    grdWOList.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;none&quot;;

                    if (Request.QueryString[&quot;ContractID&quot;] != null)
                    {
                        int _contractid;
                        int.TryParse(Request.QueryString[&quot;ContractID&quot;].ToString2(), out _contractid);
                        ViewState[&quot;ContractID&quot;] = _contractid;
                    }
                    if (Request.QueryString[&quot;PID&quot;] != null)
                    {
                        int _projectID;
                        int.TryParse(Request.QueryString[&quot;PID&quot;].ToString2(), out _projectID);
                        ViewState[&quot;PID&quot;] = _projectID;
                    }
                }
                SetPermissions();
                if ((pageState = UIHelper.GetModuleFromStateBag(WOConstants.GSTATE_WO, Context) as StateMgmtWOItems) ==
                    null)
                {
                    pageState = new StateMgmtWOItems(WOConstants.GSTATE_WO);
                    UIHelper.UpdateModuleStateBag(WOConstants.GSTATE_WO, pageState, Context);
                }
                else if (!WebConfigurationManager.AppSettings[&quot;StateMgmtGlobal&quot;].ToBoolean2()
                         &amp;&amp; Request.UrlReferrer != null
                         &amp;&amp; !Array.Exists(Request.UrlReferrer.Segments,
                                          delegate(string s) { return (s != null &amp;&amp; s.StartsWith2(WOConstants.MODID_PAYESTM)); }
                                 ))
                {
                    pageState.ClearState();
                }
                else if (pageState.ContractID != 0 &amp;&amp; Session[&quot;ContractID&quot;] != null &amp;&amp;
                         pageState.ContractID != Session[&quot;ContractID&quot;].ToString2().ToInt32_2())
                {
                    pageState.ClearState();
                }
                else
                {
                    ViewState[Constants.ODS_SORTORDER] = pageState.SortOrder;
                    ViewState[Constants.ODS_FILTER] = pageState.FilterCriterion;
                    ((HtmlInputHidden) mypager.FindControl(&quot;currentPage&quot;)).Value = pageState.PageIndex.ToString2();
                    if (ViewState[Constants.ODS_FILTER] != null &amp;&amp; !IsPostBack)
                    {
                        pageState.RestoreFilterState(Page, ViewState[&quot;FILTER&quot;].ToString2());
                    }
                    else if (ViewState[Constants.ODS_FILTER] == null &amp;&amp; pageState.PageIndex == 0)
                    {
                        Page.ClientScript.RegisterStartupScript(GetType(), &quot;resetFilters&quot;, &quot;resetFilters();&quot;, true);
                    }
                    ////if (!string.IsNullOrEmpty(pageState.FilterCriterion) &amp;&amp; !IsPostBack)
                    ////{
                    ////    pageState.RestoreFilterState(Page.Page, pageState.FilterCriterion);
                    ////}
                    // if (string.IsNullOrEmpty(pageState.FilterCriterion) &amp;&amp; pageState.PageIndex == 0)
                    //{
                    //    Page.ClientScript.RegisterStartupScript(GetType(), &quot;resetFilters&quot;, &quot;resetFilters();&quot;, true);
                    //}
                }
                if (ViewState[Constants.ODS_FILTER] != null)
                {
                    Page.ClientScript.RegisterStartupScript(GetType(), &quot;showHideFilterButtons&quot;,
                                                            &quot;showHideFilterButtons();&quot;, true);
                }
                //if (!string.IsNullOrEmpty(pageState.FilterCriterion))
                //{
                //    Page.ClientScript.RegisterStartupScript(GetType(), &quot;showHideFilterButtons&quot;, &quot;showHideFilterButtons();&quot;, true);
                //}

                if (!IsPostBack || (IsPostBack &amp;&amp; pageState.PageIndex == 0))
                {
                    GetPageCount();

                    if (!string.IsNullOrEmpty(pageState.SortKey))
                    {
                        BindData();
                        foreach (UltraGridColumn uwgcol in grdWOList.DisplayLayout.Bands[0].Columns)
                            if (uwgcol.SortIndicator != SortIndicator.None)
                                uwgcol.SortIndicator = SortIndicator.None;
                    }
                    else
                    {
                        if (ViewState[Constants.ODS_SORTORDER] != null &amp;&amp;
                            ViewState[Constants.ODS_SORTORDER].ToString2().EndsWith2(&quot;ASC&quot;))
                            ViewState[Constants.ODS_SORTORDER] = ViewState[Constants.ODS_SORTORDER].ToString2().Replace(&quot; ASC&quot;, &quot; DESC&quot;);
                        else
                            ViewState[Constants.ODS_SORTORDER] = ViewState[Constants.ODS_SORTORDER].ToString2().Replace(&quot; DESC&quot;, &quot; ASC&quot;);
                        if (grdWOList.Columns.Count &gt; 0 &amp;&amp; grdWOList.Columns.Exists(pageState.SortKey))
                            ApplySort(pageState.SortKey);
                        else
                        {
                            //BindData();
                            ApplySort(pageState.SortKey);
                        }
                    }
                    pageState.setPagerProperties(mypager);

                    if (!IsPostBack)
                    {
                        try
                        {
                            DTO dtoCntrct = BL.Instance.GetContract(Request[&quot;ContractID&quot;].ToInt32_2(),
                                                                    FetchSet.Default);

                            bool conLocked = dtoCntrct.Locked == &quot;Y&quot;;

                            lnkNew.Enabled &amp;= conLocked;
                            lnkView.Enabled &amp;= conLocked;
                            lnkPrint.Enabled &amp;= conLocked;
                            lnkEdit.Enabled &amp;= conLocked;
                            //lnkApprove.Enabled &amp;= conLocked;
                            lnkDelete.Enabled &amp;= conLocked;
                            lnkCloseOut.Enabled &amp;= conLocked;
                        }
                        catch
                        {
                            Response.Redirect(
                                &quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] ??
                                String.Empty, true);
                        }
                    }
                }
            }
            catch (Exception err)
            {
                lblError.Text = err.ToString2();
            }
        }

        private void BindData()
        {
            int startIdx = ((HtmlInputHidden) mypager.FindControl(&quot;currentPage&quot;)).Value.ToInt32_2() - 1;
            //if (startIdx &gt; 1)
            {
                startIdx = 1 + (grdWOList.DisplayLayout.Pager.PageSize*startIdx);
            }
            DataSet dsWO = WORKORDManager.Instance.GetWOList(ViewState[&quot;ContractID&quot;].ToInt32_2(),
                                                             (1 +
                                                              (PageSize*
                                                               (mypager.CurrentPage == 0 ? 0 : mypager.CurrentPage - 1))),
                                                             PageSize,
                                                             ViewState[Constants.ODS_SORTORDER] == null
                                                                 ? null
                                                                 : ViewState[Constants.ODS_SORTORDER].ToString2(),
                                                             ViewState[Constants.ODS_FILTER] == null
                                                                 ? null
                                                                 : ViewState[Constants.ODS_FILTER].ToString2());
            bool isNotFilteredOnClosed = ViewState[Constants.ODS_FILTER] == null ||
                                         !ViewState[Constants.ODS_FILTER].ToString2().Contains(
                                             &quot;&lt;Status type=&#39;rbl&#39;&gt;4&lt;/Status&gt;&quot;);
            bool isDataFound = true;
            if (isNotFilteredOnClosed)
            {
                if (dsWO.Tables[0].Rows.Count &lt; 1)
                    isDataFound = false;
                else
                {
                    var dr =
                        new DataRelation(&quot;ParentChild&quot;, dsWO.Tables[0].Columns[&quot;WorkOrderID&quot;],
                                         dsWO.Tables[1].Columns[&quot;ParentID&quot;]);
                    dsWO.Relations.Add(dr);
                    grdWOList.DataSource = dsWO;
                }
            }
            else
            {
                if (dsWO.Tables[1].Rows.Count &lt; 1)
                    isDataFound = false;
                else
                {
                    grdWOList.DataSource = dsWO.Tables[1];
                }
            }

            if (!isDataFound)
            {
                grdWOList.Columns.Clear();
                grdWOList.DisplayLayout.NoDataMessage = &quot;No Data To Display&quot;;
            }
            else
            {
                grdWOList.DisplayLayout.ViewType = ViewType.Hierarchical;
                grdWOList.DataBind();
                setGridColumns(grdWOList.Bands[0].Columns);
                if (dsWO.Tables[1].Rows.Count &gt; 0 &amp;&amp; isNotFilteredOnClosed)
                {
                    setGridColumns(grdWOList.Bands[1].Columns);
                    grdWOList.Bands[1].ColHeadersVisible = ShowMarginInfo.No;
                    grdWOList.Bands[1].ParentBand.IndentationType = IndentationType.Indented;
                    grdWOList.Bands[1].IndentationType = IndentationType.Indented;
                }
                grdWOList.DisplayLayout.Pager.AllowPaging = true;
                grdWOList.DisplayLayout.ScrollBar = ScrollBar.Auto;
                grdWOList.DisplayLayout.FrameStyle.Height = Unit.Percentage(100);
                grdWOList.DisplayLayout.Pager.AllowPaging = false;
                grdWOList.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
                grdWOList.DisplayLayout.NoDataMessage = &quot;No Data to display&quot;;
            }
        }

        protected void G1_InitializeRow(object sender, RowEventArgs e)
        {
            int status = e.Row.Cells.FromKey(&quot;Status&quot;).Value.ToInt32_2();
            e.Row.Cells.FromKey(&quot;Status&quot;).Value = (status == WOConstants.STAGE_DRAFT
                                                       ? &quot;Draft&quot;
                                                       : (status == WOConstants.STAGE_APPROVED
                                                              ? &quot;Approved&quot;
                                                              : (status == WOConstants.STAGE_ISSUED
                                                                     ? &quot;Issued&quot;
                                                                     : &quot;Closed&quot;)));

            if (!e.Row.Cells.FromKey(&quot;IsLatest&quot;).Value.ToString2().ToLower2().Equals(&quot;true&quot;))
            {
                e.Row.Style.BackColor = Color.LightGray;
            }
            else
            {
                e.Row.Style.BackColor = Color.White;
            }
        }

        protected void grdWOList_SortColumn(object sender, SortColumnEventArgs e)
        {
            ApplySort(grdWOList.Columns[e.ColumnNo].Key);
            pageState.MaintainState(((HtmlInputHidden) mypager.FindControl(&quot;currentPage&quot;)).Value.ToInt32_2(),
                grdWOList.Columns[e.ColumnNo].Key, pageState.GetSortOrder(UIHelper.GetSortIndicator(ViewState[Constants.ODS_SORTORDER])),
                ViewState[Constants.ODS_FILTER] == null ? null : ViewState[Constants.ODS_FILTER].ToString2());
        }

        private void setGridColumns(ColumnsCollection cols)
        {
            cols.FromKey(&quot;ParentID&quot;).Hidden = true;
            cols.FromKey(&quot;WorkOrderNo&quot;).HTMLEncodeContent = true;
            cols.FromKey(&quot;WorkOrderNo&quot;).Header.Caption = &quot;Work Order No.&quot;;
            cols.FromKey(&quot;WithMaterial&quot;).Header.Caption = &quot;With Material&quot;;

            cols.FromKey(&quot;WorkOrderID&quot;).Hidden = true;
            cols.FromKey(&quot;ContractID&quot;).Hidden = true;
            cols.FromKey(&quot;ContractorID&quot;).Hidden = true;
            cols.FromKey(&quot;IsLatest&quot;).Hidden = true;

            if (cols.Exists(&quot;WorkOrderDate&quot;))
            {
                cols.FromKey(&quot;WorkOrderDate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
                cols.FromKey(&quot;WorkOrderDate&quot;).Header.Caption = &quot;Work Order Date&quot;;
            }
            if (cols.Exists(&quot;VersionNo&quot;))
            {
                cols.FromKey(&quot;VersionNo&quot;).Header.Caption = &quot;Version Number&quot;;
            }
            if (cols.Exists(&quot;TotalAmount&quot;))
            {
                cols.FromKey(&quot;TotalAmount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                cols.FromKey(&quot;TotalAmount&quot;).Header.Caption = &quot;Amount&quot;;
            }
            if (cols.Exists(&quot;RowNum&quot;))
                cols.FromKey(&quot;RowNum&quot;).Hidden = true;
            //grid.DisplayLayout.ViewType = ViewType.OutlookGroupBy;
            //grid.DisplayLayout.Bands[0].Columns.FromKey(&quot;WorkOrderNo&quot;).IsGroupByColumn = true;
            //grid.Columns.FromKey(&quot;WorkOrderNo&quot;).IsGroupByColumn = true;
            //grid.DisplayLayout.Bands[0].Columns.FromKey(&quot;WorkOrderNo&quot;).AllowGroupBy = AllowGroupBy.Yes;
        }

        protected void lnkNew_Click(object sender, EventArgs e)
        {
            Response.Redirect(&quot;NewWorkOrder.aspx?&quot; + Constants.QRY_PROJECTID + &quot;=&quot; +
                (Request.QueryString[Constants.QRY_PROJECTID] ?? string.Empty) + &quot;&amp;&quot; + WOConstants.QRY_CONTRACTID + &quot;=&quot; +
                (Request.QueryString[WOConstants.QRY_CONTRACTID] ?? string.Empty) + &quot;&amp;ParentContext = CONTMGT&quot;);
        }

        protected void lnkView_Click(object sender, EventArgs e)
        {
            if (lnkView.Enabled &amp;&amp; !string.IsNullOrEmpty(hfWOID.Value))
            {
                int WOID = hfWOID.Value.ToInt32_2();
                Response.Redirect(
                    &quot;ViewWO.aspx?PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID={2}&amp;ParentContext=CONTMGT&quot;.Format2(
                    Request[&quot;PID&quot;], Request[&quot;ContractID&quot;], WOID), false);
            }
        }

        protected void lnkPrint_Click(object sender, EventArgs e)
        {
            if (lnkView.Enabled &amp;&amp; !string.IsNullOrEmpty(hfWOID.Value))
            {
                Response.Redirect(
                    &quot;~/Common/BrixReportPage.aspx?Context=WORKORD&amp;MODID=WORKORD&amp;ParentID={0}&amp;WOID={1}&amp;code=WOR&amp;PID={2}&amp;ParentModuleID=CONTMGT&quot;
                        .Format2(Request[&quot;ContractID&quot;], hfWOID.Value.ToInt32_2(), Request[&quot;PID&quot;]), false);
            }
        }

        protected void lnkReqForQuot_Click(object sender, EventArgs e)
        {
            if (lnkReqForQuot.Enabled &amp;&amp; !string.IsNullOrEmpty(hfWOID.Value))
                Response.Redirect(
                    &quot;~/Common/BrixReportPage.aspx?Context=WORKORD&amp;MODID=WORKORD&amp;ParentID={0}&amp;WOID={1}&amp;code=REQFORQUOT&amp;PID={2}&amp;ParentModuleID=CONTMGT&quot;
                        .Format2(Request[&quot;ContractID&quot;], hfWOID.Value.ToInt32_2(), Request[&quot;PID&quot;]), false);
        }

        protected void lnkExport_Click(object sender, EventArgs e)
        {
            uwgExcelExporter.WorksheetName = &quot;Work Order &quot; + LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR) + &quot;s&quot;;

            WorkOrderDTO WODTO = WORKORDManager.Instance.GetWorkOrderDetails(hfWOID.Value.ToInt32_2());
            uwgExcelExporter.DownloadName = WODTO.WorkOrderNo + &quot;_&quot; +
                                            LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR) + &quot;s.XLS&quot;;

            uwgWOItems.DataSource = WODTO.WorkOrderItems.Tables[0];
            uwgWOItems.DataBind();
            SetWOGridColumns(WODTO);

            var book = new Workbook();
            //bool colExists = true;
            //
            if ((uwgWOItems.Columns.FromKey(&quot;UnitPrice&quot;) == null) || (uwgWOItems.Columns.FromKey(&quot;UnitPrice&quot;).Hidden))
            {
                //colExists = false;
                uwgWOItems.Columns.Add(new UltraGridColumn(&quot;Rate&quot;, &quot;Rate&quot;, ColumnType.NotSet, &quot;0.0000&quot;), true);
                uwgWOItems.Columns.FromKey(&quot;Rate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                uwgWOItems.Columns.FromKey(&quot;Rate&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                uwgWOItems.Columns.FromKey(&quot;Rate&quot;).CellStyle.BackColor = Color.Yellow;
            }
            else
            {
                uwgWOItems.Columns.FromKey(&quot;UnitPrice&quot;).Move(uwgWOItems.Columns.FromKey(&quot;UnitPrice&quot;).Index + 1);
            }
            if (uwgWOItems.Columns.Exists(&quot;WOQuantity&quot;))
            {
                uwgWOItems.Columns.FromKey(&quot;WOQuantity&quot;).CellStyle.BackColor = Color.White;
                uwgWOItems.Columns.FromKey(&quot;WOQuantity&quot;).Header.Caption = &quot;WOQuantity&quot;;
            }
            if (uwgWOItems.Columns.Exists(&quot;StandardItemNo.&quot;))
            {
                uwgWOItems.Columns.FromKey(&quot;StandardItemNo.&quot;).Header.Caption = &quot;StandardItemNo.&quot;;
            }

            uwgWOItems.Columns.FromKey(&quot;LineNo&quot;).Header.Caption = &quot;LineNo&quot;;
            uwgWOItems.Columns[0].Hidden = true;
            //

            book = uwgExcelExporter.Export(uwgWOItems);
            string sheetName = &quot;Work Order &quot; + LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR) + &quot;s&quot;;

            uwgExcelExporter.Export(uwgWOItems);
        }

        private void SetWOGridColumns(WorkOrderDTO WODTO)
        {
            ColumnsCollection cols = uwgWOItems.Columns;
            cols.FromKey(&quot;ItemID&quot;).Hidden = true;

            if (WODTO != null &amp;&amp; WODTO.Status &gt;= WOConstants.STAGE_ISSUED)
            {
                cols.FromKey(&quot;UnitPrice&quot;).Hidden = false;
                cols.FromKey(&quot;UnitPrice&quot;).Header.Caption = &quot;Rate&quot;;
                cols.FromKey(&quot;UnitPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                cols.FromKey(&quot;UnitPrice&quot;).AllowUpdate = AllowUpdate.Yes;
                cols.FromKey(&quot;UnitPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;UnitPrice&quot;).CellStyle.BackColor = Color.Yellow;
            }
            else
            {
                cols.FromKey(&quot;UnitPrice&quot;).Hidden = true;
            }


            cols.FromKey(&quot;LineNo&quot;).Header.Caption = &quot;Line No.&quot;;
            if (cols.Exists(&quot;WOQuantity&quot;))
            {
                cols.FromKey(&quot;WOQuantity&quot;).Header.Caption = &quot;WO Quantity&quot;;
                cols.FromKey(&quot;WOQuantity&quot;).AllowUpdate = AllowUpdate.Yes;
                cols.FromKey(&quot;WOQuantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;WOQuantity&quot;).CellStyle.BackColor = Color.Yellow;
            }
            if (cols.Exists(&quot;StandardItemNo.&quot;))
            {
                cols.FromKey(&quot;StandardItemNo.&quot;).Header.Caption = &quot;Standard Item No.&quot;;
            }
            if (cols.Exists(&quot;AvailableQuantity.&quot;))
            {
                cols.FromKey(&quot;AvailableQuantity.&quot;).Header.Caption = &quot;Available Quantity&quot;;
            }
        }

        protected void lnkEdit_Click(object sender, EventArgs e)
        {
            if (lnkEdit.Enabled &amp;&amp; !string.IsNullOrEmpty(hfWOID.Value))
            {
                int WOID = hfWOID.Value.ToInt32_2();

                if (WORKORDManager.Instance.GetWorkOrderDetails(WOID) == null)
                {
                    lblError.Text = &quot;The work order may have been deleted by another user.&quot;;
                    BindData();
                    return;
                }
                if (!String.IsNullOrEmpty(hdnVersion.Value) || hdnVersion.Value.Equals(&quot;1&quot;))
                    Response.Redirect(
                        &quot;NewWorkOrder.aspx?Type=E&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID={2}&amp;Version=true&amp;ParentContext=CONTMGT&quot;.
                            Format2(Request[WOConstants.QRY_PROJECTID], Request[WOConstants.QRY_CONTRACTID], WOID),
                        false);
                else
                    Response.Redirect(
                        &quot;NewWorkOrder.aspx?Type=E&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;WOID={2}&amp;ParentContext=CONTMGT&quot;.Format2(
                            Request[WOConstants.QRY_PROJECTID], Request[WOConstants.QRY_CONTRACTID], WOID), false);
            }
            else
            {
                lnkView_Click(sender, e);
            }
        }

        protected void lnkDelete_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(hdnMulti.Value))
                return;

            int retValue = WORKORDManager.Instance.DeleteWorkOrder(hdnMulti.Value.ToInt32_2());
            if (retValue == -2)
            {
                lblError.Text = &quot;Only draft or Approved instances can be deleted.&quot;;
            }
            BindData();
            return;
        }

        protected void lnkClose_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(hdnMulti.Value))
                return;
            int WorkOrderID = hdnMulti.Value.ToInt32_2();
            UserDetail ud = UserDetail.GetCurrentUserDetail();
            int retValue = WORKORDManager.Instance.CloseWorkOrder(WorkOrderID, ud.UID, ud.UserName, DateTime.UtcNow,
                                                                  &quot;Closed&quot;);
            if (retValue == -2)
            {
                Page.ClientScript.RegisterStartupScript(GetType(), &quot;Cannot Close out.&quot;,
                                                        &quot;&lt;script&gt; alert(&#39;There are approved Item Postings against this Work Order instance for which &quot; +
                                                        LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATES) +
                                                        &quot; have not been generated.You cannot close out this instance.&#39;);&lt;/script&gt;&quot;);
            }
            else if (retValue == -3)
            {
                Page.ClientScript.RegisterStartupScript(GetType(), &quot;Cannot Close out.&quot;,
                                                        &quot;&lt;script&gt; alert(&#39;There are &quot; +
                                                        LocalizationManager.GetString(&quot;MOH&quot;) +
                                                        &quot;s against this Work Order instance which have not been fully recovered. You cannot close out this instance.&#39;);&lt;/script&gt;&quot;);
            }
            BindData();
            return;
        }

        protected void btnFilterGhost_Click(object sender, EventArgs e)
        {
            ApplyFilter();
        }

        private void GetPageCount()
        {
            double rCnt = WORKORDManager.Instance.GetWOCount(Request[&quot;ContractID&quot;].ToInt32_2(),
                                                             ViewState[Constants.ODS_FILTER] == null
                                                                 ? null
                                                                 : ViewState[Constants.ODS_FILTER].
                                                                       ToString());
            if (pageState.PageIndex != 0 &amp;&amp;
                Math.Ceiling(rCnt/grdWOList.DisplayLayout.Pager.PageSize) &gt;= pageState.PageIndex)
            {
                ((HtmlInputHidden) mypager.FindControl(&quot;currentPage&quot;)).Value =
                    pageState.PageIndex &gt; 0 ? pageState.PageIndex.ToString2() : &quot;0&quot;;
            }
            else
            {
                ((HtmlInputHidden) mypager.FindControl(&quot;currentPage&quot;)).Value = rCnt &gt; 0 ? &quot;1&quot; : &quot;0&quot;;
            }
            ((HtmlInputHidden) mypager.FindControl(&quot;pageCount&quot;)).Value =
                rCnt &gt; grdWOList.DisplayLayout.Pager.PageSize
                    ? Math.Ceiling(rCnt/grdWOList.DisplayLayout.Pager.PageSize).ToString2()
                    : rCnt &gt; 0 ? &quot;1&quot; : &quot;0&quot;;
            pageState.MaintainState(((HtmlInputHidden)mypager.FindControl(&quot;currentPage&quot;)).Value.ToInt32_2(),
                pageState.SortKey, pageState.GetSortOrder(UIHelper.GetSortIndicator(ViewState[Constants.ODS_SORTORDER])),
                ViewState[Constants.ODS_FILTER] == null ? null : ViewState[Constants.ODS_FILTER].ToString2());
        }

        protected void ApplySort(string sortKey)
        {
            //string sortKey;
            //switch (colNo)
            //{
            //    case 1:
            //        sortKey = &quot;WorkOrderNo&quot;;
            //        break;
            //    case 3:
            //        sortKey = &quot;WorkOrderDate&quot;;
            //        break;
            //    case 5:
            //        sortKey = &quot;TotalAmount&quot;;
            //        break;
            //    default:
            //        sortKey = grdWOList.Columns[colNo].BaseColumnName;
            //        break;
            //}

            foreach (UltraGridColumn uwgcol in grdWOList.DisplayLayout.Bands[0].Columns)
            {
                if (uwgcol.SortIndicator != SortIndicator.None)
                    uwgcol.SortIndicator = SortIndicator.None;
            }
            if (ViewState[Constants.ODS_SORTORDER] != null
                &amp;&amp; ViewState[Constants.ODS_SORTORDER].ToString2().EndsWith2(&quot;ASC&quot;)
                &amp;&amp; ViewState[Constants.ODS_SORTORDER].ToString2().StartsWith(sortKey, StringComparison.CurrentCultureIgnoreCase))
            {
                ViewState[Constants.ODS_SORTORDER] = sortKey + &quot; DESC&quot;;
                grdWOList.Bands[0].Columns.FromKey(sortKey).SortIndicator = SortIndicator.Descending;
            }
            else
            {
                ViewState[Constants.ODS_SORTORDER] = sortKey + &quot; ASC&quot;;
                grdWOList.Bands[0].Columns.FromKey(sortKey).SortIndicator = SortIndicator.Ascending;
            }
            BindData();
        }

        protected void ApplyFilter()
        {
            try
            {
                ViewState[Constants.ODS_FILTER] = UIHelper.GenerateFilterXML(aspPnlFilter);
                GetPageCount();
                BindData();
                pageState.setPagerProperties(mypager);
            }
            catch (Exception ex)
            {
                Logger.Log(Enumerations.LogType.Error, ex.Message, Constants.MODID_PROJECT);
                throw;
            }
        }

        protected void SetPermissions()
        {
            try
            {
                /* Check Module Permissions for User*/
                var featurelist = (List&lt;string&gt;) Context.Items[Constants.MODULE_PERMISSIONS];
                lnkNew.Enabled = featurelist.Contains(WOConstants.MODFEAT_CREATE);
                lnkReqForQuot.Enabled =
                    lnkPrint.Enabled = lnkView.Enabled = featurelist.Contains(WOConstants.MODFEAT_VIEW);
                lnkEdit.Enabled = featurelist.Contains(WOConstants.MODFEAT_EDIT);
                lnkDelete.Enabled = featurelist.Contains(WOConstants.MODFEAT_DELETE);
                lnkCloseOut.Enabled = (lnkNew.Enabled || lnkEdit.Enabled);
                //lnkApprove.Enabled = featurelist.Contains(WOConstants.MODFEAT_APPROVE);
                /* Check Module Permissions End */
            }
            catch (Exception ex)
            {
                Logger.Log(Enumerations.LogType.Error, ex.Message, &quot;CONTMGTWO&quot;);
                throw;
            }
        }
    }

    [Serializable]
    public class StateMgmtWOItems : StateManagementBase
    {
        private int _contractID;

        public StateMgmtWOItems(string constStr)
            : base(constStr)
        {
        }

        public int ContractID
        {
            get { return _contractID; }
            set { _contractID = value; }
        }

        public void MaintainState(int ContractId, int pageIdx, string sortKey, Telerik.Web.UI.GridSortOrder sortOrder, string filterCriterion)
        {
            ContractID = ContractId;
            PageIndex = pageIdx;
            SortKey = sortKey;
            SortOrder = sortOrder;
            FilterCriterion = filterCriterion;
            UIHelper.UpdateModuleStateBag(WOConstants.GSTATE_CONTRCT_ITEM, this, HttpContext.Current);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[31,17,31,18,0],[31,19,31,65,0],[31,66,31,67,0],[35,9,35,10,0],[36,13,36,55,0],[37,13,37,44,0],[38,13,38,58,0],[39,13,39,28,0],[40,9,40,10,0],[43,9,43,10,0],[44,13,44,24,0],[45,13,45,64,0],[46,13,48,111,0],[49,9,49,10,0],[52,9,52,10,0],[54,13,54,14,0],[56,17,56,53,0],[57,17,57,34,0],[58,17,58,36,0],[60,17,60,33,0],[61,17,61,18,0],[62,21,64,82,0],[65,21,65,83,0],[67,21,67,67,0],[68,21,68,22,0],[70,25,70,102,0],[71,25,71,63,0],[72,21,72,22,0],[73,21,73,60,0],[74,21,74,22,0],[76,25,76,94,0],[77,25,77,55,0],[78,21,78,22,0],[79,17,79,18,0],[80,17,80,34,0],[81,17,82,26,0],[83,17,83,18,0],[84,21,84,77,0],[85,21,85,94,0],[86,17,86,18,0],[87,22,90,62,0],[90,62,90,63,0],[90,63,90,64,0],[90,64,90,127,0],[90,127,90,128,0],[90,128,90,129,0],[90,129,91,36,0],[87,22,91,36,0],[92,17,92,18,0],[93,21,93,44,0],[94,17,94,18,0],[95,22,96,96,0],[97,17,97,18,0],[98,21,98,44,0],[99,17,99,18,0],[101,17,101,18,0],[102,21,102,78,0],[103,21,103,81,0],[104,21,104,116,0],[105,21,105,80,0],[106,21,106,22,0],[107,25,107,93,0],[108,21,108,22,0],[109,26,109,98,0],[110,21,110,22,0],[111,25,111,117,0],[112,21,112,22,0],[121,17,121,18,0],[122,17,122,61,0],[123,17,123,18,0],[124,21,125,95,0],[126,17,126,18,0],[132,17,132,77,0],[133,17,133,18,0],[134,21,134,36,0],[136,21,136,66,0],[137,21,137,22,0],[138,25,138,36,0],[139,25,139,32,0],[139,34,139,56,0],[139,57,139,59,0],[139,60,139,100,0],[140,29,140,76,0],[141,33,141,75,0],[142,21,142,22,0],[144,21,144,22,0],[145,25,146,93,0],[147,29,147,138,0],[149,29,149,138,0],[150,25,150,104,0],[151,29,151,58,0],[153,25,153,26,0],[155,29,155,58,0],[156,25,156,26,0],[157,21,157,22,0],[158,21,158,59,0],[160,21,160,37,0],[161,21,161,22,0],[163,25,163,26,0],[164,29,165,87,0],[167,29,167,70,0],[169,29,169,57,0],[170,29,170,58,0],[171,29,171,59,0],[172,29,172,58,0],[174,29,174,60,0],[175,29,175,62,0],[176,25,176,26,0],[177,25,177,30,0],[178,25,178,26,0],[179,29,181,53,0],[182,25,182,26,0],[183,21,183,22,0],[184,17,184,18,0],[185,13,185,14,0],[186,13,186,34,0],[187,13,187,14,0],[188,17,188,49,0],[189,13,189,14,0],[190,9,190,10,0],[193,9,193,10,0],[194,13,194,105,0],[196,13,196,14,0],[197,17,197,82,0],[198,13,198,14,0],[199,13,209,113,0],[210,13,212,79,0],[213,13,213,37,0],[214,13,214,39,0],[215,13,215,14,0],[216,17,216,51,0],[217,21,217,41,0],[219,17,219,18,0],[220,21,222,78,0],[223,21,223,44,0],[224,21,224,49,0],[225,17,225,18,0],[226,13,226,14,0],[228,13,228,14,0],[229,17,229,51,0],[230,21,230,41,0],[232,17,232,18,0],[233,21,233,59,0],[234,17,234,18,0],[235,13,235,14,0],[237,13,237,30,0],[238,13,238,14,0],[239,17,239,43,0],[240,17,240,78,0],[241,13,241,14,0],[243,13,243,14,0],[244,17,244,74,0],[245,17,245,38,0],[246,17,246,60,0],[247,17,247,76,0],[248,17,248,18,0],[249,21,249,64,0],[250,21,250,78,0],[251,21,251,94,0],[252,21,252,83,0],[253,17,253,18,0],[254,17,254,66,0],[255,17,255,68,0],[256,17,256,82,0],[257,17,257,67,0],[258,17,258,87,0],[259,17,259,78,0],[260,13,260,14,0],[261,9,261,10,0],[264,9,264,10,0],[265,13,265,74,0],[266,13,272,84,0],[274,13,274,94,0],[275,13,275,14,0],[276,17,276,57,0],[277,13,277,14,0],[279,13,279,14,0],[280,17,280,53,0],[281,13,281,14,0],[282,9,282,10,0],[285,9,285,10,0],[286,13,286,58,0],[287,13,289,111,0],[290,9,290,10,0],[293,9,293,10,0],[294,13,294,52,0],[295,13,295,66,0],[296,13,296,75,0],[297,13,297,75,0],[299,13,299,55,0],[300,13,300,54,0],[301,13,301,56,0],[302,13,302,52,0],[304,13,304,46,0],[305,13,305,14,0],[306,17,306,101,0],[307,17,307,82,0],[308,13,308,14,0],[309,13,309,42,0],[310,13,310,14,0],[311,17,311,77,0],[312,13,312,14,0],[313,13,313,44,0],[314,13,314,14,0],[315,17,315,101,0],[316,17,316,71,0],[317,13,317,14,0],[318,13,318,39,0],[319,17,319,54,0],[324,9,324,10,0],[327,9,327,10,0],[328,13,330,113,0],[331,9,331,10,0],[334,9,334,10,0],[335,13,335,72,0],[336,13,336,14,0],[337,17,337,53,0],[338,17,340,74,0],[341,13,341,14,0],[342,9,342,10,0],[345,9,345,10,0],[346,13,346,72,0],[347,13,347,14,0],[348,17,350,107,0],[351,13,351,14,0],[352,9,352,10,0],[355,9,355,10,0],[356,13,356,78,0],[357,17,359,107,0],[360,9,360,10,0],[363,9,363,10,0],[364,13,364,126,0],[366,13,366,104,0],[367,13,368,113,0],[370,13,370,68,0],[371,13,371,35,0],[372,13,372,37,0],[374,13,374,39,0],[377,13,377,119,0],[378,13,378,14,0],[380,17,380,112,0],[381,17,381,112,0],[382,17,382,102,0],[383,17,383,87,0],[384,13,384,14,0],[386,13,386,14,0],[387,17,387,113,0],[388,13,388,14,0],[389,13,389,57,0],[390,13,390,14,0],[391,17,391,92,0],[392,17,392,88,0],[393,13,393,14,0],[394,13,394,62,0],[395,13,395,14,0],[396,17,396,98,0],[397,13,397,14,0],[399,13,399,76,0],[400,13,400,49,0],[403,13,403,56,0],[404,13,404,112,0],[406,13,406,49,0],[407,9,407,10,0],[410,9,410,10,0],[411,13,411,57,0],[412,13,412,50,0],[414,13,414,75,0],[415,13,415,14,0],[416,17,416,58,0],[417,17,417,67,0],[418,17,418,103,0],[419,17,419,73,0],[420,17,420,93,0],[421,17,421,78,0],[422,13,422,14,0],[424,13,424,14,0],[425,17,425,57,0],[426,13,426,14,0],[429,13,429,64,0],[430,13,430,43,0],[431,13,431,14,0],[432,17,432,75,0],[433,17,433,74,0],[434,17,434,94,0],[435,17,435,79,0],[436,13,436,14,0],[437,13,437,48,0],[438,13,438,14,0],[439,17,439,86,0],[440,13,440,14,0],[441,13,441,51,0],[442,13,442,14,0],[443,17,443,90,0],[444,13,444,14,0],[445,9,445,10,0],[448,9,448,10,0],[449,13,449,72,0],[450,13,450,14,0],[451,17,451,53,0],[453,17,453,79,0],[454,17,454,18,0],[455,21,455,93,0],[456,21,456,32,0],[457,21,457,28,0],[459,17,459,93,0],[460,21,463,32,0],[465,21,467,116,0],[468,13,468,14,0],[470,13,470,14,0],[471,17,471,42,0],[472,13,472,14,0],[473,9,473,10,0],[476,9,476,10,0],[477,13,477,54,0],[478,17,478,24,0],[480,13,480,96,0],[481,13,481,32,0],[482,13,482,14,0],[483,17,483,84,0],[484,13,484,14,0],[485,13,485,24,0],[486,13,486,20,0],[487,9,487,10,0],[490,9,490,10,0],[491,13,491,54,0],[492,17,492,24,0],[493,13,493,58,0],[494,13,494,63,0],[495,13,496,77,0],[497,13,497,32,0],[498,13,498,14,0],[499,17,502,133,0],[503,13,503,14,0],[504,18,504,37,0],[505,13,505,14,0],[506,17,509,180,0],[510,13,510,14,0],[511,13,511,24,0],[512,13,512,20,0],[513,9,513,10,0],[516,9,516,10,0],[517,13,517,27,0],[518,9,518,10,0],[521,9,521,10,0],[522,13,526,84,0],[527,13,528,98,0],[529,13,529,14,0],[530,17,531,85,0],[532,13,532,14,0],[534,13,534,14,0],[535,17,535,101,0],[536,13,536,14,0],[537,13,540,44,0],[541,13,543,111,0],[544,9,544,10,0],[547,9,547,10,0],[565,13,565,20,0],[565,22,565,44,0],[565,45,565,47,0],[565,48,565,88,0],[566,13,566,14,0],[567,17,567,64,0],[568,21,568,63,0],[569,13,569,14,0],[570,13,572,130,0],[573,13,573,14,0],[574,17,574,72,0],[575,17,575,102,0],[576,13,576,14,0],[578,13,578,14,0],[579,17,579,71,0],[580,17,580,101,0],[581,13,581,14,0],[582,13,582,24,0],[583,9,583,10,0],[586,9,586,10,0],[588,13,588,14,0],[589,17,589,92,0],[590,17,590,32,0],[591,17,591,28,0],[592,17,592,55,0],[593,13,593,14,0],[594,13,594,33,0],[595,13,595,14,0],[596,17,596,93,0],[597,17,597,23,0],[599,9,599,10,0],[602,9,602,10,0],[604,13,604,14,0],[606,17,606,94,0],[607,17,607,83,0],[608,17,609,105,0],[610,17,610,82,0],[611,17,611,86,0],[612,17,612,75,0],[615,13,615,14,0],[616,13,616,33,0],[617,13,617,14,0],[618,17,618,81,0],[619,17,619,23,0],[621,9,621,10,0],[630,15,630,29,0],[631,9,631,10,0],[632,9,632,10,0],[636,17,636,18,0],[636,19,636,38,0],[636,39,636,40,0],[637,17,637,18,0],[637,19,637,39,0],[637,40,637,41,0],[641,9,641,10,0],[642,13,642,37,0],[643,13,643,33,0],[644,13,644,31,0],[645,13,645,35,0],[646,13,646,47,0],[647,13,647,103,0],[648,9,648,10,0]]);
    </script>
  </body>
</html>