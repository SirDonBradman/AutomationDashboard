<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Work Order\BL\WOComponent.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.AMP3.UserManagementDTO;
using Aurigo.AMP3.WORKORDDTO;
using Aurigo.Brix.Construction.ContractManager.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Microsoft.Practices.EnterpriseLibrary.Data;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.AMP3.WORKORDDAC
{
    internal class WORKORDComponent
    {
        private static volatile Dictionary&lt;string, WORKORDComponent&gt; _Inst = null;
        private static readonly object _oSync = new object();
        public static WORKORDComponent Instance
        {
            get
            {
                lock (_oSync)
                {
                    if (_Inst == null) _Inst = new Dictionary&lt;string, WORKORDComponent&gt;();
                    string currentCompany = ConnectionHelper.GetCurrentCompany();
                    if (!_Inst.ContainsKey(currentCompany))
                        _Inst.Add(currentCompany, new WORKORDComponent());

                    return _Inst[currentCompany];
                }
            }
        }

        private readonly object lockObj = new object();

        private WORKORDComponent()
        {
        }

        internal int CUWorkOrder(WorkOrderDTO WODTO)
        {
            bool isLatest = true;
            if (WODTO.Status == WOConstants.STAGE_DRAFT_AMENDMENT || WODTO.Status == WOConstants.STAGE_APPROVE_AMENDMENT)
                isLatest = false;
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.WORKORDCreateWO,
                                                                               dictionary, WODTO.WorkOrderID,
                                                                               WODTO.ContractID, WODTO.WorkOrderNo,
                                                                               WODTO.WorkOrderRequestedBy,
                                                                               WODTO.WorkOrderDate, WODTO.Description,
                                                                               WODTO.Notes, WODTO.ScopeOfWork,
                                                                               WODTO.WithMaterial, WODTO.WithLabour,
                                                                               WODTO.WithEquipment, WODTO.StartDate,
                                                                               WODTO.EndDate, WODTO.Status,
                                                                               WODTO.ModifiedByID, WODTO.ModifiedBy,
                                                                               WODTO.ModifiedOn, WODTO.IsVersion,
                                                                               WODTO.WorkOrderItems.GetXml(), isLatest,
                                                                               WODTO.IsNew, WODTO.TaxPayerID,
                                                                               WODTO.LicenseCity, WODTO.LicenseState,
                                                                               WODTO.Insurance, WODTO.WorkOrderType,
                                                                               WODTO.xmlPrepaymentItemList,
                                                                               WODTO.xmlGeneralDetails,
                                                                               WODTO.xmlRetentionItemList, WODTO.Mode,
                                                                               WODTO.ExtReference,
                                                                               WODTO.IssueMode.Equals(IssueMode.Direct) ? 1 : 0,
                                                                               WODTO.Contractor, WODTO.ContractorID, WODTO.SystemWONo);

                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal int IssueWO(WorkOrderDTO WODTO)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.WORKORDIssueWO,
                                                                               dictionary, WODTO.WorkOrderID,
                                                                               WODTO.ContractID, WODTO.WorkOrderNo,
                                                                               WODTO.ModifiedByID, WODTO.ModifiedBy,
                                                                               WODTO.ModifiedOn, WODTO.IsVersion);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal int UndoIssueWO(WorkOrderDTO WODTO)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.WORKORDUndoIssueWO,
                                                                               dictionary, WODTO.WorkOrderID,
                                                                               WODTO.ContractID, WODTO.WorkOrderNo,
                                                                               WODTO.ModifiedByID, WODTO.ModifiedBy,
                                                                               WODTO.ModifiedOn, WODTO.IsVersion);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }
        internal DataSet ValidateUndoIssueWO(string WOID, string ContractID, string WorkorderNO)
        {
            DataSet DSResult;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                DSResult = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.WORKORDValidateUndoIssueWO,
                                                                               dictionary, WOID, ContractID, WorkorderNO);
            }
            return DSResult;
        }

        internal int ValidateIssueWO(WorkOrderDTO WODTO)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.WORKORDValidateISSUEWO,
                                                                               dictionary, WODTO.WorkOrderID,
                                                                               WODTO.ContractID, WODTO.WorkOrderNo,
                                                                               WODTO.ModifiedByID, WODTO.ModifiedBy,
                                                                               WODTO.ModifiedOn, WODTO.IsVersion);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal bool IsWoNoUnique(string wonum, int woid, int contractID)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.WORKORDisUniqueNo,
                                                                               dictionary, wonum, woid, contractID);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return (retVal == -1) ? false : true;
        }


        internal int CloseWorkOrder(int WorkOrderID, int ModifiedByID, string ModifiedBy, DateTime ModifiedOn,
                                    string VersionNo, string isFromPE, DateTime? retRelDate)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    WOStoredProcedure.usp_WORKORDCloseWorkOrder, dictionary, WorkOrderID, ModifiedByID, ModifiedBy,
                    ModifiedOn, VersionNo, isFromPE, retRelDate);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal int ValidateCloseWorkOrder(int WorkOrderID, int ModifiedByID, string ModifiedBy, DateTime ModifiedOn,
                                   string VersionNo, string isFromPE, DateTime? retRelDate)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    WOStoredProcedure.usp_WORKORDValidateCloseWorkOrder, dictionary, WorkOrderID, ModifiedByID, ModifiedBy,
                    ModifiedOn, VersionNo, isFromPE, retRelDate);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal bool SetItemsCompletedQuantity(int WorkOrderID, int ItemID, decimal QuantityPosted)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;WORKORDisUniqueNo&quot;);
                conn.DB.AddInParameter(cmd, &quot;WorkOrderID&quot;, DbType.String, WorkOrderID);
                conn.DB.AddInParameter(cmd, &quot;ItemID&quot;, DbType.Int32, ItemID);
                conn.DB.AddInParameter(cmd, &quot;QuantityPosted&quot;, DbType.Decimal, QuantityPosted);
                conn.DB.AddOutParameter(cmd, &quot;OUTPUT&quot;, DbType.Int32, 4);
                try
                {
                    conn.DB.ExecuteNonQuery(cmd);
                    return conn.DB.GetParameterValue(cmd, &quot;OUTPUT&quot;).ToString().ToBoolean2();
                }
                catch
                {
                    return false;
                }
            }
        }

        /// &lt;summary&gt;
        /// The input xml should be of the format
        /// &lt;Item ItemID=&quot;2&quot; UnitPrice=&quot;33.34&quot; Quantity =&quot;13&quot; /&gt;
        /// &lt;Item ItemID=&quot;4&quot; UnitPrice=&quot;12.34&quot; Quantity =&quot;21&quot; /&gt;
        /// Note: No root element
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ItemXML&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;QuotationID&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal bool UpdateQuotationDetails(string ItemXML, int CreatedBy, int QuotationID)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;usp_WORKORDInsertQuotationDetails&quot;);
                conn.DB.AddInParameter(cmd, &quot;@ItemXML&quot;, DbType.String, ItemXML);
                conn.DB.AddInParameter(cmd, &quot;@QuotationID&quot;, DbType.Int32, QuotationID);
                conn.DB.AddInParameter(cmd, &quot;@CreatedBy&quot;, DbType.Int32, CreatedBy);
                conn.DB.AddOutParameter(cmd, &quot;@OUTPUT&quot;, DbType.Int32, 4);
                try
                {
                    conn.DB.ExecuteNonQuery(cmd);
                    int output = conn.DB.GetParameterValue(cmd, &quot;OUTPUT&quot;).ToString().ToInt32_2();
                    if (output == -1)
                        return false;
                }
                catch
                {
                    return false;
                }
                return true;
            }
        }

        internal bool CreateWorkOrderQuotations(int QID, int WorkOrderID, int ContractorID, string Contractor,
                                                DateTime Date, string quotNotes, Decimal TotalAmount, int Status,
                                                string ItemXML, int Output)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    WOStoredProcedure.usp_WORKORDCreateWorkOrderQuotation, dictionary, QID, WorkOrderID, ContractorID,
                    Contractor, Date, quotNotes, TotalAmount, Status, ItemXML, Output);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return (retVal == -1) ? false : true;
        }

        internal DataTable GetWorkOrderQuotations(int WorkOrderID)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;usp_WORKORDGetWorkOrderQuotations&quot;);
                conn.DB.AddInParameter(cmd, &quot;@WorkOrderID&quot;, DbType.Int32, WorkOrderID);

                return conn.DB.ExecuteDataSet(cmd).Tables[0];
            }
        }

        internal DataSet GetWorkOrderQuotationDetails(int WorkOrderID, int QuotationID)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;usp_WORKORDGetQuotationDetails&quot;);
                conn.DB.AddInParameter(cmd, &quot;@WorkOrderID&quot;, DbType.Int32, WorkOrderID);
                conn.DB.AddInParameter(cmd, &quot;@QuotationID&quot;, DbType.Int32, QuotationID);

                return conn.DB.ExecuteDataSet(cmd);
            }

        }

        internal DataSet GetQuotations(int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetQuotations, null,
                                                                 WorkOrderID);
            }
            return result;
        }

        internal DataSet GetQuotation(int QuotationID, int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetQuotation, null,
                                                                 QuotationID, WorkOrderID);
            }
            return result;
        }

        internal int DeleteQuotation(string QuotationIDList)
        {
            int retVal = 0;
            lock (lockObj)
            {
                retVal =
                    ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                        WOStoredProcedure.usp_WORKORDDeleteQuotations, null, QuotationIDList);
            }
            return retVal.ToInt32_2();
        }

        internal int SetQuotationStatus(string QuotationIDList, int Status)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    WOStoredProcedure.usp_WORKORDSetQuotationStatus, dictionary, QuotationIDList, Status);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal int GetWorkOrderStatus(int WorkOrderID, int Status)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;usp_WORKORDGetWorkOrderStatus&quot;);
                conn.DB.AddInParameter(cmd, &quot;@WorkOrderID&quot;, DbType.String, WorkOrderID);
                conn.DB.AddOutParameter(cmd, &quot;@Status&quot;, DbType.Int32, 4);
                return conn.DB.ExecuteNonQuery(cmd);
            }
        }

        private bool HasItemPostings(string wonum)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;WORKORDHasIPs&quot;);
                conn.DB.AddInParameter(cmd, &quot;WONo&quot;, DbType.String, wonum);
                conn.DB.AddOutParameter(cmd, &quot;OUTPUT&quot;, DbType.Int32, 4);
                try
                {
                    conn.DB.ExecuteNonQuery(cmd);
                    int output = conn.DB.GetParameterValue(cmd, &quot;OUTPUT&quot;).ToString().ToInt32_2();
                    if (output == -1)
                        return false;
                }
                catch
                {
                    return false;
                }
                return true;
            }
        }

        internal int GetWOCount(int contractID, string filterSearch)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.WORKORDGetWOList, null, contractID, 1,
                                                                 10, null, filterSearch, &quot;Y&quot;);
            }
            return result.Tables[0].Rows[0][0].ToString().ToInt32_2();
        }

        internal string GetWONumber(int contractID, int projectID, bool ContractLevel, string Company)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetWONumber, null,
                                                                 contractID, projectID, ContractLevel, Company);
            }
            return result.Tables[0].Rows[0][0].ToString();
        }

        internal DataRow ShouldAllowUnlimitedQuotRate(int contractId, int projectId)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetWONumber, null,
                                                                 contractId, projectId, null, null);
            }
            return result.Tables[1].Rows[0];
        }

        internal void CUPrefix(int SettingID, int contractID, int projectID, string Prefix, bool allowUnlimitedQuotRate,
                               bool validateChecklists)
        {
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.WORKORDCUPrefix, null,
                                                                           SettingID, contractID, projectID, Prefix,
                                                                           allowUnlimitedQuotRate, validateChecklists);
        }

        internal DataSet GetWOList(int contractID, object startRowIdx, object maxRows, string sortOrder,
                                   string filterSearch)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.WORKORDGetWOList, null, contractID,
                                                                 startRowIdx.ToInt32_2(), maxRows.ToInt32_2(), sortOrder,
                                                                 filterSearch, &quot;N&quot;);
            }
            return result;
        }

        internal WorkOrderDTO GetWorkOrderDetails(int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.WORKORDGetWO, null, WorkOrderID);

                if (result.Tables[0].Rows.Count &lt; 1)
                    return null;

                DataRow dr = result.Tables[0].Rows[0];
                var WODTO = new WorkOrderDTO();
                WODTO.WorkOrderID = WorkOrderID;
                WODTO.ParentID = (dr[&quot;ParentID&quot;] == DBNull.Value) ? (int?)null : dr[&quot;ParentID&quot;].ToInt32_2();
                WODTO.TaxPayerID = dr[&quot;TaxPayerID&quot;].ToString();
                WODTO.LicenseCity = dr[&quot;LicenseCity&quot;].ToString();
                WODTO.LicenseState = dr[&quot;LicenseState&quot;].ToString();
                WODTO.Insurance = dr[&quot;Insurance&quot;].ToString();
                WODTO.ContractID = dr[&quot;ContractID&quot;].ToString().ToInt32_2();
                WODTO.WorkOrderNo = dr[&quot;WorkOrderNo&quot;].ToString();
                WODTO.SystemWONo = dr[&quot;SystemWONo&quot;].ToString();
                WODTO.ExtReference = result.Tables[0].Columns.Contains(&quot;ExtReference&quot;) ? dr[&quot;ExtReference&quot;].ToString() : string.Empty;
                WODTO.WorkOrderRequestedBy = dr[&quot;RequestedBy&quot;].ToString();
                WODTO.WorkOrderDate = dr[&quot;WorkOrderDate&quot;].ToDateTime_MWCulture();
                WODTO.Description = dr[&quot;Description&quot;].ToString();
                WODTO.Notes = dr[&quot;Notes&quot;].ToString();
                WODTO.ScopeOfWork = dr[&quot;ScopeOfWork&quot;].ToString();
                WODTO.WithMaterial = dr[&quot;WithMaterial&quot;].ToBoolean2();
                WODTO.WithLabour = dr[&quot;WithLabour&quot;].ToString().ToBoolean2();
                WODTO.WithEquipment = dr[&quot;WithEquipment&quot;].ToString().ToBoolean2();
                WODTO.ContractorID =
                    (string.IsNullOrEmpty(dr[&quot;ContractorID&quot;].ToString()) ? &quot;0&quot; : dr[&quot;ContractorID&quot;].ToString()).
                        ToInt32_2();
                WODTO.Contractor = dr[&quot;Contractor&quot;].ToString();
                WODTO.StartDate = dr[&quot;StartDate&quot;].ToDateTime_MWCulture();
                WODTO.EndDate = dr[&quot;EndDate&quot;].ToDateTime_MWCulture();
                WODTO.Status = dr[&quot;Status&quot;].ToString().ToInt32_2();
                WODTO.TotalAmount =
                    (string.IsNullOrEmpty(dr[&quot;TotalAmount&quot;].ToString()) ? &quot;0&quot; : dr[&quot;TotalAmount&quot;].ToString()).ToDecimal2
                        ();
                WODTO.ValidateWOQty =
                    bool.Parse(string.IsNullOrEmpty(dr[&quot;ValidateWOQty&quot;].ToString())
                                   ? &quot;False&quot;
                                   : dr[&quot;ValidateWOQty&quot;].ToString())
                        ? 1
                        : 0;
                if (WODTO.Status &gt;= WOConstants.STAGE_DRAFT)
                {
                    WODTO.CreatedByID = dr[&quot;CreatedByID&quot;].ToString().ToInt32_2();
                    WODTO.CreatedOn = dr[&quot;CreatedOn&quot;].ToDateTime_MWCulture();
                    User user = UserManager.Instance.GetAUser(WODTO.CreatedByID);
                    WODTO.CreatedBy = ((user != null) ? user.UserName : string.Empty);

                    if (WODTO.Status &gt;= WOConstants.STAGE_APPROVED &amp;&amp; WODTO.Status != WOConstants.STAGE_DRAFT_AMENDMENT)
                    {
                        WODTO.ApprovedByID =
                            (string.IsNullOrEmpty(dr[&quot;ApprovedByID&quot;].ToString()) ? &quot;0&quot; : dr[&quot;ApprovedByID&quot;].ToString()).
                                ToInt32_2();
                        WODTO.ApprovedOn = dr[&quot;ApprovedOn&quot;].ToDateTime_MWCulture();
                        user = UserManager.Instance.GetAUser(WODTO.ApprovedByID);
                        WODTO.ApprovedBy = ((user != null) ? user.UserName : string.Empty);

                        if (WODTO.Status &gt;= WOConstants.STAGE_ISSUED &amp;&amp;
                            WODTO.Status != WOConstants.STAGE_APPROVE_AMENDMENT)
                        {
                            WODTO.IssuedByID =
                                (string.IsNullOrEmpty(dr[&quot;IssuedByID&quot;].ToString()) ? &quot;0&quot; : dr[&quot;ApprovedByID&quot;].ToString())
                                    .ToInt32_2();
                            WODTO.IssuedOn = dr[&quot;IssuedOn&quot;].ToDateTime_MWCulture();
                            user = UserManager.Instance.GetAUser(WODTO.IssuedByID);
                            WODTO.IssuedBy = ((user != null) ? user.UserName : string.Empty);

                            if (WODTO.Status &gt;= WOConstants.STAGE_CLOSED &amp;&amp;
                                WODTO.Status != WOConstants.STAGE_APPROVE_AMENDMENT)
                            {
                                WODTO.ClosedByID =
                                    (string.IsNullOrEmpty(dr[&quot;ClosedByID&quot;].ToString())
                                         ? &quot;0&quot;
                                         : dr[&quot;ClosedByID&quot;].ToString()).ToInt32_2();
                                WODTO.ClosedOn = dr[&quot;ClosedOn&quot;].ToDateTime_MWCulture();
                                user = UserManager.Instance.GetAUser(WODTO.ClosedByID);
                                WODTO.ClosedBy = ((user != null) ? user.UserName : string.Empty);
                            }
                        }
                    }
                }
                //Load Items here

                WODTO.WorkOrderItems.Tables.Add(result.Tables[1].Copy());

                WODTO.WorkOrderType = dr[&quot;WorkOrderType&quot;].Equals(DBNull.Value) ? &quot;W&quot; : dr[&quot;WorkOrderType&quot;].ToString();
                if (WODTO.WorkOrderType.Equals(&quot;A&quot;))
                {
                    //Load Activities here....
                    WODTO.WorkOrderActivities.Tables.Add(result.Tables[2].Copy());
                }

                WODTO.IssueMode = (result.Tables[0].Columns.Contains(&quot;IssueMode&quot;) &amp;&amp; dr[&quot;IssueMode&quot;] != null) ? (IssueMode)dr[&quot;IssueMode&quot;] : IssueMode.WithQuotation;

                return WODTO;
            }
        }

        internal int DeleteWO(int WorkOrderID)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.WORKORDDeleteWO,
                                                                               dictionary, WorkOrderID);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        private void UPDATEStatus(int WOID, int STATUS)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;WORKORDUPDATESTATUS&quot;);
                conn.DB.AddInParameter(cmd, &quot;WOID&quot;, DbType.Int32, WOID);
                conn.DB.AddInParameter(cmd, &quot;STATUS&quot;, DbType.Int32, STATUS);
                conn.DB.ExecuteNonQuery(cmd);
            }
        }

        internal DataSet GetCustomSearchResults(string strQuery)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;WORKORDGetSearchResults&quot;);
                if (strQuery == &quot;&quot;)
                    conn.DB.AddInParameter(cmd, &quot;SearchCriteria&quot;, DbType.String, DBNull.Value);
                else
                    conn.DB.AddInParameter(cmd, &quot;SearchCriteria&quot;, DbType.String, strQuery);

                return conn.DB.ExecuteDataSet(cmd);
            }
        }

        private int GetGroupItemsCount(int contractID, string filterSearch)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;WORKORDGETGROUPITEMS&quot;);

                conn.DB.AddInParameter(cmd, &quot;contID&quot;, DbType.Int32, contractID);
                if (filterSearch != null)
                    conn.DB.AddInParameter(cmd, &quot;filterText&quot;, DbType.String, filterSearch);
                conn.DB.AddInParameter(cmd, &quot;getCount&quot;, DbType.String, &quot;Y&quot;);
                return conn.DB.ExecuteDataSet(cmd).Tables[0].Rows[0][0].ToString().ToInt32_2();
            }
        }

        internal decimal GetAvailableQuantityForItem(int ItemID, int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result =
                    ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetAvailableQuantityForItem,
                                                            null, ItemID, WorkOrderID, 0);
            }
            return result.Tables[0].Rows[0][0].ToString().ToDecimal2();
        }

        internal decimal GetUnitPrice(int ItemID, string ModuleID, bool chkWithMaterial, bool chkWithLabour,
                                      bool chkWithEquipment)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetContractUnitPrice, null,
                                                                 ItemID, ModuleID, chkWithMaterial, chkWithLabour,
                                                                 chkWithEquipment);
            }
            if (!string.IsNullOrEmpty(result.Tables[0].Rows[0][0].ToString()))
                return result.Tables[0].Rows[0][0].ToString().ToDecimal2();
            else
                return 0.0m;
        }

        internal decimal GetApprovedPostedQty(int ItemID, int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result =
                    ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetAvailableQuantityForItem,
                                                            null, ItemID, WorkOrderID, 1);
            }
            return result.Tables[0].Rows[0][0].ToString().ToDecimal2();
        }

        /// &lt;summary&gt;
        /// This method is to return WorkOrder Nos for Item Postings Mobile form.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ContractID&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal DataSet GetWorkOrdersByContract(int ContractID)
        {
            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                DbCommand cmd = conn.DB.GetStoredProcCommand(&quot;usp_WORKORDGetWOsByCID&quot;);
                conn.DB.AddInParameter(cmd, &quot;ContractID&quot;, DbType.Int32, ContractID);
                try
                {
                    return conn.DB.ExecuteDataSet(cmd);
                }
                catch
                {
                    return null;
                }
            }
        }

        internal DataTable GetSubContractorsList(int ContractID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetSubContractorsList,
                                                                 null, ContractID);
            }
            return result.Tables[0];
        }

        internal decimal GetMOHStatus(string WorkOrderNumber, int ContractID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetPrePaymentStatus, null,
                                                                 WorkOrderNumber, ContractID);
            }
            return result.Tables[0].Rows[0][0].ToString().ToDecimal2();
        }


        internal DataSet GetPendingDetailsForCloseOut(int workOrderId)
        {
            return ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDGetPendingDetailsforCloseOut,
                                                           null, workOrderId);
        }
    }

    internal class WOComponent
    {
        private static volatile Dictionary&lt;string, WOComponent&gt; _Inst = null;
        private static readonly object _oSync = new object();
        public static WOComponent Instance
        {
            get
            {
                lock (_oSync)
                {
                    if (_Inst == null) _Inst = new Dictionary&lt;string, WOComponent&gt;();
                    string currentCompany = ConnectionHelper.GetCurrentCompany();
                    if (!_Inst.ContainsKey(currentCompany))
                        _Inst.Add(currentCompany, new WOComponent());

                    return _Inst[currentCompany];
                }
            }
        }

        private readonly object lockObj = new object();

        private WOComponent()
        {
        }

        internal int CUWorkOrder(WorkOrderDTO WODTO)
        {
            bool isLatest = true;
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    ACTIWOStoredProcedure.usp_ACTIWOCreateWO, dictionary, WODTO.WorkOrderID, WODTO.ContractID,
                    WODTO.WorkOrderNo, WODTO.WorkOrderRequestedBy, WODTO.WorkOrderDate, WODTO.Description, WODTO.Notes,
                    WODTO.ScopeOfWork, WODTO.WithMaterial, WODTO.WithLabour, WODTO.WithEquipment, WODTO.StartDate,
                    WODTO.EndDate, WODTO.Status, WODTO.ModifiedByID, WODTO.ModifiedBy, WODTO.ModifiedOn, WODTO.IsVersion,
                    WODTO.WorkOrderItems.GetXml(), isLatest, WODTO.IsNew, WODTO.TaxPayerID, WODTO.LicenseCity,
                    WODTO.LicenseState, WODTO.Insurance, WODTO.xmlPrepaymentItemList, WODTO.xmlGeneralDetails,
                    WODTO.xmlRetentionItemList, WODTO.Mode, WODTO.ExtReference);

                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal int CloseWorkOrder(int WorkOrderID, int ModifiedByID, string ModifiedBy, DateTime ModifiedOn,
                                    string VersionNo, string isFromPE, DateTime? retRelDate)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    ACTIWOStoredProcedure.usp_ACTIWOCloseWorkOrder, dictionary, WorkOrderID, ModifiedByID, ModifiedBy,
                    ModifiedOn, VersionNo, isFromPE, retRelDate);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }


        internal int ValidateCloseWorkOrder(int WorkOrderID, int ModifiedByID, string ModifiedBy, DateTime ModifiedOn,
                                   string VersionNo, string isFromPE, DateTime? retRelDate)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    ACTIWOStoredProcedure.usp_ACTIWOValidateCloseWorkOrder, dictionary, WorkOrderID, ModifiedByID, ModifiedBy,
                    ModifiedOn, VersionNo, isFromPE, retRelDate);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal bool CreateWorkOrderActivity(int AID, int WorkOrderID, string ActivityName, string Unit,
                                              Decimal UnitCost, Decimal Quantity, Decimal Amount, string ItemXML,
                                              Decimal? Number, Decimal? Length, Decimal? Width, Decimal? Height,
                                              int Output)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            dictionary.Add(&quot;OUTPUT&quot;, null);
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    ACTIWOStoredProcedure.usp_ACTIWOCreateActivity, dictionary, AID, WorkOrderID, ActivityName, Unit,
                    UnitCost, Quantity, Amount, ItemXML, Number, Length, Width, Height, Output);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return (retVal == -1) ? false : true;
        }

        internal DataSet GetQuotations(int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(ACTIWOStoredProcedure.usp_ACTIWOGetQuotations, null,
                                                                 WorkOrderID);
            }
            return result;
        }

        internal DataSet GetActivities(int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(ACTIWOStoredProcedure.usp_ACTIWOGetActivities, null,
                                                                 WorkOrderID);
            }
            return result;
        }

        internal DataSet GetQuotation(int QuotationID, int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(ACTIWOStoredProcedure.usp_ACTIWOGetQuotation, null,
                                                                 QuotationID, WorkOrderID);
            }
            return result;
        }

        internal DataSet GetActivity(int ActivityID, int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(ACTIWOStoredProcedure.usp_WORKORDGetActivity, null,
                                                                 ActivityID, WorkOrderID);
            }
            return result;
        }

        internal int DeleteActivities(string ActivityIDList)
        {
            int retVal = 0;
            lock (lockObj)
            {
                retVal =
                    ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                        ACTIWOStoredProcedure.usp_ACTIWODeleteActivities, null, ActivityIDList);
            }
            return retVal.ToInt32_2();
        }

        internal WorkOrderDTO GetWorkOrderDetails(int WorkOrderID)
        {
            DataSet result;
            lock (lockObj)
            {
                result = ComponentHelper.Instance.ExecuteDataSet(ACTIWOStoredProcedure.usp_ACTIWOGetWO, null,
                                                                 WorkOrderID);

                if (result.Tables[0].Rows.Count &lt; 1)
                    return null;

                DataRow dr = result.Tables[0].Rows[0];
                if (dr[&quot;WorkOrderType&quot;].Equals(DBNull.Value) || dr[&quot;WorkOrderType&quot;].Equals(&quot;E&quot;))
                {
                    result = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.WORKORDGetWO, null, WorkOrderID);
                    dr = result.Tables[0].Rows[0];
                }
                var WODTO = new WorkOrderDTO();
                WODTO.WorkOrderID = WorkOrderID;
                WODTO.ParentID = (dr[&quot;ParentID&quot;] == DBNull.Value) ? (int?)null : dr[&quot;ParentID&quot;].ToInt32_2();
                WODTO.TaxPayerID = dr[&quot;TaxPayerID&quot;].ToString();
                WODTO.LicenseCity = dr[&quot;LicenseCity&quot;].ToString();
                WODTO.LicenseState = dr[&quot;LicenseState&quot;].ToString();
                WODTO.Insurance = dr[&quot;Insurance&quot;].ToString();
                WODTO.ContractID = dr[&quot;ContractID&quot;].ToString().ToInt32_2();
                WODTO.WorkOrderNo = dr[&quot;WorkOrderNo&quot;].ToString();
                WODTO.SystemWONo = dr[&quot;SystemWONo&quot;].ToString();
                WODTO.ExtReference = result.Tables[0].Columns.Contains(&quot;ExtReference&quot;) ? dr[&quot;ExtReference&quot;].ToString() : string.Empty;
                WODTO.WorkOrderRequestedBy = dr[&quot;RequestedBy&quot;].ToString();
                WODTO.WorkOrderDate = dr[&quot;WorkOrderDate&quot;].ToDateTime_MWCulture();
                WODTO.Description = dr[&quot;Description&quot;].ToString();
                WODTO.Notes = dr[&quot;Notes&quot;].ToString();
                WODTO.ScopeOfWork = dr[&quot;ScopeOfWork&quot;].ToString();
                WODTO.WithMaterial = dr[&quot;WithMaterial&quot;].ToString().ToBoolean2();
                WODTO.WithLabour = dr[&quot;WithLabour&quot;].ToString().ToBoolean2();
                WODTO.WithEquipment = dr[&quot;WithEquipment&quot;].ToString().ToBoolean2();
                WODTO.ContractorID =
                    (string.IsNullOrEmpty(dr[&quot;ContractorID&quot;].ToString()) ? &quot;0&quot; : dr[&quot;ContractorID&quot;].ToString()).
                        ToInt32_2();
                WODTO.Contractor = dr[&quot;Contractor&quot;].ToString();
                WODTO.StartDate = dr[&quot;StartDate&quot;].ToDateTime_MWCulture();
                WODTO.EndDate = dr[&quot;EndDate&quot;].ToDateTime_MWCulture();
                WODTO.Status = dr[&quot;Status&quot;].ToString().ToInt32_2();
                WODTO.TotalAmount =
                    (string.IsNullOrEmpty(dr[&quot;TotalAmount&quot;].ToString()) ? &quot;0&quot; : dr[&quot;TotalAmount&quot;].ToString()).ToDecimal2
                        ();
                WODTO.ValidateWOQty =
                    bool.Parse(string.IsNullOrEmpty(dr[&quot;ValidateWOQty&quot;].ToString())
                                   ? &quot;False&quot;
                                   : dr[&quot;ValidateWOQty&quot;].ToString())
                        ? 1
                        : 0;
                if (WODTO.Status &gt;= WOConstants.STAGE_DRAFT)
                {
                    WODTO.CreatedByID = dr[&quot;CreatedByID&quot;].ToString().ToInt32_2();
                    WODTO.CreatedOn = dr[&quot;CreatedOn&quot;].ToDateTime_MWCulture();
                    User user = UserManager.Instance.GetAUser(WODTO.CreatedByID);
                    WODTO.CreatedBy = ((user != null) ? user.UserName : string.Empty);

                    if (WODTO.Status &gt;= WOConstants.STAGE_APPROVED &amp;&amp; WODTO.Status != WOConstants.STAGE_DRAFT_AMENDMENT)
                    {
                        WODTO.ApprovedByID =
                            (string.IsNullOrEmpty(dr[&quot;ApprovedByID&quot;].ToString()) ? &quot;0&quot; : dr[&quot;ApprovedByID&quot;].ToString()).
                                ToInt32_2();
                        WODTO.ApprovedOn = dr[&quot;ApprovedOn&quot;].ToDateTime_MWCulture();
                        user = UserManager.Instance.GetAUser(WODTO.ApprovedByID);
                        WODTO.ApprovedBy = ((user != null) ? user.UserName : string.Empty);

                        if (WODTO.Status &gt;= WOConstants.STAGE_ISSUED &amp;&amp;
                            WODTO.Status != WOConstants.STAGE_APPROVE_AMENDMENT)
                        {
                            WODTO.IssuedByID =
                                (string.IsNullOrEmpty(dr[&quot;IssuedByID&quot;].ToString()) ? &quot;0&quot; : dr[&quot;ApprovedByID&quot;].ToString())
                                    .ToInt32_2();
                            WODTO.IssuedOn = dr[&quot;IssuedOn&quot;].ToDateTime_MWCulture();
                            user = UserManager.Instance.GetAUser(WODTO.IssuedByID);
                            WODTO.IssuedBy = ((user != null) ? user.UserName : string.Empty);

                            if (WODTO.Status &gt;= WOConstants.STAGE_CLOSED &amp;&amp;
                                WODTO.Status != WOConstants.STAGE_APPROVE_AMENDMENT)
                            {
                                WODTO.ClosedByID =
                                    (string.IsNullOrEmpty(dr[&quot;ClosedByID&quot;].ToString())
                                         ? &quot;0&quot;
                                         : dr[&quot;ClosedByID&quot;].ToString()).ToInt32_2();
                                WODTO.ClosedOn = dr[&quot;ClosedOn&quot;].ToDateTime_MWCulture();
                                user = UserManager.Instance.GetAUser(WODTO.ClosedByID);
                                WODTO.ClosedBy = ((user != null) ? user.UserName : string.Empty);
                            }
                        }
                    }
                }
                //Load Items here

                WODTO.WorkOrderItems.Tables.Add(result.Tables[1].Copy());

                WODTO.WorkOrderType = dr[&quot;WorkOrderType&quot;].Equals(DBNull.Value) ? &quot;W&quot; : dr[&quot;WorkOrderType&quot;].ToString();
                WODTO.WorkOrderActivities.Tables.Add(result.Tables[2].Copy());

                return WODTO;
            }
        }

        internal int CreateAWOPosting(int WOPostingID, int WOID, int DWRID, DateTime PostedDate, string Remarks,
                                      Decimal Amount, string PostingXml, int UID, string UserName)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            dictionary.Add(&quot;OUTPUT&quot;, null);
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    ACTIWOStoredProcedure.usp_ACTIWOCreatePosting, dictionary, WOPostingID, WOID, DWRID, PostedDate,
                    Remarks, Amount, PostingXml, UID, UserName);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal DataSet GetWOPosting(int WOPostingID, int WOID, int DWRID)
        {
            lock (lockObj)
            {
                return ComponentHelper.Instance.ExecuteDataSet(ACTIWOStoredProcedure.usp_ACTIWOGetWOPosting, null,
                                                               WOPostingID, WOID, DWRID);
            }
        }

        internal DataSet GetItemPostingsByWOPostingID(string WOPostingIDList)
        {
            lock (lockObj)
            {
                return
                    ComponentHelper.Instance.ExecuteDataSet(
                        ACTIWOStoredProcedure.usp_ACTIWOGetItemPostingsByWOPostingID, null, WOPostingIDList);
            }
        }

        internal bool CreateWorkOrderQuotations(int QID, int WorkOrderID, int ContractorID, string Contractor,
                                                DateTime Date, string quotNotes, Decimal TotalAmount, int Status,
                                                string ItemXML, int Output)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    ACTIWOStoredProcedure.usp_ACTIWOCreateQuotation, dictionary, QID, WorkOrderID, ContractorID,
                    Contractor, Date, quotNotes, TotalAmount, Status, ItemXML, Output);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return (retVal == -1) ? false : true;
        }

        internal int SetQuotationStatus(string QuotationIDList, int Status)
        {
            int retVal = 0;
            var dictionary = new Dictionary&lt;string, object&gt;();
            lock (lockObj)
            {
                ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    ACTIWOStoredProcedure.usp_ACTIWOSetQuotationStatus, dictionary, QuotationIDList, Status);
                retVal = dictionary[&quot;OUTPUT&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        internal DataSet ApproveWorkOrder(int WorkOrderId, DateTime ApprovedOn, int ApprovedBy, bool IsApprove,
                                          string WorkOrderType)
        {
            lock (lockObj)
            {
                return ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDApproveWO, null, WorkOrderId,
                                                               ApprovedOn, ApprovedBy, IsApprove, WorkOrderType);
            }
        }

        internal DataSet ValidateEquipmentHireOrderVersion(string EquipmentID, int ActualEquipmentID, decimal Quantity,
                                                           string ModeType)
        {
            lock (lockObj)
            {
                return
                    ComponentHelper.Instance.ExecuteDataSet(
                        WOStoredProcedure.usp_WORKORDValidateEquipmentHireOrderVersion, null, EquipmentID,
                        ActualEquipmentID, Quantity, ModeType);
            }
        }

        /// &lt;summary&gt;
        /// Returns the Prepayment Recovery rules based on module and Instanceid
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ModuleID&quot;&gt;LIBRARY for library,CONTMGT for settings and WORKORD for work order&lt;/param&gt;
        /// &lt;param name=&quot;InstanceId&quot;&gt;0 for library, ContractID for contract settings and WOID for Workorder&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public DataSet GetPrepaymentRecoveryRules(string ModuleID, int InstanceID)
        {
            lock (lockObj)
            {
                return ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_CONTMGTGetPrepayRetentionRules,
                                                               null, &quot;PREPAY&quot;, ModuleID, InstanceID, &quot;S&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Returns the retention rules based on module and Instanceid
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ModuleID&quot;&gt;LIBRARY for library,CONTMGT for settings and WORKORD for work order&lt;/param&gt;
        /// &lt;param name=&quot;InstanceId&quot;&gt;0 for library, ContractID for contract settings and WOID for Workorder&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public DataSet GetRetentionRules(string ModuleID, int InstanceID)
        {
            lock (lockObj)
            {
                return ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_CONTMGTGetPrepayRetentionRules,
                                                               null, &quot;RETENTION&quot;, ModuleID, InstanceID, &quot;S&quot;);
            }
        }

        public DataSet GetRecoveryRetentionDetails(string ModuleID, int InstanceID)
        {
            lock (lockObj)
            {
                return ComponentHelper.Instance.ExecuteDataSet(
                    WOStoredProcedure.usp_WORKORDGetRecoveryRetentionDetails, null, ModuleID, InstanceID);
            }
        }

        /// &lt;summary&gt;
        /// Validates deletion of BOQ while creating WO versions
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;workOrderID&quot;&gt;Work order ID&lt;/param&gt;
        /// &lt;param name=&quot;itemID&quot;&gt;The BOQ that is being deleted&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public int ValidateBOQDelete(int workOrderID, int itemID)
        {
            int retVal = 0;

            lock (lockObj)
            {
                var dictionary = new Dictionary&lt;string, object&gt;();
                ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDValidateBOQDelete, dictionary,
                                                        workOrderID, itemID);
                retVal = dictionary[&quot;Exists&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        /// &lt;summary&gt;
        /// Validating addition of prepayment rule while creating versions for a work order.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;workOrderId&quot;&gt;Work order ID&lt;/param&gt;
        /// &lt;param name=&quot;recoveryId&quot;&gt;The prepayment rule id which is selected&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public int ValidatePrepaymentRule(int workOrderId, int recoveryId)
        {
            int retVal = 0;
            lock (lockObj)
            {
                var dictionary = new Dictionary&lt;string, object&gt;();
                ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_WORKORDValidatePrepaymentRule, dictionary,
                                                        0, workOrderId, recoveryId);
                retVal = dictionary[&quot;isValid&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        public int CUDPrepaymentTypes(int mohTypeID, string mohType, string description, string mode)
        {
            int retVal = 0;
            lock (lockObj)
            {
                var dictionary = new Dictionary&lt;string, object&gt;();
                ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_LIBRARYCUDPrepaymentTypes, dictionary,
                                                        mohTypeID, mohType, description, mode);
                retVal = dictionary[&quot;Status&quot;].ToString().ToInt32_2();
            }
            return retVal;
        }

        public DataTable GetPrepaymentTypes(int mohId)
        {
            lock (lockObj)
            {
                return
                    ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.usp_LIBRARYGetprepaymentTypesForType, null,
                                                            mohId).Tables[0];
            }
        }

        public DataSet GetMinMaxSubmitionDates(string AXCompany, int InstanceID, string ModuleID, string TableName,
                                               string InstanceIDColumn, string CreateDateColumn, bool IsModuleIdReq)
        {
            return ComponentHelper.Instance.ExecuteDataSet(StoredProcedure.usp_WORKFLWGetMinMaxApprovalDates, null,
                                                           AXCompany, InstanceID, ModuleID, TableName, InstanceIDColumn,
                                                           CreateDateColumn, IsModuleIdReq);
        }

        public DateTime GetWOStartDate(int workOrderId)
        {
            DataSet ds = ComponentHelper.Instance.ExecuteDataSet(WOStoredProcedure.ust_WORKORDGetWOStartDate, null,
                                                                 workOrderId);
            return Convert.ToDateTime(ds.Tables[0].Rows[0][&quot;StartDate&quot;]);
        }

        public void SaveCommitmentsAndItems(int workorderId,int? previousWOId)
        {
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.usp_WORKORDSaveCommitmentAndItems, null, workorderId, previousWOId);
        }

        public void UndoIssueAmmendment(int workorderId)
        {
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(WOStoredProcedure.usp_WORKORDUndoIssueAmmendment, null, workorderId);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,83,0],[20,9,20,62,0],[24,13,24,14,0],[25,17,25,30,0],[26,17,26,18,0],[27,21,27,39,0],[27,40,27,91,0],[28,21,28,82,0],[29,21,29,60,0],[30,25,30,75,0],[32,21,32,50,0],[34,13,34,14,0],[37,9,37,56,0],[39,9,39,35,0],[40,9,40,10,0],[41,9,41,10,0],[44,9,44,10,0],[45,13,45,34,0],[46,13,46,122,0],[47,17,47,34,0],[48,13,48,28,0],[49,13,49,63,0],[50,13,50,27,0],[51,13,51,14,0],[52,17,72,136,0],[74,17,74,70,0],[75,13,75,14,0],[76,13,76,27,0],[77,9,77,10,0],[80,9,80,10,0],[81,13,81,28,0],[82,13,82,63,0],[83,13,83,27,0],[84,13,84,14,0],[85,17,89,115,0],[90,17,90,70,0],[91,13,91,14,0],[92,13,92,27,0],[93,9,93,10,0],[96,9,96,10,0],[97,13,97,28,0],[98,13,98,63,0],[99,13,99,27,0],[100,13,100,14,0],[101,17,105,115,0],[106,17,106,70,0],[107,13,107,14,0],[108,13,108,27,0],[109,9,109,10,0],[111,9,111,10,0],[113,13,113,63,0],[114,13,114,27,0],[115,13,115,14,0],[116,17,117,123,0],[118,13,118,14,0],[119,13,119,29,0],[120,9,120,10,0],[123,9,123,10,0],[124,13,124,28,0],[125,13,125,63,0],[126,13,126,27,0],[127,13,127,14,0],[128,17,132,115,0],[133,17,133,70,0],[134,13,134,14,0],[135,13,135,27,0],[136,9,136,10,0],[139,9,139,10,0],[140,13,140,28,0],[141,13,141,63,0],[142,13,142,27,0],[143,13,143,14,0],[144,17,145,117,0],[146,17,146,70,0],[147,13,147,14,0],[148,13,148,50,0],[149,9,149,10,0],[154,9,154,10,0],[155,13,155,28,0],[156,13,156,63,0],[157,13,157,27,0],[158,13,158,14,0],[159,17,161,66,0],[162,17,162,70,0],[163,13,163,14,0],[164,13,164,27,0],[165,9,165,10,0],[169,9,169,10,0],[170,13,170,28,0],[171,13,171,63,0],[172,13,172,27,0],[173,13,173,14,0],[174,17,176,66,0],[177,17,177,70,0],[178,13,178,14,0],[179,13,179,27,0],[180,9,180,10,0],[183,9,183,10,0],[184,20,184,85,0],[185,13,185,14,0],[186,17,186,83,0],[187,17,187,88,0],[188,17,188,77,0],[189,17,189,95,0],[190,17,190,73,0],[192,17,192,18,0],[193,21,193,50,0],[194,21,194,93,0],[196,17,196,22,0],[197,17,197,18,0],[198,21,198,34,0],[201,9,201,10,0],[213,9,213,10,0],[214,20,214,85,0],[215,13,215,14,0],[216,17,216,99,0],[217,17,217,81,0],[218,17,218,88,0],[219,17,219,84,0],[220,17,220,74,0],[222,17,222,18,0],[223,21,223,50,0],[224,21,224,98,0],[225,21,225,38,0],[226,25,226,38,0],[227,17,227,18,0],[228,17,228,22,0],[229,17,229,18,0],[230,21,230,34,0],[232,17,232,29,0],[234,9,234,10,0],[239,9,239,10,0],[240,13,240,28,0],[241,13,241,63,0],[242,13,242,27,0],[243,13,243,14,0],[244,17,246,88,0],[247,17,247,70,0],[248,13,248,14,0],[249,13,249,50,0],[250,9,250,10,0],[253,9,253,10,0],[254,20,254,85,0],[255,13,255,14,0],[256,17,256,99,0],[257,17,257,88,0],[259,17,259,62,0],[261,9,261,10,0],[264,9,264,10,0],[265,20,265,85,0],[266,13,266,14,0],[267,17,267,96,0],[268,17,268,88,0],[269,17,269,88,0],[271,17,271,52,0],[274,9,274,10,0],[277,9,277,10,0],[279,13,279,27,0],[280,13,280,14,0],[281,17,282,79,0],[283,13,283,14,0],[284,13,284,27,0],[285,9,285,10,0],[288,9,288,10,0],[290,13,290,27,0],[291,13,291,14,0],[292,17,293,92,0],[294,13,294,14,0],[295,13,295,27,0],[296,9,296,10,0],[299,9,299,10,0],[300,13,300,28,0],[301,13,301,27,0],[302,13,302,14,0],[303,17,305,95,0],[306,13,306,14,0],[307,13,307,39,0],[308,9,308,10,0],[311,9,311,10,0],[312,13,312,28,0],[313,13,313,63,0],[314,13,314,27,0],[315,13,315,14,0],[316,17,317,107,0],[318,17,318,70,0],[319,13,319,14,0],[320,13,320,27,0],[321,9,321,10,0],[324,9,324,10,0],[325,20,325,85,0],[326,13,326,14,0],[327,17,327,95,0],[328,17,328,89,0],[329,17,329,74,0],[330,17,330,53,0],[332,9,332,10,0],[335,9,335,10,0],[336,20,336,85,0],[337,13,337,14,0],[338,17,338,79,0],[339,17,339,75,0],[340,17,340,73,0],[342,17,342,18,0],[343,21,343,50,0],[344,21,344,98,0],[345,21,345,38,0],[346,25,346,38,0],[347,17,347,18,0],[348,17,348,22,0],[349,17,349,18,0],[350,21,350,34,0],[352,17,352,29,0],[354,9,354,10,0],[357,9,357,10,0],[359,13,359,27,0],[360,13,360,14,0],[361,17,362,95,0],[363,13,363,14,0],[364,13,364,71,0],[365,9,365,10,0],[368,9,368,10,0],[370,13,370,27,0],[371,13,371,14,0],[372,17,373,113,0],[374,13,374,14,0],[375,13,375,59,0],[376,9,376,10,0],[379,9,379,10,0],[381,13,381,27,0],[382,13,382,14,0],[383,17,384,101,0],[385,13,385,14,0],[386,13,386,45,0],[387,9,387,10,0],[391,9,391,10,0],[392,13,394,120,0],[395,9,395,10,0],[399,9,399,10,0],[401,13,401,27,0],[402,13,402,14,0],[403,17,405,85,0],[406,13,406,14,0],[407,13,407,27,0],[408,9,408,10,0],[411,9,411,10,0],[413,13,413,27,0],[414,13,414,14,0],[415,17,415,117,0],[417,17,417,53,0],[418,21,418,33,0],[420,17,420,55,0],[421,17,421,48,0],[422,17,422,49,0],[423,17,423,109,0],[424,17,424,64,0],[425,17,425,66,0],[426,17,426,68,0],[427,17,427,62,0],[428,17,428,76,0],[429,17,429,66,0],[430,17,430,64,0],[431,17,431,135,0],[432,17,432,75,0],[433,17,433,82,0],[434,17,434,66,0],[435,17,435,54,0],[436,17,436,66,0],[437,17,437,70,0],[438,17,438,77,0],[439,17,439,83,0],[440,17,442,37,0],[443,17,443,64,0],[444,17,444,74,0],[445,17,445,70,0],[446,17,446,68,0],[447,17,449,28,0],[450,17,455,29,0],[456,17,456,61,0],[457,17,457,18,0],[458,21,458,82,0],[459,21,459,78,0],[460,21,460,82,0],[461,21,461,87,0],[463,21,463,121,0],[464,21,464,22,0],[465,25,467,45,0],[468,25,468,84,0],[469,25,469,82,0],[470,25,470,92,0],[472,25,473,81,0],[474,25,474,26,0],[475,29,477,50,0],[478,29,478,84,0],[479,29,479,84,0],[480,29,480,94,0],[482,29,483,85,0],[484,29,484,30,0],[485,33,488,85,0],[489,33,489,88,0],[490,33,490,88,0],[491,33,491,98,0],[492,29,492,30,0],[493,25,493,26,0],[494,21,494,22,0],[495,17,495,18,0],[498,17,498,74,0],[500,17,500,119,0],[501,17,501,53,0],[502,17,502,18,0],[504,21,504,83,0],[505,17,505,18,0],[507,17,507,166,0],[509,17,509,30,0],[511,9,511,10,0],[514,9,514,10,0],[515,13,515,28,0],[516,13,516,63,0],[517,13,517,27,0],[518,13,518,14,0],[519,17,520,105,0],[521,17,521,70,0],[522,13,522,14,0],[523,13,523,27,0],[524,9,524,10,0],[527,9,527,10,0],[528,20,528,85,0],[529,13,529,14,0],[530,17,530,85,0],[531,17,531,73,0],[532,17,532,77,0],[533,17,533,46,0],[534,13,534,14,0],[535,9,535,10,0],[538,9,538,10,0],[539,20,539,85,0],[540,13,540,14,0],[541,17,541,89,0],[542,17,542,36,0],[543,21,543,96,0],[545,21,545,92,0],[547,17,547,52,0],[549,9,549,10,0],[552,9,552,10,0],[553,20,553,85,0],[554,13,554,14,0],[555,17,555,86,0],[557,17,557,81,0],[558,17,558,42,0],[559,21,559,92,0],[560,17,560,77,0],[561,17,561,96,0],[563,9,563,10,0],[566,9,566,10,0],[568,13,568,27,0],[569,13,569,14,0],[570,17,572,91,0],[573,13,573,14,0],[574,13,574,72,0],[575,9,575,10,0],[579,9,579,10,0],[581,13,581,27,0],[582,13,582,14,0],[583,17,585,84,0],[586,13,586,14,0],[587,13,587,79,0],[588,17,588,76,0],[590,17,590,29,0],[591,9,591,10,0],[594,9,594,10,0],[596,13,596,27,0],[597,13,597,14,0],[598,17,600,91,0],[601,13,601,14,0],[602,13,602,72,0],[603,9,603,10,0],[611,9,611,10,0],[612,20,612,85,0],[613,13,613,14,0],[614,17,614,88,0],[615,17,615,85,0],[617,17,617,18,0],[618,21,618,56,0],[620,17,620,22,0],[621,17,621,18,0],[622,21,622,33,0],[625,9,625,10,0],[628,9,628,10,0],[630,13,630,27,0],[631,13,631,14,0],[632,17,633,84,0],[634,13,634,14,0],[635,13,635,37,0],[636,9,636,10,0],[639,9,639,10,0],[641,13,641,27,0],[642,13,642,14,0],[643,17,644,95,0],[645,13,645,14,0],[646,13,646,72,0],[647,9,647,10,0],[651,9,651,10,0],[652,13,653,79,0],[654,9,654,10,0],[659,9,659,78,1],[660,9,660,62,1],[664,13,664,14,1],[665,17,665,30,1],[666,17,666,18,1],[667,21,667,39,1],[667,40,667,86,1],[668,21,668,82,1],[669,21,669,60,1],[670,25,670,70,1],[672,21,672,50,1],[674,13,674,14,1],[677,9,677,56,1],[679,9,679,30,1],[680,9,680,10,1],[681,9,681,10,1],[684,9,684,10,0],[685,13,685,34,0],[686,13,686,28,0],[687,13,687,63,0],[688,13,688,27,0],[689,13,689,14,0],[690,17,697,81,0],[699,17,699,70,0],[700,13,700,14,0],[701,13,701,27,0],[702,9,702,10,0],[706,9,706,10,0],[707,13,707,28,0],[708,13,708,63,0],[709,13,709,27,0],[710,13,710,14,0],[711,17,713,66,0],[714,17,714,70,0],[715,13,715,14,0],[716,13,716,27,0],[717,9,717,10,0],[722,9,722,10,0],[723,13,723,28,0],[724,13,724,63,0],[725,13,725,27,0],[726,13,726,14,0],[727,17,729,66,0],[730,17,730,70,0],[731,13,731,14,0],[732,13,732,27,0],[733,9,733,10,0],[739,9,739,10,0],[740,13,740,28,0],[741,13,741,63,0],[742,13,742,44,0],[743,13,743,27,0],[744,13,744,14,0],[745,17,747,97,0],[748,17,748,70,0],[749,13,749,14,0],[750,13,750,50,0],[751,9,751,10,0],[754,9,754,10,0],[756,13,756,27,0],[757,13,757,14,0],[758,17,759,79,0],[760,13,760,14,0],[761,13,761,27,0],[762,9,762,10,0],[765,9,765,10,0],[767,13,767,27,0],[768,13,768,14,0],[769,17,770,79,0],[771,13,771,14,0],[772,13,772,27,0],[773,9,773,10,0],[776,9,776,10,0],[778,13,778,27,0],[779,13,779,14,0],[780,17,781,92,0],[782,13,782,14,0],[783,13,783,27,0],[784,9,784,10,0],[787,9,787,10,0],[789,13,789,27,0],[790,13,790,14,0],[791,17,792,91,0],[793,13,793,14,0],[794,13,794,27,0],[795,9,795,10,0],[798,9,798,10,0],[799,13,799,28,0],[800,13,800,27,0],[801,13,801,14,0],[802,17,804,97,0],[805,13,805,14,0],[806,13,806,39,0],[807,9,807,10,0],[810,9,810,10,0],[812,13,812,27,0],[813,13,813,14,0],[814,17,815,79,0],[817,17,817,53,0],[818,21,818,33,0],[820,17,820,55,0],[821,17,821,97,0],[822,17,822,18,0],[823,21,823,121,0],[824,21,824,51,0],[825,17,825,18,0],[826,17,826,48,0],[827,17,827,49,0],[828,17,828,109,0],[829,17,829,64,0],[830,17,830,66,0],[831,17,831,68,0],[832,17,832,62,0],[833,17,833,76,0],[834,17,834,66,0],[835,17,835,64,0],[836,17,836,135,0],[837,17,837,75,0],[838,17,838,82,0],[839,17,839,66,0],[840,17,840,54,0],[841,17,841,66,0],[842,17,842,81,0],[843,17,843,77,0],[844,17,844,83,0],[845,17,847,37,0],[848,17,848,64,0],[849,17,849,74,0],[850,17,850,70,0],[851,17,851,68,0],[852,17,854,28,0],[855,17,860,29,0],[861,17,861,61,0],[862,17,862,18,0],[863,21,863,82,0],[864,21,864,78,0],[865,21,865,82,0],[866,21,866,87,0],[868,21,868,121,0],[869,21,869,22,0],[870,25,872,45,0],[873,25,873,84,0],[874,25,874,82,0],[875,25,875,92,0],[877,25,878,81,0],[879,25,879,26,0],[880,29,882,50,0],[883,29,883,84,0],[884,29,884,84,0],[885,29,885,94,0],[887,29,888,85,0],[889,29,889,30,0],[890,33,893,85,0],[894,33,894,88,0],[895,33,895,88,0],[896,33,896,98,0],[897,29,897,30,0],[898,25,898,26,0],[899,21,899,22,0],[900,17,900,18,0],[903,17,903,74,0],[905,17,905,119,0],[906,17,906,79,0],[908,17,908,30,0],[910,9,910,10,0],[914,9,914,10,0],[915,13,915,28,0],[916,13,916,63,0],[917,13,917,44,0],[918,13,918,27,0],[919,13,919,14,0],[920,17,922,65,0],[923,17,923,70,0],[924,13,924,14,0],[925,13,925,27,0],[926,9,926,10,0],[929,9,929,10,0],[930,13,930,27,0],[931,13,931,14,0],[932,17,933,90,0],[935,9,935,10,0],[938,9,938,10,0],[939,13,939,27,0],[940,13,940,14,0],[941,17,943,110,0],[945,9,945,10,0],[950,9,950,10,0],[951,13,951,28,0],[952,13,952,63,0],[953,13,953,27,0],[954,13,954,14,0],[955,17,957,88,0],[958,17,958,70,0],[959,13,959,14,0],[960,13,960,50,0],[961,9,961,10,0],[964,9,964,10,0],[965,13,965,28,0],[966,13,966,63,0],[967,13,967,27,0],[968,13,968,14,0],[969,17,970,110,0],[971,17,971,70,0],[972,13,972,14,0],[973,13,973,27,0],[974,9,974,10,0],[978,9,978,10,0],[979,13,979,27,0],[980,13,980,14,0],[981,17,982,114,0],[984,9,984,10,0],[988,9,988,10,0],[989,13,989,27,0],[990,13,990,14,0],[991,17,994,64,0],[996,9,996,10,0],[1005,9,1005,10,1],[1006,13,1006,27,1],[1007,13,1007,14,1],[1008,17,1009,107,1],[1011,9,1011,10,1],[1020,9,1020,10,0],[1021,13,1021,27,0],[1022,13,1022,14,0],[1023,17,1024,110,0],[1026,9,1026,10,0],[1029,9,1029,10,0],[1030,13,1030,27,0],[1031,13,1031,14,0],[1032,17,1033,107,0],[1035,9,1035,10,0],[1044,9,1044,10,0],[1045,13,1045,28,0],[1047,13,1047,27,0],[1048,13,1048,14,0],[1049,17,1049,67,0],[1050,17,1051,78,0],[1052,17,1052,70,0],[1053,13,1053,14,0],[1054,13,1054,27,0],[1055,9,1055,10,0],[1064,9,1064,10,0],[1065,13,1065,28,0],[1066,13,1066,27,0],[1067,13,1067,14,0],[1068,17,1068,67,0],[1069,17,1070,85,0],[1071,17,1071,71,0],[1072,13,1072,14,0],[1073,13,1073,27,0],[1074,9,1074,10,0],[1077,9,1077,10,0],[1078,13,1078,28,0],[1079,13,1079,27,0],[1080,13,1080,14,0],[1081,17,1081,67,0],[1082,17,1083,96,0],[1084,17,1084,70,0],[1085,13,1085,14,0],[1086,13,1086,27,0],[1087,9,1087,10,0],[1090,9,1090,10,0],[1091,13,1091,27,0],[1092,13,1092,14,0],[1093,17,1095,78,0],[1097,9,1097,10,0],[1101,9,1101,10,0],[1102,13,1104,93,0],[1105,9,1105,10,0],[1108,9,1108,10,0],[1109,13,1110,79,0],[1111,13,1111,74,0],[1112,9,1112,10,0],[1115,9,1115,10,0],[1116,13,1116,162,0],[1117,9,1117,10,0],[1120,9,1120,10,0],[1121,13,1121,145,0],[1122,9,1122,10,0]]);
    </script>
  </body>
</html>