<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Fixed Asset Utilisation and Breakdown\FixedAssetsUtilisationAndBreakDown.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.Linq;
using System.Linq;
using System.Reflection;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.LibraryBL;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.ProjectDAC;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Construction.ContractManager.BusinessLayer.DTO;
using Aurigo.Brix.Construction.ContractManager.FAUtilisationAndBreakDownUI.BL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.DataAccess.Core;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.WebUI.UltraWebGrid;
using Infragistics.WebUI.WebSchedule;
using Microsoft.Practices.EnterpriseLibrary.Data.Configuration;
using Resource = Aurigo.AMP3.Core.BusinessLayer.DTO.Resource;
using System.Globalization;

namespace Aurigo.Brix.Construction.ContractManager.FAUtilisationAndBreakDownUI
{
    public partial class FixedAssetsUtilisationAndBreakDown : BrixPageBase, IWorkflowEnabled
    {
        private static string moduleCurrency, libraryCurrency;

        private GenericPickerControl fixedAssetPicker;
        private GenericPickerControl itemPicker;
        private GenericPickerControl sparePartPicker;

        private int parentId
        {
            get { return Convert.ToInt32(Request[&quot;ParentID&quot;]); }
        }

        private int projectId
        {
            get { return Convert.ToInt32(Request[&quot;PID&quot;]); }
        }

        private int instanceId
        {
            get { return Convert.ToInt32(hdnInstanceID.Value); }
            set { hdnInstanceID.Value = value.ToString(); }
        }

        private string mode { get; set; }

        private string logbookNo { get; set; }

        private DataTable spareParts { get; set; }

        private bool isHiredEquipmentLog { get; set; }

        private static DataTable workOrderSource { get; set; }

        /// &lt;summary&gt;
        /// Gets the Project Mode : I-Integration, L-Live
        /// &lt;/summary&gt;
        private string ProjectMode
        {
            get { return (CacheManager.Instance.IsIntegrated(projectId) ? &quot;I&quot; : &quot;L&quot;); }
        }

        /// &lt;summary&gt;
        /// Gets the Integration Cutoff Date
        /// &lt;/summary&gt;
        private DateTime IntegrationCutoffDate
        {
            get { return (DateTime)Session[Constants.APP_IntegrationCutoffDate]; }
        }

        /// &lt;summary&gt;
        /// Gets the Default Record Date
        /// &lt;/summary&gt;
        private DateTime DefaultRecordDate
        {
            get { return (DateTime)Session[Constants.APP_DefaultRecordDate]; }
        }

        private bool IsERPConnected
        {
            get { return IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX); }
        }

        #region IWorkflowEnabled Members

        public void CancelHandler(object sender, bool bAfterSave, out string sRedirectTo)
        {
            throw new NotImplementedException();
        }

        public string FormInstanceId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;InstanceID&quot;])
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;InstanceID&quot;], out id) ? id : -1;
                return id.ToString();
            }
        }

        private string _formKey;
        public string FormKey { get { return _formKey; } }

        public string FormName
        {
            get { return &quot;XEQPLOG&quot;; }
        }

        public string ClientValidationFunction
        {
            get { return &quot;SaveForm()&quot;; }
        }

        public bool IsOldWorkflow
        {
            get { return true; }
        }

        public int PID
        {
            get { return Request.QueryString[&quot;PID&quot;].ToInt32_2(); }
        }

        public int ParentModuleId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;ParentID&quot;])
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;ParentID&quot;], out id) ? id : -1;
                return id;
            }
        }

        public string PostCancelRedirectUrl
        {
            get
            {
                return string.Format(@&quot;~/Common/BrixListPage.aspx?Context=FIXUTBD&amp;PID={0}&amp;ContractID={1}&quot;, projectId,
                                     parentId);
            }
        }

        public string PostSaveRedirectUrl(string sSavedToken = &quot;&quot;)
        {
            return string.Format(@&quot;~/Common/BrixListPage.aspx?Context=FIXUTBD&amp;PID={0}&amp;ContractID={1}&quot;, projectId,
                                 parentId);
        }

        public bool SaveHandler(object sender, out string sSavedInstanceToken, out string sErrors,
                                out string sRedirectTo)
        {
            sSavedInstanceToken = &quot;&quot;;
            sErrors = &quot;&quot;;
            sRedirectTo = &quot;&quot;;


            SaveEquipmentLog(out sErrors, out sSavedInstanceToken);

            if (string.IsNullOrEmpty(sErrors) &amp;&amp; !(string.IsNullOrEmpty(sSavedInstanceToken)) &amp;&amp;
                sSavedInstanceToken != &quot;-1&quot;)
            {
                _formKey = string.Format(&quot;Log Book No.: {0}, Date: {1}&quot;, lblLogNo.Text, wdcDate.Value.ToDateTime_MWCulture().ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture));
                return true;
            }
            else
                return false;
        }

        #endregion

        protected override void OnInit(EventArgs e)
        {
            isHiredEquipmentLog = !string.IsNullOrEmpty(Request[&quot;IsHE&quot;]);

            ParentModuleID = &quot;CONTMGT&quot;;

            if (ProjectMode == &quot;I&quot;)
            {
                wdcDate.MaxDate = IntegrationCutoffDate.AddDays(-1);
            }
            else if (ProjectMode == &quot;L&quot;)
            {
                wdcDate.MaxDate = DateTime.UtcNow;
            }
            wdcDate.CalendarLayout.Culture = DateFormatCulture.GetDateFormatCulture();
            lblStdItemNo.Text = LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO) + &quot; :&quot;;
            lblTotalCost.Text = &quot;Total Cost in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL) +
                                &quot; :&quot;;
            lblEquipmentRate.Text = &quot;Equipment Rate in &quot; +
                                    LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL) + &quot; :&quot;;
            sparePartPicker = (ucSparePartPicker as GenericPickerControl);
            sparePartPicker.IsFilterXml = true;
            sparePartPicker.DisplayFilter = true;
            sparePartPicker.BackClicked += resourcePicker_BackClicked;
            sparePartPicker.ItemSelected += resourcePicker_SelectedIndexChanged;
            sparePartPicker.BindData += genericPicker_BindData;
            sparePartPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            sparePartPicker.DefaultSortColumn = IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;;
            sparePartPicker.EnableMultipleSelect = false;
            sparePartPicker.ModifyColumnProperties((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;), false, null, null, null, false, &quot;Resource ID&quot;);
            //sparePartPicker.ModifyColumnProperties(&quot;ResItemID&quot;, true, null, null, null, false);
            sparePartPicker.ModifyColumnProperties(&quot;Resource Group&quot;, true, null, null, null, false);
            sparePartPicker.ModifyColumnProperties(&quot;ProjId&quot;, true, null, null, null, false);
            sparePartPicker.ModifyColumnProperties(&quot;ID&quot;, true, null, null, null, false);
            sparePartPicker.ModifyColumnProperties(&quot;Rate&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE, null, false);
            sparePartPicker.Filters = GetFilters();

            fixedAssetPicker = (ucFixedAssetPicker as GenericPickerControl);
            fixedAssetPicker.IsFilterXml = true;
            fixedAssetPicker.DisplayFilter = true;
            fixedAssetPicker.BackClicked += fixedAssetPicker_BackClicked;
            fixedAssetPicker.ItemSelected += fixedAssetPicker_ItemSelected;
            fixedAssetPicker.BindData += fixedAssetPicker_BindData;
            fixedAssetPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            fixedAssetPicker.DefaultSortColumn = IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;;
            fixedAssetPicker.EnableMultipleSelect = false;
            fixedAssetPicker.ModifyColumnProperties((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;), false, null, null, null, false, &quot;Resource ID&quot;);
            //fixedAssetPicker.ModifyColumnProperties(&quot;ResItemID&quot;, true, null, null, null, false);
            fixedAssetPicker.ModifyColumnProperties(&quot;Resource Group&quot;, true, null, null, null, false);
            fixedAssetPicker.ModifyColumnProperties(&quot;ProjId&quot;, true, null, null, null, false);
            fixedAssetPicker.ModifyColumnProperties(&quot;ID&quot;, true, null, null, null, false);
            fixedAssetPicker.ModifyColumnProperties(&quot;HiredEquipmentID&quot;, true, null, null, null, false);
            fixedAssetPicker.ModifyColumnProperties(&quot;WorkOrderNo&quot;, true, null, null, null, false);
            fixedAssetPicker.ModifyColumnProperties(&quot;Unit&quot;, true, null, null, null, false);
            fixedAssetPicker.ModifyColumnProperties(&quot;Rate&quot;, true, null, null, null, false);
            fixedAssetPicker.StateMgmtContext = &quot;Resource Equipments&quot;;
            fixedAssetPicker.Filters = GetFilters();

            itemPicker = (ucItemPicker as GenericPickerControl);
            itemPicker.IsFilterXml = true;
            itemPicker.DisplayFilter = true;
            itemPicker.DefaultColumnVisibility = false;
            itemPicker.ItemSelected += itemPicker_ItemSelected;
            itemPicker.BindData += itemPicker_BindData;
            itemPicker.BackClicked += itemPicker_BackClicked;
            itemPicker.StateMgmtContext = &quot;EquipItems&quot;;
            itemPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            itemPicker.DefaultSortColumn = &quot;ItemID&quot;;
            itemPicker.EnableMultipleSelect = false;
            itemPicker.GridNoDataMessage = &quot;There are no &quot; + LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR)
                                           +
                                           &quot;&#39;s associated for the selected Equipment. Click &#39;apply filter&#39; to choose other &quot; +
                                           LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR);
            var filter = new BrixFilter[1];
            filter[0] = new BrixFilter();
            filter[0].Title = &quot;Mode&quot;;
            filter[0].Name = &quot;Mode&quot;;
            filter[0].FilterType = BrixFilter.Type.Radio;
            var vals = new Dictionary&lt;string, string&gt;();
            vals.Add(&quot;Equipment - BOQ&quot;, &quot;EquipItems&quot;);
            vals.Add(&quot;Other BOQs&quot;, &quot;OtherItems&quot;);
            filter[0].Values = vals;

            itemPicker.Filters = filter;

            itemPicker.ModifyColumnProperties(&quot;LineNo&quot;, false, 1, null, null, false, &quot;Line No&quot;);
            itemPicker.ModifyColumnProperties(&quot;StandardItemNo&quot;, false, 2, null, null, false, &quot;Standard Item No&quot;);
            itemPicker.ModifyColumnProperties(&quot;Description&quot;, false, 3, null, null, false, &quot;Description&quot;);
            itemPicker.ModifyColumnProperties(&quot;ContainerName&quot;, false, 4, null, null, false, &quot;Container Name&quot;);
            itemPicker.ModifyColumnProperties(&quot;Quantity&quot;, false, 5, null, null, false, &quot;Quantity&quot;);
            itemPicker.ModifyColumnProperties(&quot;Unit&quot;, false, 6, null, null, false, &quot;Unit&quot;);
            itemPicker.ModifyColumnProperties(&quot;UnitPrice&quot;, false, 7, null, null, false, &quot;Unit Price&quot;);
            itemPicker.ModifyColumnProperties(&quot;UnitCost&quot;, false, 8, null, null, false, &quot;Unit Cost&quot;);
            itemPicker.ModifyColumnProperties(&quot;BaseUnitCost&quot;, false, 9, null, null, false, &quot;Base Unit Cost&quot;);

            //itemPicker.SelectedIndexChanged += new ClickEventHandler(itemPicker_SelectedIndexChanged);
            //itemPicker.ModuleID = Constants.MODID_CONTMGT;
            //itemPicker.ParentInstanceID = parentId;
            itemPicker.EnableMultipleSelect = false;

            btnSparePartPicker.Click += btnSparePartPicker_Click;
            btnFixedAssetPicker.Click += btnFixedAssetPicker_Click;
            btnItemPicker.Click += btnItemPicker_Click;
            if (isHiredEquipmentLog)
            {
                wdcDate.AutoPostBack.ValueChanged = true;
                wdcDate.ValueChanged += wdcDate_ValueChanged;
                wneEquipmentRate.ReadOnly = true;
                hiredAmt.Visible = true;
            }

            ddlSparePart.SelectedRowChanged += ddlSparePart_SelectedIndexChanged;

            base.OnInit(e);
        }

        private void itemPicker_BindData(string Filter, string SortOrder, out DataSet DsResult, ref int CurrentPage,
                                         int PageSize, out int PageCount)
        {
            ModuleDetails moduleDetails =
                ModuleDetails.GetInstance(!string.IsNullOrEmpty(Request[&quot;Context&quot;]) ? Request[&quot;Context&quot;] : String.Empty);
            string mappedCompany = moduleDetails.GetMappedProjectInEis(
                Session[Constants.EIS_ADDITIONAL_INFO].ToString(),
                Request[&quot;PID&quot;], Request[&quot;ParentID&quot;]);

            DsResult = new DataSet();
            int TotalRecords;
            DsResult = FIXUTBDBL.Instance.GetItemsForEquipmentLog(mappedCompany, parentId, CurrentPage, PageSize,
                                                                  SortOrder, Filter, null,
                                                                  (isHiredEquipmentLog
                                                                       ? txtFixedAssetName.Text
                                                                       : txtFixedAssetID.Text), out TotalRecords);
            PageCount = (int)Math.Ceiling((double)TotalRecords / PageSize);
        }

        private void itemPicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            if (e.SelectedItems != null &amp;&amp; e.SelectedItems.Rows.Count &gt; 0)
            {
                txtStdItemNo.Text = e.SelectedItems.Rows[0][&quot;StandardItemNo&quot;].ToString();
                hdnItemID.Value = e.SelectedItems.Rows[0][&quot;ItemID&quot;].ToString();
            }
            itemPicker_BackClicked(sender, e);
        }

        private void btnItemPicker_Click(object sender, EventArgs e)
        {
            MainToolBar.Visible = divForm.Visible = false;
            divItemPicker.Visible = true;
            itemPicker.ChangeTableOrViewAndBind(&quot;&quot;);
        }

        private void itemPicker_SelectedIndexChanged(object sender, ClickEventArgs e)
        {
            //AMP3.Core.BusinessLayer.DTO.Item stdItem = itemPicker.GetDTOFromHTTP(e);
            //txtStdItemNo.Text = stdItem.StandardItemNo;
            //hdnItemID.Value = stdItem.ItemID.ToString();
            //itemPicker_BackClicked(sender, e);
        }

        private void itemPicker_BackClicked(object sender, EventArgs e)
        {
            MainToolBar.Visible = divForm.Visible = true;
            divItemPicker.Visible = false;
        }

        private void btnFixedAssetPicker_Click(object sender, EventArgs e)
        {
            divFixedAssetPicker.Visible = true;
            fixedAssetPicker.ChangeTableOrViewAndBind(&quot;&quot;);
            fixedAssetPicker.StateMgmtContext = &quot;Resource Equipments&quot;;
            MainToolBar.Visible = divForm.Visible = false;
        }

        private void fixedAssetPicker_BindData(string Filter, string SortOrder, out DataSet DsResult,
                                               ref int CurrentPage, int PageSize, out int PageCount)
        {
            DsResult = new DataSet();
            DataTable equipments = new BrixDataTable();


            if (!isHiredEquipmentLog)
            {
                ModuleDetails moduleDetails =
                    ModuleDetails.GetInstance(!string.IsNullOrEmpty(Request[&quot;Context&quot;])
                                                  ? Request[&quot;Context&quot;]
                                                  : String.Empty);
                string mappedCompany =
                    moduleDetails.GetMappedProjectInEis(Session[Constants.EIS_ADDITIONAL_INFO].ToString(),
                                                        Request[&quot;PID&quot;], Request[&quot;ParentID&quot;]);
                equipments = FIXUTBDBL.Instance.GetEquipmentsForEquipmentLog(mappedCompany, parentId, Filter,
                                                                             CurrentPage, PageSize, out PageCount);


                //LibraryInterface.Instance.GetResourceItems(mappedCompany, resourceType, ((CurrentPage - 1) * PageSize) + 1, PageSize, SortOrder, Filter).Copy());
            }

            else
            {
                int workOrderId = -1;
                int.TryParse(ddlWorkOrders.SelectedValue, out workOrderId);
                equipments = FIXUTBDBL.Instance.GetHiredEquipments(parentId, workOrderId, CurrentPage, PageSize,
                                                                   SortOrder, Filter, out PageCount);
                equipments.Columns[0].ColumnName = (IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;).ToString2();
            }
            DsResult.Tables.Add(equipments);
        }

        private void fixedAssetPicker_ItemSelected(object sender, ItemSelectedEventArgs e)
        {
            if (isHiredEquipmentLog)
            {
                txtFixedAssetName.Text = e.SelectedItems.Rows[0][(IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)].ToString();
                txtFixedAssetID.Text = e.SelectedItems.Rows[0][&quot;Serial No./ Registration No.&quot;].ToString();
                txtUnit.Text = e.SelectedItems.Rows[0][&quot;Unit&quot;].ToString();
                hdnHiredEquipmentID.Value = e.SelectedItems.Rows[0][&quot;HiredEquipmentID&quot;].ToString();
            }
            else
            {
                txtFixedAssetName.Text = e.SelectedItems.Rows[0][&quot;Description&quot;].ToString();
                txtFixedAssetID.Text = e.SelectedItems.Rows[0][(IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)].ToString();
            }
            decimal rate = Convert.ToDecimal(e.SelectedItems.Rows[0][&quot;Rate&quot;]);
            if (!moduleCurrency.Equals(libraryCurrency) &amp;&amp; !isHiredEquipmentLog)
                LocalizationManager.ApplyCurrencyConversion(libraryCurrency, moduleCurrency, ref rate,
                                                            Session[Constants.EIS_ADDITIONAL_INFO].ToString());

            wneEquipmentRate.Value = rate;
            ClearPartsWne();
            ClearExpWne();
            LoadMaterialIssueNos();
            LoadSpareParts();
            fixedAssetPicker_BackClicked(sender, e);
        }

        private void fixedAssetPicker_BackClicked(object sender, EventArgs e)
        {
            divFixedAssetPicker.Visible = false;
            MainToolBar.Visible = divForm.Visible = true;
        }

        private BrixFilter[] GetFilters()
        {
            var filters = new BrixFilter[2];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Resource ID :&quot;;
            filters[0].Name = (IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;);
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Description :&quot;;
            filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        private void resourcePicker_BackClicked(object sender, EventArgs e)
        {
            divSparePartPicker.Visible = false;
            MainToolBar.Visible = divForm.Visible = true;
        }

        private void resourcePicker_SelectedIndexChanged(object sender, ItemSelectedEventArgs e)
        {
            txtSparePart.Text = e.SelectedItems.Rows[0][&quot;Description&quot;].ToString();
            txtPartsResItemID.Text = e.SelectedItems.Rows[0][(IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)].ToString();
            hdnCurrentSparePartSize.Value = Convert.ToString(e.SelectedItems.Rows[0][&quot;Size&quot;]);
            hdnCurrentSparePartColour.Value = Convert.ToString(e.SelectedItems.Rows[0][&quot;Color&quot;]);
            hdnCurrentSparePartConfiguration.Value = Convert.ToString(e.SelectedItems.Rows[0][&quot;Configuration&quot;]);
            hdnCurrentSparePartResItemID.Value = e.SelectedItems.Rows[0][(IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)].ToString();
            // In case of bill there is no need to store this value. We don&#39;t need resitemid.            
            txtPartsUnit.Text = e.SelectedItems.Rows[0][&quot;Unit&quot;].ToString();
            decimal rate = Convert.ToDecimal(e.SelectedItems.Rows[0][&quot;Rate&quot;]);
            if (!moduleCurrency.Equals(libraryCurrency))
                LocalizationManager.ApplyCurrencyConversion(libraryCurrency, moduleCurrency, ref rate,
                                                            Session[Constants.EIS_ADDITIONAL_INFO].ToString());
            wnePartsRate.ValueDecimal = rate;
            resourcePicker_BackClicked(sender, e);
        }

        private void genericPicker_BindData(string Filter, string SortOrder, out DataSet DsResult, ref int CurrentPage,
                                            int PageSize, out int PageCount)
        {
            string resourceType = &quot;SpareParts&quot;;
            sparePartPicker.Currency = LocalizationManager.GetModuleCurrency(&quot;LIBRARY&quot;, null,
                                                                             Session[Constants.EIS_ADDITIONAL_INFO].
                                                                                 ToString());

            string materialHierarchyFilter = &quot;&lt;MaterialHierarchy type=&#39;txt&#39;&gt;True&lt;/MaterialHierarchy&gt;&quot;;
            string groupLevelFilter = &quot;&lt;IsGroupLevelResource type=&#39;txt&#39;&gt;False&lt;/IsGroupLevelResource&gt;&lt;/XMLRoot&gt;&quot;;
            if (string.IsNullOrEmpty(Filter))
                Filter = &quot;&lt;XMLRoot&gt;&quot; + materialHierarchyFilter + groupLevelFilter;
            else
                Filter = Filter.Replace(&quot;&lt;/XMLRoot&gt;&quot;, materialHierarchyFilter + groupLevelFilter);

            ModuleDetails moduleDetails =
                ModuleDetails.GetInstance(!string.IsNullOrEmpty(Request[&quot;Context&quot;]) ? Request[&quot;Context&quot;] : String.Empty);
            string mappedCompany = moduleDetails.GetMappedProjectInEis(
                Session[Constants.EIS_ADDITIONAL_INFO].ToString(),
                Request[&quot;PID&quot;], Request[&quot;ParentID&quot;]);

            DsResult = new DataSet();
            DataTable spares =
                LibraryInterface.Instance.GetResourceItems(mappedCompany, resourceType, ((CurrentPage - 1) * PageSize) + 1,
                                                           PageSize, SortOrder, Filter).Copy();
            DsResult.Tables.Add(spares);
            //PageCount = (int)Math.Ceiling(spares.Rows.Count.ToDecimal2() / PageSize);
            PageCount =
                (int)
                Math.Ceiling(
                    LibraryInterface.Instance.GetResourceItemsCount(mappedCompany, resourceType, 0, SortOrder, Filter) /
                    PageSize);
        }

        private void btnSparePartPicker_Click(object sender, EventArgs e)
        {
            divSparePartPicker.Visible = true;
            MainToolBar.Visible = divForm.Visible = false;
        }

        private DataTable GetFixedAssets()
        {
            string[] conParam =
                (&quot;Aurigo.Brix.Construction.ContractManager.FAUtilisationAndBreakDownUI.FixedAssetsUtilisationAndBreakDown;GetFixedAssets;&quot;)
                    .Split(&#39;;&#39;);

            int count = 0;
            var ds = new DataSet();

            string mappedCompany = &quot;&quot;;
            DataTable dtMap = IntegrationConnectorManager.Instance.GetERPObjectMapInfo(Request[&quot;ParentID&quot;],
                                                                                       AMP3Object.CONTMGT, null,
                                                                                       AMP3Object.UNKNOWN,
                                                                                       RegisteredEIS.AX);
            if (dtMap.Rows.Count &gt; 0)
            {
                mappedCompany = dtMap.Rows[0][&quot;ERPCompany&quot;].ToString();
            }
            else
                return null;

            var objAdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
            objAdditionalInfo.AddInfo(Constants.EIS_ADDITIONAL_INFO, mappedCompany);

            var dictAdditionalInfo = new Dictionary&lt;RegisteredEIS, EISAdditionalInfo&gt;();
            dictAdditionalInfo.Add(RegisteredEIS.AX, objAdditionalInfo);
            var connectorParameters =
                new ConnectorParameters(dictAdditionalInfo, conParam[0], conParam[1], AMP3ObjectType.Unknown,
                                        new ConnectionFilter(null, null, null, null, null), null);

            IntegrationConnectorManager.HandleIntegration(connectorParameters, ref count, ref ds, true);
            return ds.Tables[&quot;AssetTable&quot;];
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            Response.Redirect(string.Format(@&quot;~/Common/BrixListPage.aspx?Context=FIXUTBD&amp;PID={0}&amp;ContractID={1}&quot;,
                                            projectId, parentId));
        }

        protected void btnRepSave_Click(object sender, EventArgs e)
        {
            LoadRepairNos();
        }

        protected void btnRepDelete_Click(object sender, EventArgs e)
        {
            LoadRepairNos();
        }

        private void LoadRepairNos()
        {
            RemoveEmptyRows(grdRepair, &quot;RepairNo&quot;);
            IEnumerable&lt;String&gt; repairNos = (from row in grdRepair.Rows.Cast&lt;UltraGridRow&gt;()
                                             where row.Cells.FromKey(&quot;RepairNo&quot;).Value != null
                                             select row.Cells.FromKey(&quot;RepairNo&quot;).Value).Cast&lt;String&gt;().Distinct();

            if (repairNos.Count() &gt; 0)
            {
                ddlPartsRepairNo.DataSource = repairNos;
                ddlPartsRepairNo.DataBind();
            }
        }

        protected void btnPartsSave_Click(object sender, EventArgs e)
        {
            CheckGridEntries();
            LoadSparePartIssueNos();
        }

        protected void btnPartsCancel_Click(object sender, EventArgs e)
        {
            LoadSparePartIssueNos();
        }

        protected void btnPartsDelete_Click(object sender, EventArgs e)
        {
            CheckGridEntries();
            LoadSparePartIssueNos();
        }

        protected void btnPartsEdit_Click(object sender, EventArgs e)
        {
            LoadSparePartIssueNos();
            if (!string.IsNullOrEmpty(hdnCurrentSparePartIssueNo.Value))
            {
                ddlPartsIssueNo.SelectedIndex =
                    ddlPartsIssueNo.Items.IndexOf(ddlPartsIssueNo.Items.FindByText(hdnCurrentSparePartIssueNo.Value));
                LoadSparePartDetails();
            }
        }

        protected void btnPartsAdd_Click(object sender, EventArgs e)
        {
            LoadSparePartIssueNos();
        }

        protected void btnLogSave_Click(object sender, EventArgs e)
        {
            // CheckGridEntries();
            // LoadMaterialIssueNos();
            wneTotalCost.ValueDouble = GetTotalCost();
        }


        protected void btnExpSave_Click(object sender, EventArgs e)
        {
            CheckGridEntries();
            LoadMaterialIssueNos();
        }

        protected void btnExpCancel_Click(object sender, EventArgs e)
        {
            LoadMaterialIssueNos();
        }

        protected void btnExpDelete_Click(object sender, EventArgs e)
        {
            CheckGridEntries();
            LoadMaterialIssueNos();
        }

        protected void btnExpEdit_Click(object sender, EventArgs e)
        {
            LoadMaterialIssueNos();
            if (!string.IsNullOrEmpty(hdnCurrentMaterialIssueNo.Value))
            {
                ddlExpIssueNo.SelectedIndex =
                    ddlExpIssueNo.Items.IndexOf(ddlExpIssueNo.Items.FindByText(hdnCurrentMaterialIssueNo.Value));
                LoadMaterialDetails();
            }
        }

        protected void btnExpAdd_Click(object sender, EventArgs e)
        {
            LoadMaterialIssueNos();
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            mode = &quot;NE&quot;;
            UserDetail ud = UserDetail.GetCurrentUserDetail();
            List&lt;string&gt; permissions = ModuleManager.Instance.GetPermissionByUserOrRole(&quot;FIXUTBD&quot;, ud.UID, ud.RID, Request.QueryString[&quot;PID&quot;].ToInt32_2());
            if (string.IsNullOrEmpty(Request[&quot;InstanceID&quot;]))
            {
                CheckAccess(&quot;Create&quot;, permissions);
                PageTitle = &quot;New Equipment Log&quot;;
            }
            else if (Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;V&quot;))
            {
                CheckAccess(&quot;View&quot;, permissions);
                PageTitle = &quot;View Equipment Log&quot;;
                mode = &quot;V&quot;;
                DisableForm();
            }
            else
            {
                CheckAccess(&quot;Edit&quot;, permissions);
                PageTitle = &quot;Edit Equipment Log&quot;;
            }

            if (isHiredEquipmentLog)
            {
                trHireOrderSelector.Style.Value = trDurationUnit.Style.Value = &quot;display:block&quot;;
                lblFixedAssetID.Text = &quot;Serial No./Registration No. :&quot;;
                lblFixedAssetName.Text = &quot;Equipment :&quot;;
            }

            if (!IsPostBack)
            {
                if (ProjectMode == &quot;I&quot;)
                    wdcDate.Value = DefaultRecordDate;

                instanceId = string.IsNullOrEmpty(Request[&quot;InstanceID&quot;]) ? 0 : Convert.ToInt32(Request[&quot;InstanceID&quot;]);
                lblLogNo.Text = !string.IsNullOrEmpty(logbookNo) ? logbookNo : &quot;(auto generated)&quot;;
                if (isHiredEquipmentLog)
                {
                    LoadContractors();
                    workOrderSource = FIXUTBDBL.Instance.GetHireOrders(parentId, mode.Equals(&quot;V&quot;));
                }

                LoadDetails();
                FillControls();
            }

            wneTotalCost.ValueDouble = GetTotalCost();

            ShowHideDivs(divLog, btnExpandLog, hdnLogView);
            ShowHideDivs(divExpenses, btnExpandExpenses, hdnExpenseView);
            ShowHideDivs(divRepair, btnExpandRepair, hdnRepairView);
            ShowHideDivs(divPartsChanged, btnExpandPartsChanged, hdnPartsView);

            ShowHideDivs(divNewLog, null, hdnNewLogView);
            ShowHideDivs(divNewExpenses, null, hdnNewExpenseView);
            ShowHideDivs(divNewRepair, null, hdnNewRepairView);
            ShowHideDivs(divNewPartsChanged, null, hdnNewPartsView);

            CheckGridEntries();
            ddlExpIssueNo.Enabled = ddlExpIssueBill.SelectedValue.Equals(&quot;Issue&quot;);
            ddlPartsIssueNo.Enabled = ddlPartsIssueBill.SelectedValue.Equals(&quot;Issue&quot;);

            InitializeGrids(grdLog, &quot;SlNo&quot;);
            InitializeGrids(grdExpenses, &quot;SlNo&quot;);
            InitializeGrids(grdRepair, &quot;RepairNo&quot;);
            InitializeGrids(grdParts, &quot;RepairNo&quot;);
            moduleCurrency = LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL);
            libraryCurrency = LocalizationManager.GetModuleCurrency(&quot;LIBRARY&quot;, null,
                                                                    Session[Constants.EIS_ADDITIONAL_INFO].ToString());
        }

        private double GetTotalCost()
        {
            double repairCost = (from repairRow in grdRepair.Rows.Cast&lt;UltraGridRow&gt;()
                                 select double.Parse(repairRow.Cells.FromKey(&quot;Cost&quot;).Value.ToString())).Sum();
            double expenseCost = (from expenseRow in grdExpenses.Rows.Cast&lt;UltraGridRow&gt;()
                                  select double.Parse(expenseRow.Cells.FromKey(&quot;Amount&quot;).Value.ToString())).Sum();
            double partsCost = (from partsRow in grdParts.Rows.Cast&lt;UltraGridRow&gt;()
                                select double.Parse(partsRow.Cells.FromKey(&quot;Amount&quot;).Value.ToString())).Sum();
            double minutes = GetTotalRunningTime();
            double logCost = isHiredEquipmentLog ? 0 : (Convert.ToDouble(wneEquipmentRate.Value.ToString()) * minutes / 60);
            double hiredAmount = wneHiredAmount.ValueDouble;
            return repairCost + expenseCost + partsCost + logCost + (isHiredEquipmentLog ? hiredAmount : 0);
        }

        protected override void CreateChildControls()
        {
            EnsureChildControls();
            CreateControlCollection();

            var menus = new MenuArray();
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;V&quot;)))
                AddSaveButton(menus);
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;V&quot;)))
            {
                if (HasSaveButton)
                {
                    Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        lnkSave.Click += btnSave_Click;
                        lnkSave.OnClientClick = &quot;return SaveForm();&quot;;
                    }
            }
            }
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += btnCancel_Click;
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;
        }

        private void CheckAccess(string feature, List&lt;string&gt; permissions)
        {
            if (!permissions.Contains(feature))
                UIHelper.RedirectURL(
                    MessageResourceManager.GetString(&quot;E_USRMGMT_NO_PERMISSIONS_TO_VIEW_PAGE&quot;,
                                                     Enumerations.MessageType.ErrorMessage),
                    ResolveUrl(Constants.URL_ENTERPRISE), null, Context);
        }

        private void ShowHideDivs(HtmlGenericControl div, HtmlInputImage btnExpand, HiddenField hdnView)
        {
            div.Style.Value = Convert.ToBoolean(hdnView.Value) ? &quot;display:block&quot; : &quot;display:none&quot;;
            if (btnExpand != null)
                btnExpand.Src = Convert.ToBoolean(hdnView.Value)
                                    ? &quot;../../Images/ig_treeXPMinus.GIF&quot;
                                    : &quot;../../Images/ig_treeXPPlus.GIF&quot;;
        }

        private void InitializeGrids(UltraWebGrid grid, string notNullCell)
        {
            grid.DisplayLayout.AllowAddNewDefault = AllowAddNew.Yes;
            grid.DisplayLayout.AllowDeleteDefault = AllowDelete.Yes;
            grid.DisplayLayout.AllowUpdateDefault = AllowUpdate.No;
            grid.DisplayLayout.ColFootersVisibleDefault = ShowMarginInfo.Yes;

            RemoveEmptyRows(grid, notNullCell);
        }

        private void RemoveEmptyRows(UltraWebGrid grid, string notNullCell)
        {
            foreach (UltraGridRow ugr in grid.Rows)
            {
                if (ugr.Cells.FromKey(notNullCell).Value == null)
                    grid.Rows.Remove(ugr);
            }
        }

        private void FillControls()
        {
            #region Log

            ddlLogUnit.DataSource = new[] { &quot;Hrs&quot; };
            ddlLogUnit.DataBind();

            ddlLogStatus.DataSource = new[] { &quot;Breakdown&quot;, &quot;Idle&quot;, &quot;Running&quot; };
            ddlLogStatus.DataBind();

            #endregion

            #region Expenses

            ddlExpType.DataSource = new object[] { &quot;Diesel&quot;, &quot;Lubricants&quot;, &quot;Petrol&quot;, &quot;Operating Costs&quot; };
            ddlExpType.DataBind();

            ddlExpIssueBill.DataSource = new[] { &quot;Bill&quot;, &quot;Issue&quot; };
            ddlExpIssueBill.DataBind();


            UIHelper.BindDropDownData(ddlExpUnit, GetUnits(), &quot;Unit&quot;, &quot;UnitID&quot;);

            #endregion

            #region Repair

            LoadRepairNos();

            ddlRepairStatus.DataSource = new object[] { &quot;Complete&quot;, &quot;In-Progress&quot; };
            ddlRepairStatus.DataBind();

            #endregion

            #region PartsChanged

            ddlPartsAction.DataSource = new object[] { &quot;Changed&quot;, &quot;Repaired&quot; };
            ddlPartsAction.DataBind();

            ddlPartsIssueBill.DataSource = new object[] { &quot;Bill&quot;, &quot;Issue&quot; };
            ddlPartsIssueBill.DataBind();

            ddlPartsIssueNo.Items.Insert(0, &quot;Select&quot;);

            LoadSpareParts();

            #endregion
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            WorkflowEnabledSaveHandler();
        }

        private void SaveEquipmentLog(out string sErrors, out string sSavedInstanceToken)
        {
            try
            {
                sErrors = sSavedInstanceToken = string.Empty;

                if (isHiredEquipmentLog)
                {
                }
                SaveLogBook();
                SaveLog();
                SaveExpenses();
                SaveRepair();
                SaveParts();

                sSavedInstanceToken = instanceId.ToString2();
            }
            catch (Exception ex)
            {
                sErrors = ex.Message.Replace(&quot;\&#39;&quot;, &quot;\\&#39;&quot;).Replace(&quot;\n&quot;, &quot;\\n&quot;).Replace(&quot;|&quot;, &quot;\\n&quot;).Replace(&quot;\r&quot;, &quot;\\r&quot;);
                sSavedInstanceToken = &quot;-1&quot;;
            }
        }

        private void SaveLog()
        {
            RemoveEmptyRows(grdLog, &quot;SlNo&quot;);
            if (instanceId != 0)
            {
                DeleteOldEntries(&quot;FIXUTBDLog&quot;, instanceId);
                DeleteOldResources(instanceId);
            }

            var db = new FADb(ConnectionHelper.GetConnectionString());
            var dbCurr = new CoreDb(ConnectionHelper.GetConnectionString());
            foreach (UltraGridRow ugr in grdLog.Rows)
            {
                if (ugr.Cells.FromKey(&quot;SlNo&quot;).Value != null)
                {
                    string startTime = ugr.Cells.FromKey(&quot;StartTime&quot;).Value == null
                                           ? &quot;&quot;
                                           : ugr.Cells.FromKey(&quot;StartTime&quot;).Value.ToString();
                    string endTime = ugr.Cells.FromKey(&quot;EndTime&quot;).Value == null
                                         ? &quot;&quot;
                                         : ugr.Cells.FromKey(&quot;EndTime&quot;).Value.ToString();
                    double runningCost = GetItemCost(ugr.Cells.FromKey(&quot;ItemID&quot;).Value.ToString(),
                                                     Convert.ToInt32(ugr.Cells.FromKey(&quot;SlNo&quot;).Value));

                    var lg = new Log
                                 {
                                     LogBookID = instanceId,
                                     SlNo = Convert.ToInt32(ugr.Cells.FromKey(&quot;SlNo&quot;).Value),
                                     Unit = ugr.Cells.FromKey(&quot;Unit&quot;).Value.ToString(),
                                     Status = ugr.Cells.FromKey(&quot;Status&quot;).Value.ToString(),
                                     StartTime = startTime,
                                     EndTime = endTime,
                                     InitialReading = Convert.ToDouble(ugr.Cells.FromKey(&quot;InitialReading&quot;).Value),
                                     FinalReading = Convert.ToDouble(ugr.Cells.FromKey(&quot;FinalReading&quot;).Value),
                                     Remarks =
                                         ugr.Cells.FromKey(&quot;Remarks&quot;).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey(&quot;Remarks&quot;).Value.ToString(),
                                     StdItemNo =
                                         ugr.Cells.FromKey(&quot;StdItemNo&quot;).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey(&quot;StdItemNo&quot;).Value.ToString(),
                                     ItemID =
                                         ugr.Cells.FromKey(&quot;ItemID&quot;).Value == null
                                             ? 0
                                             : int.Parse(ugr.Cells.FromKey(&quot;ItemID&quot;).Value.ToString()),
                                     RunningCost = runningCost
                                 };
                    db.Log.InsertOnSubmit(lg);

                    try
                    {
                        db.SubmitChanges(ConflictMode.FailOnFirstConflict);
                    }
                    catch
                    {
                        //do nothing
                    }

                    if ((ugr.Cells.FromKey(&quot;ItemID&quot;).Value != null ||
                         int.Parse(ugr.Cells.FromKey(&quot;ItemID&quot;).Value.ToString()) != 0)
                        &amp;&amp; GetTimeDifferenceinMinutes(startTime, endTime) &gt; 0)
                    {
                        String RAResItemID =
                            FIXUTBDBL.Instance.GetRAEquipmentForNonRAEquipment(txtFixedAssetID.Text, parentId) ??
                            txtFixedAssetID.Text;
                        String UnitName;
                        UnitName = FIXUTBDBL.Instance.GetEquipmentUnit(Convert.ToString(Session[&quot;AXCompany&quot;]),
                                                                       RAResItemID);

                        var res = new Resource
                                      {
                                          ModuleID = &quot;EQUPLOG&quot;,
                                          ParentInstanceID = instanceId,
                                          ItemID =
                                              ugr.Cells.FromKey(&quot;ItemID&quot;).Value == null
                                                  ? 0
                                                  : int.Parse(ugr.Cells.FromKey(&quot;ItemID&quot;).Value.ToString()),
                                          ResourceTypeID = (short?)FIXUTBDBL.Instance.GetResourceTypeID(&quot;Equipment&quot;),
                                          Description =
                                              FIXUTBDBL.Instance.GetEquipmentDescription(
                                                  Convert.ToString(Session[&quot;AXCompany&quot;]), RAResItemID),
                                          UnitID = FIXUTBDBL.Instance.GetUnitID(&quot;CONTMGT&quot;, parentId, UnitName),
                                          Unit = UnitName,
                                          Rate = (isHiredEquipmentLog
                                                      ? ((Decimal)runningCost / wneDuration.ValueDecimal)
                                                      : ((decimal)(runningCost * 60) /
                                                         (GetTimeDifferenceinMinutes(startTime, endTime)))
                                                 ),
                                          Quantity = (isHiredEquipmentLog
                                                          ? wneDuration.ValueDecimal
                                                          : (GetTimeDifferenceinMinutes(startTime, endTime) / 60.00m)
                                                     ),
                                          Cost = (decimal)runningCost,
                                          CreatedDate = Convert.ToDateTime(wdcDate.Value).Date,
                                          ResItemID = String.IsNullOrEmpty(RAResItemID)
                                                          ? (isHiredEquipmentLog
                                                                 ? txtFixedAssetName.Text
                                                                 : txtFixedAssetID.Text)
                                                          : RAResItemID
                                      };
                        dbCurr.Resource.InsertOnSubmit(res);

                        try
                        {
                            dbCurr.SubmitChanges(ConflictMode.FailOnFirstConflict);
                        }
                        catch
                        {
                            //do nothing
                        }
                    }
                }
            }
        }

        private void DeleteOldResources(int logid)
        {
            var dbCurr =
                new CoreDb(ConnectionHelper.GetConnectionString());
            IQueryable&lt;Resource&gt; RowsToDelete = from res in dbCurr.Resource
                                                where res.ParentInstanceID == logid &amp;&amp;
                                                      res.ModuleID == &quot;EQUPLOG&quot;
                                                select res;
            dbCurr.Resource.DeleteAllOnSubmit(RowsToDelete);
            try
            {
                dbCurr.SubmitChanges(ConflictMode.FailOnFirstConflict);
            }
            catch
            {
            }
        }

        private void DeleteOldEntries(string table, int instanceId)
        {
            string query = &quot;DELETE FROM &quot; + table + &quot; WHERE LogBookID = {0}&quot;;
            int result = ComponentHelper.Instance.ExecuteNonQuery(query, instanceId);
        }

        private void SaveExpenses()
        {
            RemoveEmptyRows(grdExpenses, &quot;SlNo&quot;);
            if (instanceId != 0)
            {
                DeleteOldEntries(&quot;FIXUTBDExpenses&quot;, instanceId);
            }

            var db = new FADb(ConnectionHelper.GetConnectionString());
            foreach (UltraGridRow ugr in grdExpenses.Rows)
            {
                if (ugr.Cells.FromKey(&quot;SlNo&quot;).Value != null)
                {
                    var exp = new Expenses
                                  {
                                      LogBookID = instanceId,
                                      SlNo = Convert.ToInt32(ugr.Cells.FromKey(&quot;SlNo&quot;).Value),
                                      ExpenseType = ugr.Cells.FromKey(&quot;ExpenseType&quot;).Value.ToString(),
                                      Type =
                                          ugr.Cells.FromKey(&quot;Type&quot;).Value == null
                                              ? &quot;&quot;
                                              : ugr.Cells.FromKey(&quot;Type&quot;).Value.ToString(),
                                      IssueSlipNo =
                                          ugr.Cells.FromKey(&quot;IssueSlipNo&quot;).Value == null
                                              ? &quot;&quot;
                                              : ugr.Cells.FromKey(&quot;IssueSlipNo&quot;).Value.ToString(),
                                      ItemID =
                                          ugr.Cells.FromKey(&quot;ItemID&quot;).Value == null
                                              ? 0
                                              : Convert.ToInt32(ugr.Cells.FromKey(&quot;ItemID&quot;).Value),
                                      UnitID =
                                          ugr.Cells.FromKey(&quot;UnitID&quot;).Value == null
                                              ? 0
                                              : Convert.ToInt32(ugr.Cells.FromKey(&quot;UnitID&quot;).Value),
                                      Unit =
                                          ugr.Cells.FromKey(&quot;Unit&quot;).Value == null
                                              ? &quot;&quot;
                                              : ugr.Cells.FromKey(&quot;Unit&quot;).Value.ToString(),
                                      Quantity = Convert.ToDouble(ugr.Cells.FromKey(&quot;Quantity&quot;).Value),
                                      Rate = Convert.ToDouble(ugr.Cells.FromKey(&quot;Rate&quot;).Value),
                                      Amount = Convert.ToDouble(ugr.Cells.FromKey(&quot;Amount&quot;).Value),
                                      Remarks =
                                          ugr.Cells.FromKey(&quot;Remarks&quot;).Value == null
                                              ? &quot;&quot;
                                              : ugr.Cells.FromKey(&quot;Remarks&quot;).Value.ToString()
                                  };
                    db.Expenses.InsertOnSubmit(exp);
                }
                try
                {
                    db.SubmitChanges(ConflictMode.FailOnFirstConflict);
                }
                catch
                {
                    //do nothing
                }
            }
        }

        private void SaveRepair()
        {
            RemoveEmptyRows(grdRepair, &quot;RepairNo&quot;);
            if (instanceId != 0)
            {
                DeleteOldEntries(&quot;FIXUTBDRepair&quot;, instanceId);
            }

            var db = new FADb(ConnectionHelper.GetConnectionString());
            foreach (UltraGridRow ugr in grdRepair.Rows)
            {
                if (ugr.Cells.FromKey(&quot;RepairNo&quot;).Value != null)
                {
                    var rep = new Repair
                                  {
                                      LogBookID = instanceId,
                                      RepairNo = ugr.Cells.FromKey(&quot;RepairNo&quot;).Value.ToString(),
                                      RepairAction =
                                          ugr.Cells.FromKey(&quot;RepairAction&quot;).Value == null
                                              ? &quot;&quot;
                                              : ugr.Cells.FromKey(&quot;RepairAction&quot;).Value.ToString(),
                                      RepairStatus = ugr.Cells.FromKey(&quot;RepairStatus&quot;).Value.ToString(),
                                      Cost = Convert.ToDouble(ugr.Cells.FromKey(&quot;Cost&quot;).Value),
                                      BillNo =
                                          ugr.Cells.FromKey(&quot;BillNo&quot;).Value == null
                                              ? &quot;&quot;
                                              : ugr.Cells.FromKey(&quot;BillNo&quot;).Value.ToString(),
                                      Remarks =
                                          ugr.Cells.FromKey(&quot;Remarks&quot;).Value == null
                                              ? &quot;&quot;
                                              : ugr.Cells.FromKey(&quot;Remarks&quot;).Value.ToString()
                                  };
                    db.Repair.InsertOnSubmit(rep);
                }
            }
            try
            {
                db.SubmitChanges(ConflictMode.FailOnFirstConflict);
            }
            catch
            {
                //do nothing
            }
        }

        private void SaveParts()
        {
            RemoveEmptyRows(grdParts, &quot;RepairNo&quot;);
            if (instanceId != 0)
            {
                DeleteOldEntries(&quot;FIXUTBDPartsChanged&quot;, instanceId);
            }

            var db = new FADb(ConnectionHelper.GetConnectionString());
            foreach (UltraGridRow ugr in grdParts.Rows)
            {
                if (ugr.Cells.FromKey(&quot;RepairNo&quot;).Value != null)
                {
                    var pc = new PartsChanged
                                 {
                                     LogBookID = instanceId,
                                     RepairNo = ugr.Cells.FromKey(&quot;RepairNo&quot;).Value.ToString(),
                                     ChangeType = ugr.Cells.FromKey(&quot;ChangeType&quot;).Value.ToString(),
                                     Type = ugr.Cells.FromKey(&quot;Type&quot;).Value.ToString(),
                                     IssueSlipNo =
                                         ugr.Cells.FromKey(&quot;IssueSlipNo&quot;).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey(&quot;IssueSlipNo&quot;).Value.ToString(),
                                     SparePart = ugr.Cells.FromKey(&quot;SparePart&quot;).Value.ToString(),
                                     ResItemID =
                                         ugr.Cells.FromKey(&quot;ResItemID&quot;).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString(),
                                     UnitID = Convert.ToInt32(ugr.Cells.FromKey(&quot;UnitID&quot;).Value),
                                     Unit = ugr.Cells.FromKey(&quot;Unit&quot;).Value.ToString(),
                                     Quantity = Convert.ToDouble(ugr.Cells.FromKey(&quot;Quantity&quot;).Value),
                                     Rate = Convert.ToDouble(ugr.Cells.FromKey(&quot;Rate&quot;).Value),
                                     Amount = Convert.ToDouble(ugr.Cells.FromKey(&quot;Amount&quot;).Value),
                                     Remarks =
                                         ugr.Cells.FromKey(&quot;Remarks&quot;).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey(&quot;Remarks&quot;).Value.ToString(),
                                     ParentResItemID =
                                         ugr.Cells.FromKey((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)).Value.ToString(),
                                     Size =
                                         ugr.Cells.FromKey(&quot;Size&quot;).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey(&quot;Size&quot;).Value.ToString(),
                                     Colour =
                                         ugr.Cells.FromKey(&quot;Colour&quot;).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey(&quot;Colour&quot;).Value.ToString(),
                                     Configuration =
                                         ugr.Cells.FromKey(&quot;Configuration&quot;).Value == null
                                             ? &quot;&quot;
                                             : ugr.Cells.FromKey(&quot;Configuration&quot;).Value.ToString()
                                 };
                    db.PartsChanged.InsertOnSubmit(pc);
                }
            }
            try
            {
                db.SubmitChanges(ConflictMode.FailOnFirstConflict);
            }
            catch
            {
                //do nothing
            }
        }

        protected void ddlExpType_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (ddlExpIssueNo.Enabled) LoadMaterialIssueNos();
            if (ddlExpType.SelectedValue.Equals(&quot;Operating Costs&quot;))
            {
                IsReadOnlyExpWne(false);
            }
            ClearExpWne();
        }

        protected void ddlExpIssueBill_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (ddlExpIssueBill.SelectedValue.Equals(&quot;Issue&quot;))
            {
                ddlExpIssueNo.Enabled = true;
                LoadMaterialIssueNos();
                IsReadOnlyExpWne(true);
            }
            else
            {
                ddlExpIssueNo.SelectedIndex = 0;
                IsReadOnlyExpWne(false);
            }
            ClearExpWne();
        }

        protected void ddlSparePart_SelectedIndexChanged(object sender, EventArgs e)
        {
            LoadSparePartIssueNos();
            txtSparePart.Text =
                GetSparePartDescription(ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2());
            ClearPartsWne();
        }

        private string GetSparePartDescription(string resItemID)
        {
            spareParts =
                FIXUTBDBL.Instance.GetSparePartList(
                    (isHiredEquipmentLog ? txtFixedAssetName.Text : txtFixedAssetID.Text), parentId).Tables[0];
            DataRow[] drs = spareParts.Select(&quot;ResItemID = &#39;&quot; + resItemID + &quot;&#39; &quot;);
            return drs.Length &gt; 0 ? drs[0][&quot;Description&quot;].ToString() : &quot;&quot;;
        }

        protected void ddlPartsIssueBill_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (ddlPartsIssueBill.SelectedValue.Equals(&quot;Issue&quot;))
            {
                ddlPartsIssueNo.Enabled = true;
                LoadSparePartIssueNos();
                if (ddlSparePart.SelectedIndex &gt;= 0)
                    txtSparePart.Text =
                        GetSparePartDescription(ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2());
                IsReadOnlyPartsWne(true);
            }
            else
            {
                ddlPartsIssueNo.SelectedIndex = 0;
                txtSparePart.Text = &quot;&quot;;
                txtPartsResItemID.Text = &quot;&quot;;
                IsReadOnlyPartsWne(false);
            }
            ClearPartsWne();
        }

        protected void ddlPartsIssueNo_SelectedIndexChanged(object sender, EventArgs e)
        {
            LoadSparePartDetails();
            if (ddlPartsIssueNo.SelectedIndex == 0) ClearPartsWne();
        }

        protected void ddlExpIssueNo_SelectedIndexChanged(object sender, EventArgs e)
        {
            LoadMaterialDetails();
            if (ddlExpIssueNo.SelectedIndex == 0) ClearExpWne();
        }

        private void LoadMaterialIssueNos()
        {
            ddlExpIssueNo.Items.Clear();
            ddlExpIssueNo.Enabled = ddlExpIssueBill.SelectedValue.Equals(&quot;Issue&quot;);

            string query = &quot;SELECT DISTINCT ItemID FROM MATRISSMain WHERE ContractID = {0}&quot;;

            DataTable dtItemIds = ComponentHelper.Instance.ExecuteDataSet(query, Request[&quot;ParentID&quot;]).Tables[0];
            var dtMaterialIssueNos = new DataTable();
            dtMaterialIssueNos.Columns.Add(&quot;MaterialIssueId&quot;);
            dtMaterialIssueNos.Columns.Add(&quot;BOQID&quot;);
            var dtTemp = new DataTable();

            var db = new FADb(ConnectionHelper.GetConnectionString());
            IQueryable&lt;String&gt; usedIssueSlipNos = (from expenses in db.Expenses
                                                   join lb in db.LogBookMaster on expenses.LogBookID equals lb.LogBookID
                                                   where lb.contractID == parentId
                                                   where expenses.ExpenseType == ddlExpType.SelectedItem.Text
                                                   select expenses.IssueSlipNo).Distinct();
            RemoveEmptyRows(grdExpenses, &quot;SlNo&quot;);
            IEnumerable&lt;String&gt; IssueNos = (from row in grdExpenses.Rows.Cast&lt;UltraGridRow&gt;()
                                            where row.Cells.FromKey(&quot;IssueSlipNo&quot;).Value != null
                                            where
                                                row.Cells.FromKey(&quot;ExpenseType&quot;).Value.Equals(ddlExpType.SelectedValue)
                                            where row.Cells.FromKey(&quot;Type&quot;).Value.Equals(&quot;Issue&quot;)
                                            select row.Cells.FromKey(&quot;IssueSlipNo&quot;).Value).Cast&lt;String&gt;().Distinct();


            dtTemp = GetAXMaterialIssueSlipNos(parentId, ddlExpType.SelectedItem.Text, &quot;&quot;, &quot;MI&quot;);
            if (dtTemp != null)
            {
                foreach (DataRow drIssueNo in dtTemp.Select())
                {
                    if ((!isHiredEquipmentLog || drIssueNo[&quot;WorkOrderNo&quot;].Equals(ddlWorkOrders.SelectedItem.Text))
                        &amp;&amp; (isHiredEquipmentLog || !drIssueNo[&quot;WorkOrderType&quot;].Equals(&quot;E&quot;)))
                    {
                        if ((hdnCurrentMaterialIssueNo.Value.Equals(drIssueNo[0]) &amp;&amp;
                             ddlExpType.SelectedValue.Equals(hdnCurrentExpType.Value)) ||
                            (!usedIssueSlipNos.Contains(drIssueNo[0].ToString()) &amp;&amp;
                             !IssueNos.Contains(drIssueNo[0].ToString())))
                        {
                            DataRow drNew = dtMaterialIssueNos.NewRow();
                            drNew[0] = drIssueNo[&quot;MaterialIssueID&quot;];
                            drNew[1] = drIssueNo[&quot;BOQID&quot;];
                            dtMaterialIssueNos.Rows.Add(drNew);
                        }
                    }
                }
            }

            if (dtMaterialIssueNos.Rows.Count &gt; 0)
            {
                ddlExpIssueNo.DataSource = dtMaterialIssueNos;
                ddlExpIssueNo.DataTextField = &quot;MaterialIssueId&quot;;
                ddlExpIssueNo.DataValueField = &quot;BOQID&quot;;
                try
                {
                    ddlExpIssueNo.DataBind();
                }
                catch
                {
                    //do Nothing.
                }
            }
            ddlExpIssueNo.Items.Insert(0, &quot;Select&quot;);
            ddlExpIssueNo.SelectedIndex = 0;
            LoadMaterialDetails();
        }


        private void LoadMaterialDetails()
        {
            if (ddlExpIssueNo.SelectedIndex != 0)
            {
                DataTable materialIssue = GetIssuedQuantity(ddlExpIssueNo.SelectedItem.Text,
                                                            ddlExpType.SelectedItem.Text);
                string query = &quot;SELECT * FROM CORITEMResourceDetails WHERE ItemID = {0} AND ModuleID = &#39;MATRISS&#39; AND Description = {1}&quot;;
                DataTable material = ComponentHelper.Instance.ExecuteDataSet(query, ddlExpIssueNo.SelectedValue, ddlExpType.SelectedItem.Text).Tables[0];

                if (materialIssue.Rows.Count &gt; 0)
                    wneExpQuantity.Value = materialIssue.Rows[0][&quot;IssuedQty&quot;];
                if (material.Rows.Count &gt; 0)
                    wneExpRate.Value = material.Rows[0][&quot;Rate&quot;];
                wneExpAmount.ValueDouble = wneExpQuantity.ValueDouble * wneExpRate.ValueDouble;
                ddlExpUnit.SelectedIndex =
                    ddlExpUnit.Items.IndexOf(
                        ddlExpUnit.Items.FindByText(GetUnit(Convert.ToInt32(material.Rows[0][&quot;UnitID&quot;]))));
            }
        }

        private void LoadDetails()
        {
            if (instanceId != 0)
            {
                var db = new FADb(ConnectionHelper.GetConnectionString());
                LogBookMaster lbm = (from logBook in db.LogBookMaster
                                     where logBook.LogBookID == instanceId
                                     select logBook).FirstOrDefault();

                lblLogNo.Text = lbm.LogBookNo;
                txtFixedAssetName.Text = lbm.FixedAssetName;
                txtFixedAssetID.Text = isHiredEquipmentLog ? lbm.IdentificationNo : lbm.FixedAssetID;
                txtHelper.Text = lbm.HelperName;
                txtOperator.Text = lbm.OperatorName;
                wdcDate.Value = lbm.Date;
                txtRemarks.Text = lbm.Remarks;
                wneTotalCost.ValueDouble = lbm.TotalCost == null ? 0 : Convert.ToDouble(lbm.TotalCost);
                wneEquipmentRate.ValueDouble = lbm.EquipmentRate == null ? 0 : Convert.ToDouble(lbm.EquipmentRate);
                if (isHiredEquipmentLog)
                {
                    wneDuration.Value = lbm.Duration == null ? 0 : lbm.Duration.ToDouble2();
                    txtUnit.Text = lbm.Unit;
                    SetHireOrderDetails(lbm.Contractor, lbm.WorkOrderID, lbm.WorkOrderNo);
                    hdnHiredEquipmentID.Value = lbm.HiredEquipmentID.ToString();
                    wneHiredAmount.Value = wneDuration.Value.ToDouble2() * wneEquipmentRate.Value.ToDouble2();
                }

                if (lbm.Status &gt; 2)
                    DisableForm();
            }

            grdLog.DataSource = GetDataformTable(&quot;FIXUTBDLog&quot;);
            grdLog.DataBind();

            grdExpenses.DataSource = GetDataformTable(&quot;FIXUTBDExpenses&quot;);
            grdExpenses.DataBind();

            grdRepair.DataSource = GetDataformTable(&quot;FIXUTBDRepair&quot;);
            grdRepair.DataBind();

            grdParts.DataSource = GetDataformTable(&quot;FIXUTBDPartsChanged&quot;);
            grdParts.DataBind();

            SetColumnProperties();
        }

        private DataTable GetDataformTable(string tableName)
        {
            return ComponentHelper.Instance.ExecuteDataSet(&quot;SELECT * FROM &quot; + tableName + &quot; WHERE LogBookID = {0}&quot;, instanceId).Tables[0];
        }

        private void LoadSparePartIssueNos()
        {
            ddlPartsIssueNo.Items.Clear();
            ddlPartsIssueNo.Enabled = ddlPartsIssueBill.SelectedValue.Equals(&quot;Issue&quot;);

            var db = new FADb(ConnectionHelper.GetConnectionString());
            IQueryable&lt;String&gt; usedIssueNos = (from parts in db.PartsChanged
                                               join lbm in db.LogBookMaster on parts.LogBookID equals lbm.LogBookID
                                               where lbm.contractID == parentId
                                               where parts.Type == &quot;Issue&quot;
                                               where
                                                   parts.ResItemID ==
                                                   ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2()
                                               select parts.IssueSlipNo).Distinct();
            var issueList = new DataTable();
            DataSet spareParts =
                FIXUTBDBL.Instance.GetSparePartList(
                    (isHiredEquipmentLog ? txtFixedAssetName.Text : txtFixedAssetID.Text), parentId);
            if (ddlSparePart.SelectedRow != null)
            {
                DataTable sparePartIssueIDs = spareParts.Tables[1];
                issueList = GetAXMaterialIssueSlipNos(parentId, ddlSparePart.DisplayValue, &quot;&quot;, &quot;SP&quot;);
                issueList.Columns.Add(&quot;SparePartsDetailID&quot;);
                issueList.AcceptChanges();
                for (int issuedRecCount = issueList.Rows.Count - 1; issuedRecCount &gt;= 0; issuedRecCount--)
                {
                    //Spare parts Created in Integrated Mode
                    DataRow[] drSpareParts =
                        sparePartIssueIDs.Select(&quot;AXIssueID = &#39;&quot; + issueList.Rows[issuedRecCount][&quot;MaterialIssueID&quot;] +
                                                 &quot;&#39;&quot;);
                    if (drSpareParts.Length &gt; 0)
                    {
                        if (string.IsNullOrEmpty(Convert.ToString(drSpareParts[0][&quot;AXIssueID&quot;])))
                        {
                            issueList.Rows[issuedRecCount][&quot;SparePartsDetailID&quot;] = drSpareParts[0][&quot;SparePartsDetailID&quot;];
                            continue;
                        }
                    }

                    if (
                        sparePartIssueIDs.Select(&quot;AXIssueID = &#39;&quot; + issueList.Rows[issuedRecCount][&quot;MaterialIssueID&quot;] +
                                                 &quot;&#39;&quot;).Length == 0 ||
                        (Convert.ToString(issueList.Rows[issuedRecCount][&quot;ResItemID&quot;]).ToLower2() !=
                         Convert.ToString(ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value).ToLower2()) ||
                        (isHiredEquipmentLog &amp;&amp;
                         !issueList.Rows[issuedRecCount][&quot;WorkOrderNo&quot;].Equals(ddlWorkOrders.SelectedItem.Text)) ||
                        (!isHiredEquipmentLog &amp;&amp; issueList.Rows[issuedRecCount][&quot;WorkOrderType&quot;].Equals(&quot;E&quot;)))
                        issueList.Rows.Remove(issueList.Rows[issuedRecCount]);
                    else
                        issueList.Rows[issuedRecCount][&quot;SparePartsDetailID&quot;] =
                            sparePartIssueIDs.Select(&quot;AXIssueID = &#39;&quot; + issueList.Rows[issuedRecCount][&quot;MaterialIssueID&quot;] +
                                                     &quot;&#39;&quot;)[0][&quot;SparePartsDetailID&quot;];
                }
            }
            if (issueList.Rows.Count &gt; 0)
            {
                foreach (UltraGridRow ugr in grdParts.Rows)
                {
                    if (ugr.Cells.FromKey(&quot;Type&quot;).Value != null &amp;&amp; ugr.Cells.FromKey(&quot;Type&quot;).Value.Equals(&quot;Issue&quot;) &amp;&amp;
                        ugr.Cells.FromKey(&quot;ResItemID&quot;).Value.Equals(
                            ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2()) &amp;&amp;
                        !(hdnCurrentSparePartIssueNo.Value.Equals(ugr.Cells.FromKey(&quot;IssueSlipNo&quot;).Value) &amp;&amp;
                          ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2().Equals(
                              hdnCurrentSparePartResItemID.Value)))
                    {
                        DataRow[] drSelectedRows =
                            issueList.Select(&quot;MaterialIssueID = &#39;&quot; + ugr.Cells.FromKey(&quot;IssueSlipNo&quot;).Value + &quot;&#39;&quot;);
                        if (drSelectedRows != null &amp;&amp; drSelectedRows.Length &gt; 0)
                            issueList.Rows.Remove(drSelectedRows[0]);
                    }
                }

                foreach (string issueNo in usedIssueNos)
                {
                    if (!(hdnCurrentSparePartIssueNo.Value.Equals(issueNo) &amp;&amp;
                          ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2().Equals(
                              hdnCurrentSparePartResItemID.Value)))
                    {
                        DataRow[] dr = issueList.Select(&quot;MaterialIssueID = &#39;&quot; + issueNo + &quot;&#39;&quot;);
                        if (dr != null &amp;&amp; dr.Length &gt; 0)
                            issueList.Rows.Remove(dr[0]);
                    }
                }

                ddlPartsIssueNo.DataSource = issueList;
                ddlPartsIssueNo.DataTextField = &quot;MaterialIssueID&quot;;
                ddlPartsIssueNo.DataValueField = &quot;SparePartsDetailID&quot;;
                try
                {
                    ddlPartsIssueNo.DataBind();
                }
                catch
                {
                    //do Nothing
                }
            }

            ddlPartsIssueNo.Items.Insert(0, &quot;Select&quot;);
            ddlPartsIssueNo.SelectedIndex = 0;
            LoadSparePartDetails();

            if (issueList.Rows.Count &gt; 0 &amp;&amp; spareParts.Tables[0].Rows.Count &gt; 0)
            {
                DataRow[] sparePartRows =
                    spareParts.Tables[0].Select(&quot;ResItemID = &#39;&quot; + issueList.Rows[0][&quot;ItemId&quot;] + &quot;&#39;&quot;);
                if (sparePartRows.Length &gt; 0)
                    txtPartsUnit.Text = sparePartRows[0][&quot;Unit&quot;].ToString();
            }
        }

        private void LoadSparePartDetails()
        {
            if (ddlPartsIssueNo.SelectedIndex != 0)
            {
                DataTable sparePartDetails =
                    ComponentHelper.Instance.ExecuteDataSet(&quot;SELECT * FROM SPRPISSSparePartsData WHERE IssueID = {0} AND ResItemID = {1}&quot;,
                    ddlPartsIssueNo.SelectedValue, ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2()).Tables[0];
                
                DataTable issueDetails = GetAXMaterialIssueSlipNos(parentId, ddlSparePart.DisplayValue, &quot;&quot;, &quot;SP&quot;);

                DataRow[] sparePartIssue =
                    issueDetails.Select(&quot;MaterialIssueID = &#39;&quot; + ddlPartsIssueNo.SelectedItem.Text +
                                        &quot;&#39; AND ResItemID = &#39;&quot; +
                                        Convert.ToString(ddlSparePart.SelectedRow.Cells.FromKey(&quot;ResItemID&quot;).Value) +
                                        &quot;&#39;&quot;);


                if (sparePartDetails.Rows.Count &gt; 0)
                {
                    txtSparePart.Text = sparePartDetails.Rows[0][&quot;Description&quot;].ToString();
                    wnePartsQuantity.Value = (sparePartIssue.Length == 0
                                                  ? sparePartDetails.Rows[0][&quot;ApprovedQuantity&quot;]
                                                  : sparePartIssue[0][&quot;IssuedQty&quot;]);
                    wnePartsRate.Value = sparePartDetails.Rows[0][&quot;Rate&quot;];
                    wnePartsAmount.ValueDouble = wnePartsQuantity.ValueDouble * wnePartsRate.ValueDouble;
                }
            }
        }

        private void LoadSpareParts()
        {
            ColumnsCollection col;
            DataSet ds =
                FIXUTBDBL.Instance.GetSparePartList(
                    (isHiredEquipmentLog ? txtFixedAssetName.Text : txtFixedAssetID.Text), parentId);
            spareParts = ds.Tables[0];
            DataTable sparePartIssueIDs = ds.Tables[1];
            for (int rowCount = spareParts.Rows.Count - 1; rowCount &gt;= 0; rowCount--)
            {
                DataTable issuedSpareParts = GetAXMaterialIssueSlipNos(parentId,
                                                                       spareParts.Rows[rowCount][(IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)].
                                                                           ToString(), &quot;&quot;, &quot;SP&quot;);
                for (int issuedRecCount = issuedSpareParts.Rows.Count - 1; issuedRecCount &gt;= 0; issuedRecCount--)
                {
                    //Spare parts Created in Integrated Mode
                    DataRow[] drSpareParts =
                        sparePartIssueIDs.Select(&quot;AXIssueId = &#39;&quot; +
                                                 issuedSpareParts.Rows[issuedRecCount][&quot;MaterialIssueID&quot;] + &quot;&#39;&quot;);
                    if (drSpareParts.Length &gt; 0)
                    {
                        if (string.IsNullOrEmpty(Convert.ToString(drSpareParts[0][&quot;AXIssueID&quot;])))
                        {
                            continue;
                        }
                    }

                    if (
                        sparePartIssueIDs.Select(&quot;AXIssueID = &#39;&quot; +
                                                 issuedSpareParts.Rows[issuedRecCount][&quot;MaterialIssueID&quot;] + &quot;&#39;&quot;).Length ==
                        0)
                        issuedSpareParts.Rows.Remove(issuedSpareParts.Rows[issuedRecCount]);
                }
                if (issuedSpareParts.Rows.Count == 0)
                    spareParts.Rows.Remove(spareParts.Rows[rowCount]);
            }
            //UIHelper.BindDropDownData(ddlSparePart, spareParts, &quot;ParentResItemID&quot;, &quot;ResItemID&quot;);
            ddlSparePart.DataSource = spareParts;
            ddlSparePart.DataValueField = &quot;ResItemID&quot;;
            ddlSparePart.DataTextField = (IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;);
            ddlSparePart.DataBind();
            (col = ddlSparePart.Columns).FromKey((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)).Header.Caption = &quot;Resource ID&quot;;
            var hidecols = new List&lt;string&gt; { &quot;ResItemID&quot;, &quot;Description&quot;, &quot;Unit&quot; };
            HideColumns(col, hidecols);

            if (ddlSparePart.Rows.Count &lt;= 1)
                ddlSparePart.DropDownLayout.StationaryMargins = StationaryMargins.No;

            if (spareParts.Rows.Count &gt; 0)
            {
                txtPartsUnit.Text = spareParts.Rows[0][&quot;Unit&quot;].ToString();
                if (ddlSparePart.SelectedRow == null)
                    ddlSparePart.SelectedIndex = 0;
                txtPartsResItemID.Text = ddlSparePart.SelectedRow.Cells.FromKey((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)).Value.ToString2();
            }
            LoadSparePartIssueNos();
        }

        private void HideColumns(ColumnsCollection col, List&lt;string&gt; hidecols)
        {
            foreach (string colName in hidecols)
            {
                if (col.Exists(colName))
                    col.FromKey(colName).Hidden = true;
            }
        }

        private void ClearPartsWne()
        {
            wnePartsQuantity.Value =
                wnePartsRate.Value =
                wnePartsAmount.Value = 0;
        }

        private void IsReadOnlyPartsWne(bool p)
        {
            wnePartsQuantity.ReadOnly =
                wnePartsRate.ReadOnly = p;
        }

        private void ClearExpWne()
        {
            wneExpQuantity.Value =
                wneExpRate.Value =
                wneExpAmount.Value = 0;
        }

        private void IsReadOnlyExpWne(bool p)
        {
            ddlExpUnit.Enabled = !p;
            wneExpQuantity.ReadOnly =
                wneExpRate.ReadOnly = p;
        }

        private void CheckGridEntries()
        {
            if (!mode.Equals(&quot;V&quot;))
            {
                bool isEnabled = true;
                foreach (UltraGridRow ugr in grdExpenses.Rows)
                    if (ugr.Cells.FromKey(&quot;Type&quot;).Value != null &amp;&amp; ugr.Cells.FromKey(&quot;Type&quot;).Value.Equals(&quot;Issue&quot;))
                        isEnabled = false;
                foreach (UltraGridRow ugr in grdParts.Rows)
                    if (ugr.Cells.FromKey(&quot;Type&quot;).Value != null &amp;&amp; ugr.Cells.FromKey(&quot;Type&quot;).Value.Equals(&quot;Issue&quot;))
                        isEnabled = false;

                isEnabled = btnExpAdd.Visible &amp;&amp; btnExpEdit.Visible &amp;&amp; btnExpDelete.Visible &amp;&amp; isEnabled;
                btnFixedAssetPicker.Enabled = isEnabled;
            }
        }


        private void SaveLogBook()
        {
            UserDetail ud = UserDetail.GetCurrentUserDetail();
            var db = new FADb(ConnectionHelper.GetConnectionString());
            try
            {
                int? workorderId = null;
                double? duration = null;
                int? hiredEquipmentId = null;
                if (isHiredEquipmentLog)
                {
                    int tempWOID;
                    if (int.TryParse(ddlWorkOrders.SelectedValue, out tempWOID))
                        workorderId = tempWOID;

                    int tempHiredEquipmentId;
                    if (int.TryParse(hdnHiredEquipmentID.Value, out tempHiredEquipmentId))
                        hiredEquipmentId = tempHiredEquipmentId;
                    if (wneDuration.ValueDouble &lt;= 0)
                    {
                        string message = MessageResourceManager.GetString(&quot;W_FIXUTBD_DURATION_IS_POSITIVE&quot;,
                                                                          Enumerations.MessageType.WarningMessage);
                        throw new Exception(message);
                    }
                    else
                    {
                        duration = wneDuration.ValueDouble;
                    }
                    DataTable durationValidationDetails =
                        FIXUTBDBL.Instance.GetDurationValidationDetails(txtFixedAssetName.Text, workorderId.ToInt32_2(),
                                                                        instanceId);
                    double durationLimit, durationUsed;
                    durationLimit = durationValidationDetails.Rows[0][&quot;DurationLimit&quot;].ToDouble2();
                    durationUsed = durationValidationDetails.Rows[0][&quot;DurationUsed&quot;].ToDouble2() + duration.ToDouble2();
                    //if (durationUsed &gt; durationLimit)
                    //{
                    //    string message = MessageResourceManager.GetString(&quot;W_FIXUTBD_DURATION_EXCEEDS_HIREORDER_VALUE&quot;, Enumerations.MessageType.WarningMessage);
                    //    throw new Exception(message);
                    //}
                }
                if (instanceId == 0)
                {
                    LogBookMaster lgbNew;
                    lgbNew = new LogBookMaster
                                 {
                                     LogBookNo = GetLogBookNo(0),
                                     ProjectID = projectId,
                                     contractID = parentId,
                                     Date = Convert.ToDateTime(wdcDate.Value).Date,
                                     FixedAssetID = isHiredEquipmentLog ? txtFixedAssetName.Text : txtFixedAssetID.Text,
                                     FixedAssetName = txtFixedAssetName.Text,
                                     HelperName = txtHelper.Text,
                                     OperatorName = txtOperator.Text,
                                     Remarks = txtRemarks.Text,
                                     CreatedOn = DateTime.UtcNow.Date,
                                     CreatedBy = ud.UID.ToString(),
                                     TotalCost = wneTotalCost.ValueDouble,
                                     EquipmentRate = wneEquipmentRate.ValueDouble,
                                     WorkOrderID = isHiredEquipmentLog ? workorderId : null,
                                     WorkOrderNo = isHiredEquipmentLog ? ddlWorkOrders.SelectedItem.Text : null,
                                     Contractor = isHiredEquipmentLog ? ddlContractors.SelectedItem.Text : null,
                                     Unit = isHiredEquipmentLog ? txtUnit.Text : null,
                                     Duration = isHiredEquipmentLog ? duration : null,
                                     IdentificationNo = isHiredEquipmentLog ? txtFixedAssetID.Text : null,
                                     Status = 1,
                                     // Default Status is Draft
                                     HiredEquipmentID = isHiredEquipmentLog ? hiredEquipmentId : null
                                 };

                    db.LogBookMaster.InsertOnSubmit(lgbNew);
                    db.SubmitChanges(ConflictMode.FailOnFirstConflict);
                    instanceId = lgbNew.LogBookID;
                }
                else
                {
                    LogBookMaster lgb = (from entry in db.LogBookMaster
                                         where entry.LogBookID == instanceId
                                         select entry).FirstOrDefault();

                    string logBookNoTemp;
                    if (isHiredEquipmentLog)
                        logBookNoTemp = (lgb.FixedAssetID == txtFixedAssetName.Text)
                                            ? lgb.LogBookNo
                                            : GetLogBookNo(instanceId);
                    else
                        logBookNoTemp = (lgb.FixedAssetID == txtFixedAssetID.Text)
                                            ? lgb.LogBookNo
                                            : GetLogBookNo(instanceId);

                    lgb.LogBookNo = logBookNoTemp;
                    lgb.FixedAssetID = isHiredEquipmentLog ? txtFixedAssetName.Text : txtFixedAssetID.Text;
                    lgb.FixedAssetName = txtFixedAssetName.Text;
                    lgb.HelperName = txtHelper.Text;
                    lgb.OperatorName = txtOperator.Text;
                    lgb.Remarks = txtRemarks.Text;
                    lgb.TotalCost = wneTotalCost.ValueDouble;
                    lgb.EquipmentRate = wneEquipmentRate.ValueDouble;
                    lgb.Date = Convert.ToDateTime(wdcDate.Value).Date;

                    if (isHiredEquipmentLog)
                    {
                        lgb.WorkOrderID = workorderId;
                        lgb.WorkOrderNo = ddlWorkOrders.SelectedItem.Text;
                        lgb.Contractor = ddlContractors.SelectedItem.Text;
                        lgb.Unit = txtUnit.Text;
                        lgb.Duration = duration;
                        lgb.IdentificationNo = txtFixedAssetID.Text;
                        lgb.HiredEquipmentID = hiredEquipmentId;
                    }

                    db.Refresh(RefreshMode.KeepCurrentValues, lgb);
                    db.SubmitChanges(ConflictMode.FailOnFirstConflict);
                }
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
            //if (instanceId == 0) UpdateInstanceID();
            lblLogNo.Text = logbookNo;
        }

        private void UpdateInstanceID()
        {
            var db = new FADb(ConnectionHelper.GetConnectionString());
            instanceId = (from entry in db.LogBookMaster
                          where entry.contractID == parentId
                          where entry.ProjectID == projectId
                          select entry.LogBookID).Max();
        }

        private string GetLogBookNo(int logBookId)
        {
            var db = new FADb(ConnectionHelper.GetConnectionString());
            IQueryable&lt;String&gt; logBookNos = (from lgbn in db.LogBookMaster
                                             where lgbn.contractID == parentId
                                             where
                                                 lgbn.FixedAssetID ==
                                                 (isHiredEquipmentLog ? txtFixedAssetName.Text : txtFixedAssetID.Text)
                                             select lgbn.LogBookNo);

            string lastLogBookNo = logBookNos.Count() &gt; 0 ? logBookNos.ToArray().Last() : &quot;&quot;;
            int lastNo = 0;
            if (!string.IsNullOrEmpty(lastLogBookNo))
                lastNo = Convert.ToInt32(lastLogBookNo.Split(&#39;/&#39;)[1]);

            lastNo++;

            logbookNo = txtFixedAssetID.Text + &quot;/&quot; + (lastNo);
            return logbookNo;
        }

        private void SetColumnProperties()
        {
            SetLogColumnProperties();
            SetExpensesColumnProperties();
            SetRepairColumnProperties();
            SetPartsColumnProperties();
        }

        private void SetPartsColumnProperties()
        {
            grdParts.Columns.FromKey(&quot;PartsChangedID&quot;).Hidden = true;
            grdParts.Columns.FromKey(&quot;LogBookID&quot;).Hidden = true;
            grdParts.Columns.FromKey(&quot;UnitID&quot;).Hidden = true;

            grdParts.Columns.FromKey(&quot;ResItemID&quot;).Hidden = true;

            //grdParts.Columns.Add(&quot;ParentResItemID&quot;, &quot;Resource ID&quot;);
            //foreach (UltraGridRow row in grdParts.Rows)
            //{
            //    string resourceid = string.Empty;
            //    if (row.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString().Contains(&#39;@&#39;))
            //        resourceid = row.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString().Substring(0, row.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString().IndexOf(&#39;@&#39;));
            //    else
            //        resourceid = row.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString();

            //    row.Cells.FromKey(&quot;ParentResItemID&quot;).Value = resourceid;
            //}

            grdParts.Columns.FromKey(&quot;Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            grdParts.Columns.FromKey(&quot;Rate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            grdParts.Columns.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            grdParts.Columns.FromKey(&quot;Amount&quot;).Footer.Total = SummaryInfo.Sum;
            grdParts.Columns.FromKey(&quot;Amount&quot;).Footer.Style.HorizontalAlign = HorizontalAlign.Right;

            grdParts.Columns.FromKey(&quot;ChangeType&quot;).Header.Caption = &quot;Part Repaired / Changed&quot;;
            grdParts.Columns.FromKey(&quot;Type&quot;).Header.Caption = &quot;Bill / Issue&quot;;
            grdParts.Columns.FromKey(&quot;IssueSlipNo&quot;).Header.Caption = &quot;Issue Slip No.&quot;;
            grdParts.Columns.FromKey(&quot;SparePart&quot;).Header.Caption = &quot;Spare Part&quot;;

            if (grdParts.Columns.FromKey((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)) != null)
            {
                grdParts.Columns.FromKey((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)).Header.Caption = &quot;Resource ID&quot;;
                grdParts.Columns.FromKey((IsERPConnected ? &quot;ParentResItemID&quot; : &quot;ResItemID&quot;)).Move(3);
            }
            //if (grdParts.Columns.FromKey(&quot;ResItemID&quot;) != null)
            //{
            //    grdParts.Columns.FromKey(&quot;ResItemID&quot;).Header.Caption = &quot;Resource ID&quot;;
            //    grdParts.Columns.FromKey(&quot;ResItemID&quot;).Move(3);
            //}

            SetHorizontalAlignRight(grdParts, new[] { &quot;Quantity&quot;, &quot;Rate&quot;, &quot;Amount&quot; });
        }

        private void SetRepairColumnProperties()
        {
            grdRepair.Columns.FromKey(&quot;RepairID&quot;).Hidden = true;
            grdRepair.Columns.FromKey(&quot;LogBookID&quot;).Hidden = true;

            grdRepair.Columns.FromKey(&quot;Cost&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            grdRepair.Columns.FromKey(&quot;Cost&quot;).Footer.Total = SummaryInfo.Sum;
            grdRepair.Columns.FromKey(&quot;Cost&quot;).Footer.Style.HorizontalAlign = HorizontalAlign.Right;

            grdRepair.Columns.FromKey(&quot;RepairAction&quot;).Header.Caption = &quot;Repair Action Taken&quot;;
            grdRepair.Columns.FromKey(&quot;RepairStatus&quot;).Header.Caption = &quot;Repair Status&quot;;
            grdRepair.Columns.FromKey(&quot;BillNo&quot;).Header.Caption = &quot;Bill No. (if any)&quot;;

            SetHorizontalAlignRight(grdRepair, new[] { &quot;Cost&quot; });
        }

        private void SetExpensesColumnProperties()
        {
            grdExpenses.Columns.FromKey(&quot;ExpenseID&quot;).Hidden = true;
            grdExpenses.Columns.FromKey(&quot;LogBookID&quot;).Hidden = true;
            grdExpenses.Columns.FromKey(&quot;UnitID&quot;).Hidden = true;
            grdExpenses.Columns.FromKey(&quot;ItemID&quot;).Hidden = true;

            grdExpenses.Columns.FromKey(&quot;Quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
            grdExpenses.Columns.FromKey(&quot;Rate&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
            grdExpenses.Columns.FromKey(&quot;Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            grdExpenses.Columns.FromKey(&quot;Amount&quot;).Footer.Total = SummaryInfo.Sum;
            grdExpenses.Columns.FromKey(&quot;Amount&quot;).Footer.Style.HorizontalAlign = HorizontalAlign.Right;

            grdExpenses.Columns.FromKey(&quot;SlNo&quot;).Header.Caption = &quot;S. No.&quot;;
            grdExpenses.Columns.FromKey(&quot;ExpenseType&quot;).Header.Caption = &quot;Exp. Type&quot;;
            grdExpenses.Columns.FromKey(&quot;Type&quot;).Header.Caption = &quot;Bill / Issue&quot;;
            grdExpenses.Columns.FromKey(&quot;IssueSlipNo&quot;).Header.Caption = &quot;Issue Slip No.&quot;;

            SetHorizontalAlignRight(grdExpenses, new[] { &quot;Quantity&quot;, &quot;Rate&quot;, &quot;Amount&quot; });
        }

        private void SetLogColumnProperties()
        {
            grdLog.Columns.FromKey(&quot;LogID&quot;).Hidden = true;
            grdLog.Columns.FromKey(&quot;LogBookID&quot;).Hidden = true;
            grdLog.Columns.FromKey(&quot;ItemID&quot;).Hidden = true;
            grdLog.Columns.FromKey(&quot;RunningCost&quot;).Hidden = true;

            grdLog.Columns.FromKey(&quot;InitialReading&quot;).Format = &quot;###,###,##0.0000&quot;;
            grdLog.Columns.FromKey(&quot;FinalReading&quot;).Format = &quot;###,###,##0.0000&quot;;

            grdLog.Columns.FromKey(&quot;SlNo&quot;).Header.Caption = &quot;S. No.&quot;;
            grdLog.Columns.FromKey(&quot;StartTime&quot;).Header.Caption = &quot;Start Time&quot;;
            grdLog.Columns.FromKey(&quot;EndTime&quot;).Header.Caption = &quot;End Time&quot;;
            grdLog.Columns.FromKey(&quot;InitialReading&quot;).Header.Caption = &quot;Initial Reading&quot;;
            grdLog.Columns.FromKey(&quot;FinalReading&quot;).Header.Caption = &quot;Final Reading&quot;;
            grdLog.Columns.FromKey(&quot;StdItemNo&quot;).Header.Caption =
                LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO);

            SetHorizontalAlignRight(grdLog, new[] { &quot;InitialReading&quot;, &quot;FinalReading&quot; });
        }

        private void SetHorizontalAlignRight(UltraWebGrid grid, string[] keys)
        {
            foreach (string key in keys)
            {
                grid.Columns.FromKey(key).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                grid.Columns.FromKey(key).CellStyle.HorizontalAlign = HorizontalAlign.Right;
            }
        }

        public string GetUnit(int unitId)
        {
            return ComponentHelper.Instance.ExecuteScalar(&quot;SELECT dbo.fn_CONTMGTGetUnit({0})&quot;, unitId).ToString();
        }

        public DataTable GetUnits()
        {
            DataSet ds =
                ComponentHelper.Instance.ExecuteDataSet(
                    FixedAssetUtilizationAndBreakDownStoredProcedure.usp_CORITEMGetModuleData, null, &quot;CONTMGT&quot;, parentId);
            if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
            {
                // AX Company for Units is Login Company
                // GetModuleDataForErp(parentInstanceID);
                string AdditionalInfo = Session[Constants.EIS_ADDITIONAL_INFO] == null
                                            ? string.Empty
                                            : Session[Constants.EIS_ADDITIONAL_INFO].ToString();
                DataTable dt = ProjectComponent.Instance.GetMeasurementUnitsForSystem(AdditionalInfo, 0);
                DataTable dtUnit = null;
                if (dt != null)
                {
                    dtUnit = dt.Copy();
                }
                else
                {
                    dtUnit = new DataTable();
                }
                //TODO : Remove Indexing
                ds.Tables[2].Rows.Clear();
                ds.Tables[2].Columns.Clear();
                ds.Tables[2].Merge(dtUnit);
            }
            return ds.Tables[2];
        }

        private DataTable GetAXMaterialIssueSlipNos(int contractID, string ResItemID, string ItemID, string type)
        {
            string filterCriteria = &quot;&quot;;
            var ds = new DataSet();
            string mappedCompany = &quot;&quot;;
            var resource = new DataTable();
            if (!ProjectMode.Equals(&quot;I&quot;))
            {
                //AMP3.ContractManager.BusinessLayer.BL.Instance.UpdateMIStatusFromERPToBrix(ds.Tables[0]);

                DataTable dtMap = IntegrationConnectorManager.Instance.GetERPObjectMapInfo(contractID.ToString(),
                                                                                           AMP3Object.CONTMGT, null,
                                                                                           AMP3Object.UNKNOWN,
                                                                                           RegisteredEIS.AX);
                if (dtMap.Rows.Count &gt; 0)
                {
                    filterCriteria = &quot;&lt;XMLRoot&gt;&lt;ProjId type=&#39;txt&#39;&gt;&quot; + dtMap.Rows[0][&quot;ERPId&quot;] +
                                     &quot;&lt;/ProjId&gt;&lt;MaterialIssueStatus type=&#39;int&#39;&gt;3&lt;/MaterialIssueStatus&gt;&lt;Table2_ItemId type=&#39;txt&#39;&gt;&quot; +
                                     ResItemID + &quot;&lt;/Table2_ItemId&gt;&lt;/XMLRoot&gt;&quot;;
                    mappedCompany = dtMap.Rows[0][&quot;ERPCompany&quot;].ToString();
                }
                else
                    return null;


                var filter = new ConnectionFilter(filterCriteria, null, null, null, null);
                var objAdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
                objAdditionalInfo.AddInfo(Constants.EIS_ADDITIONAL_INFO, mappedCompany);
                var dictAdditionalInfo = new Dictionary&lt;RegisteredEIS, EISAdditionalInfo&gt;();
                dictAdditionalInfo.Add(RegisteredEIS.AX, objAdditionalInfo);
                var ConnectorParameters =
                    new ConnectorParameters(dictAdditionalInfo, MethodBase.GetCurrentMethod(),
                                            AMP3ObjectType.Unknown, filter, null);

                int count = 0;
                if (IntegrationConnectorManager.HandleIntegration(ConnectorParameters, ref count, ref ds, true))
                {
                    AMP3.ContractManager.BusinessLayer.BL.Instance.UpdateMIStatusFromERPToBrix(ds.Tables[0]);
                    ds.Tables[0].Columns.Add(&quot;BOQID&quot;);
                    ds.Tables[0].Columns.Add(&quot;WorkOrderNo&quot;);
                    ds.Tables[0].Columns.Add(&quot;WorkOrderType&quot;);
                    foreach (DataRow dr in ds.Tables[0].Select())
                    {
                        string amp3Type = type.Equals(&quot;SP&quot;) ? &quot;SPRPISS&quot; : &quot;MATISSUE&quot;;
                        string query = &quot;SELECT * FROM ERPMGMTOBJECTMAP WHERE ERPID = {0} AND ERPTYPE = &#39;MaterialIssue&#39; AND AMP3TYPE = {1} AND ERPCOMPANY = {2}&quot;;
                        resource = ComponentHelper.Instance.ExecuteDataSet(query, dr[&quot;MaterialIssueId&quot;], amp3Type, Session[Constants.EIS_ADDITIONAL_INFO]).Tables[0];
                        string brixMIId = resource.Rows.Count &gt; 0 ? resource.Rows[0][&quot;AMP3ID&quot;].ToString() : &quot;&quot;;

                        int issueId = 0;
                        if (int.TryParse(brixMIId, out issueId))
                        {
                            resource = FIXUTBDBL.Instance.GetIssueSummary(Request[&quot;ParentID&quot;].ToInt32_2(), issueId, type);
                            dr[&quot;BOQId&quot;] = resource.Rows.Count &gt; 0 ? resource.Rows[0][&quot;ItemId&quot;].ToString() : &quot;&quot;;
                            dr[&quot;WorkOrderNo&quot;] = resource.Rows.Count &gt; 0
                                                    ? resource.Rows[0][&quot;WorkOrderNo&quot;].ToString()
                                                    : &quot;&quot;;
                            dr[&quot;WorkOrderType&quot;] = resource.Rows.Count &gt; 0
                                                      ? resource.Rows[0][&quot;WorkOrderType&quot;].ToString()
                                                      : &quot;&quot;;
                        }

                        if (resource.Rows.Count &lt;= 0)
                            ds.Tables[0].Rows.Remove(dr);
                    }
                }
            }
            else
            {
                var dtData = new DataTable();
                var dtTemp = new DataTable();
                string brixInstanceID = &quot;&quot;;
                if (type.Equals(&quot;SP&quot;))
                {
                    resource =
                        AMP3.ContractManager.BusinessLayer.BL.Instance.GetSparePartIssuesToBeIssued(
                            Convert.ToInt32(Request[&quot;ParentID&quot;]));
                }
                else if (type.Equals(&quot;MI&quot;))
                {
                    resource =
                        AMP3.ContractManager.BusinessLayer.BL.Instance.GetMaterialIssuesToBeIssued(
                            Convert.ToInt32(Request[&quot;ParentID&quot;]), &quot;Y&quot;);
                }

                dtData = resource.Clone();
                DataRow[] drSelect = resource.Select(&quot;ItemId = &#39;&quot; + ResItemID + &quot;&#39;&quot;);
                foreach (DataRow drItem in drSelect)
                {
                    dtData.ImportRow(drItem);
                }
                dtData.Columns.Add(&quot;BOQID&quot;);
                dtData.Columns.Add(&quot;WorkOrderNo&quot;);
                dtData.Columns.Add(&quot;WorkOrderType&quot;);
                foreach (DataRow dr in dtData.Rows)
                {
                    if (type.Equals(&quot;MI&quot;))
                        brixInstanceID = dr[&quot;MIListID&quot;].ToString();
                    else if (type.Equals(&quot;SP&quot;))
                        brixInstanceID = dr[&quot;SparePartsIssueID&quot;].ToString();
                    int issueId = 0;

                    if (int.TryParse(brixInstanceID, out issueId))
                    {
                        dtTemp = FIXUTBDBL.Instance.GetIssueSummary(Request[&quot;ParentID&quot;].ToInt32_2(), issueId, type);
                        dr[&quot;BOQId&quot;] = dtTemp.Rows.Count &gt; 0 ? dtTemp.Rows[0][&quot;ItemId&quot;].ToString() : &quot;&quot;;
                        dr[&quot;WorkOrderNo&quot;] = dtTemp.Rows.Count &gt; 0 ? dtTemp.Rows[0][&quot;WorkOrderNo&quot;].ToString() : &quot;&quot;;
                        dr[&quot;WorkOrderType&quot;] = dtTemp.Rows.Count &gt; 0 ? dtTemp.Rows[0][&quot;WorkOrderType&quot;].ToString() : &quot;&quot;;
                    }
                }
                ds.Tables.Add(dtData.Copy());
            }
            return ds.Tables[0]; // return count;
        }

        private DataTable GetIssuedQuantity(string IssueSlipNo, string ResItemID)
        {
            if (ProjectMode.Equals(&quot;L&quot;))
            {
                string filterCriteria = &quot;&lt;XMLRoot&gt;&lt;MaterialIssueId type=&#39;txt&#39;&gt;&quot; + IssueSlipNo +
                                        &quot;&lt;/MaterialIssueId&gt;&lt;Table2_ItemId type =&#39;txt&#39;&gt;&quot; + ResItemID +
                                        &quot;&lt;/Table2_ItemId&gt;&lt;/XMLRoot&gt;&quot;;
                string mappedCompany = &quot;&quot;;
                DataTable dtMap = IntegrationConnectorManager.Instance.GetERPObjectMapInfo(Request[&quot;ParentID&quot;],
                                                                                           AMP3Object.CONTMGT, null,
                                                                                           AMP3Object.UNKNOWN,
                                                                                           RegisteredEIS.AX);
                if (dtMap.Rows.Count &gt; 0)
                {
                    mappedCompany = dtMap.Rows[0][&quot;ERPCompany&quot;].ToString();
                }
                else
                    return null;
                var filter = new ConnectionFilter(filterCriteria, null, null, null, null);
                var objAdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
                objAdditionalInfo.AddInfo(Constants.EIS_ADDITIONAL_INFO, mappedCompany);
                var dictAdditionalInfo = new Dictionary&lt;RegisteredEIS, EISAdditionalInfo&gt;();
                dictAdditionalInfo.Add(RegisteredEIS.AX, objAdditionalInfo);
                var ConnectorParameters =
                    new ConnectorParameters(dictAdditionalInfo, MethodBase.GetCurrentMethod(),
                                            AMP3ObjectType.Unknown, filter, null);
                var ds = new DataSet();
                int count = 0;
                if (IntegrationConnectorManager.HandleIntegration(ConnectorParameters, ref count, ref ds, true))
                {
                    AMP3.ContractManager.BusinessLayer.BL.Instance.UpdateMIStatusFromERPToBrix(ds.Tables[0]);
                    return ds.Tables[0]; // return count;
                }

                else
                    return new DataTable();
            }
            else
            {
                int issueID = 0;
                DataTable dtMI =
                    AMP3.ContractManager.BusinessLayer.BL.Instance.GetMaterialIssuesToBeIssued(
                        Convert.ToInt32(Request[&quot;ParentID&quot;]), &quot;Y&quot;);
                DataRow[] drSelect = dtMI.Select(&quot;MaterialIssueID = &quot; + Convert.ToInt32(IssueSlipNo));

                foreach (DataRow dr in drSelect)
                {
                    issueID = Convert.ToInt32(dr[&quot;MIListID&quot;]);
                }
                dtMI = FIXUTBDBL.Instance.GetIssuedQuantity(issueID);
                drSelect = dtMI.Select(&quot;ResItemId = &#39;&quot; + ResItemID + &quot;&#39;&quot;);

                DataTable resource = dtMI.Clone();
                foreach (DataRow drSelectItem in drSelect)
                {
                    resource.ImportRow(drSelectItem);
                }
                if (resource.Columns.Contains(&quot;IssuedQuantity&quot;))
                    resource.Columns[&quot;IssuedQuantity&quot;].ColumnName = &quot;IssuedQty&quot;;
                return resource;
            }
        }

        private double GetItemCost(string itemID, int slNo)
        {
            double itemCost = 0;
            if (!string.IsNullOrEmpty(itemID) &amp;&amp; int.Parse(itemID) != 0)
            {
                int totalRunningMinutes = GetTotalRunningTime();
                var itemRunningTime = (from logRow in grdLog.Rows.Cast&lt;UltraGridRow&gt;()
                                       where logRow.Cells.FromKey(&quot;Status&quot;).Value.Equals(&quot;Running&quot;)
                                       where logRow.Cells.FromKey(&quot;Unit&quot;).Value.Equals(&quot;Hrs&quot;)
                                       where logRow.Cells.FromKey(&quot;ItemID&quot;).Value.Equals(int.Parse(itemID))
                                       where logRow.Cells.FromKey(&quot;SlNo&quot;).Value.Equals(slNo)
                                       select new
                                                  {
                                                      StartTime = logRow.Cells.FromKey(&quot;StartTime&quot;).Value.ToString(),
                                                      EndTime = logRow.Cells.FromKey(&quot;EndTime&quot;).Value.ToString()
                                                  }).FirstOrDefault();

                if (itemRunningTime != null)
                {
                    int totalItemRunningMins = GetTimeDifferenceinMinutes(itemRunningTime.StartTime,
                                                                          itemRunningTime.EndTime);
                    if (Convert.ToDouble(totalRunningMinutes) != 0)
                        itemCost = (Convert.ToDouble(totalItemRunningMins) / Convert.ToDouble(totalRunningMinutes)) *
                                   wneTotalCost.ValueDouble;
                }
            }
            return itemCost;
        }

        private int GetTotalRunningTime()
        {
            int totalRunningMinutes = 0;
            var runningTimes = from logRow in grdLog.Rows.Cast&lt;UltraGridRow&gt;()
                               where logRow.Cells.FromKey(&quot;Status&quot;).Value.Equals(&quot;Running&quot;)
                               where logRow.Cells.FromKey(&quot;Unit&quot;).Value.Equals(&quot;Hrs&quot;)
                               select new
                                          {
                                              StartTime = logRow.Cells.FromKey(&quot;StartTime&quot;).Value.ToString(),
                                              EndTime = logRow.Cells.FromKey(&quot;EndTime&quot;).Value.ToString()
                                          };

            foreach (var runningTime in runningTimes)
            {
                totalRunningMinutes += GetTimeDifferenceinMinutes(runningTime.StartTime, runningTime.EndTime);
            }
            return totalRunningMinutes;
        }

        private int GetTimeDifferenceinMinutes(string startTime, string endTime)
        {
            int startHour = int.Parse(startTime.Split(&#39;:&#39;)[0]);
            int startMins = int.Parse(startTime.Split(&#39;:&#39;)[1]);
            int endHour = int.Parse(endTime.Split(&#39;:&#39;)[0]);
            int endMins = int.Parse(endTime.Split(&#39;:&#39;)[1]);
            return ((endHour - startHour) * 60 + endMins) - startMins;
        }

        private void DisableForm()
        {
            btnFixedAssetPicker.Enabled = false;
            txtOperator.ReadOnly = true;
            txtHelper.ReadOnly = true;
            txtRemarks.ReadOnly = true;
            wdcDate.ReadOnly = true;
            wneEquipmentRate.ReadOnly = true;
            ddlContractors.Enabled = false;
            ddlWorkOrders.Enabled = false;
            wneDuration.Enabled = false;

            btnLogAdd.Visible = false;
            btnLogEdit.Visible = false;
            btnLogDelete.Visible = false;

            btnExpAdd.Visible = false;
            btnExpEdit.Visible = false;
            btnExpDelete.Visible = false;

            btnRepAdd.Visible = false;
            btnRepEdit.Visible = false;
            btnRepDelete.Visible = false;

            btnPartsAdd.Visible = false;
            btnPartsEdit.Visible = false;
            btnPartsDelete.Visible = false;
        }

        private void LoadContractors()
        {
            DataTable contractorSource = new BrixDataTable();
            contractorSource = FIXUTBDBL.Instance.GetHireOrderContractors(parentId, mode.Equals(&quot;V&quot;));
            UIHelper.BindDropDownData(ddlContractors, contractorSource, &quot;Contractor&quot;, &quot;ContractorID&quot;);
            ddlContractors.Items.Insert(0, &quot;Select&quot;);
            LoadWorkOrders();
        }

        private void LoadWorkOrders()
        {
            ddlWorkOrders.Items.Clear();
            if (ddlContractors.SelectedIndex != 0)
            {
                UIHelper.BindDropDownData(ddlWorkOrders,
                                          GetHireOrders(ddlContractors.SelectedValue, Convert.ToDateTime(wdcDate.Value)),
                                          &quot;WorkOrderNo&quot;, &quot;WorkOrderID&quot;);
            }
            ddlWorkOrders.Items.Insert(0, &quot;Select&quot;);
        }

        private DataTable GetHireOrders(string contractorId, DateTime logDate)
        {
            var filteredHireOrders = new DataTable();
            filteredHireOrders.Columns.Add(&quot;WorkOrderID&quot;);
            filteredHireOrders.Columns.Add(&quot;WorkOrderNo&quot;);
            filteredHireOrders.AcceptChanges();
            foreach (
                DataRow hireOrder in
                    workOrderSource.Select(&quot;ContractorID = &#39;&quot; + contractorId + &quot;&#39; AND StartDate &lt;= &#39;&quot; + logDate.Date +
                                           &quot;&#39; AND EndDate &gt;= &#39;&quot; + logDate.Date + &quot;&#39;&quot;))
            {
                DataRow newHireOrder = filteredHireOrders.NewRow();
                newHireOrder[&quot;WorkOrderID&quot;] = hireOrder[&quot;WorkOrderID&quot;];
                newHireOrder[&quot;WorkOrderNo&quot;] = hireOrder[&quot;WorkOrderNo&quot;];
                filteredHireOrders.Rows.Add(newHireOrder);
            }
            return filteredHireOrders;
        }

        protected void ddlContractors_SelectedIndexChanged(object sender, EventArgs e)
        {
            LoadWorkOrders();
            ClearHireOrderDetails();
            ClearPartsWne();
            ClearExpWne();
            LoadMaterialIssueNos();
            LoadSpareParts();
        }

        protected void ddlWorkOrders_SelectedIndexChanged(object sender, EventArgs e)
        {
            ClearHireOrderDetails();
            ClearPartsWne();
            ClearExpWne();
            LoadMaterialIssueNos();
            LoadSpareParts();
            fixedAssetPicker.ChangeTableOrViewAndBind(&quot;&quot;);
        }

        private void SetHireOrderDetails(string contractor, int? workOrderId, string workOrderNo)
        {
            ddlContractors.SelectedIndex = ddlContractors.Items.IndexOf(ddlContractors.Items.FindByText(contractor));
            LoadWorkOrders();
            if (!String.IsNullOrEmpty(workOrderNo) &amp;&amp; ddlWorkOrders.Items.FindByText(workOrderNo) == null)
            {
                ddlWorkOrders.Items.Add(new ListItem(workOrderNo, workOrderId.ToString()));
            }
            ddlWorkOrders.SelectedIndex = ddlWorkOrders.Items.IndexOf(ddlWorkOrders.Items.FindByText(workOrderNo));
        }

        private void wdcDate_ValueChanged(object sender, WebDateChooser.WebDateChooserEventArgs e)
        {
            int workOrderId = 0;
            if (ddlWorkOrders.SelectedIndex &gt; 0)
                workOrderId = ddlWorkOrders.SelectedValue.ToInt32_2();
            LoadWorkOrders();
            if (workOrderId != 0 &amp;&amp; ddlWorkOrders.Items.FindByValue(workOrderId.ToString2()) != null)
            {
                ddlWorkOrders.SelectedIndex =
                    ddlWorkOrders.Items.IndexOf(ddlWorkOrders.Items.FindByValue(workOrderId.ToString2()));
            }
            else
            {
                //TODO:show the message that the data will be cleared
                ddlWorkOrders.SelectedIndex = -1;
                ClearHireOrderDetails();
                ClearPartsWne();
                ClearExpWne();
                LoadMaterialIssueNos();
                LoadSpareParts();
            }
        }

        private void ClearHireOrderDetails()
        {
            txtFixedAssetID.Text = txtFixedAssetName.Text = txtUnit.Text = string.Empty;
            wneEquipmentRate.Value = wneDuration.Value = 0.0;
        }

        protected override void SetModes()
        {
            _IsNew = string.IsNullOrEmpty(Request[&quot;InstanceID&quot;]);
            _IsEdit = (!string.IsNullOrEmpty(Request[&quot;InstanceID&quot;]) &amp;&amp; Request[&quot;InstanceID&quot;].ToInt32_2() &gt; 0);
            _IsView = (!string.IsNullOrEmpty(Request[&quot;Mode&quot;]) &amp;&amp; Request[&quot;Mode&quot;] == &quot;V&quot;);
        }
    }

    [CustomResourceType(&quot;Forms&quot;, &quot;XEQPLOG&quot;)]
    public class PerformELOperations : FormsCustomResource
    {
        public PerformELOperations()
        {
            _Namespace = &quot;Forms&quot;;
            _Path = &quot;Forms.Contract.EquipmentLog&quot;;
            _Name = &quot;PerformELOperations&quot;;
            _Desc = &quot;Perform EL Operations&quot;;
            _InParameters = new[] { &quot;Operation,System.String&quot; };
            _OutParameters = new[] { &quot;IsSuccessful,System.Boolean&quot;, &quot;Message,System.String&quot; };
        }

        public override void ExecuteDerived()
        {
            string operation = GetInputParam(&quot;Operation&quot;).ToString();
            string currentUserId = GetInputParam(&quot;_CurrentUserId&quot;).ToString();
            try
            {
                switch (operation.ToUpper())
                {
                    case &quot;SUBMIT&quot;:
                        SubmitEL(currentUserId);
                        break;
                    case &quot;APPROVE&quot;:
                        ApproveEL(currentUserId);
                        break;
                    case &quot;UNAPPROVE&quot;:
                        UnApproveEL(currentUserId);
                        break;
                }
            }
            catch (Exception ex)
            {
                SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Message&quot;, ex.Message, &quot;System.String&quot;);
                throw ex;
            }
        }

        private void SubmitEL(string currentUserId)
        {
            int isSubmitted = FIXUTBDBL.Instance.UpdateLogBookMasterStatus(InstanceId, currentUserId.ToInt32_2(),
                                                                           DateTime.UtcNow, 2);

            if (isSubmitted == 0)
            {
                SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Message&quot;, &quot;Submit Succesful&quot;, &quot;System.String&quot;);
            }
            else
            {
                SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Message&quot;, &quot;Submit Unsuccesful&quot;, &quot;System.String&quot;);
            }
        }

        private void ApproveEL(string currentUserId)
        {
            int isApproved = FIXUTBDBL.Instance.UpdateLogBookMasterStatus(InstanceId, currentUserId.ToInt32_2(),
                                                                          DateTime.UtcNow, 3);
            if (isApproved == 0)
            {
                SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Message&quot;, &quot;Approve Succesful&quot;, &quot;System.String&quot;);
            }
            else
            {
                SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Message&quot;, &quot;Approve Unsuccesful&quot;, &quot;System.String&quot;);
            }
        }

        private void UnApproveEL(string currentUserId)
        {
            ValidateEquipmentLogApproval(&quot;Undo Approve&quot;);
            int isUnApproved = FIXUTBDBL.Instance.UpdateLogBookMasterStatus(InstanceId, null, null, 1);
            if (isUnApproved == 0)
            {
                SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Message&quot;, &quot;Unapprove Succesful&quot;, &quot;System.String&quot;);
            }
            else
            {
                SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Message&quot;, &quot;Unapprove Unsuccesful&quot;, &quot;System.String&quot;);
            }
        }

        private void ValidateEquipmentLogApproval(string key)
        {
            int retVal = 0;

            int logBookId = InstanceId.ToInt32_2();

            retVal = FIXUTBDBL.Instance.ValidateEquipmentLogApproval(logBookId, key);

            // If the equipment is already used in the pay estimate while undo approving or reopening
            if (retVal == -1)
                throw new Exception(&quot;This equipment log is already used in a &quot; +
                                    LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; . Request denied.&quot;);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[46,17,46,18,0],[46,19,46,63,0],[46,64,46,65,0],[51,17,51,18,0],[51,19,51,58,0],[51,59,51,60,0],[56,17,56,18,0],[56,19,56,63,0],[56,64,56,65,0],[57,17,57,18,0],[57,19,57,58,0],[57,59,57,60,0],[60,31,60,35,0],[60,36,60,40,0],[62,36,62,40,0],[62,41,62,45,0],[64,40,64,44,0],[64,45,64,49,0],[66,44,66,48,0],[66,49,66,53,0],[68,52,68,56,0],[68,57,68,61,0],[75,17,75,18,0],[75,19,75,86,0],[75,87,75,88,0],[83,17,83,18,0],[83,19,83,81,0],[83,82,83,83,0],[91,17,91,18,0],[91,19,91,77,0],[91,78,91,79,0],[96,17,96,18,0],[96,19,96,112,0],[96,113,96,114,0],[102,9,102,10,0],[103,13,103,49,0],[109,13,109,14,0],[110,17,112,98,0],[113,17,113,38,0],[114,13,114,14,0],[118,37,118,38,0],[118,39,118,55,0],[118,56,118,57,0],[122,17,122,18,0],[122,19,122,36,0],[122,37,122,38,0],[127,17,127,18,0],[127,19,127,39,0],[127,40,127,41,0],[132,17,132,18,0],[132,19,132,31,0],[132,32,132,33,0],[137,17,137,18,0],[137,19,137,65,0],[137,66,137,67,0],[143,13,143,14,0],[144,17,146,96,0],[147,17,147,27,0],[148,13,148,14,0],[154,13,154,14,0],[155,17,156,48,0],[157,13,157,14,0],[161,9,161,10,0],[162,13,163,44,0],[164,9,164,10,0],[168,9,168,10,0],[169,13,169,38,0],[170,13,170,26,0],[171,13,171,30,0],[174,13,174,68,0],[176,13,177,45,0],[178,13,178,14,0],[179,17,179,210,0],[180,17,180,29,0],[183,17,183,30,0],[184,9,184,10,0],[189,9,189,10,0],[190,13,190,74,0],[192,13,192,40,0],[194,13,194,36,0],[195,13,195,14,0],[196,17,196,69,0],[197,13,197,14,0],[198,18,198,41,0],[199,13,199,14,0],[200,17,200,51,0],[201,13,201,14,0],[202,13,202,87,0],[203,13,203,100,0],[204,13,205,38,0],[206,13,207,108,0],[208,13,208,75,0],[209,13,209,48,0],[210,13,210,50,0],[211,13,211,71,0],[212,13,212,81,0],[213,13,213,64,0],[214,13,214,84,0],[215,13,215,98,0],[216,13,216,58,0],[217,13,217,151,0],[219,13,219,101,0],[220,13,220,93,0],[221,13,221,89,0],[222,13,222,138,0],[223,13,223,52,0],[225,13,225,77,0],[226,13,226,49,0],[227,13,227,51,0],[228,13,228,74,0],[229,13,229,76,0],[230,13,230,68,0],[231,13,231,85,0],[232,13,232,99,0],[233,13,233,59,0],[234,13,234,152,0],[236,13,236,102,0],[237,13,237,94,0],[238,13,238,90,0],[239,13,239,104,0],[240,13,240,99,0],[241,13,241,92,0],[242,13,242,92,0],[243,13,243,71,0],[244,13,244,53,0],[246,13,246,65,0],[247,13,247,43,0],[248,13,248,45,0],[249,13,249,56,0],[250,13,250,64,0],[251,13,251,56,0],[252,13,252,62,0],[253,13,253,56,0],[254,13,254,79,0],[255,13,255,53,0],[256,13,256,53,0],[257,13,260,102,0],[261,13,261,44,0],[262,13,262,42,0],[263,13,263,38,0],[264,13,264,37,0],[265,13,265,58,0],[266,13,266,57,0],[267,13,267,55,0],[268,13,268,50,0],[269,13,269,37,0],[271,13,271,41,0],[273,13,273,97,0],[274,13,274,114,0],[275,13,275,106,0],[276,13,276,111,0],[277,13,277,100,0],[278,13,278,92,0],[279,13,279,103,0],[280,13,280,101,0],[281,13,281,110,0],[286,13,286,53,0],[288,13,288,66,0],[289,13,289,68,0],[290,13,290,56,0],[291,13,291,37,0],[292,13,292,14,0],[293,17,293,58,0],[294,17,294,62,0],[295,17,295,50,0],[296,17,296,41,0],[297,13,297,14,0],[299,13,299,82,0],[301,13,301,28,0],[302,9,302,10,0],[306,9,306,10,0],[307,13,308,122,0],[309,13,311,54,0],[313,13,313,38,0],[315,13,319,115,0],[320,13,320,76,0],[321,9,321,10,0],[324,9,324,10,0],[325,13,325,75,0],[326,13,326,14,0],[327,17,327,90,0],[328,17,328,80,0],[329,13,329,14,0],[330,13,330,47,0],[331,9,331,10,0],[334,9,334,10,0],[335,13,335,59,0],[336,13,336,42,0],[337,13,337,53,0],[338,9,338,10,0],[341,9,341,10,0],[346,9,346,10,0],[349,9,349,10,0],[350,13,350,58,0],[351,13,351,43,0],[352,9,352,10,0],[355,9,355,10,0],[356,13,356,48,0],[357,13,357,59,0],[358,13,358,71,0],[359,13,359,59,0],[360,9,360,10,0],[364,9,364,10,0],[365,13,365,38,0],[366,13,366,56,0],[369,13,369,38,0],[370,13,370,14,0],[371,17,374,67,0],[375,17,377,94,0],[378,17,379,116,0],[383,13,383,14,0],[386,13,386,14,0],[387,17,387,38,0],[388,17,388,76,0],[389,17,390,102,0],[391,17,391,115,0],[392,13,392,14,0],[393,13,393,45,0],[394,9,394,10,0],[397,9,397,10,0],[398,13,398,37,0],[399,13,399,14,0],[400,17,400,129,0],[401,17,401,107,0],[402,17,402,75,0],[403,17,403,100,0],[404,13,404,14,0],[406,13,406,14,0],[407,17,407,92,0],[408,17,408,127,0],[409,13,409,14,0],[410,13,410,79,0],[411,13,411,81,0],[412,17,413,112,0],[415,13,415,43,0],[416,13,416,29,0],[417,13,417,27,0],[418,13,418,36,0],[419,13,419,30,0],[420,13,420,53,0],[421,9,421,10,0],[424,9,424,10,0],[425,13,425,49,0],[426,13,426,58,0],[427,9,427,10,0],[430,9,430,10,0],[431,13,431,45,0],[433,13,433,43,0],[434,13,434,48,0],[435,13,435,82,0],[436,13,436,58,0],[438,13,438,43,0],[439,13,439,48,0],[440,13,440,45,0],[441,13,441,58,0],[443,13,443,28,0],[444,9,444,10,0],[447,9,447,10,0],[448,13,448,48,0],[449,13,449,58,0],[450,9,450,10,0],[453,9,453,10,0],[454,13,454,83,0],[455,13,455,125,0],[456,13,456,95,0],[457,13,457,98,0],[458,13,458,113,0],[459,13,459,137,0],[461,13,461,76,0],[462,13,462,79,0],[463,13,463,57,0],[464,17,465,112,0],[466,13,466,46,0],[467,13,467,51,0],[468,9,468,10,0],[472,9,472,10,0],[473,13,473,48,0],[474,13,476,94,0],[478,13,478,103,0],[479,13,479,113,0],[480,13,480,46,0],[481,17,481,83,0],[483,17,483,99,0],[485,13,486,122,0],[487,13,489,54,0],[491,13,491,38,0],[492,13,494,96,0],[495,13,495,41,0],[497,13,501,31,0],[502,9,502,10,0],[505,9,505,10,0],[506,13,506,47,0],[507,13,507,59,0],[508,9,508,10,0],[511,9,511,10,0],[512,13,514,33,0],[516,13,516,27,0],[517,13,517,36,0],[519,13,519,39,0],[520,13,523,106,0],[524,13,524,38,0],[525,13,525,14,0],[526,17,526,72,0],[527,13,527,14,0],[529,17,529,29,0],[531,13,531,77,0],[532,13,532,85,0],[534,13,534,89,0],[535,13,535,73,0],[536,13,538,99,0],[540,13,540,105,0],[541,13,541,44,0],[542,9,542,10,0],[545,9,545,10,0],[546,13,547,67,0],[548,9,548,10,0],[551,9,551,10,0],[552,13,552,29,0],[553,9,553,10,0],[556,9,556,10,0],[557,13,557,29,0],[558,9,558,10,0],[561,9,561,10,0],[562,13,562,52,0],[563,13,564,52,0],[564,52,564,95,0],[564,95,565,53,0],[565,53,565,88,0],[565,88,565,116,0],[563,13,565,116,0],[567,13,567,39,0],[568,13,568,14,0],[569,17,569,57,0],[570,17,570,45,0],[571,13,571,14,0],[572,9,572,10,0],[575,9,575,10,0],[576,13,576,32,0],[577,13,577,37,0],[578,9,578,10,0],[581,9,581,10,0],[582,13,582,37,0],[583,9,583,10,0],[586,9,586,10,0],[587,13,587,32,0],[588,13,588,37,0],[589,9,589,10,0],[592,9,592,10,0],[593,13,593,37,0],[594,13,594,73,0],[595,13,595,14,0],[596,17,597,119,0],[598,17,598,40,0],[599,13,599,14,0],[600,9,600,10,0],[603,9,603,10,0],[604,13,604,37,0],[605,9,605,10,0],[608,9,608,10,0],[611,13,611,55,0],[612,9,612,10,0],[616,9,616,10,0],[617,13,617,32,0],[618,13,618,36,0],[619,9,619,10,0],[622,9,622,10,0],[623,13,623,36,0],[624,9,624,10,0],[627,9,627,10,0],[628,13,628,32,0],[629,13,629,36,0],[630,9,630,10,0],[633,9,633,10,0],[634,13,634,36,0],[635,13,635,72,0],[636,13,636,14,0],[637,17,638,114,0],[639,17,639,39,0],[640,13,640,14,0],[641,9,641,10,0],[644,9,644,10,0],[645,13,645,36,0],[646,9,646,10,0],[649,9,649,10,0],[650,13,650,25,0],[651,13,651,63,0],[652,13,652,156,0],[653,13,653,61,0],[654,13,654,14,0],[655,17,655,52,0],[656,17,656,49,0],[657,13,657,14,0],[658,18,658,77,0],[659,13,659,14,0],[660,17,660,50,0],[661,17,661,50,0],[662,17,662,28,0],[663,17,663,31,0],[664,13,664,14,0],[666,13,666,14,0],[667,17,667,50,0],[668,17,668,50,0],[669,13,669,14,0],[671,13,671,37,0],[672,13,672,14,0],[673,17,673,96,0],[674,17,674,72,0],[675,17,675,56,0],[676,13,676,14,0],[678,13,678,29,0],[679,13,679,14,0],[680,17,680,40,0],[681,21,681,55,0],[683,17,683,119,0],[684,17,684,99,0],[685,17,685,41,0],[686,17,686,18,0],[687,21,687,39,0],[688,21,688,100,0],[689,17,689,18,0],[691,17,691,31,0],[692,17,692,32,0],[693,13,693,14,0],[695,13,695,55,0],[697,13,697,60,0],[698,13,698,74,0],[699,13,699,69,0],[700,13,700,80,0],[702,13,702,58,0],[703,13,703,67,0],[704,13,704,64,0],[705,13,705,69,0],[707,13,707,32,0],[708,13,708,83,0],[709,13,709,87,0],[711,13,711,45,0],[712,13,712,50,0],[713,13,713,52,0],[714,13,714,51,0],[715,13,715,94,0],[716,13,717,120,0],[718,9,718,10,0],[721,9,721,10,0],[722,13,723,41,0],[723,41,723,103,0],[723,103,723,111,0],[722,13,723,111,0],[724,13,725,42,0],[725,42,725,107,0],[725,107,725,115,0],[724,13,725,115,0],[726,13,727,40,0],[727,40,727,103,0],[727,103,727,111,0],[726,13,727,111,0],[728,13,728,52,0],[729,13,729,125,0],[730,13,730,61,0],[731,13,731,109,0],[732,9,732,10,0],[735,9,735,10,0],[736,13,736,35,0],[737,13,737,39,0],[739,13,739,41,0],[740,13,740,75,0],[741,17,741,38,0],[742,13,742,82,0],[743,13,743,44,0],[744,9,744,10,0],[747,9,747,10,0],[748,13,748,75,0],[749,13,749,14,0],[750,17,750,35,0],[751,17,751,18,0],[752,21,752,82,0],[753,21,753,41,0],[754,21,754,22,0],[755,25,755,56,0],[756,25,756,70,0],[757,21,757,22,0],[758,13,758,14,0],[759,13,759,14,0],[760,13,760,80,0],[761,13,761,80,0],[762,9,762,10,0],[765,9,765,10,0],[766,13,766,48,0],[767,17,770,74,0],[771,9,771,10,0],[774,9,774,10,0],[775,13,775,99,0],[776,13,776,35,0],[777,17,779,72,0],[780,9,780,10,0],[783,9,783,10,0],[784,13,784,69,0],[785,13,785,69,0],[786,13,786,68,0],[787,13,787,78,0],[789,13,789,48,0],[790,9,790,10,0],[793,9,793,10,0],[794,13,794,20,0],[794,22,794,38,0],[794,39,794,41,0],[794,42,794,51,0],[795,13,795,14,0],[796,17,796,66,0],[797,21,797,43,0],[798,13,798,14,0],[799,9,799,10,0],[802,9,802,10,0],[805,13,805,53,0],[806,13,806,35,0],[808,13,808,80,0],[809,13,809,37,0],[815,13,815,106,0],[816,13,816,35,0],[818,13,818,68,0],[819,13,819,40,0],[822,13,822,81,0],[828,13,828,29,0],[830,13,830,85,0],[831,13,831,40,0],[837,13,837,80,0],[838,13,838,39,0],[840,13,840,77,0],[841,13,841,42,0],[843,13,843,55,0],[845,13,845,30,0],[848,9,848,10,0],[851,9,851,10,0],[852,13,852,42,0],[853,9,853,10,0],[856,9,856,10,0],[858,13,858,14,0],[859,17,859,62,0],[861,17,861,41,0],[862,17,862,18,0],[863,17,863,18,0],[864,17,864,31,0],[865,17,865,27,0],[866,17,866,32,0],[867,17,867,30,0],[868,17,868,29,0],[870,17,870,62,0],[871,13,871,14,0],[872,13,872,33,0],[873,13,873,14,0],[874,17,874,121,0],[875,17,875,44,0],[876,13,876,14,0],[877,9,877,10,0],[880,9,880,10,0],[881,13,881,45,0],[882,13,882,33,0],[883,13,883,14,0],[884,17,884,60,0],[885,17,885,48,0],[886,13,886,14,0],[888,13,888,71,0],[889,13,889,77,0],[890,13,890,20,0],[890,22,890,38,0],[890,39,890,41,0],[890,42,890,53,0],[891,13,891,14,0],[892,17,892,61,0],[893,17,893,18,0],[894,21,896,94,0],[897,21,899,90,0],[900,21,901,104,0],[903,21,926,36,0],[927,21,927,47,0],[930,21,930,22,0],[931,25,931,76,0],[932,21,932,22,0],[933,21,933,26,0],[934,21,934,22,0],[936,21,936,22,0],[938,21,940,79,0],[941,21,941,22,0],[942,25,944,50,0],[946,25,947,85,0],[949,25,979,41,0],[980,25,980,61,0],[983,25,983,26,0],[984,29,984,84,0],[985,25,985,26,0],[986,25,986,30,0],[987,25,987,26,0],[989,25,989,26,0],[990,21,990,22,0],[991,17,991,18,0],[992,13,992,14,0],[993,9,993,10,0],[996,9,996,10,0],[997,13,998,68,0],[999,13,1002,60,0],[1003,13,1003,61,0],[1005,13,1005,14,0],[1006,17,1006,72,0],[1007,13,1007,14,0],[1008,13,1008,18,0],[1009,13,1009,14,0],[1010,13,1010,14,0],[1011,9,1011,10,0],[1014,9,1014,10,0],[1015,13,1015,78,0],[1016,13,1016,86,0],[1017,9,1017,10,0],[1020,9,1020,10,0],[1021,13,1021,50,0],[1022,13,1022,33,0],[1023,13,1023,14,0],[1024,17,1024,65,0],[1025,13,1025,14,0],[1027,13,1027,71,0],[1028,13,1028,20,0],[1028,22,1028,38,0],[1028,39,1028,41,0],[1028,42,1028,58,0],[1029,13,1029,14,0],[1030,17,1030,61,0],[1031,17,1031,18,0],[1032,21,1064,37,0],[1065,21,1065,53,0],[1066,17,1066,18,0],[1068,17,1068,18,0],[1069,21,1069,72,0],[1070,17,1070,18,0],[1071,17,1071,22,0],[1072,17,1072,18,0],[1074,17,1074,18,0],[1075,13,1075,14,0],[1076,9,1076,10,0],[1079,9,1079,10,0],[1080,13,1080,52,0],[1081,13,1081,33,0],[1082,13,1082,14,0],[1083,17,1083,63,0],[1084,13,1084,14,0],[1086,13,1086,71,0],[1087,13,1087,20,0],[1087,22,1087,38,0],[1087,39,1087,41,0],[1087,42,1087,56,0],[1088,13,1088,14,0],[1089,17,1089,65,0],[1090,17,1090,18,0],[1091,21,1109,37,0],[1110,21,1110,51,0],[1111,17,1111,18,0],[1112,13,1112,14,0],[1114,13,1114,14,0],[1115,17,1115,68,0],[1116,13,1116,14,0],[1117,13,1117,18,0],[1118,13,1118,14,0],[1120,13,1120,14,0],[1121,9,1121,10,0],[1124,9,1124,10,0],[1125,13,1125,51,0],[1126,13,1126,33,0],[1127,13,1127,14,0],[1128,17,1128,69,0],[1129,13,1129,14,0],[1131,13,1131,71,0],[1132,13,1132,20,0],[1132,22,1132,38,0],[1132,39,1132,41,0],[1132,42,1132,55,0],[1133,13,1133,14,0],[1134,17,1134,65,0],[1135,17,1135,18,0],[1136,21,1176,36,0],[1177,21,1177,56,0],[1178,17,1178,18,0],[1179,13,1179,14,0],[1181,13,1181,14,0],[1182,17,1182,68,0],[1183,13,1183,14,0],[1184,13,1184,18,0],[1185,13,1185,14,0],[1187,13,1187,14,0],[1188,9,1188,10,0],[1191,9,1191,10,0],[1192,13,1192,39,0],[1192,40,1192,63,0],[1193,13,1193,68,0],[1194,13,1194,14,0],[1195,17,1195,41,0],[1196,13,1196,14,0],[1197,13,1197,27,0],[1198,9,1198,10,0],[1201,9,1201,10,0],[1202,13,1202,63,0],[1203,13,1203,14,0],[1204,17,1204,46,0],[1205,17,1205,40,0],[1206,17,1206,40,0],[1207,13,1207,14,0],[1209,13,1209,14,0],[1210,17,1210,49,0],[1211,17,1211,41,0],[1212,13,1212,14,0],[1213,13,1213,27,0],[1214,9,1214,10,0],[1217,9,1217,10,0],[1218,13,1218,37,0],[1219,13,1220,112,0],[1221,13,1221,29,0],[1222,9,1222,10,0],[1225,9,1225,10,0],[1226,13,1228,112,0],[1229,13,1229,83,0],[1230,13,1230,75,0],[1231,9,1231,10,0],[1234,9,1234,10,0],[1235,13,1235,65,0],[1236,13,1236,14,0],[1237,17,1237,48,0],[1238,17,1238,41,0],[1239,17,1239,53,0],[1240,21,1241,120,0],[1242,17,1242,42,0],[1243,13,1243,14,0],[1245,13,1245,14,0],[1246,17,1246,51,0],[1247,17,1247,40,0],[1248,17,1248,45,0],[1249,17,1249,43,0],[1250,13,1250,14,0],[1251,13,1251,29,0],[1252,9,1252,10,0],[1255,9,1255,10,0],[1256,13,1256,36,0],[1257,13,1257,52,0],[1257,53,1257,69,0],[1258,9,1258,10,0],[1261,9,1261,10,0],[1262,13,1262,35,0],[1263,13,1263,50,0],[1263,51,1263,65,0],[1264,9,1264,10,0],[1267,9,1267,10,0],[1268,13,1268,41,0],[1269,13,1269,83,0],[1271,13,1271,93,0],[1273,13,1273,113,0],[1274,13,1274,54,0],[1275,13,1275,63,0],[1276,13,1276,53,0],[1277,13,1277,42,0],[1279,13,1279,71,0],[1280,13,1284,92,0],[1285,13,1285,50,0],[1286,13,1287,51,0],[1287,51,1287,97,0],[1287,97,1289,49,0],[1289,49,1289,120,0],[1289,120,1290,51,0],[1290,51,1290,98,0],[1290,98,1291,52,0],[1291,52,1291,90,0],[1291,90,1291,118,0],[1286,13,1291,118,0],[1294,13,1294,98,0],[1295,13,1295,32,0],[1296,13,1296,14,0],[1297,17,1297,24,0],[1297,26,1297,43,0],[1297,44,1297,46,0],[1297,47,1297,62,0],[1298,17,1298,18,0],[1299,21,1300,93,0],[1301,21,1301,22,0],[1302,25,1305,75,0],[1306,25,1306,26,0],[1307,29,1307,73,0],[1308,29,1308,69,0],[1309,29,1309,59,0],[1310,29,1310,64,0],[1311,25,1311,26,0],[1312,21,1312,22,0],[1313,17,1313,18,0],[1314,13,1314,14,0],[1316,13,1316,51,0],[1317,13,1317,14,0],[1318,17,1318,63,0],[1319,17,1319,65,0],[1320,17,1320,56,0],[1322,17,1322,18,0],[1323,21,1323,46,0],[1324,17,1324,18,0],[1325,17,1325,22,0],[1326,17,1326,18,0],[1328,17,1328,18,0],[1329,13,1329,14,0],[1330,13,1330,53,0],[1331,13,1331,45,0],[1332,13,1332,35,0],[1333,9,1333,10,0],[1337,9,1337,10,0],[1338,13,1338,50,0],[1339,13,1339,14,0],[1340,17,1341,91,0],[1342,17,1342,137,0],[1343,17,1343,154,0],[1345,17,1345,50,0],[1346,21,1346,79,0],[1347,17,1347,45,0],[1348,21,1348,65,0],[1349,17,1349,96,0],[1350,17,1352,108,0],[1353,13,1353,14,0],[1354,9,1354,10,0],[1357,9,1357,10,0],[1358,13,1358,33,0],[1359,13,1359,14,0],[1360,17,1360,75,0],[1361,17,1363,71,0],[1365,17,1365,47,0],[1366,17,1366,61,0],[1367,17,1367,102,0],[1368,17,1368,49,0],[1369,17,1369,53,0],[1370,17,1370,42,0],[1371,17,1371,47,0],[1372,17,1372,104,0],[1373,17,1373,116,0],[1374,17,1374,41,0],[1375,17,1375,18,0],[1376,21,1376,93,0],[1377,21,1377,45,0],[1378,21,1378,91,0],[1379,21,1379,81,0],[1380,21,1380,111,0],[1381,17,1381,18,0],[1383,17,1383,36,0],[1384,21,1384,35,0],[1385,13,1385,14,0],[1387,13,1387,64,0],[1388,13,1388,31,0],[1390,13,1390,74,0],[1391,13,1391,36,0],[1393,13,1393,70,0],[1394,13,1394,34,0],[1396,13,1396,75,0],[1397,13,1397,33,0],[1399,13,1399,35,0],[1400,9,1400,10,0],[1403,9,1403,10,0],[1404,13,1404,139,0],[1405,9,1405,10,0],[1408,9,1408,10,0],[1409,13,1409,43,0],[1410,13,1410,87,0],[1412,13,1412,71,0],[1413,13,1420,85,0],[1421,13,1421,45,0],[1422,13,1424,102,0],[1425,13,1425,50,0],[1426,13,1426,14,0],[1427,17,1427,68,0],[1428,17,1428,102,0],[1429,17,1429,61,0],[1430,17,1430,43,0],[1431,22,1431,67,0],[1431,69,1431,88,0],[1431,90,1431,106,0],[1432,17,1432,18,0],[1434,21,1436,55,0],[1437,21,1437,49,0],[1438,21,1438,22,0],[1439,25,1439,98,0],[1440,25,1440,26,0],[1441,29,1441,122,0],[1442,29,1442,38,0],[1444,21,1444,22,0],[1446,21,1453,111,0],[1454,25,1454,79,0],[1456,25,1458,84,0],[1459,17,1459,18,0],[1460,13,1460,14,0],[1461,13,1461,42,0],[1462,13,1462,14,0],[1463,17,1463,24,0],[1463,26,1463,42,0],[1463,43,1463,45,0],[1463,46,1463,59,0],[1464,17,1464,18,0],[1465,21,1470,68,0],[1471,21,1471,22,0],[1472,25,1473,116,0],[1474,25,1474,81,0],[1475,29,1475,70,0],[1476,21,1476,22,0],[1477,17,1477,18,0],[1479,17,1479,24,0],[1479,26,1479,40,0],[1479,41,1479,43,0],[1479,44,1479,56,0],[1480,17,1480,18,0],[1481,21,1483,68,0],[1484,21,1484,22,0],[1485,25,1485,96,0],[1486,25,1486,57,0],[1487,29,1487,58,0],[1488,21,1488,22,0],[1489,17,1489,18,0],[1491,17,1491,56,0],[1492,17,1492,67,0],[1493,17,1493,71,0],[1495,17,1495,18,0],[1496,21,1496,48,0],[1497,17,1497,18,0],[1498,17,1498,22,0],[1499,17,1499,18,0],[1501,17,1501,18,0],[1502,13,1502,14,0],[1504,13,1504,55,0],[1505,13,1505,47,0],[1506,13,1506,36,0],[1508,13,1508,81,0],[1509,13,1509,14,0],[1510,17,1511,102,0],[1512,17,1512,46,0],[1513,21,1513,77,0],[1514,13,1514,14,0],[1515,9,1515,10,0],[1518,9,1518,10,0],[1519,13,1519,52,0],[1520,13,1520,14,0],[1521,17,1523,133,0],[1525,17,1525,115,0],[1527,17,1531,46,0],[1534,17,1534,53,0],[1535,17,1535,18,0],[1536,21,1536,92,0],[1537,21,1539,85,0],[1540,21,1540,75,0],[1541,21,1541,106,0],[1542,17,1542,18,0],[1543,13,1543,14,0],[1544,9,1544,10,0],[1547,9,1547,10,0],[1549,13,1551,102,0],[1552,13,1552,39,0],[1553,13,1553,56,0],[1554,18,1554,58,0],[1554,60,1554,73,0],[1554,75,1554,85,0],[1555,13,1555,14,0],[1556,17,1558,98,0],[1559,22,1559,74,0],[1559,76,1559,95,0],[1559,97,1559,113,0],[1560,17,1560,18,0],[1562,21,1564,114,0],[1565,21,1565,49,0],[1566,21,1566,22,0],[1567,25,1567,98,0],[1568,25,1568,26,0],[1569,29,1569,38,0],[1571,21,1571,22,0],[1573,21,1576,27,0],[1577,25,1577,93,0],[1578,17,1578,18,0],[1579,17,1579,54,0],[1580,21,1580,71,0],[1581,13,1581,14,0],[1583,13,1583,50,0],[1584,13,1584,55,0],[1585,13,1585,93,0],[1586,13,1586,37,0],[1587,13,1587,133,0],[1588,13,1588,84,0],[1589,13,1589,40,0],[1591,13,1591,46,0],[1592,17,1592,86,0],[1594,13,1594,43,0],[1595,13,1595,14,0],[1596,17,1596,75,0],[1597,17,1597,54,0],[1598,21,1598,52,0],[1599,17,1599,151,0],[1600,13,1600,14,0],[1601,13,1601,37,0],[1602,9,1602,10,0],[1605,9,1605,10,0],[1606,13,1606,20,0],[1606,22,1606,36,0],[1606,37,1606,39,0],[1606,40,1606,48,0],[1607,13,1607,14,0],[1608,17,1608,41,0],[1609,21,1609,56,0],[1610,13,1610,14,0],[1611,9,1611,10,0],[1614,9,1614,10,0],[1615,13,1617,42,0],[1618,9,1618,10,0],[1621,9,1621,10,0],[1622,13,1623,43,0],[1624,9,1624,10,0],[1627,9,1627,10,0],[1628,13,1630,40,0],[1631,9,1631,10,0],[1634,9,1634,10,0],[1635,13,1635,37,0],[1636,13,1637,41,0],[1638,9,1638,10,0],[1641,9,1641,10,0],[1642,13,1642,35,0],[1643,13,1643,14,0],[1644,17,1644,39,0],[1645,17,1645,24,0],[1645,26,1645,42,0],[1645,43,1645,45,0],[1645,46,1645,62,0],[1646,21,1646,116,0],[1647,25,1647,43,0],[1648,17,1648,24,0],[1648,26,1648,42,0],[1648,43,1648,45,0],[1648,46,1648,59,0],[1649,21,1649,116,0],[1650,25,1650,43,0],[1652,17,1652,106,0],[1653,17,1653,57,0],[1654,13,1654,14,0],[1655,9,1655,10,0],[1659,9,1659,10,0],[1660,13,1660,63,0],[1661,13,1661,71,0],[1663,13,1663,14,0],[1664,17,1664,41,0],[1665,17,1665,41,0],[1666,17,1666,46,0],[1667,17,1667,41,0],[1668,17,1668,18,0],[1670,21,1670,81,0],[1671,25,1671,48,0],[1674,21,1674,91,0],[1675,25,1675,65,0],[1676,21,1676,54,0],[1677,21,1677,22,0],[1678,25,1679,116,0],[1680,25,1680,54,0],[1683,21,1683,22,0],[1684,25,1684,60,0],[1685,21,1685,22,0],[1686,21,1688,85,0],[1690,21,1690,100,0],[1691,21,1691,121,0],[1697,17,1697,18,0],[1698,17,1698,37,0],[1699,17,1699,18,0],[1701,21,1725,36,0],[1727,21,1727,61,0],[1728,21,1728,72,0],[1729,21,1729,51,0],[1730,17,1730,18,0],[1732,17,1732,18,0],[1733,21,1735,73,0],[1738,21,1738,45,0],[1739,25,1741,72,0],[1743,25,1745,72,0],[1747,21,1747,51,0],[1748,21,1748,108,0],[1749,21,1749,65,0],[1750,21,1750,53,0],[1751,21,1751,57,0],[1752,21,1752,51,0],[1753,21,1753,62,0],[1754,21,1754,70,0],[1755,21,1755,71,0],[1757,21,1757,45,0],[1758,21,1758,22,0],[1759,25,1759,55,0],[1760,25,1760,75,0],[1761,25,1761,75,0],[1762,25,1762,49,0],[1763,25,1763,49,0],[1764,25,1764,69,0],[1765,25,1765,65,0],[1766,21,1766,22,0],[1768,21,1768,68,0],[1769,21,1769,72,0],[1770,17,1770,18,0],[1771,13,1771,14,0],[1772,13,1772,33,0],[1773,13,1773,14,0],[1774,17,1774,49,0],[1777,13,1777,39,0],[1778,9,1778,10,0],[1781,9,1781,10,0],[1782,13,1782,71,0],[1783,13,1786,57,0],[1787,9,1787,10,0],[1790,9,1790,10,0],[1791,13,1791,71,0],[1792,13,1797,69,0],[1799,13,1799,94,0],[1800,13,1800,28,0],[1801,13,1801,54,0],[1802,17,1802,71,0],[1804,13,1804,22,0],[1806,13,1806,63,0],[1807,13,1807,30,0],[1808,9,1808,10,0],[1811,9,1811,10,0],[1812,13,1812,38,0],[1813,13,1813,43,0],[1814,13,1814,41,0],[1815,13,1815,40,0],[1816,9,1816,10,0],[1819,9,1819,10,0],[1820,13,1820,70,0],[1821,13,1821,65,0],[1822,13,1822,62,0],[1824,13,1824,65,0],[1838,13,1838,108,0],[1839,13,1839,106,0],[1840,13,1840,104,0],[1841,13,1841,79,0],[1842,13,1842,101,0],[1844,13,1844,95,0],[1845,13,1845,78,0],[1846,13,1846,87,0],[1847,13,1847,81,0],[1849,13,1849,102,0],[1850,13,1850,14,0],[1851,17,1851,125,0],[1852,17,1852,102,0],[1853,13,1853,14,0],[1860,13,1860,87,0],[1861,9,1861,10,0],[1864,9,1864,10,0],[1865,13,1865,65,0],[1866,13,1866,66,0],[1868,13,1868,103,0],[1869,13,1869,78,0],[1870,13,1870,100,0],[1872,13,1872,94,0],[1873,13,1873,88,0],[1874,13,1874,86,0],[1876,13,1876,66,0],[1877,9,1877,10,0],[1880,9,1880,10,0],[1881,13,1881,68,0],[1882,13,1882,68,0],[1883,13,1883,65,0],[1884,13,1884,65,0],[1886,13,1886,111,0],[1887,13,1887,109,0],[1888,13,1888,107,0],[1889,13,1889,82,0],[1890,13,1890,104,0],[1892,13,1892,75,0],[1893,13,1893,85,0],[1894,13,1894,81,0],[1895,13,1895,90,0],[1897,13,1897,90,0],[1898,9,1898,10,0],[1901,9,1901,10,0],[1902,13,1902,59,0],[1903,13,1903,63,0],[1904,13,1904,60,0],[1905,13,1905,65,0],[1907,13,1907,82,0],[1908,13,1908,80,0],[1910,13,1910,70,0],[1911,13,1911,79,0],[1912,13,1912,75,0],[1913,13,1913,89,0],[1914,13,1914,85,0],[1915,13,1916,77,0],[1918,13,1918,89,0],[1919,9,1919,10,0],[1922,9,1922,10,0],[1923,13,1923,20,0],[1923,22,1923,32,0],[1923,33,1923,35,0],[1923,36,1923,40,0],[1924,13,1924,14,0],[1925,17,1925,96,0],[1926,17,1926,93,0],[1927,13,1927,14,0],[1928,9,1928,10,0],[1931,9,1931,10,0],[1932,13,1932,115,0],[1933,9,1933,10,0],[1936,9,1936,10,0],[1937,13,1939,123,0],[1940,13,1940,103,0],[1941,13,1941,14,0],[1944,17,1946,97,0],[1947,17,1947,106,0],[1948,17,1948,41,0],[1949,17,1949,32,0],[1950,17,1950,18,0],[1951,21,1951,40,0],[1952,17,1952,18,0],[1954,17,1954,18,0],[1955,21,1955,46,0],[1956,17,1956,18,0],[1958,17,1958,43,0],[1959,17,1959,46,0],[1960,17,1960,44,0],[1961,13,1961,14,0],[1962,13,1962,33,0],[1963,9,1963,10,0],[1966,9,1966,10,0],[1967,13,1967,40,0],[1968,13,1968,36,0],[1969,13,1969,39,0],[1970,13,1970,44,0],[1971,13,1971,42,0],[1972,13,1972,14,0],[1975,17,1978,110,0],[1979,17,1979,42,0],[1980,17,1980,18,0],[1981,21,1983,79,0],[1984,21,1984,76,0],[1985,17,1985,18,0],[1987,21,1987,33,0],[1990,17,1990,91,0],[1991,17,1991,81,0],[1992,17,1992,89,0],[1993,17,1993,93,0],[1994,17,1994,77,0],[1995,17,1997,83,0],[1999,17,1999,31,0],[2000,17,2000,113,0],[2001,17,2001,18,0],[2002,21,2002,110,0],[2003,21,2003,55,0],[2004,21,2004,61,0],[2005,21,2005,63,0],[2006,21,2006,28,0],[2006,30,2006,40,0],[2006,41,2006,43,0],[2006,44,2006,65,0],[2007,21,2007,22,0],[2008,25,2008,86,0],[2009,25,2009,161,0],[2010,25,2010,166,0],[2011,25,2011,112,0],[2013,25,2013,41,0],[2014,25,2014,65,0],[2015,25,2015,26,0],[2016,29,2016,123,0],[2017,29,2017,112,0],[2018,29,2020,58,0],[2021,29,2023,60,0],[2024,25,2024,26,0],[2026,25,2026,54,0],[2027,29,2027,58,0],[2028,21,2028,22,0],[2029,17,2029,18,0],[2030,13,2030,14,0],[2032,13,2032,14,0],[2033,17,2033,46,0],[2034,17,2034,46,0],[2035,17,2035,44,0],[2036,17,2036,39,0],[2037,17,2037,18,0],[2038,21,2040,67,0],[2041,17,2041,18,0],[2042,22,2042,44,0],[2043,17,2043,18,0],[2044,21,2046,72,0],[2047,17,2047,18,0],[2049,17,2049,43,0],[2050,17,2050,86,0],[2051,17,2051,24,0],[2051,26,2051,40,0],[2051,41,2051,43,0],[2051,44,2051,52,0],[2052,17,2052,18,0],[2053,21,2053,46,0],[2054,17,2054,18,0],[2055,17,2055,45,0],[2056,17,2056,51,0],[2057,17,2057,53,0],[2058,17,2058,24,0],[2058,26,2058,36,0],[2058,37,2058,39,0],[2058,40,2058,51,0],[2059,17,2059,18,0],[2060,21,2060,43,0],[2061,25,2061,68,0],[2062,26,2062,48,0],[2063,25,2063,77,0],[2064,21,2064,37,0],[2066,21,2066,67,0],[2067,21,2067,22,0],[2068,25,2068,117,0],[2069,25,2069,104,0],[2070,25,2070,115,0],[2071,25,2071,119,0],[2072,21,2072,22,0],[2073,17,2073,18,0],[2074,17,2074,46,0],[2075,13,2075,14,0],[2076,13,2076,33,0],[2077,9,2077,10,0],[2080,9,2080,10,0],[2081,13,2081,41,0],[2082,13,2082,14,0],[2083,17,2085,70,0],[2086,17,2086,43,0],[2087,17,2090,110,0],[2091,17,2091,42,0],[2092,17,2092,18,0],[2093,21,2093,76,0],[2094,17,2094,18,0],[2096,21,2096,33,0],[2097,17,2097,91,0],[2098,17,2098,81,0],[2099,17,2099,89,0],[2100,17,2100,93,0],[2101,17,2101,77,0],[2102,17,2104,83,0],[2105,17,2105,40,0],[2106,17,2106,31,0],[2107,17,2107,113,0],[2108,17,2108,18,0],[2109,21,2109,110,0],[2110,21,2110,41,0],[2114,21,2114,44,0],[2117,13,2117,14,0],[2118,17,2118,33,0],[2119,17,2121,68,0],[2122,17,2122,103,0],[2124,17,2124,24,0],[2124,26,2124,36,0],[2124,37,2124,39,0],[2124,40,2124,48,0],[2125,17,2125,18,0],[2126,21,2126,63,0],[2127,17,2127,18,0],[2128,17,2128,70,0],[2129,17,2129,75,0],[2131,17,2131,51,0],[2132,17,2132,24,0],[2132,26,2132,46,0],[2132,47,2132,49,0],[2132,50,2132,58,0],[2133,17,2133,18,0],[2134,21,2134,54,0],[2135,17,2135,18,0],[2136,17,2136,65,0],[2137,21,2137,81,0],[2138,17,2138,33,0],[2140,9,2140,10,0],[2143,9,2143,10,0],[2144,13,2144,33,0],[2145,13,2145,73,0],[2146,13,2146,14,0],[2147,17,2147,65,0],[2148,17,2149,46,0],[2149,46,2149,100,0],[2149,100,2150,46,0],[2150,46,2150,94,0],[2150,94,2151,46,0],[2151,46,2151,108,0],[2151,108,2152,46,0],[2152,46,2152,93,0],[2152,93,2153,47,0],[2153,47,2157,52,0],[2157,52,2157,71,0],[2148,17,2157,71,0],[2159,17,2159,45,0],[2160,17,2160,18,0],[2161,21,2162,100,0],[2163,21,2163,68,0],[2164,25,2165,61,0],[2166,17,2166,18,0],[2167,13,2167,14,0],[2168,13,2168,29,0],[2169,9,2169,10,0],[2172,9,2172,10,0],[2173,13,2173,41,0],[2174,13,2175,38,0],[2175,38,2175,92,0],[2175,92,2176,38,0],[2176,38,2176,86,0],[2176,86,2177,39,0],[2177,39,2181,44,0],[2181,44,2181,45,0],[2174,13,2181,45,0],[2183,13,2183,20,0],[2183,22,2183,37,0],[2183,38,2183,40,0],[2183,41,2183,53,0],[2184,13,2184,14,0],[2185,17,2185,111,0],[2186,13,2186,14,0],[2187,13,2187,40,0],[2188,9,2188,10,0],[2191,9,2191,10,0],[2192,13,2192,64,0],[2193,13,2193,64,0],[2194,13,2194,60,0],[2195,13,2195,60,0],[2196,13,2196,71,0],[2197,9,2197,10,0],[2200,9,2200,10,0],[2201,13,2201,49,0],[2202,13,2202,41,0],[2203,13,2203,39,0],[2204,13,2204,40,0],[2205,13,2205,37,0],[2206,13,2206,46,0],[2207,13,2207,44,0],[2208,13,2208,43,0],[2209,13,2209,41,0],[2211,13,2211,39,0],[2212,13,2212,40,0],[2213,13,2213,42,0],[2215,13,2215,39,0],[2216,13,2216,40,0],[2217,13,2217,42,0],[2219,13,2219,39,0],[2220,13,2220,40,0],[2221,13,2221,42,0],[2223,13,2223,41,0],[2224,13,2224,42,0],[2225,13,2225,44,0],[2226,9,2226,10,0],[2229,9,2229,10,0],[2230,13,2230,62,0],[2231,13,2231,103,0],[2232,13,2232,103,0],[2233,13,2233,54,0],[2234,13,2234,30,0],[2235,9,2235,10,0],[2238,9,2238,10,0],[2239,13,2239,41,0],[2240,13,2240,51,0],[2241,13,2241,14,0],[2242,17,2244,73,0],[2245,13,2245,14,0],[2246,13,2246,53,0],[2247,9,2247,10,0],[2250,9,2250,10,0],[2251,13,2251,54,0],[2252,13,2252,59,0],[2253,13,2253,59,0],[2254,13,2254,48,0],[2255,13,2255,20,0],[2256,17,2256,34,0],[2256,35,2256,37,0],[2257,21,2258,86,0],[2259,13,2259,14,0],[2260,17,2260,68,0],[2261,17,2261,72,0],[2262,17,2262,72,0],[2263,17,2263,59,0],[2264,13,2264,14,0],[2265,13,2265,39,0],[2266,9,2266,10,0],[2269,9,2269,10,0],[2270,13,2270,30,0],[2271,13,2271,37,0],[2272,13,2272,29,0],[2273,13,2273,27,0],[2274,13,2274,36,0],[2275,13,2275,30,0],[2276,9,2276,10,0],[2279,9,2279,10,0],[2280,13,2280,37,0],[2281,13,2281,29,0],[2282,13,2282,27,0],[2283,13,2283,36,0],[2284,13,2284,30,0],[2285,13,2285,59,0],[2286,9,2286,10,0],[2289,9,2289,10,0],[2290,13,2290,118,0],[2291,13,2291,30,0],[2292,13,2292,107,0],[2293,13,2293,14,0],[2294,17,2294,92,0],[2295,13,2295,14,0],[2296,13,2296,116,0],[2297,9,2297,10,0],[2300,9,2300,10,0],[2301,13,2301,33,0],[2302,13,2302,49,0],[2303,17,2303,71,0],[2304,13,2304,30,0],[2305,13,2305,102,0],[2306,13,2306,14,0],[2307,17,2308,107,0],[2309,13,2309,14,0],[2311,13,2311,14,0],[2313,17,2313,50,0],[2314,17,2314,41,0],[2315,17,2315,33,0],[2316,17,2316,31,0],[2317,17,2317,40,0],[2318,17,2318,34,0],[2319,13,2319,14,0],[2320,9,2320,10,0],[2323,9,2323,10,0],[2324,13,2324,89,0],[2325,13,2325,62,0],[2326,9,2326,10,0],[2329,9,2329,10,0],[2330,13,2330,66,0],[2331,13,2331,111,0],[2332,13,2332,90,0],[2333,9,2333,10,0],[2339,9,2339,37,0],[2340,9,2340,10,0],[2341,13,2341,34,0],[2342,13,2342,51,0],[2343,13,2343,43,0],[2344,13,2344,45,0],[2345,13,2345,65,0],[2346,13,2346,95,0],[2347,9,2347,10,0],[2350,9,2350,10,0],[2351,13,2351,70,0],[2352,13,2352,79,0],[2354,13,2354,14,0],[2355,17,2355,45,0],[2358,25,2358,49,0],[2359,25,2359,31,0],[2361,25,2361,50,0],[2362,25,2362,31,0],[2364,25,2364,52,0],[2365,25,2365,31,0],[2367,13,2367,14,0],[2368,13,2368,33,0],[2369,13,2369,14,0],[2370,17,2370,70,0],[2371,17,2371,69,0],[2372,17,2372,26,0],[2374,9,2374,10,0],[2377,9,2377,10,0],[2378,13,2379,96,0],[2381,13,2381,34,0],[2382,13,2382,14,0],[2383,17,2383,69,0],[2384,17,2384,77,0],[2385,13,2385,14,0],[2387,13,2387,14,0],[2388,17,2388,70,0],[2389,17,2389,79,0],[2390,13,2390,14,0],[2391,9,2391,10,0],[2394,9,2394,10,0],[2395,13,2396,95,0],[2397,13,2397,33,0],[2398,13,2398,14,0],[2399,17,2399,69,0],[2400,17,2400,78,0],[2401,13,2401,14,0],[2403,13,2403,14,0],[2404,17,2404,70,0],[2405,17,2405,80,0],[2406,13,2406,14,0],[2407,9,2407,10,0],[2410,9,2410,10,0],[2411,13,2411,58,0],[2412,13,2412,104,0],[2413,13,2413,35,0],[2414,13,2414,14,0],[2415,17,2415,69,0],[2416,17,2416,80,0],[2417,13,2417,14,0],[2419,13,2419,14,0],[2420,17,2420,70,0],[2421,17,2421,82,0],[2422,13,2422,14,0],[2423,9,2423,10,0],[2426,9,2426,10,0],[2427,13,2427,28,0],[2429,13,2429,52,0],[2431,13,2431,86,0],[2434,13,2434,30,0],[2435,17,2436,122,0],[2437,9,2437,10,0]]);
    </script>
  </body>
</html>