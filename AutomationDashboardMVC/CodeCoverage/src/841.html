<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\AbstractModels\GenericXMLListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.LibraryUI;
using Aurigo.AMP3.LinksBL;
using Aurigo.AMP3.LinksDTO;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.BusinessLayer.XmlForm_Framework;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.ReportServerHelper;
using Aurigo.Common;
using Infragistics.WebUI.UltraWebGrid.ExcelExport;
using pdftron.PDF;
using pdftron.SDF;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Globalization;
using System.IO;
using System.Json;
using System.Linq;
using System.Text;
using System.Threading;
using System.Web;
using System.Web.UI.WebControls;
using Telerik.Web.UI;
using Section = Aurigo.Brix.Platform.BusinessLayer.XMLForm.Section;

namespace Aurigo.AMP3.Core.AbstractModels
{
    [Context(Name = &quot;WEBXMLFORMHANDLER&quot;)]
    public class GenericXMLListModel : ListModel
    {
        private int columnCounter;
        private Dictionary&lt;string, BrixFilter&gt; filters;
        private List&lt;string&gt; listCols;
        private List&lt;Guid&gt; workflowsInitiated;
        private List&lt;string&gt; _docmgmtModuleComponents = null;
        private bool _executeDerived = true;

        private bool _isExcelExportContext = false;
        public bool QRCodeEnabled { get; set; }

        public override string PreWorkFlowValidation(string action, object obj)
        {
            if (listManagerModel != null)
                return listManagerModel.PreWorkFlowValidation(action, obj);

            return string.Empty;

        }
        private List&lt;string&gt; DOCMGMTModuleComponents
        {
            get
            {
                if (_docmgmtModuleComponents == null)
                    _docmgmtModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_DOCMGMT);

                return _docmgmtModuleComponents;
            }
        }

        public bool ExecuteDerived
        {
            get { return _executeDerived; }
            set { _executeDerived = value; }
        }

        public string FormTableName { get; set; }

        public string FormViewName
        {
            get
            {
                if (!string.IsNullOrEmpty(xmlModel.form.AssociatedModuleID))
                    return xmlModel.form.TableName;
                else if (!string.IsNullOrEmpty(xmlModel.form.BaseTableName) &amp;&amp; !string.IsNullOrEmpty(xmlModel.form.TableName))
                    return xmlModel.form.TableName;
                else
                    return &quot;vw_&quot; + xmlModel.form.ActualTableNameInDatabase + &quot;_Auto&quot;;
            }
        }

        public string FormSerachViewName
        {
            get
            {
                if (string.IsNullOrEmpty(xmlModel.form.BaseTableName) &amp;&amp; xmlModel.form.InstantiateTable == true)
                    return &quot;vw_&quot; + xmlModel.form.ActualTableNameInDatabase + &quot;_Search_Auto&quot;;
                else
                    return FormViewName;
            }
        }

        public Dictionary&lt;string, string&gt; MapColors
        {
            get
            {
                string PID = (string.IsNullOrEmpty(Request[&quot;PID&quot;]) ? &quot;0&quot; : Request[&quot;PID&quot;]);
                string sessionKey = &quot;MapColors_&quot; + PID + &quot;_&quot; + xmlModel.form.Name;
                if (HttpContext.Current.Session[sessionKey] == null)
                    return new Dictionary&lt;string, string&gt;();
                else
                {
                    return HttpContext.Current.Session[sessionKey] as Dictionary&lt;string, string&gt;;
                }
            }
            set
            {
                string PID = (string.IsNullOrEmpty(Request[&quot;PID&quot;]) ? &quot;0&quot; : Request[&quot;PID&quot;]);
                string sessionKey = &quot;MapColors_&quot; + PID + &quot;_&quot; + xmlModel.form.Name;
                HttpContext.Current.Session[sessionKey] = value;
            }
        }

        private bool IsERPConnected
        {
            get { return IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX); }
        }

        public override string QueryStringName
        {
            get { return xmlModel.form.PrimaryKeyName; }
        }

        public override string DefaultSortColumn
        {
            get
            {
                if (listManagerModel != null)
                    return listManagerModel.GetDefaultSortColumn(this, null);
                else
                    return base.DefaultSortColumn;
            }
        }

        public override GridSortOrder DefaultSortIndicator
        {
            get
            {
                if (listManagerModel != null)
                    return listManagerModel.GetDefaultSortIndicator(this, null);
                else
                    return base.DefaultSortIndicator;
            }
        }

        public override string ModuleId
        {
            get
            {
                if (listManagerModel != null)
                    return listManagerModel.SetModuleId(this);
                else
                    return xmlModel.form.ModuleID;
            }
        }

        public override string PageUniqueID
        {
            get
            {//If enterprise try to get the direct ModuleId by default if breadcrumb not found it will switch to enterprise
                if (xmlModel.form.ParentModuleID == Constants.MODID_ENTPRSE)
                    return xmlModel.form.ModuleID;

                return xmlModel.form.ParentModuleID;
            }
        }



        public override List&lt;MenuGroup&gt; MenuGroups
        {
            get
            {
                DisplayDetailsReport = ShowDetailsReport = xmlModel.form.ShowDetailsReport;
                ShowListPageReport = xmlModel.form.ShowListPageReport;
                DisplayReport = (ShowDetailsReport || ShowListPageReport);

                var menuGroups = base.MenuGroups;
                MenuGroup otherGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_OTHERS);
                if (otherGroup == null)
                {
                    otherGroup = new MenuGroup(GROUP_OTHERS);
                    menuGroups.Add(otherGroup);
                }
                //LargeButton reportsBtn = (LargeButton)otherGroup.Menus.Find(m =&gt; m.ID == MENU_REPORTS_ID);
                //if (reportsBtn == null)
                //{
                //    reportsBtn = new LargeButton(MENU_REPORTS_ID, MENU_REPORTS, &quot;Icn_Reports.png&quot;);
                //    otherGroup.AddMenu(reportsBtn);
                //}

                //if (displayDetailsReport &amp;&amp; !(IsERPConnected &amp;&amp; xmlModel.form.GetDataFromERP))
                //    reportsBtn.AddSubMenu(new TextIcon(&quot;lnkDetailsReport&quot;, &quot;Details Report&quot;, &quot;Icn_Pdf_16.png&quot;));


                if (xmlModel.form.EnableAuditLog &amp;&amp; IsAuditLogEnabled(xmlModel.form.ActualTableNameInDatabase) &amp;&amp; DisplayAuditLog)
                    otherGroup.AddMenu(new TextIcon(&quot;lnkAudit&quot;, &quot;Audit Log&quot;, &quot;Icn_Pdf_16.png&quot;));

                if (QRCodeEnabled)
                    otherGroup.AddMenu(new LargeButton(&quot;lnkQRCode&quot;, &quot;Generate QR&quot;, &quot;print_QRcodes.png&quot;));
                //if (xmlModel.form.MenuGroups != null)
                //    xmlModel.form.MenuGroups.menuGroups.ForEach(mg =&gt; menuGroups.Add(mg));

                //Download details report along with attahments 
                List&lt;string&gt; modulePerms = ModuleManagementBL.ModuleManager.Instance.GetPermissionByUserOrRole(
                    (xmlModel.form.ParentModuleID == Constants.MODID_LIBRARY
                        ? Constants.MODID_LIBRARY
                        : xmlModel.form.Name),
                    UserDetail.GetCurrentUserDetail().UID, UserDetail.GetCurrentUserDetail().RID,
                    (string.IsNullOrEmpty(Request.QueryString[&quot;PID&quot;]) ? 0 : Request.QueryString[&quot;PID&quot;].ToInt32_2()));

                if (modulePerms.Contains(&quot;Report&quot;))
                {
                    //Download Full Report
                    Aurigo.AMP3.Core.UserControls.Menu reportsMenu = otherGroup.Menus.FirstOrDefault(m =&gt; m.Title == &quot;Reports&quot;);
                    if (reportsMenu != null)
                    {
                        if (xmlModel.form.ShowDetailsReport &amp;&amp; DOCMGMTModuleComponents.Contains(&quot;DownloadFullReport&quot;))
                        {
                            (reportsMenu as MenuButton).SubMenus.Add(new TextIcon(&quot;lnkDownloadFullReport&quot;, &quot;Download Full Report&quot;, &quot;Icn_Pdf_16.png&quot;));
                        }
                    }
                }

                if (xmlModel.form.GroupMenus != null &amp;&amp; xmlModel.form.GroupMenus.Count &gt; 0)
                {
                    xmlModel.form.GroupMenus.ForEach(
                        grp =&gt;
                        {
                            MenuGroup group = menuGroups.Find(g =&gt; g.Title == grp.Name);
                            if (group == null)
                            {
                                group = new MenuGroup(grp.Name);
                                menuGroups.Add(group);
                            }

                            string[] menus = grp.Menus.Split(&#39;;&#39;);
                            foreach (string menu in menus)
                            {
                                string[] menuDetails = menu.Split(&#39;,&#39;);

                                if (grp.MenuStyle == MenuStyle.LargeButton)
                                    group.AddMenu(new LargeButton(menuDetails[0].ToString(),
                                        xmlModel.form.ParseDynamicString(menuDetails[1].ToString()),
                                        menuDetails[2].ToString()));
                                else if (grp.MenuStyle == MenuStyle.TextIcon)
                                    group.AddMenu(new TextIcon(menuDetails[0].ToString(),
                                        xmlModel.form.ParseDynamicString(menuDetails[1].ToString()),
                                        menuDetails[2].ToString()));
                                else if (grp.MenuStyle == MenuStyle.Icon)
                                    group.AddMenu(new Icon(menuDetails[0].ToString(),
                                        xmlModel.form.ParseDynamicString(menuDetails[1].ToString()),
                                        menuDetails[2].ToString()));
                            }
                        }
                        );
                }
                if (listManagerModel != null) listManagerModel.AddItemsToMenuGroups(menuGroups);

                return menuGroups;
            }
        }

        public override void HandleGridRowInitialization&lt;T&gt;(object sender, T row)
        {
            base.HandleGridRowInitialization&lt;T&gt;(sender, row);
            if (listManagerModel != null) listManagerModel.HandleGridRowInitialization(sender, row);
        }

        public override void CustomizeToolBarMenu(ToolBar toolBar)
        {
            if (listManagerModel != null) listManagerModel.CustomizeToolBarMenu(this, toolBar);

            if (toolBar.GetMenuReference(&quot;lnkDetailsReport&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkDetailsReport&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                             System.Convert.ToInt32(
                                                                                 ValidateSelection.OneItem,
                                                                                 CultureInfo.CurrentCulture) +
                                                                             &quot;&#39;, &#39;&quot; + mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                             QueryStringName + &quot;&#39;)&quot;;
            }
            if (toolBar.GetMenuReference(&quot;lnkDownloadFullReport&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkDownloadFullReport&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                                  System.Convert.ToInt32(
                                                                                      ValidateSelection.OneItem,
                                                                                      CultureInfo.CurrentCulture) +
                                                                                  &quot;&#39;, &#39;&quot; + mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                                  QueryStringName + &quot;&#39;)&quot;;
                toolBar.GetMenuReference(&quot;lnkDownloadFullReport&quot;).Click += lnkDownloadFullReport_Click;
            }
            if (toolBar.GetMenuReference(&quot;lnkQRCode&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkQRCode&quot;).OnClientClick = &quot;return lnkValidation(&#39;&quot; +
                                                                               System.Convert.ToInt32(
                                                                                   ValidateSelection.OneOrMoreItems,
                                                                                   CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; +
                                                                               mwGrid.ClientID + &quot;&#39;, &#39;&quot; +
                                                                               QueryStringName + &quot;&#39;);&quot;;
            }
            base.CustomizeToolBarMenu(toolBar);
        }

        private void lnkDownloadFullReport_Click(object sender, EventArgs e)
        {
            if (xmlModel != null)
            {
                int selectedId = 0;
                string selId = GetSelectedIds();
                if (!string.IsNullOrEmpty(selId) &amp;&amp; selId.Split(&#39;,&#39;).Length == 1)
                    selectedId = selId.ToInt32_2();

                xmlModel.form.RequestParameters.Add(&quot;Context&quot;, xmlModel.form.Name);
                //XMLRenderingEngine engine = new XMLRenderingEngine(null, xmlModel, null);
                //engine.Initialize();
                //xmlModel.form.instanceID = selectedId.ToString();
                //engine.Render(RenderFormat.RenderJSON);

                string folderPath = &quot;~/Modules/UploadedFiles/DownloadReports/&quot; + DateTime.UtcNow.Ticks;
                string physicalFolderPath = HttpContext.Current.Request.MapPath(folderPath);

                string mainReportName = xmlModel.form.ParseDynamicString(xmlModel.form.Header) + &quot;_DetailsReport&quot;;

                if (!Directory.Exists(physicalFolderPath))
                    Directory.CreateDirectory(physicalFolderPath);

                GetFormDetailsReport(physicalFolderPath, selectedId, mainReportName);
                GetAttachments(physicalFolderPath, selectedId);
                string finalMergedFileName = ConvertAllAttachmentsToPDFAndMerge(physicalFolderPath, selectedId);

                if (!string.IsNullOrEmpty(finalMergedFileName))
                {
                    WriteFileToBrowser(finalMergedFileName);
                }

                if (!Directory.Exists(physicalFolderPath))
                    Directory.Delete(physicalFolderPath);
            }
        }

        private void GetFormDetailsReport(string physicalFolderPath, int instanceId, string reportName)
        {
            List&lt;ReportParameterDetails&gt; parameters = ReportManager.Instance.GetReportParameters(reportName);
            Dictionary&lt;string, string&gt; reportParameters =
                new Dictionary&lt;string, string&gt;(StringComparer.OrdinalIgnoreCase);

            foreach (ReportParameterDetails parameter in parameters)
            {
                //If its a hidden and if the default parameters are not specified then the parameter will come from request. 
                if (parameter.Hidden &amp;&amp; (parameter.DefaultValues == null || parameter.DefaultValues.Length == 0))
                {
                    if (parameter.Name.ToLower2() == &quot;forminstanceid&quot;)
                    {
                        reportParameters.Add(parameter.Name, instanceId.ToString());
                    }
                    else if (parameter.Name.ToLower2() == &quot;moduleid&quot;)
                    {
                        string moduleId = xmlModel.form.Name;
                        if (!string.IsNullOrEmpty(moduleId))
                        {
                            reportParameters.Add(parameter.Name, moduleId);
                        }
                    }
                    else
                    {
                        string requestValue = Request.QueryString[parameter.Name];
                        if (!string.IsNullOrEmpty(requestValue))
                            reportParameters.Add(parameter.Name, requestValue);
                    }
                }
            }

            string physFile = physicalFolderPath + &quot;/001. &quot; + reportName + &quot;.pdf&quot;;
            ReportManager.Instance.RenderReportWithFormat(reportParameters, reportName, physFile, &quot;pdf&quot;);
        }

        private void GetAttachments(string physicalFolderPath, int instanceId)
        {
            //Get form level attachments
            List&lt;LinkDetails&gt; links = new List&lt;LinkDetails&gt;();
            if (xmlModel.form.AllowAttachments)
            {
                List&lt;LinkDetails&gt; formAttachments =
                    LinksManager.Instance.GetLinksForModuleInstance(instanceId.ToString(), xmlModel.form.Name, null);
                if (formAttachments != null)
                    links.AddRange(formAttachments);
            }

            xmlModel.form.ProcessAllControlsDeeply(xc =&gt;
            {
                if (xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.AttachmentControl)
                {
                    if (xc.ParentObject is DynamicGrid) //Grid Attachments
                    {
                        //(xc.ParentObject as DataBaseContainer).GetInstanceData();
                        DataTable dt = (xc.ParentObject as DataBaseContainer).Table;
                        foreach (DataRow row in dt.Rows)
                        {
                            List&lt;LinkDetails&gt; gridRowAttachments =
                                LinksManager.Instance.GetLinksForModuleInstance(
                                    row[(xc.ParentObject as DynamicGrid).PrimaryKeyName].ToString()
                                    , (xc as AttachmentControl).ModuleId, null);
                            if (gridRowAttachments != null)
                                links.AddRange(gridRowAttachments);
                        }
                    }
                    else if (xc.ParentObject is Section) //Section level attachments
                    {
                        List&lt;LinkDetails&gt; sectionAttachments =
                            LinksManager.Instance.GetLinksForModuleInstance(instanceId.ToString(),
                                (xc as AttachmentControl).ModuleId, null);
                        if (sectionAttachments != null)
                            links.AddRange(sectionAttachments);
                    }
                }
            });

            for (int i = 0; i &lt; links.Count; i++)
            {
                if (links[i].DestType.Equals(&quot;DOCMGMT&quot;))
                {
                    Byte[] doc =
                        DocumentManagementBL.DocumentManager.Instance.GetDocumentAsByteArrayByID(links[i].DestID.ToInt32_2());
                    File.WriteAllBytes(
                        physicalFolderPath + &quot;/&quot; + (i + 1).ToString().PadLeft(3, &#39;0&#39;) + &quot;.&quot; + links[i].LinkName, doc);
                }
            }
        }

        private string ConvertAllAttachmentsToPDFAndMerge(string physicalFolderPath, int selectedId)
        {
            string finalFileName = &quot;&quot;;
            try
            {
                List&lt;string&gt; filePaths = Directory.GetFiles(physicalFolderPath).ToList();

                int attachmentStartPage = 0;

                List&lt;PDFAttachmentDetails&gt; attachments = new List&lt;PDFAttachmentDetails&gt;();
                using (PDFDoc merged_doc = new PDFDoc())
                {
                    int i = 0;
                    foreach (string filePath in filePaths)
                    {
                        try
                        {
                            using (Stamper s = new Stamper(Stamper.SizeType.e_relative_scale, 0.5, 0.5))
                            using (PDFDoc pdfdoc = new PDFDoc())
                            {
                                string in_fileName = filePath;
                                FileInfo fi = new FileInfo(in_fileName);
                                string out_fileName = physicalFolderPath + &quot;\\&quot; + DateTime.UtcNow.Ticks + &quot;.pdf&quot;;

                                pdftron.PDF.Convert.ToPdf(pdfdoc, in_fileName);

                                if (i &gt; 0)
                                {
                                    s.SetAlignment(Stamper.HorizontalAlignment.e_horizontal_left,
                                        Stamper.VerticalAlignment.e_vertical_top);
                                    s.SetFontColor(new ColorPt(0, 0, 0, 0));
                                    s.SetSize(pdftron.PDF.Stamper.SizeType.e_font_size, 8, 8);
                                    s.StampText(pdfdoc, fi.Name, new PageSet(1, 1));
                                }

                                pdfdoc.Save(out_fileName, SDFDoc.SaveOptions.e_linearized);


                                MergePDF(merged_doc, out_fileName);
                            }
                        }
                        catch (Exception)
                        {
                        }
                        i++;
                    }

                    try
                    {
                        if (attachments.Count &gt; 0)
                        {
                            pdftron.PDF.Page pg = merged_doc.PageCreate();

                            if (xmlModel.form.ReportPageOrientation ==
                                Brix.Platform.BusinessLayer.XMLForm.ReportPageOrientation.Landscape)
                                pg.SetRotation(pdftron.PDF.Page.Rotate.e_90);

                            using (ElementBuilder eb = new ElementBuilder())
                            // ElementBuilder is used to build new Element objects
                            using (ElementWriter writer = new ElementWriter())
                            // ElementWriter is used to write Elements to the page 
                            {
                                writer.Begin(pg); // begin writing to this page
                                eb.Reset(); // Reset GState to default
                                i = 0;


                                Element element1 =
                                    eb.CreateTextBegin(Font.Create(merged_doc, Font.StandardType1Font.e_times_roman), 14);
                                writer.WriteElement(element1);
                                element1 = eb.CreateTextRun(&quot;List of attachments&quot;);
                                element1.SetTextMatrix(1, 0, 0, 1, 10, (pg.GetPageHeight() - 20));
                                element1.GetGState().SetLeading(15); // Set the spacing between lines
                                writer.WriteElement(element1);
                                writer.WriteElement(eb.CreateTextNewLine()); // New line
                                writer.WriteElement(eb.CreateTextEnd());

                                Bookmark tocBK = Bookmark.Create(merged_doc, &quot;List of attachments&quot;);
                                merged_doc.AddRootBookmark(tocBK);

                                foreach (PDFAttachmentDetails ad in attachments)
                                {
                                    string data = ad.Name + &quot;\t\t\t\t&quot; + ad.StartPage + &quot;\t&quot; + &quot;-&quot; + &quot;\t&quot; + ad.EndPage;
                                    Element element =
                                        eb.CreateTextBegin(
                                            Font.Create(merged_doc, Font.StandardType1Font.e_times_roman), 10);
                                    writer.WriteElement(element);

                                    double yPos = (pg.GetPageHeight() - 50) - (i * 20);

                                    element = eb.CreateTextRun(data);
                                    element.SetTextMatrix(1, 0, 0, 1, 10, yPos);
                                    element.GetGState().SetLeading(15); // Set the spacing between lines
                                    writer.WriteElement(element);

                                    writer.WriteElement(eb.CreateTextNewLine()); // New line

                                    // Finish the block of text
                                    writer.WriteElement(eb.CreateTextEnd());
                                    i++;

                                    Bookmark attachmentBK = Bookmark.Create(merged_doc, ad.Name);
                                    merged_doc.AddRootBookmark(attachmentBK);

                                    pdftron.PDF.Action attachmentBK_action = pdftron.PDF.Action.CreateGoto(ad.Name,
                                        pdftron.PDF.Destination.CreateFit(merged_doc.GetPage(ad.StartPage - 1)));
                                    attachmentBK.SetAction(attachmentBK_action);
                                    //pdftron.PDF.Annots.Link attachmentBK_link = pdftron.PDF.Annots.Link.Create(merged_doc.GetSDFDoc(), new Rect(10, yPos, pg.GetPageWidth(), yPos + 20), attachmentBK_action);
                                    //attachmentBK_link.SetBorderStyle(new pdftron.PDF.Annot.BorderStyle(Annot.BorderStyle.Style.e_solid, 0));
                                    //pg.AnnotPushBack(attachmentBK_link);
                                }
                                writer.End(); // save changes to the current page

                                merged_doc.PageInsert(merged_doc.GetPageIterator(attachmentStartPage), pg);

                                pdftron.PDF.Action tocBK_action = pdftron.PDF.Action.CreateGoto(&quot;List of attachments&quot;,
                                    pdftron.PDF.Destination.CreateFit(merged_doc.GetPage(attachmentStartPage)));
                                tocBK.SetAction(tocBK_action);
                            }
                        }


                        //Get the filename if its specified in XML
                        finalFileName = physicalFolderPath + &quot;\\&quot; +
                                        xmlModel.form.ParseDynamicString(xmlModel.form.Header) + &quot;.pdf&quot;;
                        if (!string.IsNullOrEmpty(xmlModel.form.ExportReportFileName))
                        {
                            try
                            {
                                string nameQuery = &quot;select &quot; + xmlModel.form.ExportReportFileName +
                                                   &quot; as ExportReportFileName from &quot; + xmlModel.form.ActualTableNameInDatabase
                                                   + &quot; where &quot; + xmlModel.form.PrimaryKeyName + &quot;={0}&quot;;

                                object objName = ComponentHelper.Instance.ExecuteScalar(nameQuery, selectedId);
                                if (objName != null)
                                {
                                    objName = objName.ToString().Replace(&quot;/&quot;, &quot; &quot;).Replace(&quot;\\&quot;, &quot; &quot;);
                                    finalFileName = (physicalFolderPath + &quot;\\&quot; + objName.ToString() + &quot;.pdf&quot;);
                                }
                            }
                            catch
                            {
                                //Ignore
                            }
                        }
                        merged_doc.Save(finalFileName, SDFDoc.SaveOptions.e_linearized);
                    }
                    catch
                    {
                    }
                }
            }
            catch (Exception)
            {
            }

            return finalFileName;
        }

        static void MergePDF(PDFDoc new_doc, string filename)
        {
            using (PDFDoc in_doc = new PDFDoc(filename))
            {
                in_doc.InitSecurityHandler();
                ArrayList copy_pages = new ArrayList();
                for (PageIterator itr = in_doc.GetPageIterator(); itr.HasNext(); itr.Next())
                {
                    copy_pages.Add(itr.Current());
                }

                ArrayList imported_pages = new_doc.ImportPages(copy_pages);
                for (int i = 0; i != imported_pages.Count; ++i)
                {
                    new_doc.PagePushBack((pdftron.PDF.Page)imported_pages[i]); // Order pages in reverse order. 
                }
            }
        }

        private void WriteFileToBrowser(string finalMergedFileName)
        {
            Response.ContentType = &quot;application/octet-stream&quot;;
            string fileNameToDownload = finalMergedFileName;
            string[] fileNameParts = finalMergedFileName.Split(&#39;\\&#39;);
            if (fileNameParts.Length &gt; 0)
            {
                fileNameToDownload = fileNameParts[fileNameParts.Length - 1];
            }

            Response.AddHeader(&quot;Content-disposition&quot;, &quot;attachment; filename=&quot; + fileNameToDownload);
            using (var fs = new FileStream(finalMergedFileName, FileMode.OpenOrCreate, FileAccess.Read, FileShare.Read))
            {
                long bytesToRead = fs.Length;
                while (bytesToRead &gt; 0)
                {
                    // Read the data into the buffer and write into the 
                    var buffer = new Byte[1024];
                    int length = fs.Read(buffer, 0, 1024);
                    Response.OutputStream.Write(buffer, 0, length);
                    Response.Flush();
                    // only the remaining. 
                    bytesToRead = bytesToRead - length;
                }
            }

            Response.End();
            HttpContext.Current.Response.Flush(); // Sends all currently buffered output to the client.
            HttpContext.Current.Response.SuppressContent = true;
            // Gets or sets a value indicating whether to send HTTP content to the client.
            HttpContext.Current.ApplicationInstance.CompleteRequest();
        }

        public override void SetUIDetails()
        {
            if (xmlModel != null)
            {
                if (listManagerModel != null) listManagerModel.BeforeSetUIDetails(this, new XmlFormArgs());

                if (HttpContext.Current != null)
                {
                    if (File.Exists(HttpContext.Current.Server.MapPath(&quot;~/Modules/WORKFLW/&quot; + ModuleId + &quot;.xml&quot;)))
                    {
                        displayApprove = true;
                    }
                }
                else
                {
                    if (
                        File.Exists(HttpRuntime.AppDomainAppPath +
                                    (&quot;/Modules/WORKFLW/&quot; + ModuleId + &quot;.xml&quot;).Replace(&#39;/&#39;, &#39;\\&#39;)))
                    {
                        displayApprove = true;
                    }
                }

                displayReport = true;
                displayApplyFilter = true;
                displayDetailsReport = true;

                if (xmlModel.form != null)
                {
                    //PEREPARE LIST PROPERTIES AND FIRE THE MODIFYCOLUMNPROPERTIES ON EACH COLUMN
                    listCols = new List&lt;string&gt;();
                    //if (xmlModel.form.AllowAttachments)
                    //    listCols.Add(&quot;HasAttachments&quot;);
                    listCols.AddRange(xmlModel.form.ListColumns.Columns.Split(&quot;,&quot;.ToCharArray()));

                    columnCounter = listCols.Count;
                    ModifyColumnPropertiesInContainer(xmlModel.form);
                    ModifyAdditionalColumnsAddedUsingReferenceColumn(xmlModel.form);

                    //TODO: Hide RowNum if it is present --  later on do proper fix for this kind of problems
                    ModifyColumnProperties(&quot;RowNum&quot;, true, null, &quot;&quot;, &quot;&quot;, false, &quot;&quot;);

                    // Hiding Timestamp Column
                    ModifyColumnProperties(Form.TIMESTAMP_COLUMN_NAME, true, null, &quot;&quot;, &quot;&quot;, false, &quot;&quot;);

                    //if (xmlModel.form.AllowAttachments)
                    //{
                    //    ModifyColumnProperties(&quot;HasAttachments&quot;, true, 1, null, &quot;32px&quot;, false);
                    //    SetImageForRowValue(&quot;HasAttachments&quot;, &quot;&lt;img src=&#39;../../Images/Toolbar/IcnAttachment.gif&#39; alt=&#39;Attachments&#39; Title=&#39;Attachments&#39; /&gt;&quot;, &quot;True&quot;, &quot;IcnAttachmentBW.png&quot;);
                    //    SetImageForRowValue(&quot;HasAttachments&quot;, &quot;&lt;img src=&#39;../../Images/Toolbar/IcnAttachment.gif&#39; alt=&#39;Attachments&#39; Title=&#39;Attachments&#39; /&gt;&quot;, &quot;False&quot;, &quot;&quot;);
                    //}
                    foreach (var item in xmlModel.form.QRGenerator.QRControl)
                    {
                        ModifyColumnProperties(xmlModel.form.QRGenerator.Prefix + item.Name, true, null, &quot;&quot;, &quot;&quot;, false, &quot;&quot;);
                    }
                    header = xmlModel.form.ParseDynamicString(xmlModel.form.Header);
                }
                //Will add later
                if (IsERPConnected &amp;&amp; xmlModel.form.GetDataFromERP)
                {
                    displayImport =
                        displayExport =
                            displayTemplateExport = false;
                }
                else
                {
                    displayTemplateExport = displayImport = xmlModel.form.AllowExcelImport;
                    displayExport = xmlModel.form.AllowExcelExport;
                }
                // show the modify form button only for admin role
                if (UserDetail.GetCurrentUserDetail() != null &amp;&amp; UserManager.Instance.IsUserAdministrator(UserDetail.GetCurrentUserDetail().UID))
                    // checking for admin role, later handle it using features
                    DisplaylnkEditForm = true;

                displayNew = xmlModel.form.DisplayNew;
                displayEdit = xmlModel.form.DisplayEdit;
                displayView = xmlModel.form.DisplayView;
                displayDelete = xmlModel.form.DisplayDelete;


                if (IsERPConnected &amp;&amp; xmlModel.form.GetDataFromERP)
                {
                    displayNew =
                        displayEdit =
                            displayView =
                                displayDelete = false;
                }

                if (xmlModel.form.ParentModuleID == &quot;LIBRARY&quot; || xmlModel.form.ParentModuleID == &quot;UTILITY&quot;)
                    DisplayMMgroup = false; 

                HasHierarchicalGrid = !string.IsNullOrEmpty(xmlModel.form.GroupBy);

                if (Request != null &amp;&amp; UserDetail.GetCurrentUserDetail() != null)
                {
                    List&lt;string&gt; modulePerms = ModuleManagementBL.ModuleManager.Instance.GetPermissionByUserOrRole(
                    (xmlModel.form.ParentModuleID == Constants.MODID_LIBRARY
                        ? Constants.MODID_LIBRARY
                        : xmlModel.form.Name),
                    UserDetail.GetCurrentUserDetail().UID, UserDetail.GetCurrentUserDetail().RID,
                    (string.IsNullOrEmpty(Request.QueryString[&quot;PID&quot;]) ? 0 : Request.QueryString[&quot;PID&quot;].ToInt32_2()));

                    if (modulePerms.Contains(Constants.MODFEAT_VISIBILITY) &amp;&amp; modulePerms.Contains(Constants.MODFEAT_VIEW))
                    {
                        displayDocuments = xmlModel.form.AllowAttachments;
                    }

                }

                if (listManagerModel != null) listManagerModel.AfterSetUIDetails(this, new XmlFormArgs());


                if (xmlModel.form.ShowMapView)
                {
                    ShowMapView = true;
                }

                if (xmlModel.form.QRGenerator.QRControl.Count &gt; 0)
                {
                    QRCodeEnabled = true;
                }
            }
        }

        private void ModifyAdditionalColumnsAddedUsingReferenceColumn(Form form)
        {
            string key, caption = String.Empty;
            int position = 0;

            //For all columns which are being displayed using reference columns
            //Find all the columns and set the position.

            //All reference columns will have . in between TableName.ColumnName 
            foreach (string listCol in listCols.Where(s =&gt; s.Contains(&quot;.&quot;)))
            {
                var fkReference = xmlModel.form.References.Where(fk =&gt; fk.Value.FindColumn(listCol) != null);
                if (fkReference.Any())
                {
                    ReferenceColumnDetails colDetails = fkReference.First().Value.FindColumn(listCol);
                    if (colDetails != null)
                    {
                        key = caption = colDetails.AliasText ?? colDetails.FieldName;
                        position = listCols.IndexOf(listCol) + 1;

                        ModifyColumnProperties(key, false, position, null, string.Empty, false, caption);
                    }
                }
            }
        }

        public override string DocumentUrl
        {
            get
            {
                return
                    (HttpContext.Current.Handler as System.Web.UI.Page).ResolveUrl(
                        string.Format(&quot;~/Modules/DOCMGMT/DocumentView.aspx?PID={0}&amp;parent={1}&amp;context={2}&amp;module={3}&quot;,
                            (string.IsNullOrEmpty(Request[&quot;PID&quot;]) ? &quot;0&quot; : Request[&quot;PID&quot;]),
                            (string.IsNullOrEmpty(Request[&quot;ParentID&quot;]) ? &quot;0&quot; : Request[&quot;ParentID&quot;]),
                            xmlModel.form.ParentModuleID, xmlModel.form.Name));
            }
        }
        private void ModifyColumnPropertiesInContainer(ControlContainer c)
        {
            if (c is Section)
                ModifyColumnsInSection(c as Section);

            if (c is Picker)
                ModifyColumnsInPicker(c as Picker);

            foreach (ControlContainer innerC in c.Containers)
                ModifyColumnPropertiesInContainer(innerC);
        }

        private void ModifyColumnsInPicker(Picker pk)
        {
            foreach (xColumn xc in pk.Controls)
            {
                if (xc.Controls.Count &gt; 0)
                {
                    foreach (xControl innerXC in xc.Controls)
                    {
                        //if (!string.IsNullOrEmpty(innerXC.DBType))
                        ModifySingleColumn(innerXC);
                    }
                }
                else
                {
                    //if (!string.IsNullOrEmpty(xc.DBType))
                    ModifySingleColumn(xc);
                }
            }
        }

        private void ModifyColumnsInSection(Section sec)
        {
            foreach (xControl xc in sec.Controls)
            {
                if (xc.Controls.Count &gt; 0)
                {
                    foreach (xControl innerXC in xc.Controls)
                    {
                        //if (!string.IsNullOrEmpty(innerXC.DBType))
                        ModifySingleColumn(innerXC);
                    }
                }
                else
                {
                    //if (!string.IsNullOrEmpty(xc.DBType))
                    ModifySingleColumn(xc);
                }
            }
        }

        private void ModifySingleColumn(xControl xc)
        {
            string key, propertyValue = String.Empty, format, colwidth;
            int position = 0;
            bool allowUpdate = false, isHidden = false;

            key = xc.Name;
            if (listCols.Contains(key))
                position = listCols.IndexOf(key) + 1;
            else
                position = columnCounter++;

            format = xc.GetControlFormat();

            colwidth = String.IsNullOrEmpty(xc.ListColumnWidth) ? &quot;&quot; : xc.ListColumnWidth;

            if (xmlModel.form.ListColumns.Type == &quot;Hidden&quot;)
            {
                if (listCols.Contains(xc.Name)) isHidden = true;
                else
                    isHidden = false;
            }
            else
            {
                // DEFAULT LOCATION  --- IF NOT GIVEN ANYTHING
                if (listCols.Contains(xc.Name)) isHidden = false;
                else
                    isHidden = true;
            }
            string caption = string.IsNullOrEmpty(xc.Caption)
                ? xc.Name
                : xc.ParseDynamicString(xc.Caption.TrimEnd(&quot;:&quot;.ToCharArray()));

            if (xc != null &amp;&amp; xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.Password)
            {
                isHidden = true;
            }

            ModifyColumnProperties(key, isHidden, position, format, colwidth, allowUpdate, caption, xc.IsTimezoneApplicable);
        }

        public override void HandleNew()
        {
        }

        public override void HandleEdit()
        {
            var e = new XmlFormArgs();
            string selectedIds = GetSelectedIds();
            if (listManagerModel != null) listManagerModel.BeforeEdit(this, selectedIds, e);
            if (listManagerModel == null || e.ExecuteBase)
            {
                string url = string.Empty;
                url += &quot;BrixForm.aspx?Context=&quot; + xmlModel.form.Name + &quot;&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ParentID=&quot; +
                       ((Request[&quot;ParentID&quot;] == null) ? &quot;0&quot; : Request[&quot;ParentID&quot;]) + &quot;&amp;Mode=Edit&quot;;
                url += &quot;&amp;InstanceID=&quot; + GetSelectedIds();
                if (Request.QueryString[&quot;module&quot;] != null) url += &quot;&amp;module=&quot; + Request.QueryString[&quot;module&quot;];
                if (Request.QueryString[&quot;LMID&quot;] != null) url += &quot;&amp;LMID=&quot; + Request.QueryString[&quot;LMID&quot;];
                if (Request.QueryString[&quot;ParentInstanceID&quot;] != null)
                    url += &quot;&amp;ParentInstanceID=&quot; + Request.QueryString[&quot;ParentInstanceID&quot;];
                if (Request.QueryString[&quot;BasePOID&quot;] != null) url += &quot;&amp;BasePOID=&quot; + Request.QueryString[&quot;BasePOID&quot;];
                if (!string.IsNullOrEmpty(GetSelectedIds()))
                    Response.Redirect(url, true);
            }
        }

        public override void HandleView()
        {
        }

        private bool ExistsDependantTableRecords(string selectedIdsToDelete, ref string errorMessage)
        {
            bool hasRecords = false;
            string dependantTables = xmlModel.form.DependantTables.Name;
            if (!string.IsNullOrEmpty(dependantTables))
            {
                string pkTable = xmlModel.form.ActualTableNameInDatabase;
                string fkColumn = xmlModel.form.PrimaryKeyName;
                string SourceTableColumn = xmlModel.form.PrimaryKeyName;

                string query = string.Empty;
                List&lt;string&gt; tables = dependantTables.Split(&#39;,&#39;).ToList();
                foreach (string table in tables)
                {
                    //fkParams[0] = TableName
                    //fkParams[1] = ColumnName
                    //fkParams[2] = Table Description which will be shown in the alert message
                    var t = table;

                    //this code is to handle when the child table has referenced the &#39;value&#39; column of the parent table (instead of the id column)
                    if (t.Contains(&quot;::&quot;))
                    {
                        //string[] NewParam = table.Split(new string[] { &quot;::&quot;, &quot;.&quot;, &quot;:&quot; }, StringSplitOptions.RemoveEmptyEntries);
                        string[] NewParam = t.Split(new string[] { &quot;::&quot; }, StringSplitOptions.RemoveEmptyEntries);
                        if (NewParam.Length &gt; 0)
                        {
                            SourceTableColumn = NewParam[0];
                            if (NewParam.Length &gt; 1)
                                t = NewParam[1];
                        }
                    }

                    string[] fkParams = t.Split(new string[] { &quot;.&quot;, &quot;:&quot; }, StringSplitOptions.RemoveEmptyEntries);
                    if (fkParams.Length &gt; 0)
                    {
                        string fkTable = fkParams[0];
                        if (fkColumn.Length &gt; 1)
                            fkColumn = fkParams[1];

                        string errorDescription = string.Empty;
                        if (fkParams.Length &gt; 2)
                            errorDescription = fkParams[2];

                        query += &quot;select count(t2.{3}) RecordCount, &#39;{4}&#39; as ErrorDescription  from {1} t1 inner join {2} t2 on t1.{0} = t2.{3} where t1.{6} in ({5}) union all &quot;
                            .Format2(
                                SourceTableColumn, xmlModel.form.TableName, fkTable, fkColumn, errorDescription,
                                selectedIdsToDelete, xmlModel.form.PrimaryKeyName);
                    }
                }

                if (query.EndsWith(&quot;union all &quot;))
                    query = query.Substring(0, query.Length - 10);

                if (!string.IsNullOrEmpty(query))
                {
                    DataSet dsDependants = ComponentHelper.Instance.ExecuteDataSet(query);
                    if (dsDependants != null &amp;&amp; dsDependants.Tables.Count &gt; 0 &amp;&amp; dsDependants.Tables[0].Rows.Count &gt; 0)
                    {
                        errorMessage = &quot;One or more of the selected records(s) is being referred in &quot;;
                        string errorDescription = &quot;&quot;;

                        foreach (DataRow row in dsDependants.Tables[0].Rows)
                        {
                            object count = row[&quot;RecordCount&quot;];

                            if (count != null &amp;&amp; count.ToInt32_2() &gt; 0)
                            {
                                if (!hasRecords)
                                    hasRecords = true;
                                if (!string.IsNullOrEmpty(row[&quot;ErrorDescription&quot;].ToString()))
                                {
                                    if (errorDescription.IndexOf(row[&quot;ErrorDescription&quot;].ToString() + &quot;,&quot;) == -1)
                                        errorDescription += row[&quot;ErrorDescription&quot;].ToString() + &quot;,&quot;;
                                }
                            }
                        }
                        errorMessage += errorDescription;
                        errorMessage = errorMessage.TrimEnd(&#39;,&#39;);
                        if (errorMessage.EndsWith(&quot; in &quot;))
                            errorMessage = errorMessage.Substring(0, errorMessage.Length - 4);
                        errorMessage += &quot;. Request Denied&quot;;
                    }
                }
            }
            return hasRecords;
        }

        public override int HandleDelete()
        {
            var e = new XmlFormArgs();
            string selectedIds = GetSelectedIds();
            selectedIds = FilterIdsToDeleteBasedOnWFDefinitions(ModuleId, Request[&quot;PID&quot;], Request[&quot;ParentID&quot;],
                selectedIds);

            //Check if records are there in the dependant tables
            string errorMessage = string.Empty;
            if (ExistsDependantTableRecords(selectedIds, ref errorMessage))
                throw new Exception(errorMessage);

            if (listManagerModel != null) listManagerModel.BeforeDelete(this, selectedIds, e);
            if (listManagerModel == null || e.ExecuteBase)
            {
                string toBeDeleted = string.Empty;
                if (null == ConfigurationManager.AppSettings[&quot;DonotDeleteFormsInWorkflow&quot;])
                    toBeDeleted = selectedIds;
                else
                {
                    string[] allIds = selectedIds.Trim(&#39;,&#39;).Split(&#39;,&#39;);
                    DataTable dt = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(selectedIds, ModuleId);
                    DataRow[] dRows = dt.Select(&quot;IsCompleted=False&quot;);
                    string notToBeDeleted = &quot;,&quot;;
                    foreach (DataRow dr in dRows)
                    {
                        if (null != dr[&quot;FormInstanceID&quot;]) notToBeDeleted += dr[&quot;FormInstanceID&quot;] + &quot;,&quot;;
                    }

                    foreach (string id in allIds)
                    {
                        if (!notToBeDeleted.Contains(&quot;,&quot; + id + &quot;,&quot;)) toBeDeleted += id + &quot;,&quot;;
                    }

                    if (!string.IsNullOrEmpty(notToBeDeleted.Trim(&#39;,&#39;)))
                    {
                        var currentPage = HttpContext.Current.Handler as System.Web.UI.Page;
                        currentPage.ClientScript.RegisterClientScriptBlock(currentPage.GetType(), &quot;ShowAlert&quot;,
                            &quot;ShowError(&#39;Instances running under workflow can not be deleted.&#39;);&quot;,
                            true);
                    }
                }
                //foreach (ControlContainer c in xmlModel.form.Containers)
                //{
                //    DeleteChildTables(toBeDeleted, c);
                //    while (c.Containers.Count &gt; 0)
                //    {
                //        foreach (ControlContainer cc in c.Containers)
                //        {
                //            DeleteChildTables(toBeDeleted, cc);
                //        }

                //    }
                //}
                foreach (ControlContainer c in xmlModel.form.Containers)
                {
                    DeleteChildTableRows(toBeDeleted, c);
                }

                if (xmlModel.form.AllowAttachments)
                {
                    string[] ids = toBeDeleted.Trim(&#39;,&#39;).Split(new[] { &#39;,&#39; });
                    foreach (string id in ids)
                        ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                            StoredProcedure.usp_LINKMODDeleteALink, null, id, xmlModel.form.Name, 1);
                }
                int iDeleted = 0;
                try
                {
                    iDeleted =
                        CoreDatabaseHelper.GenericLibraryDelete(xmlModel.form.ActualTableNameInDatabase, xmlModel.form.PrimaryKeyName, toBeDeleted.Trim(&#39;,&#39;));
                }
                catch (Exception ex)
                {
                    if (ex.Message.Contains(&quot;The DELETE statement conflicted with the REFERENCE constraint&quot;))
                        throw new Exception(&quot;Some of the record(s) cannot be deleted as its already associated.&quot;);
                    throw ex;
                }
                ForceDeleteWorkflowsForThisForm(toBeDeleted, xmlModel.form.Name);
                if (listManagerModel != null) listManagerModel.AfterDelete(this, selectedIds, e);
                if (listManagerModel == null || e.IsValid)
                    return iDeleted;
                else
                    throw new Exception(e.ErrorMessage);
            }
            else if (listManagerModel != null &amp;&amp; !e.ExecuteBase &amp;&amp; !e.IsValid)
                throw new Exception(e.ErrorMessage);
            else
                return 0;
        }

        public static void DeleteChildTableRows(string toBeDeleted, ControlContainer c)
        {
            if (c.GetType().IsSubclassOf(typeof(DataBaseContainer)))
            {
                DeleteRows(toBeDeleted, c);
            }
            else
            {
                foreach (ControlContainer cc in c.Containers)
                {
                    DeleteChildTableRows(toBeDeleted, cc);
                }
            }
        }

        public static void DeleteEmbeddedForm(string toBeDeleted, ControlContainer c)
        {
            var embeddedControl = (c as EmbeddedForm);
            toBeDeleted.Split(&#39;,&#39;).ForEach(instanceId =&gt;
            {
                embeddedControl.form.instanceID = instanceId;
                string[] moduleIds = embeddedControl.GetQueryFromDataSource();

                foreach (string moduleId in moduleIds)
                {
                    BrixFormModel model = new BrixFormModel(moduleId, moduleId + &quot;.xml&quot;, XMLType.Form);
                    if (model == null || model.form == null) continue;

                    int formInstance = EmbeddedFormHelper.GetEmbeddedFormInstance(model, embeddedControl.form.Name, embeddedControl.form.instanceID.ToInt32_2());
                    if (formInstance &gt; 0)
                    {
                        CoreDatabaseHelper.GenericLibraryDelete(model.form.ActualTableNameInDatabase, model.form.PrimaryKeyName, formInstance.ToString());
                        foreach (ControlContainer ec in model.form.Containers)
                        {
                            DeleteChildTableRows(formInstance.ToString(), ec);
                        }
                    }
                }

            });
        }

        private static void DeleteRows(string toBeDeleted, ControlContainer c)
        {
            var dc = c as DataBaseContainer;
            List&lt;xControl&gt; fks = dc.GetForeignKeyControls();
            string foriegnKey = string.Empty;

            if (fks != null)
                foreach (xControl xc in fks)
                {
                    if (xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden &amp;&amp; xc.ForeignKey)
                    {
                        foriegnKey = xc.Name;
                        break;
                    }
                }
            if (!string.IsNullOrEmpty(foriegnKey))
                CoreDatabaseHelper.GenericLibraryDelete(dc.ActualTableNameInDatabase, foriegnKey, toBeDeleted.Trim(&#39;,&#39;));
        }

        public override MenuHandlerStatus HandleApprove()
        {
            return MenuHandlerStatus.GetSuccessObject(&quot;Approved Successfully&quot;);
        }

        public override string HandleMenuItem(string eventString)
        {
            string selectedIds = GetSelectedIds();
            var e = new XmlFormArgs();
            if (listManagerModel != null &amp;&amp; ((eventString == &quot;Edit&quot; &amp;&amp; ExecuteDerived) || (eventString != &quot;Edit&quot;)))
            {
                listManagerModel.HandleMenuItem(eventString, selectedIds, this, e);
                // if manager class has handled the operation - just return from here
                if (!e.ExecuteBase)
                {
                    this.isMenuClickHandled = true;
                    return &quot;&quot;;
                }
            }

            if (listManagerModel == null || e.ExecuteBase)
            {
                string url = string.Empty;
                if (eventString == &quot;New&quot;)
                {
                    if (BrixWorkflowManager.Instance.IsWorkflowAssociated(xmlModel.form.Name, Request[&quot;PID&quot;],
                        Request[&quot;ParentID&quot;]))
                    {
                        workflowsInitiated = BrixWorkflowManager.Instance.TriggerWorkflow(
                            TriggerPoint.TriggerActions[0], xmlModel.form.Name, Request[&quot;PID&quot;], Request[&quot;ParentID&quot;], &quot;&quot;,
                            xmlModel.form.instanceID, xmlModel.form.PrimaryKeyName);
                        var waitForWFToStart = new AutoResetEvent(false);
                        waitForWFToStart.WaitOne(200);

                        if (null != workflowsInitiated &amp;&amp; workflowsInitiated.Count &gt; 0)
                            workflowGuid = workflowsInitiated[0];
                    }

                    url += &quot;BrixForm.aspx?Context=&quot; + xmlModel.form.Name + &quot;&amp;PID=&quot; +
                           ((Request[&quot;PID&quot;] == null) ? &quot;0&quot; : Request[&quot;PID&quot;]) + &quot;&amp;ParentID=&quot; +
                           ((Request[&quot;ParentID&quot;] == null) ? &quot;0&quot; : Request[&quot;ParentID&quot;]) + &quot;&amp;Mode=New&quot;;
                    if (Request.QueryString[&quot;module&quot;] != null) url += &quot;&amp;module=&quot; + Request.QueryString[&quot;module&quot;];
                    if (Request.QueryString[&quot;LMID&quot;] != null) url += &quot;&amp;LMID=&quot; + Request.QueryString[&quot;LMID&quot;];
                    if (Request.QueryString[&quot;ParentInstanceID&quot;] != null)
                        url += &quot;&amp;ParentInstanceID=&quot; + Request.QueryString[&quot;ParentInstanceID&quot;];
                    if (workflowGuid != null) url += &quot;&amp;WFID=&quot; + workflowGuid;
                    Response.Redirect(url, true);
                }
                else if (eventString == &quot;View&quot; || eventString == &quot;ViewDblClick&quot;)
                {
                    ((System.Web.UI.Page)HttpContext.Current.Handler).Session.Add(&quot;queryStrings&quot;, Request.QueryString);
                    url += &quot;BrixForm.aspx?Context=&quot; + xmlModel.form.Name + &quot;&amp;PID=&quot; +
                           ((Request[&quot;PID&quot;] == null) ? &quot;0&quot; : Request[&quot;PID&quot;]) + &quot;&amp;ParentID=&quot; +
                           ((Request[&quot;ParentID&quot;] == null) ? &quot;0&quot; : Request[&quot;ParentID&quot;]) + &quot;&amp;Mode=View&quot;;
                    string id = string.Empty;
                    if (eventString == &quot;View&quot;)
                        id = GetSelectedIds();
                    if (eventString == &quot;ViewDblClick&quot; &amp;&amp; mwGrid.MasterTableView.GetSelectedItems().Count() &gt; 0 &amp;&amp;
                        mwGrid.MasterTableView.GetColumnSafe(QueryStringName) != null)
                        id = mwGrid.MasterTableView.GetSelectedItems()[0][QueryStringName].Text;
                    url += &quot;&amp;InstanceID=&quot; + id;
                    if (Request.QueryString[&quot;module&quot;] != null) url += &quot;&amp;module=&quot; + Request.QueryString[&quot;module&quot;];
                    if (Request.QueryString[&quot;LMID&quot;] != null) url += &quot;&amp;LMID=&quot; + Request.QueryString[&quot;LMID&quot;];
                    if (Request.QueryString[&quot;ParentInstanceID&quot;] != null)
                        url += &quot;&amp;ParentInstanceID=&quot; + Request.QueryString[&quot;ParentInstanceID&quot;];
                    if (!string.IsNullOrEmpty(id))
                        Response.Redirect(url, true);
                }
                else if (eventString == &quot;Modify Form&quot;)
                {
                    // redirect to formeditor with module id and context
                    string redirectURL = &quot;~/Modules/FRMBLDR/XmlFormBuilder.aspx?Mode=Modify&amp;context=&quot; +
                                         Request.QueryString[&quot;xcontext&quot;];
                    if (!string.IsNullOrEmpty(Request[&quot;module&quot;]))
                        redirectURL += &quot;&amp;moduleid=&quot; + Request[&quot;module&quot;];
                    HttpContext.Current.Session[&quot;ReturnURL&quot;] = Request.RawUrl;
                    Response.Redirect(redirectURL, true);
                }
                //else if (eventString == &quot;Details Report&quot;)
                //{
                //    ((Page)HttpContext.Current.Handler).Session.Add(&quot;queryStrings&quot;, Request.QueryString);
                //    url += &quot;BrixForm.aspx?Context=&quot; + xmlModel.form.Name + &quot;&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ParentID=&quot; +
                //           ((Request[&quot;ParentID&quot;] == null) ? &quot;0&quot; : Request[&quot;ParentID&quot;]) + &quot;&amp;Mode=Report&quot;;
                //    string id = string.Empty;
                //    id = GetSelectedIds();
                //    url += &quot;&amp;InstanceID=&quot; + id;
                //    if (Request.QueryString[&quot;module&quot;] != null) url += &quot;&amp;module=&quot; + Request.QueryString[&quot;module&quot;];
                //    if (Request.QueryString[&quot;LMID&quot;] != null) url += &quot;&amp;LMID=&quot; + Request.QueryString[&quot;LMID&quot;];

                //    if (id.Split(&#39;,&#39;).Length &gt; 1)
                //        return &quot;Please Select only one Record to View the Report.&quot;;

                //    if (!string.IsNullOrEmpty(id))
                //        Response.Redirect(url, true);
                //    else
                //        return &quot;Please Select a Record to View the Report.&quot;;
                //}

                else if (eventString == &quot;Audit Log&quot;)
                {
                    ValidateFormForAuditLog(xmlModel);
                }
                else if (eventString == &quot;Generate QR&quot;)
                {
                    string id = string.Empty;
                    id = GetSelectedIds();
                    Response.Redirect(string.Format(&quot;~/Common/QRViewer.aspx?ID={0}&amp;Rurl={1}&amp;QRCtrlCount={2}&amp;NoCol&amp;&quot;, id, HttpContext.Current.Server.UrlEncode(Request.RawUrl), xmlModel.form.QRGenerator.QRControl.Count, xmlModel.form.QRGenerator.NoOfColumns) + Request.QueryString);
                }
                else
                    return base.HandleMenuItem(eventString);
            }
            else
                return base.HandleMenuItem(eventString);

            return &quot;&quot;;
        }

        public override string HandleMenuItems(string eventString, UltraWebGridExcelExporter UltraWebGridExcelExporter1, string filter = &quot;&quot;)
        {
            string errors = string.Empty;

            var e = new XmlFormArgs();

            HttpResponse response = HttpContext.Current.Response;

            response.Clear();

            if (!string.IsNullOrEmpty(ExportFileDownloadTokenID) &amp;&amp; !string.IsNullOrEmpty(ExportFileDownloadTokenValue))
            {
                response.AppendCookie(new HttpCookie(ExportFileDownloadTokenID, ExportFileDownloadTokenValue));
            }

            if (listManagerModel != null)
                listManagerModel.HandleMenuItems(eventString, UltraWebGridExcelExporter1, this, e);

            if (listManagerModel == null || e.ExecuteBase)
            {
                if (eventString == &quot;Excel Export (xls)&quot; || eventString == &quot;Excel Export (xlsx)&quot;)
                {
                    ExportToExcel(eventString, filter);
                }
                else if (eventString == &quot;Excel Import&quot;)
                {
                    ImportFromExcel();
                }
                else if (eventString == &quot;Excel Template Export (xls)&quot; || eventString == &quot;Excel Template Export (xlsx)&quot; || eventString == &quot;Excel Template (xls)&quot; || eventString == &quot;Excel Template (xlsx)&quot;)
                {
                    ExportTemplate(eventString);
                }
                else
                {
                    //call HandleMenuItem when the event is not handles in any of the derived classes
                    //ExecuteBase should be set to false when we handle the event in any of the derived classes
                    errors = HandleMenuItem(eventString);
                }
            }

            return errors;
        }

        public override BrixFilter[] GetApplySearchFilterLabels()
        {
            bool isSearch = true;
            filters = new Dictionary&lt;string, BrixFilter&gt;();
            xmlModel.form.ProcessAllContainersDeeply(c =&gt;
            {
                if (c.GetType() == typeof(Section))
                    AddFilterForSearchSection(c as Section);
            });

            xmlModel.form.ProcessAllContainersDeeply(
               cc =&gt;
               {
                   if (cc is DynamicGrid || cc is StaticGrid)
                   {
                       if (((cc is StaticGrid) &amp;&amp; cc.Containers[0].GetType() == typeof(Header)) || cc is DynamicGrid &amp;&amp; !string.IsNullOrEmpty(cc.Name))
                       {

                           foreach (xControl xctrl in
                                (cc is StaticGrid) ? cc.Containers[0].Controls : cc.Controls)
                           {
                               if (xctrl.Type != Aurigo.Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden)
                               {
                                   AddFilterForControl(xctrl, &quot;&quot;, isSearch, &quot;&quot;, true, cc.Name, (cc is StaticGrid) ? ((StaticGrid)cc).Caption : ((DynamicGrid)cc).Caption, ((DataBaseContainer)cc).TableName);
                               }
                           }
                       }
                   }
               });

            List&lt;BrixFilter&gt; filterList = filters.Select(kvp =&gt; kvp.Value).ToList();

            //Pass this array to a XML form manager to add required controls. 
            if (listManagerModel != null)
                listManagerModel.AddFilterLabels(this, filterList);
            return filterList.ToArray();
        }

        private void AddFilterForSearchSection(Section sec)
        {
            bool isSearch = true;
            foreach (xControl ctrl in sec.Controls)
            {
                if (ctrl.Controls.Count &gt; 0)
                {
                    foreach (xControl innerCtrl in ctrl.Controls)
                        if (!string.IsNullOrEmpty(innerCtrl.DBType) &amp;&amp;
                            innerCtrl.Type != Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden &amp;&amp; (string.IsNullOrEmpty(ctrl.Value) || !ctrl.Value.Contains(&quot;_Picker&quot;))
                            &amp;&amp; innerCtrl.Type != Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownTreeDataControl)
                            AddFilterForControl(innerCtrl, &quot;&quot;, isSearch, sec.Caption);
                }
                else
                {
                    if (!string.IsNullOrEmpty(ctrl.DBType) &amp;&amp; ctrl.Type != Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden &amp;&amp; ctrl.Type != Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownTreeDataControl)
                        AddFilterForControl(ctrl, &quot;&quot;, isSearch, sec.Caption);
                }
            }
        }

        public override BrixFilter[] GetApplyFilterLabels()
        {
            filters = new Dictionary&lt;string, BrixFilter&gt;();
            xmlModel.form.ProcessAllContainersDeeply(c =&gt;
            {
                if (c.GetType() == typeof(Section))
                    AddFilterForSection(c as Section);
            });

            foreach (KeyValuePair&lt;string, ForeignKeyReference&gt; kvp in xmlModel.form.References)
            {
                xControl referedCtrl = kvp.Value.ReferedBy;
                if (kvp.Value.RequiredColumns.Count &gt; 0 &amp;&amp; referedCtrl != null
                    &amp;&amp; !filters.ContainsKey(referedCtrl.Name))
                    AddFilterForControl(referedCtrl);
            }

            List&lt;BrixFilter&gt; filterList = filters.Select(kvp =&gt; kvp.Value).ToList();

            //Pass this array to a XML form manager to add required controls. 
            if (listManagerModel != null)
                listManagerModel.AddFilterLabels(this, filterList);
            return filterList.ToArray();
        }

        private void AddFilterForSection(Section sec)
        {
            foreach (xControl ctrl in sec.Controls)
            {
                if (ctrl.Controls.Count &gt; 0)
                {
                    foreach (xControl innerCtrl in ctrl.Controls)
                        if (!string.IsNullOrEmpty(innerCtrl.DBType) &amp;&amp; innerCtrl.IsListVisible &amp;&amp;
                            innerCtrl.Type != Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden &amp;&amp;
                            string.IsNullOrEmpty(innerCtrl.ReferenceColumn))
                            AddFilterForControl(innerCtrl);
                }
                else
                {
                    if (!string.IsNullOrEmpty(ctrl.DBType) &amp;&amp; ctrl.IsListVisible &amp;&amp;
                        ctrl.Type != Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden &amp;&amp;
                        string.IsNullOrEmpty(ctrl.ReferenceColumn))
                        AddFilterForControl(ctrl);
                }
            }
        }

        private void AddFilterForControl(xControl ctrl, string dbColumnName = &quot;&quot;, bool isSearch = false, string CaptionName = &quot;&quot;, bool isDynamicGrid = false, string DynamicGridName = &quot;&quot;, string DynamicGridCaption = &quot;&quot;, string DynamicGridTableName = &quot;&quot;)
        {
            var BFilter = new BrixFilter();
            BFilter.Name = ctrl.Name.Replace(&quot; &quot;, &quot;&quot;);
            BFilter.DBColumnName = string.IsNullOrEmpty(dbColumnName) ? ctrl.Name : dbColumnName;
            BFilter.Title = !string.IsNullOrEmpty(ctrl.Caption) ? ctrl.ParseDynamicString(ctrl.Caption) : ctrl.Name;
            BFilter.IsTimezoneApplicable = ctrl.IsTimezoneApplicable;

            if (isSearch)
            {
                if (!string.IsNullOrEmpty(ctrl.DataSource) &amp;&amp;
                        ctrl.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList &amp;&amp;
                        (ctrl.DataSource.ToLower().Contains(&quot;_request&quot;) || ctrl.DataSource.ToLower().Contains(&quot;$&quot;)))
                    ctrl.Type = Brix.Platform.BusinessLayer.XMLForm.ControlType.TextBox;

                BFilter.Title = !string.IsNullOrEmpty(ctrl.Caption) ? ctrl.ParseDynamicString(ctrl.Caption) : (string.IsNullOrEmpty(CaptionName) ? ctrl.Name : CaptionName);

                if (isDynamicGrid)
                {
                    BFilter.isGridSection = true;
                    BFilter.DynamicGridName = DynamicGridName;
                    BFilter.DynamicGridCaption = DynamicGridCaption;
                    BFilter.DynamicGridTableName = DynamicGridTableName;
                    ctrl.Name = DynamicGridName + &quot;_&quot; + ctrl.Name;
                }

                if (!string.IsNullOrEmpty(CaptionName))
                {
                    BFilter.sectionCaption = CaptionName;
                }
            }

            switch (ctrl.Type)
            {
                case Brix.Platform.BusinessLayer.XMLForm.ControlType.TextArea:
                case Brix.Platform.BusinessLayer.XMLForm.ControlType.TextBox:
                case Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden:
                    BFilter.FilterType = BrixFilter.Type.Text;
                    break;
                case Brix.Platform.BusinessLayer.XMLForm.ControlType.Date:
                    BFilter.FilterType = BrixFilter.Type.Date;
                    break;
                case Brix.Platform.BusinessLayer.XMLForm.ControlType.Numeric:
                    BFilter.FilterType = BrixFilter.Type.Real;
                    break;
                case Brix.Platform.BusinessLayer.XMLForm.ControlType.CheckBox:
                    BFilter.FilterType = BrixFilter.Type.CheckBox;
                    BFilter.Values = new Dictionary&lt;string, string&gt;();
                    BFilter.Values[&quot;Text&quot;] = &quot;&quot;;
                    BFilter.DBType = ctrl.DBType;
                    break;
                case Brix.Platform.BusinessLayer.XMLForm.ControlType.RadioButtonList:
                    BFilter.FilterType = BrixFilter.Type.Radio;
                    RadioButtonList rbl = new RadioButtonList();
                    BFilter.Values = new Dictionary&lt;string, string&gt;();
                    BFilter.DataTextField = &quot;Key&quot;;
                    BFilter.DataValueField = &quot;Value&quot;;
                    HtmlRenderer.BindRadioButtonList(ctrl, rbl);
                    foreach (ListItem li in rbl.Items)
                    {
                        BFilter.Values.Add(li.Text, li.Value);
                    }
                    break;
                case Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList:
                    BFilter.FilterType = BrixFilter.Type.Combo;
                    BFilter.DataTextField = &quot;Value&quot;;
                    BFilter.DataValueField = &quot;Key&quot;;
                    DropDownList ddl = new DropDownList();
                    try
                    {
                        HtmlRenderer.BindDropDown(ctrl, ddl);
                    }
                    catch (Exception)
                    {
                    }
                    BFilter.Values = new Dictionary&lt;string, string&gt;();
                    foreach (ListItem li in ddl.Items)
                    {
                        BFilter.Values.Add(li.Value, li.Text);
                    }

                    break;
            }
            if (BFilter != null) filters.Add(ctrl.Name, BFilter);
        }

        public override void HandleGridDblClick&lt;T&gt;(T row)
        {
            if (displayView)
                HandleMenuItem(&quot;ViewDblClick&quot;);
        }

        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int CurrentPage,
            out int count)
        {
            sortOrder = string.IsNullOrEmpty(sortOrder) ? DefaultSortColumn + &quot; DESC&quot; : sortOrder;

            if (!string.IsNullOrEmpty(sortOrder) &amp;&amp; sortOrder.Contains(&quot;img_&quot;))
                sortOrder = sortOrder.Replace(&quot;img_&quot;, string.Empty);

            count = 0;


            Dictionary&lt;string, string&gt; dicFilters = null;

            List&lt;xControl&gt; filters = xmlModel.form.GetForeignKeyControls();
            if (filters.Count &gt; 0)
            {
                dicFilters = new Dictionary&lt;string, string&gt;();
                foreach (xControl filterControl in filters)
                    dicFilters.Add(filterControl.Name, filterControl.EvaluateControlValue());
            }
            UserDetail ud = UserDetail.GetCurrentUserDetail();

            var e = new XmlFormArgs();
            if (listManagerModel != null)
                dicFilters = listManagerModel.HandleFilters(dicFilters, this, e);


            DataSet ds = new DataSet();
            string sortBy = sortOrder;


            if (listManagerModel != null)
                listManagerModel.BeforeGetList(this, null);

            string tableName = string.IsNullOrEmpty(FormTableName) ? xmlModel.form.TableName : FormTableName;

            if (xmlModel.form.GetDataFromERP &amp;&amp; IsERPConnected) //Ax is connected and form gets data from AX
            {
                // call the getlist function of AXGetListDataProvider
                ds = GenericAXGetListDataProvider.Instance.GetList(xmlModel.form.Name, AdditionalInfo, pageSize,
                    sortOrder, filter, ref CurrentPage, out count);
            }
            else
            {
                //If teh column name is not persent or the column name has a space, then its a reference column 
                //if (sortOrder.Split(&#39; &#39;).Length &gt; 2 || xmlModel.form.GetControl(sortOrder.Split(&#39; &#39;)[0].Trim().TrimStart(&#39;[&#39;).TrimEnd(&#39;]&#39;)) == null)
                //    sortBy = xmlModel.form.PrimaryKeyName;

                ds = CoreDatabaseHelper.GetODSData(FormViewName, pageSize, sortBy, filter, filter.Trim().StartsWith(&quot;&lt;&quot;),
                    ref CurrentPage, out count, dicFilters, ud.RID, ud.UID, null,
                    false, xmlModel.form.Name, xmlModel.form.PrimaryKeyName, null,
                    (xmlModel.form.RequestParameters.ContainsKey(&quot;pid&quot;) ? xmlModel.form.RequestParameters[&quot;pid&quot;].ToInt32_2() : 0),
                    filterOrSortHasPendingOnUser: FilterOrSortHasPendingOnUser);
            }


            ds = GenericXMLListModel.ManageDropDownListItemsInternal(ds, xmlModel, _isExcelExportContext);
            //AddReferenceColumns(ds);
            //if (xmlModel.form.AllowAttachments)
            //    AddAttachmentColumn(ds);

            //Apply sort and return ds
            //if (sortBy != sortOrder)
            //{
            //    DataSet sortedDs = new DataSet();
            //    DataTable sortedDt = ds.Tables[0].Clone();
            //    sortedDs.Tables.Add(sortedDt);
            //    ds.Tables[0].Select(&quot;&quot;, sortOrder).CopyToDataTable(sortedDt, LoadOption.Upsert);
            //    return sortedDs;
            //}
            //else
            if (listManagerModel != null)
                ds = listManagerModel.AfterGetList(this, ds, null);
            return ds;
        }

        public override List&lt;string&gt; GetMapDetails(string filter)
        {
            List&lt;string&gt; mapDetails = new List&lt;string&gt;();
            if (xmlModel.form.ShowMapView)
            {
                xControl mapControl = null;
                xControl filterControl = null;
                bool findFilterControl = !string.IsNullOrEmpty(xmlModel.form.MapFilterKey)
                                         &amp;&amp; xmlModel.form.MapFilterKey != &quot;WorkflowStatus&quot;;
                xmlModel.form.ProcessAllControlsDeeply
                    (xc =&gt;
                    {
                        if (xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.Map)
                        {
                            mapControl = xc;
                        }
                        if (findFilterControl)
                            if (xc.Name == xmlModel.form.MapFilterKey)
                                filterControl = xc;
                    });

                if (mapControl != null)
                {
                    string query = &quot;select &quot; + mapControl.Name + &quot; from &quot; + FormTableName;

                    if (xmlModel.form.MapFilterKey == &quot;WorkflowStatus&quot;)
                    {
                        query = @&quot;select &quot; + FormTableName + @&quot;.*,WF.CurrentStatus as WorkflowStatus
                        from &quot; + FormTableName + @&quot; inner join WorkflowFormMapping WF on &quot; + FormTableName + @&quot;.&quot; +
                                xmlModel.form.PrimaryKeyName + @&quot; = WF.FormInstanceID 
                        and WF.FormID = &#39;&quot; + xmlModel.form.Name + @&quot;&#39; where 1=1 &quot;;
                        string whrCond = xmlModel.form.BuildForeignKeyFilter();
                        if (!string.IsNullOrEmpty(whrCond))
                            query += whrCond.Replace(&quot;where&quot;, &quot; and &quot;);
                        if (!string.IsNullOrEmpty(filter))
                            query += &quot; and WF.CurrentStatus in (&quot; + filter + &quot;)&quot;;
                    }
                    else //TODO: Need to fix this
                        query += (string.IsNullOrEmpty(filter) ? &quot;&quot; : (&quot; where  &quot; + filter));

                    DataSet ds = ComponentHelper.Instance.ExecuteDataSet(query);

                    JsonObject optionObject = new JsonObject();
                    JsonArray graphicsArray = new JsonArray();

                    if (ds != null &amp;&amp; ds.Tables.Count &gt; 0)
                    {
                        foreach (DataRow dr in ds.Tables[0].Rows)
                        {
                            string vals = dr[mapControl.Name].ToString();
                            if (!string.IsNullOrEmpty(vals) &amp;&amp; vals.Contains(&quot;~~&quot;))
                            {
                                string[] values = vals.Split(new string[] { &quot;~~&quot; },
                                    StringSplitOptions.RemoveEmptyEntries);
                                if (values.Length == 2)
                                {
                                    optionObject = JsonObject.Parse(values[1]).ToJsonObject();

                                    JsonObject graphicsObject = JsonObject.Parse(values[0]).ToJsonObject();

                                    //Add Attributes Json Object to graphics object
                                    JsonObject attrObject = new JsonObject();
                                    foreach (DataColumn column in ds.Tables[0].Columns)
                                    {
                                        string columnName = column.ColumnName;
                                        xControl ctrl = xmlModel.form.GetControl(columnName);
                                        if (columnName != mapControl.Name &amp;&amp; ctrl != null &amp;&amp; ctrl.IsListVisible)
                                        {
                                            string columnValue = dr[column.ColumnName].ToString();
                                            if (ctrl.Type ==
                                                Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList)
                                            {
                                                DropDownList ddl = new DropDownList();
                                                HtmlRenderer.BindDropDown(ctrl, ddl);
                                                foreach (ListItem li in ddl.Items)
                                                {
                                                    if (li.Value == columnValue)
                                                    {
                                                        columnValue = li.Text;
                                                        break;
                                                    }
                                                }
                                            }
                                            attrObject.Add(
                                                (string.IsNullOrEmpty(ctrl.Caption)
                                                    ? ctrl.Name
                                                    : ctrl.ParseDynamicString(ctrl.Caption)).Replace(&quot;:&quot;, &quot;&quot;).Trim(),
                                                columnValue);
                                        }
                                    }

                                    string url = string.Empty;
                                    url += &quot;BrixForm.aspx?Context=&quot; + xmlModel.form.Name + &quot;&amp;PID=&quot; + Request[&quot;PID&quot;] +
                                           &quot;&amp;ParentID=&quot; +
                                           ((Request[&quot;ParentID&quot;] == null) ? &quot;0&quot; : Request[&quot;ParentID&quot;]) + &quot;&amp;Mode={0}&quot;;
                                    url += &quot;&amp;InstanceID=&quot; + dr[xmlModel.form.PrimaryKeyName];
                                    if (Request.QueryString[&quot;module&quot;] != null)
                                        url += &quot;&amp;module=&quot; + Request.QueryString[&quot;module&quot;];
                                    if (Request.QueryString[&quot;LMID&quot;] != null)
                                        url += &quot;&amp;LMID=&quot; + Request.QueryString[&quot;LMID&quot;];
                                    if (Request.QueryString[&quot;ParentInstanceID&quot;] != null)
                                        url += &quot;&amp;ParentInstanceID=&quot; + Request.QueryString[&quot;ParentInstanceID&quot;];

                                    attrObject.Add(&quot;InfoWindowTitle&quot;,
                                        xmlModel.form.ParseDynamicString(xmlModel.form.Header) + &quot; Details&quot;);
                                    attrObject.Add(&quot;EditDetailsURL&quot;, url.Format2(&quot;Edit&quot;));
                                    attrObject.Add(&quot;ViewDetailsURL&quot;, url.Format2(&quot;View&quot;));

                                    Dictionary&lt;string, string&gt; colors = MapColors;
                                    attrObject.Add(&quot;Color&quot;, GetColor(dr[&quot;WorkflowStatus&quot;].ToString(), ref colors));
                                    MapColors = colors;

                                    for (int i = 0; i &lt; ((JsonArray)graphicsObject[&quot;graphics&quot;]).Count; i++)
                                    {
                                        JsonObject obj = ((JsonArray)graphicsObject[&quot;graphics&quot;])[i].ToJsonObject();

                                        if (obj.ContainsKey(&quot;attributes&quot;))
                                            ((JsonArray)graphicsObject[&quot;graphics&quot;])[i][&quot;attributes&quot;] = attrObject;
                                        else
                                            ((JsonObject)((JsonArray)graphicsObject[&quot;graphics&quot;])[i]).Add(
                                                &quot;attributes&quot;, attrObject);
                                    }

                                    graphicsArray.Add(graphicsObject);
                                }
                            }
                        }
                    }

                    mapDetails.Add(optionObject.ToString());
                    mapDetails.Add(graphicsArray.ToString());
                }
                if (xmlModel.form.MapFilterKey == &quot;WorkflowStatus&quot;)
                {
                    string query = @&quot;select distinct WF.CurrentStatus 
                        from &quot; + FormTableName + @&quot; inner join WorkflowFormMapping WF on &quot; + FormTableName + @&quot;.&quot; +
                                   xmlModel.form.PrimaryKeyName + @&quot; = WF.FormInstanceID 
                        and WF.FormID = &#39;&quot; + xmlModel.form.Name + @&quot;&#39;&quot;;
                    string whrCond = xmlModel.form.BuildForeignKeyFilter();
                    if (!string.IsNullOrEmpty(whrCond))
                        query += whrCond;

                    string filters = string.Empty;

                    DataSet ds = ComponentHelper.Instance.ExecuteDataSet(query);
                    if (ds != null &amp;&amp; ds.Tables.Count &gt; 0)
                    {
                        foreach (DataRow row in ds.Tables[0].Rows)
                        {
                            Dictionary&lt;string, string&gt; colors = MapColors;
                            filters += row[&quot;CurrentStatus&quot;].ToString() + &quot;~~&quot; +
                                       &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;div style=&#39;width:10px;height:10px;background-color:&quot; +
                                       GetColor(row[&quot;CurrentStatus&quot;].ToString(), ref colors) + &quot;&#39;&gt;&lt;/div&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;&quot; +
                                       row[&quot;CurrentStatus&quot;].ToString() + &quot;&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;,&quot;;
                            MapColors = colors;
                        }

                        filters = filters.TrimEnd(&#39;,&#39;);
                        mapDetails.Add(filters);
                    }
                }
                else if (filterControl != null)
                {
                }
            }
            return mapDetails;
        }

        private string GetColor(string workflowStatus, ref Dictionary&lt;string, string&gt; colors)
        {
            //Red,Blue,Green,Yellow,Orange
            List&lt;string&gt; validColors = new List&lt;string&gt;()
            {
                &quot;#FF0000&quot;,
                &quot;#0000FF&quot;,
                &quot;#00FF00&quot;,
                &quot;#FFFF00&quot;,
                &quot;#FF8000&quot;,
                &quot;#4CF2F4&quot;,
                &quot;#BABCFD&quot;,
                &quot;#FEA2FC&quot;,
                &quot;#E0BDFE&quot;,
                &quot;#D911FF&quot;,
                &quot;#FFDA53&quot;
            };
            if (!colors.ContainsKey(workflowStatus))
            {
                foreach (string color in validColors)
                {
                    if (!colors.ContainsValue(color))
                    {
                        colors.Add(workflowStatus, color);
                        break;
                    }
                }
            }

            return colors[workflowStatus];
        }

        //private void AddAttachmentColumn(DataSet ds)
        //{
        //    if (ds != null &amp;&amp; ds.Tables.Count &gt; 0)
        //    {
        //        if (!ds.Tables[0].Columns.Contains(&quot;HasAttachments&quot;))
        //            ds.Tables[0].Columns.Add(&quot;HasAttachments&quot;);

        //        string ids = string.Join(&quot;, &quot;, ds.Tables[0].Rows.OfType&lt;DataRow&gt;().Select(r =&gt; r[xmlModel.form.PrimaryKeyName]));

        //        string query = &quot;select * from LINKMODLinkDetails &quot;;


        //    }
        //}

        public static DataSet ManageDropDownListItems(DataSet ds, BrixFormModel xmlModel)
        {
            return ManageDropDownListItemsInternal(ds, xmlModel);
        }
        //TODO: Please simplify the code. There must be a better way of doing it - Akila
        public static DataSet ManageDropDownListItemsInternal(DataSet ds, BrixFormModel xmlModel, bool showDDTreeNodeFullPath = false)
        {
            DataSet newDs = new DataSet();
            //For each table in the dataset,
            //Create a new table
            //If a control is of type drop down list and ListItems is not empty,
            //Then replace that column&#39;s value with the text. 
            //Add that newly created data table to the new dataset and return it.

            foreach (DataTable dt in ds.Tables)
            {
                DataTable newDt = new DataTable();
                Dictionary&lt;string, Dictionary&lt;string, string&gt;&gt; listItems =
                    new Dictionary&lt;string, Dictionary&lt;string, string&gt;&gt;();
                //List&lt;string&gt; colsToDelete = new List&lt;string&gt;();
                foreach (DataColumn dc in dt.Columns)
                {
                    DataColumn newDc = new DataColumn();
                    if (!listItems.ContainsKey(dc.ColumnName))
                    {
                        xControl xc = xmlModel.form.GetControl(dc.ColumnName);
                        if (xc != null &amp;&amp; xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList &amp;&amp;
                            (!(string.IsNullOrEmpty(xc.ListItems)) &amp;&amp; (string.IsNullOrEmpty(xc.DataSource))))
                        {
                            Dictionary&lt;string, string&gt; dic = new Dictionary&lt;string, string&gt;();
                            foreach (
                                string item in
                                    xc.ListItems.Split(new string[] { &quot;;&quot; }, StringSplitOptions.RemoveEmptyEntries))
                            {
                                string[] kv = item.Split(&#39;:&#39;);
                                if (!dic.ContainsKey(kv[1]))
                                {
                                    dic.Add(kv[1], kv[0]);
                                }
                            }
                            listItems.Add(dc.ColumnName, dic);
                            newDc.DataType = typeof(String);
                            newDc.ExtendedProperties.Add(&quot;ListItems&quot;, dic);
                        }
                        else if (xc != null &amp;&amp; xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList
                                 &amp;&amp; (!(string.IsNullOrEmpty(xc.DataSource)) &amp;&amp; xc.DataSource.StartsWith(&quot;{&quot;)))
                        {
                            Dictionary&lt;string, string&gt; dic = new Dictionary&lt;string, string&gt;();
                            List&lt;FormListItem&gt; lbis = xc.GetFormList();
                            foreach (FormListItem fli in lbis)
                            {
                                if (!dic.ContainsKey(fli.value))
                                {
                                    dic.Add(fli.value, fli.display);
                                }
                            }
                            listItems.Add(dc.ColumnName, dic);
                            newDc.DataType = typeof(String);
                            newDc.ExtendedProperties.Add(&quot;ListItems&quot;, dic);
                        }
                        else
                        {
                            newDc.DataType = dc.DataType;
                        }
                    }
                    newDc.ColumnName = dc.ColumnName;
                    newDt.Columns.Add(newDc);
                }

                foreach (DataRow row in dt.Rows)
                {
                    DataRow newRow = newDt.NewRow();
                    foreach (DataColumn dc in dt.Columns)
                    {
                        xControl xc = xmlModel.form.GetControl(dc.ColumnName);
                        // in case of multiselect DDtree str, show all the leaf nodes instead of full trree str for each tree selected
                        if (xc != null &amp;&amp; xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownTreeDataControl &amp;&amp; xc.EnableMultiSelect)
                        {
                            string nodeIds = row[dc.ColumnName].ToString();
                            if (xc.DataSource != null)
                            {
                                string[] dataSrcOfTree = xc.DataSource.Split(&quot;;&quot;.ToCharArray());
                                string libTable = dataSrcOfTree[0], idColumn = dataSrcOfTree[1], parentColumn = dataSrcOfTree[2], displayTextCol = dataSrcOfTree[3];
                                string whereCondtion = dataSrcOfTree.Length &gt; 4 ? dataSrcOfTree[4] : string.Empty;

                                if (!showDDTreeNodeFullPath)
                                {
                                    // To show only Leaf nodes
                                    DataSet res = ComponentHelper.Instance.ExecuteDataSet(StoredProcedure.usp_GetLeafNodesInDDTree, null, nodeIds, libTable, idColumn, parentColumn, displayTextCol, whereCondtion);
                                    if (res != null &amp;&amp; res.Tables.Count &gt; 0)
                                    {
                                        if (res.Tables[0].Rows.Count &gt; 0)
                                            newRow[dc.ColumnName] = res.Tables[0].Rows[0][0].ToString();
                                    }
                                }
                                else
                                {
                                    // show complete path of node
                                    if (!string.IsNullOrEmpty(nodeIds.TrimEnd(&#39;,&#39;)))
                                    {
                                        DataSet res = ComponentHelper.Instance.ExecuteDataSet(StoredProcedure.usp_GetNodePathInDDTree, null, libTable, idColumn, parentColumn, displayTextCol, whereCondtion, nodeIds.TrimEnd(&#39;,&#39;));
                                        if (res != null &amp;&amp; res.Tables.Count &gt; 0 &amp;&amp; res.Tables[0].Rows.Count &gt; 0)
                                        {
                                            string paths = string.Empty;
                                            foreach (string id in nodeIds.TrimEnd(&#39;,&#39;).Split(&#39;,&#39;))
                                            {
                                                DataRow[] rows = res.Tables[0].Select(&quot;ID=&#39;&quot; + id + &quot;&#39;&quot;);

                                                if (rows != null &amp;&amp; rows.Length &gt; 0)
                                                {
                                                    paths += rows[0][&quot;Path&quot;].ToString() + &quot;,&quot;;
                                                }
                                            }
                                            newRow[dc.ColumnName] = paths.TrimEnd(&#39;,&#39;);
                                        }
                                        else
                                        {
                                            newRow[dc.ColumnName] = string.Empty;
                                        }
                                    }
                                    else
                                    {
                                        newRow[dc.ColumnName] = string.Empty;
                                    }
                                }
                            }
                        }
                        else if (xc != null &amp;&amp; xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList
                            &amp;&amp;
                            ((!(string.IsNullOrEmpty(xc.ListItems)) &amp;&amp; (string.IsNullOrEmpty(xc.DataSource))) ||
                             (!(string.IsNullOrEmpty(xc.DataSource)) &amp;&amp; xc.DataSource.StartsWith(&quot;{&quot;))))
                        {
                            Dictionary&lt;string, string&gt; dicValues = listItems[dc.ColumnName];
                            string key = row[dc.ColumnName].ToString();
                            string dispValue = string.Empty;
                            if (dicValues.ContainsKey(key))
                                dispValue = dicValues[key];
                            newRow[dc.ColumnName] = dispValue;
                        }
                        else if (xc != null &amp;&amp; xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.Password)
                        {
                            //newRow[dc.ColumnName] = row[dc.ColumnName];
                            newRow[dc.ColumnName] = &quot;#######&quot;; //Prevent the password from getting displayed in the List page
                        }
                        else
                        {
                            newRow[dc.ColumnName] = row[dc.ColumnName];
                        }
                    }
                    newDt.Rows.Add(newRow);
                }

                newDs.Tables.Add(newDt);
            }
            return newDs;
        }

        //TODO: Please simplify the code. There must be a better way of doing it - Akila
        //private void AddReferenceColumns(DataSet ds)
        //{
        //    StringBuilder query = new StringBuilder();
        //    foreach (ForeignKeyReference obj in xmlModel.form.References)
        //    {
        //        //Foreach of the reference columns fetching the value column and display column
        //        if (obj.RequiredColumns.Count &gt; 0)
        //            query.AppendFormat(&quot;select {2},{0} from {1};&quot;, string.Join(&quot;,&quot;, obj.RequiredColumns), obj.ReferenceTable, obj.ReferenceColumn);
        //    }
        //    if (!string.IsNullOrEmpty(query.ToString()))
        //    {
        //        //Getting all the reference table data into a new dataset

        //        //foreach (DataTable dt in newDS.Tables)

        //        //Foreach of the table in the new datatset
        //        //Create the table structure in the currect dataset
        //        //Create a relation for each of the column
        //        //Fill the table in the current dataset
        //        //And copy required column values into the table
        //        DataSet newDS = ComponentHelper.Instance.ExecuteDataSet(query.ToString());
        //        int counter = 0;
        //        foreach (ForeignKeyReference obj in xmlModel.form.References)
        //        {
        //            if (obj.RequiredColumns.Count &gt; 0)
        //            {
        //                if (!string.IsNullOrEmpty(obj.ReferedBy.ListItems))
        //                {
        //                    List&lt;FormListItem&gt; lbis = obj.ReferedBy.GetFormList();
        //                    foreach (FormListItem fli in lbis)
        //                    {

        //                        foreach (string reqC in obj.RequiredColumns)
        //                        {
        //                            string dsColumnName = GetPossibleColumnName(reqC);
        //                            if (newDS.Tables[counter].Columns.Contains(dsColumnName) &amp;&amp; NotInDataSet(newDS.Tables[counter], fli.value, obj.ReferenceColumn))
        //                            {
        //                                DataRow newDr = newDS.Tables[counter].NewRow();
        //                                newDr[obj.ReferenceColumn] = fli.value;
        //                                newDr[dsColumnName] = fli.display;
        //                                newDS.Tables[counter].Rows.Add(newDr);
        //                            }
        //                        }
        //                    }
        //                }

        //                DataTable dt = newDS.Tables[counter];
        //                dt.TableName = counter.ToString();
        //                ds.Tables.Add(dt.Clone());

        //                if (dt.Columns.Contains(obj.ReferenceColumn))
        //                {
        //                    string relationName = obj.ReferenceColumn + &quot;_&quot; + obj.ReferedBy.Name;
        //                    if (ds.Relations[relationName] == null)
        //                    {
        //                        ds.Tables[counter.ToString()].Columns[obj.ReferenceColumn].DataType = ds.Tables[0].Columns[obj.ReferedBy.Name].DataType;
        //                        ds.Relations.Add(relationName, ds.Tables[counter.ToString()].Columns[obj.ReferenceColumn], ds.Tables[0].Columns[obj.ReferedBy.Name], false);
        //                    }
        //                    foreach (DataRow row in dt.Rows)
        //                        ds.Tables[counter.ToString()].ImportRow(row);

        //                    //Adding the reference columns to the ds.
        //                    foreach (DataColumn col in ds.Tables[counter.ToString()].Columns)
        //                    {
        //                        if (col.ColumnName != ds.Tables[counter.ToString()].Columns[0].ColumnName)
        //                        {
        //                            //Dont add the primary key (value column) column to the ds.
        //                            if (!ds.Tables[0].Columns.Contains(col.ColumnName))
        //                                ds.Tables[0].Columns.Add(col.ColumnName);
        //                        }
        //                    }

        //                    foreach (DataRow parentRow in ds.Tables[counter.ToString()].Rows)
        //                    {
        //                        foreach (DataRow childRow in parentRow.GetChildRows(relationName))
        //                        {
        //                            foreach (DataColumn col in parentRow.Table.Columns)
        //                            {
        //                                if (col.ColumnName != parentRow.Table.Columns[0].ColumnName)
        //                                {
        //                                    //Assign display column value to the added column
        //                                    if (ds.Tables[0].Columns.Contains(col.ColumnName)) //ds.Tables[0].Columns.Add(col.ColumnName);
        //                                        childRow[col.ColumnName] = parentRow[col.ColumnName];
        //                                }
        //                            }
        //                        }
        //                    }

        //                }
        //                counter++;
        //            }

        //        }
        //    }
        //}

        private bool NotInDataSet(DataTable dataTable, string value, string columnName)
        {
            bool notPresent = true;

            foreach (DataRow r in dataTable.Rows)
            {
                if (r[columnName].ToString() == value)
                {
                    notPresent = false;
                    break;
                }
            }

            return notPresent;
        }

        private string GetPossibleColumnName(string reqC)
        {
            string colName = reqC;
            try
            {
                if (reqC.Contains(&quot;as&quot;))
                {
                    string[] temp = reqC.Split(new string[] { &quot;as&quot; }, StringSplitOptions.RemoveEmptyEntries);
                    string dbColName = temp[0];
                    string dsColName = temp[1];

                    colName = dsColName.Replace(&quot;[&quot;, &quot;&quot;).Replace(&quot;]&quot;, &quot;&quot;);
                }
            }
            catch
            {
            }
            return colName.Trim();
        }

        public override bool IsSynchWithServer(int ID)
        {
            return false;
        }

        protected void ExportToExcel(string eventString, string filter, bool template = false)
        {

            string table = xmlModel.form.ActualTableNameInDatabase;
            string tName = table;

            DataSet ExportDataset = new DataSet();
            Dictionary&lt;string, StringBuilder&gt; userDefinedScalarFunctions = new Dictionary&lt;string, StringBuilder&gt;();

            try
            {



                _isExcelExportContext = true;
                int pageno = 0;
                int count = 0;
                DataSet ds = GetList(Int32.MaxValue, null, filter, ref pageno, out count);



                if (ds.Tables.Count &gt; 0)
                {
                    DataTable masterDT = ds.Tables[0].Copy();
                    ds.Tables[0].Columns.Remove(xmlModel.form.PrimaryKeyName);

                    if (masterDT.Rows.Count == 0 &amp;&amp; !template)
                    {
                        throw new Exception(&quot;No data to export.&quot;);
                    }
                    ds.Tables[0].TableName = xmlModel.form.ParseDynamicString(xmlModel.form.Header);

                    //keep columns visible in list page
                    List&lt;string&gt; visibleColumns = xmlModel.form.ListColumns.Columns.Split(&#39;,&#39;).ToList();
                    List&lt;string&gt; tableColumns = ds.Tables[0].Columns.Cast&lt;DataColumn&gt;().Select(x =&gt; x.ColumnName).ToList();

                    if (string.Equals(xmlModel.form.ListColumns.Type, &quot;Visible&quot;, StringComparison.OrdinalIgnoreCase))
                    {
                        foreach (string column in tableColumns)
                        {
                            if (xmlModel.form.GetControl(column) != null)
                            {
                                if (!visibleColumns.Contains(column))
                                {
                                    ds.Tables[0].Columns.Remove(column);
                                }
                            }
                        }
                    }
                    else if (string.Equals(xmlModel.form.ListColumns.Type, &quot;Hidden&quot;, StringComparison.OrdinalIgnoreCase))
                    {
                        foreach (string column in tableColumns)
                        {
                            if (xmlModel.form.GetControl(column) != null)
                            {
                                if (visibleColumns.Contains(column))
                                {
                                    ds.Tables[0].Columns.Remove(column);
                                }
                            }
                        }
                    }
                    //

                    ModifyColumnsForExport(ds.Tables[0], xmlModel.form.Name);

                    List&lt;xControl&gt; tzControls = xmlModel.form.GetTimezoneControls();
                    ExportDataset.Tables.Add(ConvertDateValuesToMWDateTime(ds.Tables[0], tzControls));


                    xmlModel.form.ProcessAllContainersDeeply(
                        cc =&gt;
                        {
                            if (cc is DynamicGrid || cc is StaticGrid)
                            {
                                if (((cc is StaticGrid) &amp;&amp; cc.Containers[0].GetType() == typeof(Header)) ||
                                    cc is DynamicGrid)
                                {
                                    string sheetName = (cc is StaticGrid)
                                        ? (cc as StaticGrid).Caption.Trim()
                                        : (cc as DynamicGrid).Caption.Trim();
                                    sheetName = (string.IsNullOrEmpty(sheetName))
                                        ? ((cc is StaticGrid) ? (cc as StaticGrid).Name : (cc as DynamicGrid).Name)
                                        : sheetName;
                                    sheetName = cc.ParseDynamicString(sheetName);
                                    string tableName = (cc as DataBaseContainer).TableName;
                                    tName = tableName;
                                    string columns = string.Empty;
                                    List&lt;xControl&gt; tzCols = new List&lt;xControl&gt;();
                                    foreach (xControl xctrl in
                                        (cc is StaticGrid) ? cc.Containers[0].Controls : cc.Controls)
                                    {
                                        if (!string.IsNullOrEmpty(xctrl.DBType) &amp;&amp;
                                            (xctrl.ForeignKey ||
                                             xctrl.Type != Aurigo.Brix.Platform.BusinessLayer.XMLForm.ControlType.Hidden)
                                            &amp;&amp;
                                            xctrl.Type !=
                                            Aurigo.Brix.Platform.BusinessLayer.XMLForm.ControlType.AttachmentControl
                                            &amp;&amp;
                                            !(xctrl.ParentObject is
                                                Aurigo.Brix.Platform.BusinessLayer.XMLForm.AttachmentControl))
                                        {
                                            BuildSelectQuery(xctrl, ref columns, ref tableName, tName, ref userDefinedScalarFunctions);

                                            if (xctrl.IsTimezoneApplicable)
                                                tzCols.Add(xctrl);
                                        }
                                    }

                                    columns = columns.TrimEnd(&quot;, &quot;.ToCharArray());

                                    var ds1 =
                                        ComponentHelper.Instance.ExecuteDataSet(&quot;Select &quot; + (template ? &quot; Top 0 &quot; : &quot;&quot;) +
                                                                                columns + &quot; from &quot; + tableName +
                                                                                BuildWhereCondition(
                                                                                    (cc as DataBaseContainer), masterDT,
                                                                                    tName));

                                    if (masterDT.Columns.Contains(xmlModel.form.PrimaryKeyName) &amp;&amp;
                                        ds1.Tables[0].Columns.Contains(xmlModel.form.PrimaryKeyName + &quot;_FK&quot;))
                                    {
                                        foreach (DataRow row in ds1.Tables[0].Rows)
                                        {
                                            DataRow[] r =
                                                masterDT.Select(xmlModel.form.PrimaryKeyName + &quot; = &#39;&quot; +
                                                                row[xmlModel.form.PrimaryKeyName + &quot;_FK&quot;] + &quot;&#39;&quot;);
                                            if (r.Length &gt; 0 &amp;&amp; r[0].Table.Columns.Contains(&quot;RecordID&quot;))
                                                row[xmlModel.form.PrimaryKeyName + &quot;_FK&quot;] = r[0][&quot;RecordID&quot;];
                                        }
                                        ds1.Tables[0].Columns[xmlModel.form.PrimaryKeyName + &quot;_FK&quot;].ColumnName = &quot;RecordID&quot;;
                                    }
                                    //adding the tablename to the dataset as it comes as sheet name
                                    ds1.Tables[0].TableName = sheetName;
                                    //DataTable dt1 = ds1.Tables[0].Copy();
                                    ExportDataset.Tables.Add(ConvertDateValuesToMWDateTime(ds1.Tables[0], tzCols));
                                }
                            }
                        });

                    ExportTable(eventString, xmlModel.form.ParseDynamicString(xmlModel.form.Header), ExportDataset, template);
                }
            }
            catch (Exception e)
            {
                Logger.Log(Resources.MessageResources.Enumerations.LogType.Error, e.Message + e.StackTrace, &quot;GenericXMLListModel.ExportToExcel&quot;);
                throw;
            }
            finally
            {
                _isExcelExportContext = false;
                //Drop the user defined functions 

                if (userDefinedScalarFunctions.Count &gt; 0)
                {
                    StringBuilder dropFunctionScript = new StringBuilder();
                    foreach (KeyValuePair&lt;string, StringBuilder&gt; func in userDefinedScalarFunctions)
                    {
                        dropFunctionScript.AppendFormat(
                            &quot;IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N&#39;[{0}]&#39;) AND type in (N&#39;FN&#39;, N&#39;IF&#39;, N&#39;TF&#39;, N&#39;FS&#39;, N&#39;FT&#39;)) DROP FUNCTION {0} &quot;,
                            func.Key);
                    }
                    if (!string.IsNullOrEmpty(dropFunctionScript.ToString()))
                        ComponentHelper.Instance.ExecuteNonQuery(dropFunctionScript.ToString());
                }
            }
        }

        private DataTable ConvertDateValuesToMWDateTime(DataTable dt, List&lt;xControl&gt; timezoneColumns)
        {
            if (timezoneColumns != null &amp;&amp; timezoneColumns.Count &gt; 0)
            {
                DataTable newDt = dt.Clone();
                string colName = string.Empty;
                foreach (xControl xc in timezoneColumns)
                {
                    string cName = xc.Name;
                    if (newDt.Columns[cName] != null)
                        newDt.Columns[cName].DataType = typeof(string);

                }

                foreach (DataRow row in dt.Rows)
                {
                    newDt.ImportRow(row);
                    DataRow newRow = newDt.Rows[newDt.Rows.Count - 1];
                    foreach (xControl xc in timezoneColumns)
                    {
                        colName = xc.Name;
                        if (newDt.Columns.Contains(colName))
                        {
                            newRow[colName] = string.IsNullOrEmpty(newRow[colName].ToString()) ? newRow[colName] :
                             (!string.IsNullOrEmpty(xc.Format) &amp;&amp; xc.Format.Equals(&quot;date&quot;, StringComparison.CurrentCultureIgnoreCase))
                             ? newRow[colName].ToString().ToMWDateTimeString_FormatDate()
                             : newRow[colName].ToString().ToMWDateTimeString_FormatDateTime();

                        }
                    }
                }
                return newDt;
            }
            else
            {
                return dt.Copy();
            }
        }

        private string DBStringBuilder_GetColumnName(string tableName, string actualColumnName, string newColumnName, bool isPrefixComma = true)
        {
            return string.Format(&quot;{0}.[{1}] AS [{2}] {3}&quot;, tableName, actualColumnName, newColumnName, isPrefixComma ? &quot;,&quot; : string.Empty);
        }

        private void BuildSelectQuery(xControl xc, ref string columns_x, ref string table, string tableName, ref Dictionary&lt;string, StringBuilder&gt; userDefinedScalarFunctions)
        {
            StringBuilder columnAppender = new StringBuilder();
            columnAppender.Append(columns_x);

            if (xc.ForeignKey)
            {
                #region ForeignKey
                //columns += tableName + &quot;.[&quot; + xc.Name + &quot;] as [&quot; + xmlModel.form.PrimaryKeyName + &quot;_FK],&quot;;
                columnAppender.Append(DBStringBuilder_GetColumnName(tableName, xc.Name, xmlModel.form.PrimaryKeyName + &quot;_FK&quot;));
                #endregion ForeignKey
            }
            else if (xc.Type.IsEqualToAny(Brix.Platform.BusinessLayer.XMLForm.ControlType.Date, Brix.Platform.BusinessLayer.XMLForm.ControlType.DateTime))
            {
                #region Date Related
                string outputFieldName = (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption));
                outputFieldName = TrimCaptionLength(outputFieldName);

                if (!string.IsNullOrEmpty(xc.Format) &amp;&amp; !xc.IsTimezoneApplicable)
                {
                    //string format = GetFormat(xc);
                    //columns += &quot;FORMAT(&quot; + tableName + &quot;.[&quot; + xc.Name + &quot;],&#39;&quot; + format + &quot;&#39;) as [&quot; +
                    //               (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) + &quot;],&quot;;
                    columnAppender.AppendFormat(&quot;FORMAT({0}.[{1}], &#39;{2}&#39;) AS [{3}] ,&quot;, tableName, xc.Name, xc.GetControlFormat(), outputFieldName);
                }
                else
                    columnAppender.Append(DBStringBuilder_GetColumnName(tableName, xc.Name, outputFieldName));
                //  columns += tableName + &quot;.[&quot; + xc.Name + &quot;] as [&quot; + (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) + &quot;],&quot;;
                #endregion Date Related
            }
            else if (xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownList ||
                     xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.RadioButtonList)
            {
                #region DropDownList/RadioButtonList Related
                DropDownList ddl = new DropDownList();
                HtmlRenderer.BindDropDown(xc, ddl);

                string outputFieldName = (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption));
                outputFieldName = TrimCaptionLength(outputFieldName);

                if (ddl.Items.Count &gt; 0)
                {
                    bool hasDBNULLItem = false;
                    columnAppender.Append(&quot;CASE &quot;);//columns += &quot;case &quot;;
                    foreach (ListItem item in ddl.Items)
                    {
                        if (!item.Value.Equals(&quot;_DBNULL_&quot;, StringComparison.CurrentCultureIgnoreCase))
                        {
                            //columns += &quot; when &quot; + tableName + &quot;.[&quot; + xc.Name + &quot;] = &#39;&quot; + item.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) +
                            //           &quot;&#39; then &#39;&quot; + item.Text.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;;
                            columnAppender.AppendFormat(&quot; WHEN {0}.[{1}] = &#39;{2}&#39; THEN &#39;{3}&#39; &quot;, tableName, xc.Name, item.Value.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;), item.Text.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;));
                        }
                        else hasDBNULLItem = true;
                    }

                    //There is no data in drop down and Select is the only option, then we should not build the case statement - Akila 
                    if (hasDBNULLItem &amp;&amp; ddl.Items.Count == 1)
                        //columns += &quot; when &quot; + tableName + &quot;.[&quot; + xc.Name + &quot;] = ISNULL(&quot; + tableName + &quot;.[&quot; + xc.Name +
                        //           &quot;],&#39;&#39;) then &#39;&#39; end as [&quot; +
                        //           (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) +
                        //           &quot;],&quot;;
                        columnAppender.AppendFormat(&quot; WHEN {0}.[{1}] = ISNULL( {0}.[{1}], &#39;&#39;)  THEN &#39;&#39; END AS [{2}], &quot;, tableName, xc.Name, outputFieldName);
                    else
                        //columns += &quot;else &#39;&#39; end as [&quot; +
                        //           (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) +
                        //           &quot;],&quot;;
                        columnAppender.AppendFormat(&quot; ELSE &#39;&#39; END AS [{0}], &quot;, outputFieldName);
                }
                else
                {
                    columnAppender.AppendFormat(&quot; &#39;&#39; AS [{0}], &quot;, outputFieldName);
                    //columns += &quot;&#39;&#39; as [&quot; + (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) + &quot;],&quot;;
                }

                #endregion DropDownList/RadioButtonList Related
            }
            else if (xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.DropDownTreeDataControl)
            {
                #region DropDownTreeDataControl

                if (string.IsNullOrEmpty(xc.DataSource))
                    return;

                string outputFieldName = (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption));
                outputFieldName = TrimCaptionLength(outputFieldName);

                string[] dataSourceSplit = xc.DataSource.Split(&quot;;&quot;.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);

                string referencedTableName = dataSourceSplit[0];
                string valueColumn = dataSourceSplit[1];
                string parentValueColumn = dataSourceSplit[2];
                string displayColumn = dataSourceSplit[3];

                //Create a function to get the Values in CSV format 


                string functionToGetPathName = &quot;fn_XMLFramework_&quot; + Guid.NewGuid().ToString().Replace(&quot;-&quot;, &quot;&quot;);
                StringBuilder functionToGetPathBody = new StringBuilder();

                functionToGetPathBody.AppendFormat(&quot;CREATE FUNCTION {0} &quot;, functionToGetPathName);
                functionToGetPathBody.Append(&quot;( @ID NVARCHAR(MAX) ) RETURNS NVARCHAR(MAX) AS BEGIN &quot;);
                functionToGetPathBody.Append(&quot;DECLARE @Result NVARCHAR(MAX) &quot;);
                functionToGetPathBody.Append(&quot;DECLARE @CurrRecName NVARCHAR(MAX) &quot;);
                functionToGetPathBody.Append(&quot;IF (ISNULL(@ID, &#39;&#39;)) = &#39;&#39; RETURN &#39;&#39; &quot;);

                if (!string.IsNullOrEmpty(parentValueColumn) &amp;&amp; parentValueColumn.ToLower() != &quot;null&quot;)
                {
                    functionToGetPathBody.AppendFormat(&quot;SELECT @Result = dbo.{0}({1}), @CurrRecName = {2} &quot;, functionToGetPathName, parentValueColumn, displayColumn);
                    functionToGetPathBody.AppendFormat(&quot;FROM {0} &quot;, referencedTableName);
                    functionToGetPathBody.AppendFormat(&quot;WHERE {0} = @ID AND {1} IS NOT NULL &quot;, valueColumn, parentValueColumn);
                }

                functionToGetPathBody.Append(&quot;IF (@Result IS NULL) BEGIN &quot;);
                functionToGetPathBody.AppendFormat(&quot;SELECT @CurrRecName = {0} &quot;, displayColumn);
                functionToGetPathBody.AppendFormat(&quot;FROM {0} &quot;, referencedTableName);
                functionToGetPathBody.AppendFormat(&quot;WHERE {0} = @ID &quot;, valueColumn);
                functionToGetPathBody.AppendFormat(&quot;SET @Result = @CurrRecName &quot;);
                functionToGetPathBody.Append(&quot;END ELSE BEGIN &quot;);
                functionToGetPathBody.AppendFormat(&quot;SET @Result = @Result + &#39;\\&#39; + @CurrRecName &quot;, displayColumn);
                functionToGetPathBody.Append(&quot;END RETURN @Result END &quot;);

                string functionName = &quot;fn_XMLFramework_&quot; + Guid.NewGuid().ToString().Replace(&quot;-&quot;, &quot;&quot;);
                StringBuilder functionBody = new StringBuilder();

                functionBody.AppendFormat(&quot;CREATE FUNCTION {0} &quot;, functionName);
                functionBody.Append(&quot;( @Values NVARCHAR(MAX) ) RETURNS NVARCHAR(MAX) AS BEGIN &quot;);
                functionBody.Append(&quot;DECLARE @Result NVARCHAR(MAX) &quot;);
                functionBody.AppendFormat(&quot;SELECT @Result = COALESCE(@Result + &#39;, &#39;, &#39;&#39;) + dbo.{0}({1}) &quot;, functionToGetPathName, valueColumn);
                functionBody.AppendFormat(&quot;FROM {0} &quot;, referencedTableName);
                functionBody.AppendFormat(&quot;WHERE {0} IN (SELECT * FROM dbo.fnSplitToVarchar(@Values)) &quot;, valueColumn);
                functionBody.Append(&quot;RETURN @Result END&quot;);

                userDefinedScalarFunctions.Add(functionToGetPathName, functionToGetPathBody);
                userDefinedScalarFunctions.Add(functionName, functionBody);

                columnAppender.AppendFormat(&quot; dbo.{0}( {1}.[{2}] ) AS [{3}], &quot;, functionName, table, xc.Name, outputFieldName);

                #endregion DropDownTreeDataControl

            }
            else if (xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.Listbox ||
                     xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.MultiPicker ||
                     xc.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.CheckBoxList)
            {
                #region Listbox/MultiPicker/CheckBoxList Related

                string outputFieldName = (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption));
                outputFieldName = TrimCaptionLength(outputFieldName);

                if (string.IsNullOrEmpty(xc.DataSource))
                {
                    //If datasource is not there then its coming from ListItems. In that case build the replace statement
                    DropDownList ddl = new DropDownList();
                    HtmlRenderer.BindDropDown(xc, ddl);


                    if (ddl.Items.Count &gt; 0)
                    {
                        string initialString = &quot;&#39;,&#39; + &quot; + xc.Name + &quot; + &#39;,&#39;&quot;;
                        string searchString = string.Empty;

                        for (int i = 0; i &lt; ddl.Items.Count; i++)
                        {
                            ListItem item = ddl.Items[i];
                            initialString = (i &gt; 0 ? searchString : initialString);
                            searchString = string.Format(&quot;Replace({0},&#39;{1}&#39;,&#39;{2}&#39;)&quot;, initialString, &quot;,&quot; + item.Value + &quot;,&quot;, &quot;,&quot; + item.Text + &quot;,&quot;);
                        }

                        //The below code is to remove the first and last comma
                        searchString = &quot;REVERSE(STUFF(REVERSE(STUFF(&quot; + searchString + &quot;,1,1,&#39;&#39;)),1,1,&#39;&#39;))&quot;;

                        //columns += searchString.ToString() + &quot; as [&quot; + (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) + &quot;],&quot;;
                        columnAppender.AppendFormat(&quot;{0} AS [{1}], &quot;, searchString, outputFieldName);
                    }
                    else
                    {
                        //columns += &quot;&#39;&#39; as [&quot; +(string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) +&quot;],&quot;;
                        columnAppender.AppendFormat(&quot;&#39;&#39; AS [{0}], &quot;, outputFieldName);
                    }
                }
                else
                {
                    //If it uses the some table, then create a scalar function and then get the text

                    string[] dataSourceDetails = xc.DataSource.Split(&#39;;&#39;);
                    if (dataSourceDetails.Length &gt;= 3)
                    {
                        string childTable = dataSourceDetails[0];
                        string displayColumn = dataSourceDetails[1];
                        string valueColumn = dataSourceDetails[2];
                        string whereCond = string.Empty;

                        if (dataSourceDetails.Length &gt; 4)
                            whereCond = xc.ParseDynamicString(dataSourceDetails[3]);

                        string parentTable = xc.form.TableName;
                        string parentIdColumnName = xc.form.PrimaryKeyName;

                        string functionName = &quot;fn_XMLFramework_&quot; + Guid.NewGuid().ToString().Replace(&quot;-&quot;, &quot;&quot;);

                        StringBuilder funcQuery = new StringBuilder();
                        //funcQuery.AppendFormat(&quot;IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N&#39;[{0}]&#39;) AND type in (N&#39;FN&#39;, N&#39;IF&#39;, N&#39;TF&#39;, N&#39;FS&#39;, N&#39;FT&#39;))&quot;, functionName);
                        //funcQuery.AppendFormat(&quot;DROP FUNCTION {0}&quot;, functionName);
                        //funcQuery.AppendFormat(&quot;{0}GO{0}&quot;, Environment.NewLine);
                        funcQuery.AppendFormat(&quot;CREATE FUNCTION dbo.{0} &quot;, functionName);
                        funcQuery.AppendFormat(&quot;( @ID int ) &quot;);
                        funcQuery.AppendFormat(&quot;returns nvarchar(max) &quot;);
                        funcQuery.Append(&quot;as &quot;);
                        funcQuery.Append(&quot;BEGIN declare @result nvarchar(max) &quot;);
                        funcQuery.Append(&quot;SELECT DISTINCT @result=&quot;);
                        funcQuery.AppendFormat(&quot;STUFF((SELECT distinct &#39;,&#39; + {0}.[{1}] &quot;, childTable, displayColumn);
                        funcQuery.AppendFormat(&quot;FROM {0} &quot;, childTable);
                        funcQuery.AppendFormat(&quot;WHERE {0}.[{1}] &quot;, childTable, valueColumn);
                        funcQuery.AppendFormat(&quot;in (select id from dbo.fnSplitToVarchar({0}.[{1}])) &quot;, parentTable, xc.Name);
                        funcQuery.AppendFormat(&quot;FOR XML PATH(&#39;&#39;), TYPE&quot;);
                        funcQuery.AppendFormat(&quot;).value(&#39;.&#39;, &#39;NVARCHAR(MAX)&#39;)&quot;);
                        funcQuery.AppendFormat(&quot;,1,1,&#39;&#39;)&quot;);
                        funcQuery.AppendFormat(&quot;FROM {0} &quot;, parentTable);
                        funcQuery.AppendFormat(&quot;where {0}.[{1}] = @ID {2} &quot;, parentTable, parentIdColumnName, whereCond);
                        funcQuery.AppendFormat(&quot;{0} return @result {0}&quot;, Environment.NewLine);
                        funcQuery.AppendFormat(&quot;END &quot;);


                        userDefinedScalarFunctions.Add(functionName, funcQuery);

                        //columns += &quot;dbo.&quot; + functionName + &quot;(&quot; + parentTable + &quot;.[&quot; + parentIdColumnName + &quot;])&quot; +
                        //           &quot; as [&quot; + (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) + &quot;],&quot;;

                        columnAppender.AppendFormat(&quot;dbo.{0}( {1}.[{2}] ) AS [3], &quot;, functionName, parentTable, parentIdColumnName, outputFieldName);
                    }
                    else
                        columnAppender.AppendFormat(&quot;&#39;&#39; AS [{0}], &quot;, outputFieldName);
                    //  columns += &quot;&#39;&#39; as [&quot; + (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) + &quot;],&quot;;
                }
                #endregion Listbox/MultiPicker/CheckBoxList Related
            }
            else
            {
                string outputFieldName = (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption));
                outputFieldName = TrimCaptionLength(outputFieldName);

                columnAppender.Append(DBStringBuilder_GetColumnName(tableName, xc.Name, outputFieldName));
                //columns += tableName + &quot;.[&quot; + xc.Name + &quot;] as [&quot; + (string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.ParseDynamicString(xc.Caption)) + &quot;],&quot;;
            }

            columns_x = columnAppender.ToString();
        }

        private string TrimCaptionLength(string controlCaption)
        {
            if (!string.IsNullOrEmpty(controlCaption))
                controlCaption = controlCaption.Length &lt;= MaxLen ? controlCaption : controlCaption.Substring(0, MaxLen);

            return controlCaption;
        }

        private void ExportTemplate(string eventString)
        {
            DataSet ds = xmlModel.form.GetSchema(true);
            MWGrid.Export(eventString, MWGrid.ExportSettings.FileFormat.Excel, MWGrid.ExportSettings.DataFormat.Template,
                ds, xmlModel.form.ParseDynamicString(xmlModel.form.Header), ds.Tables[0].TableName, this.xmlModel, null, ExportFileDownloadTokenID, ExportFileDownloadTokenValue);
            //foreach (DataTable dt in ds.Tables)
            //{
            //    MWGrid.Export(MWGrid.ExportSettings.FileFormat.Excel, MWGrid.ExportSettings.DataFormat.Template, dt, xmlModel.form.ParseDynamicString(xmlModel.form.Header), dt.TableName, this.xmlModel);
            //}
        }

        private void ExportTable(string eventString, string sheetName, DataSet ds, bool template)
        {
            //DataSet ds = new DataSet();
            //ds.Tables.Add(dt.Copy());
            MWGrid.ExportSettings.DataFormat dataFormat = (template)
                ? MWGrid.ExportSettings.DataFormat.Template
                : MWGrid.ExportSettings.DataFormat.Data;
            MWGrid.Export(eventString, MWGrid.ExportSettings.FileFormat.Excel, dataFormat, ds,
                xmlModel.form.ParseDynamicString(xmlModel.form.Header), sheetName, this.xmlModel, null);
        }

        void grid_ExcelMLWorkBookCreated(object sender, Telerik.Web.UI.GridExcelBuilder.GridExcelMLWorkBookCreatedEventArgs e)
        {
        }

        private string BuildWhereCondition(DataBaseContainer dbc, DataTable masterDT, string tableName)
        {
            string whereCond = string.Empty;
            string primaryKeyValues = string.Empty;
            foreach (DataRow dr in masterDT.Rows)
            {
                primaryKeyValues += dr[xmlModel.form.PrimaryKeyName] + &quot;,&quot;;
            }
            primaryKeyValues = primaryKeyValues.TrimEnd(&#39;,&#39;);
            if (!string.IsNullOrEmpty(primaryKeyValues))
            {
                whereCond = &quot; where &quot;;
                List&lt;xControl&gt; ctrls = dbc.GetForeignKeyControls();
                foreach (xControl xc in ctrls)
                {
                    if (xc.ForeignKey)
                        whereCond += tableName + &quot;.&quot; + xc.Name + &quot; in (&quot; + primaryKeyValues + &quot;) AND &quot;;
                    else
                        whereCond += tableName + &quot;.&quot; + xc.Name + &quot; = &#39;&quot; + xc.EvaluateControlValue() + &quot;&#39; AND &quot;;
                }
                whereCond = whereCond.Remove(whereCond.LastIndexOf(&quot;AND&quot;));
            }
            return whereCond;
        }

        private void ImportFromExcel()
        {
        }

        public override void SetHierarchicalGridProperties(DataSet sourceDataSet)
        {
            string sGroupBy = xmlModel.form.GroupBy;
            if (!(string.IsNullOrEmpty(sGroupBy)) &amp;&amp; sGroupBy.Contains(&quot;;&quot;))
            {
                sGroupBy.Split(&quot;;&quot;.ToCharArray(), StringSplitOptions.RemoveEmptyEntries).ForEach(sGroup =&gt;
                {
                    AddGroupByExpression(sGroup);

                });
            }
            else
            {
                AddGroupByExpression(sGroupBy);
            }

            base.SetHierarchicalGridProperties(sourceDataSet);

            if (listManagerModel != null)
                listManagerModel.AfterSetHierarchicalGridProperties(this, sourceDataSet);

        }

        private void AddGroupByExpression(string sGroupBy)
        {
            Telerik.Web.UI.GridGroupByExpression expression = new Telerik.Web.UI.GridGroupByExpression();
            GridGroupByField gridGroupByField = new GridGroupByField();
            gridGroupByField.FieldName = sGroupBy;
            gridGroupByField.HeaderText = sGroupBy;
            gridGroupByField.HeaderValueSeparator = &quot; for current group: &quot;;
            gridGroupByField.FormatString = &quot;&lt;strong&gt;{0}&lt;/strong&gt;&quot;;
            expression.SelectFields.Add(gridGroupByField);
            expression.GroupByFields.Add(gridGroupByField);
            mwGrid.MasterTableView.GroupByExpressions.Add(expression);
        }

        public override void OnInit()
        {
            FormTableName = xmlModel.form.TableName;
            var e = new XmlFormArgs();
            if (listManagerModel != null)
                listManagerModel.OnInit(this, e);

            RegisterJavaScriptFiles();

            base.OnInit();
        }

        public override void OnPreRender()
        {
            ProcessPictureTakerControls();

            var e = new XmlFormArgs();
            if (listManagerModel != null) listManagerModel.OnPreRender(this, e);

            base.OnPreRender();
        }

        public override void FormatColumns(RadGrid grid)
        {
            if (listManagerModel != null) listManagerModel.FormatColumns(this, grid);

            base.FormatColumns(grid);
        }

        private void ProcessPictureTakerControls()
        {
            foreach (var col in listCols)
            {
                var ctrl = xmlModel.form.GetControl(col);
                if (ctrl != null &amp;&amp; ctrl.Type == Brix.Platform.BusinessLayer.XMLForm.ControlType.PictureTaker)
                {
                    foreach (var gridCol in mwGrid.MasterTableView.AutoGeneratedColumns)
                        if (gridCol.UniqueName.Contains(ctrl.Name))
                            gridCol.Visible = false;

                    var page = HttpContext.Current.Handler as System.Web.UI.Page;
                    if (page == null)
                        return;

                    GridImageColumn myCol = null;
                    if (!page.IsPostBack)
                    {
                        myCol = new GridImageColumn();
                        mwGrid.MasterTableView.Columns.Add(myCol);
                    }
                    else
                        myCol = mwGrid.MasterTableView.GetColumnSafe(ctrl.Name + &quot;_Image&quot;) as GridImageColumn;
                    if (myCol != null)
                    {
                        myCol.HeaderStyle.Width = new Unit(100, UnitType.Pixel);
                        myCol.UniqueName = ctrl.Name + &quot;_Image&quot;;
                        myCol.AlternateText = &quot;Picture&quot;;
                        myCol.DataImageUrlFields = new[] { ctrl.Name };
                        myCol.HeaderText = !string.IsNullOrWhiteSpace(ctrl.Caption) ? ctrl.Caption : ctrl.Name;
                        myCol.ImageWidth = new Unit(80, UnitType.Pixel);
                        myCol.ImageHeight = new Unit(100, UnitType.Pixel);
                        myCol.ImageAlign = ImageAlign.Middle;
                        myCol.AllowFiltering = false;
                        myCol.AllowSorting = false;
                    }
                }
            }
        }

        public override void HandleDataFromWorkFlow()
        {
            var e = new XmlFormArgs();
            if (listManagerModel != null) listManagerModel.HandleDataFromWorkFlow(this, e);
            base.HandleDataFromWorkFlow();
        }

        private void RegisterJavaScriptFiles()
        {
            if (xmlModel != null &amp;&amp; xmlModel.form != null &amp;&amp; !string.IsNullOrEmpty(xmlModel.form.ListPageScriptFiles) &amp;&amp;
                HttpContext.Current.Handler is System.Web.UI.Page)
            {
                System.Web.UI.Page callingPage = HttpContext.Current.Handler as System.Web.UI.Page;

                xmlModel.form.ListPageScriptFiles.Split(&quot;,&quot;.ToCharArray(), StringSplitOptions.RemoveEmptyEntries).ForEach(scriptFile =&gt;
                {
                    callingPage.ClientScript.RegisterClientScriptInclude(Guid.NewGuid().ToString(), VirtualPathUtility.ToAbsolute(scriptFile));
                });

            }
        }

#pragma warning disable 0649
        class PDFAttachmentDetails
        {
            public int Number;
            public string Name;
            public int PageCount;
            public int StartPage;
            public int EndPage;
        }
#pragma warning restore 0649
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[49,9,49,62,1],[50,9,50,45,1],[52,9,52,52,1],[53,37,53,41,1],[53,42,53,46,0],[56,9,56,10,1],[57,13,57,42,1],[58,17,58,76,1],[60,13,60,33,1],[62,9,62,10,1],[66,13,66,14,1],[67,17,67,54,1],[68,21,68,117,1],[70,17,70,49,1],[71,13,71,14,1],[76,17,76,18,0],[76,19,76,42,0],[76,43,76,44,0],[77,17,77,18,0],[77,19,77,43,0],[77,44,77,45,0],[80,39,80,43,1],[80,44,80,48,1],[85,13,85,14,1],[86,17,86,77,1],[87,21,87,52,0],[88,22,88,127,1],[89,21,89,52,1],[91,21,91,86,1],[92,13,92,14,1],[98,13,98,14,0],[99,17,99,113,0],[100,21,100,93,0],[102,21,102,41,0],[103,13,103,14,0],[109,13,109,14,0],[110,17,110,92,0],[111,17,111,83,0],[112,17,112,69,0],[113,21,113,61,0],[115,17,115,18,0],[116,21,116,98,0],[118,13,118,14,0],[120,13,120,14,0],[121,17,121,92,0],[122,17,122,83,0],[123,17,123,65,0],[124,13,124,14,0],[129,17,129,18,1],[129,19,129,112,1],[129,113,129,114,1],[134,17,134,18,1],[134,19,134,55,1],[134,56,134,57,1],[140,13,140,14,1],[141,17,141,46,1],[142,21,142,78,1],[144,21,144,51,1],[145,13,145,14,1],[151,13,151,14,1],[152,17,152,46,1],[153,21,153,81,1],[155,21,155,54,1],[156,13,156,14,1],[162,13,162,14,1],[163,17,163,46,1],[164,21,164,63,1],[166,21,166,51,1],[167,13,167,14,1],[173,13,173,14,0],[174,17,174,77,0],[175,21,175,51,0],[177,17,177,53,0],[178,13,178,14,0],[186,13,186,14,0],[187,17,187,92,0],[188,17,188,71,0],[189,17,189,75,0],[191,17,191,50,0],[192,17,192,62,0],[192,62,192,86,1],[192,86,192,88,0],[192,17,192,88,0],[193,17,193,40,0],[194,17,194,18,0],[195,21,195,62,0],[196,21,196,48,0],[197,17,197,18,0],[209,17,209,131,0],[210,21,210,97,0],[212,17,212,35,0],[213,21,213,106,0],[218,17,223,118,0],[225,17,225,52,0],[226,17,226,18,0],[228,21,228,107,0],[228,107,228,127,1],[228,127,228,129,0],[228,21,228,129,0],[229,21,229,45,0],[230,21,230,22,0],[231,25,231,119,0],[232,25,232,26,0],[233,29,233,151,0],[234,25,234,26,0],[235,21,235,22,0],[236,17,236,18,0],[238,17,238,92,0],[239,17,239,18,0],[240,21,242,25,0],[242,25,242,26,1],[242,26,243,29,0],[243,29,243,68,1],[243,68,243,87,1],[243,87,243,89,1],[243,29,243,89,1],[243,89,244,29,0],[244,29,244,47,1],[244,47,245,29,0],[245,29,245,30,1],[245,30,246,33,0],[246,33,246,65,1],[246,65,247,33,0],[247,33,247,55,1],[247,55,248,29,0],[248,29,248,30,1],[248,30,250,29,0],[250,29,250,67,1],[250,67,251,29,0],[251,29,251,36,1],[251,36,251,38,0],[251,38,251,49,1],[251,49,251,50,0],[251,50,251,52,1],[251,52,251,53,0],[251,53,251,58,1],[251,58,252,29,0],[252,29,252,30,1],[252,30,253,33,0],[253,33,253,72,1],[253,72,255,33,0],[255,33,255,76,1],[255,76,256,37,0],[256,37,258,69,1],[258,69,259,38,0],[259,38,259,78,1],[259,78,260,37,0],[260,37,262,69,1],[262,69,263,38,0],[263,38,263,74,0],[263,74,264,37,0],[264,37,266,69,0],[266,69,267,29,0],[267,29,267,30,1],[267,30,268,25,0],[268,25,268,26,1],[268,26,269,27,0],[240,21,269,27,0],[270,17,270,18,0],[271,17,271,46,0],[271,47,271,97,0],[273,17,273,35,0],[274,13,274,14,0],[278,9,278,10,1],[279,13,279,62,1],[280,13,280,42,1],[280,43,280,101,1],[281,9,281,10,1],[284,9,284,10,1],[285,13,285,42,1],[285,43,285,96,1],[287,13,287,70,1],[288,13,288,14,0],[289,17,294,101,0],[295,13,295,14,0],[296,13,296,75,1],[297,13,297,14,0],[298,17,303,106,0],[304,17,304,104,0],[305,13,305,14,0],[306,13,306,63,1],[307,13,307,14,0],[308,17,313,104,0],[314,13,314,14,0],[315,13,315,48,1],[316,9,316,10,1],[319,9,319,10,0],[320,13,320,34,0],[321,13,321,14,0],[322,17,322,36,0],[323,17,323,49,0],[324,17,324,82,0],[325,21,325,52,0],[327,17,327,84,0],[333,17,333,104,0],[334,17,334,93,0],[336,17,336,115,0],[338,17,338,59,0],[339,21,339,67,0],[341,17,341,86,0],[342,17,342,64,0],[343,17,343,113,0],[345,17,345,64,0],[346,17,346,18,0],[347,21,347,61,0],[348,17,348,18,0],[350,17,350,59,0],[351,21,351,58,0],[352,13,352,14,0],[353,9,353,10,0],[356,9,356,10,0],[357,13,357,110,0],[358,13,359,82,0],[361,13,361,20,0],[361,22,361,54,0],[361,55,361,57,0],[361,58,361,68,0],[362,13,362,14,0],[364,17,364,114,0],[365,17,365,18,0],[366,21,366,71,0],[367,21,367,22,0],[368,25,368,85,0],[369,21,369,22,0],[370,26,370,70,0],[371,21,371,22,0],[372,25,372,62,0],[373,25,373,61,0],[374,25,374,26,0],[375,29,375,76,0],[376,25,376,26,0],[377,21,377,22,0],[379,21,379,22,0],[380,25,380,83,0],[381,25,381,65,0],[382,29,382,80,0],[383,21,383,22,0],[384,17,384,18,0],[385,13,385,14,0],[387,13,387,83,0],[388,13,388,106,0],[389,9,389,10,0],[392,9,392,10,0],[394,13,394,63,0],[395,13,395,48,0],[396,13,396,14,0],[397,17,398,118,0],[399,17,399,45,0],[400,21,400,53,0],[401,13,401,14,0],[403,13,404,13,0],[404,13,404,14,0],[404,14,405,17,0],[405,17,405,98,0],[405,98,406,17,0],[406,17,406,18,0],[406,18,407,21,0],[407,21,407,56,0],[407,56,408,21,0],[408,21,408,22,0],[408,22,410,25,0],[410,25,410,85,0],[410,85,411,25,0],[411,25,411,32,0],[411,32,411,34,0],[411,34,411,45,0],[411,45,411,46,0],[411,46,411,48,0],[411,48,411,49,0],[411,49,411,56,0],[411,56,412,25,0],[412,25,412,26,0],[412,26,413,29,0],[413,29,416,81,0],[416,81,417,29,0],[417,29,417,60,0],[417,60,418,33,0],[418,33,418,68,0],[418,68,419,25,0],[419,25,419,26,0],[419,26,420,21,0],[420,21,420,22,0],[420,22,421,26,0],[421,26,421,57,0],[421,57,422,21,0],[422,21,422,22,0],[422,22,423,25,0],[423,25,425,75,0],[425,75,426,25,0],[426,25,426,56,0],[426,56,427,29,0],[427,29,427,64,0],[427,64,428,21,0],[428,21,428,22,0],[428,22,429,17,0],[429,17,429,18,0],[429,18,430,13,0],[430,13,430,14,0],[430,14,430,16,0],[403,13,430,16,0],[432,18,432,27,0],[432,29,432,44,0],[432,46,432,49,0],[433,13,433,14,0],[434,17,434,57,0],[435,17,435,18,0],[436,21,437,127,0],[438,21,439,119,0],[440,17,440,18,0],[441,13,441,14,0],[442,9,442,10,0],[445,9,445,10,0],[446,13,446,39,0],[448,13,448,14,0],[449,17,449,90,0],[451,17,451,45,0],[453,17,453,91,0],[454,24,454,56,0],[455,17,455,18,0],[456,21,456,31,0],[457,21,457,28,0],[457,30,457,45,0],[457,46,457,48,0],[457,49,457,58,0],[458,21,458,22,0],[460,25,460,26,0],[461,36,461,104,0],[462,36,462,64,0],[463,29,463,30,0],[464,33,464,63,0],[465,33,465,73,0],[466,33,466,114,0],[468,33,468,80,0],[470,33,470,43,0],[471,33,471,34,0],[472,37,473,83,0],[474,37,474,77,0],[475,37,475,95,0],[476,37,476,85,0],[477,33,477,34,0],[479,33,479,92,0],[482,33,482,68,0],[483,29,483,30,0],[484,25,484,26,0],[485,25,485,42,0],[486,25,486,26,0],[487,25,487,26,0],[488,25,488,29,0],[489,21,489,22,0],[492,21,492,22,0],[493,25,493,51,0],[494,25,494,26,0],[495,29,495,75,0],[497,29,498,101,0],[499,33,499,78,0],[501,36,501,76,0],[503,36,503,78,0],[505,29,505,30,0],[506,33,506,50,0],[507,33,507,44,0],[508,33,508,39,0],[511,33,512,123,0],[513,33,513,63,0],[514,33,514,84,0],[515,33,515,99,0],[516,33,516,69,0],[517,33,517,63,0],[518,33,518,77,0],[519,33,519,73,0],[521,33,521,101,0],[522,33,522,67,0],[524,33,524,40,0],[524,42,524,65,0],[524,66,524,68,0],[524,69,524,80,0],[525,33,525,34,0],[526,37,526,120,0],[527,37,529,112,0],[530,37,530,66,0],[532,37,532,88,0],[534,37,534,70,0],[535,37,535,81,0],[536,37,536,72,0],[537,37,537,66,0],[539,37,539,81,0],[542,37,542,77,0],[543,37,543,41,0],[545,37,545,98,0],[546,37,546,78,0],[548,37,549,114,0],[550,37,550,81,0],[554,33,554,34,0],[555,33,555,46,0],[557,33,557,108,0],[559,33,560,113,0],[561,33,561,63,0],[562,29,562,30,0],[563,25,563,26,0],[567,25,568,105,0],[569,25,569,87,0],[570,25,570,26,0],[572,29,572,30,0],[573,33,575,104,0],[577,33,577,112,0],[578,33,578,53,0],[579,33,579,34,0],[580,37,580,103,0],[581,37,581,111,0],[582,33,582,34,0],[583,29,583,30,0],[584,29,584,34,0],[585,29,585,30,0],[587,29,587,30,0],[588,25,588,26,0],[589,25,589,89,0],[590,21,590,22,0],[591,21,591,26,0],[592,21,592,22,0],[593,21,593,22,0],[594,17,594,18,0],[595,13,595,14,0],[596,13,596,30,0],[597,13,597,14,0],[598,13,598,14,0],[600,13,600,34,0],[601,9,601,10,0],[604,9,604,10,0],[605,20,605,56,0],[606,13,606,14,0],[607,17,607,46,0],[608,17,608,56,0],[609,22,609,65,0],[609,67,609,80,0],[609,82,609,92,0],[610,17,610,18,0],[611,21,611,51,0],[612,17,612,18,0],[614,17,614,76,0],[615,22,615,31,0],[615,33,615,58,0],[615,60,615,63,0],[616,17,616,18,0],[617,21,617,79,0],[618,17,618,18,0],[619,13,619,14,0],[620,9,620,10,0],[623,9,623,10,0],[624,13,624,63,0],[625,13,625,61,0],[626,13,626,70,0],[627,13,627,42,0],[628,13,628,14,0],[629,17,629,78,0],[630,13,630,14,0],[632,13,632,101,0],[633,20,633,120,0],[634,13,634,14,0],[635,17,635,46,0],[636,17,636,40,0],[637,17,637,18,0],[639,21,639,49,0],[640,21,640,59,0],[641,21,641,68,0],[642,21,642,38,0],[644,21,644,56,0],[645,17,645,18,0],[646,13,646,14,0],[648,13,648,28,0],[649,13,649,50,0],[650,13,650,65,0],[652,13,652,71,0],[653,9,653,10,0],[656,9,656,10,1],[657,13,657,34,1],[658,13,658,14,1],[659,17,659,46,1],[659,47,659,108,1],[661,17,661,49,1],[662,17,662,18,1],[663,21,663,115,1],[664,21,664,22,0],[665,25,665,47,0],[666,21,666,22,0],[667,17,667,18,1],[669,17,669,18,0],[670,21,672,99,0],[673,21,673,22,0],[674,25,674,47,0],[675,21,675,22,0],[676,17,676,18,0],[678,17,678,38,1],[679,17,679,43,1],[680,17,680,45,1],[682,17,682,43,1],[683,17,683,18,1],[685,21,685,51,1],[688,21,688,99,1],[690,21,690,52,1],[691,21,691,70,1],[692,21,692,85,1],[695,21,695,85,1],[698,21,698,103,1],[706,21,706,28,1],[706,30,706,38,0],[706,39,706,41,1],[706,42,706,77,1],[707,21,707,22,0],[708,25,708,125,0],[709,21,709,22,0],[710,21,710,85,1],[711,17,711,18,1],[713,17,713,68,1],[714,17,714,18,0],[715,21,717,59,0],[718,17,718,18,0],[720,17,720,18,1],[721,21,721,92,1],[722,21,722,68,1],[723,17,723,18,1],[725,17,725,146,1],[727,21,727,47,1],[729,17,729,55,1],[730,17,730,57,1],[731,17,731,57,1],[732,17,732,61,1],[735,17,735,68,1],[736,17,736,18,0],[737,21,740,55,0],[741,17,741,18,0],[743,17,743,108,1],[744,21,744,44,1],[746,17,746,84,1],[748,17,748,82,1],[749,17,749,18,1],[750,21,755,118,1],[757,21,757,124,1],[758,21,758,22,1],[759,25,759,75,1],[760,21,760,22,1],[762,17,762,18,1],[764,17,764,46,1],[764,47,764,107,1],[767,17,767,47,1],[768,17,768,18,0],[769,21,769,40,0],[770,17,770,18,0],[772,17,772,67,1],[773,17,773,18,0],[774,21,774,42,0],[775,17,775,18,0],[776,13,776,14,1],[777,9,777,10,1],[780,9,780,10,1],[781,25,781,47,1],[782,13,782,30,1],[788,13,788,20,1],[788,22,788,36,1],[788,37,788,39,1],[788,40,788,60,1],[788,60,788,75,1],[788,75,788,76,1],[788,40,788,76,1],[789,13,789,14,1],[790,17,790,72,1],[790,72,790,108,1],[790,108,790,110,1],[790,17,790,110,1],[791,17,791,39,1],[792,17,792,18,1],[793,21,793,103,1],[794,21,794,44,1],[795,21,795,22,1],[796,25,796,86,1],[797,25,797,66,1],[799,25,799,106,1],[800,21,800,22,1],[801,17,801,18,1],[802,13,802,14,1],[803,9,803,10,1],[808,13,808,14,1],[809,17,814,80,1],[815,13,815,14,1],[818,9,818,10,1],[819,13,819,30,1],[820,17,820,54,1],[822,13,822,29,1],[823,17,823,52,1],[825,13,825,20,1],[825,22,825,45,1],[825,46,825,48,1],[825,49,825,61,1],[826,17,826,59,1],[827,9,827,10,1],[830,9,830,10,1],[831,13,831,20,1],[831,22,831,32,1],[831,33,831,35,1],[831,36,831,47,1],[832,13,832,14,1],[833,17,833,43,1],[834,17,834,18,0],[835,21,835,28,0],[835,30,835,46,0],[835,47,835,49,0],[835,50,835,61,0],[836,21,836,22,0],[838,25,838,53,0],[839,21,839,22,0],[840,17,840,18,0],[842,17,842,18,1],[844,21,844,44,1],[845,17,845,18,1],[846,13,846,14,1],[847,9,847,10,1],[850,9,850,10,1],[851,13,851,20,1],[851,22,851,33,1],[851,34,851,36,1],[851,37,851,49,1],[852,13,852,14,1],[853,17,853,43,1],[854,17,854,18,1],[855,21,855,28,1],[855,30,855,46,1],[855,47,855,49,1],[855,50,855,61,1],[856,21,856,22,1],[858,25,858,53,1],[859,21,859,22,1],[860,17,860,18,1],[862,17,862,18,1],[864,21,864,44,1],[865,17,865,18,1],[866,13,866,14,1],[867,9,867,10,1],[870,9,870,10,0],[871,25,871,53,0],[872,13,872,30,0],[873,13,873,37,0],[873,39,873,55,0],[875,13,875,27,0],[876,13,876,40,0],[877,17,877,54,0],[879,17,879,44,0],[881,13,881,44,0],[883,13,883,91,0],[885,13,885,60,0],[886,13,886,14,0],[887,17,887,48,0],[887,49,887,65,0],[889,21,889,38,0],[890,13,890,14,0],[892,13,892,14,0],[894,17,894,48,0],[894,49,894,66,0],[896,21,896,37,0],[897,13,897,14,0],[898,13,900,80,0],[902,13,902,99,0],[903,13,903,14,0],[904,17,904,33,0],[905,13,905,14,0],[907,13,907,126,0],[908,9,908,10,0],[911,9,911,10,1],[912,9,912,10,1],[915,9,915,10,1],[916,13,916,39,1],[917,13,917,51,1],[918,13,918,42,1],[918,43,918,93,1],[919,13,919,59,1],[920,13,920,14,1],[921,17,921,43,1],[922,17,923,99,1],[924,17,924,58,1],[925,17,925,59,1],[925,60,925,110,1],[926,17,926,57,1],[926,58,926,104,0],[927,17,927,69,1],[928,21,928,91,0],[929,17,929,61,1],[929,62,929,116,0],[930,17,930,61,1],[931,21,931,50,1],[932,13,932,14,0],[933,9,933,10,0],[936,9,936,10,1],[937,9,937,10,1],[940,9,940,10,1],[941,13,941,37,1],[942,13,942,73,1],[943,13,943,56,1],[944,13,944,14,1],[945,17,945,74,1],[946,17,946,64,1],[947,17,947,73,1],[949,17,949,45,1],[950,17,950,75,1],[951,17,951,24,1],[951,26,951,38,1],[951,39,951,41,1],[951,42,951,48,1],[952,17,952,18,1],[956,21,956,35,1],[959,21,959,42,1],[960,21,960,22,0],[962,25,962,115,0],[963,25,963,49,0],[964,25,964,26,0],[965,29,965,61,0],[966,29,966,53,0],[967,33,967,49,0],[968,25,968,26,0],[969,21,969,22,0],[971,21,971,115,1],[972,21,972,45,1],[973,21,973,22,1],[974,25,974,54,1],[975,25,975,49,1],[976,29,976,52,1],[978,25,978,64,1],[979,25,979,49,1],[980,29,980,60,1],[982,25,985,84,1],[986,21,986,22,1],[987,17,987,18,1],[989,17,989,50,1],[990,21,990,67,1],[992,17,992,50,1],[993,17,993,18,1],[994,21,994,91,1],[995,21,995,120,1],[996,21,996,22,1],[997,25,997,103,1],[998,25,998,54,1],[1000,25,1000,32,1],[1000,34,1000,45,1],[1000,46,1000,48,1],[1000,49,1000,76,1],[1001,25,1001,26,1],[1002,29,1002,63,1],[1004,29,1004,72,1],[1005,29,1005,30,0],[1006,33,1006,49,0],[1007,37,1007,55,0],[1008,33,1008,95,0],[1009,33,1009,34,0],[1010,37,1010,114,0],[1011,41,1011,102,0],[1012,33,1012,34,0],[1013,29,1013,30,0],[1014,25,1014,26,1],[1015,25,1015,58,1],[1016,25,1016,66,1],[1017,25,1017,59,1],[1018,29,1018,95,1],[1019,25,1019,60,1],[1020,21,1020,22,1],[1021,17,1021,18,1],[1022,13,1022,14,1],[1023,13,1023,31,1],[1024,9,1024,10,1],[1027,9,1027,10,1],[1028,13,1028,39,1],[1029,13,1029,51,1],[1030,13,1031,30,1],[1034,13,1034,48,1],[1035,13,1035,76,1],[1036,17,1036,51,0],[1038,13,1038,42,1],[1038,43,1038,95,1],[1039,13,1039,59,1],[1040,13,1040,14,1],[1041,17,1041,51,1],[1042,17,1042,92,1],[1043,21,1043,47,1],[1045,17,1045,18,0],[1046,21,1046,72,0],[1047,21,1047,114,0],[1048,21,1048,70,0],[1049,21,1049,49,0],[1050,21,1050,28,0],[1050,30,1050,40,0],[1050,41,1050,43,0],[1050,44,1050,49,0],[1051,21,1051,22,0],[1052,25,1052,58,0],[1052,59,1052,104,0],[1053,21,1053,22,0],[1055,21,1055,28,0],[1055,30,1055,39,0],[1055,40,1055,42,0],[1055,43,1055,49,0],[1056,21,1056,22,0],[1057,25,1057,70,0],[1057,71,1057,95,0],[1058,21,1058,22,0],[1060,21,1060,73,0],[1061,21,1061,22,0],[1062,25,1062,93,0],[1063,25,1065,35,0],[1066,21,1066,22,0],[1067,17,1067,18,0],[1080,17,1080,24,1],[1080,26,1080,44,1],[1080,45,1080,47,1],[1080,48,1080,72,1],[1081,17,1081,18,1],[1082,21,1082,58,1],[1083,17,1083,18,1],[1085,17,1085,52,1],[1086,17,1086,18,1],[1087,21,1087,79,1],[1088,21,1088,28,1],[1088,30,1088,39,1],[1088,40,1088,42,1],[1088,43,1088,46,1],[1089,25,1090,102,1],[1091,17,1091,18,1],[1092,17,1092,34,1],[1094,17,1094,18,1],[1095,21,1096,159,1],[1097,17,1097,18,1],[1098,17,1098,37,0],[1099,17,1099,18,0],[1100,21,1100,110,0],[1101,25,1101,115,0],[1102,21,1102,30,0],[1104,17,1104,82,1],[1105,17,1105,46,1],[1105,47,1105,98,1],[1106,17,1106,59,1],[1107,21,1107,37,1],[1109,21,1109,57,0],[1111,18,1111,79,1],[1112,17,1112,53,1],[1114,17,1114,26,1],[1115,9,1115,10,1],[1118,9,1118,10,1],[1119,13,1119,69,1],[1120,13,1120,14,1],[1121,17,1121,44,1],[1122,13,1122,14,1],[1124,13,1124,14,1],[1125,17,1125,24,1],[1125,26,1125,45,1],[1125,46,1125,48,1],[1125,49,1125,61,1],[1126,17,1126,18,1],[1127,21,1127,59,1],[1128,17,1128,18,1],[1129,13,1129,14,1],[1130,9,1130,10,1],[1133,9,1133,10,0],[1134,13,1134,55,0],[1135,13,1136,13,0],[1136,13,1136,14,0],[1136,14,1137,17,0],[1137,17,1137,62,0],[1137,62,1138,17,0],[1138,17,1138,79,0],[1138,79,1140,17,0],[1140,17,1140,24,0],[1140,24,1140,26,0],[1140,26,1140,41,0],[1140,41,1140,42,0],[1140,42,1140,44,0],[1140,44,1140,45,0],[1140,45,1140,54,0],[1140,54,1141,17,0],[1141,17,1141,18,0],[1141,18,1142,21,0],[1142,21,1142,104,0],[1142,104,1143,21,0],[1143,21,1143,61,0],[1143,61,1143,62,0],[1143,62,1143,71,0],[1143,71,1145,21,0],[1145,21,1145,162,0],[1145,162,1146,21,0],[1146,21,1146,42,0],[1146,42,1147,21,0],[1147,21,1147,22,0],[1147,22,1148,25,0],[1148,25,1148,155,0],[1148,155,1149,25,0],[1149,25,1149,32,0],[1149,32,1149,34,0],[1149,34,1149,53,0],[1149,53,1149,54,0],[1149,54,1149,56,0],[1149,56,1149,57,0],[1149,57,1149,78,0],[1149,78,1150,25,0],[1150,25,1150,26,0],[1150,26,1151,29,0],[1151,29,1151,79,0],[1151,79,1152,25,0],[1152,25,1152,26,0],[1152,26,1153,21,0],[1153,21,1153,22,0],[1153,22,1154,17,0],[1154,17,1154,18,0],[1154,18,1156,13,0],[1156,13,1156,14,0],[1156,14,1156,16,0],[1135,13,1156,16,0],[1157,9,1157,10,0],[1160,9,1160,10,1],[1161,13,1161,45,1],[1162,13,1162,61,1],[1163,13,1163,46,1],[1165,13,1165,29,1],[1166,17,1166,24,1],[1166,26,1166,37,1],[1166,38,1166,40,1],[1166,41,1166,44,1],[1167,17,1167,18,1],[1168,21,1168,108,1],[1169,21,1169,22,1],[1170,25,1170,46,1],[1171,25,1171,31,1],[1173,17,1173,18,0],[1174,13,1174,51,1],[1175,17,1175,122,1],[1176,9,1176,10,1],[1179,9,1179,10,0],[1180,13,1180,80,0],[1181,9,1181,10,0],[1184,9,1184,10,1],[1185,13,1185,51,1],[1186,13,1186,39,1],[1187,13,1187,116,1],[1188,13,1188,14,1],[1189,17,1189,84,1],[1191,17,1191,36,1],[1192,17,1192,18,1],[1193,21,1193,52,1],[1194,21,1194,31,1],[1196,13,1196,14,1],[1198,13,1198,59,1],[1199,13,1199,14,1],[1200,17,1200,43,1],[1201,17,1201,42,1],[1202,17,1202,18,1],[1203,21,1204,46,1],[1205,21,1205,22,1],[1206,25,1208,85,1],[1209,25,1209,74,1],[1210,25,1210,55,1],[1212,25,1212,88,1],[1213,29,1213,66,1],[1214,21,1214,22,1],[1216,21,1218,102,1],[1219,21,1219,63,1],[1219,64,1219,114,1],[1220,21,1220,61,1],[1220,62,1220,108,1],[1221,21,1221,73,1],[1222,25,1222,95,0],[1223,21,1223,46,1],[1223,47,1223,78,1],[1224,21,1224,50,1],[1225,17,1225,18,0],[1226,22,1226,81,1],[1227,17,1227,18,1],[1228,21,1228,120,1],[1229,21,1231,103,1],[1232,21,1232,46,1],[1233,21,1233,47,1],[1234,25,1234,47,1],[1235,21,1236,87,1],[1237,25,1237,97,1],[1238,21,1238,48,1],[1239,21,1239,63,1],[1239,64,1239,114,1],[1240,21,1240,61,1],[1240,62,1240,108,1],[1241,21,1241,73,1],[1242,25,1242,95,0],[1243,21,1243,51,1],[1244,25,1244,54,1],[1245,17,1245,18,0],[1246,22,1246,55,1],[1247,17,1247,18,0],[1249,21,1250,74,0],[1251,21,1251,66,0],[1252,25,1252,73,0],[1253,21,1253,79,0],[1254,21,1254,58,0],[1255,17,1255,18,0],[1276,22,1276,53,1],[1277,17,1277,18,0],[1278,21,1278,55,0],[1279,17,1279,18,0],[1280,22,1280,55,1],[1281,17,1281,18,0],[1282,21,1282,46,0],[1283,21,1283,43,0],[1284,21,1284,281,0],[1285,17,1285,18,0],[1287,21,1287,61,1],[1288,13,1288,14,0],[1290,17,1290,57,0],[1292,13,1292,23,0],[1293,9,1293,10,1],[1296,9,1296,10,1],[1297,13,1297,42,1],[1299,13,1299,39,1],[1301,13,1301,66,1],[1303,13,1303,30,1],[1305,13,1305,121,1],[1306,13,1306,14,1],[1307,17,1307,112,1],[1308,13,1308,14,1],[1310,13,1310,42,1],[1311,17,1311,100,1],[1313,13,1313,59,1],[1314,13,1314,14,1],[1315,17,1315,97,1],[1316,17,1316,18,1],[1317,21,1317,56,1],[1318,17,1318,18,1],[1319,22,1319,56,1],[1320,17,1320,18,0],[1321,21,1321,39,0],[1322,17,1322,18,0],[1323,22,1323,203,1],[1324,17,1324,18,1],[1325,21,1325,49,1],[1326,17,1326,18,1],[1328,17,1328,18,1],[1331,21,1331,58,1],[1332,17,1332,18,1],[1333,13,1333,14,1],[1335,13,1335,27,1],[1336,9,1336,10,1],[1339,9,1339,10,0],[1340,13,1340,34,0],[1341,13,1341,60,0],[1342,13,1343,13,0],[1343,13,1343,14,0],[1343,14,1344,17,0],[1344,17,1344,52,0],[1344,52,1345,21,0],[1345,21,1345,61,0],[1345,61,1346,13,0],[1346,13,1346,14,0],[1346,14,1346,16,0],[1342,13,1346,16,0],[1348,13,1350,16,0],[1350,16,1350,17,0],[1350,17,1351,20,0],[1351,20,1351,62,0],[1351,62,1352,20,0],[1352,20,1352,21,0],[1352,21,1353,24,0],[1353,24,1353,152,0],[1353,152,1354,24,0],[1354,24,1354,25,0],[1354,25,1356,28,0],[1356,28,1356,35,0],[1356,35,1356,37,0],[1356,37,1356,51,0],[1356,51,1356,52,0],[1356,52,1356,54,0],[1356,54,1357,33,0],[1357,33,1357,93,0],[1357,93,1358,28,0],[1358,28,1358,29,0],[1358,29,1359,32,0],[1359,32,1359,112,0],[1359,112,1360,32,0],[1360,32,1360,33,0],[1360,33,1361,36,0],[1361,36,1361,206,0],[1361,206,1362,32,0],[1362,32,1362,33,0],[1362,33,1363,28,0],[1363,28,1363,29,0],[1363,29,1364,24,0],[1364,24,1364,25,0],[1364,25,1365,20,0],[1365,20,1365,21,0],[1365,21,1366,16,0],[1366,16,1366,17,0],[1366,17,1366,19,0],[1348,13,1366,19,0],[1368,13,1368,65,0],[1368,65,1368,74,0],[1368,74,1368,85,0],[1368,13,1368,85,0],[1371,13,1371,42,0],[1372,17,1372,68,0],[1373,13,1373,41,0],[1374,9,1374,10,0],[1377,9,1377,10,0],[1378,13,1378,34,0],[1379,13,1379,20,0],[1379,22,1379,35,0],[1379,36,1379,38,0],[1379,39,1379,51,0],[1380,13,1380,14,0],[1381,17,1381,45,0],[1382,17,1382,18,0],[1383,21,1383,28,0],[1383,30,1383,48,0],[1383,49,1383,51,0],[1383,52,1383,65,0],[1384,25,1386,122,0],[1387,29,1387,87,0],[1388,17,1388,18,0],[1390,17,1390,18,0],[1391,21,1391,219,0],[1392,25,1392,78,0],[1393,17,1393,18,0],[1394,13,1394,14,0],[1395,9,1395,10,0],[1398,9,1398,10,1],[1399,13,1399,60,1],[1400,13,1401,13,1],[1401,13,1401,14,1],[1401,14,1402,17,1],[1402,17,1402,52,1],[1402,52,1403,21,1],[1403,21,1403,55,1],[1403,55,1404,13,1],[1404,13,1404,14,1],[1404,14,1404,16,1],[1400,13,1404,16,1],[1406,13,1406,20,1],[1406,22,1406,67,1],[1406,68,1406,70,1],[1406,71,1406,95,1],[1407,13,1407,14,1],[1408,17,1408,60,1],[1409,17,1410,63,1],[1411,21,1411,54,1],[1412,13,1412,14,1],[1414,13,1414,65,1],[1414,65,1414,74,1],[1414,74,1414,85,1],[1414,13,1414,85,1],[1417,13,1417,42,1],[1418,17,1418,68,1],[1419,13,1419,41,1],[1420,9,1420,10,1],[1423,9,1423,10,1],[1424,13,1424,20,1],[1424,22,1424,35,1],[1424,36,1424,38,1],[1424,39,1424,51,1],[1425,13,1425,14,1],[1426,17,1426,45,1],[1427,17,1427,18,1],[1428,21,1428,28,1],[1428,30,1428,48,1],[1428,49,1428,51,1],[1428,52,1428,65,1],[1429,25,1431,77,1],[1432,29,1432,60,1],[1433,17,1433,18,1],[1435,17,1435,18,1],[1436,21,1438,68,1],[1439,25,1439,51,1],[1440,17,1440,18,1],[1441,13,1441,14,1],[1442,9,1442,10,1],[1445,9,1445,10,1],[1446,13,1446,44,1],[1447,13,1447,55,1],[1448,13,1448,98,1],[1449,13,1449,117,1],[1450,13,1450,70,1],[1452,13,1452,26,1],[1453,13,1453,14,0],[1454,17,1456,117,0],[1457,21,1457,89,0],[1459,17,1459,173,0],[1461,17,1461,35,0],[1462,17,1462,18,0],[1463,21,1463,50,0],[1464,21,1464,63,0],[1465,21,1465,69,0],[1466,21,1466,73,0],[1467,21,1467,67,0],[1468,17,1468,18,0],[1470,17,1470,56,0],[1471,17,1471,18,0],[1472,21,1472,58,0],[1473,17,1473,18,0],[1474,13,1474,14,0],[1476,13,1476,31,1],[1481,21,1481,63,1],[1482,21,1482,27,1],[1484,21,1484,63,1],[1485,21,1485,27,1],[1487,21,1487,63,1],[1488,21,1488,27,1],[1490,21,1490,67,1],[1491,21,1491,71,1],[1492,21,1492,49,1],[1493,21,1493,50,1],[1494,21,1494,27,1],[1496,21,1496,64,1],[1497,21,1497,65,1],[1498,21,1498,71,1],[1499,21,1499,51,1],[1500,21,1500,54,1],[1501,21,1501,65,1],[1502,21,1502,28,1],[1502,30,1502,41,1],[1502,42,1502,44,1],[1502,45,1502,54,1],[1503,21,1503,22,1],[1504,25,1504,63,1],[1505,21,1505,22,1],[1506,21,1506,27,1],[1508,21,1508,64,1],[1509,21,1509,53,1],[1510,21,1510,52,1],[1511,21,1511,59,1],[1513,21,1513,22,1],[1514,25,1514,62,1],[1515,21,1515,22,1],[1516,21,1516,38,0],[1517,21,1517,22,0],[1518,21,1518,22,0],[1519,21,1519,71,1],[1520,21,1520,28,1],[1520,30,1520,41,1],[1520,42,1520,44,1],[1520,45,1520,54,1],[1521,21,1521,22,1],[1522,25,1522,63,1],[1523,21,1523,22,1],[1525,21,1525,27,1],[1527,13,1527,33,1],[1527,34,1527,66,1],[1528,9,1528,10,1],[1531,9,1531,10,1],[1532,13,1532,29,1],[1533,17,1533,48,1],[1534,9,1534,10,0],[1538,9,1538,10,1],[1539,13,1539,99,1],[1541,13,1541,80,1],[1542,17,1542,69,0],[1544,13,1544,23,1],[1547,13,1547,58,1],[1549,13,1549,76,1],[1550,13,1550,35,1],[1551,13,1551,14,1],[1552,17,1552,63,1],[1553,17,1553,24,1],[1553,26,1553,48,1],[1553,49,1553,51,1],[1553,52,1553,59,1],[1554,21,1554,94,1],[1555,13,1555,14,1],[1556,13,1556,63,1],[1558,13,1558,39,1],[1559,13,1559,42,1],[1560,17,1560,82,1],[1563,13,1563,40,1],[1564,13,1564,39,1],[1567,13,1567,42,1],[1568,17,1568,60,1],[1570,13,1570,110,1],[1572,13,1572,64,1],[1573,13,1573,14,0],[1575,17,1576,68,0],[1577,13,1577,14,0],[1579,13,1579,14,1],[1584,17,1588,81,1],[1589,13,1589,14,1],[1592,13,1592,107,1],[1607,13,1607,42,1],[1608,17,1608,68,1],[1609,13,1609,23,1],[1610,9,1610,10,1],[1613,9,1613,10,0],[1614,13,1614,58,0],[1615,13,1615,43,0],[1616,13,1616,14,0],[1617,17,1617,44,0],[1618,17,1618,47,0],[1619,17,1620,92,0],[1621,17,1623,21,0],[1623,21,1623,22,0],[1623,22,1624,25,0],[1624,25,1624,92,0],[1624,92,1625,25,0],[1625,25,1625,26,0],[1625,26,1626,29,0],[1626,29,1626,45,0],[1626,45,1627,25,0],[1627,25,1627,26,0],[1627,26,1628,25,0],[1628,25,1628,47,0],[1628,47,1629,29,0],[1629,29,1629,71,0],[1629,71,1630,33,0],[1630,33,1630,52,0],[1630,52,1631,21,0],[1631,21,1631,22,0],[1631,22,1631,24,0],[1621,17,1631,24,0],[1633,17,1633,40,0],[1634,17,1634,18,0],[1635,21,1635,91,0],[1637,21,1637,72,0],[1638,21,1638,22,0],[1639,25,1642,83,0],[1643,25,1643,80,0],[1644,25,1644,60,0],[1645,29,1645,72,0],[1646,25,1646,59,0],[1647,29,1647,82,0],[1648,21,1648,22,0],[1650,25,1650,94,0],[1652,21,1652,81,0],[1654,21,1654,64,0],[1655,21,1655,63,0],[1657,21,1657,59,0],[1658,21,1658,22,0],[1659,25,1659,32,0],[1659,34,1659,44,0],[1659,45,1659,47,0],[1659,48,1659,65,0],[1660,25,1660,26,0],[1661,29,1661,74,0],[1662,29,1662,84,0],[1663,29,1663,30,0],[1664,33,1665,76,0],[1666,33,1666,56,0],[1667,33,1667,34,0],[1668,37,1668,95,0],[1670,37,1670,108,0],[1673,37,1673,78,0],[1674,37,1674,44,0],[1674,46,1674,63,0],[1674,64,1674,66,0],[1674,67,1674,87,0],[1675,37,1675,38,0],[1676,41,1676,79,0],[1677,41,1677,94,0],[1678,41,1678,113,0],[1679,41,1679,42,0],[1680,45,1680,99,0],[1681,45,1682,110,0],[1683,45,1683,46,0],[1684,49,1684,87,0],[1685,49,1685,86,0],[1686,49,1686,56,0],[1686,58,1686,69,0],[1686,70,1686,72,0],[1686,73,1686,82,0],[1687,49,1687,50,0],[1688,53,1688,81,0],[1689,53,1689,54,0],[1690,57,1690,79,0],[1691,57,1691,63,0],[1693,49,1693,50,0],[1694,45,1694,46,0],[1695,45,1699,62,0],[1700,41,1700,42,0],[1701,37,1701,38,0],[1703,37,1703,63,0],[1704,37,1706,118,0],[1707,37,1707,94,0],[1708,37,1708,79,0],[1709,41,1709,91,0],[1710,37,1710,77,0],[1711,41,1711,87,0],[1712,37,1712,89,0],[1713,41,1713,111,0],[1715,37,1716,110,0],[1717,37,1717,91,0],[1718,37,1718,91,0],[1720,37,1720,83,0],[1721,37,1721,116,0],[1722,37,1722,56,0],[1724,42,1724,51,0],[1724,53,1724,102,0],[1724,104,1724,107,0],[1725,37,1725,38,0],[1726,41,1726,116,0],[1728,41,1728,75,0],[1729,45,1729,115,0],[1731,45,1732,75,0],[1733,37,1733,38,0],[1735,37,1735,71,0],[1736,33,1736,34,0],[1737,29,1737,30,0],[1738,25,1738,26,0],[1739,21,1739,22,0],[1741,21,1741,61,0],[1742,21,1742,62,0],[1743,17,1743,18,0],[1744,17,1744,68,0],[1745,17,1745,18,0],[1746,21,1749,72,0],[1750,21,1750,76,0],[1751,21,1751,56,0],[1752,25,1752,42,0],[1754,21,1754,51,0],[1756,21,1756,81,0],[1757,21,1757,59,0],[1758,21,1758,22,0],[1759,25,1759,32,0],[1759,34,1759,45,0],[1759,46,1759,48,0],[1759,49,1759,66,0],[1760,25,1760,26,0],[1761,29,1761,75,0],[1762,29,1765,100,0],[1766,29,1766,48,0],[1767,25,1767,26,0],[1769,25,1769,56,0],[1770,25,1770,49,0],[1771,21,1771,22,0],[1772,17,1772,18,0],[1773,22,1773,48,0],[1774,17,1774,18,0],[1775,17,1775,18,0],[1776,13,1776,14,0],[1777,13,1777,31,0],[1778,9,1778,10,0],[1781,9,1781,10,0],[1783,13,1796,15,0],[1797,13,1797,53,0],[1798,13,1798,14,0],[1799,17,1799,24,0],[1799,26,1799,38,0],[1799,39,1799,41,0],[1799,42,1799,53,0],[1800,17,1800,18,0],[1801,21,1801,54,0],[1802,21,1802,22,0],[1803,25,1803,59,0],[1804,25,1804,31,0],[1806,17,1806,18,0],[1807,13,1807,14,0],[1809,13,1809,43,0],[1810,9,1810,10,0],[1828,9,1828,10,0],[1829,13,1829,66,0],[1830,9,1830,10,0],[1833,9,1833,10,0],[1834,13,1834,43,0],[1841,13,1841,20,0],[1841,22,1841,34,0],[1841,35,1841,37,0],[1841,38,1841,47,0],[1842,13,1842,14,0],[1843,17,1843,51,0],[1844,17,1845,74,0],[1847,17,1847,24,0],[1847,26,1847,39,0],[1847,40,1847,42,0],[1847,43,1847,53,0],[1848,17,1848,18,0],[1849,21,1849,57,0],[1850,21,1850,63,0],[1851,21,1851,22,0],[1852,25,1852,79,0],[1853,25,1854,110,0],[1855,25,1855,26,0],[1856,29,1856,95,0],[1857,29,1857,36,0],[1858,33,1858,44,0],[1858,45,1858,47,0],[1859,37,1859,116,0],[1860,29,1860,30,0],[1861,33,1861,63,0],[1862,33,1862,61,0],[1863,33,1863,34,0],[1864,37,1864,59,0],[1865,33,1865,34,0],[1866,29,1866,30,0],[1867,29,1867,63,0],[1868,29,1868,61,0],[1869,29,1869,76,0],[1870,25,1870,26,0],[1871,30,1872,111,0],[1873,25,1873,26,0],[1874,29,1874,95,0],[1875,29,1875,72,0],[1876,29,1876,36,0],[1876,38,1876,54,0],[1876,55,1876,57,0],[1876,58,1876,62,0],[1877,29,1877,30,0],[1878,33,1878,65,0],[1879,33,1879,34,0],[1880,37,1880,69,0],[1881,33,1881,34,0],[1882,29,1882,30,0],[1883,29,1883,63,0],[1884,29,1884,61,0],[1885,29,1885,76,0],[1886,25,1886,26,0],[1888,25,1888,26,0],[1889,29,1889,58,0],[1890,25,1890,26,0],[1891,21,1891,22,0],[1892,21,1892,54,0],[1893,21,1893,46,0],[1894,17,1894,18,0],[1896,17,1896,24,0],[1896,26,1896,37,0],[1896,38,1896,40,0],[1896,41,1896,48,0],[1897,17,1897,18,0],[1898,21,1898,53,0],[1899,21,1899,28,0],[1899,30,1899,43,0],[1899,44,1899,46,0],[1899,47,1899,57,0],[1900,21,1900,22,0],[1901,25,1901,79,0],[1903,25,1903,150,0],[1904,25,1904,26,0],[1905,29,1905,76,0],[1906,29,1906,55,0],[1907,29,1907,30,0],[1908,33,1908,97,0],[1909,33,1909,67,0],[1909,69,1909,96,0],[1909,98,1909,129,0],[1909,131,1909,164,0],[1910,33,1910,115,0],[1912,33,1912,61,0],[1913,33,1913,34,0],[1915,37,1915,213,0],[1916,37,1916,77,0],[1917,37,1917,38,0],[1918,41,1918,74,0],[1919,45,1919,105,0],[1920,37,1920,38,0],[1921,33,1921,34,0],[1923,33,1923,34,0],[1925,37,1925,85,0],[1926,37,1926,38,0],[1927,41,1927,229,0],[1928,41,1928,113,0],[1929,41,1929,42,0],[1930,45,1930,73,0],[1931,45,1931,52,0],[1931,54,1931,63,0],[1931,64,1931,66,0],[1931,67,1931,98,0],[1932,45,1932,46,0],[1933,49,1933,106,0],[1935,49,1935,85,0],[1936,49,1936,50,0],[1937,53,1937,95,0],[1938,49,1938,50,0],[1939,45,1939,46,0],[1940,45,1940,88,0],[1941,41,1941,42,0],[1943,41,1943,42,0],[1944,45,1944,82,0],[1945,41,1945,42,0],[1946,37,1946,38,0],[1948,37,1948,38,0],[1949,41,1949,78,0],[1950,37,1950,38,0],[1951,33,1951,34,0],[1952,29,1952,30,0],[1953,25,1953,26,0],[1954,30,1957,105,0],[1958,25,1958,26,0],[1959,29,1959,93,0],[1960,29,1960,72,0],[1961,29,1961,61,0],[1962,29,1962,60,0],[1963,33,1963,60,0],[1964,29,1964,63,0],[1965,25,1965,26,0],[1966,30,1966,116,0],[1967,25,1967,26,0],[1969,29,1969,63,0],[1970,25,1970,26,0],[1972,25,1972,26,0],[1973,29,1973,72,0],[1974,25,1974,26,0],[1975,21,1975,22,0],[1976,21,1976,44,0],[1977,17,1977,18,0],[1979,17,1979,41,0],[1980,13,1980,14,0],[1981,13,1981,26,0],[1982,9,1982,10,0],[2082,9,2082,10,0],[2083,13,2083,36,0],[2085,13,2085,20,0],[2085,22,2085,31,0],[2085,32,2085,34,0],[2085,35,2085,49,0],[2086,13,2086,14,0],[2087,17,2087,55,0],[2088,17,2088,18,0],[2089,21,2089,40,0],[2090,21,2090,27,0],[2092,13,2092,14,0],[2094,13,2094,31,0],[2095,9,2095,10,0],[2098,9,2098,10,0],[2099,13,2099,35,0],[2101,13,2101,14,0],[2102,17,2102,41,0],[2103,17,2103,18,0],[2104,21,2104,110,0],[2105,21,2105,48,0],[2106,21,2106,48,0],[2108,21,2108,75,0],[2109,17,2109,18,0],[2110,13,2110,14,0],[2111,13,2111,18,0],[2112,13,2112,14,0],[2113,13,2113,14,0],[2114,13,2114,35,0],[2115,9,2115,10,0],[2118,9,2118,10,0],[2119,13,2119,26,0],[2120,9,2120,10,0],[2123,9,2123,10,1],[2125,13,2125,68,1],[2126,13,2126,34,1],[2128,13,2128,51,1],[2129,13,2129,116,1],[2132,13,2132,14,1],[2136,17,2136,46,1],[2137,17,2137,32,1],[2138,17,2138,31,1],[2139,17,2139,91,1],[2143,17,2143,41,1],[2144,17,2144,18,1],[2145,21,2145,62,1],[2146,21,2146,79,1],[2148,21,2148,63,1],[2149,21,2149,22,0],[2150,25,2150,67,0],[2152,21,2152,101,1],[2155,21,2155,105,1],[2156,21,2156,101,1],[2156,101,2156,113,1],[2156,113,2156,124,1],[2156,21,2156,124,1],[2158,21,2158,118,1],[2159,21,2159,22,1],[2160,25,2160,32,1],[2160,34,2160,47,1],[2160,48,2160,50,1],[2160,51,2160,63,1],[2161,25,2161,26,1],[2162,29,2162,74,1],[2163,29,2163,30,1],[2164,33,2164,70,1],[2165,33,2165,34,1],[2166,37,2166,73,1],[2167,33,2167,34,1],[2168,29,2168,30,1],[2169,25,2169,26,1],[2170,21,2170,22,1],[2171,26,2171,122,0],[2172,21,2172,22,0],[2173,25,2173,32,0],[2173,34,2173,47,0],[2173,48,2173,50,0],[2173,51,2173,63,0],[2174,25,2174,26,0],[2175,29,2175,74,0],[2176,29,2176,30,0],[2177,33,2177,69,0],[2178,33,2178,34,0],[2179,37,2179,73,0],[2180,33,2180,34,0],[2181,29,2181,30,0],[2182,25,2182,26,0],[2183,21,2183,22,0],[2186,21,2186,78,1],[2188,21,2188,85,1],[2189,21,2189,103,1],[2192,21,2194,25,1],[2194,25,2194,26,1],[2194,26,2195,29,1],[2195,29,2195,71,1],[2195,71,2196,29,1],[2196,29,2196,30,1],[2196,30,2197,33,1],[2197,33,2198,55,1],[2198,55,2199,33,1],[2199,33,2199,34,1],[2199,34,2200,37,1],[2200,37,2202,78,1],[2202,78,2203,37,1],[2203,37,2205,53,1],[2205,53,2206,37,1],[2206,37,2206,82,1],[2206,82,2207,37,1],[2207,37,2207,92,1],[2207,92,2208,37,1],[2208,37,2208,55,1],[2208,55,2209,37,1],[2209,37,2209,67,1],[2209,67,2210,37,1],[2210,37,2210,82,1],[2210,82,2211,37,1],[2211,37,2211,44,1],[2211,44,2211,46,1],[2211,46,2211,60,1],[2211,60,2211,61,1],[2211,61,2211,63,1],[2211,63,2212,41,1],[2212,41,2212,101,1],[2212,101,2213,37,1],[2213,37,2213,38,1],[2213,38,2214,41,1],[2214,41,2222,111,1],[2222,111,2223,41,1],[2223,41,2223,42,1],[2223,42,2224,45,1],[2224,45,2224,136,1],[2224,136,2226,45,1],[2226,45,2226,76,1],[2226,76,2227,49,1],[2227,49,2227,67,0],[2227,67,2228,41,1],[2228,41,2228,42,1],[2228,42,2229,37,1],[2229,37,2229,38,1],[2229,38,2231,37,1],[2231,37,2231,83,1],[2231,83,2233,37,1],[2233,37,2238,93,1],[2238,93,2240,37,1],[2240,37,2241,110,1],[2241,110,2242,37,1],[2242,37,2242,38,1],[2242,38,2243,41,1],[2243,41,2243,48,1],[2243,48,2243,50,1],[2243,50,2243,61,0],[2243,61,2243,62,1],[2243,62,2243,64,1],[2243,64,2243,65,1],[2243,65,2243,83,1],[2243,83,2244,41,1],[2244,41,2244,42,0],[2244,42,2245,45,1],[2245,45,2247,114,0],[2247,114,2248,45,1],[2248,45,2248,105,0],[2248,105,2249,49,1],[2249,49,2249,110,0],[2249,110,2250,41,1],[2250,41,2250,42,0],[2250,42,2251,41,1],[2251,41,2251,125,1],[2251,125,2252,37,1],[2252,37,2252,38,1],[2252,38,2254,37,1],[2254,37,2254,73,1],[2254,73,2256,37,1],[2256,37,2256,116,1],[2256,116,2257,33,1],[2257,33,2257,34,1],[2257,34,2258,29,1],[2258,29,2258,30,1],[2258,30,2259,25,1],[2259,25,2259,26,1],[2259,26,2259,28,1],[2192,21,2259,28,1],[2261,21,2261,127,1],[2262,17,2262,18,1],[2263,13,2263,14,1],[2264,13,2264,32,0],[2265,13,2265,14,0],[2266,17,2266,146,0],[2267,17,2267,23,0],[2270,13,2270,14,1],[2271,17,2271,47,1],[2274,17,2274,58,1],[2275,17,2275,18,0],[2276,21,2276,76,0],[2277,21,2277,28,0],[2277,30,2277,70,0],[2277,71,2277,73,0],[2277,74,2277,100,0],[2278,21,2278,22,0],[2279,25,2281,39,0],[2282,21,2282,22,0],[2283,21,2283,78,0],[2284,25,2284,97,0],[2285,17,2285,18,0],[2286,13,2286,14,1],[2287,9,2287,10,1],[2290,9,2290,10,1],[2291,13,2291,70,1],[2292,13,2292,14,1],[2293,17,2293,46,1],[2294,17,2294,47,1],[2295,17,2295,24,1],[2295,26,2295,37,1],[2295,38,2295,40,1],[2295,41,2295,56,1],[2296,17,2296,18,1],[2297,21,2297,44,1],[2298,21,2298,54,1],[2299,25,2299,72,0],[2301,17,2301,18,1],[2303,17,2303,24,1],[2303,26,2303,37,1],[2303,38,2303,40,1],[2303,41,2303,48,1],[2304,17,2304,18,1],[2305,21,2305,42,1],[2306,21,2306,71,1],[2307,21,2307,28,1],[2307,30,2307,41,1],[2307,42,2307,44,1],[2307,45,2307,60,1],[2308,21,2308,22,1],[2309,25,2309,43,1],[2310,25,2310,61,1],[2311,25,2311,26,0],[2312,29,2315,95,0],[2317,25,2317,26,0],[2318,21,2318,22,1],[2319,17,2319,18,1],[2320,17,2320,30,1],[2323,13,2323,14,1],[2324,17,2324,34,1],[2326,9,2326,10,1],[2329,9,2329,10,1],[2330,13,2330,140,1],[2331,9,2331,10,1],[2334,9,2334,10,1],[2335,13,2335,64,1],[2336,13,2336,46,1],[2338,13,2338,31,1],[2339,13,2339,14,1],[2342,17,2342,128,1],[2344,13,2344,14,1],[2345,18,2345,155,1],[2346,13,2346,14,0],[2348,17,2348,123,0],[2349,17,2349,70,0],[2351,17,2351,82,0],[2352,17,2352,18,0],[2356,21,2356,148,0],[2357,17,2357,18,0],[2359,21,2359,111,0],[2362,13,2362,14,0],[2363,18,2364,97,1],[2365,13,2365,14,1],[2367,17,2367,55,1],[2368,17,2368,52,1],[2370,17,2370,123,1],[2371,17,2371,70,1],[2373,17,2373,41,1],[2374,17,2374,18,1],[2375,21,2375,48,1],[2376,21,2376,52,1],[2377,21,2377,28,1],[2377,30,2377,43,1],[2377,44,2377,46,1],[2377,47,2377,56,1],[2378,21,2378,22,1],[2379,25,2379,103,1],[2380,25,2380,26,1],[2383,29,2383,177,1],[2384,25,2384,26,1],[2385,30,2385,51,1],[2386,21,2386,22,1],[2389,21,2389,63,1],[2394,25,2394,158,1],[2399,25,2399,97,1],[2400,17,2400,18,1],[2402,17,2402,18,0],[2403,21,2403,84,0],[2405,17,2405,18,0],[2408,13,2408,14,1],[2409,18,2409,105,1],[2410,13,2410,14,0],[2413,17,2413,57,0],[2414,21,2414,28,0],[2416,17,2416,123,0],[2417,17,2417,70,0],[2419,17,2419,122,0],[2421,17,2421,65,0],[2422,17,2422,57,0],[2423,17,2423,63,0],[2424,17,2424,59,0],[2429,17,2429,112,0],[2430,17,2430,75,0],[2432,17,2432,99,0],[2433,17,2433,103,0],[2434,17,2434,80,0],[2435,17,2435,85,0],[2436,17,2436,86,0],[2438,17,2438,103,0],[2439,17,2439,18,0],[2440,21,2440,167,0],[2441,21,2441,90,0],[2442,21,2442,128,0],[2443,17,2443,18,0],[2445,17,2445,77,0],[2446,17,2446,97,0],[2447,17,2447,86,0],[2448,17,2448,85,0],[2449,17,2449,83,0],[2450,17,2450,65,0],[2451,17,2451,115,0],[2452,17,2452,73,0],[2454,17,2454,103,0],[2455,17,2455,66,0],[2457,17,2457,81,0],[2458,17,2458,98,0],[2459,17,2459,71,0],[2460,17,2460,144,0],[2461,17,2461,77,0],[2462,17,2462,119,0],[2463,17,2463,59,0],[2465,17,2465,94,0],[2466,17,2466,76,0],[2468,17,2468,128,0],[2472,13,2472,14,0],[2473,18,2475,94,1],[2476,13,2476,14,0],[2479,17,2479,123,0],[2480,17,2480,70,0],[2482,17,2482,57,0],[2483,17,2483,18,0],[2485,21,2485,59,0],[2486,21,2486,56,0],[2489,21,2489,45,0],[2490,21,2490,22,0],[2491,25,2491,78,0],[2492,25,2492,60,0],[2494,30,2494,39,0],[2494,41,2494,60,0],[2494,62,2494,65,0],[2495,25,2495,26,0],[2496,29,2496,58,0],[2497,29,2497,84,0],[2498,29,2498,148,0],[2499,25,2499,26,0],[2502,25,2502,109,0],[2505,25,2505,102,0],[2506,21,2506,22,0],[2508,21,2508,22,0],[2510,25,2510,87,0],[2511,21,2511,22,0],[2512,17,2512,18,0],[2514,17,2514,18,0],[2517,21,2517,75,0],[2518,21,2518,55,0],[2519,21,2519,22,0],[2520,25,2520,66,0],[2521,25,2521,69,0],[2522,25,2522,67,0],[2523,25,2523,57,0],[2525,25,2525,58,0],[2526,29,2526,85,0],[2528,25,2528,64,0],[2529,25,2529,76,0],[2531,25,2531,111,0],[2533,25,2533,71,0],[2537,25,2537,90,0],[2538,25,2538,64,0],[2539,25,2539,74,0],[2540,25,2540,49,0],[2541,25,2541,82,0],[2542,25,2542,70,0],[2543,25,2543,118,0],[2544,25,2544,73,0],[2545,25,2545,93,0],[2546,25,2546,126,0],[2547,25,2547,74,0],[2548,25,2548,81,0],[2549,25,2549,60,0],[2550,25,2550,74,0],[2551,25,2551,122,0],[2552,25,2552,95,0],[2553,25,2553,56,0],[2556,25,2556,81,0],[2561,25,2561,150,0],[2562,21,2562,22,0],[2564,25,2564,87,0],[2566,17,2566,18,0],[2568,13,2568,14,0],[2570,13,2570,14,1],[2571,17,2571,123,1],[2572,17,2572,70,1],[2574,17,2574,107,1],[2576,13,2576,14,1],[2578,13,2578,51,1],[2579,9,2579,10,1],[2582,9,2582,10,1],[2583,13,2583,55,1],[2584,17,2584,121,1],[2586,13,2586,35,1],[2587,9,2587,10,1],[2590,9,2590,10,1],[2591,13,2591,56,1],[2592,13,2593,179,1],[2598,9,2598,10,1],[2601,9,2601,10,1],[2604,13,2606,57,1],[2607,13,2608,105,1],[2609,9,2609,10,1],[2612,9,2612,10,0],[2613,9,2613,10,0],[2616,9,2616,10,1],[2617,13,2617,45,1],[2618,13,2618,52,1],[2619,13,2619,20,1],[2619,22,2619,32,1],[2619,33,2619,35,1],[2619,36,2619,49,1],[2620,13,2620,14,1],[2621,17,2621,76,1],[2622,13,2622,14,1],[2623,13,2623,62,1],[2624,13,2624,57,1],[2625,13,2625,14,1],[2626,17,2626,39,1],[2627,17,2627,68,1],[2628,17,2628,24,1],[2628,26,2628,37,1],[2628,38,2628,40,1],[2628,41,2628,46,1],[2629,17,2629,18,1],[2630,21,2630,39,1],[2631,25,2631,104,1],[2633,25,2633,112,0],[2634,17,2634,18,1],[2635,17,2635,76,1],[2636,13,2636,14,1],[2637,13,2637,30,1],[2638,9,2638,10,1],[2641,9,2641,10,0],[2642,9,2642,10,0],[2645,9,2645,10,1],[2646,13,2646,53,1],[2647,13,2647,77,1],[2648,13,2648,14,0],[2649,17,2650,17,0],[2650,17,2650,18,0],[2650,18,2651,21,0],[2651,21,2651,50,0],[2651,50,2653,17,0],[2653,17,2653,18,0],[2653,18,2653,20,0],[2649,17,2653,20,0],[2654,13,2654,14,0],[2656,13,2656,14,1],[2657,17,2657,48,1],[2658,13,2658,14,1],[2660,13,2660,63,1],[2662,13,2662,42,1],[2663,17,2663,90,0],[2665,9,2665,10,1],[2668,9,2668,10,1],[2669,13,2669,106,1],[2670,13,2670,72,1],[2671,13,2671,51,1],[2672,13,2672,52,1],[2673,13,2673,76,1],[2674,13,2674,68,1],[2675,13,2675,59,1],[2676,13,2676,60,1],[2677,13,2677,71,1],[2678,9,2678,10,1],[2681,9,2681,10,1],[2682,13,2682,53,1],[2683,13,2683,39,1],[2684,13,2684,42,1],[2685,17,2685,50,1],[2687,13,2687,39,1],[2689,13,2689,27,1],[2690,9,2690,10,1],[2693,9,2693,10,1],[2694,13,2694,43,1],[2696,13,2696,39,1],[2697,13,2697,42,1],[2697,43,2697,81,1],[2699,13,2699,32,1],[2700,9,2700,10,1],[2703,9,2703,10,1],[2704,13,2704,42,1],[2704,43,2704,86,1],[2706,13,2706,38,1],[2707,9,2707,10,1],[2710,9,2710,10,1],[2711,13,2711,20,1],[2711,22,2711,29,1],[2711,30,2711,32,1],[2711,33,2711,41,1],[2712,13,2712,14,1],[2713,17,2713,58,1],[2714,17,2714,111,1],[2715,17,2715,18,0],[2716,21,2716,28,0],[2716,30,2716,41,0],[2716,42,2716,44,0],[2716,45,2716,88,0],[2717,25,2717,68,0],[2718,29,2718,53,0],[2720,21,2720,82,0],[2721,21,2721,38,0],[2722,25,2722,32,0],[2724,21,2724,50,0],[2725,21,2725,42,0],[2726,21,2726,22,0],[2727,25,2727,55,0],[2728,25,2728,67,0],[2729,21,2729,22,0],[2731,25,2731,111,0],[2732,21,2732,39,0],[2733,21,2733,22,0],[2734,25,2734,81,0],[2735,25,2735,65,0],[2736,25,2736,57,0],[2737,25,2737,72,0],[2738,25,2738,112,0],[2739,25,2739,73,0],[2740,25,2740,75,0],[2741,25,2741,62,0],[2742,25,2742,54,0],[2743,25,2743,52,0],[2744,21,2744,22,0],[2745,17,2745,18,0],[2746,13,2746,14,1],[2747,9,2747,10,1],[2750,9,2750,10,1],[2751,13,2751,39,1],[2752,13,2752,42,1],[2752,43,2752,92,1],[2753,13,2753,43,1],[2754,9,2754,10,1],[2757,9,2757,10,1],[2758,13,2759,67,1],[2760,13,2760,14,1],[2761,17,2761,100,1],[2763,17,2764,17,1],[2764,17,2764,18,1],[2764,18,2765,21,1],[2765,21,2765,144,1],[2765,144,2766,17,1],[2766,17,2766,18,1],[2766,18,2766,20,1],[2763,17,2766,20,1],[2768,13,2768,14,1],[2769,9,2769,10,1]]);
    </script>
  </body>
</html>