<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\MODMGMT\ApplicationSettings.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.IO;
using System.Text;
using System.Threading.Tasks;
using System.Web;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.ModuleManagementDTO;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;
using System.Web.Script.Serialization;
using Aurigo.Brix.Platform.BusinessLayer.BL.ADIntegration;
using App = Aurigo.AMP3.Common.AMP3ApplicationSettings;
using Image = System.Drawing.Image;
using Aurigo.AMP3.EnterpriseBL;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Common;

namespace Aurigo.AMP3.ModuleManagementUI
{
    public partial class ApplicationSettings : BrixPageBase
    {
        public override bool CheckAccess()
        {
            return ModuleManager.Instance.HasAdminRole(UserDetail.GetCurrentUserDetail());
        }
        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                //Setting Default Button
                ((HtmlForm)Page.Master.FindControl(&quot;form1&quot;)).DefaultButton = btnSave.UniqueID;

                //disabling system log checkbox
                cblLogMode.Items[1].Enabled = false;
                lblMsg.Text = &quot;&quot;;
                tdCustomize.InnerText = string.Format(&quot;Customize {0} Options&quot;, ItemNameAbbr);
                tdGroupType.InnerText = string.Format(&quot;{0} Group Type :&quot;, ItemNameAbbr);
                tdRateFactor.InnerText = string.Format(&quot;{0} Rate Factor :&quot;, ItemNameAbbr);
                if (!IsPostBack)
                {
                    imgPreview.Attributes.Add(&quot;style&quot;, &quot;display:none&quot;);
                    txtAppName.Text = App.Instance.AppName;
                    txtBlockedFileTypes.Text = App.Instance.BlockedFileTypes;
                    lnkAppLogo.Text = App.Instance.AppLogo.Substring(&quot;~/Modules/MODMGMT/Images/&quot;.Length);
                    txtSmtpServer.Text = App.Instance.SmtpServer;
                    txtAppEmailId.Text = App.Instance.AppEmailID;
                    rblAppLvlLog.Text = App.Instance.AppLevelLog ? &quot;On&quot; : &quot;Off&quot;;
                    txtProjectedCostFormula.Text = App.Instance.ProjectedCostFormula;
                    ddlBOQGrpType.SelectedValue = App.Instance.LogLevel;
                    txtD1Title.Text = App.Instance.Dim1Title;
                    txtD2Title.Text = App.Instance.Dim2Title;
                    txtD3Title.Text = App.Instance.Dim3Title;

                    txtD2Title.Text = App.Instance.Dim2Title;
                    txtD3Title.Text = App.Instance.Dim3Title;

                    wneAutoSync.ValueInt = App.Instance.MOBILEAutoSyncInterval.ToInt32_2();
                    wneAutoSave.ValueInt = App.Instance.MOBILEAutoSaveInterval.ToInt32_2();
                    wneMaxOffline.ValueInt = App.Instance.MOBILEOfflineDuration.ToInt32_2();
                    rblCache.Text = App.Instance.CacheData ? &quot;On&quot; : &quot;Off&quot;;

                    if (!string.IsNullOrEmpty(App.Instance.BOQRateFactor))
                        wneRateFactor.ValueDecimal = App.Instance.BOQRateFactor.ToDecimal2();
                    string FORMAT_AMOUNT = App.Instance.FORMAT_AMOUNT;
                    string FORMAT_UNIT_PRICE = App.Instance.FORMAT_UNIT_PRICE;
                    string FORMAT_QUANTITY = App.Instance.FORMAT_QUANTITY;
                    string FORMAT_DATE = App.Instance.FORMAT_DATE; //Month(MM) to diffrentiate from minute(mm)
                    string FORMAT_TIME = App.Instance.FORMAT_TIME;

                    if (ddlCulture.Items.FindByValue(App.Instance.Culture) != null)
                    {
                        ddlCulture.Items.FindByValue(App.Instance.Culture).Selected = true;
                        CultureSpecificSettings();
                    }

                    if (ddlBOQGrpType.Items.FindByValue(App.Instance.BOQGroupType) != null)
                    {
                        ddlBOQGrpType.Items.FindByValue(App.Instance.BOQGroupType).Selected = true;
                    }

                    ddlNoDigitsAmount.SelectedValue =
                        CoreDatabaseHelper.GetDigitsAfterDecimal(FORMAT_AMOUNT).ToString2();
                    ddlNoDigitsUnitPrice.SelectedValue =
                        CoreDatabaseHelper.GetDigitsAfterDecimal(FORMAT_UNIT_PRICE).ToString2();
                    ddlNoDigitsQuantity.SelectedValue =
                        CoreDatabaseHelper.GetDigitsAfterDecimal(FORMAT_QUANTITY).ToString2();
                    ddlDateFormat.SelectedValue = CoreDatabaseHelper.SetDisplayDateSeparator(FORMAT_DATE); 
                    ddlDateSeparator.SelectedValue = CoreDatabaseHelper.GetDateSeparator(FORMAT_DATE);
                    ddlTimeFormat.SelectedValue = FORMAT_TIME;
                    ddlDigitGrouping.SelectedValue = CoreDatabaseHelper.GetDigitsGrouping(FORMAT_AMOUNT);

                    //string FORMAT_DATETIME = FORMAT_DATE + &quot; &quot; + FORMAT_TIME;
                    if (!String.IsNullOrEmpty(App.Instance.LogMode))
                    {
                        string[] logModes = App.Instance.LogMode.Split(&#39;,&#39;);
                        foreach (string logMode in logModes)
                            cblLogMode.Items[cblLogMode.Items.IndexOf(new ListItem(logMode))].Selected = true;
                    }
                    else
                    {
                        for (int loop = 0; loop &lt; cblLogMode.Items.Count; loop++)
                            cblLogMode.Items[loop].Selected = false;
                    }

                    if (!String.IsNullOrEmpty(App.Instance.LogLevel))
                    {
                        string[] logLvls = App.Instance.LogLevel.Split(&#39;,&#39;);
                        foreach (string logLvl in logLvls)
                            cblLogLevel.Items[cblLogLevel.Items.IndexOf(new ListItem(logLvl))].Selected = true;
                    }
                    else
                    {
                        for (int loop = 0; loop &lt; cblLogLevel.Items.Count; loop++)
                            cblLogLevel.Items[loop].Selected = false;
                    }

                    ddlTimezone.DataSource = TimeZoneInfo.GetSystemTimeZones();
                    ddlTimezone.DataTextField = &quot;DisplayName&quot;;
                    ddlTimezone.DataValueField = &quot;Id&quot;;
                    ddlTimezone.DataBind();

                    // Set the Value for Timezone
                    if (!string.IsNullOrEmpty(App.Instance.CurrentTimeZone) &amp;&amp;
                        ddlTimezone.Items.FindByValue(App.Instance.CurrentTimeZone) != null)
                    {
                        ddlTimezone.Items.FindByValue(App.Instance.CurrentTimeZone).Selected = true;
                    }

                    BindData();

                    BindIntegrationDateSettings();

                    List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
                    if (!ModuleComponents.Contains(&quot;ItemDimension1&quot;))
                        Dim1.Visible = false;
                    if (!ModuleComponents.Contains(&quot;ItemDimension2&quot;))
                        Dim2.Visible = false;
                    if (!ModuleComponents.Contains(&quot;ItemDimension3&quot;))
                        Dim3.Visible = false;

                    wneMobileRebuildSchedule.ValueDecimal = AMP3ApplicationSettings.Instance.MobileSyncInterval;
                    wneMobileRebuildUser.ValueInt = AMP3ApplicationSettings.Instance.MobileSyncLastUserCount;

                    if (MobileCacheManager.Instance.IsMobileCacheInProgress())
                        lblMobileCacheMessage.Text = &quot;Cache building in progress...&quot;;
                    else
                    {
                        DateTime? lastCacheTime = MobileCacheManager.Instance.GetLastSuccessfullCacheEndTime();
                        if (lastCacheTime != null)
                        {
                            lblMobileCacheMessage.Text = &quot;Last cache was successfully built at &quot; +
                                                         lastCacheTime.ToMWDateTimeString_FormatDateTime();
                        }
                    }

                    LoginModeList.SelectedValue = App.Instance.LoginMode;
                    AdfsDomainName.Text = App.Instance.DomainName;
                    hiddenLoginMode.Value = App.Instance.LoginMode;
                    SessionTimeoutTBox.Text = App.Instance.SessionTimeoutNotification;
                }

                if (hdFile.Value.Equals(&quot;AppLogo&quot;))
                {
                    ChangeLogo(hdFile.Value);
                    hdFile.Value = &quot;&quot;;
                }
            }
            catch (Exception ex)
            {
                lblMsg.Text = ex.Message;
            }
        }

        private void BindIntegrationDateSettings()
        {
            DataTable dtIntegrationDateSettings =
                CoreDatabaseHelper.GetIntegrationDateSettings(Session[Constants.EIS_ADDITIONAL_INFO].ToString());
            if (dtIntegrationDateSettings.Rows.Count &gt; 0)
            {
                lblIntegrationCutoffDate.Text =
                    dtIntegrationDateSettings.Rows[0][&quot;IntegrationCutoffDate&quot;].ToMWDateTimeString_FormatDate();
                wdcIntegrationCutoffDate.Value =
                    dtIntegrationDateSettings.Rows[0][&quot;IntegrationCutoffDate&quot;].ToMWDateTimeNullable();
                wdcDefaultRecordDate.Value = dtIntegrationDateSettings.Rows[0][&quot;DefaultRecordDate&quot;].ToMWDateTimeNullable();
            }
            else
            {
                lblIntegrationCutoffDate.Text = &quot;&quot;;
                wdcIntegrationCutoffDate.Value = null;
                wdcDefaultRecordDate.Value = null;
                wdcDefaultRecordDate.Enabled = false;
                trIntegration1.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trIntegration2.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trIntegration3.Style.Add(&quot;display&quot;, &quot;none&quot;);
            }
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            menus.Add(new BrixMenu(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;));
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;));

            CreateToolBarMenu(menus, null);
            base.CreateChildControls();
        }

        protected override void CustomizeToolBar()
        {
            Aurigo.AMP3.Core.UserControls.Menu lnkSave = MainToolBar.GetMenuReference(&quot;lnkSave&quot;);
            lnkSave.Click += btnSave_Click;
            lnkSave.OnClientClick = &quot;return SaveButtionClick()&quot;;
            var lnkCancel = MainToolBar.GetMenuReference(&quot;lnkCancel&quot;);
            if (lnkCancel != null) {
                lnkCancel.Click += btnClose_Click;
                lnkCancel.CausesValidation = false;
            }
        }

        private void BindData()
        {
            try
            {
                //to get the report logos
                List&lt;LogoDetails&gt; logos = ModuleManager.Instance.GetImagedetails();

                if (uwgAttachments.Columns.Count == 0)
                {
                    var col = new UltraGridColumn();
                    col.Key = &quot;ImageId&quot;;
                    col.Header.Caption = &quot;ImageId&quot;;
                    col.Hidden = true;
                    uwgAttachments.Columns.Add(col);

                    col = new UltraGridColumn();
                    col.Key = &quot;Name&quot;;
                    col.Header.Caption = &quot;Name&quot;;
                    uwgAttachments.Columns.Add(col);

                    col = new UltraGridColumn();
                    col.Key = &quot;Description&quot;;
                    col.Header.Caption = &quot;Description&quot;;
                    uwgAttachments.Columns.Add(col);

                    col = new UltraGridColumn();
                    col.Key = &quot;Image&quot;;
                    col.Header.Caption = &quot;Image&quot;;
                    uwgAttachments.Columns.Add(col);

                    col = new UltraGridColumn();
                    col.Key = &quot;Delete&quot;;
                    col.Header.Caption = &quot;Delete&quot;;
                    uwgAttachments.Columns.Add(col);

                    col = new UltraGridColumn();
                    col.Key = &quot;IsDeleted&quot;;
                    col.Header.Caption = &quot;IsDeleted&quot;;
                    col.Hidden = true;
                    uwgAttachments.Columns.Add(col);

                    col = new UltraGridColumn();
                    col.Key = &quot;fileID&quot;;
                    col.Header.Caption = &quot;fileID&quot;;
                    col.Hidden = true;
                    uwgAttachments.Columns.Add(col);

                    col = new UltraGridColumn();
                    col.Key = &quot;type&quot;;
                    col.Header.Caption = &quot;type&quot;;
                    col.Hidden = true;
                    uwgAttachments.Columns.Add(col);
                }

                uwgAttachments.DisplayLayout.Rows.Clear();

                if (logos != null &amp;&amp; logos.Count &gt; 0)
                {
                    foreach (LogoDetails logo in logos)
                    {
                        UltraGridRow row = uwgAttachments.Bands[0].AddNew();
                        row.Cells.FromKey(&quot;ImageId&quot;).Value = logo.ImageID;
                        row.Cells.FromKey(&quot;Name&quot;).Value = logo.Name;
                        row.Cells.FromKey(&quot;Description&quot;).Value = logo.Description;
                        row.Cells.FromKey(&quot;Image&quot;).Value = logo.Image;
                        row.Cells.FromKey(&quot;Delete&quot;).Value = &quot;&lt;a href=javascript:DeleteSelected(&#39;&quot; +
                                                            uwgAttachments.ClientID + &quot;&#39;)&gt;Delete&lt;/a&gt;&quot;;
                        row.Cells.FromKey(&quot;IsDeleted&quot;).Value = &quot;false&quot;;
                        row.Cells.FromKey(&quot;type&quot;).Value = &quot;Existing&quot;;
                        uwgAttachments.Rows.Add(row);
                    }
                }
            }
            catch (Exception ex)
            {
                lblMsg.Text = ex.Message;
            }
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            try
            {
                if (wdcDefaultRecordDate.Value != null &amp;&amp;
                    wdcDefaultRecordDate.Value.ToDateTime_MWCulture() &gt;= wdcIntegrationCutoffDate.Value.ToDateTime_MWCulture())
                {
                    throw new Exception(&quot;Default Record Date should be less than Integration Date.&quot;);
                }

                if(LoginModeList.SelectedValue != hiddenLoginMode.Value)
                {
                    var count = EnterpriseManager.Instance.GetOnlineUserCount(ConnectionHelper.GetCurrentCompany(), null, null);

                    if (count &gt; 1)
                    {
                        ShowError(&quot;Application is being used by active users. Ensure all users are logged off before editing the login mode.&quot;);
                        return;
                    }
                }

                var appSettings = new Dictionary&lt;string, string&gt;();

                appSettings[&quot;AppName&quot;] = txtAppName.Text;

                if (SaveLogo(lnkAppLogo.Text))
                    appSettings.Add(&quot;AppLogo&quot;, lnkAppLogo.Text);

                appSettings.Add(&quot;AppServer&quot;, txtSmtpServer.Text);
                appSettings.Add(&quot;AppEmailId&quot;, txtAppEmailId.Text);
                appSettings.Add(&quot;AppLevelLog&quot;, rblAppLvlLog.SelectedItem.Value);
                appSettings.Add(&quot;ProjectedCostFormula&quot;, txtProjectedCostFormula.Text);
                appSettings.Add(&quot;BlockedFileTypes&quot;, txtBlockedFileTypes.Text.Trim());

                var logMode = new StringBuilder();

                for (int i = 0, addDelimiter = 0; i &lt; cblLogMode.Items.Count; i++)
                {
                    if (cblLogMode.Items[i].Selected)
                    {
                        if (rblAppLvlLog.SelectedItem.Value == &quot;Off&quot;)
                            cblLogMode.Items[i].Selected = false;
                        else
                        {
                            if (addDelimiter == 1)
                                logMode.Append(&quot;,&quot;);
                            else
                                addDelimiter = 1;
                            logMode.Append(cblLogMode.Items[i].Text);
                        }
                    }
                }
                appSettings.Add(&quot;LogMode&quot;, logMode.ToString2());

                var logLevel = new StringBuilder();
                for (int i = 0, addDelimiter = 0; i &lt; cblLogLevel.Items.Count; i++)
                {
                    if (cblLogLevel.Items[i].Selected)
                    {
                        if (rblAppLvlLog.SelectedItem.Value == &quot;Off&quot;)
                            cblLogLevel.Items[i].Selected = false;
                        else
                        {
                            if (addDelimiter == 1)
                                logLevel.Append(&quot;,&quot;);
                            else
                                addDelimiter = 1;
                            logLevel.Append(cblLogLevel.Items[i].Text);
                        }
                    }
                }
                appSettings.Add(&quot;LogLevel&quot;, logLevel.ToString2());


                appSettings[&quot;BOQGroupType&quot;] = ddlBOQGrpType.SelectedValue;
                appSettings[&quot;BOQRateFactor&quot;] = wneRateFactor.ValueDecimal.ToString2();
                appSettings[&quot;Dim1Title&quot;] = txtD1Title.Text;
                appSettings[&quot;Dim2Title&quot;] = txtD2Title.Text;
                appSettings[&quot;Dim3Title&quot;] = txtD3Title.Text;
                appSettings[&quot;MOBILEOfflineDuration&quot;] = wneMaxOffline.ValueInt.ToString();
                appSettings[&quot;MOBILEAutoSyncInterval&quot;] = wneAutoSync.ValueInt.ToString();
                //Number and Date Formats
                appSettings.Add(&quot;FORMAT_AMOUNT&quot;,
                    CoreDatabaseHelper.GetNumberFormat(ddlDigitGrouping.SelectedValue,
                        ddlNoDigitsAmount.SelectedValue.ToInt32_2()));
                appSettings.Add(&quot;FORMAT_UNIT_PRICE&quot;,
                    CoreDatabaseHelper.GetNumberFormat(ddlDigitGrouping.SelectedValue,
                        ddlNoDigitsUnitPrice.SelectedValue.ToInt32_2()));
                appSettings.Add(&quot;FORMAT_QUANTITY&quot;,
                    CoreDatabaseHelper.GetNumberFormat(ddlDigitGrouping.SelectedValue,
                        ddlNoDigitsQuantity.SelectedValue.ToInt32_2()));
                appSettings.Add(&quot;FORMAT_DATE&quot;, ddlDateFormat.SelectedValue.Replace(&quot;/&quot;, ddlDateSeparator.SelectedValue).Replace(&quot;-&quot;, ddlDateSeparator.SelectedValue));
                appSettings.Add(&quot;FORMAT_TIME&quot;, ddlTimeFormat.SelectedValue);
                appSettings.Add(&quot;FORMAT_DATETIME&quot;, ddlDateFormat.SelectedValue.Replace(&quot;/&quot;, ddlDateSeparator.SelectedValue).Replace(&quot;-&quot;, ddlDateSeparator.SelectedValue) + &quot; &quot; + ddlTimeFormat.SelectedValue);

                appSettings.Add(&quot;Culture&quot;, ddlCulture.SelectedValue);
                appSettings.Add(&quot;CurrentTimeZone&quot;, ddlTimezone.SelectedValue);

                appSettings.Add(&quot;MobileSyncInterval&quot;, wneMobileRebuildSchedule.ValueDecimal.ToString());
                appSettings.Add(&quot;MOBILEAutoSaveInterval&quot;, wneAutoSave.ValueInt.ToString());
                appSettings.Add(&quot;MobileLastUserCount&quot;, wneMobileRebuildUser.ValueInt.ToString());
                appSettings.Add(&quot;CacheData&quot;, rblCache.SelectedItem.Value);
                appSettings.Add(&quot;LoginMode&quot;, LoginModeList.SelectedValue);
                appSettings.Add(&quot;DomainName&quot;, AdfsDomainName.Text);
                if (SessionTimeoutTBox.Text.ToInt32_2() &lt; Session.Timeout * 60)
                    appSettings.Add(&quot;SessionTimeoutNotification&quot;, SessionTimeoutTBox.Text);
                else
                {
                    ShowError(&quot;Session Timeout Notification should be less than &quot; + Session.Timeout * 60 + &quot; seconds&quot;);
                    return;
                }

                string integrationDateSettings = string.Empty;
                if (!string.IsNullOrEmpty(lblIntegrationCutoffDate.Text))
                    integrationDateSettings = &quot;&lt;IntegrationDateSettings&gt;&lt;Setting&gt;&lt;AXCompany&gt;&quot; +
                                              Session[Constants.EIS_ADDITIONAL_INFO] + &quot;&lt;/AXCompany&gt;&lt;DefaultRecordDate&gt;&quot; +
                                              wdcDefaultRecordDate.Value.ToUtcNullable() +
                                              &quot;&lt;/DefaultRecordDate&gt;&lt;/Setting&gt;&lt;/IntegrationDateSettings&gt;&quot;;
                else
                    integrationDateSettings = &quot;&lt;IntegrationDateSettings&gt;&lt;Setting&gt;&lt;/Setting&gt;&lt;/IntegrationDateSettings&gt;&quot;;

                if (CoreDatabaseHelper.SetApplicationSettings(appSettings, integrationDateSettings) &gt; 0)
                {
                    Session[Constants.APP_DefaultRecordDate] = wdcDefaultRecordDate.Value.ToUtcNullable().ToDateTime_MWCulture();

                    bool resetCulture = (App.Instance.Culture != ddlCulture.SelectedValue);

                    AMP3ApplicationSettings.Instance.Reload();
                    (this as BrixPageBase).UpdateWebFarmData(&quot;AppSettings&quot;);
                    AMP3ApplicationSettings.Instance.UpdateReportSettings();

                    if (SaveReportLogos())
                    {
                        BindData();

                        // Delete cached data from Redis, will be fetched from DB.
                        string key = RedisKeyConstants.AppSetting + ConnectionHelper.GetCurrentCompany();
                        CacheProvider.CacheBroker.Remove(key, regionName: AMP3ApplicationSettings.Instance.RedisRegionName);
                                                
                        lblMsg.ForeColor = Color.Green;
                        hiddenLoginMode.Value = LoginModeList.SelectedValue;
                        lblMsg.Text = &quot;Settings saved successfully&quot;;
                    }
                    else
                        lblMsg.Text = &quot;Save failed&quot;;
                }
                else
                    lblMsg.Text = &quot;Save failed&quot;;
            }
            catch (Exception ex)
            {
                Logger.Log(Enumerations.LogType.Error, ex.Message, &quot;APPMGMT&quot;);
                lblMsg.Text = ex.Message;
            }
        }

        private bool SaveReportLogos()
        {
            try
            {
                DeleteSelectedLogos();

                string name, description, imagePath = &quot;&quot;;
                bool flag = true;
                string tempFolderPath = HttpContext.Current.Server.MapPath(&quot;./TempFolder&quot;).ToString2();

                if (!Directory.Exists(tempFolderPath))
                    Directory.CreateDirectory(tempFolderPath);

                HttpFileCollection moduleFiles = HttpContext.Current.Request.Files;

                if (moduleFiles == null) return flag;

                for (int j = 0; j &lt; uwgAttachments.Rows.Count; j++)
                {
                    if (!uwgAttachments.Rows[j].Cells.FromKey(&quot;IsDeleted&quot;).Text.Equals(&quot;true&quot;) &amp;&amp;
                        uwgAttachments.Rows[j].Cells.FromKey(&quot;type&quot;).Text.Equals(&quot;New&quot;))
                    {
                        name = uwgAttachments.Rows[j].Cells.FromKey(&quot;Name&quot;).Text;
                        description = uwgAttachments.Rows[j].Cells.FromKey(&quot;Description&quot;).Text;
                        imagePath = uwgAttachments.Rows[j].Cells.FromKey(&quot;Image&quot;).Text;
                        Stream fileStream = moduleFiles[uwgAttachments.Rows[j].Cells.FromKey(&quot;fileID&quot;).Text].InputStream;
                        var strArr = new byte[fileStream.Length];
                        fileStream.Read(strArr, 0, fileStream.Length.ToInt32_2());
                        var memStrm = new MemoryStream(strArr, 0, strArr.Length);
                        Image imgObj = Image.FromStream(memStrm);
                        imgObj.RotateFlip(RotateFlipType.Rotate180FlipNone);
                        imgObj.RotateFlip(RotateFlipType.Rotate180FlipNone);
                        imgObj.Save(tempFolderPath + &quot;\\&quot; + imagePath);

                        if (SaveLogo(imagePath))
                            flag = (ModuleManager.Instance.AddImageDetails(name, description, imagePath) &lt; 0)
                                ? false
                                : true;
                    }
                }
                return flag;
            }
            catch (Exception)
            {
                return false;
            }
        }

        protected bool DeleteSelectedLogos()
        {
            try
            {
                string imageId = &quot;&quot;;

                for (int i = 0; i &lt; uwgAttachments.Rows.Count; i++)
                {
                    if (uwgAttachments.Rows[i].Cells.FromKey(&quot;IsDeleted&quot;).Text.Equals(&quot;true&quot;) &amp;&amp;
                        !uwgAttachments.Rows[i].Cells.FromKey(&quot;type&quot;).Text.Equals(&quot;New&quot;))
                    {
                        UltraGridRow selectedRow = uwgAttachments.Rows[i];
                        string fileName = selectedRow.Cells.FromKey(&quot;Image&quot;).Value.ToString2();

                        imageId = (imageId == &quot;&quot;)
                            ? selectedRow.Cells.FromKey(&quot;ImageId&quot;).Value.ToString2()
                            : imageId + &quot;,&quot; +
                              selectedRow.Cells.FromKey(&quot;ImageId&quot;).Value.ToString2().ToInt32_2();
                    }
                }

                if (imageId == &quot;&quot;)
                    return false;
                else
                    return (ModuleManager.Instance.DeleteImageDetails(imageId) &gt; 0) ? true : false;
            }
            catch (Exception ex)
            {
                lblMsg.Text = ex.Message;
                return false;
            }
        }

        protected void btnClose_Click(object sender, EventArgs e)
        {
            try
            {
                string tempFolderPath = HttpContext.Current.Server.MapPath(&quot;./TempFolder&quot;).ToString2();

                if (Directory.Exists(tempFolderPath))
                {
                    foreach (string filename in Directory.GetFiles(tempFolderPath))
                        File.Delete(filename);
                }

                //if (Directory.Exists(tempFolderPath))
                //    Directory.Delete(tempFolderPath);

                Response.Redirect(&quot;~/UtilityHome.aspx&quot;, false);
            }
            catch (Exception ex)
            {
                lblMsg.Text = ex.Message;
            }
        }

        private void SetImageSize(int width, int height)
        {
            KeyValuePair&lt;int, int&gt; aspectRatio = UIHelper.RatioStretch(width, height, 250, 250);
            imgPreview.Attributes.Add(&quot;style&quot;,
                &quot;width:&quot; + aspectRatio.Key.ToString2() + &quot;px;height:&quot; +
                aspectRatio.Value.ToString2() + &quot;px&quot;);
        }

        private void ImagePreview(string fName)
        {
            string tmpAbsFName, tmpRelFName;
            imgPreview.Src = null;

            if (File.Exists(tmpAbsFName = Server.MapPath(tmpRelFName = (&quot;~/Modules/MODMGMT/TempFolder/&quot; + fName)))
                || File.Exists(tmpAbsFName = Server.MapPath(tmpRelFName = (&quot;~/Modules/MODMGMT/Images/&quot; + fName))))
            {
                var img = new Bitmap(tmpAbsFName);
                SetImageSize(img.Width, img.Height);
                img.Dispose();
                imgPreview.Src = tmpRelFName;
            }
        }

        protected void lnkAppLogo_Click(object sender, EventArgs e)
        {
            ImagePreview(lnkAppLogo.Text);
        }

        private void ChangeLogo(string type)
        {
            try
            {
                //create a temporary folder for the images
                string tempFolderPath = HttpContext.Current.Server.MapPath(&quot;./TempFolder&quot;).ToString2();

                if (!Directory.Exists(tempFolderPath))
                    Directory.CreateDirectory(tempFolderPath);

                HtmlInputFile logoFile = null;
                LinkButton lnkBtnLogo = null;

                if (type.Equals(&quot;AppLogo&quot;))
                {
                    logoFile = flAppLogo;
                    lnkBtnLogo = lnkAppLogo;
                }

                if (lnkBtnLogo != null &amp;&amp; logoFile != null)
                {
                    string filePath = logoFile.Value.ToString2();

                    if (filePath != &quot;&quot;)
                    {
                        string fileType = (Path.GetExtension(filePath));

                        if (AMP3ApplicationSettings.Instance.IsFileTypeBlocked(fileType.TrimStart(&#39;.&#39;)))
                        {
                            JavaScriptSerializer JS = new JavaScriptSerializer();
                            ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                            &quot;ShowError(&quot; + JS.Serialize(&quot;File type (&quot; + fileType + &quot;) is not supported.&quot;) + &quot;);&quot;, true);
                            return;
                        }

                        string fName = filePath.Substring(filePath.LastIndexOf(&#39;\\&#39;) + 1);
                        var sizeInbytes = (int)logoFile.PostedFile.InputStream.Length;
                        var dataBytes = new byte[sizeInbytes];

                        logoFile.PostedFile.InputStream.Read(dataBytes, 0, sizeInbytes);

                        var memStrm = new MemoryStream(dataBytes, 0, dataBytes.Length);
                        Image imgObj = Image.FromStream(memStrm);
                        // these next two lines is to fix a weird C#/.Net bug
                        imgObj.RotateFlip(RotateFlipType.Rotate180FlipNone);
                        imgObj.RotateFlip(RotateFlipType.Rotate180FlipNone);
                        imgObj.Save(tempFolderPath + &quot;\\&quot; + fName);
                        lnkBtnLogo.Text = fName;
                    }
                }
            }
            catch (Exception ex)
            {
                lblMsg.Text = ex.Message;
            }
        }

        private bool SaveLogo(string fName)
        {
            try
            {
                //create a temporary folder for the images
                string tempFolderPath = HttpContext.Current.Server.MapPath(&quot;./TempFolder&quot;).ToString2();

                if (!Directory.Exists(tempFolderPath))
                    Directory.CreateDirectory(tempFolderPath);

                if (File.Exists(tempFolderPath + &quot;\\&quot; + fName))
                {
                    File.Copy(tempFolderPath + &quot;\\&quot; + fName, Server.MapPath(&quot;~/Modules/MODMGMT/Images/&quot; + fName), true);
                    return true;
                }
            }
            catch (Exception ex)
            {
                lblMsg.Text = ex.Message;
            }
            return false;
        }

        protected void btnTestEmailServer_Click(object sender, EventArgs e)
        {
            try
            {
                Mailer.SendEmail(UserDetail.GetCurrentUserDetail().Email,
                    AMP3ApplicationSettings.Instance.AppName + &quot; Test Mail&quot;,
                    &quot;Testing email configuration.&quot;, txtAppEmailId.Text.ToString2(),
                    smtp: txtSmtpServer.Text.ToString2());
            }
            catch (Exception)
            {
                lblMsg.Text = &quot;Mail Delivery Failed!&quot;;
            }
        }

        protected void uwgAttachments_InitializeLayout(object sender, LayoutEventArgs e)
        {
            e.Layout.AllowAddNewDefault = AllowAddNew.Yes;
            e.Layout.AddNewBox.Hidden = true;
        }

        protected void ddlCulture_OnSelectedIndexChanged(object sender, EventArgs e)
        {
            CultureSpecificSettings();
        }

        private void CultureSpecificSettings()
        {
            if (ddlCulture.SelectedValue.Equals(&quot;en-IN&quot;, StringComparison.CurrentCultureIgnoreCase))
            {
                //trDateSeparator.Style.Add(&quot;display&quot;, &quot;none&quot;);
                //ddlDateSeparator.SelectedValue = &quot;-&quot;;
                ddlDigitGrouping.SelectedValue = &quot;12,34,56,789&quot;;
            }
            else
            {
                //trDateSeparator.Style.Add(&quot;display&quot;, &quot;table-row&quot;);
                ddlDigitGrouping.SelectedValue = &quot;123,456,789&quot;;
            }
        }

        protected void btnRebuildCache_Click(object sender, EventArgs e)
        {
            if (MobileCacheManager.Instance.IsMobileCacheInProgress())
            {
                ShowError(&quot;Cache building in progress, cannot rebuild now.&quot;);
            }
            else
            {
                int userId = UserDetail.GetCurrentUserDetail().UID;
                btnSave_Click(sender, e);
                Task t =
                    Task.Factory.StartNew(
                        () =&gt;
                        {
                            MobileCacheManager.Instance.RebuildCacheForSchedule(wneMobileRebuildUser.ValueInt, userId);
                        });

                lblMobileCacheMessage.Text = &quot;Cache building in progress...&quot;;
            }
        }

        protected void btnImportADUsers_Click(object sender, EventArgs e)
        {
            ADUserImport.Instance.ExecuteUserImport();
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[36,9,36,10,1],[37,13,37,91,1],[38,9,38,10,1],[40,9,40,10,1],[42,13,42,14,1],[44,17,44,95,1],[47,17,47,53,1],[48,17,48,34,1],[49,17,49,94,1],[50,17,50,89,1],[51,17,51,91,1],[52,17,52,33,1],[53,17,53,18,1],[54,21,54,72,1],[55,21,55,60,1],[56,21,56,78,1],[57,21,57,106,1],[58,21,58,66,1],[59,21,59,66,1],[60,21,60,81,1],[61,21,61,86,1],[62,21,62,73,1],[63,21,63,62,1],[64,21,64,62,1],[65,21,65,62,1],[67,21,67,62,1],[68,21,68,62,1],[70,21,70,92,1],[71,21,71,92,1],[72,21,72,93,1],[73,21,73,75,1],[75,21,75,75,1],[76,25,76,94,1],[77,21,77,71,1],[78,21,78,79,1],[79,21,79,75,1],[80,21,80,67,1],[81,21,81,67,1],[83,21,83,84,1],[84,21,84,22,1],[85,25,85,92,1],[86,25,86,51,1],[87,21,87,22,1],[89,21,89,92,1],[90,21,90,22,1],[91,25,91,100,1],[92,21,92,22,1],[94,21,95,93,1],[96,21,97,97,1],[98,21,99,95,1],[100,21,100,107,1],[101,21,101,103,1],[102,21,102,63,1],[103,21,103,106,1],[106,21,106,69,1],[107,21,107,22,1],[108,25,108,77,1],[109,25,109,32,1],[109,34,109,48,1],[109,49,109,51,1],[109,52,109,60,1],[110,29,110,111,1],[111,21,111,22,1],[113,21,113,22,0],[114,30,114,42,0],[114,44,114,73,0],[114,75,114,81,0],[115,29,115,69,0],[116,21,116,22,0],[118,21,118,70,1],[119,21,119,22,1],[120,25,120,77,1],[121,25,121,32,1],[121,34,121,47,1],[121,48,121,50,1],[121,51,121,58,1],[122,29,122,112,1],[123,21,123,22,1],[125,21,125,22,0],[126,30,126,42,0],[126,44,126,74,0],[126,76,126,82,0],[127,29,127,70,0],[128,21,128,22,0],[130,21,130,80,1],[131,21,131,63,1],[132,21,132,55,1],[133,21,133,44,1],[136,21,137,93,1],[138,21,138,22,1],[139,25,139,101,1],[140,21,140,22,1],[142,21,142,32,1],[144,21,144,51,1],[146,21,146,119,1],[147,21,147,70,1],[148,25,148,46,1],[149,21,149,70,1],[150,25,150,46,1],[151,21,151,70,1],[152,25,152,46,1],[154,21,154,113,1],[155,21,155,110,1],[157,21,157,79,1],[158,25,158,86,0],[160,21,160,22,1],[161,25,161,112,1],[162,25,162,51,1],[163,25,163,26,0],[164,29,165,108,0],[166,25,166,26,0],[167,21,167,22,1],[169,21,169,74,1],[170,21,170,67,1],[171,21,171,68,1],[172,21,172,87,1],[173,17,173,18,1],[175,17,175,52,1],[176,17,176,18,0],[177,21,177,46,0],[178,21,178,39,0],[179,17,179,18,0],[180,13,180,14,1],[181,13,181,33,0],[182,13,182,14,0],[183,17,183,42,0],[184,13,184,14,0],[185,9,185,10,1],[188,9,188,10,1],[189,13,190,114,1],[191,13,191,58,1],[192,13,192,14,0],[193,17,194,112,0],[195,17,196,103,0],[197,17,197,124,0],[198,13,198,14,0],[200,13,200,14,1],[201,17,201,52,1],[202,17,202,55,1],[203,17,203,51,1],[204,17,204,54,1],[205,17,205,61,1],[206,17,206,61,1],[207,17,207,61,1],[208,13,208,14,1],[209,9,209,10,1],[212,9,212,10,1],[213,13,213,41,1],[214,13,214,72,1],[215,13,215,78,1],[217,13,217,44,1],[218,13,218,40,1],[219,9,219,10,1],[222,9,222,10,1],[223,13,223,98,1],[224,13,224,44,1],[225,13,225,65,1],[226,13,226,71,1],[227,13,227,35,1],[227,36,227,37,1],[228,17,228,51,1],[229,17,229,52,1],[230,13,230,14,1],[231,9,231,10,1],[234,9,234,10,1],[236,13,236,14,1],[238,17,238,84,1],[240,17,240,55,1],[241,17,241,18,1],[242,21,242,53,1],[243,21,243,41,1],[244,21,244,52,1],[245,21,245,39,1],[246,21,246,53,1],[248,21,248,49,1],[249,21,249,38,1],[250,21,250,49,1],[251,21,251,53,1],[253,21,253,49,1],[254,21,254,45,1],[255,21,255,56,1],[256,21,256,53,1],[258,21,258,49,1],[259,21,259,39,1],[260,21,260,50,1],[261,21,261,53,1],[263,21,263,49,1],[264,21,264,40,1],[265,21,265,51,1],[266,21,266,53,1],[268,21,268,49,1],[269,21,269,43,1],[270,21,270,54,1],[271,21,271,39,1],[272,21,272,53,1],[274,21,274,49,1],[275,21,275,40,1],[276,21,276,51,1],[277,21,277,39,1],[278,21,278,53,1],[280,21,280,49,1],[281,21,281,38,1],[282,21,282,49,1],[283,21,283,39,1],[284,21,284,53,1],[285,17,285,18,1],[287,17,287,59,1],[289,17,289,54,1],[290,17,290,18,0],[291,21,291,28,0],[291,30,291,46,0],[291,47,291,49,0],[291,50,291,55,0],[292,21,292,22,0],[293,25,293,77,0],[294,25,294,75,0],[295,25,295,69,0],[296,25,296,83,0],[297,25,297,71,0],[298,25,299,103,0],[300,25,300,72,0],[301,25,301,70,0],[302,25,302,54,0],[303,21,303,22,0],[304,17,304,18,0],[305,13,305,14,1],[306,13,306,33,0],[307,13,307,14,0],[308,17,308,42,0],[309,13,309,14,0],[310,9,310,10,1],[313,9,313,10,1],[315,13,315,14,1],[316,17,317,128,1],[318,17,318,18,0],[319,21,319,102,0],[322,17,322,73,1],[323,17,323,18,0],[324,21,324,129,0],[326,21,326,35,0],[327,21,327,22,0],[328,25,328,144,0],[329,25,329,32,0],[331,17,331,18,0],[333,17,333,68,1],[335,17,335,58,1],[337,17,337,47,1],[338,21,338,65,0],[340,17,340,66,1],[341,17,341,67,1],[342,17,342,81,1],[343,17,343,87,1],[344,17,344,86,1],[346,17,346,51,1],[348,22,348,31,1],[348,33,348,49,1],[348,51,348,77,1],[348,79,348,82,1],[349,17,349,18,1],[350,21,350,54,1],[351,21,351,22,1],[352,25,352,70,1],[353,29,353,66,0],[355,25,355,26,1],[356,29,356,51,1],[357,33,357,53,0],[359,33,359,50,1],[360,29,360,70,1],[361,25,361,26,1],[362,21,362,22,1],[363,17,363,18,1],[364,17,364,65,1],[366,17,366,52,1],[367,22,367,31,1],[367,33,367,49,1],[367,51,367,78,1],[367,80,367,83,1],[368,17,368,18,1],[369,21,369,55,1],[370,21,370,22,1],[371,25,371,70,1],[372,29,372,67,0],[374,25,374,26,1],[375,29,375,51,1],[376,33,376,54,1],[378,33,378,50,1],[379,29,379,72,1],[380,25,380,26,1],[381,21,381,22,1],[382,17,382,18,1],[383,17,383,67,1],[386,17,386,75,1],[387,17,387,87,1],[388,17,388,60,1],[389,17,389,60,1],[390,17,390,60,1],[391,17,391,90,1],[392,17,392,89,1],[394,17,396,71,1],[397,17,399,74,1],[400,17,402,73,1],[403,17,403,167,1],[404,17,404,77,1],[405,17,405,207,1],[407,17,407,70,1],[408,17,408,79,1],[410,17,410,105,1],[411,17,411,92,1],[412,17,412,98,1],[413,17,413,75,1],[414,17,414,75,1],[415,17,415,68,1],[416,17,416,80,1],[417,21,417,92,1],[419,17,419,18,0],[420,21,420,120,0],[421,21,421,28,0],[424,17,424,63,1],[425,17,425,74,1],[426,21,429,106,0],[431,21,431,120,1],[433,17,433,105,1],[434,17,434,18,1],[435,21,435,130,1],[437,21,437,92,1],[439,21,439,63,1],[440,21,440,77,1],[441,21,441,77,1],[443,21,443,43,1],[444,21,444,22,1],[445,25,445,36,1],[448,25,448,106,1],[449,25,449,125,1],[451,25,451,56,1],[452,25,452,77,1],[453,25,453,69,1],[454,21,454,22,1],[456,25,456,53,0],[457,17,457,18,1],[459,21,459,49,0],[460,13,460,14,1],[461,13,461,33,0],[462,13,462,14,0],[463,17,463,79,0],[464,17,464,42,0],[465,13,465,14,0],[466,9,466,10,1],[469,9,469,10,1],[471,13,471,14,1],[472,17,472,39,1],[474,43,474,57,1],[475,17,475,34,1],[476,17,476,104,1],[478,17,478,55,1],[479,21,479,63,0],[481,17,481,84,1],[483,17,483,41,1],[483,42,483,54,0],[485,22,485,31,1],[485,33,485,62,1],[485,64,485,67,0],[486,17,486,18,0],[487,21,488,89,0],[489,21,489,22,0],[490,25,490,82,0],[491,25,491,96,0],[492,25,492,88,0],[493,25,493,122,0],[494,25,494,66,0],[495,25,495,83,0],[496,25,496,82,0],[497,25,497,66,0],[498,25,498,77,0],[499,25,499,77,0],[500,25,500,72,0],[502,25,502,49,0],[503,29,505,40,0],[506,21,506,22,0],[507,17,507,18,0],[508,17,508,29,1],[510,13,510,30,0],[511,13,511,14,0],[512,17,512,30,0],[514,9,514,10,1],[517,9,517,10,1],[519,13,519,14,1],[520,17,520,37,1],[522,22,522,31,1],[522,33,522,62,1],[522,64,522,67,0],[523,17,523,18,0],[524,21,525,90,0],[526,21,526,22,0],[527,25,527,75,0],[528,25,528,96,0],[530,25,533,98,0],[534,21,534,22,0],[535,17,535,18,0],[537,17,537,35,1],[538,21,538,34,1],[540,21,540,100,0],[542,13,542,33,0],[543,13,543,14,0],[544,17,544,42,0],[545,17,545,30,0],[547,9,547,10,1],[550,9,550,10,0],[552,13,552,14,0],[553,17,553,104,0],[555,17,555,54,0],[556,17,556,18,0],[557,21,557,28,0],[557,30,557,45,0],[557,46,557,48,0],[557,49,557,83,0],[558,25,558,47,0],[559,17,559,18,0],[564,17,564,64,0],[565,13,565,14,0],[566,13,566,33,0],[567,13,567,14,0],[568,17,568,42,0],[569,13,569,14,0],[570,9,570,10,0],[573,9,573,10,1],[574,13,574,97,1],[575,13,577,55,1],[578,9,578,10,1],[581,9,581,10,1],[583,13,583,35,1],[585,13,586,115,1],[587,13,587,14,1],[588,17,588,51,1],[589,17,589,53,1],[590,17,590,31,1],[591,17,591,46,1],[592,13,592,14,1],[593,9,593,10,1],[596,9,596,10,1],[597,13,597,43,1],[598,9,598,10,1],[601,9,601,10,0],[603,13,603,14,0],[605,17,605,104,0],[607,17,607,55,0],[608,21,608,63,0],[610,17,610,47,0],[611,17,611,46,0],[613,17,613,44,0],[614,17,614,18,0],[615,21,615,42,0],[616,21,616,45,0],[617,17,617,18,0],[619,17,619,60,0],[620,17,620,18,0],[621,21,621,66,0],[623,21,623,40,0],[624,21,624,22,0],[625,25,625,73,0],[627,25,627,105,0],[628,25,628,26,0],[629,29,629,82,0],[630,29,631,121,0],[632,29,632,36,0],[635,25,635,91,0],[636,25,636,87,0],[637,25,637,63,0],[639,25,639,89,0],[641,25,641,88,0],[642,25,642,66,0],[644,25,644,77,0],[645,25,645,77,0],[646,25,646,68,0],[647,25,647,49,0],[648,21,648,22,0],[649,17,649,18,0],[650,13,650,14,0],[651,13,651,33,0],[652,13,652,14,0],[653,17,653,42,0],[654,13,654,14,0],[655,9,655,10,0],[658,9,658,10,1],[660,13,660,14,1],[662,17,662,104,1],[664,17,664,55,1],[665,21,665,63,0],[667,17,667,64,1],[668,17,668,18,0],[669,21,669,121,0],[670,21,670,33,0],[672,13,672,14,1],[673,13,673,33,0],[674,13,674,14,0],[675,17,675,42,0],[676,13,676,14,0],[677,13,677,26,1],[678,9,678,10,1],[681,9,681,10,0],[683,13,683,14,0],[684,17,687,59,0],[688,13,688,14,0],[689,13,689,30,0],[690,13,690,14,0],[691,17,691,55,0],[692,13,692,14,0],[693,9,693,10,0],[696,9,696,10,0],[697,13,697,59,0],[698,13,698,46,0],[699,9,699,10,0],[702,9,702,10,0],[703,13,703,39,0],[704,9,704,10,0],[707,9,707,10,1],[708,13,708,101,1],[709,13,709,14,0],[712,17,712,65,0],[713,13,713,14,0],[715,13,715,14,1],[717,17,717,64,1],[718,13,718,14,1],[719,9,719,10,1],[722,9,722,10,0],[723,13,723,71,0],[724,13,724,14,0],[725,17,725,78,0],[726,13,726,14,0],[728,13,728,14,0],[729,17,729,68,0],[730,17,730,42,0],[731,17,734,25,0],[734,25,734,26,0],[734,26,735,29,0],[735,29,735,120,0],[735,120,736,25,0],[736,25,736,26,0],[736,26,736,28,0],[731,17,736,28,0],[738,17,738,78,0],[739,13,739,14,0],[740,9,740,10,0],[743,9,743,10,0],[744,13,744,55,0],[745,9,745,10,0]]);
    </script>
  </body>
</html>