<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Main Modules\Contract Manager\UI\Settings.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Text;
using System.Web.UI;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ContmgtDTO;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.LibraryBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using System.Web.Configuration;
using Aurigo.Brix.Platform.BusinessLayer.UserControls;
using System.Web.Script.Serialization;
using Infragistics.WebUI.UltraWebGrid;

namespace Aurigo.AMP3.ContmgtUI
{
    public partial class Settings : BrixPageBase
    {
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wnePercentage;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneAmount;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneRecAmount;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneRAbillNum;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid statusGrid;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid attribGrid;
        protected global::Infragistics.WebUI.UltraWebGrid.UltraWebGrid uwgContSettings;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneNumberFormatHidden;
        protected global::Infragistics.WebUI.WebDataInput.WebNumericEdit wnePercentFormatHidden;

        #region PEPrimeItemSource enum

        public enum PEPrimeItemSource
        {
            FromRFI = 1,
            FromItemPostings = 2
        }

        #endregion

        #region PEPrimeItems enum

        public enum PEPrimeItems
        {
            SubmittedRFI = 1,
            ApprovedRFI = 2,
            ApprovedPostings = 3,
            AllPostings = 4
        }

        #endregion

        #region PESubItemSource enum

        public enum PESubItemSource
        {
            FromItemPostings = 1,
            FromMeasurementBook = 2
        }

        #endregion

        #region PESubItems enum

        public enum PESubItems
        {
            ApprovedPostings = 1,
            AllPostings = 2,
            ApprovedMeasurementBooks = 3
        }

        #endregion

        #region RFIItemList enum

        public enum RFIItemList
        {
            ContractList = 1,
            ExecutionList = 2,
            ApprovedPostings = 3,
            AllPostings = 4
        }

        #endregion

        #region RFIItemSource enum

        public enum RFIItemSource
        {
            ContractItems = 1,
            PostingItems = 2
        }

        #endregion

        protected ModalPopupExtender PopupExtenderPrepay;
        protected ModalPopupExtender PopupExtenderRetention;
        protected LineNoControl ucLineNo;

        private string ModuleCurrency
        {
            get { return LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, Request[&quot;ContractID&quot;]); }
        }

        /// &lt;summary&gt;
        /// Gets the Project Mode : I-Integration, L-Live
        /// &lt;/summary&gt;
        private string ProjectMode
        {
            get { return (CacheManager.Instance.IsIntegrated(Request[Constants.QRY_PROJECTID].ToInt32_2()) ? &quot;I&quot; : &quot;L&quot;); }
        }

        protected override void OnInit(EventArgs e)
        {
            // set the list of permissions to be checked.
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);
            PermissionsToCheck.Add(&quot;Settings&quot;);

            hdnAmountDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT).ToString2();
            hdnPercentDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE).ToString2();
         
            if (!Page.IsPostBack)
            {
                td8.InnerText = &quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Item Source&quot;;
                rbRFIContr.Text = &quot;Restrict &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Quantity to a maximum of :&quot;;
                chkRFIReq.Text = &quot;&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Number Required while Posting&quot;;
                rbRFIPostings.Text = &quot;Restrict &quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; Quantity to a maximum of :&quot;;
            }
            base.OnInit(e);
        }

      
        protected void Page_Load(object sender, EventArgs e)
        {
            DTO contractDTO = BL.Instance.GetContract(Request[&quot;ContractID&quot;].ToInt32_2(), FetchSet.Modules);
            List&lt;string&gt; components = ModuleManagementBL.ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CONTMGT);

            // Hide Owner Tab
            if (!components.Contains(&quot;ShowOwnerTab&quot;)) 
            {
                litabOwner.Visible = false;
                litabOwner.Style.Add(&quot;display&quot;, &quot;none&quot;);
            }

            

            if (String.IsNullOrEmpty(Request[Constants.QRY_PROJECTID]))
                Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot;, true);
            if (String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
            {
                tabOwner.Visible = false;
                btnOwnerSave.Visible = false;
                HideForecastDetails(true);
                HidePIDetails();
            }

            UIHelper.DisableRoleSelection(Page);

            //(Page.Master.FindControl(&quot;form1&quot;) as HtmlForm).DefaultButton = btnBack.UniqueID;
            var featurelist = (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS];

            if (!String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
            {
                if (!featurelist.Contains(CMConstans.MODFEAT_VIEW))
                {
                    UIHelper.RedirectURL(
                        &quot;The current role does not have the required permissions to view this page.&quot;,
                        ResolveUrl(&quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;), null, Context);
                }
            }

            chkPushFRCSTtoAX.Enabled =
                chkValidatePIqty.Enabled =
                chkValidateExecutionQuantity.Enabled =
                chkValidateWorkOrderQuantity.Enabled =
                //AddNewAttribute.Enabled =
                //btnDelAtt.Enabled =
                //btnAddNewStatus.Enabled =
                //btnDelStatus.Enabled =
                btnAddSetting.Enabled =
                btnEditSetting.Enabled =
                btnDeleteSetting.Enabled =
                btnOwnerSave.Enabled =
                chkMIWithBOQ.Enabled = featurelist.Contains(Constants.MODFEAT_SETTINGS);

            //Checking wheather the user has RAB Setting permission
            //List&lt;string&gt; permissions = ModuleManager.Instance.GetPermissionByRole(&quot;WORKORD&quot;, UserDetail.GetCurrentUserDetail().RID);

            if (!featurelist.Contains(&quot;RFISetting&quot;))
                btnRFISave.Enabled = false;

            //if (!components.Contains(&quot;RequestForInspection&quot;) || !contractDTO.ContainsModule(Constants.MODID_CONTRFI))
            if (!contractDTO.ContainsModule(Constants.MODID_CONTRFI))
            {
                litabRFI.Visible = false;
            }

           

            bool isIPHidden = false, isForecastHidden = false, isPIHidden = false, isMIHidden = false, isWOIssueConditionHidden = false,
                isWOHidden = false, isCRHidden = false, isForecastSettingHidden = false, isForecastPushDetailsHidden = false;

            if (!contractDTO.ContainsModule(Constants.MODID_ITMPOST) || !contractDTO.ContainsModule(Constants.MODID_QTYPLAN))
            {
                HideItemPostingsDetails();
                isIPHidden = true;
            }
            

            if (!Page.IsPostBack)
            {
               
                BindContractNames();
                LoadContractSettings();

                if (contractDTO.ContainsModule(Constants.MODID_CONTRFI))
                    LoadRFISettings();

              

                if (!contractDTO.ContainsModule(Constants.MODID_QTYPLAN)
                    &amp;&amp; !IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.MSP))
                {
                    HideForecastSettings();
                    isForecastSettingHidden = true;
                }
                if (!IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                {
                    HideForecastDetails();
                    isForecastPushDetailsHidden = true;
                }
                if ((!IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX)) ||
                    (!contractDTO.ContainsModule(&quot;PURCIND&quot;)))
                {
                    HidePIDetails();
                    isPIHidden = true;
                }
                if ((!IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX)) ||
                    (!contractDTO.ContainsModule(&quot;MATRISS&quot;)))
                {
                    HideMISettings();
                    isMIHidden = true;
                }

                if (!contractDTO.ContainsModule(Constants.MODID_QTYPLAN))
                {
                    HideWOIssueCondition();
                    isWOIssueConditionHidden = true;
                }
                if (!contractDTO.ContainsModule(&quot;COSTVER&quot;))
                {
                    HideCostRevisionSettings();
                    isCRHidden = true;
                }

                if (!contractDTO.ContainsModule(&quot;WORKORD&quot;)
                    || (isCRHidden &amp;&amp; isWOIssueConditionHidden))
                {
                    HideWorkOrderSettings();
                    isWOHidden = true;
                }

                if (!components.Contains(&quot;Forecast&quot;) || (isForecastSettingHidden &amp;&amp; isForecastPushDetailsHidden))
                {
                    HideForecastDetails(true);
                    isForecastHidden = true;
                }

                if (!String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                {
                    DataSet dsContract = BL.Instance.GetContractDetails(Request[&quot;ContractID&quot;].ToInt32_2());
                    DataRow drContract = dsContract.Tables[0].Rows[0];
                    if (!drContract[&quot;PushFRCSTtoAX&quot;].Equals(DBNull.Value))
                        chkPushFRCSTtoAX.Checked = drContract[&quot;PushFRCSTtoAX&quot;].ToBoolean2();

                    DataRow drValidate = dsContract.Tables[2].Rows[0];
                    if (drValidate[&quot;IsForecastExists&quot;].ToInt32_2() &gt; 0)
                        rblForecastSource.Attributes.Add(&quot;disabled&quot;, &quot;true&quot;);

                    if (drValidate[&quot;IsCostRevisionExists&quot;].ToInt32_2() &gt; 0 ||
                        drValidate[&quot;IsWorkOrderExists&quot;].ToInt32_2() &gt; 0 || drValidate[&quot;IsRFIExists&quot;].ToInt32_2() &gt; 0)
                    {
                        chkValidateExecutionQuantity.Attributes.Add(&quot;disabled&quot;, &quot;true&quot;);
                        chkValidateWorkOrderQuantity.Attributes.Add(&quot;disabled&quot;, &quot;true&quot;);
                    }
                }


                if (isForecastHidden &amp;&amp; isPIHidden &amp;&amp; isMIHidden &amp;&amp; isWOHidden &amp;&amp; isCRHidden &amp;&amp; isIPHidden)
                {
                    liGeneral.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                    hdnVisibleTab.Value = &quot;A1&quot;;
                }
                else
                    hdnVisibleTab.Value = &quot;tab1&quot;;
            }
            if (!string.IsNullOrEmpty(hdnVisibleTab.Value))
                Page.ClientScript.RegisterStartupScript(GetType(), &quot;S&quot;,
                                                        @&quot;showPane(document.getElementById(document.getElementById(&#39;&quot; +
                                                        hdnVisibleTab.ClientID + &quot;&#39;).value));&quot;, true);


            PageTitle = &quot;Settings&quot;;
        }

        protected override void CreateChildControls()
        {
            EnsureChildControls();
            CreateControlCollection();
            var featurelist = (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS];

            var menus = new MenuArray();
            if (featurelist.Contains(Constants.MODFEAT_SETTINGS))
                AddSaveButton(menus);
            if ((WebConfigurationManager.AppSettings[&quot;EPSModeMultiple&quot;] == &quot;ON&quot;))
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            var featurelist = (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS];
            if (featurelist.Contains(Constants.MODFEAT_SETTINGS))
                if (HasSaveButton)
                {
                    Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        lnkSave.Click += btnSaveForm_Click;                      
                    }
                }
            if ((WebConfigurationManager.AppSettings[&quot;EPSModeMultiple&quot;] == &quot;ON&quot;))
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += btnBack_Click;
        }

        private void HidePIDetails()
        {
            trPurchaseIndentSettings1.Style.Value = &quot;display:none;&quot;;
            trPurchaseIndentSettings2.Style.Value = &quot;display:none;&quot;;
            trPurchaseIndentSettings3.Style.Value = &quot;display:none;&quot;;
            trPurchaseIndentSettings4.Style.Value = &quot;display:none;&quot;;
        }

        private void HideForecastDetails(bool IsHideSetting = false)
        {
            if (IsHideSetting)
            {
                HideForecastSettings();
            }
            trForecastSettings3.Style.Value = &quot;display:none;&quot;;
            trForecastSettings4.Style.Value = &quot;display:none;&quot;;
        }

        private void HideForecastSettings()
        {
            trForecastSettings1.Style.Value = &quot;display:none;&quot;;
            trForecastSettings2.Style.Value = &quot;display:none;&quot;;
            trForecastSettings5.Style.Value = &quot;display:none;&quot;;
            trForecastSettings6.Style.Value = &quot;display:none;&quot;;
        }

        private void HideItemPostingsDetails()
        {
            trIPSettings1.Style.Value = &quot;display:none&quot;;
            trIPSettings2.Style.Value = &quot;display:none&quot;;
            trIPSettings3.Style.Value = &quot;display:none&quot;;
            trIPSettings4.Style.Value = &quot;display:none&quot;;
        }

        private void HideWorkOrderSettings()
        {
            trWorkOrderSettings1.Style.Value = &quot;display:none&quot;;
            trWorkOrderSettings2.Style.Value = &quot;display:none&quot;;
            HideWOIssueCondition();

            trWorkOrderSettings5.Style.Value = &quot;display:none&quot;;
        }

        private void HideWOIssueCondition()
        {
            trWorkOrderSettings3.Style.Value = &quot;display:none&quot;;
            trWorkOrderSettings4.Style.Value = &quot;display:none&quot;;
        }

        private void HideMISettings()
        {
            trMISettings1.Style.Value = &quot;display:none&quot;;
            trMISettings2.Style.Value = &quot;display:none&quot;;
        }

        private void HideCostRevisionSettings()
        {
            trWorkOrderSettings5.Style.Value = &quot;display:none&quot;;
            trExecutionQuantitySettings1.Style.Value = &quot;display:none&quot;;
            trExecutionQuantitySettings2.Style.Value = &quot;display:none&quot;;
            trExecutionQuantitySettings3.Style.Value = &quot;display:none&quot;;
            trExecutionQuantitySettings4.Style.Value = &quot;display:none&quot;;
            trRFIExecutionQty.Style.Value = &quot;display:none&quot;;
        }

        private void BindContractNames()
        {
            DataTable dt = BL.Instance.GetContractNames(Request[Constants.QRY_PROJECTID].ToInt32_2());
            if (dt.Rows.Count &gt; 0)
            {
                ddlContracts.DataSource = dt;
                ddlContracts.DataTextField = &quot;Name&quot;;
                ddlContracts.DataValueField = &quot;ContractID&quot;;
                ddlContracts.DataBind();
            }
            ddlContracts.Items.Insert(0, new ListItem(&quot;Select One&quot;));
        }

        //protected void PopulateLibraryDDL()
        //{
        //    Dictionary&lt;int, string&gt; catalogs = BL.Instance.GetLibraryCatalogs(&quot;Common&quot;);

        //    foreach (var item in catalogs)
        //    {
        //        ddlLibrary.Items.Add(new ListItem(item.Value, item.Key.ToString2()));
        //    }

        //    ddlLibrary.Items.Insert(0, new ListItem(&quot;Select&quot;, &quot;Select&quot;));
        //    ddlType.Attributes.Add(&quot;onchange&quot;, &quot;fnShowLib()&quot;);
        //}

        protected void btnSave_Click(object sender, EventArgs e)
        {
            try
            {
                int? start = null, incr = null;
                try
                {
                    if (!String.IsNullOrEmpty(txtLineStart.Text))
                        start = txtLineStart.Text.ToInt32_2();
                }
                catch
                {
                    throw new Exception(@&quot;Please enter a numeric value for &#39;Line No Start&#39;.&quot;);
                }

                try
                {
                    if (!String.IsNullOrEmpty(txtLineIncre.Text))
                        incr = txtLineIncre.Text.ToInt32_2();
                }
                catch
                {
                    throw new Exception(@&quot;Please enter a numeric value for &#39;Line No Increment By&#39;.&quot;);
                }
                if (incr != null &amp;&amp; incr &lt; 0)
                    throw new Exception(&quot;Please enter a positive number for &#39;Line No Increment By&#39;.&quot;);

                BL.Instance.SaveLineNoSettings(ddlContracts.SelectedValue.ToInt32_2(),
                                               txtPrefix.Text, start, incr, txtSeperator.Text);

                LoadContractSettings();
                lblLineNoSettingsMsg.Text = &quot;Line No. Setting successfully saved.&quot;;
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;, &quot;ShowError(&quot; + JS.Serialize(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;)) + &quot;);&quot;, true);
            }
        }

        protected void btnDeleteSetting_Click(object sender, EventArgs e)
        {
            int id;
            try
            {
                id = uwgContSettings.DisplayLayout.SelectedRows[0].Cells.FromKey(&quot;ID&quot;).Text.ToInt32_2();
            }
            catch
            {
                throw new Exception(&quot;Please select a Line No. Setting.&quot;);
            }
            try
            {
                BL.Instance.DeleteLineNoSetting(id);
                LoadContractSettings();
                lblLineNoSettingsMsg.Text = &quot;Line No. Setting successfully deleted.&quot;;
            }
            catch
            {
            }
        }

        // Loads the settings of the Contract
        private void LoadContractSettings()
        {
            DataTable dtTemp = BL.Instance.GetContractSettings(Request[Constants.QRY_PROJECTID].ToInt32_2());

            if (dtTemp.Rows.Count &gt; 0)
            {
                uwgContSettings.DataSource = dtTemp;
                uwgContSettings.DataBind();

                uwgContSettings.Columns.FromKey(&quot;ID&quot;).Hidden = true;
                uwgContSettings.Columns.FromKey(&quot;ContractID&quot;).Hidden = true;


                foreach (UltraGridColumn col in uwgContSettings.Columns)
                {
                    col.HTMLEncodeContent = true;
                }
            }
            else
            {
                uwgContSettings.Columns.Clear();
                uwgContSettings.DisplayLayout.NoDataMessage = &quot;No settings to display.&quot;;
            }

            if (!String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
            {
                dtTemp.Clear();
                // Owner Details
                dtTemp = BL.Instance.GetOwnerDetails(Request[&quot;ContractID&quot;].ToInt32_2());
                if (dtTemp.Rows.Count &gt; 0)
                {
                    txtAddr1.Text = dtTemp.Rows[0][&quot;Address1&quot;].ToString();
                    txtAddr2.Text = dtTemp.Rows[0][&quot;Address2&quot;].ToString();
                    txtAddr3.Text = dtTemp.Rows[0][&quot;Address3&quot;].ToString();
                    txtCity.Text = dtTemp.Rows[0][&quot;City&quot;].ToString();
                    txtEmail.Text = dtTemp.Rows[0][&quot;Email&quot;].ToString();
                    txtFax.Text = dtTemp.Rows[0][&quot;Fax&quot;].ToString();
                    txtPh.Text = dtTemp.Rows[0][&quot;Phone&quot;].ToString();
                    txtState.Text = dtTemp.Rows[0][&quot;State&quot;].ToString();
                    txtZip.Text = dtTemp.Rows[0][&quot;ZipCode&quot;].ToString();
                    txtOwnName.Text = dtTemp.Rows[0][&quot;Name&quot;].ToString();
                    chkValidatePIqty.Checked = bool.Parse(dtTemp.Rows[0][&quot;ValidatePIQty&quot;].ToString());
                    chkValidateExecutionQuantity.Checked = bool.Parse(dtTemp.Rows[0][&quot;ValidateExecQty&quot;].ToString());
                    chkValidateWorkOrderQuantity.Checked = bool.Parse(dtTemp.Rows[0][&quot;ValidateWOQty&quot;].ToString());
                    rblForecastSource.SelectedValue = dtTemp.Rows[0][&quot;ForecastSource&quot;].ToString();
                    rblIPCriterion.SelectedValue = dtTemp.Rows[0][&quot;ItemPostingCriterion&quot;].ToString();
                    rblWOCriterion.SelectedValue = dtTemp.Rows[0][&quot;WorkOrderCriterion&quot;].ToString();
                    chkMIWithBOQ.Checked = bool.Parse(dtTemp.Rows[0][&quot;MIWithBOQ&quot;].ToString());


                    DataSet ds = BL.Instance.GetRecordsCount(&quot;MATRISS&quot;, Convert.ToInt32(Request[&quot;ContractID&quot;]));
                    if (ds != null)
                    {
                        if (Convert.ToInt32(ds.Tables[0].Rows[0][0]) &gt; 0)
                            chkMIWithBOQ.Enabled = false;
                    }
                }
            }
        }

        private void LoadRFISettings()
        {
            ucLineNo.ModuleID = &quot;CONTRFI&quot;;
            int contractId = 0;
            if (!String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
            {
                contractId = Request[&quot;ContractID&quot;].ToInt32_2();
            }
            ucLineNo.ParentInstanceID = contractId;
            ucLineNo.HideIncrement = true;
            DataTable dtTemp = BL.Instance.GetRFISettings(contractId);

            if (dtTemp.Rows.Count &gt; 0)
            {
                if ((RFIItemSource)dtTemp.Rows[0][&quot;ItemSource&quot;] == RFIItemSource.ContractItems)
                {
                    rbRFIContr.Checked = true;
                    if ((RFIItemList)dtTemp.Rows[0][&quot;Items&quot;] == RFIItemList.ContractList)
                        rbRFIContrList.Checked = true;
                    else
                        rbRFIExecutionList.Checked = true;
                    chkRFIReq.Checked = dtTemp.Rows[0][&quot;IsReqForPosting&quot;].ToBoolean2();
                }
                else
                {
                    rbRFIPostings.Checked = true;
                    if ((RFIItemList)dtTemp.Rows[0][&quot;Items&quot;] == RFIItemList.ApprovedPostings)
                        rbRFIPostingApproved.Checked = true;
                    else
                        rbRFIPostingAll.Checked = true;
                }
            }
        }

        protected void btnBack_Click(object sender, EventArgs e)
        {
            Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID]);
        }

        protected void btnSaveForm_Click(object sender, EventArgs e)
        {
            if (!String.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
            {
                try
                {
                    string finalMsg = string.Empty;
                   // Need not call this if owner tab is hidden.
                    if (litabOwner.Visible)
                    {
                        btnOwnerSave_Click(sender, e);

                    if (!lblMessage.Text.Equals(&quot;Saved Successfully&quot;))
                        finalMsg += &quot;Owner details save failed.&quot;;
                    else
                        finalMsg += &quot;Owner details saved successfully.&quot;;
                    }

                    if (litabRFI.Visible)
                    {
                        btnRFISave_Click(sender, e);
                        if (!lblMessage.Text.ToLower2().Contains(&quot;saved successfully&quot;))
                            finalMsg += &quot;\n&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; settings save failed. Exception : &quot; + lblMessage.Text;
                        else finalMsg += &quot;\n&quot; + LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;) + &quot; settings saved successfully.&quot;;
                    }
                   
                    SaveModuleSettingsData();

                    string query = &quot;UPDATE CONTMGTMaster SET PushFRCSTtoAX = {0} WHERE [ID] = {1}&quot;;
                    ComponentHelper.Instance.ExecuteNonQuery(query, chkPushFRCSTtoAX.Checked, Request[&quot;ContractID&quot;]);

                    if (!lblMessage.Text.ToLower2().Contains(&quot;saved successfully&quot;))
                        throw new Exception(finalMsg);
                    else
                        ShowNotificationMessage(finalMsg,NotificationType.Success);
                }
                catch (Exception ex)
                {
                    JavaScriptSerializer JS = new JavaScriptSerializer();
                    Page.ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                                            &quot;&lt;script language=javascript&gt;ShowError(&quot; + JS.Serialize(ex.Message.Replace(&quot;#&quot;, &quot;\n#&quot;).Replace(&quot;|&quot;, &quot;\\n&quot;)) +
                                                            &quot;);&lt;/script&gt;&quot;);
                }
                finally
                {
                    lblMessage.Text = string.Empty;
                }
            }
            //Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=CONTMGT&amp;PID=&quot; + Request[Constants.QRY_PROJECTID]);
            
        }

        private void SaveModuleSettingsData()
        {
            var sb = new StringBuilder(&quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;\n&lt;XMLROOT&gt;\n&lt;Owner&gt;\n&quot;);
            sb.AppendFormat(&quot;&lt;ValidatePIQty&gt;{0}&lt;/ValidatePIQty&gt;\n&quot;,
                            UIHelper.ReplaceXMLCharEntities(chkValidatePIqty.Checked.ToString()));
            sb.AppendFormat(&quot;&lt;ForecastSource&gt;{0}&lt;/ForecastSource&gt;\n&quot;,
                            UIHelper.ReplaceXMLCharEntities(rblForecastSource.SelectedValue));
            sb.AppendFormat(&quot;&lt;ItemPostingCriterion&gt;{0}&lt;/ItemPostingCriterion&gt;\n&quot;,
                            UIHelper.ReplaceXMLCharEntities(rblIPCriterion.SelectedValue));
            sb.AppendFormat(&quot;&lt;MIWithBOQ&gt;{0}&lt;/MIWithBOQ&gt;\n&quot;,
                            UIHelper.ReplaceXMLCharEntities(chkMIWithBOQ.Checked.ToString()));
            sb.AppendFormat(&quot;&lt;WorkOrderCriterion&gt;{0}&lt;/WorkOrderCriterion&gt;\n&quot;,
                            UIHelper.ReplaceXMLCharEntities(rblWOCriterion.SelectedValue));
            sb.AppendFormat(&quot;&lt;ValidateExecQty&gt;{0}&lt;/ValidateExecQty&gt;\n&quot;,
                            UIHelper.ReplaceXMLCharEntities(chkValidateExecutionQuantity.Checked.ToString()));
            sb.AppendFormat(&quot;&lt;ValidateWOQty&gt;{0}&lt;/ValidateWOQty&gt;\n&lt;/Owner&gt;\n&lt;/XMLROOT&gt;&quot;,
                            UIHelper.ReplaceXMLCharEntities(chkValidateWorkOrderQuantity.Checked.ToString()));

            BL.Instance.SaveModuleSettingsData(Request[&quot;ContractID&quot;].ToInt32_2(), sb.ToString());
        }

        protected void btnOwnerSave_Click(object sender, EventArgs e)
        {
            var sb = new StringBuilder(&quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;\n&lt;XMLROOT&gt;\n&lt;Owner&gt;\n&quot;);
            sb.AppendFormat(&quot;&lt;Name&gt;{0}&lt;/Name&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtOwnName.Text));
            sb.AppendFormat(&quot;&lt;Address1&gt;{0}&lt;/Address1&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtAddr1.Text));
            sb.AppendFormat(&quot;&lt;Address2&gt;{0}&lt;/Address2&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtAddr2.Text));
            sb.AppendFormat(&quot;&lt;Address3&gt;{0}&lt;/Address3&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtAddr3.Text));
            sb.AppendFormat(&quot;&lt;City&gt;{0}&lt;/City&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtCity.Text));
            sb.AppendFormat(&quot;&lt;Email&gt;{0}&lt;/Email&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtEmail.Text));
            sb.AppendFormat(&quot;&lt;Fax&gt;{0}&lt;/Fax&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtFax.Text));
            sb.AppendFormat(&quot;&lt;Phone&gt;{0}&lt;/Phone&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtPh.Text));
            sb.AppendFormat(&quot;&lt;State&gt;{0}&lt;/State&gt;\n&quot;, UIHelper.ReplaceXMLCharEntities(txtState.Text));
            sb.AppendFormat(&quot;&lt;ZipCode&gt;{0}&lt;/ZipCode&gt;\n&lt;/Owner&gt;\n&lt;/XMLROOT&gt;&quot;, UIHelper.ReplaceXMLCharEntities(txtZip.Text));

            BL.Instance.SaveSettings(Request[&quot;ContractID&quot;].ToInt32_2(), sb.ToString());
            lblMessage.Text = &quot;Saved Successfully&quot;;
            //btnBack_Click(sender, e);
        }

        protected void btnRFISave_Click(object sender, EventArgs e)
        {
            try
            {
                ucLineNo.ModuleID = &quot;CONTRFI&quot;;
                ucLineNo.ParentInstanceID = Request[&quot;ContractID&quot;].ToInt32_2();
                ucLineNo.ValidateSetting();
                int itemSource = (rbRFIContr.Checked)
                                     ? (int)RFIItemSource.ContractItems
                                     : (int)RFIItemSource.PostingItems;
                int rfiItems = (rbRFIContr.Checked)
                                   ? (rbRFIContrList.Checked
                                          ? (int)RFIItemList.ContractList
                                          : (int)RFIItemList.ExecutionList)
                                   : (rbRFIPostingApproved.Checked
                                          ? (int)RFIItemList.ApprovedPostings
                                          : (int)RFIItemList.AllPostings);
                bool isReqForPosting = (rbRFIContr.Checked) ? ((chkRFIReq.Checked) ? true : false) : false;

                string result = BL.Instance.SaveRFISettings(Request[&quot;ContractID&quot;].ToInt32_2(), itemSource, rfiItems,
                                                            isReqForPosting);
                if (result.Equals(&quot;LOC_RFI Settings saved successfully&quot;))
                {
                    ucLineNo.SaveLineNoSettings();
                }
               // lblMessage.Text = result.Replace(&quot;LOC_RFI&quot;, LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;));
                ShowNotificationMessage(result.Replace(&quot;LOC_RFI&quot;, LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;)), NotificationType.Success);
            }
            catch (Exception ex)
            {
                //lblMessage.Text = ex.Message.Replace(&quot;LOC_RFI&quot;, LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;));
                ShowNotificationMessage( ex.Message.Replace(&quot;LOC_RFI&quot;, LocalizationManager.GetString(&quot;LOC_RequestForInspection&quot;)), NotificationType.Success);
            }
        }


        /// &lt;summary&gt;
        /// Converts Datatable to XML
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dt&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string ToStringAsXml(DataTable dt)
        {
            var sw = new StringWriter();
            dt.WriteXml(sw, XmlWriteMode.IgnoreSchema);
            string s = sw.ToString();
            return s;
        }

        /// &lt;summary&gt;
        /// Converting Row collection to DataTable.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dt&quot;&gt;&lt;/param&gt;
        private DataTable GetDataTable(DataRow[] drs, DataTable dt)
        {
            var dtTemp = new DataTable();
            dtTemp = dt.Clone();
            foreach (DataRow dr in drs)
                dtTemp.Rows.Add(dr.ItemArray);

            return dtTemp;
        }

        /// &lt;summary&gt;
        /// Generates the Sl No
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dtToGenerate&quot;&gt;&lt;/param&gt;
        private void GenerateSerialNo(DataTable dtToGenerate)
        {
            int count = 1;
            foreach (DataRow row in dtToGenerate.Rows)
            {
                row.BeginEdit();
                row[&quot;SNo&quot;] = count.ToString2();
                row.EndEdit();
                row.AcceptChanges();
                count++;
            }
        }

        private string GetMode(string modeValue)
        {
            if (modeValue.ToLower2() == &quot;true&quot; || modeValue == &quot;1&quot;)
                return &quot;1&quot;;
            else
                return &quot;0&quot;;
        }

        public override int GetProjectIdFromInstanceId()
        {
            if (!string.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                return BL.Instance.GetPIDFromContractId(Request[&quot;ContractID&quot;].ToInt32_2());
            else
                return -1;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[109,17,109,18,0],[109,19,109,112,0],[109,113,109,114,0],[117,17,117,18,0],[117,19,117,121,0],[117,122,117,123,0],[121,9,121,10,0],[123,13,123,66,0],[124,13,124,48,0],[126,13,126,138,0],[127,13,127,143,0],[129,13,129,34,0],[130,13,130,14,0],[131,17,131,113,0],[132,17,132,139,0],[133,17,133,132,0],[134,17,134,142,0],[135,13,135,14,0],[136,13,136,28,0],[137,9,137,10,0],[141,9,141,10,0],[142,13,142,108,0],[143,13,143,127,0],[146,13,146,54,0],[147,13,147,14,0],[148,17,148,44,0],[149,17,149,57,0],[150,13,150,14,0],[154,13,154,72,0],[155,17,155,92,0],[156,13,156,61,0],[157,13,157,14,0],[158,17,158,42,0],[159,17,159,46,0],[160,17,160,43,0],[161,17,161,33,0],[162,13,162,14,0],[164,13,164,49,0],[167,13,167,89,0],[169,13,169,62,0],[170,13,170,14,0],[171,17,171,68,0],[172,17,172,18,0],[173,21,175,98,0],[176,17,176,18,0],[177,13,177,14,0],[179,13,191,89,0],[196,13,196,53,0],[197,17,197,44,0],[200,13,200,70,0],[201,13,201,14,0],[202,17,202,42,0],[203,13,203,14,0],[207,13,207,36,0],[207,38,207,62,0],[207,64,207,82,0],[207,84,207,102,0],[207,104,207,136,0],[208,17,208,35,0],[208,37,208,55,0],[208,57,208,88,0],[208,90,208,125,0],[210,13,210,126,0],[211,13,211,14,0],[212,17,212,43,0],[213,17,213,35,0],[214,13,214,14,0],[217,13,217,34,0],[218,13,218,14,0],[220,17,220,37,0],[221,17,221,40,0],[223,17,223,73,0],[224,21,224,39,0],[228,17,229,112,0],[230,17,230,18,0],[231,21,231,44,0],[232,21,232,52,0],[233,17,233,18,0],[234,17,234,108,0],[235,17,235,18,0],[236,21,236,43,0],[237,21,237,56,0],[238,17,238,18,0],[239,17,240,62,0],[241,17,241,18,0],[242,21,242,37,0],[243,21,243,39,0],[244,17,244,18,0],[245,17,246,62,0],[247,17,247,18,0],[248,21,248,38,0],[249,21,249,39,0],[250,17,250,18,0],[252,17,252,74,0],[253,17,253,18,0],[254,21,254,44,0],[255,21,255,53,0],[256,17,256,18,0],[257,17,257,60,0],[258,17,258,18,0],[259,21,259,48,0],[260,21,260,39,0],[261,17,261,18,0],[263,17,264,65,0],[265,17,265,18,0],[266,21,266,45,0],[267,21,267,39,0],[268,17,268,18,0],[270,17,270,114,0],[271,17,271,18,0],[272,21,272,47,0],[273,21,273,45,0],[274,17,274,18,0],[276,17,276,66,0],[277,17,277,18,0],[278,21,278,108,0],[279,21,279,71,0],[280,21,280,75,0],[281,25,281,93,0],[283,21,283,71,0],[284,21,284,72,0],[285,25,285,78,0],[287,21,288,118,0],[289,21,289,22,0],[290,25,290,89,0],[291,25,291,89,0],[292,21,292,22,0],[293,17,293,18,0],[296,17,296,108,0],[297,17,297,18,0],[298,21,298,78,0],[299,21,299,48,0],[300,17,300,18,0],[302,21,302,50,0],[303,13,303,14,0],[304,13,304,60,0],[305,17,307,103,0],[310,13,310,36,0],[311,9,311,10,0],[314,9,314,10,0],[315,13,315,35,0],[316,13,316,39,0],[317,13,317,89,0],[319,13,319,41,0],[320,13,320,66,0],[321,17,321,38,0],[322,13,322,82,0],[323,13,323,82,0],[324,13,324,44,0],[325,9,325,10,0],[328,9,328,10,0],[329,13,329,89,0],[330,13,330,66,0],[331,17,331,35,0],[332,17,332,18,0],[333,21,333,82,0],[334,21,334,41,0],[335,21,335,22,0],[336,25,336,60,0],[337,21,337,22,0],[338,17,338,18,0],[339,13,339,82,0],[340,13,340,78,0],[341,9,341,10,0],[344,9,344,10,0],[345,13,345,69,0],[346,13,346,69,0],[347,13,347,69,0],[348,13,348,69,0],[349,9,349,10,0],[352,9,352,10,0],[353,13,353,31,0],[354,13,354,14,0],[355,17,355,40,0],[356,13,356,14,0],[357,13,357,63,0],[358,13,358,63,0],[359,9,359,10,0],[362,9,362,10,0],[363,13,363,63,0],[364,13,364,63,0],[365,13,365,63,0],[366,13,366,63,0],[367,9,367,10,0],[370,9,370,10,0],[371,13,371,56,0],[372,13,372,56,0],[373,13,373,56,0],[374,13,374,56,0],[375,9,375,10,0],[378,9,378,10,0],[379,13,379,63,0],[380,13,380,63,0],[381,13,381,36,0],[383,13,383,63,0],[384,9,384,10,0],[387,9,387,10,0],[388,13,388,63,0],[389,13,389,63,0],[390,9,390,10,0],[393,9,393,10,0],[394,13,394,56,0],[395,13,395,56,0],[396,9,396,10,0],[399,9,399,10,0],[400,13,400,63,0],[401,13,401,71,0],[402,13,402,71,0],[403,13,403,71,0],[404,13,404,71,0],[405,13,405,60,0],[406,9,406,10,0],[409,9,409,10,0],[410,13,410,103,0],[411,13,411,35,0],[412,13,412,14,0],[413,17,413,46,0],[414,17,414,53,0],[415,17,415,60,0],[416,17,416,41,0],[417,13,417,14,0],[418,13,418,70,0],[419,9,419,10,0],[435,9,435,10,0],[437,13,437,14,0],[438,17,438,34,0],[438,36,438,47,0],[440,17,440,18,0],[441,21,441,66,0],[442,25,442,63,0],[443,17,443,18,0],[444,17,444,22,0],[445,17,445,18,0],[446,21,446,95,0],[450,17,450,18,0],[451,21,451,66,0],[452,25,452,62,0],[453,17,453,18,0],[454,17,454,22,0],[455,17,455,18,0],[456,21,456,102,0],[458,17,458,46,0],[459,21,459,103,0],[461,17,462,96,0],[464,17,464,40,0],[465,17,465,84,0],[466,13,466,14,0],[467,13,467,33,0],[468,13,468,14,0],[469,17,469,70,0],[470,17,470,150,0],[471,13,471,14,0],[472,9,472,10,0],[475,9,475,10,0],[478,13,478,14,0],[479,17,479,105,0],[480,13,480,14,0],[481,13,481,18,0],[482,13,482,14,0],[483,17,483,74,0],[486,13,486,14,0],[487,17,487,53,0],[488,17,488,40,0],[489,17,489,86,0],[490,13,490,14,0],[491,13,491,18,0],[492,13,492,14,0],[493,13,493,14,0],[494,9,494,10,0],[498,9,498,10,0],[499,13,499,110,0],[501,13,501,39,0],[502,13,502,14,0],[503,17,503,53,0],[504,17,504,44,0],[506,17,506,69,0],[507,17,507,77,0],[510,17,510,24,0],[510,26,510,45,0],[510,46,510,48,0],[510,49,510,72,0],[511,17,511,18,0],[512,21,512,50,0],[513,17,513,18,0],[514,13,514,14,0],[516,13,516,14,0],[517,17,517,49,0],[518,17,518,89,0],[519,13,519,14,0],[521,13,521,62,0],[522,13,522,14,0],[523,17,523,32,0],[525,17,525,89,0],[526,17,526,43,0],[527,17,527,18,0],[528,21,528,75,0],[529,21,529,75,0],[530,21,530,75,0],[531,21,531,70,0],[532,21,532,72,0],[533,21,533,68,0],[534,21,534,69,0],[535,21,535,72,0],[536,21,536,72,0],[537,21,537,73,0],[538,21,538,103,0],[539,21,539,117,0],[540,21,540,115,0],[541,21,541,99,0],[542,21,542,102,0],[543,21,543,100,0],[544,21,544,95,0],[547,21,547,113,0],[548,21,548,36,0],[549,21,549,22,0],[550,25,550,74,0],[551,29,551,58,0],[552,21,552,22,0],[553,17,553,18,0],[554,13,554,14,0],[555,9,555,10,0],[558,9,558,10,0],[559,13,559,43,0],[560,13,560,32,0],[561,13,561,62,0],[562,13,562,14,0],[563,17,563,64,0],[564,13,564,14,0],[565,13,565,52,0],[566,13,566,43,0],[567,13,567,71,0],[569,13,569,39,0],[570,13,570,14,0],[571,17,571,96,0],[572,17,572,18,0],[573,21,573,47,0],[574,21,574,90,0],[575,25,575,55,0],[577,25,577,59,0],[578,21,578,88,0],[579,17,579,18,0],[581,17,581,18,0],[582,21,582,50,0],[583,21,583,94,0],[584,25,584,61,0],[586,25,586,56,0],[587,17,587,18,0],[588,13,588,14,0],[589,9,589,10,0],[592,9,592,10,0],[593,13,593,117,0],[594,9,594,10,0],[597,9,597,10,0],[598,13,598,62,0],[599,13,599,14,0],[601,17,601,18,0],[602,21,602,52,0],[604,21,604,44,0],[605,21,605,22,0],[606,25,606,55,0],[608,21,608,71,0],[609,25,609,66,0],[611,25,611,73,0],[612,21,612,22,0],[614,21,614,42,0],[615,21,615,22,0],[616,25,616,53,0],[617,25,617,88,0],[618,29,618,164,0],[619,30,619,141,0],[620,21,620,22,0],[622,21,622,46,0],[624,21,624,100,0],[625,21,625,118,0],[627,21,627,84,0],[628,25,628,55,0],[630,25,630,84,0],[631,17,631,18,0],[632,17,632,37,0],[633,17,633,18,0],[634,21,634,74,0],[635,21,637,76,0],[638,17,638,18,0],[640,17,640,18,0],[641,21,641,52,0],[642,17,642,18,0],[643,13,643,14,0],[646,9,646,10,0],[649,9,649,10,0],[650,13,650,90,0],[651,13,652,99,0],[653,13,654,95,0],[655,13,656,92,0],[657,13,658,95,0],[659,13,660,92,0],[661,13,662,111,0],[663,13,664,111,0],[666,13,666,98,0],[667,9,667,10,0],[670,9,670,10,0],[671,13,671,90,0],[672,13,672,101,0],[673,13,673,107,0],[674,13,674,107,0],[675,13,675,107,0],[676,13,676,98,0],[677,13,677,101,0],[678,13,678,95,0],[679,13,679,98,0],[680,13,680,101,0],[681,13,681,123,0],[683,13,683,88,0],[684,13,684,52,0],[686,9,686,10,0],[689,9,689,10,0],[691,13,691,14,0],[692,17,692,47,0],[693,17,693,79,0],[694,17,694,44,0],[695,17,697,72,0],[698,17,704,75,0],[705,17,705,108,0],[707,17,708,78,0],[709,17,709,74,0],[710,17,710,18,0],[711,21,711,51,0],[712,17,712,18,0],[714,17,714,153,0],[715,13,715,14,0],[716,13,716,33,0],[717,13,717,14,0],[719,17,719,158,0],[720,13,720,14,0],[721,9,721,10,0],[730,9,730,10,0],[731,13,731,41,0],[732,13,732,56,0],[733,13,733,38,0],[734,13,734,22,0],[735,9,735,10,0],[742,9,742,10,0],[743,13,743,42,0],[744,13,744,33,0],[745,13,745,20,0],[745,22,745,32,0],[745,33,745,35,0],[745,36,745,39,0],[746,17,746,47,0],[748,13,748,27,0],[749,9,749,10,0],[756,9,756,10,0],[757,13,757,27,0],[758,13,758,20,0],[758,22,758,33,0],[758,34,758,36,0],[758,37,758,54,0],[759,13,759,14,0],[760,17,760,33,0],[761,17,761,48,0],[762,17,762,31,0],[763,17,763,37,0],[764,17,764,25,0],[765,13,765,14,0],[766,9,766,10,0],[769,9,769,10,0],[770,13,770,68,0],[771,17,771,28,0],[773,17,773,28,0],[774,9,774,10,0],[777,9,777,10,0],[778,13,778,62,0],[779,17,779,92,0],[781,17,781,27,0],[782,9,782,10,0]]);
    </script>
  </body>
</html>