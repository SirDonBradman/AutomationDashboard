<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\WORKFLW\BrixWorkflowNew.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Services;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Common;
using Aurigo.Workflow;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.AMP3.DataAccess.Core;
using System.Json;
using System.Text;
using System.Xml;
using System.Web.Script.Serialization;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Evaluator;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.Platform.BusinessLayer.XmlForm_Framework;
using System.Xml.Linq;
using System.IO;
using Aurigo.Brix.Platform.BusinessLayer.Controller;
using System.Net.Http;
using Aurigo.AMP3.UserManagementBL;
using System.Web.UI.HtmlControls;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.AMP3.Core.BusinessLayer.BL;

namespace Aurigo.Brix.Platform.UI.Modules.WORKFLW
{
    public partial class BrixWorkflowNew : BrixPageBase
    {
        private static Dictionary&lt;string, WorkflowDetails&gt; _dictWorkflowDetails = new Dictionary&lt;string, WorkflowDetails&gt;();
        private WorkflowDetails _workflowDetails = new WorkflowDetails();

        public override void InclueScriptAndStyleFiles()
        {
            base.InclueScriptAndStyleFiles();
            AddScriptsAndStyles(this, true);
        }

        public static void AddScriptsAndStyles(BrixPageBase pageBase, bool isEditor)
        {
            pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/css/application.css&quot;);
            pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/css/contextmenu.css&quot;);
            pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/css/bootstrap.min.css&quot;);
            pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/css/bootstrap-theme.min.css&quot;);

            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/Scripts/lib/bootstrap.min.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/Scripts/lib/parsley.min.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/patched_raphael.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/jquery.contextmenu.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/autoresize.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/shifty.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/rgbcolor.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/patched_canvg.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/patched_Class.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/draw2d.js&quot;);
            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/pathfinding-browser.min.js&quot;);

            pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/Scripts/app/bundle.workflow.*.js&quot;);
            // Add Code Action Module Component is Active.
            List&lt;string&gt; workflowComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_WORKFLW);
            if (workflowComponents.Contains(&quot;CodeAction&quot;))
            {
                if (isEditor)
                {
                    pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/lib/codemirror.css&quot;);
                    pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/dialog/dialog.css&quot;);
                    pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/hint/show-hint.css&quot;);
                    pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/tern/tern.css&quot;);
                    pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/theme/lesser-dark.css&quot;);
                    pageBase.RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/foldgutter.css&quot;);

                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/lib/codemirror.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/mode/javascript/javascript.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/dialog/dialog.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/hint/show-hint.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/tern/tern.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/selection/active-line.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/edit/matchbrackets.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/edit/closebrackets.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/search/searchcursor.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/search/search.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/foldcode.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/foldgutter.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/brace-fold.js&quot;);

                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/node_modules/acorn/dist/acorn.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/node_modules/acorn/dist/acorn_loose.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/node_modules/acorn/dist/walk.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/doc/demo/polyfill.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/lib/signal.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/lib/tern.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/lib/def.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/lib/comment.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/lib/infer.js&quot;);
                    pageBase.RegisterClientScriptInclude(&quot;//ternjs.net/plugin/doc_comment.js&quot;);
                }
                pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/Scripts/app/bundle.workflow.codeaction.*.js&quot;);
            }
            if (isEditor)
            {
                pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/document.js&quot;);
                pageBase.RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/Scripts/app/bundle.workflow.editor.*.js&quot;);
            }
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                _workflowDetails.isViewMode = !string.IsNullOrEmpty(Request.QueryString[&quot;mode&quot;]) &amp;&amp; Request.QueryString[&quot;mode&quot;] == &quot;View&quot;;
                _workflowDetails.isEditMode = !string.IsNullOrEmpty(Request.QueryString[&quot;mode&quot;]) &amp;&amp; Request.QueryString[&quot;mode&quot;] == &quot;Edit&quot;;

                DataTable dt = null;
                if (_workflowDetails.isEditMode || _workflowDetails.isViewMode)
                {
                    dt = WFTemplateManager.GetWorkflowDetails(Request.QueryString[&quot;ID&quot;]);
                    if (dt.Rows.Count == 1)
                    {
                        _workflowDetails.WorkflowGUID = dt.Rows[0][&quot;WorkflowGUID&quot;].ToString2();
                        _workflowDetails.wfFile = dt.Rows[0][&quot;DefinitionFilePath&quot;].ToString2();
                        _workflowDetails.wfFileId = dt.Rows[0][&quot;FileId&quot;].ToString2();
                        _workflowDetails.isSystemWorkflow = dt.Rows[0][&quot;IsValidation&quot;] != null &amp;&amp; dt.Rows[0][&quot;IsValidation&quot;] != DBNull.Value &amp;&amp; (bool)dt.Rows[0][&quot;IsValidation&quot;];
                    }
                    else
                        throw new InvalidOperationException(&quot;None or More than one workflows for the given Id.&quot;);
                }

                if (_workflowDetails.isSystemWorkflow)
                    _workflowDetails.isViewMode = true;

                InitWorkflow(dt);

                HideMenus();

                PageTitle = _workflowDetails.isViewMode ? &quot; View Workflow&quot; : _workflowDetails.isEditMode ? &quot; Edit Workflow&quot; : &quot; New Workflow&quot;;

                SetWorkflowDetails(_workflowDetails.WorkflowGUID, _workflowDetails);
            }

            UIHelper.DisableRoleSelection(Page);
        }

        protected override void OnInit(EventArgs e)
        {
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);

            if (!string.IsNullOrEmpty(Request.QueryString[&quot;mode&quot;]))
            {
                if (Request.QueryString[&quot;Mode&quot;].Equals(&quot;Edit&quot;, StringComparison.CurrentCultureIgnoreCase))
                    PermissionsToCheck.Add(Constants.MODFEAT_EDIT);
                else if (Request.QueryString[&quot;Mode&quot;].Equals(&quot;View&quot;, StringComparison.CurrentCultureIgnoreCase))
                    PermissionsToCheck.Add(Constants.MODFEAT_VIEW);
                else
                    PermissionsToCheck.Add(Constants.MODFEAT_CREATE); // Default is Create mode
            }
            else
            {
                // Default is Create mode
                PermissionsToCheck.Add(Constants.MODFEAT_CREATE);
            }

            MainToolBar.EnableUpdatePanelForToolBar();
            PageUniqueID = &quot;MODMGMT&quot;;
            base.OnInit(e);
        }

        protected override void OnPreInit(EventArgs e)
        {
            ModuleId = &quot;WORKFLW&quot;;
            base.OnPreInit(e);
        }

        protected override void CreateChildControls()
        {
            var menus = new List&lt;MenuGroup&gt;();
            MenuGroup standard = new MenuGroup(&quot;Standard&quot;);
            menus.Add(standard);
            if (!_workflowDetails.isViewMode)
            {
                standard.AddMenu(new LargeButton(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;));
            }
            standard.AddMenu(new LargeButton(&quot;lnkClose&quot;, &quot;Close&quot;, &quot;Icn_Cancel.png&quot;));
            standard.AddMenu(new LargeButton(&quot;lnkCopy&quot;, &quot;Copy&quot;, &quot;Icn_Copy.png&quot;));

            //MenuGroup workflow = new MenuGroup(&quot;Workflow&quot;);           

            if (!_workflowDetails.isViewMode)
            {
                var undoRedo = new MenuGroup(&quot;Edit&quot;);
                undoRedo.AddMenu(new LargeButton(&quot;lnkUndo&quot;, &quot;Undo&quot;, &quot;Icn_Undo.png&quot;));
                undoRedo.AddMenu(new LargeButton(&quot;lnkRedo&quot;, &quot;Redo&quot;, &quot;Icn_Redo.png&quot;));
                undoRedo.AddMenu(new LargeButton(&quot;lnkDelete&quot;, &quot;Delete&quot;, &quot;Icn_Delete.png&quot;));
                undoRedo.AddMenu(new LargeButton(&quot;lnkAutolayout&quot;, &quot;Autolayout&quot;, &quot;Icn_StandardItems.png&quot;));
                menus.Add(undoRedo);

                //workflow.AddMenu(new LargeButton(&quot;lnkExpressions&quot;, &quot;Expressions&quot;, &quot;Icn_StandardItems.png&quot;));
            }

            //if (_ModuleComponents.Contains(&quot;ImpExpWFXML&quot;))
            //{
            //    workflow.AddMenu(new TextIcon(&quot;lnkExport&quot;, &quot;Export To XML&quot;, &quot;Icn_export.png&quot;));
            //    workflow.AddMenu(new TextIcon(&quot;lnkImport&quot;, &quot;Import From XML&quot;, &quot;Icn_export.png&quot;));
            //}
            //menus.Add(workflow);

            CreateToolBarMenu(menus, null);
            base.CreateChildControls();
        }

        protected override void CustomizeToolBar()
        {
            if (null == MainToolBar) return;

            if (!_workflowDetails.isViewMode)
            {
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Enabled = false;
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += lnkClose_Click;
            }
            MainToolBar.GetMenuReference(&quot;lnkCopy&quot;).Enabled = false;

            if (!_workflowDetails.isViewMode)
            {
                MainToolBar.GetMenuReference(&quot;lnkUndo&quot;).Enabled = false;
                MainToolBar.GetMenuReference(&quot;lnkRedo&quot;).Enabled = false;
                MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).Enabled = false;
                MainToolBar.GetMenuReference(&quot;lnkAutolayout&quot;).Enabled = false;
            }

            MainToolBar.GetMenuReference(&quot;lnkClose&quot;).Click += lnkClose_Click;
            MainToolBar.GetMenuReference(&quot;lnkCopy&quot;).Click += lnkClose_Click;
        }

        private void lnkClose_Click(object sender, EventArgs e)
        {
            try
            {
                if (!string.IsNullOrEmpty(_workflowDetails.WorkflowGUID))
                {
                    var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany()) as BrixCoreDataProvider;
                    var templateManager = provider.GetTemplateWFManager();
                    templateManager.UnLoadTemplate(_workflowDetails.WorkflowGUID);
                }
            }
            catch (Exception err)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                ShowError(JS.Serialize(err.Message.Replace(&quot;|&quot;, &quot;\\n&quot;)));
                return;
            }
            Response.Redirect(&quot;~/Common/BrixListPage.aspx?Context=WORKFLW&quot;, true);
        }

        private string InitWorkflow(DataTable dt)
        {
            string workflowJSON = string.Empty;
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany()) as BrixCoreDataProvider;
            if (provider != null)
            {
                var sFileSavedTo = string.Empty;
                var templateManager = provider.GetTemplateWFManager();

                int? userId = UserDetail.GetCurrentUserDetail()?.UID;

                if (!_workflowDetails.isEditMode &amp;&amp; !_workflowDetails.isViewMode)
                {
                    _workflowDetails.WorkflowTemplate = (StateMachineTemplate)templateManager.GetNewStateMachineTemplate(&quot;NewWF1&quot;);
                    _workflowDetails.WorkflowGUID = _workflowDetails.WorkflowTemplate.TemplateId.ToString2();
                    templateManager.SaveWFTemplate(_workflowDetails.WorkflowTemplate, false, ref sFileSavedTo, false, userId);
                }
                else
                {
                    _workflowDetails.WorkflowTemplate = (StateMachineTemplate)templateManager.GetOrLoadWFTemplate(_workflowDetails.WorkflowGUID, _workflowDetails.wfFile, _workflowDetails.wfFileId);
                    if (null == _workflowDetails.WorkflowTemplate)
                    {
                        _workflowDetails.WorkflowTemplate = (StateMachineTemplate)templateManager.GetNewStateMachineTemplate(&quot;NewWF1&quot;);
                        templateManager.SaveWFTemplate(_workflowDetails.WorkflowTemplate, false, ref sFileSavedTo, false, userId);
                    }
                }
                _workflowDetails.WorkflowTemplate.OnDeserialize();

                if (_workflowDetails.WorkflowTemplate != null &amp;&amp; dt != null &amp;&amp; dt.Rows.Count == 1)
                {
                    _workflowDetails.WorkflowTemplate.Unlock();

                    _workflowDetails.WorkflowTemplate.LinkedFormXML = dt.Rows[0][&quot;LinkedFormXML&quot;] != null &amp;&amp; dt.Rows[0][&quot;LinkedFormXML&quot;] != DBNull.Value
                        &amp;&amp; !string.IsNullOrEmpty(dt.Rows[0][&quot;LinkedFormXML&quot;].ToString2()) ? dt.Rows[0][&quot;LinkedFormXML&quot;].ToString2() : &quot;&lt;XML/&gt;&quot;;

                    _workflowDetails.WorkflowTemplate.WorkflowJSON = dt.Rows[0][&quot;WorkflowJSON&quot;] != null &amp;&amp; dt.Rows[0][&quot;WorkflowJSON&quot;] != DBNull.Value
                        &amp;&amp; !string.IsNullOrEmpty(dt.Rows[0][&quot;WorkflowJSON&quot;].ToString2()) ? dt.Rows[0][&quot;WorkflowJSON&quot;].ToString2() : &quot;&quot;;

                    workflowJSON = _workflowDetails.WorkflowTemplate.WorkflowJSON;
                    if (string.IsNullOrEmpty(workflowJSON))
                    {
                        ShowWarning(&quot;Workflow might have changed on migration to new display&quot;);
                    }
                }

                string js = &quot;var wfEditor = wfEditor || { }; wfEditor.wfDetails = JSON.parse(&#39;&quot; + GetWorkflowDetailsJSON(dt == null ? null : dt.Rows[0]) + &quot;&#39;); &quot;;

                RegisterStartupScript(js);
            }
            return workflowJSON;
        }

        private void HideMenus()
        {
            List&lt;string&gt; strPermList = Context.Items.Contains(Constants.MODULE_PERMISSIONS)
                ? (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS]
                : new List&lt;string&gt;();
            if (_workflowDetails.isViewMode || !(strPermList.Contains(&quot;Create&quot;) || strPermList.Contains(&quot;Edit&quot;)))
            {
                MainToolBar.HideMenu(&quot;lnkSave&quot;);
                MainToolBar.HideMenu(&quot;lnkUndo&quot;);
                MainToolBar.HideMenu(&quot;lnkRedo&quot;);
                MainToolBar.HideMenu(&quot;lnkDelete&quot;);
                MainToolBar.HideMenu(&quot;lnkExpressions&quot;);

                if (!_workflowDetails.isViewMode)
                    MainToolBar.HideMenu(&quot;lnkCopy&quot;);
            }
        }

        private string GetWorkflowDetailsJSON(DataRow row)
        {
            JsonObject wfDetails = new JsonObject();
            wfDetails.Add(&quot;WorkflowGUID&quot;, _workflowDetails.WorkflowGUID.ToString2());
            wfDetails.Add(&quot;workflowName&quot;, &quot;&quot;);
            wfDetails.Add(&quot;workflowDescription&quot;, &quot;&quot;);
            wfDetails.Add(&quot;viewPermissions&quot;, false);
            wfDetails.Add(&quot;selectedFormId&quot;, &quot;&quot;);
            wfDetails.Add(&quot;selectedFormName&quot;, &quot;&quot;);
            if (row != null)
            {
                wfDetails[&quot;workflowName&quot;] = row[&quot;Name&quot;].ToString2();
                wfDetails[&quot;workflowDescription&quot;] = row[&quot;Description&quot;].ToString2();
                wfDetails[&quot;viewPermissions&quot;] = row[&quot;ViewPermissions&quot;].ToBoolean2();
                wfDetails[&quot;selectedFormId&quot;] = row[&quot;AssociatedForm&quot;].ToString2().ToUpper2();
            }
            wfDetails.Add(&quot;PageMode&quot;, (_workflowDetails.isViewMode ? &quot;VIEW&quot;
                : (string.IsNullOrEmpty(Request.QueryString[&quot;mode&quot;]) ? &quot;ADD&quot; : Request.QueryString[&quot;mode&quot;].ToUpper2())));
            return wfDetails.ToString2();
        }

        public class WorkflowDetails
        {
            public bool isViewMode { get; set; }
            public bool isEditMode { get; set; }
            public bool isSystemWorkflow { get; set; }
            public string wfFile { get; set; }
            public string wfFileId { get; set; }

            public string WorkflowGUID { get; set; }

            private StateMachineTemplate _workflowTemplate = null;
            public StateMachineTemplate WorkflowTemplate
            {
                get
                {
                    if (_workflowTemplate != null)
                        return _workflowTemplate;

                    var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany()) as BrixCoreDataProvider;
                    if (provider != null)
                    {
                        var templateManager = provider.GetTemplateWFManager();
                        _workflowTemplate = (StateMachineTemplate)templateManager.GetOrLoadWFTemplate(WorkflowGUID, wfFile, wfFileId);
                    }

                    return _workflowTemplate;
                }
                set
                {
                    _workflowTemplate = value;
                }
            }

            private List&lt;IResource&gt; _formResources = null;
            public List&lt;IResource&gt; FormCustomResources
            {
                get
                {
                    if (_formResources == null)
                    {
                        _formResources = WorkflowTemplate.FormCustomResources();
                    }
                    return _formResources;
                }
            }

            Dictionary&lt;string, string&gt; errorMsgs = new Dictionary&lt;string, string&gt;();

            public void AddError(string actionName, string errMsg)
            {
                if (!string.IsNullOrEmpty(errMsg))
                {
                    if (errorMsgs.ContainsKey(actionName))
                        errorMsgs[actionName] += errMsg;
                    else
                        errorMsgs.Add(actionName, errMsg);
                }
            }

            public string GetError(string actionName, bool saveWF)
            {
                string errMsg = string.Empty;
                if (errorMsgs.Keys.Count &gt; 0)
                {
                    if (saveWF)
                        errorMsgs.ForEach(m =&gt; errMsg += m.Key + &quot; : &quot; + m.Value);
                    else if (!string.IsNullOrEmpty(actionName) &amp;&amp; errorMsgs.ContainsKey(actionName))
                        errMsg = actionName + &quot; : &quot; + errorMsgs[actionName];

                    errorMsgs.Clear();
                }
                return errMsg;
            }
        }

        public static WorkflowDetails GetWorkflowDetails(string WorkflowGUID)
        {
            if (_dictWorkflowDetails.ContainsKey(WorkflowGUID))
            {
                return _dictWorkflowDetails[WorkflowGUID];
            }
            return new WorkflowDetails();
        }

        public static void SetWorkflowDetails(string WorkflowGUID, WorkflowDetails wfDetails)
        {
            if (_dictWorkflowDetails.ContainsKey(WorkflowGUID))
                _dictWorkflowDetails[WorkflowGUID] = wfDetails;
            else
                _dictWorkflowDetails.Add(WorkflowGUID, wfDetails);
        }

        #region Asynchronous Callbacks with Web Methods

        public class ResourceInfo : FormInfo
        {
            public Params Parameters { get; set; }
        }

        public class MorphWorkflowInfo : FormInfo
        {
            public IEnumerable&lt;ResourceInfo&gt; Actions { get; set; }
        }

        public class RoleInfo : FormInfo
        {
        }

        public class FormInfo
        {
            public string Id { get; set; }
            public string Name { get; set; }
            public string Description { get; set; }
        }

        public class ExpressionInfo : FormInfo
        {
            public string Type { get; set; }
            public string IsArray { get; set; }
        }

        public class BICEmailTemplate
        {
            public int TemplateID { get; set; }
            public string TemplateName { get; set; }
            public int TemplateType { get; set; }
        }

        public class MailBodyTemplate
        {
            public int TemplateID { get; set; }
            public string TemplateName { get; set; }
        }

        public class MailMergeTemplate
        {
            public int TemplateID { get; set; }
            public string TemplateName { get; set; }
        }

        public class ParamInfo
        {
            public string Name { get; set; }
            public string DisplayName { get; set; }
            public string DataType { get; set; }
            public bool IsMandatory { get; set; }
        }

        public class Params
        {
            public string PrimaryKeyName { get; set; }
            public IEnumerable&lt;ParamInfo&gt; OutputParameters { get; set; }
            public IEnumerable&lt;ParamInfo&gt; InputParameters { get; set; }
        }

        [WebMethod]
        public static IEnumerable&lt;RoleInfo&gt; GetAvailableRoles(string formId)
        {
            List&lt;RoleInfo&gt; roleInfos = new List&lt;RoleInfo&gt;();

            if (formId == string.Empty)
            {
                //Get All Roles
                Dictionary&lt;int, string&gt; roles = UserManager.Instance.GetRoles();
                foreach (var o in roles)
                {
                    roleInfos.Add(new RoleInfo
                    {
                        Id = o.Key.ToString2(),
                        Name = o.Value
                    });
                }
            }
            else
            {
                //Get Roles with Edit permission for a specific form
                DataTable rolesTable = ModuleManager.Instance.GetRolesForaFeature(formId, Constants.MODFEAT_EDIT);
                if (ModuleManager.Instance.IsAllowActionByAllStakeHolders(formId))
                {
                    rolesTable.Merge(ModuleManager.Instance.GetRolesForaFeature(formId, Constants.MODFEAT_VIEW));
                    rolesTable.DefaultView.Sort = &quot;RoleName&quot;;
                    rolesTable = rolesTable.DefaultView.ToTable();
                }
                var roles = rolesTable.AsEnumerable()
                    .GroupBy(r =&gt; r.Field&lt;int&gt;(&quot;RoleID&quot;))
                    .Select(g =&gt; g.First());
                foreach (var o in roles)
                {
                    roleInfos.Add(new RoleInfo
                    {
                        Id = o.Field&lt;int&gt;(&quot;RoleID&quot;).ToString2(),
                        Name = o.Field&lt;string&gt;(&quot;RoleName&quot;),
                        Description = &quot;EDIT&quot;
                    });
                }

                //Get Roles with View permission for a specific form
                roles = ModuleManager.Instance.GetRolesForaFeature(formId, Constants.MODFEAT_VISIBILITY).AsEnumerable();

                foreach (var o in roles)
                {
                    roleInfos.Add(new RoleInfo
                    {
                        Id = o.Field&lt;int&gt;(&quot;RoleID&quot;).ToString2(),
                        Name = o.Field&lt;string&gt;(&quot;RoleName&quot;),
                        Description = &quot;VIEW&quot;
                    });
                }
            }
            return roleInfos.AsEnumerable();
        }

        [WebMethod]
        public static IEnumerable&lt;BICEmailTemplate&gt; GetBICTemplates(string formId)
        {
            List&lt;BICEmailTemplate&gt; emailTemplates = new List&lt;BICEmailTemplate&gt;();
            var BICQTemplates = EmailTemplateManager.Instance.GetEmailTemplatesByModuleId(formId).AsEnumerable();
            foreach (var bict in BICQTemplates)
            {
                emailTemplates.Add(new BICEmailTemplate
                {
                    TemplateID = bict.Field&lt;int&gt;(&quot;TemplateID&quot;),
                    TemplateName = bict.Field&lt;string&gt;(&quot;TemplateName&quot;),
                    TemplateType = bict.Field&lt;int&gt;(&quot;TemplateType&quot;)
                });
            }
            return emailTemplates.AsEnumerable();
        }

        [WebMethod]
        public static IEnumerable&lt;MailBodyTemplate&gt; GetMailBodyTemplate(string formId)
        {
            List&lt;MailBodyTemplate&gt; mailBodyTemplates = new List&lt;MailBodyTemplate&gt;();
            var ENSMailBodyTemplates = EmailTemplateManager.Instance.GetMailBodyTemplate(0, formId).AsEnumerable();
            foreach (var mbt in ENSMailBodyTemplates)
            {
                mailBodyTemplates.Add(new MailBodyTemplate
                {
                    TemplateID = mbt.Field&lt;int&gt;(&quot;ID&quot;),
                    TemplateName = mbt.Field&lt;string&gt;(&quot;Name&quot;),
                });
            }
            return mailBodyTemplates.AsEnumerable();
        }

        [WebMethod]
        public static IEnumerable&lt;MailMergeTemplate&gt; GetMailMergeTemplate(string formId)
        {
            List&lt;MailMergeTemplate&gt; mailMergeTemplates = new List&lt;MailMergeTemplate&gt;();
            var ENSMailMergeTemplates = new MailMergeManager().GetMappings(formId).AsEnumerable();
            foreach (var mmt in ENSMailMergeTemplates)
            {
                mailMergeTemplates.Add(new MailMergeTemplate
                {
                    TemplateID = mmt.Field&lt;int&gt;(&quot;MapID&quot;),
                    TemplateName = mmt.Field&lt;string&gt;(&quot;Name&quot;),
                });
            }
            return mailMergeTemplates.AsEnumerable();
        }

        [WebMethod]
        public static IEnumerable&lt;MorphWorkflowInfo&gt; GetWorkflows(string formID)
        {
            DataTable dtWFDetails = WFRuntimeHandlerDB.GetAssociatedWorkflows(formID, true).Tables[0];
            if (dtWFDetails.Rows.Count &gt; 0)
            {
                var results = dtWFDetails.Select(&quot;IsPublished=True AND IsDeleted=False&quot;).AsEnumerable();

                return from o in results
                       select new MorphWorkflowInfo
                       {
                           Id = o.Field&lt;string&gt;(&quot;WorkflowGUID&quot;),
                           Name = o.Field&lt;string&gt;(&quot;Name&quot;),
                           Actions = GetActions(o.Field&lt;string&gt;(&quot;WorkflowGUID&quot;), o.Field&lt;string&gt;(&quot;DefinitionFilePath&quot;), o.Field&lt;string&gt;(&quot;FileId&quot;))
                       };
            }

            return null;
        }

        public static IEnumerable&lt;ResourceInfo&gt; GetActions(string workflowGUID, string wfFile, string wfFileID)
        {
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany()) as BrixCoreDataProvider;
            var templateManager = provider.GetTemplateWFManager();
            StateMachineTemplate wfTemplate = (StateMachineTemplate)templateManager.GetOrLoadWFTemplate(workflowGUID, wfFile, wfFileID);
            wfTemplate.OnDeserialize();

            StateInfo stateInfo = (StateInfo)wfTemplate.GetActivity(wfTemplate.InitialStateName);

            return from o in stateInfo.ActionButtons
                   select new ResourceInfo
                   {
                       Id = ((FormAction)o).ActionName,
                       Name = ((FormAction)o).DisplayName
                   };
        }

        [WebMethod]
        public static IEnumerable&lt;FormInfo&gt; GetModules()
        {
            var dt = ModuleManager.Instance.GetModules().AsEnumerable();

            var forms = from o in dt
                        where o.Field&lt;string&gt;(&quot;NavigateURL&quot;).StartsWith(&quot;xmlform&quot;, StringComparison.CurrentCultureIgnoreCase)
                        select new FormInfo
                        {
                            Name = o.Field&lt;string&gt;(&quot;ModuleName&quot;),
                            Id = o.Field&lt;string&gt;(&quot;ModuleId&quot;),
                        };

            return forms;
        }

        [WebMethod]
        public static Params GetFormElements(string dsType, FormInfo Form)
        {
            Params Params = new Params();

            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany());
            if (provider != null)
            {
                var datasource = provider.GetDataSource(dsType, false);
                if (datasource != null &amp;&amp; Form.Id != null)
                {
                    var resource = datasource.GetResourceById(Form.Id);
                    if (resource != null)
                    {
                        BrixFormModel model = new BrixFormModel(XMLForms.GetXMLFormModuleID(Form.Id),
                                                 Form.Id + &quot;.xml&quot;, XMLType.Form, null, null);

                        Params.PrimaryKeyName = model.form.PrimaryKeyName;

                        Params.OutputParameters =
                            from o in resource.GetOutputParamNames().Contents
                            select new ParamInfo
                            {
                                Name = o.Value.Name,
                                DisplayName = GetBeautifyName(o.Value.Name)
                            };

                        Params.InputParameters =
                            from o in resource.GetInputParamNames().Contents
                            select new ParamInfo
                            {
                                Name = o.Value.Name,
                                DisplayName = GetBeautifyName(o.Value.Name),
                                IsMandatory = ((Param)o.Value).IsMandatory,
                                DataType = o.Value.Type
                            };
                    }
                }
            }

            return Params;
        }

        [WebMethod]
        public static IEnumerable&lt;ResourceInfo&gt; GetResourceList(string WorkflowGUID, string formId)
        {
            StateMachineTemplate WorkflowTemplate = GetWorkflowDetails(WorkflowGUID).WorkflowTemplate;

            List&lt;ResourceInfo&gt; resources = new List&lt;ResourceInfo&gt;();
            List&lt;IResource&gt; formResources = GetWorkflowDetails(WorkflowGUID).FormCustomResources;

            foreach (var rs in formResources)
            {
                ResourceInfo resource = new ResourceInfo
                {
                    Name = rs.Name,
                    Id = rs.Id,
                    Description = rs.Description,
                    Parameters = new Params
                    {
                        OutputParameters = from p in rs.GetOutputParamNames().Contents
                                           select new ParamInfo
                                           {
                                               Name = p.Value.Name,
                                               DisplayName = GetBeautifyName(p.Value.Name)
                                           },
                        InputParameters = from p in rs.GetInputParamNames().Contents
                                          where !p.Value.Name.StartsWith(&quot;_&quot;)
                                          select new ParamInfo
                                          {
                                              Name = p.Value.Name,
                                              DisplayName = GetBeautifyName(p.Value.Name),
                                              IsMandatory = ((Param)p.Value).IsMandatory,
                                              DataType = p.Value.Type
                                          }
                    }
                };
                resources.Add(resource);
            }
            return resources.AsEnumerable();
        }

        [WebMethod]
        public static string GetSections(string formId)
        {
            var s = new Sections();
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany());
            if (provider != null)
            {
                IDataSource dataSource = provider.GetDataSource(&quot;xmlget&quot;, false);
                if (dataSource != null)
                {
                    IParams input = new Aurigo.Common.Params(Guid.NewGuid());
                    IParams oParam = null;
                    IResource getSections = dataSource.GetResourceByName(&quot;GetSections&quot;);
                    if (getSections != null)
                    {
                        input.SetParam(new Param(&quot;FormId&quot;, formId, &quot;string&quot;), true);
                        oParam = getSections.Execute(input);
                        Aurigo.Common.Section[] secs = ((IForm)oParam.GetValue(&quot;IForm&quot;)).Sections;
                        s.Secs = secs;
                    }
                }
            }
            return s.Serialize();
        }

        [WebMethod]
        public static string GetControlHierarchy(string moduleId)
        {
            BrixFormModel model = new BrixFormModel(moduleId, moduleId + &quot;.xml&quot;,
                BusinessLayer.XmlForm_Framework.XMLType.Form, false, true);
            model.form.instanceID = &quot;-1&quot;;

            JsonObject j = APIModuleHelper.GetDetails(moduleId, &quot;-1&quot;, string.Empty, model);
            return j.ToString();
        }

        [WebMethod]
        public static IEnumerable&lt;FormInfo&gt; GetFormList()
        {
            IEnumerable&lt;FormInfo&gt; forms = new List&lt;FormInfo&gt;();
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany());
            if (provider != null)
            {
                var datasource = provider.GetDataSource(&quot;XMLGet&quot;, false);
                if (datasource != null)
                {
                    var resources = datasource.GetResources();
                    forms = from o in resources
                            where !string.IsNullOrWhiteSpace(o.Value.Name)
                            select new FormInfo
                            {
                                Name = o.Value.Name,
                                Id = o.Value.Id,
                                Description = o.Value.Description
                            };
                }
            }

            return forms;
        }

        [WebMethod]
        public static IEnumerable&lt;ExpressionInfo&gt; GetExpressions(string WorkflowGUID, string expType)
        {
            StateMachineTemplate WorkflowTemplate = GetWorkflowDetails(WorkflowGUID).WorkflowTemplate;

            List&lt;ExpressionInfo&gt; expressions = new List&lt;ExpressionInfo&gt;();
            IDictionary&lt;string, IResource&gt; dicExpForThisWorkflow = ExpressionDataSource.Instance.GetResources(WorkflowGUID);
            foreach (IResource res in dicExpForThisWorkflow.Values)
            {
                IParams pms = res.GetOutputParamNames();
                string sType = &quot;System.Boolean&quot;;
                bool bIsArray = false;
                GetResourceType(pms, ref sType, ref bIsArray);

                IParams outputParams = (expType == &quot;bool&quot;) ? res.GetOutputParamNamesOfTypes(&quot;System.Boolean&quot;)
                : res.GetOutputParamNames();

                if (outputParams.Contents.Count &gt; 0)
                    expressions.Add(new ExpressionInfo()
                    {
                        Id = res.Id,
                        Name = GetBeautifyName(res.Name),
                        Description = res.Description,
                        Type = sType,
                        IsArray = bIsArray ? &quot;True&quot; : &quot;False&quot;
                    });
            }
            return expressions.AsEnumerable&lt;ExpressionInfo&gt;();
        }

        private static void GetResourceType(IParams pms, ref string sType, ref bool bIsArray)
        {
            if (null == pms) return;
            string[] outParams = pms.GetKeys();
            if (null == outParams || outParams.Length &lt; 1) return;
            IParam p = pms.GetParam(outParams[0]);
            if (null == p) return;
            sType = p.Type;
            bIsArray = p.IsArrayType;
        }

        [WebMethod]
        public static IEnumerable&lt;ParamInfo&gt; GetHostParameters(string WorkflowGUID, string expType)
        {
            StateMachineTemplate WorkflowTemplate = GetWorkflowDetails(WorkflowGUID).WorkflowTemplate;
            IEnumerable&lt;ParamInfo&gt; hostParameters = new List&lt;ParamInfo&gt;();

            GenericResource hostResources = WorkflowTemplate.WFResources();
            IParams outputParams = (expType == &quot;bool&quot;) ? hostResources.GetOutputParamNamesOfTypes(&quot;System.Boolean&quot;)
                : hostResources.GetOutputParamNames();

            hostParameters =
                           from o in outputParams.Contents
                           select new ParamInfo
                           {
                               Name = o.Value.DerivedPath,
                               DisplayName = GetBeautifyName(o.Value.Name, WorkflowTemplate.Name)
                           };

            return hostParameters;
        }

        private static string GetBeautifyName(string name, string workflowTemplateName = &quot;&quot;)
        {
            StringBuilder mngfulName = new StringBuilder();
            bool previousCharIsUpperOrSpace = false;

            name = name.Replace(workflowTemplateName.Replace(&quot; &quot;, &quot;&quot;) + &quot;_&quot;, &quot;&quot;); //Remove workflow template name
            name = name.Trim(&#39;_&#39;);
            name = name.Replace(&quot;_&quot;, &quot; : &quot;); // Replace _ with : 

            foreach (char charName in name.ToCharArray())
            {
                if (!previousCharIsUpperOrSpace &amp;&amp; Char.IsUpper(charName))
                    mngfulName.Append(&quot; &quot;);
                mngfulName.Append(charName);

                previousCharIsUpperOrSpace = Char.IsUpper(charName) || Char.IsWhiteSpace(charName);
            }
            return mngfulName.ToString2();
        }

        [WebMethod]
        public static string GetWorkflow(string WorkflowGUID)
        {
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany()) as BrixCoreDataProvider;
            var templateManager = provider.GetTemplateWFManager();

            return ((WFTemplateManager)templateManager).GetJSONFromWorkflowTemplate(GetWorkflowDetails(WorkflowGUID).WorkflowTemplate);
        }

        [WebMethod]
        public static string AutoLayout(string wfJSON)
        {
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany()) as BrixCoreDataProvider;
            var templateManager = provider.GetTemplateWFManager();

            return ((WFTemplateManager)templateManager).AutoLayout(wfJSON);
        }        

        [WebMethod]
        public static IEnumerable&lt;FormInfo&gt; GetChecklists(string formId)
        {
            IEnumerable&lt;FormInfo&gt; checkLists = new List&lt;FormInfo&gt;();
            DataSet ds = ChecklistManager.Instance.GetChecklists(&quot;LIBRARY&quot;, 0, formId);
            if(ds.Tables.Count &gt; 0 &amp;&amp; ds.Tables[0].Rows.Count &gt; 0)
            {
                checkLists = from o in ds.Tables[0].Select()
                             select new FormInfo
                             {
                                 Name = o[&quot;Name&quot;].ToString2(),
                                 Id = o[&quot;CheckListID&quot;].ToString2(),
                                 Description = o[&quot;Description&quot;].ToString2()
                             };
            }
            return checkLists;
        }

        #endregion

        #region Create Workflow from JSON

        private static void SaveWorkflow(WorkflowDetails workflowDetails, ref string errMsg)
        {
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany()) as BrixCoreDataProvider;
            var templateManager = provider.GetTemplateWFManager();

            string errMessages = &quot;&quot;;
            if (!workflowDetails.WorkflowTemplate.CanLockAndSave(ref errMessages))
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                string errMessage = JS.Serialize(errMessages.Replace(&quot;|&quot;, &quot;\\n&quot;));
                errMsg += errMessage;
            }

            string sFileSavedTo = string.Empty;
            if (workflowDetails.isEditMode) sFileSavedTo = workflowDetails.wfFile;
            workflowDetails.WorkflowTemplate.LockDesign();

            templateManager.SaveWFTemplate(workflowDetails.WorkflowTemplate, true, ref sFileSavedTo, false, UserDetail.GetCurrentUserDetail()?.UID);
            templateManager.UnLoadTemplate(workflowDetails.WorkflowTemplate.TemplateId.ToString2());
        }

        [WebMethod]
        public static string CreateWorkflowFromJSON(string WorkflowGUID, string wfJSON, bool copy, bool saveWF, string selectedAction)
        {
            try
            {
                WorkflowDetails workflowDetails = GetWorkflowDetails(WorkflowGUID);

                if (workflowDetails.isSystemWorkflow &amp;&amp; !copy)
                    throw new Exception(&quot;System workflow cannot be modified. Please make a copy in order to modify.&quot;);

                CreateWorkflowFromJSON(workflowDetails, wfJSON, copy, saveWF);

                SetWorkflowDetails(workflowDetails.WorkflowGUID, workflowDetails);

                string errMsg = workflowDetails.GetError(selectedAction, saveWF);

                if (saveWF &amp;&amp; string.IsNullOrEmpty(errMsg))
                    SaveWorkflow(workflowDetails, ref errMsg);

                if (string.IsNullOrEmpty(errMsg))
                    return &quot;success|&quot; + VirtualPathUtility.ToAbsolute(&quot;~/Common/BrixListPage.aspx&quot;) + &quot;?Context=WORKFLW&quot;;
                else
                    return &quot;Error - &quot; + errMsg;
            }
            catch (Exception ex)
            {
                return &quot;Error - &quot; + ex.Message;
            }
        }

        public static void CreateWorkflowFromJSON(WorkflowDetails workflowDetails, string wfJSON, bool bCopy, bool saveWorkflow)
        {
            string errMsg = string.Empty;
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;, ConnectionHelper.GetCurrentCompany()) as BrixCoreDataProvider;
            var templateManager = provider.GetTemplateWFManager();

            StateMachineTemplate wfTemplate = workflowDetails.WorkflowTemplate;

            JsonObject wfJSONObj = (JsonObject)JsonObject.Parse(wfJSON);
            JsonObject wfDetails = (JsonObject)wfJSONObj[&quot;wfDetails&quot;];
            string wfStageJSON = wfJSONObj[&quot;wfStages&quot;].ToString2();

            string workflowName = (bCopy ? &quot;Copy of &quot; : &quot;&quot;) + GetJsonValue(wfDetails, &quot;workflowName&quot;);
            if (bCopy)
            {
                string oldWfTemplateId = wfTemplate.TemplateId.ToString2();
                wfTemplate.TemplateId = Guid.NewGuid();
                wfStageJSON = wfStageJSON.Replace(&quot;_&quot; + oldWfTemplateId + &quot;_&quot;, &quot;_&quot; + wfTemplate.TemplateId.ToString2() + &quot;_&quot;);

                workflowDetails.WorkflowGUID = wfTemplate.TemplateId.ToString2();
            }

            if (saveWorkflow)
            {
                if (!WFTemplateManager.ValidateWorkflowName(workflowDetails.WorkflowGUID, workflowName, GetJsonValue(wfDetails, &quot;selectedFormId&quot;).ToLower()))
                {
                    workflowDetails.AddError(workflowName, &quot;Workflow with same name already exists for the form.&quot;);
                    return;
                }
            }

            wfTemplate.Name = workflowName;
            wfTemplate.Description = GetJsonValue(wfDetails, &quot;workflowDescription&quot;);
            wfTemplate.AssociatedFormId = GetJsonValue(wfDetails, &quot;selectedFormId&quot;).ToLower();
            wfTemplate.ViewPermissions = wfDetails[&quot;viewPermissions&quot;].ReadAs&lt;bool&gt;();
            wfTemplate.TriggerData = new TriggerPoint(TriggerPoint.TriggerActions[0], GetJsonValue(wfDetails, &quot;selectedFormName&quot;),
                                                       GetJsonValue(wfDetails, &quot;selectedFormId&quot;));
            string deleteValidator;
            wfTemplate.GetPossibleDeleteValidators(out deleteValidator);
            wfTemplate.DeleteValidator = deleteValidator;
            wfTemplate.LinkedFormXML = string.Empty;

            foreach (string stageId in wfTemplate.ActivitiesList)
            {
                string sName = stageId.Split(&#39;|&#39;)[1];
                wfTemplate.RemoveActivity(sName);
            }

            JsonArray wfStages = (JsonArray)JsonArray.Parse(wfStageJSON);

            List&lt;KeyValuePair&lt;string, string&gt;&gt; wfStagesGUID = new List&lt;KeyValuePair&lt;string, string&gt;&gt;();

            List&lt;JsonObject&gt; wfStates = wfStages.OfType&lt;JsonObject&gt;().Where(x =&gt; x[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;StartStage&quot;
                    || x[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;IntermediateStage&quot;
                    || x[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;EndStage&quot;).ToList&lt;JsonObject&gt;();

            foreach (JsonObject wfStage in wfStates)
            {
                string stateInstanceId = ParseState(provider, workflowDetails, wfDetails[&quot;selectedFormId&quot;].ReadAs&lt;string&gt;().ToLower(), wfStages, wfStage);
                wfStagesGUID.Add(new KeyValuePair&lt;string, string&gt;(wfStage[&quot;id&quot;].ReadAs&lt;string&gt;(), stateInstanceId));
            }

            //Set target state
            foreach (string stageId in wfTemplate.ActivitiesList)
            {
                string sName = stageId.Split(&#39;|&#39;)[1];
                StateInfo stateInfo = (StateInfo)wfTemplate.GetActivity(sName);
                foreach (FormAction frmAction in stateInfo.ActionButtons)
                {
                    SetState(wfTemplate, wfStagesGUID, frmAction.ActivitiesList);
                }
            }

            if (saveWorkflow)
            {
                wfTemplate.WorkflowJSON = wfStages.ToString2();
            }
        }

        private static string GetJsonValue(JsonObject jsonObject, string key)
        {
            string value = string.Empty;
            if (jsonObject.ContainsKey(key) &amp;&amp; jsonObject[key] != null)
            {
                value = jsonObject[key].ReadAs&lt;string&gt;();
            }
            return value;
        }

        private static string ParseState(BrixCoreDataProvider provider, WorkflowDetails workflowDetails,
            string selectedFormId, JsonArray wfStages, JsonObject wfStage)
        {
            string errMsg = string.Empty;
            StateMachineTemplate wfTemplate = workflowDetails.WorkflowTemplate;

            IState st = wfTemplate.AddAStateToWF(wfStage[&quot;name&quot;].ReadAs&lt;string&gt;(), selectedFormId);

            var stateInfo = (StateInfo)wfTemplate.GetActivity(st.InstanceId);

            stateInfo.IsStartState = wfStage[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;StartStage&quot;;
            stateInfo.IsEndState = wfStage[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;EndStage&quot;;
            if (stateInfo.IsStartState) wfTemplate.InitialStateName = stateInfo.InstanceId;
            if (stateInfo.IsEndState) wfTemplate.CompletedStateName = stateInfo.InstanceId;

            JsonObject userData = (JsonObject)wfStage[&quot;userData&quot;];

            if (userData.ContainsKey(&quot;Sections&quot;) &amp;&amp; userData[&quot;Sections&quot;] != null)
                stateInfo.SectionDisplayInfo = userData[&quot;Sections&quot;].ToString2();

            stateInfo.BICRequestEmailTemplate = GetJsonValue(userData, &quot;ballInCourtRequestEmailTemplate&quot;);
            stateInfo.BICResponseEmailTemplate = GetJsonValue(userData, &quot;ballInCourtResponseEmailTemplate&quot;);

            stateInfo.ActionsMustBePerformedBy = &quot;&quot;;
            if (userData.ContainsKey(&quot;actionStakeHolders&quot;) &amp;&amp; userData[&quot;actionStakeHolders&quot;] != null &amp;&amp; userData[&quot;actionStakeHolders&quot;] is JsonArray)
            {
                foreach (string actionStakeHolder in (JsonArray)userData[&quot;actionStakeHolders&quot;])
                {
                    stateInfo.ActionsMustBePerformedBy += actionStakeHolder + &quot;,&quot;;
                }
                stateInfo.ActionsMustBePerformedBy = stateInfo.ActionsMustBePerformedBy.Trim(&#39;,&#39;);
            }
            if (!stateInfo.IsEndState &amp;&amp; string.IsNullOrEmpty(stateInfo.ActionsMustBePerformedBy))
                errMsg += &quot;Select at least one action stake holder. \r\n&quot;;

            stateInfo.ViewStakeHolders = &quot;&quot;;
            if (wfTemplate.ViewPermissions)
            {
                if (userData.ContainsKey(&quot;viewStakeHolders&quot;) &amp;&amp; userData[&quot;viewStakeHolders&quot;] != null &amp;&amp; userData[&quot;viewStakeHolders&quot;] is JsonArray)
                {
                    foreach (string viewStakeHolder in (JsonArray)userData[&quot;viewStakeHolders&quot;])
                    {
                        stateInfo.ViewStakeHolders += viewStakeHolder + &quot;,&quot;;
                    }
                    stateInfo.ViewStakeHolders = stateInfo.ViewStakeHolders.Trim(&#39;,&#39;);
                }

                if (string.IsNullOrEmpty(stateInfo.ViewStakeHolders))
                    errMsg += &quot;Select at least one view stake holder. \r\n&quot;;
            }

            int daysToComplate = 0;
            if (int.TryParse(GetJsonValue(userData, &quot;daysToComplete&quot;), out daysToComplate))
                stateInfo.DaysToComplete = daysToComplate;

            stateInfo.SendMailToStakeholders = stateInfo.IsEndState ? false : userData[&quot;sendEmailToStakeHolders&quot;].ReadAs&lt;bool&gt;();
            StateAdditionalInfo sai = stateInfo.AdditionalInfo;
            sai.ShowInMyTasks = stateInfo.IsEndState ? false : userData[&quot;showStageInTasks&quot;].ReadAs&lt;bool&gt;();
            sai.CanDelete = GetJsonValue(userData, &quot;deleteValidation&quot;);
            stateInfo.SetAdditionalInfo(sai);

            workflowDetails.AddError(stateInfo.DisplayName, errMsg);

            foreach (JsonObject wfAction in (JsonArray)wfStage[&quot;entities&quot;])
            {
                FormAction formAction = (FormAction)stateInfo.AddAction();

                formAction.ActionName = GetJsonValue(wfAction, &quot;text&quot;);
                formAction.ActionDisplayName = GetJsonValue(wfAction, &quot;text&quot;);
                formAction.OnClientClick = GetJsonValue((JsonObject)wfAction[&quot;userData&quot;], &quot;onClientClick&quot;);
                formAction.IsCommentsMandatory = ((JsonObject)wfAction[&quot;userData&quot;]).ContainsKey(&quot;isCommentsMandatory&quot;) ? wfAction[&quot;userData&quot;][&quot;isCommentsMandatory&quot;].ReadAs&lt;bool&gt;() : false;
                formAction.AssociatedCheckList = GetJsonValue((JsonObject)wfAction[&quot;userData&quot;], &quot;associatedCheckList&quot;);

                ParseActivities(workflowDetails, wfStages, wfStage, &quot;output_&quot; + wfAction[&quot;id&quot;].ReadAs&lt;string&gt;(), formAction,
                    provider, selectedFormId.ToLower());
            }

            return stateInfo.InstanceId;
        }

        private static void SetState(StateMachineTemplate wfTemplate, List&lt;KeyValuePair&lt;string, string&gt;&gt; wfStagesGUID, List&lt;string&gt; activitiesList)
        {
            foreach (string activityId in activitiesList)
            {
                IActivityInstance activity = wfTemplate.GetActivity(activityId);
                if (activity.ActivityType == &quot;Aurigo.Workflow.SetStateActivityEx&quot;)
                {
                    SetStateActivityEx setState = (SetStateActivityEx)activity;
                    setState.Modify(wfStagesGUID.Find(i =&gt; i.Key == setState.TargetState).Value);
                }
                if (activity.IsContainerActivity) SetState(wfTemplate, wfStagesGUID, activity.ActivitiesList);
            }
        }

        private static JsonObject GetNextActivityNode(JsonArray wfStages, string previousActivityId, string portId)
        {
            var targetNode = wfStages.OfType&lt;JsonObject&gt;().Where(x =&gt; x[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;wfEditor.WorkflowConnection&quot;
                                              &amp;&amp; x[&quot;source&quot;][&quot;node&quot;].ReadAs&lt;string&gt;() == previousActivityId
                                              &amp;&amp; x[&quot;source&quot;][&quot;port&quot;].ReadAs&lt;string&gt;() == portId).ToList&lt;JsonObject&gt;();

            if (targetNode != null &amp;&amp; targetNode.Count &gt; 0)
            {
                targetNode = wfStages.OfType&lt;JsonObject&gt;().Where(x =&gt; x[&quot;id&quot;].ReadAs&lt;string&gt;() == targetNode[0][&quot;target&quot;][&quot;node&quot;].ReadAs&lt;string&gt;()).ToList&lt;JsonObject&gt;();

                if (targetNode != null &amp;&amp; targetNode.Count &gt; 0)
                    return (JsonObject)targetNode[0];
            }
            return null;
        }

        private static void ParseActivities(WorkflowDetails workflowDetails, JsonArray wfStages, JsonObject sourceActivity, string sourcePortId, IActivityInstance activityInstance,
            BrixCoreDataProvider provider, string formId)
        {
            string errMsg = string.Empty;
            JsonObject targetActivity = GetNextActivityNode(wfStages, sourceActivity[&quot;id&quot;].ReadAs&lt;string&gt;(), sourcePortId);

            if (targetActivity != null)
            {
                //If next node is stage node add set state activity
                if (targetActivity[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;StartStage&quot;
                    || targetActivity[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;IntermediateStage&quot;
                    || targetActivity[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;EndStage&quot;)
                {
                    //Add Set State Activity
                    var ssEx = (SetStateActivityEx)activityInstance.AddSetStateActivity();
                    ssEx.TargetState = targetActivity[&quot;id&quot;].ReadAs&lt;string&gt;(); //Will get modify with actual workflow state instance id once all the state is created

                    var wfConnection = wfStages.OfType&lt;JsonObject&gt;().Where(x =&gt; x[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;wfEditor.WorkflowConnection&quot;
                                                  &amp;&amp; x[&quot;source&quot;][&quot;node&quot;].ReadAs&lt;string&gt;() == sourceActivity[&quot;id&quot;].ReadAs&lt;string&gt;()
                                                  &amp;&amp; x[&quot;source&quot;][&quot;port&quot;].ReadAs&lt;string&gt;() == sourcePortId).ToList&lt;JsonObject&gt;();

                    if (wfConnection != null &amp;&amp; wfConnection.Count &gt; 0)
                    {
                        ssEx.ExecuteAlways = GetJsonValue((JsonObject)wfConnection[0][&quot;userData&quot;], &quot;executionMode&quot;) == &quot;1&quot;;
                        ssEx.EmailNotification = new EmailNotification();

                        ssEx.EmailNotification.TO = &quot;&quot;;

                        if (wfConnection[0][&quot;userData&quot;].ContainsKey(&quot;To&quot;) &amp;&amp; ((JsonObject)wfConnection[0][&quot;userData&quot;])[&quot;To&quot;] != null &amp;&amp;
                            ((JsonObject)wfConnection[0][&quot;userData&quot;])[&quot;To&quot;] is JsonArray)
                        {
                            foreach (string to in (JsonArray)((JsonObject)wfConnection[0][&quot;userData&quot;])[&quot;To&quot;])
                            {
                                ssEx.EmailNotification.TO += to + &quot;,&quot;;
                            }
                            ssEx.EmailNotification.TO = ssEx.EmailNotification.TO.Trim(&#39;,&#39;);
                        }

                        ssEx.EmailNotification.CC = &quot;&quot;;

                        if (wfConnection[0][&quot;userData&quot;].ContainsKey(&quot;CC&quot;) &amp;&amp; ((JsonObject)wfConnection[0][&quot;userData&quot;])[&quot;CC&quot;] != null &amp;&amp;
                            ((JsonObject)wfConnection[0][&quot;userData&quot;])[&quot;CC&quot;] is JsonArray)
                        {
                            foreach (string cc in (JsonArray)((JsonObject)wfConnection[0][&quot;userData&quot;])[&quot;CC&quot;])
                            {
                                ssEx.EmailNotification.CC += cc + &quot;,&quot;;
                            }
                            ssEx.EmailNotification.CC = ssEx.EmailNotification.CC.Trim(&#39;,&#39;);
                        }

                        ssEx.EmailNotification.MailBodyTemplateID = GetJsonValue((JsonObject)wfConnection[0][&quot;userData&quot;], &quot;emailTemplateId&quot;);
                        ssEx.EmailNotification.MailMergeTemplateID = GetJsonValue((JsonObject)wfConnection[0][&quot;userData&quot;], &quot;mailMergeTemplateId&quot;);

                        bool formAttachment = false;
                        if (Boolean.TryParse(GetJsonValue((JsonObject)wfConnection[0][&quot;userData&quot;], &quot;formAttachment&quot;), out formAttachment))
                            ssEx.EmailNotification.FormAttachment = formAttachment;

                        bool workflowCommentAttachment = false;
                        if (Boolean.TryParse(GetJsonValue((JsonObject)wfConnection[0][&quot;userData&quot;], &quot;workflowCommentAttachment&quot;), out workflowCommentAttachment))
                            ssEx.EmailNotification.WorkflowAttachment = workflowCommentAttachment;

                        bool notifyThroughEmail = false;
                        if (Boolean.TryParse(GetJsonValue((JsonObject)wfConnection[0][&quot;userData&quot;], &quot;notifyThroughEmail&quot;), out notifyThroughEmail))
                            ssEx.EmailNotification.NotifyThroughEmail = notifyThroughEmail;
                    }

                    return;
                }

                if (targetActivity[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;ActivityContainer&quot;)
                {
                    //Get all the activities in an activity container
                    List&lt;JsonObject&gt; activityInContainer = wfStages.OfType&lt;JsonObject&gt;().Where(x =&gt; x.Keys.Contains(&quot;composite&quot;)
                        &amp;&amp; x[&quot;composite&quot;].ReadAs&lt;string&gt;() == targetActivity[&quot;id&quot;].ReadAs&lt;string&gt;()).ToList&lt;JsonObject&gt;();

                    //Order activites based on order in activity container
                    activityInContainer = activityInContainer.OrderBy(y =&gt; y[&quot;y&quot;].ReadAs&lt;int&gt;()).ToList&lt;JsonObject&gt;();

                    foreach (JsonObject targetActivityInContainer in activityInContainer)
                    {
                        errMsg = string.Empty;
                        if (targetActivityInContainer[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;FormStatusActivity&quot;)
                        {
                            SetFormStatus formStatus = (SetFormStatus)activityInstance.AddSetFormStatus();
                            formStatus.DisplayName = targetActivityInContainer[&quot;name&quot;].ReadAs&lt;string&gt;();
                            formStatus.FormStatus = GetJsonValue((JsonObject)targetActivityInContainer[&quot;userData&quot;], &quot;status&quot;);
                            formStatus.CanDeleteInStatus = GetJsonValue((JsonObject)targetActivityInContainer[&quot;userData&quot;], &quot;deleteValidation&quot;);
                            formStatus.ExecuteAlways = GetJsonValue((JsonObject)targetActivityInContainer[&quot;userData&quot;], &quot;executionMode&quot;) == &quot;1&quot;;
                        }
                        else if (targetActivityInContainer[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;DisplayMessageActivity&quot;)
                        {
                            SendValidationMessage sendValidationMessage = (SendValidationMessage)activityInstance.AddValidationMessage();
                            sendValidationMessage.SendMessage = GetJsonValue((JsonObject)targetActivityInContainer[&quot;userData&quot;][&quot;InParams&quot;][&quot;Message&quot;], &quot;paramValue&quot;);
                            sendValidationMessage.SendMessageType = targetActivityInContainer[&quot;userData&quot;][&quot;MessageType&quot;].ReadAs&lt;int&gt;();
                            sendValidationMessage.ExecuteAlways = GetJsonValue((JsonObject)targetActivityInContainer[&quot;userData&quot;], &quot;executionMode&quot;) == &quot;1&quot;;

                            sendValidationMessage.Init(sendValidationMessage.InstanceId,
                                GetResourceInstance(workflowDetails, GetJsonValue(targetActivityInContainer, &quot;id&quot;), provider, (JsonObject)targetActivityInContainer[&quot;userData&quot;][&quot;InParams&quot;][&quot;Message&quot;], formId, ref errMsg));
                            sendValidationMessage.DisplayName = targetActivityInContainer[&quot;name&quot;].ReadAs&lt;string&gt;();
                        }
                        else
                        {
                            ExternalCallInstance extActivity = (ExternalCallInstance)activityInstance.AddActivity();
                            extActivity.ExecuteAlways = GetJsonValue((JsonObject)targetActivityInContainer[&quot;userData&quot;], &quot;executionMode&quot;) == &quot;1&quot;;
                            extActivity.Init(GetResourceInstance(workflowDetails, GetJsonValue(targetActivityInContainer, &quot;id&quot;), provider, targetActivityInContainer, formId, ref errMsg));
                            extActivity.DisplayName = targetActivityInContainer[&quot;name&quot;].ReadAs&lt;string&gt;();
                        }
                        workflowDetails.AddError(targetActivityInContainer[&quot;name&quot;].ReadAs&lt;string&gt;(), errMsg);
                    }
                    //Output port of activity container
                    ParseActivities(workflowDetails, wfStages, targetActivity, &quot;output0&quot;, activityInstance, provider, formId);
                }

                if (targetActivity[&quot;type&quot;].ReadAs&lt;string&gt;() == &quot;ConditionsBlock&quot;)
                {
                    ConditionsBlock conditionBlock = (ConditionsBlock)activityInstance.AddIfBlockActivity();
                    //conditionBlock.DisplayName = targetActivity[&quot;name&quot;].ReadAs&lt;string&gt;();

                    JsonArray ifActivities = (JsonArray)targetActivity[&quot;entities&quot;];

                    for (int count = ifActivities.Count - 1; count &gt;= 0; count--)
                    {
                        errMsg = string.Empty;

                        JsonObject ifActivity = (JsonObject)ifActivities[count];
                        IfCondition ifCondition = (IfCondition)conditionBlock.AddIfActivity();
                        if (ifActivity[&quot;userData&quot;].ContainsKey(&quot;type&quot;))
                            ifCondition.UpdateCondition(GetResourceInstance(workflowDetails, GetJsonValue(ifActivity, &quot;id&quot;), provider, (JsonObject)ifActivity[&quot;userData&quot;], formId, ref errMsg));
                        ifCondition.DisplayName = ifActivity[&quot;text&quot;].ReadAs&lt;string&gt;();

                        workflowDetails.AddError(ifActivity[&quot;text&quot;].ReadAs&lt;string&gt;(), errMsg);

                        ParseActivities(workflowDetails, wfStages, targetActivity, &quot;output_&quot; + ifActivity[&quot;id&quot;].ReadAs&lt;string&gt;(), ifCondition, provider, formId);
                    }
                    //Output port of condition block
                    ParseActivities(workflowDetails, wfStages, targetActivity, &quot;output0&quot;, activityInstance, provider, formId);
                }
            }
        }

        private static IResourceInstance GetResourceInstance(WorkflowDetails workflowDetails, string activityGUID, BrixCoreDataProvider provider, JsonObject wfResource, string selectedFormId, ref string errMsg)
        {
            IResourceInstance resInstance = null;
            IResource resource = null;

            switch (wfResource[&quot;type&quot;].ReadAs&lt;string&gt;())
            {
                case &quot;Expressions&quot;:
                    JsonArray selectedOutParams = (JsonArray)wfResource[&quot;SelectedOutParams&quot;];
                    if (selectedOutParams.Count &gt; 0)
                    {
                        resource = ExpressionDataSource.Instance.GetResourceById(selectedOutParams[0].ReadAs&lt;string&gt;());
                        resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, null, ref errMsg);
                    }
                    break;

                case &quot;HostParameters&quot;:
                    JsonArray hostParam = (JsonArray)wfResource[&quot;SelectedOutParams&quot;];
                    if (hostParam.Count &gt; 0)
                    {
                        resource = workflowDetails.WorkflowTemplate.WFResources();
                        resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, false, wfResource, ref errMsg);
                    }
                    break;

                case &quot;GetFormData&quot;:
                    resInstance = GetXMLDataSourceResourceInstance(workflowDetails, activityGUID, provider, &quot;xmlget&quot;, (JsonObject)wfResource[&quot;userData&quot;], ref errMsg);
                    break;

                case &quot;SetFormData&quot;:
                    resInstance = GetXMLDataSourceResourceInstance(workflowDetails, activityGUID, provider, &quot;xmlset&quot;, (JsonObject)wfResource[&quot;userData&quot;], ref errMsg);
                    break;

                case &quot;CreateNewForm&quot;:
                    resInstance = GetXMLDataSourceResourceInstance(workflowDetails, activityGUID, provider, &quot;xmlcreate&quot;, (JsonObject)wfResource[&quot;userData&quot;], ref errMsg);
                    break;

                case &quot;SendEmailActivity&quot;:
                    resInstance = GetEnviornmentDataSourceResourceInstance(workflowDetails, activityGUID, provider, typeof(SendEmail).Name, (JsonObject)wfResource[&quot;userData&quot;], ref errMsg);
                    resInstance.InParams.GetParam(&quot;AttachCurrentDocument&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;AttachCurrentDocument&quot;);
                    break;

                case &quot;RequestDetailsActivity&quot;:
                    resInstance = GetEnviornmentDataSourceResourceInstance(workflowDetails, activityGUID, provider, &quot;RequestDetails&quot;, null, ref errMsg);
                    resInstance.InParams.GetParam(&quot;Key&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;Key&quot;);
                    break;

                case &quot;MorphWorkflowActivity&quot;:
                    resource = new MorphWorkflow();
                    resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, null, ref errMsg);

                    resInstance.InParams.GetParam(&quot;FormName&quot;).Value = selectedFormId;
                    resInstance.InParams.GetParam(&quot;morphedWorkflowGuid&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;morphedWorkflowGuid&quot;);
                    resInstance.InParams.GetParam(&quot;triggerActionName&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;triggerActionName&quot;);
                    resInstance.InParams.GetParam(&quot;notes&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;notes&quot;);

                    IParam inParam = resInstance.InParams.GetParam(&quot;FormInstanceId&quot;);
                    inParam.DerivedFrom = &quot;&quot;;
                    inParam.IsDerived = true;
                    inParam.IsResolved = false;
                    inParam.DerivedPath = &quot;_host_&quot; + workflowDetails.WorkflowTemplate.TemplateId.ToString2() + &quot;_associatedforminstance&quot;;
                    break;

                case &quot;SetDueDateActivity&quot;:
                    resource = new SetDueDateResource();
                    resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, null, ref errMsg);
                    resInstance.InParams.GetParam(&quot;DueDate&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;DueDate&quot;);
                    break;

                case &quot;SetStakeHoldersActivity&quot;:
                    resource = new SetStakeHoldersResource();
                    resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, null, ref errMsg);

                    foreach (string inParamName in resInstance.InParams.GetKeys())
                    {
                        IParam inSParam = resInstance.InParams.GetParam(inParamName);
                        if (inSParam != null &amp;&amp; wfResource[&quot;userData&quot;][&quot;InParams&quot;].ContainsKey(inSParam.Name))
                        {
                            JsonObject inParamValue = (JsonObject)wfResource[&quot;userData&quot;][&quot;InParams&quot;][inSParam.Name];
                            string paramValue = GetJsonValue(inParamValue, &quot;paramValue&quot;);
                            if (!string.IsNullOrEmpty(paramValue))
                                resInstance.InParams.GetParam(inParamName).Value = paramValue;
                            else
                            {
                                IResourceInstance rIns = GetResourceInstance(workflowDetails, activityGUID, provider, inParamValue, string.Empty, ref errMsg);
                                if (rIns != null)
                                {
                                    //Resinstance ID - GUID
                                    inSParam.DerivedFrom = rIns.InstanceId.ToString2();
                                    inSParam.IsDerived = true;
                                    inSParam.IsResolved = false;
                                    if (rIns.SelectedOutParams.GetKeys().Length &gt; 0)
                                    {
                                        //Resource path
                                        inSParam.DerivedPath = rIns.SelectedOutParams.GetParam(rIns.SelectedOutParams.GetKeys()[0], true).DerivedPath;
                                    }
                                    resInstance.AddInstance(rIns);
                                }
                            }
                        }
                    }
                    break;

                case &quot;IsUserInRoleActivity&quot;:
                    resource = new IsUserInRole();
                    resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, null, ref errMsg);
                    resInstance.InParams.GetParam(&quot;Role&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;Role&quot;);
                    break;

                case &quot;CreateNotificationActivity&quot;:
                    resource = new CreateNotificationResource();
                    resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, null, ref errMsg);

                    resInstance.InParams.GetParam(&quot;NotificationInfo&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;NotificationInfo&quot;);
                    resInstance.InParams.GetParam(&quot;Description&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;Description&quot;);
                    resInstance.InParams.GetParam(&quot;Notes&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;Notes&quot;);
                    resInstance.InParams.GetParam(&quot;ActionToBeTaken&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;ActionToBeTaken&quot;);
                    resInstance.InParams.GetParam(&quot;IsActionTaken&quot;).Value = (JsonObject)wfResource[&quot;userData&quot;][&quot;IsActionTaken&quot;].ReadAs&lt;bool&gt;();
                    resInstance.InParams.GetParam(&quot;ResponsiblePerson&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;ResponsiblePerson&quot;);
                    resInstance.InParams.GetParam(&quot;ByPerson&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;ByPerson&quot;);
                    resInstance.InParams.GetParam(&quot;DueDate&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;DueDate&quot;);
                    resInstance.InParams.GetParam(&quot;Priority&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;Priority&quot;);
                    resInstance.InParams.GetParam(&quot;Severity&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;Severity&quot;);
                    resInstance.InParams.GetParam(&quot;IsNoticed&quot;).Value = (JsonObject)wfResource[&quot;userData&quot;][&quot;IsNoticed&quot;].ReadAs&lt;bool&gt;();
                    resInstance.InParams.GetParam(&quot;BusinessType&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;BusinessType&quot;);
                    resInstance.InParams.GetParam(&quot;NotificationType&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;NotificationType&quot;);
                    break;

                case &quot;CallFormResource&quot;:
                    string selectedResource = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;selectedResource&quot;);
                    if (!string.IsNullOrEmpty(selectedResource) &amp;&amp; workflowDetails.FormCustomResources.Count &gt; 0)
                    {
                        resource = workflowDetails.FormCustomResources.FirstOrDefault(r =&gt; String.Equals(r.Id, selectedResource, StringComparison.OrdinalIgnoreCase));
                        if (resource != null)
                            resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, (JsonObject)wfResource[&quot;userData&quot;], ref errMsg);
                    }
                    break;

                case &quot;CodeActionActivity&quot;:
                    resource = new CodeActivityResource();
                    resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, null, ref errMsg);

                    resInstance.InParams.GetParam(&quot;Code&quot;).Value = GetJsonValue((JsonObject)wfResource[&quot;userData&quot;], &quot;code&quot;);
                    break;
            }
            return resInstance;
        }

        private static IResourceInstance GetCustomResourceInstance(WorkflowDetails workflowDetails,
            string activityGUID, BrixCoreDataProvider provider, IResource resource, bool includeAllOutputParameters, JsonObject userData, ref string errMsg)
        {
            IResourceInstance resInstance = resource.GetNewResourceInstance();
            resInstance.UniqueId = Guid.Parse(activityGUID);
            IParams selectedOutParms = resource.GetOutputParamNames().Clone();

            AddOutputParameters(includeAllOutputParameters, provider, resource, resInstance, userData, ref errMsg);
            AddInputParameters(workflowDetails, activityGUID, provider, resInstance, userData, ref errMsg);

            return resInstance;
        }

        private static IResourceInstance GetEnviornmentDataSourceResourceInstance(WorkflowDetails workflowDetails,
            string activityGUID, BrixCoreDataProvider provider, string resourceId, JsonObject userData, ref string errMsg)
        {
            IResourceInstance resInstance = null;
            try
            {
                IDataSource dataSource = provider.GetDataSource(&quot;env&quot;, false);

                //Get resource instance, add selected out parameters and add input paramters.
                IResource resource = dataSource.GetResourceById(resourceId);

                resInstance = GetCustomResourceInstance(workflowDetails, activityGUID, provider, resource, true, userData, ref errMsg);
            }
            catch (Exception ex)
            {
                return null;
            }
            return resInstance;
        }

        private static IResourceInstance GetXMLDataSourceResourceInstance(WorkflowDetails workflowDetails,
            string activityGUID, BrixCoreDataProvider provider, string xmlType, JsonObject userData, ref string errMsg)
        {
            IResourceInstance resInstance = null;
            try
            {
                string selectedForm = GetJsonValue(userData, &quot;selectedForm&quot;);
                if (!string.IsNullOrEmpty(selectedForm))
                {
                    IDataSource dataSource = provider.GetDataSource(xmlType, false);

                    //Get resource instance, add selected out parameters and add input paramters.
                    IResource resource = dataSource.GetResourceById(selectedForm);
                    resInstance = resource.GetNewResourceInstance();
                    resInstance.UniqueId = Guid.Parse(activityGUID);

                    AddOutputParameters(false, provider, resource, resInstance, userData, ref errMsg);

                    if (xmlType == &quot;xmlcreate&quot;)
                    {
                        StringBuilder linkedFields = new StringBuilder();
                        AddInputParameters(workflowDetails, activityGUID, provider, resInstance, userData, ref errMsg, linkedFields);

                        XmlDocument linkedActivityFields = new XmlDocument();
                        linkedActivityFields.LoadXml(&quot;&lt;XML&gt;&lt;Activity Name = &#39;&quot; + GetJsonValue(userData, &quot;name&quot;) + &quot;&#39; LinkedForm = &#39;&quot; + selectedForm.ToLower2() + &quot;&#39; &gt;&lt;Fields&gt;&quot; + linkedFields.ToString2() + &quot;&lt;/Fields&gt;&lt;/Activity&gt;&lt;/XML&gt;&quot;);

                        XmlDocument linkedFormXML = new XmlDocument();
                        if (string.IsNullOrEmpty(workflowDetails.WorkflowTemplate.LinkedFormXML)) workflowDetails.WorkflowTemplate.LinkedFormXML = &quot;&lt;XML/&gt;&quot;;
                        linkedFormXML.LoadXml(workflowDetails.WorkflowTemplate.LinkedFormXML);

                        XmlNode copiedNode = linkedFormXML.ImportNode(linkedActivityFields.SelectSingleNode(&quot;//Activity&quot;), true);
                        linkedFormXML.DocumentElement.AppendChild(copiedNode);

                        workflowDetails.WorkflowTemplate.LinkedFormXML = linkedFormXML.OuterXml;
                    }
                    else
                    {
                        AddInputParameters(workflowDetails, activityGUID, provider, resInstance, userData, ref errMsg);
                    }
                }
            }
            catch (Exception ex)
            {
                throw ex;
            }
            return resInstance;
        }

        private static void AddOutputParameters(bool includeAllOutputParameters, BrixCoreDataProvider provider, IResource resource, IResourceInstance resInstance, JsonObject userData, ref string errMsg)
        {
            IParams selectedOutParms = resource.GetOutputParamNames().Clone();

            if (includeAllOutputParameters || userData == null)
            {
                //Add all output params in SelectedOutParams.
                foreach (IParam pm in selectedOutParms.Contents.Values)
                {
                    pm.DerivedFrom = resInstance.InstanceId.ToString2();
                    pm.IsResolved = false;
                    resInstance.SelectedOutParams.SetParam(pm, true);
                }
            }
            else if (userData != null &amp;&amp; userData.ContainsKey(&quot;SelectedOutParams&quot;))
            {
                JsonArray fields = (JsonArray)userData[&quot;SelectedOutParams&quot;];
                if (fields.Count == 0)
                {
                    errMsg += &quot;Please select at least one output parameter. \r\n&quot;;
                }

                for (int i = 0; i &lt; fields.Count; i++)
                {
                    IParam outParam = selectedOutParms.GetParam(fields[i].ReadAs&lt;string&gt;(), true);
                    if (outParam != null)
                    {
                        outParam.DerivedFrom = resInstance.InstanceId.ToString2();
                        outParam.IsResolved = false;
                        resInstance.SelectedOutParams.SetParam(outParam, true);
                    }
                }
            }
        }

        private static void AddInputParameters(WorkflowDetails workflowDetails,
            string activityGUID, BrixCoreDataProvider provider, IResourceInstance resInstance, JsonObject userData, ref string errMsg, StringBuilder linkedFields = null)
        {
            bool isAllMandatoryInputParameterMapped = true;
            if (userData != null &amp;&amp; userData.ContainsKey(&quot;InParams&quot;))
            {
                foreach (string inParamName in resInstance.InParams.GetKeys())
                {
                    IParam inParam = resInstance.InParams.GetParam(inParamName);
                    if (inParam != null &amp;&amp; userData[&quot;InParams&quot;].ContainsKey(inParam.Name))
                    {
                        JsonObject inParamValue = (JsonObject)userData[&quot;InParams&quot;][inParam.Name];
                        string linkedField = GetJsonValue(inParamValue, &quot;linkedField&quot;);
                        if (linkedFields != null) linkedFields.Append(&quot;&lt;Field name=&#39;&quot; + inParam.Name + &quot;&#39; value=&#39;&quot; + linkedField + &quot;&#39; /&gt;&quot;);
                        if (linkedFields == null || linkedField == &quot;DNS&quot;)
                        {
                            string paramValue = GetJsonValue(inParamValue, &quot;paramValue&quot;);
                            if (!string.IsNullOrEmpty(paramValue))
                                inParam.Value = paramValue;
                            else
                            {
                                IResourceInstance rIns = GetResourceInstance(workflowDetails, activityGUID, provider, inParamValue, string.Empty, ref errMsg);

                                if (((Param)inParam).IsMandatory &amp;&amp; (rIns == null || rIns.SelectedOutParams.GetKeys().Length == 0))
                                    isAllMandatoryInputParameterMapped = false;

                                if (rIns != null)
                                {
                                    //Resinstance ID - GUID
                                    inParam.DerivedFrom = rIns.InstanceId.ToString2();
                                    inParam.IsDerived = true;
                                    inParam.IsResolved = false;
                                    if (rIns.SelectedOutParams.GetKeys().Length &gt; 0)
                                    {
                                        //Resource path
                                        inParam.DerivedPath = rIns.SelectedOutParams.GetParam(rIns.SelectedOutParams.GetKeys()[0], true).DerivedPath;
                                    }
                                    resInstance.AddInstance(rIns);
                                }
                            }
                        }
                    }
                }
            }
            if (!isAllMandatoryInputParameterMapped)
                errMsg += &quot;Please map all input parameters. &quot;;
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[38,9,38,125,0],[39,9,39,74,0],[42,9,42,10,0],[43,13,43,46,0],[44,13,44,45,0],[45,9,45,10,0],[48,9,48,10,0],[49,13,49,77,0],[50,13,50,77,0],[51,13,51,79,0],[52,13,52,85,0],[54,13,54,100,0],[55,13,55,98,0],[56,13,56,102,0],[57,13,57,105,0],[58,13,58,97,0],[59,13,59,93,0],[60,13,60,95,0],[61,13,61,100,0],[62,13,62,100,0],[63,13,63,93,0],[64,13,64,110,0],[66,13,66,104,0],[68,13,68,116,0],[69,13,69,59,0],[70,13,70,14,0],[71,17,71,30,0],[72,17,72,18,0],[73,21,73,107,0],[74,21,74,112,0],[75,21,75,113,0],[76,21,76,108,0],[77,21,77,110,0],[78,21,78,114,0],[80,21,80,120,0],[81,21,81,132,0],[82,21,82,125,0],[83,21,83,126,0],[84,21,84,121,0],[85,21,85,133,0],[86,21,86,130,0],[87,21,87,130,0],[88,21,88,131,0],[89,21,89,125,0],[90,21,90,125,0],[91,21,91,127,0],[92,21,92,127,0],[94,21,94,107,0],[95,21,95,113,0],[96,21,96,106,0],[97,21,97,95,0],[98,21,98,88,0],[99,21,99,86,0],[100,21,100,85,0],[101,21,101,89,0],[102,21,102,87,0],[103,21,103,96,0],[104,17,104,18,0],[105,17,105,119,0],[106,13,106,14,0],[107,13,107,26,0],[108,13,108,14,0],[109,17,109,87,0],[110,17,110,115,0],[111,13,111,14,0],[112,9,112,10,0],[115,9,115,10,0],[116,13,116,29,0],[117,13,117,14,0],[118,17,118,139,0],[119,17,119,139,0],[121,17,121,37,0],[122,17,122,80,0],[123,17,123,18,0],[124,21,124,90,0],[125,21,125,44,0],[126,21,126,22,0],[127,25,127,96,0],[128,25,128,96,0],[129,25,129,86,0],[130,25,130,178,0],[131,21,131,22,0],[133,25,133,114,0],[134,17,134,18,0],[136,17,136,55,0],[137,21,137,56,0],[139,17,139,34,0],[141,17,141,29,0],[143,17,143,143,0],[145,17,145,85,0],[146,13,146,14,0],[148,13,148,49,0],[149,9,149,10,0],[152,9,152,10,0],[153,13,153,66,0],[155,13,155,68,0],[156,13,156,14,0],[157,17,157,107,0],[158,21,158,68,0],[159,22,159,112,0],[160,21,160,68,0],[162,21,162,70,0],[163,13,163,14,0],[165,13,165,14,0],[167,17,167,66,0],[168,13,168,14,0],[170,13,170,55,0],[171,13,171,38,0],[172,13,172,28,0],[173,9,173,10,0],[176,9,176,10,0],[177,13,177,34,0],[178,13,178,31,0],[179,9,179,10,0],[182,9,182,10,0],[183,13,183,47,0],[184,13,184,60,0],[185,13,185,33,0],[186,13,186,46,0],[187,13,187,14,0],[188,17,188,86,0],[189,13,189,14,0],[190,13,190,86,0],[191,13,191,82,0],[195,13,195,46,0],[196,13,196,14,0],[197,17,197,54,0],[198,17,198,86,0],[199,17,199,86,0],[200,17,200,92,0],[201,17,201,107,0],[202,17,202,37,0],[205,13,205,14,0],[214,13,214,44,0],[215,13,215,40,0],[216,9,216,10,0],[219,9,219,10,0],[220,13,220,37,0],[220,38,220,45,0],[222,13,222,46,0],[223,13,223,14,0],[224,17,224,73,0],[225,17,225,81,0],[226,13,226,14,0],[227,13,227,69,0],[229,13,229,46,0],[230,13,230,14,0],[231,17,231,73,0],[232,17,232,73,0],[233,17,233,75,0],[234,17,234,79,0],[235,13,235,14,0],[237,13,237,78,0],[238,13,238,77,0],[239,9,239,10,0],[242,9,242,10,0],[244,13,244,14,0],[245,17,245,74,0],[246,17,246,18,0],[247,21,247,154,0],[248,21,248,75,0],[249,21,249,83,0],[250,17,250,18,0],[251,13,251,14,0],[252,13,252,34,0],[253,13,253,14,0],[254,17,254,70,0],[255,17,255,74,0],[256,17,256,24,0],[258,13,258,83,0],[259,9,259,10,0],[262,9,262,10,0],[263,13,263,48,0],[264,13,264,146,0],[265,13,265,34,0],[266,13,266,14,0],[267,17,267,49,0],[268,17,268,71,0],[270,17,270,70,0],[272,17,272,82,0],[273,17,273,18,0],[274,21,274,132,0],[275,21,275,110,0],[276,21,276,127,0],[277,17,277,18,0],[279,17,279,18,0],[280,21,280,198,0],[281,21,281,67,0],[282,21,282,22,0],[283,25,283,136,0],[284,25,284,131,0],[285,21,285,22,0],[286,17,286,18,0],[287,17,287,67,0],[289,17,289,99,0],[290,17,290,18,0],[291,21,291,64,0],[293,21,294,144,0],[296,21,297,136,0],[299,21,299,83,0],[300,21,300,60,0],[301,21,301,22,0],[302,25,302,96,0],[303,21,303,22,0],[304,17,304,18,0],[306,17,306,163,0],[308,17,308,43,0],[309,13,309,14,0],[310,13,310,33,0],[311,9,311,10,0],[314,9,314,10,0],[315,13,317,38,0],[318,13,318,114,0],[319,13,319,14,0],[320,17,320,49,0],[321,17,321,49,0],[322,17,322,49,0],[323,17,323,51,0],[324,17,324,56,0],[326,17,326,50,0],[327,21,327,53,0],[328,13,328,14,0],[329,9,329,10,0],[332,9,332,10,0],[333,13,333,53,0],[334,13,334,86,0],[335,13,335,47,0],[336,13,336,54,0],[337,13,337,53,0],[338,13,338,49,0],[339,13,339,51,0],[340,13,340,29,0],[341,13,341,14,0],[342,17,342,69,0],[343,17,343,83,0],[344,17,344,84,0],[345,17,345,92,0],[346,13,346,14,0],[347,13,348,122,0],[349,13,349,42,0],[350,9,350,10,0],[354,38,354,42,0],[354,43,354,47,0],[355,38,355,42,0],[355,43,355,47,0],[356,44,356,48,0],[356,49,356,53,0],[357,36,357,40,0],[357,41,357,45,0],[358,38,358,42,0],[358,43,358,47,0],[360,42,360,46,0],[360,47,360,51,0],[362,13,362,67,0],[366,17,366,18,0],[367,21,367,51,0],[368,25,368,50,0],[370,21,370,154,0],[371,21,371,42,0],[372,21,372,22,0],[373,25,373,79,0],[374,25,374,135,0],[375,21,375,22,0],[377,21,377,46,0],[378,17,378,18,0],[380,17,380,18,0],[381,21,381,47,0],[382,17,382,18,0],[385,13,385,59,0],[389,17,389,18,0],[390,21,390,48,0],[391,21,391,22,0],[392,25,392,81,0],[393,21,393,22,0],[394,21,394,43,0],[395,17,395,18,0],[398,13,398,85,0],[401,13,401,14,0],[402,17,402,51,0],[403,17,403,18,0],[404,21,404,59,0],[405,25,405,57,0],[407,25,407,59,0],[408,17,408,18,0],[409,13,409,14,0],[412,13,412,14,0],[413,17,413,46,0],[414,17,414,46,0],[415,17,415,18,0],[416,21,416,32,0],[417,25,417,48,0],[417,48,417,81,0],[417,81,417,83,0],[417,25,417,83,0],[418,26,418,101,0],[419,25,419,77,0],[421,21,421,39,0],[422,17,422,18,0],[423,17,423,31,0],[424,13,424,14,0],[428,9,428,10,0],[429,13,429,64,0],[430,13,430,14,0],[431,17,431,59,0],[433,13,433,42,0],[434,9,434,10,0],[437,9,437,10,0],[438,13,438,64,0],[439,17,439,64,0],[441,17,441,67,0],[442,9,442,10,0],[448,40,448,44,0],[448,45,448,49,0],[453,56,453,60,0],[453,61,453,65,0],[462,32,462,36,0],[462,37,462,41,0],[463,34,463,38,0],[463,39,463,43,0],[464,41,464,45,0],[464,46,464,50,0],[469,34,469,38,0],[469,39,469,43,0],[470,37,470,41,0],[470,42,470,46,0],[475,37,475,41,0],[475,42,475,46,0],[476,42,476,46,0],[476,47,476,51,0],[477,39,477,43,0],[477,44,477,48,0],[482,37,482,41,0],[482,42,482,46,0],[483,42,483,46,0],[483,47,483,51,0],[488,37,488,41,0],[488,42,488,46,0],[489,42,489,46,0],[489,47,489,51,0],[494,34,494,38,0],[494,39,494,43,0],[495,41,495,45,0],[495,46,495,50,0],[496,38,496,42,0],[496,43,496,47,0],[497,39,497,43,0],[497,44,497,48,0],[502,44,502,48,0],[502,49,502,53,0],[503,62,503,66,0],[503,67,503,71,0],[504,61,504,65,0],[504,66,504,70,0],[509,9,509,10,0],[510,13,510,61,0],[512,13,512,40,0],[513,13,513,14,0],[515,17,515,81,0],[516,17,516,24,0],[516,26,516,31,0],[516,32,516,34,0],[516,35,516,40,0],[517,17,517,18,0],[518,21,522,24,0],[523,17,523,18,0],[524,13,524,14,0],[526,13,526,14,0],[528,17,528,115,0],[529,17,529,83,0],[530,17,530,18,0],[531,21,531,114,0],[532,21,532,62,0],[533,21,533,67,0],[534,17,534,18,0],[535,17,536,35,0],[536,35,536,57,0],[536,57,537,34,0],[537,34,537,43,0],[537,43,537,45,0],[535,17,537,45,0],[538,17,538,24,0],[538,26,538,31,0],[538,32,538,34,0],[538,35,538,40,0],[539,17,539,18,0],[540,21,545,24,0],[546,17,546,18,0],[549,17,549,121,0],[551,17,551,24,0],[551,26,551,31,0],[551,32,551,34,0],[551,35,551,40,0],[552,17,552,18,0],[553,21,558,24,0],[559,17,559,18,0],[560,13,560,14,0],[561,13,561,45,0],[562,9,562,10,0],[566,9,566,10,0],[567,13,567,82,0],[568,13,568,114,0],[569,13,569,20,0],[569,22,569,30,0],[569,31,569,33,0],[569,34,569,47,0],[570,13,570,14,0],[571,17,576,20,0],[577,13,577,14,0],[578,13,578,50,0],[579,9,579,10,0],[583,9,583,10,0],[584,13,584,85,0],[585,13,585,116,0],[586,13,586,20,0],[586,22,586,29,0],[586,30,586,32,0],[586,33,586,53,0],[587,13,587,14,0],[588,17,592,20,0],[593,13,593,14,0],[594,13,594,53,0],[595,9,595,10,0],[599,9,599,10,0],[600,13,600,88,0],[601,13,601,99,0],[602,13,602,20,0],[602,22,602,29,0],[602,30,602,32,0],[602,33,602,54,0],[603,13,603,14,0],[604,17,608,20,0],[609,13,609,14,0],[610,13,610,54,0],[611,9,611,10,0],[615,9,615,10,0],[616,13,616,103,0],[617,13,617,44,0],[618,13,618,14,0],[619,17,619,105,0],[621,17,622,31,0],[622,31,627,25,0],[627,25,627,26,0],[621,17,627,26,0],[630,13,630,25,0],[631,9,631,10,0],[634,9,634,10,0],[635,13,635,146,0],[636,13,636,67,0],[637,13,637,137,0],[638,13,638,40,0],[640,13,640,98,0],[642,13,643,27,0],[643,27,647,21,0],[647,21,647,22,0],[642,13,647,22,0],[648,9,648,10,0],[652,9,652,10,0],[653,13,653,73,0],[655,13,656,31,0],[656,31,656,126,0],[656,126,657,32,0],[657,32,661,26,0],[661,26,661,27,0],[655,13,661,27,0],[663,13,663,26,0],[664,9,664,10,0],[668,9,668,10,0],[669,13,669,42,0],[671,13,671,122,0],[672,13,672,34,0],[673,13,673,14,0],[674,17,674,72,0],[675,17,675,59,0],[676,17,676,18,0],[677,21,677,72,0],[678,21,678,42,0],[679,21,679,22,0],[680,25,681,94,0],[683,25,683,75,0],[685,25,687,36,0],[687,36,691,30,0],[691,30,691,31,0],[685,25,691,31,0],[693,25,695,36,0],[695,36,701,30,0],[701,30,701,31,0],[693,25,701,31,0],[702,21,702,22,0],[703,17,703,18,0],[704,13,704,14,0],[706,13,706,27,0],[707,9,707,10,0],[711,9,711,10,0],[712,13,712,103,0],[714,13,714,69,0],[715,13,715,98,0],[717,13,717,20,0],[717,22,717,28,0],[717,29,717,31,0],[717,32,717,45,0],[718,13,718,14,0],[719,17,727,51,0],[727,51,731,45,0],[731,45,733,49,0],[733,49,733,78,0],[733,78,734,50,0],[734,50,740,44,0],[740,44,742,19,0],[719,17,742,19,0],[743,17,743,41,0],[744,13,744,14,0],[745,13,745,45,0],[746,9,746,10,0],[750,9,750,10,0],[751,13,751,36,0],[752,13,752,122,0],[753,13,753,34,0],[754,13,754,14,0],[755,17,755,82,0],[756,17,756,40,0],[757,17,757,18,0],[758,21,758,78,0],[759,21,759,43,0],[760,21,760,89,0],[761,21,761,45,0],[762,21,762,22,0],[763,25,763,85,0],[764,25,764,61,0],[765,25,765,99,0],[766,25,766,39,0],[767,21,767,22,0],[768,17,768,18,0],[769,13,769,14,0],[770,13,770,34,0],[771,9,771,10,0],[775,9,775,10,0],[776,13,777,76,0],[778,13,778,42,0],[780,13,780,92,0],[781,13,781,33,0],[782,9,782,10,0],[786,9,786,10,0],[787,13,787,64,0],[788,13,788,122,0],[789,13,789,34,0],[790,13,790,14,0],[791,17,791,74,0],[792,17,792,40,0],[793,17,793,18,0],[794,21,794,63,0],[795,21,796,35,0],[796,35,796,75,0],[796,75,797,36,0],[797,36,802,30,0],[802,30,802,31,0],[795,21,802,31,0],[803,17,803,18,0],[804,13,804,14,0],[806,13,806,26,0],[807,9,807,10,0],[811,9,811,10,0],[812,13,812,103,0],[814,13,814,75,0],[815,13,815,125,0],[816,13,816,20,0],[816,22,816,35,0],[816,36,816,38,0],[816,39,816,67,0],[817,13,817,14,0],[818,17,818,57,0],[819,17,819,49,0],[820,17,820,39,0],[821,17,821,63,0],[823,17,824,45,0],[826,17,826,53,0],[827,21,834,24,0],[835,13,835,14,0],[836,13,836,63,0],[837,9,837,10,0],[840,9,840,10,0],[841,13,841,29,0],[841,30,841,37,0],[842,13,842,48,0],[843,13,843,59,0],[843,60,843,67,0],[844,13,844,51,0],[845,13,845,27,0],[845,28,845,35,0],[846,13,846,28,0],[847,13,847,38,0],[848,9,848,10,0],[852,9,852,10,0],[853,13,853,103,0],[854,13,854,75,0],[856,13,856,76,0],[857,13,858,55,0],[860,13,862,35,0],[862,35,866,29,0],[866,29,866,30,0],[860,13,866,30,0],[868,13,868,35,0],[869,9,869,10,0],[872,9,872,10,0],[873,13,873,60,0],[874,13,874,53,0],[876,13,876,82,0],[877,13,877,35,0],[878,13,878,45,0],[880,13,880,20,0],[880,22,880,35,0],[880,36,880,38,0],[880,39,880,57,0],[881,13,881,14,0],[882,17,882,75,0],[883,21,883,44,0],[884,17,884,45,0],[886,17,886,100,0],[887,13,887,14,0],[888,13,888,43,0],[889,9,889,10,0],[893,9,893,10,0],[894,13,894,146,0],[895,13,895,67,0],[897,13,897,136,0],[898,9,898,10,0],[902,9,902,10,0],[903,13,903,146,0],[904,13,904,67,0],[906,13,906,76,0],[907,9,907,10,0],[911,9,911,10,0],[912,13,912,69,0],[913,13,913,88,0],[914,13,914,67,0],[915,13,915,14,0],[916,17,917,37,0],[917,37,922,31,0],[922,31,922,32,0],[916,17,922,32,0],[923,13,923,14,0],[924,13,924,31,0],[925,9,925,10,0],[932,9,932,10,0],[933,13,933,146,0],[934,13,934,67,0],[936,13,936,37,0],[937,13,937,83,0],[938,13,938,14,0],[939,17,939,70,0],[940,17,940,83,0],[941,17,941,38,0],[942,13,942,14,0],[944,13,944,48,0],[945,13,945,44,0],[945,45,945,83,0],[946,13,946,59,0],[948,13,948,149,0],[949,13,949,101,0],[950,9,950,10,0],[954,9,954,10,0],[956,13,956,14,0],[957,17,957,84,0],[959,17,959,63,0],[960,21,960,119,0],[962,17,962,79,0],[964,17,964,83,0],[966,17,966,82,0],[968,17,968,60,0],[969,21,969,63,0],[971,17,971,50,0],[972,21,972,122,0],[974,21,974,48,0],[976,13,976,33,0],[977,13,977,14,0],[978,17,978,48,0],[980,9,980,10,0],[983,9,983,10,0],[984,13,984,42,0],[985,13,985,146,0],[986,13,986,67,0],[988,13,988,80,0],[990,13,990,73,0],[991,13,991,71,0],[992,13,992,68,0],[994,13,994,103,0],[995,13,995,23,0],[996,13,996,14,0],[997,17,997,76,0],[998,17,998,56,0],[999,17,999,127,0],[1001,17,1001,82,0],[1002,13,1002,14,0],[1004,13,1004,30,0],[1005,13,1005,14,0],[1006,17,1006,158,0],[1007,17,1007,18,0],[1008,21,1008,116,0],[1009,21,1009,28,0],[1011,13,1011,14,0],[1013,13,1013,44,0],[1014,13,1014,85,0],[1015,13,1015,95,0],[1016,13,1016,86,0],[1017,13,1018,99,0],[1020,13,1020,73,0],[1021,13,1021,58,0],[1022,13,1022,53,0],[1024,13,1024,20,0],[1024,22,1024,36,0],[1024,37,1024,39,0],[1024,40,1024,65,0],[1025,13,1025,14,0],[1026,17,1026,54,0],[1027,17,1027,50,0],[1028,13,1028,14,0],[1030,13,1030,74,0],[1032,13,1032,104,0],[1034,13,1034,82,0],[1034,82,1036,64,0],[1036,64,1036,87,0],[1034,13,1036,87,0],[1038,13,1038,20,0],[1038,22,1038,40,0],[1038,41,1038,43,0],[1038,44,1038,52,0],[1039,13,1039,14,0],[1040,17,1040,155,0],[1041,17,1041,117,0],[1042,13,1042,14,0],[1045,13,1045,20,0],[1045,22,1045,36,0],[1045,37,1045,39,0],[1045,40,1045,65,0],[1046,13,1046,14,0],[1047,17,1047,54,0],[1048,17,1048,80,0],[1049,17,1049,24,0],[1049,26,1049,46,0],[1049,47,1049,49,0],[1049,50,1049,73,0],[1050,17,1050,18,0],[1051,21,1051,82,0],[1052,17,1052,18,0],[1053,13,1053,14,0],[1055,13,1055,30,0],[1056,13,1056,14,0],[1057,17,1057,64,0],[1058,13,1058,14,0],[1059,9,1059,10,0],[1062,9,1062,10,0],[1063,13,1063,41,0],[1064,13,1064,72,0],[1065,13,1065,14,0],[1066,17,1066,58,0],[1067,13,1067,14,0],[1068,13,1068,26,0],[1069,9,1069,10,0],[1073,9,1073,10,0],[1074,13,1074,42,0],[1075,13,1075,80,0],[1077,13,1077,100,0],[1079,13,1079,78,0],[1081,13,1081,87,0],[1082,13,1082,83,0],[1083,13,1083,40,0],[1083,41,1083,92,0],[1084,13,1084,38,0],[1084,39,1084,92,0],[1086,13,1086,67,0],[1088,13,1088,82,0],[1089,17,1089,81,0],[1091,13,1091,107,0],[1092,13,1092,109,0],[1094,13,1094,53,0],[1095,13,1095,149,0],[1096,13,1096,14,0],[1097,17,1097,24,0],[1097,26,1097,50,0],[1097,51,1097,53,0],[1097,54,1097,95,0],[1098,17,1098,18,0],[1099,21,1099,83,0],[1100,17,1100,18,0],[1101,17,1101,99,0],[1102,13,1102,14,0],[1103,13,1103,99,0],[1104,17,1104,75,0],[1106,13,1106,45,0],[1107,13,1107,44,0],[1108,13,1108,14,0],[1109,17,1109,147,0],[1110,17,1110,18,0],[1111,21,1111,28,0],[1111,30,1111,52,0],[1111,53,1111,55,0],[1111,56,1111,95,0],[1112,21,1112,22,0],[1113,25,1113,77,0],[1114,21,1114,22,0],[1115,21,1115,87,0],[1116,17,1116,18,0],[1118,17,1118,70,0],[1119,21,1119,77,0],[1120,13,1120,14,0],[1122,13,1122,36,0],[1123,13,1123,92,0],[1124,17,1124,59,0],[1126,13,1126,130,0],[1127,13,1127,64,0],[1128,13,1128,108,0],[1129,13,1129,72,0],[1130,13,1130,46,0],[1132,13,1132,69,0],[1134,13,1134,20,0],[1134,22,1134,41,0],[1134,42,1134,44,0],[1134,45,1134,75,0],[1135,13,1135,14,0],[1136,17,1136,75,0],[1138,17,1138,72,0],[1139,17,1139,79,0],[1140,17,1140,108,0],[1141,17,1141,189,0],[1142,17,1142,120,0],[1144,17,1145,57,0],[1146,13,1146,14,0],[1148,13,1148,41,0],[1149,9,1149,10,0],[1152,9,1152,10,0],[1153,13,1153,20,0],[1153,22,1153,39,0],[1153,40,1153,42,0],[1153,43,1153,57,0],[1154,13,1154,14,0],[1155,17,1155,81,0],[1156,17,1156,83,0],[1157,17,1157,18,0],[1158,21,1158,80,0],[1159,21,1159,60,0],[1159,60,1159,89,0],[1159,89,1159,98,0],[1159,21,1159,98,0],[1160,17,1160,18,0],[1161,17,1161,50,0],[1161,51,1161,111,0],[1162,13,1162,14,0],[1163,9,1163,10,0],[1166,9,1166,10,0],[1167,13,1167,71,0],[1167,71,1169,96,0],[1169,96,1169,119,0],[1167,13,1169,119,0],[1171,13,1171,60,0],[1172,13,1172,14,0],[1173,17,1173,71,0],[1173,71,1173,147,0],[1173,147,1173,170,0],[1173,17,1173,170,0],[1175,17,1175,64,0],[1176,21,1176,54,0],[1177,13,1177,14,0],[1178,13,1178,25,0],[1179,9,1179,10,0],[1183,9,1183,10,0],[1184,13,1184,42,0],[1185,13,1185,124,0],[1187,13,1187,40,0],[1188,13,1188,14,0],[1190,17,1192,78,0],[1193,17,1193,18,0],[1195,21,1195,91,0],[1196,21,1196,78,0],[1198,21,1198,81,0],[1198,81,1200,106,0],[1200,106,1200,129,0],[1198,21,1200,129,0],[1202,21,1202,72,0],[1203,21,1203,22,0],[1204,25,1204,124,0],[1205,25,1205,74,0],[1207,25,1207,56,0],[1209,25,1210,90,0],[1211,25,1211,26,0],[1212,29,1212,36,0],[1212,38,1212,47,0],[1212,48,1212,50,0],[1212,51,1212,109,0],[1213,29,1213,30,0],[1214,33,1214,71,0],[1215,29,1215,30,0],[1216,29,1216,93,0],[1217,25,1217,26,0],[1219,25,1219,56,0],[1221,25,1222,90,0],[1223,25,1223,26,0],[1224,29,1224,36,0],[1224,38,1224,47,0],[1224,48,1224,50,0],[1224,51,1224,109,0],[1225,29,1225,30,0],[1226,33,1226,71,0],[1227,29,1227,30,0],[1228,29,1228,93,0],[1229,25,1229,26,0],[1231,25,1231,142,0],[1232,25,1232,147,0],[1234,25,1234,53,0],[1235,25,1235,139,0],[1236,29,1236,84,0],[1238,25,1238,64,0],[1239,25,1239,161,0],[1240,29,1240,99,0],[1242,25,1242,57,0],[1243,25,1243,147,0],[1244,29,1244,92,0],[1245,21,1245,22,0],[1247,21,1247,28,0],[1250,17,1250,84,0],[1251,17,1251,18,0],[1253,21,1253,101,0],[1253,101,1254,100,0],[1254,100,1254,123,0],[1253,21,1254,123,0],[1257,21,1257,76,0],[1257,76,1257,96,0],[1257,96,1257,119,0],[1257,21,1257,119,0],[1259,21,1259,28,0],[1259,30,1259,66,0],[1259,67,1259,69,0],[1259,70,1259,89,0],[1260,21,1260,22,0],[1261,25,1261,47,0],[1262,25,1262,104,0],[1263,25,1263,26,0],[1264,29,1264,107,0],[1265,29,1265,105,0],[1266,29,1266,127,0],[1267,29,1267,144,0],[1268,29,1268,144,0],[1269,25,1269,26,0],[1270,30,1270,113,0],[1271,25,1271,26,0],[1272,29,1272,138,0],[1273,29,1273,166,0],[1274,29,1274,136,0],[1275,29,1275,155,0],[1277,29,1278,222,0],[1279,29,1279,116,0],[1280,25,1280,26,0],[1282,25,1282,26,0],[1283,29,1283,117,0],[1284,29,1284,145,0],[1285,29,1285,188,0],[1286,29,1286,106,0],[1287,25,1287,26,0],[1288,25,1288,110,0],[1289,21,1289,22,0],[1291,21,1291,127,0],[1292,17,1292,18,0],[1294,17,1294,82,0],[1295,17,1295,18,0],[1296,21,1296,109,0],[1299,21,1299,84,0],[1301,26,1301,60,0],[1301,62,1301,72,0],[1301,74,1301,81,0],[1302,21,1302,22,0],[1303,25,1303,47,0],[1305,25,1305,81,0],[1306,25,1306,95,0],[1307,25,1307,72,0],[1308,29,1308,193,0],[1309,25,1309,87,0],[1311,25,1311,95,0],[1313,25,1313,162,0],[1314,21,1314,22,0],[1316,21,1316,127,0],[1317,17,1317,18,0],[1318,13,1318,14,0],[1319,9,1319,10,0],[1322,9,1322,10,0],[1323,13,1323,50,0],[1324,13,1324,39,0],[1326,13,1326,57,0],[1329,21,1329,94,0],[1330,21,1330,53,0],[1331,21,1331,22,0],[1332,25,1332,121,0],[1333,25,1333,140,0],[1334,21,1334,22,0],[1335,21,1335,27,0],[1338,21,1338,86,0],[1339,21,1339,45,0],[1340,21,1340,22,0],[1341,25,1341,83,0],[1342,25,1342,147,0],[1343,21,1343,22,0],[1344,21,1344,27,0],[1347,21,1347,167,0],[1348,21,1348,27,0],[1351,21,1351,167,0],[1352,21,1352,27,0],[1355,21,1355,170,0],[1356,21,1356,27,0],[1359,21,1359,189,0],[1360,21,1360,158,0],[1361,21,1361,27,0],[1364,21,1364,153,0],[1365,21,1365,122,0],[1366,21,1366,27,0],[1369,21,1369,52,0],[1370,21,1370,136,0],[1372,21,1372,86,0],[1373,21,1373,154,0],[1374,21,1374,150,0],[1375,21,1375,126,0],[1377,21,1377,86,0],[1378,21,1378,46,0],[1379,21,1379,46,0],[1380,21,1380,48,0],[1381,21,1381,138,0],[1382,21,1382,27,0],[1385,21,1385,57,0],[1386,21,1386,136,0],[1387,21,1387,130,0],[1388,21,1388,27,0],[1391,21,1391,62,0],[1392,21,1392,136,0],[1394,21,1394,28,0],[1394,30,1394,48,0],[1394,49,1394,51,0],[1394,52,1394,82,0],[1395,21,1395,22,0],[1396,25,1396,86,0],[1397,25,1397,111,0],[1398,25,1398,26,0],[1399,29,1399,117,0],[1400,29,1400,90,0],[1401,29,1401,67,0],[1402,33,1402,95,0],[1404,29,1404,30,0],[1405,33,1405,159,0],[1406,33,1406,50,0],[1407,33,1407,34,0],[1409,37,1409,88,0],[1410,37,1410,63,0],[1411,37,1411,65,0],[1412,37,1412,85,0],[1413,37,1413,38,0],[1415,41,1415,151,0],[1416,37,1416,38,0],[1417,37,1417,67,0],[1418,33,1418,34,0],[1419,29,1419,30,0],[1420,25,1420,26,0],[1421,21,1421,22,0],[1422,21,1422,27,0],[1425,21,1425,51,0],[1426,21,1426,136,0],[1427,21,1427,124,0],[1428,21,1428,27,0],[1431,21,1431,65,0],[1432,21,1432,136,0],[1434,21,1434,148,0],[1435,21,1435,138,0],[1436,21,1436,126,0],[1437,21,1437,146,0],[1438,21,1438,143,0],[1439,21,1439,150,0],[1440,21,1440,132,0],[1441,21,1441,130,0],[1442,21,1442,132,0],[1443,21,1443,132,0],[1444,21,1444,135,0],[1445,21,1445,140,0],[1446,21,1446,148,0],[1447,21,1447,27,0],[1450,21,1450,116,0],[1451,21,1451,114,0],[1452,21,1452,22,0],[1453,25,1453,92,0],[1453,92,1453,165,0],[1453,165,1453,167,0],[1453,25,1453,167,0],[1454,25,1454,46,0],[1455,29,1455,174,0],[1456,21,1456,22,0],[1457,21,1457,27,0],[1460,21,1460,59,0],[1461,21,1461,136,0],[1463,21,1463,124,0],[1464,21,1464,27,0],[1466,13,1466,32,0],[1467,9,1467,10,0],[1471,9,1471,10,0],[1472,13,1472,79,0],[1473,13,1473,61,0],[1474,13,1474,79,0],[1476,13,1476,116,0],[1477,13,1477,108,0],[1479,13,1479,32,0],[1480,9,1480,10,0],[1484,9,1484,10,0],[1485,13,1485,50,0],[1487,13,1487,14,0],[1488,17,1488,79,0],[1491,17,1491,77,0],[1493,17,1493,136,0],[1494,13,1494,14,0],[1495,13,1495,33,0],[1496,13,1496,14,0],[1497,17,1497,29,0],[1499,13,1499,32,0],[1500,9,1500,10,0],[1504,9,1504,10,0],[1505,13,1505,50,0],[1507,13,1507,14,0],[1508,17,1508,78,0],[1509,17,1509,57,0],[1510,17,1510,18,0],[1511,21,1511,85,0],[1514,21,1514,83,0],[1515,21,1515,69,0],[1516,21,1516,69,0],[1518,21,1518,103,0],[1520,21,1520,48,0],[1521,21,1521,22,0],[1522,25,1522,74,0],[1523,25,1523,134,0],[1525,25,1525,78,0],[1526,25,1526,235,0],[1528,25,1528,71,0],[1529,25,1529,98,0],[1529,99,1529,157,0],[1530,25,1530,95,0],[1532,25,1532,130,0],[1533,25,1533,79,0],[1535,25,1535,97,0],[1536,21,1536,22,0],[1538,21,1538,22,0],[1539,25,1539,120,0],[1540,21,1540,22,0],[1541,17,1541,18,0],[1542,13,1542,14,0],[1543,13,1543,33,0],[1544,13,1544,14,0],[1545,17,1545,26,0],[1547,13,1547,32,0],[1548,9,1548,10,0],[1551,9,1551,10,0],[1552,13,1552,79,0],[1554,13,1554,64,0],[1555,13,1555,14,0],[1557,17,1557,24,0],[1557,26,1557,35,0],[1557,36,1557,38,0],[1557,39,1557,71,0],[1558,17,1558,18,0],[1559,21,1559,73,0],[1560,21,1560,43,0],[1561,21,1561,70,0],[1562,17,1562,18,0],[1563,13,1563,14,0],[1564,18,1564,84,0],[1565,13,1565,14,0],[1566,17,1566,77,0],[1567,17,1567,39,0],[1568,17,1568,18,0],[1569,21,1569,83,0],[1570,17,1570,18,0],[1572,22,1572,31,0],[1572,33,1572,49,0],[1572,51,1572,54,0],[1573,17,1573,18,0],[1574,21,1574,99,0],[1575,21,1575,42,0],[1576,21,1576,22,0],[1577,25,1577,83,0],[1578,25,1578,53,0],[1579,25,1579,80,0],[1580,21,1580,22,0],[1581,17,1581,18,0],[1582,13,1582,14,0],[1583,9,1583,10,0],[1587,9,1587,10,0],[1588,13,1588,60,0],[1589,13,1589,70,0],[1590,13,1590,14,0],[1591,17,1591,24,0],[1591,26,1591,44,0],[1591,45,1591,47,0],[1591,48,1591,78,0],[1592,17,1592,18,0],[1593,21,1593,81,0],[1594,21,1594,91,0],[1595,21,1595,22,0],[1596,25,1596,98,0],[1597,25,1597,88,0],[1598,25,1598,50,0],[1598,51,1598,140,0],[1599,25,1599,74,0],[1600,25,1600,26,0],[1601,29,1601,90,0],[1602,29,1602,67,0],[1603,33,1603,60,0],[1605,29,1605,30,0],[1606,33,1606,159,0],[1608,33,1608,132,0],[1609,37,1609,80,0],[1611,33,1611,50,0],[1612,33,1612,34,0],[1614,37,1614,87,0],[1615,37,1615,62,0],[1616,37,1616,64,0],[1617,37,1617,85,0],[1618,37,1618,38,0],[1620,41,1620,150,0],[1621,37,1621,38,0],[1622,37,1622,67,0],[1623,33,1623,34,0],[1624,29,1624,30,0],[1625,25,1625,26,0],[1626,21,1626,22,0],[1627,17,1627,18,0],[1628,13,1628,14,0],[1629,13,1629,53,0],[1630,17,1630,63,0],[1631,9,1631,10,0]]);
    </script>
  </body>
</html>