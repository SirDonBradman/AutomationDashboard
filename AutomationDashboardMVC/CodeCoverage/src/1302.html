<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\ENTPRSE\CustomSearch.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.EnterpriseBL;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.ProjectBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;
using Infragistics.WebUI.UltraWebGrid.ExcelExport;
using Aurigo.AMP3.Resources.MessageResources;
using System.Globalization;
using System.Linq;

namespace Aurigo.AMP3.EnterpriseUI
{
    public partial class CustomSearch : BrixPageBase
    {
        protected PagerControl mypager;
        private string ModuleID
        {
            get { return (ViewState[&quot;ModuleID&quot;] ?? string.Empty).ToString(); }
            set { ViewState[&quot;ModuleID&quot;] = value; }
        }

        private string SelectedModuleID
        {
            get
            {
                return string.IsNullOrEmpty(Request.Form[cboModules.UniqueID])
                    ? cboModules.SelectedValue
                    : Request.Form[cboModules.UniqueID];
            }
        }

        private string SortColumn
        {
            get { return (ViewState[&quot;SortColumn&quot;] ?? string.Empty).ToString(); }
            set { ViewState[&quot;SortColumn&quot;] = value; }
        }

        private SortIndicator SortIndicator
        {
            get { return (SortIndicator)(ViewState[&quot;SortIndicator&quot;] ?? SortIndicator.None); }
            set { ViewState[&quot;SortIndicator&quot;] = value; }
        }

        private int CurrentPage
        {
            get { return (ViewState[&quot;CurrentPage&quot;] ?? 1).ToInt32_2(); }
            set { ViewState[&quot;CurrentPage&quot;] = value; }
        }

        private string FilterCriteria
        {
            get { return (ViewState[&quot;FilterCriteria&quot;] ?? string.Empty).ToString(); }
            set { ViewState[&quot;FilterCriteria&quot;] = value; }
        }

        private string FilterDynamicGridCriteria
        {
            get { return (ViewState[&quot;FilterDynamicGridCriteria&quot;] ?? string.Empty).ToString(); }
            set { ViewState[&quot;FilterDynamicGridCriteria&quot;] = value; }
        }

        private string queryStringName
        {
            get { return (ViewState[&quot;queryStringName&quot;] ?? string.Empty).ToString(); }
            set { ViewState[&quot;queryStringName&quot;] = value; }
        }

        protected void cboModules_OnSelectedIndexChanged(object sender, EventArgs e)
        {
            //ResetSearch(null, null);
        }

        protected override void OnInit(EventArgs e)
        {
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);

            mypager.ItemClicked += HandlePagerEvent;
            mypager.EnableViewState = true;
            lblerrormsg.Text = &quot;&quot;;

            if (!Page.IsPostBack)
            {
                DataTable dt = SearchManager.Instance.GetSearchableModules();
                foreach (DataRow dr in dt.Rows)
                    dr[&quot;ModuleName&quot;] = GlobalizationUtility.SetResource(dr[&quot;ModuleName&quot;].ToString2(), false);
                dt.DefaultView.Sort = &quot;ModuleName&quot;;
                cboModules.DataSource = dt.ToMWDateTime().DefaultView;
                cboModules.DataTextField = &quot;ModuleName&quot;;
                cboModules.DataValueField = &quot;ModuleID&quot;;
                cboModules.DataBind();
                ResetSearch(null, null);
            }

            base.OnInit(e);
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            menus.Add(new BrixMenu(&quot;lnkSearch&quot;, &quot;Search&quot;, &quot;Icn_Search.png&quot;, 55));
            menus.Add(new BrixMenu(&quot;lnkView&quot;, &quot;View&quot;, &quot;Icn_View.png&quot;, 55));
            menus.Add(new BrixMenu(&quot;lnkReset&quot;, &quot;Reset&quot;, &quot;IcnFilterRem.png&quot;, 55));
            menus.Add(new BrixMenu(&quot;lnkExport&quot;, &quot;Export&quot;, &quot;Icn_export.png&quot;, 55));

            CreateToolBarMenu(menus, null);

            if (Page.IsPostBack &amp;&amp; Request.Form[cboModules.UniqueID] != ModuleID)
                ResetSearch(null, null);

            base.CreateChildControls();
        }

        protected override void CustomizeToolBar()
        {
            if (MainToolBar.GetMenuReference(&quot;lnkSearch&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkSearch&quot;).Click += btnSearch_Click;
                MainToolBar.GetMenuReference(&quot;lnkSearch&quot;).OnClientClick = &quot;return ColExpStatus()&quot;;
            }
            if (MainToolBar.GetMenuReference(&quot;lnkReset&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkReset&quot;).Click += ResetSearch;
                MainToolBar.GetMenuReference(&quot;lnkReset&quot;).CausesValidation = false;
            }
            if (MainToolBar.GetMenuReference(&quot;lnkExport&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkExport&quot;).Click += lnkExport_Click;
      
            if (MainToolBar.GetMenuReference(&quot;lnkView&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkView&quot;).OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                        Convert.ToInt32(ValidateSelection.OneItem,
                            CultureInfo.CurrentCulture) +
                        &quot;&#39;, &#39;&quot; + gridResults.ClientID + &quot;&#39;, &#39;&quot; +
                                      queryStringName + &quot;&#39;))return gridResultsDblClickHandler(); else return false;&quot;;
            }
        }

        public override void InclueScriptAndStyleFiles()
        {
            base.InclueScriptAndStyleFiles();
            base.RegisterClientScriptInclude(&quot;~/Scripts/BrixListPageValidate.js&quot;);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                if (!base.IsPostBack)
                {
                    gridResults.DisplayLayout.Pager.AllowPaging = true;
                    gridResults.DisplayLayout.ScrollBar = ScrollBar.Auto;
                    gridResults.DisplayLayout.FrameStyle.Height = Unit.Percentage(100);
                    gridResults.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
                    gridResults.DisplayLayout.NoDataMessage = &quot;Loading...&quot;;
                    mypager.Set_Page(1, 1);
                    mypager.Visible = false;
                }
                if (IsPostBack &amp;&amp; gridResults.Bands[0].SortedColumns.Count &gt; 0 &amp;&amp; hdnDBClick.Value != &quot;TRUE&quot;)
                {
                    SortColumn = gridResults.Bands[0].SortedColumns[0].Key;
                    SortIndicator = gridResults.Bands[0].SortedColumns[0].SortIndicator;
                    SortSearchResults();
                }
            }
            catch
            {
                lblerrormsg.Text = &quot;Error On Page&quot;;
            }

            PageTitle = &quot;Enterprise Search&quot;;
        }

        public void HandlePagerEvent(object sender, ItemClickEventArgs e)
        {
            try
            {
                gridResults.DisplayLayout.Pager.CurrentPageIndex = CurrentPage = e.PageNo;
                SortSearchResults();
                mypager.ItemClicked -= HandlePagerEvent;
            }
            catch
            {
                lblerrormsg.Text = &quot;Error On Page&quot;;
            }
        }

        protected void btnSearch_Click(object sender, EventArgs e)
        {
            lblerrormsg.Text = &quot;&quot;;
            CurrentPage = 1;
            GetSearchResults(CurrentPage, gridResults);
        }

        protected void lnkExport_Click(object sender, EventArgs e)
        {         
            lblerrormsg.Text = &quot;&quot;;
            UltraWebGrid exportGrid = new UltraWebGrid(&quot;grd_Temp&quot;);
            GetSearchResults(1, exportGrid, true);

            if (exportGrid.Rows.Count == 0)
            {
                lblerrormsg.Text = &quot;No data to export.&quot;;
                return;
            }        
            UltraWebGridExcelExporter UWGExcelExporter = new UltraWebGridExcelExporter();
            UWGExcelExporter.DownloadName = SelectedModuleID + &quot;_data.xls&quot;;
            UWGExcelExporter.WorksheetName = cboModules.SelectedItem != null
                ? cboModules.SelectedItem.Text
                : SelectedModuleID;
            UWGExcelExporter.Export(exportGrid);
            
            this.Controls.Add(UWGExcelExporter);
        }

        protected void ResetSearch(object sender, EventArgs e)
        {
            lblerrormsg.Text = &quot;&quot;;
            gridResults.Clear();
            gridResults.DisplayLayout.NoDataMessage = &quot;Loading...&quot;;
            mypager.Visible = false;
            CurrentPage = 1;
            SortColumn = null;
            SortIndicator = SortIndicator.None;
            ModuleID = SelectedModuleID; // this.cboModules.SelectedValue;
            SearchPanel.Controls.Clear();
            SearchManager.Instance.GetSearchCriteriaForModule(ModuleID, SearchPanel);
        }
        /// &lt;summary&gt;
        /// Gets the search results  
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cpage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;grid&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;isExport&quot;&gt;&lt;/param&gt;
        protected void GetSearchResults(int cpage, UltraWebGrid grid, bool isExport = false)
        {
            try
            {
                lblerrormsg.Text = &quot;&quot;;
                int pagecnt;
                string ModID = SelectedModuleID; // cboModules.SelectedValue;
                DataSet dsResults;
                ListModel listModel = null;
                bool isActualModel = !ModID.StartsWith(&quot;C-&quot;);
                if (isActualModel)
                {
                    listModel = ListModel.GetXMLInstance(ModID, null, null, null);
                    columnInfo = listModel.ColumnInfo;
                    BrixFilter[] filters = listModel.GetApplySearchFilterLabels();
                    queryStringName = listModel.QueryStringName;
                    MainToolBar.GetMenuReference(&quot;lnkView&quot;).OnClientClick = &quot;if(lnkValidation(&#39;&quot; +
                    Convert.ToInt32(ValidateSelection.OneItem,
                     CultureInfo.CurrentCulture) +
                 &quot;&#39;, &#39;&quot; + gridResults.ClientID + &quot;&#39;, &#39;&quot; +
                               queryStringName + &quot;&#39;))return gridResultsDblClickHandler(); else return false;&quot;;

                    //Get Filter for Non dynamic Grid Section
                    FilterCriteria = ModelHelper.GetFilterXML(SearchPanel.NamingContainer.UniqueID + &quot;$&quot;, Request,
                        filters);

                    string sNonxmlFilterCriteria = string.Empty;
                    if (!string.IsNullOrEmpty(FilterCriteria))
                        sNonxmlFilterCriteria = CoreDatabaseHelper.FormatFilterText(FilterCriteria);

                    //Get Filter for dynamic Grid Section
                    FilterDynamicGridCriteria = ModelHelper.GetFilterXML(SearchPanel.NamingContainer.UniqueID + &quot;$&quot;, Request,
                    filters,null,true);

                    string xmlFilterCriteriaDynamicGrid = string.Empty;
                    if (!string.IsNullOrEmpty(FilterDynamicGridCriteria))
                        xmlFilterCriteriaDynamicGrid = CoreDatabaseHelper.FormatDynamicFilterText(FilterDynamicGridCriteria);

                    string sortindicator = (SortIndicator == SortIndicator.Descending) ? &quot;desc&quot; : string.Empty;
                    string dbSortColumn = string.Empty;

                    if (!string.IsNullOrEmpty(SortColumn))
                        dbSortColumn = string.Format(&quot;[{0}]&quot;, SortColumn);

                    string sortorder =
                        (string.IsNullOrEmpty(SortColumn) ||
                         (!string.IsNullOrEmpty(SortColumn) &amp;&amp;
                          new List&lt;string&gt; { &quot;Project Name&quot;, &quot;Contract Name&quot;, &quot;Project Code&quot; }.Contains(SortColumn))
                            ? queryStringName
                            : dbSortColumn + &quot; &quot; + sortindicator).Trim();

                    string formViewName = (listModel as GenericXMLListModel)?.FormSerachViewName;
                    if (!string.IsNullOrEmpty(formViewName))
                    {
                        UserDetail ud = UserDetail.GetCurrentUserDetail();
                        if (ud != null)
                        {
                            int roleId = 0;
                            if (!ModuleManagementBL.ModuleManager.Instance.IsEffectivePermissionOfRoles())
                                roleId = ud.RID;

                            //Either user is invited to project or user is an administrator
                            string Projfilter = $@&quot;(SELECT (
                                            CASE WHEN  COL_LENGTH(&#39;{formViewName}&#39;, &#39;PID&#39;        ) IS NOT NULL 
                                                    THEN &#39;(PID     in (SELECT P.ProjectId FROM PROJECTProjectUser P WHERE P.UserId = {ud.UID} {(roleId == 0 ? &quot;&quot; : &quot; AND P.RoleId =&quot; + ud.RID)}) 
                                                           OR (SELECT RoleId FROM USRMGMTUserRoles WHERE UserId = {ud.UID} AND RoleId = 1 ) = 1 ) &#39; 
                                                    WHEN  COL_LENGTH(&#39;{formViewName}&#39;, &#39;ProjectID&#39;) IS NOT NULL 
                                                    THEN &#39;(ProjectID in (SELECT P.ProjectId FROM PROJECTProjectUser P WHERE P.UserId = {ud.UID} {(roleId == 0 ? &quot;&quot; : &quot; AND P.RoleId =&quot; + ud.RID)}) 
                                                           OR (SELECT RoleId FROM USRMGMTUserRoles WHERE UserId = {ud.UID} AND RoleId = 1 ) = 1 ) &#39; 
	                                            ELSE &#39;&#39; 
                                            END) )&quot;;

                            Projfilter = ComponentHelper.Instance.ExecuteScalar(Projfilter).ToString();

                            if (Projfilter.Trim().Length &gt; 0)
                                sNonxmlFilterCriteria += ((sNonxmlFilterCriteria).Trim().Length &gt; 0 ? &quot; AND &quot; : &quot;&quot;) + Projfilter;
                        }

                        //Bug 92159:Enterprise Search: When user click on the BE able to see the message as &quot;The current role doesnot have the permission to view the page ..&quot;
                        //Issue is because records of deleted project shows up in the enterprise search. 
                        //Resolution will be not bringing records related with deleted projects in the enterprise search.
                        string existingProjFilter = $@&quot;
                                                (SELECT (
                                                    CASE WHEN  COL_LENGTH(&#39;{formViewName}&#39;, &#39;PID&#39;      ) IS NOT NULL 
                                                            THEN &#39;(PID     in (SELECT P.ProjectId FROM PROJECTProjectMain P WHERE ISNULL(P.IsDeleted , 0) = 0) OR PID = 0)&#39; 
                                                         WHEN  COL_LENGTH(&#39;{formViewName}&#39;, &#39;ProjectID&#39;) IS NOT NULL
                                                            THEN &#39;(ProjectID in (SELECT P.ProjectId FROM PROJECTProjectMain P WHERE ISNULL(P.IsDeleted , 0) = 0) OR ProjectID = 0)&#39; 
	                                                    ELSE &#39;&#39; 
                                                    END)
                                                )&quot;;
                        existingProjFilter = ComponentHelper.Instance.ExecuteScalar(existingProjFilter).ToString();

                        if (existingProjFilter.Trim().Length &gt; 0)
                            sNonxmlFilterCriteria += ((sNonxmlFilterCriteria).Trim().Length &gt; 0 ? &quot; AND &quot; : &quot;&quot;) + existingProjFilter;
                        //End Bug 92159
                    }
                    dsResults = CoreDatabaseHelper.GetSearchODSData(((GenericXMLListModel)listModel).FormSerachViewName,
                        !isExport ? 19 : int.MaxValue, sortorder, sNonxmlFilterCriteria, false, ref cpage, out pagecnt,
                        null, null, null, null, false, listModel.xmlModel.form.Name, listModel.xmlModel.form.PrimaryKeyName, null, 0, ignoreWorkflow: true, filterOrSortHasPendingOnUser:false,
                        xmlFilterCriteriaDynamicGrid:xmlFilterCriteriaDynamicGrid);
                }
                else
                {
                    FilterCriteria = SearchManager.Instance.GetFilterXML(ModID,
                        SearchPanel.NamingContainer.UniqueID + &quot;$&quot;, Request);
                    string sortindicator = (SortIndicator == SortIndicator.Descending) ? &quot;desc&quot; : string.Empty;
                    string sortorder =
                        (string.IsNullOrEmpty(SortColumn) ||
                         (!string.IsNullOrEmpty(SortColumn) &amp;&amp;
                          new List&lt;string&gt; { &quot;Project Name&quot;, &quot;Contract Name&quot; }.Contains(SortColumn))
                            ? &quot;&quot;
                            : SortColumn + &quot; &quot; + sortindicator).Trim();
                    dsResults = SearchManager.Instance.GetList(ModID, !isExport ? 19 : int.MaxValue, sortorder,
                        FilterCriteria, ref cpage, out pagecnt);
                }
                ModuleID = ModID;
                grid.Clear();
                if (dsResults == null || dsResults.Tables.Count == 0 || dsResults.Tables[0].Rows.Count == 0)
                {
                    grid.DisplayLayout.NoDataMessage = &quot;No data to display.&quot;;
                    mypager.Visible = false;
                }
                else
                {
                    DataTable dtResults = dsResults.Tables[0];
                    var lst = new List&lt;string&gt; { &quot;ContractID&quot;, &quot;ProjectId&quot;, &quot;RowNum&quot;, &quot;ParentID&quot;, &quot;PID&quot; };
                    if (isActualModel &amp;&amp; listModel != null)
                    {
                        if (!(listModel is GenericXMLListModel) &amp;&amp; columnInfo != null &amp;&amp; dtResults != null)
                        {
                            foreach (DataColumn dCol in dtResults.Columns)
                            {
                                if (columnInfo.Select(string.Format(&quot;Key=&#39;{0}&#39;&quot;, dCol.ColumnName)).Length &lt;= 0)
                                    lst.Add(dCol.ColumnName);
                            }
                        }

                        DataRow dr = ModuleManager.Instance.GetModuleDetails(ModID);
                        string parentModule = (!dr[&quot;ParentModuleID&quot;].Equals(DBNull.Value) &amp;&amp;
                                               !string.IsNullOrEmpty(dr[&quot;ParentModuleID&quot;].ToString2()))
                            ? dr[&quot;ParentModuleID&quot;].ToString2()
                            : &quot;&quot;;

                        if (!dr[&quot;AssociatedContext&quot;].Equals(DBNull.Value) &amp;&amp;
                            !string.IsNullOrEmpty(dr[&quot;AssociatedContext&quot;].ToString2()))
                            listModel = ListModel.GetInstance(dr[&quot;AssociatedContext&quot;].ToString2(), null, null, null);

                        if (parentModule.ToUpper() == Constants.MODID_PROJECT)
                            ProjectManager.Instance.GetParentModuleDetails(dtResults, listModel.ParentIDKey);
                        else if (!string.IsNullOrEmpty(parentModule))
                            CoreDatabaseHelper.GetDataFromAssembly(parentModule, &quot;GetParentModuleDetails&quot;,
                                new object[] { dtResults, listModel.ParentIDKey });
                    }
                    //Bug 85743:Enterprise search does not identify the project in the output
                    //check for PID and add ProjectName, Code
                    string pIDColName = string.Empty, pNameCol = string.Empty, pCodeCol = string.Empty;
                    foreach(DataColumn col in dsResults.Tables[0].Columns)
                    {
                        if(col.ColumnName.ToLower2()==&quot;pid&quot; || col.ColumnName.ToLower2()==&quot;projectid&quot;)
                        {
                            pIDColName = col.ColumnName;
                        }
                        else if (col.ColumnName.ToLower2() == &quot;projectname&quot; || col.ColumnName.ToLower2() == &quot;project name&quot;)
                        {
                            pNameCol = col.ColumnName;
                        }
                        else if (col.ColumnName.ToLower2() == &quot;projectcode&quot; || col.ColumnName.ToLower2() == &quot;project code&quot;)
                        {
                            pCodeCol = col.ColumnName;
                        }
                    }
                    if(pIDColName!=string.Empty)
                    {
                        if(dsResults.Tables[0].Columns.Contains(pNameCol))
                            dsResults.Tables[0].Columns.Remove(pNameCol);
                        if (dsResults.Tables[0].Columns.Contains(pCodeCol))
                            dsResults.Tables[0].Columns.Remove(pCodeCol);

                        string projectIds = string.Join(&quot;,&quot;,dsResults.Tables[0].AsEnumerable().Select(r =&gt; r.Field&lt;object&gt;(pIDColName)));
                        DataTable dtProjDetails = SearchManager.Instance.GetENTPRSEProjectDetails(projectIds);

                        dsResults.Tables[0].Columns.Add(&quot;ProjectName&quot;);
                        dsResults.Tables[0].Columns.Add(&quot;ProjectCode&quot;);
                        foreach(DataRow row in dsResults.Tables[0].Rows)
                        {
                            DataRow rowProjDetail = dtProjDetails.AsEnumerable().FirstOrDefault(r =&gt; r[&quot;ProjectID&quot;].ToInt32_2() == row[pIDColName].ToInt32_2());
                            if (rowProjDetail != null)
                            {
                                row[&quot;ProjectName&quot;] = rowProjDetail[&quot;ProjectName&quot;].ToString2();
                                row[&quot;ProjectCode&quot;] = rowProjDetail[&quot;ProjectCode&quot;].ToString2();
                            }
                        }
                        dsResults.Tables[0].Columns[&quot;ProjectCode&quot;].SetOrdinal(0);
                        dsResults.Tables[0].Columns[&quot;ProjectName&quot;].SetOrdinal(1);
                    }

                    grid.DataSource = dsResults.ToMWDateTime();
                    grid.DataBind();

                    // To Fix XSS attack
                    foreach (UltraGridColumn col in grid.Columns)
                    {
                        col.HTMLEncodeContent = true;
                    }

                    #region Disable Sorting

                    var lstDisableSort = new List&lt;string&gt; { &quot;Project Name&quot;, &quot;Contract Name&quot;, &quot;Project Code&quot; };
                    foreach (UltraGridColumn gCol in grid.Columns)
                    {
                        if (lstDisableSort.Contains(gCol.BaseColumnName))
                        {
                            gCol.Header.ClickAction = HeaderClickAction.Select;
                        }
                    }

                    #endregion

                    grid.DisplayLayout.Pager.AllowPaging = true;
                    grid.DisplayLayout.ScrollBar = ScrollBar.Auto;
                    grid.DisplayLayout.FrameStyle.Height = Unit.Percentage(100);
                    grid.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
                    if (!isActualModel)
                    {
                        List&lt;string&gt; hdnLst = SearchManager.Instance.GetHiddenColumnsList(ModID);
                        if (hdnLst != null &amp;&amp; hdnLst.Count &gt; 0)
                            lst.AddRange(hdnLst);
                    }

                    foreach (UltraGridColumn ugCol in grid.Columns)
                    {
                        if (lst.Contains(ugCol.Key))
                            ugCol.Hidden = true;
                        else if (ugCol.DataType == &quot;System.DateTime&quot;)
                            ugCol.Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
                    }
                    //check for PID/ProjectID column and move Name &amp; code to the position 0,1

                    columnInfo.AsEnumerable().Where(r =&gt; r[&quot;Key&quot;].ToString2().ToLower2() == &quot;projectname&quot; || r[&quot;Key&quot;].ToString2().ToLower2() == &quot;projectcode&quot;)
                        .ForEach&lt;DataRow&gt;(r =&gt;
                        {
                            r[&quot;Hidden&quot;] = &quot;false&quot;;
                            r[&quot;Position&quot;] = (r[&quot;Key&quot;].ToString2().ToLower2() == &quot;projectname&quot;) ? 1 : 0;
                        });


                    if (!isActualModel)
                        SearchManager.Instance.FormatGrid(ModID, grid);
                    else
                        GlobalizationUtility.ApplyGlobalizationToGrid(grid, columnInfo);

                    //foreach (UltraGridColumn ugCol in gridResults.Columns)
                    //{
                    //    if (ugCol.Key.StartsWith2(LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_SYMBOL)))
                    //    {
                    //        ugCol.Format = Constants.FORMAT_AMOUNT;
                    //        ugCol.Header.Caption = ugCol.Key.Remove(0, 1);
                    //    }
                    //}
                    grid.DisplayLayout.Pager.CurrentPageIndex = 1;
                    if (!isExport)
                    {
                        mypager.Visible = true;
                        if (cpage &gt; pagecnt)
                            cpage = pagecnt;
                        (mypager).Set_Page(cpage, pagecnt);
                        CurrentPage = cpage;
                    }
                    Dictionary&lt;string, Type&gt; dicObj = CustomizePageModel.GetModelObjects();
                    foreach (KeyValuePair&lt;string, Type&gt; kvp in dicObj)
                    {
                        CustomizePageModel cpm = CustomizePageModel.GetInstance(kvp.Key);
                        if (cpm != null)
                            cpm.CustomizeGrid(this.Page, grid, &quot;&quot;, callerContext: &quot;CustomSearch&quot;);
                    }
                }
            }
            catch (Exception ex)
            {
                lblerrormsg.Text = ex.Message;
                //return;
            }
        }

        protected void btnGhost_ServerClick(object sender, EventArgs e)
        {
            hdnDBClick.Value = &quot;RESET&quot;;

            if (gridResults.DisplayLayout.SelectedRows != null &amp;&amp; gridResults.DisplayLayout.ActiveRow != null)
            {
                CellsCollection cell = gridResults.DisplayLayout.ActiveRow.Cells;
                string url = &quot;&quot;;
                ListModel lstModel;
                string lstContext = SelectedModuleID; // cboModules.SelectedValue;
                bool isActualModel = !lstContext.StartsWith(&quot;C-&quot;);
                if (isActualModel)
                {
                    DataRow dr = ModuleManager.Instance.GetModuleDetails(lstContext);
                    if (dr[&quot;AssociatedContext&quot;].Equals(DBNull.Value) ||
                        string.IsNullOrEmpty(dr[&quot;AssociatedContext&quot;].ToString2()))
                        lstModel = ListModel.GetXMLInstance(lstContext, null, null, null);
                    else
                    {
                        lstContext = dr[&quot;AssociatedContext&quot;].ToString2();
                        lstModel = ListModel.GetInstance(lstContext, null, null, null);
                    }
                    string pid = &quot;0&quot;;
                    if (!string.IsNullOrEmpty(lstModel.PIDKey) &amp;&amp; cell.Exists(lstModel.PIDKey))
                        pid = (cell.FromKey(lstModel.PIDKey).Value ?? 0).ToString();
                    if (pid == &quot;0&quot; &amp;&amp; cell.Exists(&quot;PID&quot;))
                        pid = (cell.FromKey(&quot;PID&quot;).Value ?? 0).ToString();
                    string parentid = &quot;0&quot;;
                    if (!string.IsNullOrEmpty(lstModel.ParentIDKey) &amp;&amp; cell.Exists(lstModel.ParentIDKey))
                        parentid = (cell.FromKey(lstModel.ParentIDKey).Value ?? 0).ToString();
                    if (parentid == &quot;0&quot; &amp;&amp; cell.Exists(&quot;ContractID&quot;))
                        parentid = (cell.FromKey(&quot;ContractID&quot;).Value ?? 0).ToString();
                    if (cell.Exists(lstModel.QueryStringName))
                    {
                        Context.Items.Add(&quot;Search_CurrentCellsCollection&quot;, cell);
                        url = lstModel.GetEditPageURL(pid, parentid, cell.FromKey(lstModel.QueryStringName).Text,
                            lstContext);
                    }
                    else if (cell.Exists(&quot;ID&quot;))
                        url = lstModel.GetEditPageURL(pid, parentid, cell.FromKey(&quot;ID&quot;).Text, lstContext);
                    if (!string.IsNullOrEmpty(url))
                    {
                        if (!dr[&quot;ParentModuleID&quot;].Equals(DBNull.Value) &amp;&amp;
                            dr[&quot;ParentModuleID&quot;].ToString2().Equals(Constants.MODID_LIBRARY,
                                StringComparison.OrdinalIgnoreCase))
                            url = string.Format(&quot;{0}&amp;module={1}&quot;, url, Constants.MODID_LIBRARY);
                    }
                }
                else
                {
                    url = SearchManager.Instance.GetEditPageUrl(lstContext, cell);
                }
                if (!string.IsNullOrEmpty(url))
                    Response.Redirect(string.Format(&quot;{0}{1}nt=1&quot;, url, url.Contains(&quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;), true);
            }
        }

        protected void SortSearchResults()
        {
            GetSearchResults(CurrentPage, gridResults);
            if (!string.IsNullOrEmpty(SortColumn) &amp;&amp; SortIndicator != SortIndicator.None)
            {
                if (gridResults.Columns.Exists(SortColumn))
                {
                    gridResults.Bands[0].SortedColumns.Add(gridResults.Columns.FromKey(SortColumn), true);
                    gridResults.Bands[0].SortedColumns[0].SortIndicator = SortIndicator;
                }
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[30,17,30,18,0],[30,19,30,77,0],[30,78,30,79,0],[31,17,31,18,0],[31,19,31,49,0],[31,50,31,51,0],[37,13,37,14,0],[38,17,40,57,0],[41,13,41,14,0],[46,17,46,18,0],[46,19,46,79,0],[46,80,46,81,0],[47,17,47,18,0],[47,19,47,51,0],[47,52,47,53,0],[52,17,52,18,0],[52,19,52,92,0],[52,93,52,94,0],[53,17,53,18,0],[53,19,53,54,0],[53,55,53,56,0],[58,17,58,18,0],[58,19,58,70,0],[58,71,58,72,0],[59,17,59,18,0],[59,19,59,52,0],[59,53,59,54,0],[64,17,64,18,0],[64,19,64,83,0],[64,84,64,85,0],[65,17,65,18,0],[65,19,65,55,0],[65,56,65,57,0],[70,17,70,18,0],[70,19,70,94,0],[70,95,70,96,0],[71,17,71,18,0],[71,19,71,66,0],[71,67,71,68,0],[76,17,76,18,0],[76,19,76,84,0],[76,85,76,86,0],[77,17,77,18,0],[77,19,77,56,0],[77,57,77,58,0],[81,9,81,10,0],[83,9,83,10,0],[86,9,86,10,0],[87,13,87,66,0],[89,13,89,53,0],[90,13,90,44,0],[91,13,91,35,0],[93,13,93,34,0],[94,13,94,14,0],[95,17,95,78,0],[96,17,96,24,0],[96,26,96,36,0],[96,37,96,39,0],[96,40,96,47,0],[97,21,97,110,0],[98,17,98,52,0],[99,17,99,71,0],[100,17,100,57,0],[101,17,101,56,0],[102,17,102,39,0],[103,17,103,41,0],[104,13,104,14,0],[106,13,106,28,0],[107,9,107,10,0],[110,9,110,10,0],[111,13,111,41,0],[112,13,112,82,0],[113,13,113,76,0],[114,13,114,82,0],[115,13,115,82,0],[117,13,117,44,0],[119,13,119,82,0],[120,17,120,41,0],[122,13,122,40,0],[123,9,123,10,0],[126,9,126,10,0],[127,13,127,67,0],[128,13,128,14,0],[129,17,129,84,0],[130,17,130,99,0],[131,13,131,14,0],[132,13,132,66,0],[133,13,133,14,0],[134,17,134,79,0],[135,17,135,83,0],[136,13,136,14,0],[137,13,137,67,0],[138,17,138,84,0],[140,13,140,65,0],[141,13,141,14,0],[142,17,146,118,0],[147,13,147,14,0],[148,9,148,10,0],[151,9,151,10,0],[152,13,152,46,0],[153,13,153,83,0],[154,9,154,10,0],[157,9,157,10,0],[159,13,159,14,0],[160,17,160,38,0],[161,17,161,18,0],[162,21,162,72,0],[163,21,163,74,0],[164,21,164,88,0],[165,21,165,93,0],[166,21,166,76,0],[167,21,167,44,0],[168,21,168,45,0],[169,17,169,18,0],[170,17,170,110,0],[171,17,171,18,0],[172,21,172,76,0],[173,21,173,89,0],[174,21,174,41,0],[175,17,175,18,0],[176,13,176,14,0],[177,13,177,18,0],[178,13,178,14,0],[179,17,179,52,0],[180,13,180,14,0],[182,13,182,45,0],[183,9,183,10,0],[186,9,186,10,0],[188,13,188,14,0],[189,17,189,91,0],[190,17,190,37,0],[191,17,191,57,0],[192,13,192,14,0],[193,13,193,18,0],[194,13,194,14,0],[195,17,195,52,0],[196,13,196,14,0],[197,9,197,10,0],[200,9,200,10,0],[201,13,201,35,0],[202,13,202,29,0],[203,13,203,56,0],[204,9,204,10,0],[207,9,207,10,0],[208,13,208,35,0],[209,13,209,68,0],[210,13,210,51,0],[212,13,212,44,0],[213,13,213,14,0],[214,17,214,57,0],[215,17,215,24,0],[217,13,217,90,0],[218,13,218,76,0],[219,13,221,36,0],[222,13,222,49,0],[224,13,224,49,0],[225,9,225,10,0],[228,9,228,10,0],[229,13,229,35,0],[230,13,230,33,0],[231,13,231,68,0],[232,13,232,37,0],[233,13,233,29,0],[234,13,234,31,0],[235,13,235,48,0],[236,13,236,41,0],[237,13,237,42,0],[238,13,238,86,0],[239,9,239,10,0],[247,9,247,10,0],[249,13,249,14,0],[250,17,250,39,0],[252,17,252,49,0],[254,17,254,44,0],[255,17,255,62,0],[256,17,256,35,0],[257,17,257,18,0],[258,21,258,83,0],[259,21,259,55,0],[260,21,260,83,0],[261,21,261,65,0],[262,21,266,111,0],[269,21,270,34,0],[272,21,272,65,0],[273,21,273,63,0],[274,25,274,101,0],[277,21,278,40,0],[280,21,280,72,0],[281,21,281,74,0],[282,25,282,126,0],[284,21,284,112,0],[285,21,285,56,0],[287,21,287,59,0],[288,25,288,75,0],[290,21,295,74,0],[297,21,297,98,0],[298,21,298,61,0],[299,21,299,22,0],[300,25,300,75,0],[301,25,301,40,0],[302,25,302,26,0],[303,29,303,44,0],[304,29,304,107,0],[305,33,305,49,0],[308,29,316,53,0],[318,29,318,104,0],[320,29,320,62,0],[321,33,321,130,0],[322,25,322,26,0],[327,25,335,52,0],[336,25,336,116,0],[338,25,338,66,0],[339,29,339,134,0],[341,21,341,22,0],[342,21,345,84,0],[346,17,346,18,0],[348,17,348,18,0],[349,21,350,78,0],[351,21,351,112,0],[352,21,357,72,0],[358,21,359,65,0],[360,17,360,18,0],[361,17,361,34,0],[362,17,362,30,0],[363,17,363,109,0],[364,17,364,18,0],[365,21,365,78,0],[366,21,366,45,0],[367,17,367,18,0],[369,17,369,18,0],[370,21,370,63,0],[371,21,371,107,0],[372,21,372,60,0],[373,21,373,22,0],[374,25,374,108,0],[375,25,375,26,0],[376,29,376,36,0],[376,38,376,53,0],[376,54,376,56,0],[376,57,376,74,0],[377,29,377,30,0],[378,33,378,112,0],[379,37,379,62,0],[380,29,380,30,0],[381,25,381,26,0],[383,25,383,85,0],[384,25,387,34,0],[389,25,390,88,0],[391,29,391,118,0],[393,25,393,79,0],[394,29,394,110,0],[395,30,395,70,0],[396,29,397,84,0],[398,21,398,22,0],[401,21,401,53,0],[401,55,401,78,0],[401,80,401,103,0],[402,21,402,28,0],[402,29,402,43,0],[402,44,402,46,0],[402,47,402,74,0],[403,21,403,22,0],[404,25,404,103,0],[405,25,405,26,0],[406,29,406,57,0],[407,25,407,26,0],[408,30,408,124,0],[409,25,409,26,0],[410,29,410,55,0],[411,25,411,26,0],[412,30,412,124,0],[413,25,413,26,0],[414,29,414,55,0],[415,25,415,26,0],[416,21,416,22,0],[417,21,417,49,0],[418,21,418,22,0],[419,25,419,75,0],[420,29,420,74,0],[421,25,421,76,0],[422,29,422,74,0],[424,25,424,108,0],[424,108,424,135,0],[424,135,424,138,0],[424,25,424,138,0],[425,25,425,111,0],[427,25,427,72,0],[428,25,428,72,0],[429,25,429,32,0],[429,33,429,44,0],[429,45,429,47,0],[429,48,429,72,0],[430,25,430,26,0],[431,29,431,102,0],[431,102,431,159,0],[431,159,431,161,0],[431,29,431,161,0],[432,29,432,55,0],[433,29,433,30,0],[434,33,434,95,0],[435,33,435,95,0],[436,29,436,30,0],[437,25,437,26,0],[438,25,438,82,0],[439,25,439,82,0],[440,21,440,22,0],[442,21,442,64,0],[443,21,443,37,0],[446,21,446,28,0],[446,30,446,49,0],[446,50,446,52,0],[446,53,446,65,0],[447,21,447,22,0],[448,25,448,54,0],[449,21,449,22,0],[453,21,453,111,0],[454,21,454,28,0],[454,30,454,50,0],[454,51,454,53,0],[454,54,454,66,0],[455,21,455,22,0],[456,25,456,74,0],[457,25,457,26,0],[458,29,458,80,0],[459,25,459,26,0],[460,21,460,22,0],[464,21,464,65,0],[465,21,465,67,0],[466,21,466,81,0],[467,21,467,86,0],[468,21,468,40,0],[469,21,469,22,0],[470,25,470,98,0],[471,25,471,64,0],[472,29,472,50,0],[473,21,473,22,0],[475,21,475,28,0],[475,30,475,51,0],[475,52,475,54,0],[475,55,475,67,0],[476,21,476,22,0],[477,25,477,53,0],[478,29,478,49,0],[479,30,479,70,0],[480,29,480,89,0],[481,21,481,22,0],[484,21,484,58,0],[484,58,484,158,0],[484,158,486,25,0],[486,25,486,26,0],[486,26,487,29,0],[487,29,487,51,0],[487,51,488,29,0],[488,29,488,104,0],[488,104,489,25,0],[489,25,489,26,0],[489,26,489,28,0],[484,21,489,28,0],[492,21,492,40,0],[493,25,493,72,0],[495,25,495,89,0],[505,21,505,67,0],[506,21,506,35,0],[507,21,507,22,0],[508,25,508,48,0],[509,25,509,45,0],[510,29,510,45,0],[511,25,511,60,0],[512,25,512,45,0],[513,21,513,22,0],[514,21,514,92,0],[515,21,515,28,0],[515,30,515,60,0],[515,61,515,63,0],[515,64,515,70,0],[516,21,516,22,0],[517,25,517,90,0],[518,25,518,41,0],[519,29,519,99,0],[520,21,520,22,0],[521,17,521,18,0],[522,13,522,14,0],[523,13,523,33,0],[524,13,524,14,0],[525,17,525,47,0],[527,13,527,14,0],[528,9,528,10,0],[531,9,531,10,0],[532,13,532,40,0],[534,13,534,111,0],[535,13,535,14,0],[536,17,536,82,0],[537,17,537,33,0],[539,17,539,54,0],[540,17,540,67,0],[541,17,541,35,0],[542,17,542,18,0],[543,21,543,86,0],[544,21,545,83,0],[546,25,546,91,0],[548,21,548,22,0],[549,25,549,74,0],[550,25,550,88,0],[551,21,551,22,0],[552,21,552,38,0],[553,21,553,96,0],[554,25,554,85,0],[555,21,555,58,0],[556,25,556,75,0],[557,21,557,43,0],[558,21,558,106,0],[559,25,559,95,0],[560,21,560,70,0],[561,25,561,87,0],[562,21,562,63,0],[563,21,563,22,0],[564,25,564,82,0],[565,25,566,41,0],[567,21,567,22,0],[568,26,568,48,0],[569,25,569,107,0],[570,21,570,52,0],[571,21,571,22,0],[572,25,574,69,0],[575,29,575,97,0],[576,21,576,22,0],[577,17,577,18,0],[579,17,579,18,0],[580,21,580,83,0],[581,17,581,18,0],[582,17,582,48,0],[583,21,583,110,0],[584,13,584,14,0],[585,9,585,10,0],[588,9,588,10,0],[589,13,589,56,0],[590,13,590,90,0],[591,13,591,14,0],[592,17,592,60,0],[593,17,593,18,0],[594,21,594,107,0],[595,21,595,89,0],[596,17,596,18,0],[597,13,597,14,0],[598,9,598,10,0]]);
    </script>
  </body>
</html>