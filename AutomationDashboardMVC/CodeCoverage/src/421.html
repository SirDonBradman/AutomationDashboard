<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Main Modules\Estimator\BusinessLayer\ConcreateModels\Estimate\EstimateItemListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.EstimatorBL;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Estimator.BusinessLayer;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;

namespace Aurigo.AMP3.EstimatorUI
{
    [ItemListModelContext(Name = &quot;ESTMATE&quot;)]
    [ContextElement(Name = &quot;Estmate Item List&quot;)]
    public class EstmateItemListModel : ItemListModel
    {
        private bool? _IsLocked;
        private bool? _IsApproved;
        private bool? _isWorkflowAssociated;

        private List&lt;string&gt; _coreModuleComponents = null;

        public EstmateItemListModel()
        {
            RollUpColumnName = &quot;Amount&quot;;
        }

        private List&lt;string&gt; CoreModuleComponents
        {
            get
            {
                if (_coreModuleComponents == null)
                    _coreModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);

                return _coreModuleComponents;
            }
        }

        protected bool IsLocked
        {
            get
            {
                if (!_IsLocked.HasValue)
                    _IsLocked = EstimateManager.Instance.GetLockStatus(parentID);
                return _IsLocked.Value;
            }
        }

        public virtual bool CanAssociateFund
        {
            get
            {
                return !IsLocked;
            }
        }

        private bool IsApproved
        {
            get
            {
                if (!_IsApproved.HasValue)
                    _IsApproved = EstimateManager.Instance.GetApprovedStatus(parentID);
                return _IsApproved.Value;
            }
        }

        private bool IsWorkflow
        {
            get
            {
                if (!_isWorkflowAssociated.HasValue)
                {
                    _isWorkflowAssociated = false;
                    if (HttpContext.Current.CurrentHandler is BrixPageBase)
                    {
                        BrixPageBase pb = HttpContext.Current.CurrentHandler as BrixPageBase;
                        if (pb.IsWorkflowAssociated(WorkflowModuleID))
                        {
                            DataTable mappingDetails = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(parentID.ToString(), WorkflowModuleID);
                            _isWorkflowAssociated = (mappingDetails.Rows.Count &gt; 0 &amp;&amp; !mappingDetails.Rows[0][&quot;WorkflowInstanceGuid&quot;].Equals(DBNull.Value));
                        }
                    }
                }
                return _isWorkflowAssociated.Value;
            }
        }

        //private bool? _IsSubmited;
        //private bool IsSubmit
        //{
        //    get
        //    {
        //        if (!_IsSubmited.HasValue)
        //            _IsSubmited = IsEstimateSubmited(ParentID);
        //        return _IsSubmited.Value;
        //    }
        //}

        public override string ModuleId
        {
            get { return Constants.MODID_ESTMATE; }
        }

        public override string QueryStringName
        {
            get { return &quot;ID&quot;; }
        }

        public override string SkinID
        {
            get { return string.Empty; }
        }

        public override OtherAction[] OtherActions
        {
            get
            {
                var list = new List&lt;OtherAction&gt;();

                var action = new OtherAction();
                action.ID = &quot;lnkExcelImport&quot;;
                action.Name = &quot;Excel Import&quot;;
                action.Link = &quot;~/Common/Import.aspx?&quot; + Request.QueryString.ToString2();
                action.IsMainItem = false;
                list.Add(action);

                action = new OtherAction();
                action.ID = &quot;lnkExcelExport&quot;;
                action.Name = &quot;Excel Export (xls)&quot;;
                action.IsMainItem = false;
                list.Add(action);

                action = new OtherAction();
                action.ID = &quot;lnkExcelExportXlsx&quot;;
                action.Name = &quot;Excel Export (xlsx)&quot;;
                action.IsMainItem = false;
                list.Add(action);

                action = new OtherAction();
                action.ID = &quot;lnkExcelTemplateExport&quot;;
                action.Name = ExcelHelper.EXCEL_TEMPLATE;
                action.IsMainItem = false;
                list.Add(action);

                action = new OtherAction();
                action.ID = &quot;lnkExcelTemplateExportXlsx&quot;;
                action.Name = ExcelHelper.EXCEL_TEMPLATE_XLSX;
                action.IsMainItem = false;
                list.Add(action);

                action = new OtherAction();
                action.ID = &quot;lnkSettings&quot;;
                action.Name = &quot;Settings&quot;;
                action.IsMainItem = false;
                list.Add(action);

                action = new OtherAction();
                action.ID = &quot;lnkAddMultiple&quot;;
                action.Name = &quot;Add Multiple&quot;;
                action.IsMainItem = false;
                action.RequireSelection = true;
                list.Add(action);

                return list.ToArray();
            }
        }

        public override List&lt;MenuGroup&gt; MenuGroups
        {
            get
            {
                List&lt;MenuGroup&gt; menuGroups = base.MenuGroups;
                MenuGroup generalGroup = menuGroups.Find(mg =&gt; mg.Title == GlobalizationUtility.SetResource(&quot;Item&quot;, false) + &quot; Details&quot;);
                MenuGroup workflowGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_WORKFLOW);
                if (generalGroup == null)
                {
                    generalGroup = new MenuGroup(GlobalizationUtility.SetResource(&quot;Item&quot;, false) + &quot; Details&quot;);
                    menuGroups.Add(generalGroup);
                }
                else
                {
                    generalGroup.AddMenu(new TextIcon(&quot;lnkRefLineNo&quot;, &quot;Refresh Line Number&quot;, &quot;Icn_MSPSync_16.png&quot;));
                }
                if (displayApprove)
                {
                    if (workflowGroup != null)
                    {
                        var approveBtn = (TextIcon)workflowGroup.Menus.Find(m =&gt; m.ID == MENU_APPROVE_ID);
                        if (approveBtn != null)
                            workflowGroup.Menus.Remove(approveBtn);
                    }
                }
                if (displayUnApprove)
                {
                    if (workflowGroup != null)
                    {
                        var unApproveBtn = (TextIcon)workflowGroup.Menus.Find(m =&gt; m.ID == MENU_UNAPPROVE_ID);
                        if (unApproveBtn != null)
                            workflowGroup.Menus.Remove(unApproveBtn);
                    }
                }
                if (!IsWorkflow)
                {
                    if (displayUnlock) generalGroup.AddMenu(new TextIcon(&quot;lnkUnlock&quot;, &quot;Unlock&quot;, &quot;Icn_unlock_16.png&quot;));
                    if (displayLock) generalGroup.AddMenu(new TextIcon(&quot;lnkLock&quot;, &quot;Lock&quot;, &quot;Icn_lock_16.png&quot;));
                    if (displayApprove)
                        generalGroup.AddMenu(new TextIcon(MENU_APPROVE_ID, MENU_APPROVE, &quot;Icn_Approve_16.png&quot;));
                    if (displayUnApprove)
                        generalGroup.AddMenu(new TextIcon(MENU_UNAPPROVE_ID, MENU_UNAPPROVE, &quot;Icn_Undoapprove_16.png&quot;));
                }
                MenuGroup otherGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_OTHERS);
                if (otherGroup == null)
                {
                    otherGroup = new MenuGroup(GROUP_OTHERS);
                    menuGroups.Add(otherGroup);
                }

                if (displaySettings)
                    otherGroup.AddMenu(new TextIcon(&quot;lnkSettings&quot;, &quot;Settings&quot;, &quot;Icn_Settings_16.png&quot;));
                MenuButton btnReports = (MenuButton)otherGroup.Menus.Find(m =&gt; m.ID == MENU_REPORTS_ID);
                if (btnReports == null)
                {
                    btnReports = new MenuButton(MENU_REPORTS_ID, MENU_REPORTS, &quot;Icn_Reports.png&quot;);
                    btnReports.AddSubMenu(new TextIcon(&quot;lnkBidItemListReport&quot;, &quot;Bid Item List Report&quot;, &quot;Icn_Pdf_16.png&quot;));
                    otherGroup.AddMenu(btnReports);
                }

                List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_FNDMGMT);
                if (ModuleComponents != null &amp;&amp; ModuleComponents.Contains(&quot;FUND&quot; + Request[&quot;Context&quot;]) &amp;&amp; CanAssociateFund)
                {
                    List&lt;TextIcon&gt; lstRules = new List&lt;TextIcon&gt;();
                    DataSet ds = ItemManager.Instance.GetFundRule(Request[&quot;PID&quot;].ToInt32_2());
                    foreach (DataRow dr in ds.Tables[0].Rows)
                        lstRules.Add(new TextIcon(&quot;lnkApplyFundRule&quot; + dr[&quot;ID&quot;].ToString2(), dr[&quot;RuleName&quot;].ToString2(), &quot;Icn_Addexistingrecord_16.png&quot;, tag: &quot;RuleID-&quot; + dr[&quot;ID&quot;].ToString2()));

                    if (lstRules.Count &gt; 1)
                    {
                        MenuButton menuImpExp = new MenuButton(&quot;lnkFundRules&quot;, &quot;Associate Fund&quot;, &quot;Icn_Addexistingrecord_16.png&quot;);
                        menuImpExp.ButtonSize = ButtonSize.Medium;
                        lstRules.ForEach(mnu =&gt; { menuImpExp.AddSubMenu(mnu); });
                        otherGroup.AddMenu(menuImpExp);
                    }
                    else
                        lstRules.ForEach(mnu =&gt;
                        {
                            mnu.Text = &quot;Associate Fund - &quot; + mnu.Text;
                            otherGroup.AddMenu(mnu);
                        });
                }

                return menuGroups;
            }
        }

        public override void HandleEdit(ItemTypes type, int id)
        {
            string queryString = string.Empty;
            if (!string.IsNullOrEmpty(Request[&quot;ProjectEstimateID&quot;]))
                queryString = string.Format(CultureInfo.CurrentCulture, &quot;&amp;ProjectEstimateID={0}&quot;,
                                            Request[&quot;ProjectEstimateID&quot;]);
            if (type == ItemTypes.Item)
            {
                if (IsLocked)
                    throw new Exception(&quot;Estimate &quot; + LocalizationManager.GetString(KeyConstants.LOC_ITEM_ABBR) + &quot;(s) can not be edited after lock.&quot;);
                HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                                               &quot;BrixItemPage.aspx?Context={0}&amp;ItemID={1}&amp;Mode={2}&amp;ParentID={3}&amp;PID={4}{5}&quot;,
                                               ModuleId, id,
                                               Convert.ToInt32(ModeTypes.Edit, CultureInfo.CurrentCulture), parentID,
                                               Request[&quot;PID&quot;], queryString), false);
            }
            else
                HttpContext.Current.Server.Transfer(string.Format(CultureInfo.CurrentCulture,
                                               &quot;BrixItemContainer.aspx?Context={0}&amp;ContainerID={1}&amp;Mode={2}&amp;ParentID={3}&amp;PID={4}{5}{6}&quot;,
                                               ModuleId, id,
                                               Convert.ToInt32(ModeTypes.Edit, CultureInfo.CurrentCulture), parentID,
                                               Request[&quot;PID&quot;], queryString, IsLocked ? &quot;&amp;IsPE=1&quot; : string.Empty), false);
        }

        public override void SetUIDetails()
        {
            //bool lockedStatus = false;
            //bool approvedStatus = false;
            //if (parentID != 0)
            //{
            //    lockedStatus = IsEstimateLocked(parentID);
            //    approvedStatus = IsApproved(parentID);
            //}
            List&lt;string&gt; list = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_ESTMATE);
            displayBudgetItemAssociatePicker = true;
            DisplayWorkFlowHistory = DisplayWorkFlowStatus = IsWorkflow;

            displayApplyFilter = displayEdit = displayNew = displayDelete = displayNewContainer = true;

            displayLock = !IsLocked &amp;&amp; !IsApproved;
            displayUnlock = IsLocked;
            DisplayReorder = !IsLocked;
            displayImport = displayItemCopyPaste = displaySubItemCopyPaste = !IsLocked;
            if (!list.Contains(&quot;HideApprove&quot;))
            {
                displayApprove = !IsApproved;
                displayUnApprove = IsApproved;
            }
            else
                displayApprove = displayUnApprove = false;

            EnableAddMulti = EnableImport = EnableDelete = EnableNew = EnableNewContainer = !IsLocked;

            displayOtherDropMenu = displaySubItems = displayRateAnalysis = true;

            // OTHER ACTIONS - ENABLE SUBMENUS IN THE OTHER ACTIONS
            displayExport = displayTemplateExport = displayAddMultiple = displaySettings = true;

            //if (ItemManager.Instance.GetGroupType(parentID, Constants.MODID_ESTMATE) == &#39;G&#39;)
            //    DisplayGlobalGroups = true;

            ShowFlatList = true;

            header = GlobalizationUtility.SetResource(&quot;Item&quot;, false) + &quot; List&quot;;
            InstanceIDColumn = &quot;ProjectEstimateID&quot;;
            CreateDateColumn = &quot;CreatedDate&quot;;
            AllowGridEdit = !IsLocked;
            DisableSave = true;
        }

        public override void OnInit()
        {
            Page page = (HttpContext.Current.CurrentHandler as Page);
            page.ClientScript.RegisterClientScriptInclude(&quot;UnitPriceSearchScript&quot;, VirtualPathUtility.ToAbsolute(&quot;~/Modules/ESTMATE/Scripts/UnitPriceSearch_20140410_1600.js&quot;));

            base.OnInit();
        }

        public Control FindControlRecursive(Control root, string id)
        {
            if (root.ID == id)
                return root;

            return root.Controls.Cast&lt;Control&gt;()
               .Select(c =&gt; FindControlRecursive(c, id))
               .FirstOrDefault(c =&gt; c != null);
        }

        public override BrixFilter[] GetApplyFilterLabels()
        {
            var filters = new BrixFilter[2];
            filters[0] = new BrixFilter();
            filters[0].Name = &quot;StandardItemNo&quot;;
            filters[0].Title = GlobalizationUtility.SetResource(&quot;Pay Item No&quot;, false);
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        public override int HandleUnlock()
        {
            //bool approveStatus = IsApproved(parentID);
            if (IsApproved)
                return -100;
            int lockStatus = EstimateManager.Instance.UpdateIsLocked(parentID, false);
            _IsLocked = null;
            displayUnlock =
                !(DisplayImport = EnableNew = EnableDelete = displayLock = EnableItemCopyPaste =
                    EnableSubItemCopyPaste = EnableAddMulti = EnableImport = EnableNewContainer = !IsLocked);

            SetUIDetails();

            return lockStatus;
        }

        public override int HandleLock()
        {
            List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_ESTMATE);
            if (ModuleComponents != null &amp;&amp; ModuleComponents.Contains(&quot;ValidateBidItemsWithBudget&quot;))
            {
                Dictionary&lt;string, object&gt; dic = new Dictionary&lt;string, object&gt;();
                int result = ComponentHelper.Instance.ExecuteScalar(new StoredProcedure { Name = &quot;usp_BIDMGMTValidateEstimateAmountAndBidAmount&quot;, Input = &quot;BUDGID,BIDID&quot; }, dic, Request[&quot;ParentID&quot;], Request[&quot;PID&quot;]).ToInt32_2();
                if (result != 0)
                {
                    throw new Exception(&quot;Bid Estimate is greater than Budget Estimate.&quot;);
                }
            }
            int lockStatus = EstimateManager.Instance.UpdateIsLocked(parentID, true);
            _IsLocked = null;
            DisplayImport = EnableNew = EnableDelete = displayLock = EnableAddMulti = EnableImport =
                EnableItemCopyPaste = enableSubItemCopyPaste = EnableNewContainer = !(displayUnlock = IsLocked);

            SetUIDetails();

            return lockStatus;
        }

        public override MenuHandlerStatus HandleApprove()
        {
            int approveStatus = EstimateManager.Instance.UpdateIsApproved(parentID, true);
            _IsApproved = null;
            displayApprove = !(displayUnApprove = IsApproved);
            return MenuHandlerStatus.GetSuccessObject(&quot; Estimate is Approved by Manager&quot;);
        }

        public override MenuHandlerStatus HandleUnApprove()
        {
            int approveStatus = EstimateManager.Instance.UpdateIsApproved(parentID, false);
            _IsApproved = null;
            displayUnApprove = !(displayApprove = !IsApproved);
            switch (approveStatus)
            {
                case -1:
                    return MenuHandlerStatus.GetErrorObject(&quot;Cannot undo approve as Estimate is awarded.&quot;);

                case -3:
                    return MenuHandlerStatus.GetErrorObject(&quot;Cannot undo approve as Bid letting exists.&quot;);

                case -4:
                    return MenuHandlerStatus.GetErrorObject(&quot;Cannot undo approve as Bids exists.&quot;);
            }
            return MenuHandlerStatus.GetSuccessObject(string.Empty);
        }

        public override void HandleDelete(ItemTypes type, string ids)
        {
            base.HandleDelete(type, ids);
        }

        public override string HandleMenuItem(string eventString)
        {
            switch (eventString)
            {
                case &quot;Settings&quot;:
                    Response.Redirect(
                        &quot;~/Modules/ESTMATE/EstimateSettings.aspx?PID={0}&amp;ProjectEstimateID={1}&quot;.Format2(Request[&quot;PID&quot;],
                                                                                                        Request[
                                                                                                            &quot;ParentID&quot;]), true);
                    break;
                //case &quot;Global Groups&quot;:
                //    Response.Redirect(
                //        &quot;~/Common/BrixListPage.aspx?Context=GLOBALGROUP{0}&amp;LockMode={1}&amp;ParentInstanceID={2}&amp;PID={3}&amp;ModuleID={0}&quot;
                //            .Format2(ModuleId, DisplayUnlock ? ModeTypes.View.ToInt32_2() : ModeTypes.Edit.ToInt32_2(),
                //                     ParentID, Request[Constants.QRY_PROJECTID]), true);
                //    break;
                case &quot;Flat List&quot;:
                    string url = &quot;~/Common/BrixListPage.aspx?&quot; + Request.QueryString;
                    url = url.ToLower().Replace(&quot;context=estmate&quot;, &quot;Context=FLATEST&quot;).Replace(&quot;mode=edit&quot;, &quot;mode=Edit&quot;);
                    Response.Redirect(url);
                    break;

                case &quot;Refresh Line Number&quot;:
                    RefreshLineNumbers(ModuleId, ParentID);
                    EnableSave = false;
                    Response.Redirect(Request.RawUrl);
                    break;

                case &quot;Bid Item List Report&quot;:
                    Response.Redirect(String.Format(CultureInfo.CurrentCulture,
                        &quot;~/Common/BrixListReportPage.aspx?Context=BIDITML&amp;ParentID={0}&amp;ModelType=ItemList&amp;ModuleID=ESTMATE&amp;ParentModuleID=ESTMATE&amp;ParentContext=ESTMATE&amp;PID={1}&quot;,
                        Request[&quot;ParentID&quot;], Request[&quot;PID&quot;]), true);
                    isMenuClickHandled = true;
                    break;

                case &quot;Delete&quot;:
                    isMenuClickHandled = true;
                    EnableSave = false;
                    Response.Redirect(Request.RawUrl);
                    break;

                default:
                    return base.HandleMenuItem(eventString);
            }
            return string.Empty;
        }

        private void RefreshLineNumbers(string ModuleId, int ParentID)
        {
            try
            {
                ItemManager.Instance.RefreshLineNumbers(ModuleId, ParentID);
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }

        public override DataSet GetSchema()
        {
            var ici = new ImportEstimateItems();
            return ici.GetSchema(&quot;AXCompany&quot;);
        }

        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int currentPage, out int count)
        {
            return base.GetList(pageSize, sortOrder, filter, ref currentPage, out count);
        }

        //Disable unlock button if the record is approved.
        public override void ApplyToolBarCustomisation(ToolBar toolBarArg)
        {
            base.ApplyToolBarCustomisation(toolBarArg);

            //bool lockedStatus = false;
            //if (parentID != 0)
            //    lockedStatus = IsEstimateLocked(parentID);

            if (IsLocked &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkDelete&quot;) != null)
            {
                //toolBarArg.GetMenuReference(&quot;lnkEdit&quot;).Attributes.Add(&quot;onclick&quot;, &quot;return false;&quot;);
                toolBarArg.GetMenuReference(&quot;lnkDelete&quot;).OnClientClick = &quot;return false;&quot;;
            }

            if (IsApproved &amp;&amp; displayUnlock &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkUnlock&quot;) != null)
                toolBarArg.GetMenuReference(&quot;lnkUnlock&quot;).Enabled = false;

            if (!IsLocked &amp;&amp; displayApprove &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkApprove&quot;) != null)
                toolBarArg.GetMenuReference(&quot;lnkApprove&quot;).Enabled = false;

            if (displayApprove &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkApprove&quot;) != null &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkApprove&quot;).Enabled)
                toolBarArg.GetMenuReference(&quot;lnkApprove&quot;).OnClientClick = &quot;return confirm(&#39;Are you sure you want to Approve?&#39;);&quot;;

            if (displayUnApprove &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkUnApprove&quot;) != null &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkUnApprove&quot;).Enabled)
                toolBarArg.GetMenuReference(&quot;lnkUnApprove&quot;).OnClientClick = &quot;return confirm(&#39;Are you sure you want to Undo Approve?&#39;);&quot;;

            if (displayUnlock &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkUnlock&quot;) != null &amp;&amp; !toolBarArg.GetMenuReference(&quot;lnkUnlock&quot;).Enabled)
                toolBarArg.GetMenuReference(&quot;lnkUnlock&quot;).OnClientClick = &quot;return ShowError(&#39;Cannot unlock as estimate is approved.&#39;);&quot;;

            if (displayApprove &amp;&amp; toolBarArg.GetMenuReference(&quot;lnkApprove&quot;) != null &amp;&amp; !toolBarArg.GetMenuReference(&quot;lnkApprove&quot;).Enabled)
                toolBarArg.GetMenuReference(&quot;lnkApprove&quot;).OnClientClick = &quot;return ShowError(&#39;Cannot approve as estimate is not locked.&#39;);&quot;;

            toolBarArg.DisableMenu(&quot;lnkListSave&quot;);
        }

        public override void CustomUnlock(ToolBar MainToolBar)
        {
            MainToolBar.GetMenuReference(&quot;lnkNew&quot;).Enabled =
                MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Enabled =
                MainToolBar.GetMenuReference(&quot;lnkExcelImport&quot;).Enabled =
                MainToolBar.GetMenuReference(&quot;lnkItemCopyPaste&quot;).Enabled =
                MainToolBar.GetMenuReference(&quot;lnkSubItemCopyPaste&quot;).Enabled =
                MainToolBar.GetMenuReference(&quot;lnkDelete&quot;).Enabled = true;
        }

        public override void CustomDisplay(ToolBar MainToolBar)
        {
            if (DisplayNew &amp;&amp; !EnableNew) MainToolBar.DisableMenu(&quot;lnkNew&quot;);
            if (DisplayDelete &amp;&amp; !EnableDelete) MainToolBar.DisableMenu(&quot;lnkDelete&quot;);
            if (DisplayEdit &amp;&amp; !EnableEdit) MainToolBar.DisableMenu(&quot;lnkEdit&quot;);

            if (DisplayNew &amp;&amp; !EnableNew) MainToolBar.GetMenuReference(&quot;lnkSubItemCopyPaste&quot;).Enabled = false;
            if (DisplayNew &amp;&amp; !EnableNew) MainToolBar.GetMenuReference(&quot;lnkItemCopyPaste&quot;).Enabled = false;
            if (DisplayNew &amp;&amp; !EnableNew) MainToolBar.GetMenuReference(&quot;lnkExcelImport&quot;).Enabled = false;
        }

        protected override void GetExportListData(DataSet ds)
        {
            if (ds.Tables[0].Columns.Contains(ItemsDBColumns.IS_COMPLETE))
                ds.Tables[0].Columns.Remove(ItemsDBColumns.IS_COMPLETE);
            if (ds.Tables[0].Columns.Contains(ItemsDBColumns.IS_NON_CONTRACT))
                ds.Tables[0].Columns.Remove(ItemsDBColumns.IS_NON_CONTRACT);
        }

        public override string WorkflowModuleID
        {
            get
            {
                return &quot;XESITWF&quot;;
            }
        }

        public override void CustomizeContextMenu(List&lt;BrixContextMenu&gt; cMenu)
        {
            base.CustomizeContextMenu(cMenu);

            List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_FNDMGMT);
            if (ModuleComponents != null &amp;&amp; ModuleComponents.Contains(&quot;FUND&quot; + Request[&quot;Context&quot;]) &amp;&amp; CanAssociateFund)
            {
                DataSet ds = ItemManager.Instance.GetFundRule(Request[&quot;PID&quot;].ToInt32_2());
                foreach (DataRow dr in ds.Tables[0].Rows)
                    cMenu.Add(new BrixContextMenu(&quot;Associate Fund Rule&quot;, &quot;Associate Fund - &quot; + dr[&quot;RuleName&quot;].ToString2(), string.Empty, ContextMenuActionType.Code, &quot;return true;&quot;, tag: &quot;RuleID-&quot; + dr[&quot;ID&quot;].ToString2()));
            }
            if (!IsLocked)//Unit Price Search
            {
                Page page = (HttpContext.Current.CurrentHandler as Page);
                HtmlIframe iframeUnitPriceSearchRef = (HtmlIframe)FindControlRecursive(page, &quot;iframeUnitPriceSearch&quot;);
                Panel pnlUnitPriceSearchRef = (Panel)FindControlRecursive(page, &quot;pnlUnitPriceSearch&quot;);
                Button CancelButtonRef = (Button)FindControlRecursive(page, &quot;btnUnitPriceSearchClose&quot;);

                cMenu.Add(new BrixContextMenu(&quot;Unit Price Search&quot;, &quot;Unit Price Search&quot;, string.Empty, ContextMenuActionType.ClientScript,
                    string.Format(&quot;OpenUnitPriceWindow(event, &#39;{0}&#39;,&#39;{1}&#39;,&#39;{2}&#39;,&#39;{3}&#39;,&#39;{4}&#39;); return false;&quot;, pnlUnitPriceSearchRef.ClientID, CancelButtonRef.ClientID, iframeUnitPriceSearchRef.ClientID, Request[&quot;ParentID&quot;], Request[&quot;PID&quot;])));
            }
        }

        public override void HandleMenuItems(string eventString, Infragistics.WebUI.UltraWebGrid.ExcelExport.UltraWebGridExcelExporter expGrid, string ids)
        {
            if (eventString.Contains(&quot;-RuleID-&quot;) &amp;&amp; CanAssociateFund)
            {
                if (!string.IsNullOrEmpty(hGrid.CheckedItems) || !string.IsNullOrEmpty(hGrid.CheckedContainers) || ((hGrid.SelectedRowType == &quot;ITR&quot; || hGrid.SelectedRowType == &quot;CTR&quot;) &amp;&amp; !string.IsNullOrEmpty(hGrid.SelectedRowID)))
                {
                    string fundRuleName = eventString.Replace(&quot;Associate Fund - &quot;, &quot;&quot;).Replace(&quot;-RuleID&quot;, &quot;&quot;);
                    string[] rules = fundRuleName.Split(&#39;-&#39;);
                    string RuleId = rules[rules.Length - 1];
                    //Apply Fund Rule
                    string itemids = string.Empty;
                    if (hGrid.SelectedRowType == &quot;ITR&quot; &amp;&amp; !string.IsNullOrEmpty(hGrid.SelectedRowID))
                        itemids = hGrid.SelectedRowID;
                    if (!string.IsNullOrEmpty(hGrid.CheckedItems))
                        itemids = string.IsNullOrEmpty(itemids) ? hGrid.CheckedItems.Trim(&#39;,&#39;) : itemids + &quot;,&quot; + hGrid.CheckedItems.Trim(&#39;,&#39;);

                    string containerids = string.Empty;
                    if (hGrid.SelectedRowType == &quot;CTR&quot; &amp;&amp; !string.IsNullOrEmpty(hGrid.SelectedRowID))
                        containerids = hGrid.SelectedRowID;
                    if (!string.IsNullOrEmpty(hGrid.CheckedContainers))
                        containerids += string.IsNullOrEmpty(containerids) ? hGrid.CheckedContainers.Trim(&#39;,&#39;) : containerids + &quot;,&quot; + hGrid.CheckedContainers.Trim(&#39;,&#39;);

                    if (!string.IsNullOrEmpty(itemids))
                    {
                        string selectedIDs = itemids.Trim(&#39;,&#39;);
                        selectedIDs = &quot;&lt;items&gt;&lt;item&gt;&quot; + selectedIDs.Replace(&quot;,&quot;, &quot;&lt;/item&gt;&lt;item&gt;&quot;) + &quot;&lt;/item&gt;&lt;/items&gt;&quot;;
                        ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(StoredProcedure.usp_UpdateCORITEMItemDetailsItem, null, &quot;ESTMATE&quot;, RuleId, Request[&quot;ParentID&quot;], selectedIDs);
                    }
                    if (!string.IsNullOrEmpty(containerids))
                    {
                        string selectedIDs = containerids.Trim(&#39;,&#39;);
                        selectedIDs = &quot;&lt;items&gt;&lt;item&gt;&quot; + selectedIDs.Replace(&quot;,&quot;, &quot;&lt;/item&gt;&lt;item&gt;&quot;) + &quot;&lt;/item&gt;&lt;/items&gt;&quot;;
                        ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(StoredProcedure.usp_UpdateCORITEMItemDetailsContainer, null, &quot;ESTMATE&quot;, RuleId, Request[&quot;ParentID&quot;], selectedIDs);
                    }
                }
                else
                {
                    isMenuClickHandled = false;
                    throw new Exception(&quot;Select atleast one item or container&quot;);
                }
                HttpContext.Current.Server.Transfer(&quot;BrixItemListPage.aspx?Context={0}&amp;ParentID={1}&amp;PID={2}&quot;.Format2(ModuleId, Request[&quot;ParentID&quot;], Request[&quot;PID&quot;]));
            }
            else
            {
                base.HandleMenuItems(eventString, expGrid, ids);
            }
        }

        public override HierarchicalGridColumns HGridColumns()
        {
            HierarchicalGridColumns cols = base.HGridColumns();

            if (CoreModuleComponents.IsNotNullAndHasItems() &amp;&amp; CoreModuleComponents.Contains(Constants.ModuleComponent.EnableResourceManagement))
            {
                cols.Add(new HierarchicalGridColumn(&quot;Resources&quot;, 200, false));
            }

            return cols;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[35,9,35,59,0],[37,9,37,38,0],[38,9,38,10,0],[39,13,39,41,0],[40,9,40,10,0],[45,13,45,14,1],[46,17,46,51,1],[47,21,47,111,1],[49,17,49,46,1],[50,13,50,14,1],[56,13,56,14,1],[57,17,57,41,1],[58,21,58,82,1],[59,17,59,40,1],[60,13,60,14,1],[66,13,66,14,1],[67,17,67,34,1],[68,13,68,14,1],[74,13,74,14,1],[75,17,75,43,1],[76,21,76,88,1],[77,17,77,42,1],[78,13,78,14,1],[84,13,84,14,1],[85,17,85,53,1],[86,17,86,18,1],[87,21,87,51,1],[88,21,88,76,1],[89,21,89,22,1],[90,25,90,94,1],[91,25,91,71,1],[92,25,92,26,0],[93,29,93,150,0],[94,29,94,157,0],[95,25,95,26,0],[96,21,96,22,1],[97,17,97,18,1],[98,17,98,52,1],[99,13,99,14,1],[115,17,115,18,1],[115,19,115,50,1],[115,51,115,52,1],[120,17,120,18,0],[120,19,120,31,0],[120,32,120,33,0],[125,17,125,18,0],[125,19,125,39,0],[125,40,125,41,0],[131,13,131,14,0],[132,17,132,52,0],[134,17,134,48,0],[135,17,135,46,0],[136,17,136,46,0],[137,17,137,89,0],[138,17,138,43,0],[139,17,139,34,0],[141,17,141,44,0],[142,17,142,46,0],[143,17,143,52,0],[144,17,144,43,0],[145,17,145,34,0],[147,17,147,44,0],[148,17,148,50,0],[149,17,149,53,0],[150,17,150,43,0],[151,17,151,34,0],[153,17,153,44,0],[154,17,154,54,0],[155,17,155,58,0],[156,17,156,43,0],[157,17,157,34,0],[159,17,159,44,0],[160,17,160,58,0],[161,17,161,63,0],[162,17,162,43,0],[163,17,163,34,0],[165,17,165,44,0],[166,17,166,43,0],[167,17,167,42,0],[168,17,168,43,0],[169,17,169,34,0],[171,17,171,44,0],[172,17,172,46,0],[173,17,173,46,0],[174,17,174,43,0],[175,17,175,48,0],[176,17,176,34,0],[178,17,178,39,0],[179,13,179,14,0],[185,13,185,14,1],[186,17,186,62,1],[187,17,187,64,1],[187,64,187,136,0],[187,136,187,138,1],[187,17,187,138,1],[188,17,188,65,1],[188,65,188,91,0],[188,91,188,93,1],[188,17,188,93,1],[189,17,189,42,1],[190,17,190,18,0],[191,21,191,112,0],[192,21,192,50,0],[193,17,193,18,0],[195,17,195,18,1],[196,21,196,117,1],[197,17,197,18,1],[198,17,198,36,1],[199,17,199,18,1],[200,21,200,47,1],[201,21,201,22,1],[202,25,202,82,1],[202,82,202,105,0],[202,105,202,107,1],[202,25,202,107,1],[203,25,203,48,1],[204,29,204,68,1],[205,21,205,22,1],[206,17,206,18,1],[207,17,207,38,1],[208,17,208,18,1],[209,21,209,47,1],[210,21,210,22,1],[211,25,211,84,1],[211,84,211,109,0],[211,109,211,111,1],[211,25,211,111,1],[212,25,212,50,1],[213,29,213,70,1],[214,21,214,22,1],[215,17,215,18,1],[216,17,216,33,1],[217,17,217,18,1],[218,21,218,39,1],[218,40,218,119,1],[219,21,219,37,1],[219,38,219,111,1],[220,21,220,40,1],[221,25,221,113,1],[222,21,222,42,1],[223,25,223,121,1],[224,17,224,18,1],[225,17,225,62,1],[225,62,225,86,0],[225,86,225,88,1],[225,17,225,88,1],[226,17,226,40,1],[227,17,227,18,0],[228,21,228,62,0],[229,21,229,48,0],[230,17,230,18,0],[232,17,232,37,1],[233,21,233,104,1],[234,17,234,80,1],[234,80,234,103,0],[234,103,234,105,1],[234,17,234,105,1],[235,17,235,40,1],[236,17,236,18,1],[237,21,237,99,1],[238,21,238,123,1],[239,21,239,52,1],[240,17,240,18,1],[242,17,242,118,1],[243,17,243,124,1],[244,17,244,18,1],[245,21,245,68,1],[246,21,246,95,1],[247,21,247,28,1],[247,30,247,40,0],[247,41,247,43,1],[247,44,247,61,1],[248,25,248,194,0],[250,21,250,44,1],[251,21,251,22,0],[252,25,252,130,0],[253,25,253,67,0],[254,25,254,49,0],[254,49,254,50,0],[254,50,254,51,0],[254,51,254,78,0],[254,78,254,79,0],[254,79,254,80,0],[254,80,254,82,0],[254,25,254,82,0],[255,25,255,56,0],[256,21,256,22,0],[258,25,259,25,1],[259,25,259,26,0],[259,26,260,29,1],[260,29,260,71,0],[260,71,261,29,1],[261,29,261,53,0],[261,53,262,25,1],[262,25,262,26,0],[262,26,262,28,1],[258,25,262,28,1],[263,17,263,18,1],[265,17,265,35,1],[266,13,266,14,1],[270,9,270,10,0],[271,13,271,47,0],[272,13,272,69,0],[273,17,274,75,0],[275,13,275,40,0],[276,13,276,14,0],[277,17,277,30,0],[278,21,278,152,0],[279,17,283,85,0],[284,13,284,14,0],[286,17,290,122,0],[291,9,291,10,0],[294,9,294,10,1],[302,13,302,102,1],[303,13,303,53,1],[304,13,304,73,1],[306,13,306,104,1],[308,13,308,52,1],[309,13,309,38,1],[310,13,310,40,1],[311,13,311,88,1],[312,13,312,47,1],[313,13,313,14,1],[314,17,314,46,1],[315,17,315,47,1],[316,13,316,14,1],[318,17,318,59,0],[320,13,320,103,1],[322,13,322,81,1],[325,13,325,97,1],[330,13,330,33,1],[332,13,332,80,1],[333,13,333,52,1],[334,13,334,46,1],[335,13,335,39,1],[336,13,336,32,1],[337,9,337,10,1],[340,9,340,10,1],[341,13,341,70,1],[342,13,342,177,1],[344,13,344,27,1],[345,9,345,10,1],[348,9,348,10,1],[349,13,349,31,1],[350,17,350,29,1],[352,13,353,29,1],[353,29,353,56,0],[353,56,354,37,1],[354,37,354,46,0],[354,46,354,48,1],[352,13,354,48,1],[355,9,355,10,1],[358,9,358,10,1],[359,13,359,45,1],[360,13,360,43,1],[361,13,361,48,1],[362,13,362,87,1],[363,13,363,58,1],[365,13,365,43,1],[366,13,366,64,1],[367,13,367,58,1],[369,13,369,28,1],[370,9,370,10,1],[373,9,373,10,1],[375,13,375,28,1],[376,17,376,29,0],[377,13,377,87,1],[378,13,378,30,1],[379,13,381,110,1],[383,13,383,28,1],[385,13,385,31,1],[386,9,386,10,1],[389,9,389,10,1],[390,13,390,114,1],[391,13,391,101,1],[392,13,392,14,0],[393,17,393,83,0],[394,17,394,227,0],[395,17,395,33,0],[396,17,396,18,0],[397,21,397,90,0],[399,13,399,14,0],[400,13,400,86,1],[401,13,401,30,1],[402,13,403,113,1],[405,13,405,28,1],[407,13,407,31,1],[408,9,408,10,1],[411,9,411,10,1],[412,13,412,91,1],[413,13,413,32,1],[414,13,414,63,1],[415,13,415,91,1],[416,9,416,10,1],[419,9,419,10,0],[420,13,420,92,0],[421,13,421,32,0],[422,13,422,64,0],[423,13,423,35,0],[426,21,426,108,0],[429,21,429,107,0],[432,21,432,100,0],[434,13,434,69,0],[435,9,435,10,0],[438,9,438,10,1],[439,13,439,42,1],[440,9,440,10,1],[443,9,443,10,1],[444,13,444,33,1],[447,21,450,129,1],[451,21,451,27,0],[459,21,459,86,1],[460,21,460,121,1],[461,21,461,44,1],[462,21,462,27,0],[465,21,465,60,0],[466,21,466,40,0],[467,21,467,55,0],[468,21,468,27,0],[471,21,473,69,1],[474,21,474,47,0],[475,21,475,27,0],[478,21,478,47,1],[479,21,479,40,1],[480,21,480,55,1],[481,21,481,27,0],[484,21,484,61,1],[486,13,486,33,0],[487,9,487,10,1],[490,9,490,10,0],[492,13,492,14,0],[493,17,493,77,0],[494,13,494,14,0],[495,13,495,33,0],[496,13,496,14,0],[497,17,497,49,0],[499,9,499,10,0],[502,9,502,10,1],[503,13,503,49,1],[504,13,504,47,1],[505,9,505,10,1],[508,9,508,10,1],[509,13,509,90,1],[510,9,510,10,1],[514,9,514,10,1],[515,13,515,56,1],[521,13,521,78,1],[522,13,522,14,1],[524,17,524,90,1],[525,13,525,14,1],[527,13,527,97,1],[528,17,528,74,1],[530,13,530,98,1],[531,17,531,75,1],[533,13,533,138,1],[534,17,534,130,1],[536,13,536,144,1],[537,17,537,137,1],[539,13,539,136,1],[540,17,540,136,1],[542,13,542,139,1],[543,17,543,140,1],[545,13,545,51,1],[546,9,546,10,1],[549,9,549,10,0],[550,13,555,74,0],[556,9,556,10,0],[559,9,559,10,0],[560,13,560,42,0],[560,43,560,77,0],[561,13,561,48,0],[561,49,561,86,0],[562,13,562,44,0],[562,45,562,80,0],[564,13,564,42,0],[564,43,564,111,0],[565,13,565,42,0],[565,43,565,108,0],[566,13,566,42,0],[566,43,566,106,0],[567,9,567,10,0],[570,9,570,10,1],[571,13,571,75,1],[572,17,572,73,0],[573,13,573,79,1],[574,17,574,77,0],[575,9,575,10,1],[580,13,580,14,1],[581,17,581,34,1],[582,13,582,14,1],[586,9,586,10,1],[587,13,587,46,1],[589,13,589,114,1],[590,13,590,120,1],[591,13,591,14,1],[592,17,592,91,1],[593,17,593,24,1],[593,26,593,36,0],[593,37,593,39,1],[593,40,593,57,1],[594,21,594,222,0],[595,13,595,14,1],[596,13,596,27,1],[597,13,597,14,1],[598,17,598,74,1],[599,17,599,119,1],[600,17,600,103,1],[601,17,601,104,1],[603,17,604,243,1],[605,13,605,14,1],[606,9,606,10,1],[609,9,609,10,1],[610,13,610,70,1],[611,13,611,14,0],[612,17,612,231,0],[613,17,613,18,0],[614,21,614,111,0],[615,21,615,62,0],[616,21,616,61,0],[618,21,618,51,0],[619,21,619,102,0],[620,25,620,55,0],[621,21,621,67,0],[622,25,622,143,0],[624,21,624,56,0],[625,21,625,102,0],[626,25,626,60,0],[627,21,627,72,0],[628,25,628,169,0],[630,21,630,56,0],[631,21,631,22,0],[632,25,632,64,0],[633,25,633,119,0],[634,25,634,197,0],[635,21,635,22,0],[636,21,636,61,0],[637,21,637,22,0],[638,25,638,69,0],[639,25,639,119,0],[640,25,640,202,0],[641,21,641,22,0],[642,17,642,18,0],[644,17,644,18,0],[645,21,645,48,0],[646,21,646,81,0],[648,17,648,166,0],[649,13,649,14,0],[651,13,651,14,1],[652,17,652,65,1],[653,13,653,14,1],[654,9,654,10,1],[657,9,657,10,1],[658,13,658,64,1],[660,13,660,146,1],[661,13,661,14,1],[662,17,662,79,1],[663,13,663,14,1],[665,13,665,25,1],[666,9,666,10,1]]);
    </script>
  </body>
</html>