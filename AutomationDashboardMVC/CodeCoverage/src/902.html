<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\XmlForm Framework\GenericXMLListPageController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Json;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Web;
using System.Web.Http;
using System.Web.Script.Serialization;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.Controller;
using Aurigo.Brix.Platform.BusinessLayer.UserControls;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Common;
using Aurigo.Workflow;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace Aurigo.Brix.Platform.BusinessLayer.XmlForm_Framework
{
    [MWAuthentication]
    public class GenericXMLListPageController : ApiController
    {
        const string CONST_SEPARATOR_AUR_ModifiedOn_LastPKey = &quot;_SEPARATOR_&quot;;

        internal static void Extract_LastSyncDateTime_And_LastPKey(string sourceString, out string lastSyncDateTime, out int PKey)
        {
            if (string.IsNullOrEmpty(sourceString) || sourceString == &quot;EMPTY&quot;)
            {
                lastSyncDateTime = &quot;EMPTY&quot;;
                PKey = 0;
            }
            else
            {
                if (sourceString.Contains(CONST_SEPARATOR_AUR_ModifiedOn_LastPKey))
                {

                    string[] arr = sourceString.Split(new string[] { CONST_SEPARATOR_AUR_ModifiedOn_LastPKey }, StringSplitOptions.None);
                    if (arr.Length &gt; 0)
                        lastSyncDateTime = arr[0];//this is the lastSyncDateTime
                    else
                        lastSyncDateTime = sourceString;

                    if (arr.Length &gt; 1)//means we have the primary key available
                        PKey = Convert.ToInt32(arr[1]);
                    else
                        PKey = 0;
                }
                else
                {
                    lastSyncDateTime = sourceString; //backward compatible
                    PKey = 0;
                }
            }
        }


        private class DataSourceRequestExt : DataSourceRequest
        {
            public object requestParams { get; set; }
        }

        [HttpGet]
        public HttpResponseMessage GetListPageOptions(string context, string jsonParameters = &quot;&quot;)
        {
            DateTime Start = DateTime.UtcNow;
            string result = string.Empty;
            if (GetListPageTemplate(context, out result, jsonParameters))
            {
                var response = Request.CreateResponse&lt;string&gt;(HttpStatusCode.OK, result);
                response.Headers.Add(&quot;Request-Start&quot;, Start.ToDateTimeString_InvariantCulture());//TODO:Asheesh_Check_TimeZone: Thread culture will get used here
                return response;
            }
            var BadRequest = Request.CreateResponse&lt;string&gt;(HttpStatusCode.BadRequest, result);
            BadRequest.Headers.Add(&quot;Request-Start&quot;, Start.ToDateTimeString_InvariantCulture());//TODO:Asheesh_Check_TimeZone: Thread culture will get used here
            return BadRequest;
        }

        [HttpGet]
        public HttpResponseMessage Get(HttpRequestMessage requestMessage)
        {
            DataSourceRequestExt request = GetDataSourceRequestExt(requestMessage.RequestUri.ParseQueryString().GetKey(0));
            return GetActualListData(request);
        }

        [HttpPost]
        public HttpResponseMessage Post([FromBody]string requestMessage)
        {
            DataSourceRequestExt request = GetDataSourceRequestExt(requestMessage);
            return GetActualListData(request);
        }

        #region NON API METHODS

        private string GetType(xControl xc)
        {
            string type = &quot;string&quot;;
            if (xc != null)
                if (xc.Type == ControlType.Numeric || xc.Type == ControlType.Integer)
                    type = &quot;number&quot;;
            return type;
        }

        private string GetFormattedColumn(xControl xc)
        {
            if (xc != null)
            {
                string column = xc.Name;

                if (xc.Type == ControlType.Date)

                    // column = &quot;xmlForm.getMWDateFormattedString(&quot; + column + &quot;)&quot;; this is new method added to wrapper for Date formatting. 
                    // if you have latest app then it is good to use this wrapper method and comment the below code for formatting the date.

                    column = &quot;kendo.toString(ToDate(&quot; + column + &quot;), &#39;&quot; + AMP3ApplicationSettings.Instance.FORMAT_DATE +
                            &quot;&#39;)&quot;;
                if (xc.Type == ControlType.Numeric)
                    column = &quot;kendo.toString(ToNumber(&quot; + column + &quot;), &#39;N&quot; + GetNumericDecimalLength(xc.GetControlFormat()) +
                             &quot;&#39;)&quot;;

                return column;
            }
            return &quot;&quot;;
        }

        private string EscapeSpecialCharacters(string name)
        {
            return name.Replace(&quot;#&quot;, &quot;\\\\#&quot;);
        }

        private string GetNumericDecimalLength(string format)
        {
            return
                (format != null &amp;&amp; format.Contains(&quot;.&quot;) ? format.Substring(format.IndexOf(&quot;.&quot;) + 1).Length : 0).ToString
                    ();
        }

        private KendoDataSource GetData(DataSourceRequestExt request)
        {
            bool out_hasMorePages = false;
            string lastRecordSyncDateTimeAndPKeyValueConsolidate = string.Empty;
            
            /**
            //TO DO : USER STAKEHOLDER OVERRIDING AND VIEW STAKEHOLDER
            **/

            BrixFormModel model = null;
            string jsonParameters = string.Empty;

            ListPageControllerParameters formData =
                JsonConvert.DeserializeObject&lt;ListPageControllerParameters&gt;(
                    (request.additionalParameters ?? &quot;&quot;).ToString());

            formData.LastSyncedAt = string.IsNullOrEmpty(formData.LastSyncedAt) ? &quot;EMPTY&quot; : formData.LastSyncedAt;

            string requestParamsJSON = (request.requestParams ?? &quot;&quot;).ToString();
            Dictionary&lt;string, object&gt; requestParams = new Dictionary&lt;string, object&gt;();

            if (!string.IsNullOrEmpty(requestParamsJSON))
                requestParams = JsonConvert.DeserializeObject&lt;Dictionary&lt;string, object&gt;&gt;(requestParamsJSON);

            if (requestParams.ContainsKey(&quot;context&quot;))
            {
                model = new BrixFormModel(XMLForms.GetXMLFormModuleID(requestParams[&quot;context&quot;].ToString()),
                    requestParams[&quot;context&quot;] + &quot;.xml&quot;, XMLType.Form, null, null);

                string ViewName = APIHelper.GetViewName(model);

                formData.WhereCond = APIHelper.BuildWhereCondition(model, ViewName, requestParams, request.Filter);
                //formData.WhereCond.Replace(&quot;@^&quot;, &quot;=&quot;);
            }
            else
            {
                formData.WhereCond = &quot;&quot;;
            }
            UserDetail ud = CurrentUser.CurrentUserDetail;
            var features = new List&lt;string&gt;();
            features.Add(&quot;Visibility&quot;);
            var ds = new DataSet();
            DataSet newDs = new DataSet();
            if (ModuleManager.Instance.checkPermissions(model.form.AssociatedModuleID, model.form.ModuleID, ud,
                requestParams[&quot;pid&quot;].ToString2(), features))
            {
                Aurigo.AMP3.Core.AbstractModels.ListModel listModel =
                    Aurigo.AMP3.Core.AbstractModels.ListModel.GetXMLInstance(null, null, &quot;&quot;,
                        requestParams[&quot;context&quot;].ToString(), requestParams);


                string inputValueForStoredProc_lastSyncedAt = string.Empty;
                int inputValueForStoredProc_lastSyncedRecordPrimaryKeyValue = 0;

                Extract_LastSyncDateTime_And_LastPKey(formData.LastSyncedAt, out inputValueForStoredProc_lastSyncedAt, out inputValueForStoredProc_lastSyncedRecordPrimaryKeyValue);

                ds = XmlFormComponent.Instance.GetListPageRecords(formData.PrimaryKeyName, formData.TableName,
                    formData.WhereCond,
                    request.Skip, (request.Skip + request.PageSize), model.form.Name, requestParams[&quot;pid&quot;].ToInt32_2(),
                    ud.UID, ud.RID, inputValueForStoredProc_lastSyncedAt, inputValueForStoredProc_lastSyncedRecordPrimaryKeyValue, out out_hasMorePages);


                if (ds.Tables.Count &gt; 0)
                    lastRecordSyncDateTimeAndPKeyValueConsolidate = GetLastRecordSyncDateTime(ds.Tables[0], formData.PrimaryKeyName);

                newDs = FormatToTimezone(ds);
                try
                {
                    if (listModel != null)
                    {
                        if (!string.IsNullOrEmpty(model.form.ManagerDLL) &amp;&amp;
                            !string.IsNullOrEmpty(model.form.ListManagerClass))
                        {
                            JavaScriptSerializer js = new JavaScriptSerializer();
                            Dictionary&lt;string, object&gt; jsonParams = string.IsNullOrEmpty(requestParamsJSON)
                                ? new Dictionary&lt;string, object&gt;(StringComparer.OrdinalIgnoreCase)
                                : js.Deserialize&lt;Dictionary&lt;string, object&gt;&gt;(requestParamsJSON);
                            listModel.xmlModel.form.RequestParameters = new Dictionary&lt;string, object&gt;(jsonParams,
                                StringComparer.OrdinalIgnoreCase);

                            DataSet dsStyle =
                                ComponentHelper.Instance.ExecuteDataSet(
                                    &quot;select &#39;block&#39; as DataStyle,&#39;&#39; as NoRecMsgStyle&quot;);
                            DataSet dsAfterList = listModel.listManagerModel.AfterGetList(listModel, newDs, null);

                            if (dsAfterList != null)
                            {
                                dsStyle.Tables[0].TableName = &quot;dsStyle&quot;; //1
                                dsAfterList.Tables[0].TableName = &quot;dsAfterList&quot;; //3

                                if (!dsAfterList.Tables[&quot;dsAfterList&quot;].Columns.Contains(&quot;DataStyle&quot;))
                                    dsAfterList.Tables[&quot;dsAfterList&quot;].Columns.Add(&quot;DataStyle&quot;);

                                if (!dsAfterList.Tables[&quot;dsAfterList&quot;].Columns.Contains(&quot;NoRecMsgStyle&quot;))
                                    dsAfterList.Tables[&quot;dsAfterList&quot;].Columns.Add(&quot;NoRecMsgStyle&quot;);

                                for (var r = 0; r &lt; dsAfterList.Tables[&quot;dsAfterList&quot;].Rows.Count; r++)
                                {
                                    dsAfterList.Tables[&quot;dsAfterList&quot;].Rows[r][&quot;DataStyle&quot;] = &quot;block&quot;;
                                    dsAfterList.Tables[&quot;dsAfterList&quot;].Rows[r][&quot;NoRecMsgStyle&quot;] = &quot;&quot;;
                                }

                                dsAfterList.Tables.Add(&quot;columns&quot;);
                                dsAfterList.Tables[&quot;columns&quot;].Columns.Add(&quot;Column1&quot;);
                                DataRow row = dsAfterList.Tables[&quot;columns&quot;].NewRow();
                                row[&quot;Column1&quot;] = 1;
                                dsAfterList.Tables[&quot;columns&quot;].Rows.Add(row);

                                if (dsAfterList.Tables[&quot;dsAfterList&quot;].Rows.Count == 0)
                                {
                                    DataRow rowAfterList = dsAfterList.Tables[&quot;dsAfterList&quot;].NewRow();
                                    rowAfterList[&quot;DataStyle&quot;] = &quot;none&quot;;
                                    rowAfterList[&quot;NoRecMsgStyle&quot;] = &quot;No records to display&quot;;
                                    dsAfterList.Tables[&quot;dsAfterList&quot;].Rows.Add(rowAfterList);
                                    dsAfterList.Tables[&quot;columns&quot;].Rows[0][0] = &quot;1&quot;;
                                }

                                GetFormWorkflowDetails(listModel.xmlModel.form.RequestParameters, formData,
                                    ref dsAfterList);

                                return new KendoDataSource()
                                {
                                    Data = dsAfterList.Tables[&quot;dsAfterList&quot;].GetKendoDataSource(),
                                    Total = dsAfterList.Tables[&quot;columns&quot;].Rows[0][0].ToInt32_2(),
                                    HasMorePage = out_hasMorePages,
                                    LastRecordSyncDateTime = lastRecordSyncDateTimeAndPKeyValueConsolidate
                                };
                            }
                        }
                    }
                }
                catch (Exception)
                {
                }
            }

            if (newDs.Tables.Count != 0 &amp;&amp; newDs.Tables[0].Rows.Count == 0)
            {
                DataRow row = newDs.Tables[0].NewRow();
                row[&quot;DataStyle&quot;] = &quot;none&quot;;
                row[&quot;NoRecMsgStyle&quot;] = &quot;No records to display&quot;;
                newDs.Tables[0].Rows.Add(row);
                if (newDs.Tables.Count &gt; 1) newDs.Tables[1].Rows[0][0] = &quot;1&quot;;
            }

            GetFormWorkflowDetails(new Dictionary&lt;string, object&gt;(requestParams, StringComparer.OrdinalIgnoreCase),
                formData, ref newDs);


            return new KendoDataSource()
            {
                Data = newDs.Tables[0].GetKendoDataSource(),
                Total = (newDs.Tables.Count &gt; 1) ? newDs.Tables[1].Rows[0][0].ToInt32_2() : 0,
                HasMorePage = out_hasMorePages,
                LastRecordSyncDateTime = lastRecordSyncDateTimeAndPKeyValueConsolidate
            };
        }

        public static string GetLastRecordSyncDateTime(DataTable dt, string primaryKeyName)
        {
            if (dt == null || dt.Rows.Count == 0 || !dt.Columns.Contains(&quot;AUR_ModifiedOn&quot;))
            {
                return string.Empty;
            }

            var records = dt.Rows.Cast&lt;DataRow&gt;().Where(t =&gt; t[&quot;AUR_ModifiedOn&quot;] != DBNull.Value &amp;&amp; ((DateTime?)t[&quot;AUR_ModifiedOn&quot;] != null))
                .Select(t =&gt; new
                {
                    AUR_ModifiedOn = (DateTime)t[&quot;AUR_ModifiedOn&quot;],
                    PrimaryKeyValue = t[primaryKeyName].ToInt32_2()
                }).ToList();
            
            if (!records.Any())
                return string.Empty;
            else
            {
                int maxPrimaryKey = records.First().PrimaryKeyValue;
                DateTime maxAUR_ModifiedOn = records.First().AUR_ModifiedOn;

                for (int i = 1; i &lt; records.Count(); i++)
                {
                    var curItem = records[i];
                    if (curItem.AUR_ModifiedOn &gt; maxAUR_ModifiedOn || (curItem.AUR_ModifiedOn == maxAUR_ModifiedOn &amp;&amp; curItem.PrimaryKeyValue &gt; maxPrimaryKey))
                    {
                        maxPrimaryKey = curItem.PrimaryKeyValue;
                        maxAUR_ModifiedOn = curItem.AUR_ModifiedOn;
                    }
                }

                return maxAUR_ModifiedOn.ToDateTimeString_InvariantCulture() + CONST_SEPARATOR_AUR_ModifiedOn_LastPKey + maxPrimaryKey;
            }
        }

        private void GetFormWorkflowDetails(Dictionary&lt;string, object&gt; RequestParameters,
            ListPageControllerParameters formData, ref DataSet ds)
        {
            DataTable dt = new DataTable();
            DataSet dsViewRoles = new DataSet();
            UserDetail ud = CurrentUser.CurrentUserDetail;
            if (ds.Tables.Count != 0)
            {
                for (var dr = 0; dr &lt; ds.Tables[0].Rows.Count; dr++)
                {
                    string sGuid =
                        BrixWorkflowManager.Instance.IsWorkflowAssociated(RequestParameters[&quot;context&quot;].ToString(),
                            ds.Tables[0].Rows[dr][formData.PrimaryKeyName].ToString());

                    //adding isWorkflowAssociated flag
                    if (dr == 0 &amp;&amp; !ds.Tables[0].Columns.Contains(&quot;isWorkflowAssociated&quot;))
                        ds.Tables[0].Columns.Add(&quot;isWorkflowAssociated&quot;);

                    if (!string.IsNullOrEmpty(sGuid)) //there is a workflow associated with this record
                        ds.Tables[0].Rows[dr][&quot;isWorkflowAssociated&quot;] = true;
                    else
                        ds.Tables[0].Rows[dr][&quot;isWorkflowAssociated&quot;] = false;


                    if (!string.IsNullOrEmpty(sGuid)) //there is a workflow associated with this record
                    {
                        Guid newGuid = Guid.Empty;

                        //Adding Workflow Mapping Details
                        dt =
                            BrixWorkflowManager.Instance.GetWorkflowMappingDetails(
                                ds.Tables[0].Rows[dr][formData.PrimaryKeyName].ToString(),
                                RequestParameters[&quot;context&quot;].ToString());
                        dsViewRoles = WFRuntimeHandlerDB.GetUserStakeHolderMappingDetails(
                                ds.Tables[0].Rows[dr][formData.PrimaryKeyName].ToString(),
                                RequestParameters[&quot;context&quot;].ToString());


                        //Adding columns for first rows
                        foreach (DataColumn wfDc in dt.Columns)
                        {
                            if (!ds.Tables[0].Columns.Contains(&quot;wfd_&quot; + wfDc.ColumnName))
                            {
                                ds.Tables[0].Columns.Add(&quot;wfd_&quot; + wfDc.ColumnName);
                            }
                        }
                        DataColumn workflowUserColumn = new DataColumn(&quot;WF_PendingOnUser&quot;, System.Type.GetType(&quot;System.String&quot;));
                        workflowUserColumn.Caption = &quot;Pending On User(s)&quot;;
                        if (!ds.Tables[0].Columns.Contains(&quot;WF_PendingOnUser&quot;))
                            ds.Tables[0].Columns.Add(workflowUserColumn);

                        //adding row with matching wf
                        for (var wfDr = 0; wfDr &lt; dt.Rows.Count; wfDr++)
                        {
                            foreach (DataColumn wfDc in dt.Columns)
                            {
                                try
                                {
                                    if (
                                        ds.Tables[0].Rows[dr][formData.PrimaryKeyName].ToString()
                                            .Equals(dt.Rows[wfDr][&quot;FormInstanceID&quot;].ToString()))
                                    {
                                        ds.Tables[0].Rows[dr][&quot;wfd_&quot; + wfDc.ColumnName] = dt.Rows[wfDr][wfDc.ColumnName];
                                    }
                                }
                                catch (Exception)
                                {
                                    // log issues 
                                }
                            }
                        }

                        for (var wfDr = 0; wfDr &lt; dt.Rows.Count; wfDr++)
                        {
                            if (
                                        ds.Tables[0].Rows[dr][formData.PrimaryKeyName].ToString()
                                            .Equals(dt.Rows[wfDr][&quot;FormInstanceID&quot;].ToString()))
                            {
                                ds.Tables[0].Rows[dr][&quot;WF_PendingOnUser&quot;] = (bool)dt.Rows[wfDr][&quot;IsCompleted&quot;] ? &quot;None&quot;
                        : GetWorkflowUsers(dsViewRoles, RequestParameters[&quot;pid&quot;].ToInt32_2(), dt.Rows[wfDr][&quot;FormInstanceID&quot;].ToInt32_2(),
                            dt.Rows[wfDr][&quot;CurrentRole&quot;].ToString());
                            }
                        }
                        //ds.Tables[0].Rows[0][&quot;WF_PendingOnUser&quot;] = bIsCompleted : GetWorkflowUsers(dsViewRoles, pid, dr[keyColumn].ToInt32_2(),
                        //    statusDetails[0][&quot;CurrentRole&quot;].ToString());

                        //Adding Workflow History
                        DataSet wfhDS = BrixWorkflowManager.Instance.GetWorkflowHistory(sGuid);

                        DataSet newData = new DataSet();
                        if (wfhDS != null &amp;&amp; wfhDS.Tables[0].Rows.Count != 0)
                        {
                            DataTable dtNew = wfhDS.Tables[0];
                            DataTable Dtnew = dtNew.Clone();
                            if (!Dtnew.Columns.Contains(&quot;Action User&quot;)) Dtnew.Columns.Add(&quot;Action User&quot;);
                            if (!Dtnew.Columns.Contains(&quot;Action Date&quot;)) Dtnew.Columns.Add(&quot;Action Date&quot;);
                            if (!Dtnew.Columns.Contains(&quot;Notes&quot;)) Dtnew.Columns.Add(&quot;Notes&quot;);
                            if (!Dtnew.Columns.Contains(&quot;Due Date Override&quot;)) Dtnew.Columns.Add(&quot;Due Date Override&quot;);
                            int stageRowIndex = 0;
                            for (int i = 0; i &lt; dtNew.Rows.Count; i++)
                            {
                                string staginit = dtNew.Rows[i][&quot;Action&quot;].ToString2();
                                if (staginit == &quot;StageInitialized&quot;)
                                {
                                    stageRowIndex = i;
                                }
                                if (staginit != &quot;StageInitialized&quot; ||
                                    (staginit == &quot;StageInitialized&quot; &amp;&amp; (i == dtNew.Rows.Count - 1)))
                                {
                                    DataRow drnew = Dtnew.NewRow();
                                    drnew[&quot;ID&quot;] = dtNew.Rows[i][&quot;ID&quot;];
                                    drnew[&quot;Status&quot;] = dtNew.Rows[i][&quot;Status&quot;];
                                    drnew[&quot;Pending On&quot;] = dtNew.Rows[i][&quot;Pending On&quot;];
                                    drnew[&quot;Date&quot;] = dtNew.Rows[stageRowIndex][&quot;Date&quot;].ToMWDateTime();
                                    drnew[&quot;User&quot;] = dtNew.Rows[stageRowIndex][&quot;User&quot;];
                                    if (staginit != &quot;StageInitialized&quot;)
                                    {
                                        drnew[&quot;Action&quot;] = dtNew.Rows[i][&quot;Action&quot;];
                                        drnew[&quot;Action User&quot;] = dtNew.Rows[i][&quot;Action User&quot;];
                                        //Action date must not be set if it is the last stage (ie must not be the only state also) Action also must exists
                                        if (!(dtNew.Rows.Count &gt; 1 &amp;&amp; i == dtNew.Rows.Count - 1 &amp;&amp; string.IsNullOrWhiteSpace(drnew[&quot;Action&quot;].ToString())))
                                            drnew[&quot;Action Date&quot;] = dtNew.Rows[i][&quot;Date&quot;].ToMWDateTime();

                                        drnew[&quot;Notes&quot;] = dtNew.Rows[i][&quot;Action Notes&quot;];
                                        drnew[&quot;Due Date Override&quot;] = dtNew.Rows[i][&quot;Due Date Override&quot;];
                                    }
                                    Dtnew.Rows.Add(drnew);
                                }
                            }
                            newData.Tables.Add(Dtnew);
                        }
                        var wfHistoryDetails = &quot;&quot;;
                        if (newData.Tables.Count != 0)
                        {
                            DataSet newDs = (newData);

                            DataTable wfhDT = newDs.Tables[0];

                            //Remove spaces from column name
                            DataTable rsDT = new DataTable();
                            rsDT.TableName = &quot;RemoveSpaceDT&quot;;

                            foreach (DataColumn wfhdc in wfhDT.Columns)
                            {
                                wfhdc.ColumnName = wfhdc.ColumnName.Replace(&quot; &quot;, String.Empty);
                                rsDT.Columns.Add(wfhdc.ColumnName);
                            }

                            foreach (DataRow wfhdr in wfhDT.Rows)
                            {
                                rsDT.Rows.Add(wfhdr.ItemArray);
                            }

                            wfHistoryDetails = JsonConvert.SerializeObject(rsDT);
                        }

                        if (!ds.Tables[0].Columns.Contains(&quot;wfHistoryDetails&quot;))
                            ds.Tables[0].Columns.Add(&quot;wfHistoryDetails&quot;);

                        ds.Tables[0].Rows[dr][&quot;wfHistoryDetails&quot;] = wfHistoryDetails;

                        //Adding Workflow Actions
                        List&lt;Guid&gt; lstWfInstances = null;
                        DataRow[] drs = null;
                        Dictionary&lt;string, bool?&gt; dicRolesToPlay = null;
                        bool canSave;
                        List&lt;WorkflowActions&gt; actions = GetWorkflowButtons(RequestParameters[&quot;context&quot;].ToString(),
                            ds.Tables[0].Rows[dr][formData.PrimaryKeyName].ToString(),
                            RequestParameters[&quot;pid&quot;].ToString(), RequestParameters[&quot;parentid&quot;].ToString(),
                            out lstWfInstances, out drs, out dicRolesToPlay, out canSave);

                        bool bHasRoleToPlay = false;
                        foreach (string key in dicRolesToPlay.Keys)
                            if (dicRolesToPlay[key] == true)
                            {
                                bHasRoleToPlay = true;
                                break;
                            }

                        bool bIsWorkflowAssociatedatFormLevel = true;
                        if (bIsWorkflowAssociatedatFormLevel)
                        {
                            var dicHasRoleToPlay = new Dictionary&lt;string, bool?&gt;();
                            DataTable wfdt =
                                BrixWorkflowManager.Instance.GetWorkflowMappingDetails(
                                    ds.Tables[0].Rows[dr][formData.PrimaryKeyName].ToString(),
                                    RequestParameters[&quot;context&quot;].ToString());
                            List&lt;string&gt; stakeHolders = new List&lt;string&gt;();
                            if (wfdt.Rows.Count &gt; 0)
                                for (int i = 0; i &lt; wfdt.Rows.Count; i++)
                                {
                                    bool bIsComplete = DBNull.Value == wfdt.Rows[i][&quot;IsCompleted&quot;]
                                        ? false
                                        : wfdt.Rows[i][&quot;IsCompleted&quot;].ToString() == &quot;True&quot;;
                                    if (bIsComplete) continue;
                                    string[] roles = DBNull.Value == wfdt.Rows[i][&quot;CurrentRole&quot;]
                                        ? null
                                        : wfdt.Rows[i][&quot;CurrentRole&quot;].ToString().Split(&#39;,&#39;);
                                    if (null == roles) continue;
                                    stakeHolders.AddRange(roles);
                                }

                            UserDetail sCurrentUser = CurrentUser.CurrentUserDetail;
                            Dictionary&lt;int, string&gt; userRoles = new Dictionary&lt;int, string&gt;();
                            int pid = (string.IsNullOrEmpty(RequestParameters[&quot;pid&quot;].ToString())
                                ? 0
                                : RequestParameters[&quot;pid&quot;].ToInt32_2());
                            userRoles = UserManager.Instance.GetUserRolesBasedOnProjectId(sCurrentUser.UID, pid,
                                sCurrentUser.RID, sCurrentUser.RoleName);

                            foreach (string stakeHolderRole in stakeHolders)
                            {
                                int stakeHolderRoleID = UserManager.Instance.GetUsersRoleId(stakeHolderRole);
                                if (userRoles.ContainsKey(stakeHolderRoleID))
                                {
                                    bHasRoleToPlay = true;

                                    //if current user role matches the stakeholders roles, then proceed further
                                    string workflowInstanceGuid = dt.Rows[0][&quot;WorkflowInstanceGuid&quot;].ToString();

                                    bHasRoleToPlay =
                                        !WFRuntimeHandlerDB.HasCurrentUserPerformedWorkflowAction(workflowInstanceGuid,
                                            userRoles, sCurrentUser.UID);
                                    break;
                                }                                
                            }
                        }

                        List&lt;WorkflowActions&gt; result = bHasRoleToPlay ? actions : new List&lt;WorkflowActions&gt;();

                        if (!ds.Tables[0].Columns.Contains(&quot;wfActions&quot;))
                            ds.Tables[0].Columns.Add(&quot;wfActions&quot;);
                        ds.Tables[0].Rows[dr][&quot;wfActions&quot;] = JsonConvert.SerializeObject(result);
                    }
                }
            }
        }
        private static string GetWorkflowUsers(DataSet stakeHolders, int pid, int formID, string wfRoles)
        {
            Dictionary&lt;string, List&lt;string&gt;&gt; wfUsers = new Dictionary&lt;string, List&lt;string&gt;&gt;();
            //StakeHolders Table 0 - All workflow users, Table 1 - All workflow users who has perform action
            DataRow[] wfStakeHolders = stakeHolders.Tables[0].Select(&quot;FormInstanceID = &#39;&quot; + formID + &quot;&#39;&quot;);
            if (wfStakeHolders.Length &gt; 0)
            {
                foreach (DataRow drUsers in wfStakeHolders)
                {
                    string roleName = drUsers[&quot;RoleName&quot;].ToString().ToLower();
                    if (!wfUsers.Keys.Contains(roleName)) wfUsers.Add(roleName, new List&lt;string&gt;());

                    DataRow[] userActionPerformed = stakeHolders.Tables[1].Select(&quot;FormInstanceID = &#39;&quot; + formID
                                                                                  + &quot;&#39; AND RoleId = &quot; +
                                                                                  drUsers[&quot;RoleId&quot;] + &quot; AND UserId = &quot; +
                                                                                  drUsers[&quot;UserId&quot;]);
                    if (userActionPerformed.Length == 0)
                    {
                        wfUsers[roleName].Add(drUsers[&quot;FirstName&quot;].ToString() + &quot; &quot; + drUsers[&quot;LastName&quot;].ToString());
                    }
                }
            }

            List&lt;string&gt; roles =
                wfRoles.Split(&#39;,&#39;).Where(p =&gt; !wfUsers.Keys.Any(p2 =&gt; p2.ToLower() == p.ToLower())).ToList();
            if (roles.Count &gt; 0)
            {
                //All project users for a role for which user overriding is not done
                DataTable dtUsers = UserManager.Instance.GetProjectUserDetailsByRoleNames(pid,
                    string.Join(&quot;,&quot;, roles.ToArray()));
                foreach (DataRow drUsers in dtUsers.Rows)
                {
                    string roleName = drUsers[&quot;RoleName&quot;].ToString().ToLower();
                    if (!wfUsers.Keys.Contains(roleName)) wfUsers.Add(roleName, new List&lt;string&gt;());

                    DataRow[] userActionPerformed = stakeHolders.Tables[1].Select(&quot;FormInstanceID = &#39;&quot; + formID
                                                                                  + &quot;&#39; AND RoleId = &quot; +
                                                                                  drUsers[&quot;RoleId&quot;] + &quot; AND UserId = &quot; +
                                                                                  drUsers[&quot;UserId&quot;]);
                    if (userActionPerformed.Length == 0)
                    {
                        wfUsers[roleName].Add(drUsers[&quot;FirstName&quot;].ToString() + &quot; &quot; + drUsers[&quot;LastName&quot;].ToString());
                    }
                }
            }

            return string.Join(&quot;,&quot;, wfUsers.Values.SelectMany(i =&gt; i).Distinct().ToArray());
        }

        private DataSet FormatToTimezone(DataSet ds)
        {
            DataSet dsnew = new DataSet();

            for (int i = 0; i &lt; ds.Tables.Count; i++)
            {
                if (i == 0)
                {
                    dsnew.Tables.Add(ds.Tables[0].ToMWDateTime().Copy());
                }
                else
                {
                    dsnew.Tables.Add(ds.Tables[i].Copy());
                }
            }
            return dsnew;
        }

        private List&lt;WorkflowActions&gt; GetWorkflowButtons(string moduleid, string formInstanceId, string pid,
            string parentId, out List&lt;Guid&gt; lstWfInstances, out DataRow[] drs,
            out Dictionary&lt;string, bool?&gt; dicHasRoleToPlay, out bool canAddSaveButton)
        {
            dicHasRoleToPlay = new Dictionary&lt;string, bool?&gt;();
            drs = null;
            canAddSaveButton = false;
            lstWfInstances = new List&lt;Guid&gt;();
            List&lt;WorkflowActions&gt; dicActions = new List&lt;WorkflowActions&gt;();
            if (!BrixWorkflowManager.Instance.IsWorkflowAssociated(moduleid, pid, parentId)) return dicActions;
            DataTable mappingDetails = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(formInstanceId, moduleid);
            drs = mappingDetails.Select(&quot;IsCompleted=False&quot;);
            if (null == drs || drs.Count() &lt; 1) return new List&lt;WorkflowActions&gt;();

            foreach (DataRow dr in drs)
            {
                string sCurrentUser = CurrentUser.CurrentUserDetail.UserID;
                Guid actualGuid = Guid.Empty;
                int daysToComplete = 0;
                string actionsMustBePerformedBy = null;
                string stateName = string.Empty;
                Guid gd = new Guid((string)dr[&quot;WorkflowInstanceGuid&quot;]);
                List&lt;IAction&gt; actions = BrixWorkflowManager.Instance.GetCurrentWorkflowActionButtons(gd, ref actualGuid,
                       ref daysToComplete, ref actionsMustBePerformedBy, ref stateName);
                if (actualGuid == Guid.Empty) actualGuid = gd;
                if (null == actions) continue;

                //give opinion and route to are not required for mobile
                //bool bGiveOpinion = BrixWorkflowManager.Instance.IsRouted(out sRoutedTo, &quot;&quot;, &quot;&quot;, actualGuid.ToString()) &amp;&amp;
                //                    sRoutedTo.Equals(sCurrentUser, StringComparison.CurrentCultureIgnoreCase);
                //if (bGiveOpinion)
                //    dicActions.Add(new WorkflowActions { Guid = actualGuid.ToString(), ActionId = &quot;GiveOpinion&quot;, ActionName = &quot;GiveOpinion&quot; });

                bool bHasLocalRoleToPlay = false;
                string[] stakeHolders = null == actionsMustBePerformedBy
                    ? null
                    : actionsMustBePerformedBy.Split(&#39;,&#39;);
                Dictionary&lt;int, string&gt; userRoles = new Dictionary&lt;int, string&gt;();

                int iPid = string.IsNullOrEmpty(pid) ? 0 : pid.ToInt32_2();
                UserDetail objCurrentUser = CurrentUser.CurrentUserDetail;

                userRoles = UserManager.Instance.GetUserRolesBasedOnProjectId(objCurrentUser.UID, iPid,
                    objCurrentUser.RID, objCurrentUser.RoleName);

                if (null != stakeHolders)
                    foreach (string stakeHolderRole in stakeHolders)
                    {
                        if (string.IsNullOrEmpty(stakeHolderRole)) continue;
                        if (dicHasRoleToPlay.ContainsKey(stakeHolderRole.ToLower()))
                        {
                            if (dicHasRoleToPlay[stakeHolderRole.ToLower()] == true)
                            {
                                canAddSaveButton = bHasLocalRoleToPlay = true;
                            }
                            continue;
                        }
                        int stakeHolderRoleID = UserManager.Instance.GetUsersRoleId(stakeHolderRole);
                        bool bHasRoleToPlay = userRoles.ContainsKey(stakeHolderRoleID);
                        dicHasRoleToPlay.Add(stakeHolderRole.ToLower(), bHasRoleToPlay);
                        if (bHasRoleToPlay)
                        {
                            canAddSaveButton = bHasLocalRoleToPlay = true;
                        }
                    }
                if (!bHasLocalRoleToPlay) continue;

                //if (!bGiveOpinion)
                //dicActions.Add(new WorkflowActions { Guid = actualGuid.ToString(), ActionId = &quot;RouteTo&quot;, ActionName = &quot;RouteTo&quot; });

                foreach (IAction action in actions)
                {
                    dicActions.Add(new WorkflowActions
                    {
                        Guid = actualGuid.ToString(),
                        ActionId = action.InstanceId,
                        ActionName =
                            string.IsNullOrEmpty(action.ActionDisplayName)
                                ? action.ActionName
                                : action.ActionDisplayName
                    });
                }
                lstWfInstances.Add(actualGuid);
            }
            return dicActions;
        }

        public bool GetListPageTemplate(string context, out string result, string jsonParameters, int? userId = null,
            int? roleid = null)
        {
            result = string.Empty;

            BrixFormModel model = new BrixFormModel(XMLForms.GetXMLFormModuleID(context), context + &quot;.xml&quot;, XMLType.Form,
                null, null);
            if (model != null &amp;&amp; model.form != null)
            {
                if (userId == 0 &amp;&amp; roleid == 0)
                {
                    UserDetail ud = CurrentUser.CurrentUserDetail;
                    userId = ud.UID;
                    roleid = ud.RID;
                }
                List&lt;string&gt; permissions =
                    ModuleManager.Instance.GetPermissionByUserOrRole(
                        string.IsNullOrEmpty(model.form.AssociatedModuleID) ? context : model.form.AssociatedModuleID,
                        userId.ToInt32_2(), roleid.ToInt32_2(), 0);

                if (permissions == null || (!permissions.Contains(&quot;View&quot;) || !permissions.Contains(&quot;Visibility&quot;)))
                {
                    result = &quot;The user does not have permissions.&quot;;
                    return false;
                }

                string _fields = &quot;{&quot;;
                StringBuilder tempScript = getOnlineListTemplate(model, ref _fields);
                _fields += &quot;}&quot;;
                StringBuilder offTempScript = getOfflineListTemplate(model);

                string ViewName = &quot;&quot;;

                if (!string.IsNullOrEmpty(model.form.BaseTableName) &amp;&amp; !string.IsNullOrEmpty(model.form.TableName))
                    ViewName = model.form.TableName;
                else
                    ViewName = &quot;vw_&quot; + model.form.ActualTableNameInDatabase + &quot;_Auto&quot;;

                StringBuilder parameters = new StringBuilder();
                parameters.Append(&quot;{&quot;);
                parameters.AppendFormat(&quot;\&quot;ModuleID\&quot; : \&quot;{0}\&quot;,&quot;, model.form.Name);
                parameters.AppendFormat(&quot;\&quot;TableName\&quot; : \&quot;{0}\&quot;,&quot;, ViewName);
                parameters.AppendFormat(&quot;\&quot;PrimaryKeyName\&quot; : \&quot;{0}\&quot;,&quot;, model.form.PrimaryKeyName);
                parameters.AppendFormat(&quot;\&quot;WhereCond\&quot; : \&quot;{0}\&quot;&quot;, &quot;&quot;); //BuildWhereCondition(model, ViewName));
                parameters.Append(&quot;}&quot;);

                string _data = string.Format(&quot;{{\&quot;additionalParameters\&quot; : {0} }}&quot;, parameters);

                // This is a temp fix for DWR BYU , we are calling ListModel &quot;HandleMenuItem&quot; and hard coding eventstring as &quot;MobileNew&quot;
                string onNewButtonClick = &quot;&quot;;

                try
                {
                    Aurigo.AMP3.Core.AbstractModels.ListModel listModel =
                    Aurigo.AMP3.Core.AbstractModels.ListModel.GetXMLInstance(null, null, &quot;&quot;, context, null);
                    if (listModel != null)
                    {
                        if (jsonParameters != &quot;&quot;)
                        {
                            JavaScriptSerializer js = new JavaScriptSerializer();
                            Dictionary&lt;string, object&gt; jsonParams = string.IsNullOrEmpty(jsonParameters)
                                ? new Dictionary&lt;string, object&gt;(StringComparer.OrdinalIgnoreCase)
                                : js.Deserialize&lt;Dictionary&lt;string, object&gt;&gt;(jsonParameters);
                            listModel.xmlModel.form.RequestParameters = new Dictionary&lt;string, object&gt;(jsonParams,
                                StringComparer.OrdinalIgnoreCase);
                            if (listModel.listManagerModel != null &amp;&amp;
                                listModel.xmlModel.form.RequestParameters.ContainsKey(&quot;ParentID&quot;))
                            {
                                listModel.listManagerModel.HandleMenuItem(&quot;MobileNew&quot;, &quot;&quot;, listModel, new XmlFormArgs());
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    onNewButtonClick = ex.Message;
                }

                StringBuilder otherInfo = new StringBuilder();
                otherInfo.Append(&quot;{&quot;);
                otherInfo.AppendFormat(&quot;\&quot;PageTitle\&quot; : \&quot;{0}\&quot;,&quot;, model.form.ParseDynamicString(model.form.Header));
                otherInfo.AppendFormat(&quot;\&quot;DisplayNew\&quot; : {0}&quot;, permissions.Contains(&quot;Create&quot;).ToString().ToLower());
                otherInfo.Append(&quot;}&quot;);

                StringBuilder Actions = new StringBuilder();
                Actions.Append(&quot;{&quot;);
                if (onNewButtonClick != &quot;&quot;)
                {
                    Actions.Append(&quot;\&quot;Action\&quot; : \&quot;New\&quot;,&quot;);
                    Actions.AppendFormat(&quot;\&quot;Message\&quot; : \&quot;{0}\&quot;&quot;, onNewButtonClick);
                }
                Actions.Append(&quot;}&quot;);
                StringBuilder sb = new StringBuilder();
                sb.Append(&quot;{&quot;);
                //sb.AppendFormat(&quot;\&quot;pageSize\&quot; : \&quot;{0}\&quot;,&quot;, 30);
                sb.AppendFormat(&quot;\&quot;fields\&quot; : {0},&quot;, _fields);
                sb.AppendFormat(&quot;\&quot;offline\&quot; : {0},&quot;,
                    (string.IsNullOrEmpty(model.form.AllowOffline)) ? &quot;false&quot; : model.form.AllowOffline);
                sb.AppendFormat(&quot;\&quot;template\&quot; : \&quot;{0}\&quot;,&quot;, tempScript.ToString());
                sb.AppendFormat(&quot;\&quot;offTemplate\&quot; : \&quot;{0}\&quot;,&quot;, offTempScript.ToString());
                sb.AppendFormat(&quot;\&quot;data\&quot; :  {0},&quot;, _data);
                sb.AppendFormat(&quot;\&quot;instanceIdName\&quot; : \&quot;{0}\&quot;,&quot;, model.form.PrimaryKeyName);
                sb.AppendFormat(&quot;\&quot;otherInfo\&quot; : {0},&quot;, otherInfo.ToString());
                sb.AppendFormat(&quot;\&quot;Actions\&quot; : {0},&quot;, Actions.ToString());
                sb.AppendFormat(&quot;\&quot;ListScriptPath\&quot; : {0}&quot;, HandleCustomClientScript(model.form.ListScriptPath));
                sb.Append(&quot;}&quot;);

                result = sb.ToString();
                return true;
            }

            result = &quot;BAD REQUEST&quot;;
            return false;
        }

        private StringBuilder getOnlineListTemplate(BrixFormModel model, ref string _fields)
        {
            bool hasTemplate = model.form.ListPageTemplate != null &amp;&amp;
                               !string.IsNullOrEmpty(model.form.ListPageTemplate.Markup);
            List&lt;string&gt; listColumns = new List&lt;string&gt;();
            //string templateScript = &quot;&lt;script type=&#39;text/x-kendo-template&#39; id=&#39;listPageTemplate&#39;&gt;&quot;;
            string templateScript = &quot;&quot;;
            string templateFirstLine = &quot;&lt;div style=&#39;font-weight:bold&#39;&gt;&lt;span&gt;{0} : {1}&lt;/span&gt;&lt;/div&gt;&quot;;
            string template =
                &quot;&lt;span style=&#39;font-weight:normal&#39;&gt;&lt;div style=&#39;display:inline-block&#39;&gt;{0} : {1}&lt;/div&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&quot;;

            StringBuilder tempScript = new StringBuilder();

            if (!string.IsNullOrEmpty(model.form.ListColumns.Columns))
            {
                listColumns = new List&lt;string&gt;(model.form.ListColumns.Columns.Split(&#39;,&#39;).ToArray());
            }

            xControl pk = model.form.GetControl(model.form.PrimaryKeyName);
            if (pk != null)
            {
                tempScript.AppendFormat(
                    &quot;&lt;a style=&#39;display:#:DataStyle#&#39; onclick=&#39;app.listPageView.viewModel.listItemClicked(\\\&quot;{0}\\\&quot;);&#39;&gt;&quot;,
                    &quot;#: &quot; + model.form.PrimaryKeyName + &quot;#&quot;);
            }

            tempScript.Append(templateScript);

            List&lt;string&gt; columns = new List&lt;string&gt;();

            List&lt;string&gt; mobileListPageColumns = new List&lt;string&gt;();

            if (!string.IsNullOrEmpty(model.form.BaseTableName) &amp;&amp; !string.IsNullOrEmpty(model.form.TableName))
            {
                string query = &quot;select top 1 * from &quot; + model.form.TableName;
                DataSet ds = ComponentHelper.Instance.ExecuteDataSet(query);
                if (ds.Tables[0].Columns.Count != 0)
                    columns =
                        new List&lt;string&gt;(ds.Tables[0].Columns.OfType&lt;DataColumn&gt;().Select(x =&gt; x.ColumnName).ToList());
            }
            else
            {
                if (!string.IsNullOrEmpty(model.form.ListColumns.Columns))
                {
                    columns = new List&lt;string&gt;(model.form.ListColumns.Columns.Split(&#39;,&#39;).ToArray());
                }
            }
            int i = 0;

            if (listColumns != null)
                foreach (var col in columns)
                {
                    if (listColumns.Contains(col)) mobileListPageColumns.Add(col);
                }

            foreach (string column in mobileListPageColumns)
            {
                string colName = column;
                if (column.Contains(&quot; as &quot;))
                {
                    string[] parts = column.Split(new string[] { &quot; as &quot; }, StringSplitOptions.RemoveEmptyEntries);
                    if (parts.Length &gt; 0)
                    {
                        colName = parts[1].Replace(&quot;[&quot;, &quot;&quot;).Replace(&quot;]&quot;, &quot;&quot;);
                    }
                }
                xControl xc = model.form.GetControl(colName);

                _fields += string.Format(&quot;\&quot;{0}\&quot; : {{ \&quot;type\&quot; : \&quot;&quot; + GetType(xc) + &quot;\&quot;}},&quot;, colName);
                string caption = colName;

                if (xc != null)
                {
                    caption = string.IsNullOrEmpty(xc.Caption)
                        ? colName
                        : xc.ParseDynamicString(xc.Caption).Replace(&quot;:&quot;, &quot;&quot;);
                }
                if (!hasTemplate &amp;&amp; xc != null &amp;&amp; xc.Type != ControlType.Hidden)
                {
                    if (i == 0)
                    {
                        tempScript.AppendFormat(templateFirstLine, EscapeSpecialCharacters(caption),
                            (&quot;#: &quot; + GetFormattedColumn(xc) + &quot; #&quot;));
                    }
                    else
                    {
                        tempScript.AppendFormat(template, EscapeSpecialCharacters(caption),
                            (&quot;#: &quot; + GetFormattedColumn(xc) + &quot; #&quot;));
                    }
                }
                i++;
            }

            _fields = _fields.TrimEnd(&#39;,&#39;);

            if (hasTemplate)
            {
                if (model.form.ListPageTemplate.AllElements != null &amp;&amp;
                    model.form.ListPageTemplate.AllElements.Length &gt; 0)
                    //Escaping the double {{ so that it gets passed to the client
                    tempScript.Append(model.form.ListPageTemplate.Markup.Replace(&quot;{{&quot;, &quot;^(!&quot;).Replace(&quot;}}&quot;, &quot;^)!&quot;).
                        Replace(&quot;{&quot;, &quot;#:&quot;).Replace(&quot;}&quot;, &quot;#&quot;).
                        Replace(&quot;^(!&quot;, &quot;{&quot;).Replace(&quot;^)!&quot;, &quot;}&quot;));
            }

            tempScript.Append(&quot;&lt;/a&gt;&quot;);
            tempScript.Append(&quot;#:NoRecMsgStyle#&quot;);

            //tempScript.Append(&quot;&lt;/script&gt;&quot;);

            //replace { with #: and } with #. 
            //kendo recognizes them as variables
            return tempScript;
        }

        private StringBuilder getOfflineListTemplate(BrixFormModel model)
        {
            bool hasTemplate = model.form.OfflineListPageTemplate != null &amp;&amp;
                               !string.IsNullOrEmpty(model.form.OfflineListPageTemplate.Markup);

            string templateFirstLine = &quot;&lt;div style=&#39;font-weight:bold&#39;&gt;&lt;span&gt;{0} : {1}&lt;/span&gt;&lt;/div&gt;&quot;;
            string template =
                &quot;&lt;span style=&#39;font-weight:normal&#39;&gt;&lt;div style=&#39;display:inline-block;font-weight:bold&#39;&gt;{0} : {1}&lt;/div&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&quot;;

            StringBuilder tempScript = new StringBuilder();

            //OfflineData primary key column
            tempScript.AppendFormat(
                &quot;&lt;a style=&#39;display:#:DataStyle#&#39; onclick=&#39;app.listPageView.viewModel.offlineListItemClicked(\\\&quot;{0}\\\&quot;, \\\&quot;{1}\\\&quot;);&#39;&gt;&lt;table width=&#39;95%&#39;&gt;&lt;tr&gt;&lt;td&gt;&quot;,
                &quot;#:_ID#&quot;, &quot;#:_InstanceId#&quot;);

            if (hasTemplate)
            {
                if (model.form.OfflineListPageTemplate.AllElements != null &amp;&amp;
                    model.form.OfflineListPageTemplate.AllElements.Length &gt; 0)
                    //Escaping the double {{ so that it gets passed to the client
                    tempScript.Append(model.form.OfflineListPageTemplate.Markup.Replace(&quot;{{&quot;, &quot;^(!&quot;)
                        .Replace(&quot;}}&quot;, &quot;^)!&quot;)
                        .
                        Replace(&quot;{&quot;, &quot;#:&quot;).Replace(&quot;}&quot;, &quot;#&quot;).
                        Replace(&quot;^(!&quot;, &quot;{&quot;).Replace(&quot;^)!&quot;, &quot;}&quot;));
            }
            else
            {
                int i = 0;

                model.form.ProcessAllControlsDeeply(xc =&gt;
                {
                    if (i == 4) return;
                    if (xc != null &amp;&amp; xc is xControl &amp;&amp; xc.IsListVisible &amp;&amp; xc.Type != ControlType.Set &amp;&amp; xc.Type != ControlType.Hidden)
                    {
                        string caption = string.IsNullOrEmpty(xc.Caption)
                            ? xc.Name
                            : xc.ParseDynamicString(xc.Caption).Replace(&quot;:&quot;, &quot;&quot;);

                        if (!hasTemplate)
                        {
                            if (i == 0)
                            {
                                tempScript.AppendFormat(templateFirstLine, EscapeSpecialCharacters(caption),
                                    (&quot;#: &quot; + GetFormattedColumn(xc) + &quot; #&quot;));
                            }
                            else
                            {
                                tempScript.AppendFormat(template, EscapeSpecialCharacters(caption),
                                    (&quot;#: &quot; + GetFormattedColumn(xc) + &quot; #&quot;));
                            }
                        }
                        i++;
                    }
                });
            }


            tempScript.Append(&quot;&lt;/td&gt;&quot;);

            //Add error icon
            tempScript.Append(
                &quot;&lt;td style=&#39;padding-right: 90px !important;&#39;&gt;&lt;div style=&#39;display:#:_ErrorStyle#&#39; onclick=&#39;app.listPageView.viewModel.showErrors(this, \\\&quot;#:_ErrorMsg#\\\&quot;);&#39;&gt;&lt;i class=&#39;icon-exclamation-sign&#39; /&gt;&lt;/div&gt;&lt;/td&gt;&quot;);

            tempScript.Append(&quot;&lt;/tr&gt;&lt;/table&gt;&lt;/a&gt;&quot;);
            tempScript.Append(&quot;#:NoRecMsgStyle#&quot;);

            return tempScript;
        }


        private string HandleCustomClientScript(string path)
        {
            if (!string.IsNullOrEmpty(path))
            {
                var PATH = &quot;&quot;;
                if (HttpContext.Current != null)
                    PATH = HttpContext.Current.Server.MapPath(path);
                else
                    PATH = System.Web.Hosting.HostingEnvironment.MapPath(path);
                if (!string.IsNullOrEmpty(PATH))
                {
                    string contents = File.ReadAllText(PATH);
                    JsonObject o = new JsonObject();
                    o.Add(&quot;ListPageScript&quot;, contents);
                    return o.ToString();
                }
            }
            return &quot;{}&quot;;
        }

        private HttpResponseMessage GetActualListData(DataSourceRequestExt request)
        {
            DateTime Start = DateTime.UtcNow;
            KendoDataSource kendoDS = GetData(request);
            if (kendoDS != null)
            {
                JObject jObject = JObject.FromObject(kendoDS);
                var response = Request.CreateResponse&lt;JObject&gt;(HttpStatusCode.OK, jObject);
                response.Headers.Add(&quot;Request-Start&quot;, Start.ToDateTimeString_InvariantCulture());//TODO:Asheesh_Check_TimeZone: Thread culture will get used here
                return response;
            }
            else
                return null;
        }

        private DataSourceRequestExt GetDataSourceRequestExt(string requestMessage)
        {
            return JsonConvert.DeserializeObject&lt;DataSourceRequestExt&gt;(requestMessage);
        }
        #endregion
    }

    public class ListPageControllerParameters
    {
        public string ModuleID { get; set; }
        public string TableName { get; set; }
        public string PrimaryKeyName { get; set; }
        public string WhereCond { get; set; }
        public string LastSyncedAt { get; set; }
    }

    public class APIHelper
    {
        public static string BuildWhereCondition(BrixFormModel model, string ViewName,
            Dictionary&lt;string, object&gt; requestParams, KendoFilter kendoFilter)
        {
            List&lt;xControl&gt; Keys = model.form.GetForeignKeyControls();
            string key;

            if (Keys.Count &lt; 1)
                return string.Empty;

            String Filter = &quot; where &quot;;
            Keys.ForEach(xc =&gt;
            {
                if (xc.Value.ToLower().Contains(&quot;_request&quot;))
                {
                    string reqParam = xc.Value.Substring(xc.Value.IndexOf(&quot;:&quot;) + 1,
                        xc.Value.Length - xc.Value.IndexOf(&quot;:&quot;) - 2);
                    if (!string.IsNullOrEmpty(key = requestParams.Keys.Find(x =&gt; x.ToLower() == reqParam.ToLower())))
                        Filter += ViewName + &quot;.[&quot; + xc.Name + &quot;] = &#39;&quot; + requestParams[key] + &quot;&#39; AND &quot;;
                }
                else
                {
                    string xcValue = xc.EvaluateControlValue();
                    // if filter key value is specified in the xml ( this is for thr product template xml&#39;s)
                    if (!string.IsNullOrEmpty(xcValue))
                        Filter += ViewName + &quot;.[&quot; + xc.Name + &quot;] = &#39;&quot; + xc.EvaluateControlValue() + &quot;&#39; AND &quot;;
                }
            });

            Filter = Filter.TrimEnd(&quot;AND &quot;.ToCharArray());

            string filterExp = string.Empty;
            if (kendoFilter != null &amp;&amp; kendoFilter.Filters.Count() &gt; 0)
            {
                List&lt;string&gt; columns = GetSearchColumns(model);

                foreach (string column in columns)
                {
                    if (!string.IsNullOrEmpty(filterExp)) filterExp += &quot; OR &quot;;

                    kendoFilter.Filters.ForEach(f =&gt; f.Field = ViewName + &quot;.[&quot; + column + &quot;]&quot;);
                    filterExp += kendoFilter.ToExpression(kendoFilter.All());
                }

                if (!string.IsNullOrEmpty(filterExp))
                {
                    filterExp = string.Format(&quot; ({0}) &quot;, filterExp);
                    Filter += Filter.Trim().ToLower() == &quot;where&quot; ? filterExp : (&quot; AND &quot; + filterExp);
                }
            }

            return (Filter);
        }

        public static string GetViewName(BrixFormModel model)
        {
            string ViewName = &quot;&quot;;

            if (!string.IsNullOrEmpty(model.form.BaseTableName) &amp;&amp; !string.IsNullOrEmpty(model.form.TableName))
                ViewName = model.form.TableName;
            else
                ViewName = &quot;vw_&quot; + model.form.ActualTableNameInDatabase + &quot;_Auto&quot;;
            return ViewName;
        }

        private static List&lt;string&gt; GetSearchColumns(BrixFormModel model)
        {
            List&lt;string&gt; columns = new List&lt;string&gt;();
            List&lt;string&gt; searchcolumns = new List&lt;string&gt;();
            if (!string.IsNullOrEmpty(model.form.BaseTableName) &amp;&amp; !string.IsNullOrEmpty(model.form.TableName))
            {
                string query = &quot;select top 1 * from &quot; + model.form.TableName;
                DataSet ds = ComponentHelper.Instance.ExecuteDataSet(query);
                if (ds.Tables[0].Columns.Count != 0)
                    columns =
                        new List&lt;string&gt;(ds.Tables[0].Columns.OfType&lt;DataColumn&gt;().Select(x =&gt; x.ColumnName).ToList());
            }
            else if (string.IsNullOrEmpty(model.form.ListColumns.SearchColumns))
            {
                if (model.form.ListColumns.Type.ToLower() == &quot;visible&quot;)
                {
                    foreach (string column in model.form.ListColumns.Columns.Split(&#39;,&#39;).ToArray())
                    {
                        xControl ctrl = model.form.GetControl(column);
                        if (ctrl != null)
                        {
                            columns.Add(column);
                        }
                    }
                }
                else
                {
                    xControl ctrl = GetFirstListVisibleTextboxColumn(model);
                    if (ctrl != null)
                    {
                        columns.Add(ctrl.Name);
                    }
                }
            }
            else
            {
                columns = new List&lt;string&gt;(model.form.ListColumns.SearchColumns.Split(&#39;,&#39;).ToArray());
            }

            foreach (var col in columns)
            {
                xControl xc = model.form.GetControl(col);
                if (xc != null) searchcolumns.Add(col);
                ;
            }
            return searchcolumns;
        }

        private static xControl GetFirstListVisibleTextboxColumn(BrixFormModel model)
        {
            // this returns the first match, although controlname should be unique
            xControl retctrl = null;
            model.form.ProcessAllControlsDeeply(xc =&gt;
            {
                if (retctrl != null) return;
                if (xc.IsListVisible &amp;&amp; xc.Type == ControlType.TextBox) retctrl = xc;
            });
            return (retctrl);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[37,9,37,10,1],[38,13,38,79,1],[39,13,39,14,1],[40,17,40,44,1],[41,17,41,26,1],[42,13,42,14,1],[44,13,44,14,0],[45,17,45,84,0],[46,17,46,18,0],[48,21,48,138,0],[49,21,49,40,0],[50,25,50,51,0],[52,25,52,57,0],[54,21,54,40,0],[55,25,55,56,0],[57,25,57,34,0],[58,17,58,18,0],[60,17,60,18,0],[61,21,61,53,0],[62,21,62,30,0],[63,17,63,18,0],[64,13,64,14,0],[65,9,65,10,1],[70,43,70,47,0],[70,48,70,52,0],[75,9,75,10,0],[76,13,76,46,0],[77,13,77,42,0],[78,13,78,74,0],[79,13,79,14,0],[80,17,80,90,0],[81,17,81,98,0],[82,17,82,33,0],[84,13,84,96,0],[85,13,85,96,0],[86,13,86,31,0],[87,9,87,10,0],[91,9,91,10,0],[92,13,92,124,0],[93,13,93,47,0],[94,9,94,10,0],[98,9,98,10,0],[99,13,99,84,0],[100,13,100,47,0],[101,9,101,10,0],[106,9,106,10,0],[107,13,107,36,0],[108,13,108,28,0],[109,17,109,86,0],[110,21,110,37,0],[111,13,111,25,0],[112,9,112,10,0],[115,9,115,10,0],[116,13,116,28,0],[117,13,117,14,0],[118,17,118,41,0],[120,17,120,49,0],[125,21,126,34,0],[127,17,127,52,0],[128,21,129,35,0],[131,17,131,31,0],[133,13,133,23,0],[134,9,134,10,0],[137,9,137,10,0],[138,13,138,47,0],[139,9,139,10,0],[142,9,142,10,0],[143,13,145,24,0],[146,9,146,10,0],[149,9,149,10,0],[150,13,150,43,0],[151,13,151,81,0],[157,13,157,40,0],[158,13,158,50,0],[160,13,162,70,0],[164,13,164,115,0],[166,13,166,81,0],[167,13,167,89,0],[169,13,169,58,0],[170,17,170,110,0],[172,13,172,54,0],[173,13,173,14,0],[174,17,175,82,0],[177,17,177,64,0],[179,17,179,116,0],[181,13,181,14,0],[183,13,183,14,0],[184,17,184,41,0],[185,13,185,14,0],[186,13,186,59,0],[187,13,187,47,0],[188,13,188,40,0],[189,13,189,36,0],[190,13,190,43,0],[191,13,192,61,0],[193,13,193,14,0],[194,17,196,77,0],[199,17,199,76,0],[200,17,200,81,0],[202,17,202,181,0],[204,17,207,154,0],[210,17,210,41,0],[211,21,211,134,0],[213,17,213,46,0],[215,17,215,18,0],[216,21,216,43,0],[217,21,217,22,0],[218,25,219,80,0],[220,25,220,26,0],[221,29,221,82,0],[222,29,224,97,0],[225,29,226,67,0],[228,29,230,88,0],[231,29,231,115,0],[233,29,233,53,0],[234,29,234,30,0],[235,33,235,73,0],[236,33,236,81,0],[238,33,238,102,0],[239,37,239,96,0],[241,33,241,106,0],[242,37,242,100,0],[244,38,244,47,0],[244,49,244,97,0],[244,99,244,102,0],[245,33,245,34,0],[246,37,246,102,0],[247,37,247,101,0],[248,33,248,34,0],[250,33,250,67,0],[251,33,251,86,0],[252,33,252,86,0],[253,33,253,52,0],[254,33,254,77,0],[256,33,256,87,0],[257,33,257,34,0],[258,37,258,103,0],[259,37,259,72,0],[260,37,260,93,0],[261,37,261,94,0],[262,37,262,84,0],[263,33,263,34,0],[265,33,266,54,0],[268,33,274,35,0],[276,25,276,26,0],[277,21,277,22,0],[278,17,278,18,0],[279,17,279,34,0],[280,17,280,18,0],[281,17,281,18,0],[282,13,282,14,0],[284,13,284,76,0],[285,13,285,14,0],[286,17,286,56,0],[287,17,287,43,0],[288,17,288,64,0],[289,17,289,47,0],[290,17,290,44,0],[290,45,290,78,0],[291,13,291,14,0],[293,13,294,38,0],[297,13,303,15,0],[304,9,304,10,0],[307,9,307,10,1],[308,13,308,92,1],[309,13,309,14,1],[310,17,310,37,1],[313,13,313,62,1],[313,62,313,141,1],[313,141,314,30,1],[314,30,318,18,1],[318,18,318,29,1],[313,13,318,29,1],[320,13,320,32,1],[321,17,321,37,0],[323,13,323,14,1],[324,17,324,69,1],[325,17,325,77,1],[327,22,327,31,1],[327,33,327,52,1],[327,54,327,57,1],[328,17,328,18,1],[329,21,329,46,1],[330,21,330,160,1],[331,21,331,22,1],[332,25,332,65,1],[333,25,333,68,1],[334,21,334,22,1],[335,17,335,18,1],[337,17,337,136,1],[339,9,339,10,1],[343,9,343,10,0],[344,13,344,44,0],[345,13,345,49,0],[346,13,346,59,0],[347,13,347,38,0],[348,13,348,14,0],[349,22,349,32,0],[349,34,349,62,0],[349,64,349,68,0],[350,17,350,18,0],[351,21,353,88,0],[356,21,356,91,0],[357,25,357,74,0],[359,21,359,54,0],[360,25,360,78,0],[362,25,362,79,0],[365,21,365,54,0],[366,21,366,22,0],[367,25,367,51,0],[370,25,373,74,0],[374,25,376,74,0],[380,25,380,32,0],[380,34,380,49,0],[380,50,380,52,0],[380,53,380,63,0],[381,25,381,26,0],[382,29,382,90,0],[383,29,383,30,0],[384,33,384,84,0],[385,29,385,30,0],[386,25,386,26,0],[387,25,387,130,0],[388,25,388,75,0],[389,25,389,80,0],[390,29,390,74,0],[393,30,393,42,0],[393,44,393,64,0],[393,66,393,72,0],[394,25,394,26,0],[395,29,395,36,0],[395,38,395,53,0],[395,54,395,56,0],[395,57,395,67,0],[396,29,396,30,0],[398,33,398,34,0],[399,37,401,97,0],[402,37,402,38,0],[403,41,403,122,0],[404,37,404,38,0],[405,33,405,34,0],[406,33,406,50,0],[407,33,407,34,0],[409,33,409,34,0],[410,29,410,30,0],[411,25,411,26,0],[413,30,413,42,0],[413,44,413,64,0],[413,66,413,72,0],[414,25,414,26,0],[415,29,417,97,0],[418,29,418,30,0],[419,33,421,70,0],[422,29,422,30,0],[423,25,423,26,0],[428,25,428,96,0],[430,25,430,57,0],[431,25,431,78,0],[432,25,432,26,0],[433,29,433,63,0],[434,29,434,61,0],[435,29,435,72,0],[435,73,435,106,0],[436,29,436,72,0],[436,73,436,106,0],[437,29,437,66,0],[437,67,437,94,0],[438,29,438,78,0],[438,79,438,118,0],[439,29,439,51,0],[440,34,440,43,0],[440,45,440,65,0],[440,67,440,70,0],[441,29,441,30,0],[442,33,442,87,0],[443,33,443,68,0],[444,33,444,34,0],[445,37,445,55,0],[446,33,446,34,0],[447,33,448,101,0],[449,33,449,34,0],[450,37,450,68,0],[451,37,451,71,0],[452,37,452,79,0],[453,37,453,87,0],[454,37,454,102,0],[455,37,455,87,0],[456,37,456,72,0],[457,37,457,38,0],[458,41,458,83,0],[459,41,459,93,0],[461,41,461,155,0],[462,45,462,105,0],[464,41,464,88,0],[465,41,465,105,0],[466,37,466,38,0],[467,37,467,59,0],[468,33,468,34,0],[469,29,469,30,0],[470,29,470,55,0],[471,25,471,26,0],[472,25,472,51,0],[473,25,473,55,0],[474,25,474,26,0],[475,29,475,55,0],[477,29,477,63,0],[480,29,480,62,0],[481,29,481,62,0],[483,29,483,36,0],[483,38,483,54,0],[483,55,483,57,0],[483,58,483,71,0],[484,29,484,30,0],[485,33,485,96,0],[486,33,486,68,0],[487,29,487,30,0],[489,29,489,36,0],[489,38,489,51,0],[489,52,489,54,0],[489,55,489,65,0],[490,29,490,30,0],[491,33,491,64,0],[492,29,492,30,0],[494,29,494,82,0],[495,25,495,26,0],[497,25,497,80,0],[498,29,498,74,0],[500,25,500,86,0],[503,25,503,58,0],[504,25,504,46,0],[505,25,505,73,0],[507,25,510,91,0],[512,25,512,53,0],[513,25,513,32,0],[513,34,513,44,0],[513,45,513,47,0],[513,48,513,67,0],[514,29,514,61,0],[515,29,515,30,0],[516,33,516,55,0],[517,33,517,39,0],[520,25,520,70,0],[521,25,521,62,0],[522,25,522,26,0],[523,29,523,84,0],[524,29,527,78,0],[528,29,528,76,0],[529,29,529,53,0],[530,38,530,47,0],[530,49,530,68,0],[530,70,530,73,0],[531,33,531,34,0],[532,37,534,92,0],[535,37,535,53,0],[535,54,535,63,0],[536,37,538,93,0],[539,37,539,55,0],[539,56,539,65,0],[540,37,540,66,0],[541,33,541,34,0],[543,29,543,85,0],[544,29,544,95,0],[545,29,547,73,0],[548,29,549,74,0],[551,29,551,36,0],[551,38,551,60,0],[551,61,551,63,0],[551,64,551,76,0],[552,29,552,30,0],[553,33,553,110,0],[554,33,554,78,0],[555,33,555,34,0],[556,37,556,59,0],[559,37,559,113,0],[561,37,563,74,0],[564,37,564,43,0],[566,29,566,30,0],[567,25,567,26,0],[569,25,569,111,0],[571,25,571,73,0],[572,29,572,67,0],[573,25,573,98,0],[574,21,574,22,0],[575,17,575,18,0],[576,13,576,14,0],[577,9,577,10,0],[579,9,579,10,0],[580,13,580,95,0],[582,13,582,107,0],[583,13,583,43,0],[584,13,584,14,0],[585,17,585,24,0],[585,26,585,41,0],[585,42,585,44,0],[585,45,585,59,0],[586,17,586,18,0],[587,21,587,80,0],[588,21,588,58,0],[588,59,588,101,0],[590,21,593,102,0],[594,21,594,57,0],[595,21,595,22,0],[596,25,596,119,0],[597,21,597,22,0],[598,17,598,18,0],[599,13,599,14,0],[601,13,602,47,0],[602,47,602,71,0],[602,71,602,98,0],[602,98,602,99,0],[602,47,602,99,0],[602,99,602,110,0],[601,13,602,110,0],[603,13,603,33,0],[604,13,604,14,0],[606,17,607,56,0],[608,17,608,24,0],[608,26,608,41,0],[608,42,608,44,0],[608,45,608,57,0],[609,17,609,18,0],[610,21,610,80,0],[611,21,611,58,0],[611,59,611,101,0],[613,21,616,102,0],[617,21,617,57,0],[618,21,618,22,0],[619,25,619,119,0],[620,21,620,22,0],[621,17,621,18,0],[622,13,622,14,0],[624,13,624,68,0],[624,68,624,69,0],[624,69,624,93,0],[624,13,624,93,0],[625,9,625,10,0],[628,9,628,10,0],[629,13,629,43,0],[631,18,631,27,0],[631,29,631,48,0],[631,50,631,53,0],[632,13,632,14,0],[633,17,633,28,0],[634,17,634,18,0],[635,21,635,74,0],[636,17,636,18,0],[638,17,638,18,0],[639,21,639,59,0],[640,17,640,18,0],[641,13,641,14,0],[642,13,642,26,0],[643,9,643,10,0],[648,9,648,10,0],[649,13,649,64,0],[650,13,650,24,0],[651,13,651,38,0],[652,13,652,47,0],[653,13,653,76,0],[654,13,654,93,0],[654,94,654,112,0],[655,13,655,121,0],[656,13,656,62,0],[657,13,657,48,0],[657,49,657,84,0],[659,13,659,20,0],[659,22,659,32,0],[659,33,659,35,0],[659,36,659,39,0],[660,13,660,14,0],[661,17,661,76,0],[662,17,662,46,0],[663,17,663,40,0],[664,17,664,56,0],[665,17,665,49,0],[666,17,666,72,0],[667,17,668,89,0],[669,17,669,46,0],[669,47,669,63,0],[670,17,670,37,0],[670,38,670,47,0],[678,17,678,50,0],[679,17,681,59,0],[682,17,682,83,0],[684,17,684,76,0],[685,17,685,75,0],[687,17,688,66,0],[690,17,690,42,0],[691,21,691,28,0],[691,30,691,52,0],[691,53,691,55,0],[691,56,691,68,0],[692,21,692,22,0],[693,25,693,67,0],[693,68,693,77,0],[694,25,694,85,0],[695,25,695,26,0],[696,29,696,85,0],[697,29,697,30,0],[698,33,698,79,0],[699,29,699,30,0],[700,29,700,38,0],[702,25,702,102,0],[703,25,703,88,0],[704,25,704,89,0],[705,25,705,44,0],[706,25,706,26,0],[707,29,707,75,0],[708,25,708,26,0],[709,21,709,22,0],[710,17,710,42,0],[710,43,710,52,0],[715,17,715,24,0],[715,26,715,40,0],[715,41,715,43,0],[715,44,715,51,0],[716,17,716,18,0],[717,21,725,24,0],[726,17,726,18,0],[727,17,727,48,0],[728,13,728,14,0],[729,13,729,31,0],[730,9,730,10,0],[734,9,734,10,0],[735,13,735,35,0],[737,13,738,29,0],[739,13,739,53,0],[740,13,740,14,0],[741,17,741,48,0],[742,17,742,18,0],[743,21,743,67,0],[744,21,744,37,0],[745,21,745,37,0],[746,17,746,18,0],[747,17,750,68,0],[752,17,752,115,0],[753,17,753,18,0],[754,21,754,68,0],[755,21,755,34,0],[758,17,758,38,0],[759,17,759,86,0],[760,17,760,32,0],[761,17,761,77,0],[763,17,763,38,0],[765,17,765,116,0],[766,21,766,53,0],[768,21,768,87,0],[770,17,770,64,0],[771,17,771,40,0],[772,17,772,85,0],[773,17,773,79,0],[774,17,774,101,0],[775,17,775,72,0],[776,17,776,40,0],[778,17,778,97,0],[781,17,781,46,0],[784,17,784,18,0],[785,21,786,109,0],[787,21,787,43,0],[788,21,788,22,0],[789,25,789,50,0],[790,25,790,26,0],[791,29,791,82,0],[792,29,794,94,0],[795,29,796,67,0],[797,29,798,99,0],[799,29,799,30,0],[800,33,800,122,0],[801,29,801,30,0],[802,25,802,26,0],[803,21,803,22,0],[804,17,804,18,0],[805,17,805,37,0],[806,17,806,18,0],[807,21,807,51,0],[808,17,808,18,0],[810,17,810,63,0],[811,17,811,39,0],[812,17,812,118,0],[813,17,813,117,0],[814,17,814,39,0],[816,17,816,61,0],[817,17,817,37,0],[818,17,818,44,0],[819,17,819,18,0],[820,21,820,61,0],[821,21,821,85,0],[822,17,822,18,0],[823,17,823,37,0],[824,17,824,56,0],[825,17,825,32,0],[827,17,827,63,0],[828,17,829,106,0],[830,17,830,83,0],[831,17,831,89,0],[832,17,832,60,0],[833,17,833,93,0],[834,17,834,79,0],[835,17,835,75,0],[836,17,836,114,0],[837,17,837,32,0],[839,17,839,40,0],[840,17,840,29,0],[843,13,843,36,0],[844,13,844,26,0],[845,9,845,10,0],[848,9,848,10,0],[849,13,850,90,0],[851,13,851,59,0],[853,13,853,40,0],[854,13,854,101,0],[855,13,856,121,0],[858,13,858,60,0],[860,13,860,71,0],[861,13,861,14,0],[862,17,862,101,0],[863,13,863,14,0],[865,13,865,76,0],[866,13,866,28,0],[867,13,867,14,0],[868,17,870,62,0],[871,13,871,14,0],[873,13,873,47,0],[875,13,875,55,0],[877,13,877,69,0],[879,13,879,112,0],[880,13,880,14,0],[881,17,881,78,0],[882,17,882,77,0],[883,17,883,53,0],[884,21,885,96,0],[885,96,885,108,0],[885,108,885,120,0],[884,21,885,120,0],[886,13,886,14,0],[888,13,888,14,0],[889,17,889,75,0],[890,17,890,18,0],[891,21,891,101,0],[892,17,892,18,0],[893,13,893,14,0],[894,13,894,23,0],[896,13,896,37,0],[897,17,897,24,0],[897,26,897,33,0],[897,34,897,36,0],[897,37,897,44,0],[898,17,898,18,0],[899,21,899,51,0],[899,52,899,83,0],[900,17,900,18,0],[902,13,902,20,0],[902,22,902,35,0],[902,36,902,38,0],[902,39,902,60,0],[903,13,903,14,0],[904,17,904,41,0],[905,17,905,45,0],[906,17,906,18,0],[907,21,907,115,0],[908,21,908,42,0],[909,21,909,22,0],[910,25,910,78,0],[911,21,911,22,0],[912,17,912,18,0],[913,17,913,62,0],[915,17,915,105,0],[916,17,916,42,0],[918,17,918,32,0],[919,17,919,18,0],[920,21,922,78,0],[923,17,923,18,0],[924,17,924,81,0],[925,17,925,18,0],[926,21,926,32,0],[927,21,927,22,0],[928,25,929,70,0],[930,21,930,22,0],[932,21,932,22,0],[933,25,934,70,0],[935,21,935,22,0],[936,17,936,18,0],[937,17,937,21,0],[938,13,938,14,0],[940,13,940,44,0],[942,13,942,29,0],[943,13,943,14,0],[944,17,945,72,0],[947,21,949,66,0],[950,13,950,14,0],[952,13,952,39,0],[953,13,953,51,0],[959,13,959,31,0],[960,9,960,10,0],[963,9,963,10,0],[964,13,965,97,0],[967,13,967,101,0],[968,13,969,138,0],[971,13,971,60,0],[974,13,976,45,0],[978,13,978,29,0],[979,13,979,14,0],[980,17,981,79,0],[983,21,987,66,0],[988,13,988,14,0],[990,13,990,14,0],[991,17,991,27,0],[993,17,994,17,0],[994,17,994,18,0],[994,18,995,21,0],[995,21,995,32,0],[995,32,995,33,0],[995,33,995,40,0],[995,40,996,21,0],[996,21,996,137,0],[996,137,997,21,0],[997,21,997,22,0],[997,22,998,25,0],[998,25,1000,82,0],[1000,82,1002,25,0],[1002,25,1002,42,0],[1002,42,1003,25,0],[1003,25,1003,26,0],[1003,26,1004,29,0],[1004,29,1004,40,0],[1004,40,1005,29,0],[1005,29,1005,30,0],[1005,30,1006,33,0],[1006,33,1007,78,0],[1007,78,1008,29,0],[1008,29,1008,30,0],[1008,30,1010,29,0],[1010,29,1010,30,0],[1010,30,1011,33,0],[1011,33,1012,78,0],[1012,78,1013,29,0],[1013,29,1013,30,0],[1013,30,1014,25,0],[1014,25,1014,26,0],[1014,26,1015,25,0],[1015,25,1015,29,0],[1015,29,1016,21,0],[1016,21,1016,22,0],[1016,22,1017,17,0],[1017,17,1017,18,0],[1017,18,1017,20,0],[993,17,1017,20,0],[1018,13,1018,14,0],[1021,13,1021,40,0],[1024,13,1025,224,0],[1027,13,1027,52,0],[1028,13,1028,51,0],[1030,13,1030,31,0],[1031,9,1031,10,0],[1035,9,1035,10,0],[1036,13,1036,45,0],[1037,13,1037,14,0],[1038,17,1038,31,0],[1039,17,1039,49,0],[1040,21,1040,69,0],[1042,21,1042,80,0],[1043,17,1043,49,0],[1044,17,1044,18,0],[1045,21,1045,62,0],[1046,21,1046,53,0],[1047,21,1047,55,0],[1048,21,1048,41,0],[1050,13,1050,14,0],[1051,13,1051,25,0],[1052,9,1052,10,0],[1055,9,1055,10,0],[1056,13,1056,46,0],[1057,13,1057,56,0],[1058,13,1058,33,0],[1059,13,1059,14,0],[1060,17,1060,63,0],[1061,17,1061,92,0],[1062,17,1062,98,0],[1063,17,1063,33,0],[1066,17,1066,29,0],[1067,9,1067,10,0],[1070,9,1070,10,0],[1071,13,1071,88,0],[1072,9,1072,10,0],[1078,34,1078,38,0],[1078,39,1078,43,0],[1079,35,1079,39,0],[1079,40,1079,44,0],[1080,40,1080,44,0],[1080,45,1080,49,0],[1081,35,1081,39,0],[1081,40,1081,44,0],[1082,38,1082,42,0],[1082,43,1082,47,0],[1089,9,1089,10,1],[1090,13,1090,70,1],[1093,13,1093,32,1],[1094,17,1094,37,0],[1096,13,1096,39,1],[1097,13,1098,13,1],[1098,13,1098,14,1],[1098,14,1099,17,1],[1099,17,1099,61,1],[1099,61,1100,17,1],[1100,17,1100,18,1],[1100,18,1101,21,1],[1101,21,1102,70,1],[1102,70,1103,21,1],[1103,21,1103,82,1],[1103,82,1103,115,1],[1103,115,1103,118,1],[1103,21,1103,118,1],[1103,118,1104,25,1],[1104,25,1104,103,1],[1104,103,1105,17,1],[1105,17,1105,18,1],[1105,18,1107,17,1],[1107,17,1107,18,0],[1107,18,1108,21,1],[1108,21,1108,64,0],[1108,64,1110,21,1],[1110,21,1110,56,0],[1110,56,1111,25,1],[1111,25,1111,110,0],[1111,110,1112,17,1],[1112,17,1112,18,0],[1112,18,1113,13,1],[1113,13,1113,14,1],[1113,14,1113,16,1],[1097,13,1113,16,1],[1115,13,1115,59,1],[1117,13,1117,45,1],[1118,13,1118,72,1],[1119,13,1119,14,0],[1120,17,1120,64,0],[1122,17,1122,24,0],[1122,26,1122,39,0],[1122,40,1122,42,0],[1122,43,1122,50,0],[1123,17,1123,18,0],[1124,21,1124,58,0],[1124,59,1124,79,0],[1126,21,1126,54,0],[1126,54,1126,94,0],[1126,94,1126,96,0],[1126,21,1126,96,0],[1127,21,1127,78,0],[1128,17,1128,18,0],[1130,17,1130,54,0],[1131,17,1131,18,0],[1132,21,1132,69,0],[1133,21,1133,102,0],[1134,17,1134,18,0],[1135,13,1135,14,0],[1137,13,1137,29,1],[1138,9,1138,10,1],[1141,9,1141,10,1],[1142,13,1142,34,1],[1144,13,1144,112,1],[1145,17,1145,49,1],[1147,17,1147,83,0],[1148,13,1148,29,1],[1149,9,1149,10,1],[1152,9,1152,10,0],[1153,13,1153,55,0],[1154,13,1154,61,0],[1155,13,1155,112,0],[1156,13,1156,14,0],[1157,17,1157,78,0],[1158,17,1158,77,0],[1159,17,1159,53,0],[1160,21,1161,96,0],[1161,96,1161,108,0],[1161,108,1161,120,0],[1160,21,1161,120,0],[1162,13,1162,14,0],[1163,18,1163,81,0],[1164,13,1164,14,0],[1165,17,1165,72,0],[1166,17,1166,18,0],[1167,21,1167,28,0],[1167,30,1167,43,0],[1167,44,1167,46,0],[1167,47,1167,98,0],[1168,21,1168,22,0],[1169,25,1169,71,0],[1170,25,1170,42,0],[1171,25,1171,26,0],[1172,29,1172,49,0],[1173,25,1173,26,0],[1174,21,1174,22,0],[1175,17,1175,18,0],[1177,17,1177,18,0],[1178,21,1178,77,0],[1179,21,1179,38,0],[1180,21,1180,22,0],[1181,25,1181,48,0],[1182,21,1182,22,0],[1183,17,1183,18,0],[1184,13,1184,14,0],[1186,13,1186,14,0],[1187,17,1187,103,0],[1188,13,1188,14,0],[1190,13,1190,20,0],[1190,22,1190,29,0],[1190,30,1190,32,0],[1190,33,1190,40,0],[1191,13,1191,14,0],[1192,17,1192,58,0],[1193,17,1193,32,0],[1193,33,1193,56,0],[1194,17,1194,18,0],[1195,13,1195,14,0],[1196,13,1196,34,0],[1197,9,1197,10,0],[1200,9,1200,10,0],[1202,13,1202,37,0],[1203,13,1204,13,0],[1204,13,1204,14,0],[1204,14,1205,17,0],[1205,17,1205,37,0],[1205,37,1205,38,0],[1205,38,1205,45,0],[1205,45,1206,17,0],[1206,17,1206,72,0],[1206,72,1206,73,0],[1206,73,1206,86,0],[1206,86,1207,13,0],[1207,13,1207,14,0],[1207,14,1207,16,0],[1203,13,1207,16,0],[1208,13,1208,30,0],[1209,9,1209,10,0]]);
    </script>
  </body>
</html>