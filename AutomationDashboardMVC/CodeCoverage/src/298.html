<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Main Modules\Contract Manager\UI\NewContractTermsAndCondition.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ContmgtDTO;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.Brix.Platform.BusinessLayer.DTO;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.WebUI.UltraWebGrid;
using Infragistics.WebUI.WebDataInput;
using Infragistics.WebUI.WebSchedule;
using System;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.Threading;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Xml;

namespace Aurigo.Brix.Construction.ContractManager.UI
{
    public partial class NewContractTermsAndCondition : BrixPageBase, IWorkflowEnabled
    {
        protected WebDateChooser dtContractDate, wdcCreatedOn;
        protected WebNumericEdit wneMaxAmount, wneMaxPercentage, wneRetentionPercentage, wneRetentionCeiling;
        protected UltraWebGrid uwgPrepaymentTypes;

        protected AttachmentsControl attachments;

        #region ItemDivEnums enum

        public enum ItemDivEnums
        {
            CreateTerm = 1,
            PrepaymentPicker = 2,
            RetentionPicker = 3
        }

        #endregion

        private bool IsNewInstance = true;
        private int _ContTermID;
        public int _ContractID;

        private DataTable dtPrepayment;
        private DataTable dtRecovery;
        private DataTable dtRetention;
        private bool editRecoveryDetails = true;
        private bool editRetentionDetails = true;
        public bool isVersion;
        private GenericPickerControl prepaymentPicker;
        private GenericPickerControl retentionPicker;
        private AMP3.ContmgtDTO.DTO _contractModules = null;

        /// &lt;summary&gt;
        /// Gets the Integration Cutoff Date
        /// &lt;/summary&gt;
        private DateTime IntegrationCutoffDate
        {
            get { return ((DateTime)Session[Constants.APP_IntegrationCutoffDate]).AddDays(-1); }
        }

        /// &lt;summary&gt;
        /// Gets the Default Record Date
        /// &lt;/summary&gt;
        private DateTime DefaultRecordDate
        {
            get { return (DateTime)Session[Constants.APP_DefaultRecordDate]; }
        }

        /// &lt;summary&gt;
        /// Gets the Project Mode : I-Integration, L-Live
        /// &lt;/summary&gt;
        private string ProjectMode
        {
            get { return (CacheManager.Instance.IsIntegrated(PID) ? &quot;I&quot; : &quot;L&quot;); }
        }

        protected bool HasPrePaymentModule;

        #region IWorkflowEnabled Members

        public void CancelHandler(object sender, bool bAfterSave, out string sRedirectTo)
        {
            throw new NotImplementedException();
        }

        public string FormInstanceId
        {
            get
            {
                int id = -1;
                if ((!string.IsNullOrEmpty(Request.QueryString[&quot;Version&quot;]) &amp;&amp;
                     Request.QueryString[&quot;Version&quot;].ToString2() == &quot;true&quot;) ||
                    string.IsNullOrEmpty(Request.QueryString[&quot;ContTermID&quot;]))
                    id = -1;
                else
                {
                    int.TryParse(Request.QueryString[&quot;ContTermID&quot;].ToString2(), out id);
                    id = id == 0 ? -1 : id;
                }

                return id.ToString2();
            }
        }

        public string FormKey { get { return string.Format(&quot;Name : {0}&quot;, txtName.Text); } set { txtName.Text = value; } }


        public string FormName
        {
            get { return &quot;XCONTTC&quot;; }
        }

        public string ClientValidationFunction
        {
            get { return &quot;Validate()&quot;; }
        }

        public bool IsOldWorkflow
        {
            get { return true; }
        }

        public int PID
        {
            get { return Request.QueryString[&quot;PID&quot;].ToInt32_2(); }
        }

        public int ParentModuleId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;ContractID&quot;])
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;ContractID&quot;], out id) ? id : -1;
                return id;
            }
        }

        public string PostCancelRedirectUrl
        {
            get
            {
                return String.Format(CultureInfo.CurrentCulture,
                                     &quot;~/Common/BrixListPage.aspx?context=CONTERM&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&quot;, PID,
                                     ParentModuleId);
            }
        }

        public string PostSaveRedirectUrl(string sSavedToken = &quot;&quot;)
        {
            return String.Format(CultureInfo.CurrentCulture,
                                 &quot;~/Common/BrixListPage.aspx?context=CONTERM&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&quot;, PID,
                                 ParentModuleId);
        }

        public bool SaveHandler(object sender, out string sSavedInstanceToken, out string sErrors,
                                out string sRedirectTo)
        {
            sSavedInstanceToken = &quot;&quot;;
            sErrors = &quot;&quot;;
            sRedirectTo = &quot;&quot;;
            SaveContractTerms(out sSavedInstanceToken);
            if (!string.IsNullOrEmpty(sSavedInstanceToken))
                return true;
            else
                return false;
        }

        #endregion

        protected override void OnInit(EventArgs e)
        {
            IsNewInstance = (String.IsNullOrEmpty(Request[&quot;ContTermID&quot;]));

            if (IsNewInstance)
            {
                //New Record Creation
                PermissionsToCheck.Add(&quot;CreateCT&quot;);
            }
            else if (!(String.IsNullOrEmpty(Request[&quot;PageMode&quot;])))
            {
                //view Record
                PermissionsToCheck.Add(&quot;ViewCT&quot;);
            }
            else
            {
                //edit Record
                PermissionsToCheck.Add(&quot;EditCT&quot;);
            }



            #region Initializing prepayment picker

            prepaymentPicker = (ucPrepaymentPicker as GenericPickerControl);
            prepaymentPicker.IsFilterXml = true;
            prepaymentPicker.DisplayFilter = true;
            prepaymentPicker.BackClicked += prepaymentRulePicker_BackClicked;
            prepaymentPicker.ItemSelected += prepaymentRulePicker_SelectedIndexChanged;
            prepaymentPicker.BindData += prepaymentRulePicker_BindData;
            prepaymentPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            prepaymentPicker.StateMgmtContext = &quot;prepayment&quot;;
            prepaymentPicker.Filters = GetPrepaymentFilters();

            prepaymentPicker.ModifyColumnProperties(&quot;RecoveryId&quot;, true, null, null, null, false);
            prepaymentPicker.ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
            prepaymentPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
            prepaymentPicker.ModifyColumnProperties(&quot;Prepaymentmode&quot;, true, null, null, null, false);
            prepaymentPicker.ModifyColumnProperties(&quot;Value&quot;, true, null, null, null, false);
            prepaymentPicker.ModifyColumnProperties(&quot;Notes&quot;, true, null, null, null, false);
            prepaymentPicker.ModifyColumnProperties(&quot;IsActive&quot;, true, null, null, null, false);

            prepaymentPicker.ModifyColumnProperties(&quot;RecoveryRuleName&quot;, false, null, null, null, false,
                                                    &quot;Pre-Payment Rule&quot;);
            prepaymentPicker.ModifyColumnProperties(&quot;PrepayValue&quot;, false, null, null, null, false, &quot;Pre-Payment Value&quot;);

            #endregion

            #region Initializing retention picker

            retentionPicker = (ucRetentionPicker as GenericPickerControl);
            retentionPicker.IsFilterXml = true;
            retentionPicker.DisplayFilter = true;
            retentionPicker.BackClicked += retentionRulePicker_BackClicked;
            retentionPicker.ItemSelected += retentionRulePicker_SelectedIndexChanged;
            retentionPicker.BindData += retentionRulePicker_BindData;
            retentionPicker.DataSourceCommandType = DataSourceType.StoredProcedure;
            retentionPicker.StateMgmtContext = &quot;retention&quot;;
            retentionPicker.Filters = GetRetentionFilters();

            retentionPicker.ModifyColumnProperties(&quot;RetentionID&quot;, true, null, null, null, false);
            retentionPicker.ModifyColumnProperties(&quot;ModuleID&quot;, true, null, null, null, false);
            retentionPicker.ModifyColumnProperties(&quot;ParentInstanceID&quot;, true, null, null, null, false);
            retentionPicker.ModifyColumnProperties(&quot;RetentionCeilingMode&quot;, true, null, null, null, false);
            retentionPicker.ModifyColumnProperties(&quot;RetentionCeilingValue&quot;, true, null, null, null, false);
            retentionPicker.ModifyColumnProperties(&quot;Notes&quot;, true, null, null, null, false);
            retentionPicker.ModifyColumnProperties(&quot;IsActive&quot;, true, null, null, null, false);

            retentionPicker.ModifyColumnProperties(&quot;RetentionRuleName&quot;, false, null, null, null, false,
                                                   &quot;Retention Rule Name&quot;);
            retentionPicker.ModifyColumnProperties(&quot;RetentionPercentage&quot;, false, null, null, null, false,
                                                   &quot;Retention Percentage&quot;);
            retentionPicker.ModifyColumnProperties(&quot;RetentnValue&quot;, false, null, null, null, false,
                                                   &quot;Retention Ceiling Value&quot;);

            #endregion

            hdnAmountDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT).ToString2();
            hdnPercentageDigits.Value =
                CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE).ToString2();

            base.OnInit(e);
        }

        private void Page_PreRender(object sender, EventArgs e)
        {
            string mode = &quot;Z&quot;;
            if (txtPrepaymentRule.Text != string.Empty)
            {
                try
                {
                    DataTable dt =
                        dtRecovery.Select(&quot;RecoveryRuleName=&#39;&quot; + txtPrepaymentRule.Text.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;).CopyToDataTable();
                    DataRow row = dt.Rows[0];
                    mode = ((row[&quot;Prepaymentmode&quot;].ToString2().ToLower2() == &quot;false&quot; ||
                             row[&quot;Prepaymentmode&quot;].ToString2() == &quot;0&quot;)
                                ? &quot;A&quot;
                                : &quot;P&quot;);
                }
                catch
                {
                    mode = &quot;Z&quot;;
                }
            }
            HideShowTB(mode);
            //ShowHideComponents();
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            _ContractID = Request.QueryString[&quot;ContractID&quot;].ToInt32_2();
            IsNewInstance = (String.IsNullOrEmpty(Request[&quot;ContTermID&quot;]));
            if (!IsNewInstance)
                _ContTermID = Request.QueryString[&quot;ContTermID&quot;].ToInt32_2();
            isVersion = (!String.IsNullOrEmpty(Request.QueryString[&quot;Version&quot;]) &amp;&amp;
                         (Request.QueryString[&quot;Version&quot;].Equals(&quot;true&quot;)));
            if (IsNewInstance)
                lblID.Text = &quot;&lt;Auto Generated&gt;&quot;;
            PopulateDataTables();
            if (!IsPostBack)
            {
                wdcCreatedOn.CalendarLayout.Culture = DateFormatCulture.GetDateFormatCulture();
                if (IsNewInstance)
                {
                    wdcCreatedOn.MinDate = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : DefaultRecordDate.ToMWDateTime();
                    wdcCreatedOn.MaxDate = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : IntegrationCutoffDate.ToMWDateTime();
                    wdcCreatedOn.Value = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : DefaultRecordDate.ToMWDateTime();
                }
                wdcCreatedOn.Enabled = !ProjectMode.Equals(&quot;L&quot;);


                if (!IsNewInstance)
                {
                    //editing here
                    LoadContractTermInstanceDetails();
                }
                else
                {
                    DataTable dtPrepaymentType = GetSchema();
                    uwgPrepaymentTypes.DataSource = dtPrepaymentType;
                    uwgPrepaymentTypes.DataBind();
                    dtContractDate.Value = MWDateTimeHelper.MWNow;
                }
            }

            if (IsNewInstance)
            {
                //New Record Creation
                PageTitle = &quot;New Contractual Terms And Conditions&quot;;
                hdnTotalAmt.Value = BL.Instance.GetTotalContractAmountForContractView(_ContractID).ToString();
            }
            else if (!(String.IsNullOrEmpty(Request[&quot;PageMode&quot;])))
            {
                PageTitle = &quot;View Contractual Terms And Conditions&quot;;
                btnPrepaymentRulePicker.Enabled =
                    btnRetentionRulePicker.Enabled = false;
                SetReadOnly(true);
            }
            else
            {
                PageTitle = &quot;Edit Contractual Terms And Conditions&quot;;
                SetReadOnly(false);
            }

            litCurrency.Text = LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2());
            if (prepaymentPicker.Visible != false)
            {
                PageTitle = &quot;select pre-payment rule&quot;;
            }

            if (retentionPicker.Visible != false)
            {
                PageTitle = &quot;Select Retention Rule&quot;;
            }

            if (_contractModules == null)
                _contractModules = BL.Instance.GetContractModules(_ContractID);

            if (!_contractModules.Modules.Exists(module =&gt; module.ModID == Constants.MODID_CONTMOH))
                HasPrePaymentModule = false;
            else
                HasPrePaymentModule = true;


            TogglePrePaymentRuleSectionVisibility(HasPrePaymentModule);
        }

        private BrixDataTable GetSchema()
        {
            BrixDataTable dtPrepaymentType = new BrixDataTable();
            dtPrepaymentType.Columns.AddRange(new[]
                                                      {
                                                          new DataColumn(&quot;S.NO&quot;),
                                                          new DataColumn(&quot;PrepaymentType&quot;),
                                                          new DataColumn(&quot;PrepaymentValue&quot;, typeof(decimal)),
                                                          new DataColumn(&quot;RecoveryValue&quot;, typeof(decimal)),
                                                          new DataColumn(&quot;Recovery Amount&quot;, typeof(decimal)),
                                                          new DataColumn(&quot;RABillNumber&quot;),
                                                          new DataColumn(&quot;Amount Paid&quot;, typeof(decimal)),
                                                          new DataColumn(&quot;Recovered Amount&quot;, typeof(decimal))
                                                      });
            return dtPrepaymentType;
        }

        private void LoadContractTermInstanceDetails()
        {
            ContTermCondDTO ContTermDTO = BL.Instance.GetContractTermDetails(_ContTermID);

            if (ContTermDTO == null)
            {
                return;
            }

            lblID.Text = Convert.ToString(ContTermDTO.TermsNo);
            txtDescription.Text = ContTermDTO.Description;
            txtNotes.Text = ContTermDTO.Notes;
            txtName.Text = ContTermDTO.Name;
            hdnContTermID.Value = (string.IsNullOrEmpty(Request.QueryString[&quot;Version&quot;])
                                       ? ContTermDTO.Status.ToString2()
                                       : &quot;1&quot;);

            dtContractDate.Value = ContTermDTO.ContractDate.ToMWDateTime();
            tdCreatedBy2.InnerText = Convert.ToString(ContTermDTO.CreatedByName);
            wdcCreatedOn.Value = ContTermDTO.CreatedOn.ToMWDateTime();
            wdcCreatedOn.ReadOnly = true;
            hdnTotalAmt.Value =
                (ContTermDTO.ContractAmt == 0 ? hdnTotalAmt.Value.ToDecimal2() : ContTermDTO.ContractAmt).ToString2();

            ((AttachmentsControl)attachments).InstanceID = _ContTermID.ToString();
            ((AttachmentsControl)attachments).SrcType = &quot;CONTERM&quot;;
            ((AttachmentsControl)attachments).LoadAttachments();

            #region Loading Prepayment Rule, Prepayment Types and Retention details

            DataSet dsRRDetails = BL.Instance.GetRecoveryRetentionDetails(&quot;CONTERM&quot;, _ContTermID);
            //Table[0] - Recovery Details
            //Table[1] - Associated Prepayment Types
            //Table[2] - Retention Details

            string mode = string.Empty;
            if (dsRRDetails.Tables[0].Rows.Count != 0 &amp;&amp; dsRRDetails.Tables[1].Rows.Count != 0)
            {
                #region Loading Prepayment Rule

                mode = string.Empty;
                DataRow row = dsRRDetails.Tables[0].Rows[0];
                mode = ((row[&quot;Prepaymentmode&quot;].ToString2().ToLower2() == &quot;false&quot; ||
                         row[&quot;Prepaymentmode&quot;].ToString2() == &quot;0&quot;)
                            ? &quot;A&quot;
                            : &quot;P&quot;);
                wneMaxPercentage.Value =
                    ((row[&quot;Prepaymentmode&quot;].ToString2().ToLower2() == &quot;true&quot; || row[&quot;Prepaymentmode&quot;].ToString2() == &quot;1&quot;)
                         ? row[&quot;Value&quot;].ToString2()
                         : &quot;0&quot;).ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
                wneMaxAmount.Value =
                    ((row[&quot;Prepaymentmode&quot;].ToString2().ToLower2() == &quot;false&quot; ||
                      row[&quot;Prepaymentmode&quot;].ToString2() == &quot;0&quot;)
                         ? row[&quot;Value&quot;].ToString2()
                         : &quot;0&quot;).ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);

                txtPrepaymentRule.Text = row[&quot;RecoveryRuleName&quot;].ToString2();

                hdnRecoveryID.Value = row[&quot;RecoveryID&quot;].ToString2();

                #endregion

                #region Loading Prepayment Types

                DataTable dtTypes = dsRRDetails.Tables[1];
                dtTypes.Columns[&quot;PrepaymentValue&quot;].DataType = typeof(decimal);
                dtTypes.Columns[&quot;RecoveryValue&quot;].DataType = typeof(decimal);
                dtTypes.Columns[&quot;Amount Paid&quot;].DataType = typeof(decimal);
                dtTypes.Columns[&quot;Recovered Amount&quot;].DataType = typeof(decimal);

                dtTypes.Columns.Add(&quot;Recovery Amount&quot;, typeof(decimal));
                string format = (mode == &quot;P&quot; ? AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE : AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                foreach (DataRow rw in dtTypes.Rows)
                {
                    rw[&quot;Recovery Amount&quot;] =
                        CalculateRecoveryValueInEachRAB(rw[&quot;RecoveryValue&quot;].ToString2(),
                                                        rw[&quot;PrepaymentValue&quot;].ToString2(), mode).ToDecimal2().ToString(
                                                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                    ;
                    rw[&quot;Amount Paid&quot;] =
                        rw[&quot;Amount Paid&quot;].ToDecimal2().ToString(format, CultureInfo.CurrentCulture).ToDecimal2();
                    rw[&quot;Recovered Amount&quot;] =
                        rw[&quot;Recovered Amount&quot;].ToDecimal2().ToString(format, CultureInfo.CurrentCulture).ToDecimal2();
                }
                dtTypes.AcceptChanges();
                uwgPrepaymentTypes.DataSource = dtTypes;
                uwgPrepaymentTypes.DataBind();

                FormatPrepaymentTypesGrid(mode);
                HideShowTB(mode);

                #endregion
            }
            if (dsRRDetails.Tables[2].Rows.Count != 0)
            {
                #region Loading Retention Details

                DataRow row1 = dsRRDetails.Tables[2].Rows[0];
                mode = ((row1[&quot;RetentionCeilingMode&quot;].ToString2().Equals(&quot;False&quot;) ||
                         row1[&quot;RetentionCeilingMode&quot;].ToString2() == &quot;0&quot;)
                            ? &quot;A&quot;
                            : &quot;P&quot;);
                lblRetentionCeiling.Text = (mode == &quot;P&quot;
                                                ? &quot;Retention Ceiling Percentage :&quot;
                                                : &quot;Retention Ceiling Amount in &quot; +
                                                  LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT,
                                                                                        _ContractID.ToString2()) + &quot; :&quot;);
                wneRetentionPercentage.Value =
                    (row1[&quot;RetentionPercentage&quot;].ToString2() == &quot;&quot; ? &quot;0&quot; : row1[&quot;RetentionPercentage&quot;]).ToDecimal2().
                        ToString(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
                wneRetentionCeiling.Value =
                    (row1[&quot;RetentionCeilingValue&quot;].ToString2() == &quot;&quot; ? &quot;0&quot; : row1[&quot;RetentionCeilingValue&quot;]).ToDecimal2()
                        .ToString(mode == &quot;P&quot; ? AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE : AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                  CultureInfo.CurrentCulture);

                txtRetentionRule.Text = row1[&quot;RetentionRuleName&quot;].ToString2();

                hdnRetentionID.Value = row1[&quot;RetentionID&quot;].ToString2();

                #endregion
            }
            if (isVersion)
            {
                //Version being created.
                txtName.ReadOnly = true;
            }
            if (ContTermDTO.Status == 3)
            {
                tdApprovedBy.InnerText = Convert.ToString(ContTermDTO.ApprovedByName);
                tdApprovedOn.InnerText = ContTermDTO.ApprovedOn.ToMWDateTimeString_FormatDate();
                tdCreatedBy.Visible = true;
                btnPrepaymentRulePicker.Enabled =
                    btnRetentionRulePicker.Enabled = false;
                if (!isVersion)
                {
                    wneMaxAmount.Enabled =
                        wneMaxPercentage.Enabled =
                        wneRetentionCeiling.Enabled =
                        wneRetentionPercentage.Enabled = false;
                    SetReadOnly(true);
                }
                else
                {
                    btnPrepaymentRulePicker.Enabled =
                        btnRetentionRulePicker.Enabled = true;
                    trApprovedBy.Visible = false;
                    SetReadOnly(false);
                }
            }
            else
            {
                trApprovedBy.Visible = false;
            }

            #endregion
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            WorkflowEnabledSaveHandler();
        }

        protected void SaveContractTerms(out string savedToken)
        {

            // Payestimate Validation.
            if (!BL.Instance.ValidateContermOnPE(_ContractID, wneRetentionCeiling.Value.ToDecimal2()))
            {
                throw new Exception(&quot;Retention ceiling Value cannot be less than the Retained amount. Request Denied.&quot;);
            }

            #region save

            savedToken = string.Empty;
            if (string.IsNullOrEmpty(hdnContTermID.Value) ||
                (!string.IsNullOrEmpty(hdnContTermID.Value) &amp;&amp; hdnContTermID.Value != &quot;3&quot;))
            {
                var ContTermDTO = new ContTermCondDTO();
                if (IsNewInstance)
                    ContTermDTO.ContractualTermID = null;
                else
                    ContTermDTO.ContractualTermID = _ContTermID;
                ContTermDTO.ContractID = _ContractID;
                ContTermDTO.Name = txtName.Text;
                ContTermDTO.Description = txtDescription.Text;
                ContTermDTO.Notes = txtNotes.Text;
                ContTermDTO.Status = string.IsNullOrEmpty(hdnContTermID.Value) ? 1 : hdnContTermID.Value.ToInt32_2();
                //Convert.ToInt32(ddlStatus.SelectedValue);
                ContTermDTO.CreatedBy = UserDetail.GetCurrentUserDetail().UID;
                ContTermDTO.CreatedOn = (wdcCreatedOn.Value.ToUtc());
                ContTermDTO.ContractDate = (dtContractDate.Value.ToUtc());
                ContTermDTO.TermsNo = (IsNewInstance) ? 0 : lblID.Text.ToInt32_2();

                #region Storing Prepayment,recovery and retention information

                int rowCount = uwgPrepaymentTypes.Rows.Count;
                int incrmentor = 0;
                int InstanceID = _ContTermID;
                var dtoRecoveryItems = new PrepaymentRecoveryRulesItems[rowCount];


                if (rowCount &gt; 0)
                {
                    DataRow[] dr = dtPrepayment.Select(&quot;RecoveryId=&quot; + hdnRecoveryID.Value);
                    foreach (UltraGridRow row in uwgPrepaymentTypes.DisplayLayout.Rows)
                    {
                        dtoRecoveryItems[incrmentor] = new PrepaymentRecoveryRulesItems();
                        int TypeId =
                            Int32.Parse(dr != null &amp;&amp; dr.Length &gt; 0 &amp;&amp; dr[incrmentor][&quot;PrepaymentTypeID&quot;] != null
                                            ? dr[incrmentor][&quot;PrepaymentTypeID&quot;].ToString2()
                                            : row.Cells.FromKey(&quot;PrepaymentTypeID&quot;).ToString2());
                        dtoRecoveryItems[incrmentor].PrepaymentTypeID = TypeId;
                        dtoRecoveryItems[incrmentor].RecoveryID = int.Parse(IsNewInstance ? &quot;0&quot; : hdnRecoveryID.Value);

                        dtoRecoveryItems[incrmentor].PrepaymentValue =
                            decimal.Parse(row.Cells.FromKey(&quot;PrepaymentValue&quot;).ToString2());
                        dtoRecoveryItems[incrmentor].RABillNumber =
                            int.Parse(row.Cells.FromKey(&quot;RABillNumber&quot;).ToString2());
                        dtoRecoveryItems[incrmentor].RecoveryValue =
                            decimal.Parse(row.Cells.FromKey(&quot;RecoveryValue&quot;).ToString2());

                        incrmentor++;
                    }


                    ContTermDTO.xmlPrepaymentItemList =
                        PrepaymentRecoveryrulesBL.Instance.SerializeDTO(dtoRecoveryItems).Replace(&quot;encoding=\&quot;utf-8\&quot;&quot;,
                                                                                                  String.Empty);
                    var dtoGeneral = new PrepaymentRecovery();
                    dtoGeneral.RecoveryID = int.Parse(IsNewInstance ? &quot;0&quot; : hdnRecoveryID.Value);

                    if (dtRecovery.Rows.Count != 0)
                    {
                        DataRow[] rowRecovery = dtRecovery.Select(&quot;RecoveryRuleName=&#39;&quot; + txtPrepaymentRule.Text.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;);
                        if (rowRecovery.Length != 0)
                        {
                            dtoGeneral.RecoveryRuleName = rowRecovery[0][&quot;RecoveryRuleName&quot;].ToString2();
                            dtoGeneral.Description = rowRecovery[0][&quot;Description&quot;].ToString2();
                            dtoGeneral.Value = ((rowRecovery[0][&quot;Prepaymentmode&quot;].ToString2() == &quot;True&quot; ||
                                                 rowRecovery[0][&quot;Prepaymentmode&quot;].ToString2() == &quot;1&quot;)
                                                    ? wneMaxPercentage.ValueDecimal
                                                    : wneMaxAmount.ValueDecimal);
                            dtoGeneral.Prepaymentmode = ((rowRecovery[0][&quot;Prepaymentmode&quot;].ToString2() == &quot;True&quot; ||
                                                          rowRecovery[0][&quot;Prepaymentmode&quot;].ToString2() == &quot;1&quot;)
                                                             ? true
                                                             : false);
                        }
                        ContTermDTO.xmlGeneralDetails =
                            PrepaymentRecoveryrulesBL.Instance.SerializeDTO(dtoGeneral).Replace(&quot;encoding=\&quot;utf-8\&quot;&quot;,
                                                                                                String.Empty);
                    }
                }
                var dtoRetention = new RetentionRuleItems();

                if (dtRetention.Rows.Count != 0)
                {
                    DataRow[] drRetention = dtRetention.Select(&quot;RetentionRuleName=&#39;&quot; + txtRetentionRule.Text.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;&quot;);

                    if (drRetention.Length != 0)
                    {
                        dtoRetention.RetentionID = isVersion
                                                       ? 0
                                                       : Convert.ToInt32(IsNewInstance ? &quot;0&quot; : hdnRetentionID.Value);
                        dtoRetention.RetentionRuleName = drRetention[0][&quot;RetentionRuleName&quot;].ToString2();
                        dtoRetention.Description = drRetention[0][&quot;Description&quot;].ToString2();
                        dtoRetention.RetentionCeilingValue = wneRetentionCeiling.ValueDecimal;
                        dtoRetention.RetentionCeilingMode = ((drRetention[0][&quot;RetentionCeilingMode&quot;].ToString2() ==
                                                              &quot;True&quot; ||
                                                              drRetention[0][&quot;RetentionCeilingMode&quot;].ToString2() == &quot;1&quot;)
                                                                 ? true
                                                                 : false);
                        dtoRetention.RetentionPercentage = wneRetentionPercentage.ValueDecimal;
                        ContTermDTO.xmlRetentionItemList =
                            RetentionRuleBL.Instance.SerializeDTO(dtoRetention).Replace(&quot;encoding=\&quot;utf-8\&quot;&quot;,
                                                                                        String.Empty);
                    }
                }

                #endregion

                ContTermDTO.Mode = (IsNewInstance ? &quot;N&quot; : &quot;E&quot;);
                ContTermDTO.IsVersion = isVersion;
                if ((_ContTermID = BL.Instance.SaveContractTermsAndConditions(ContTermDTO)) &gt; 0)
                {
                    savedToken = _ContTermID.ToString2();
                    //save attachments here
                    if (!SaveAttachments(_ContTermID, UserDetail.GetCurrentUserDetail(), isVersion))
                    {
                        Page.ClientScript.RegisterClientScriptBlock(GetType(), &quot;Error_in_Attachments&quot;,
                                                                    &quot;&lt;script&gt;ShowError(&lt;%= Aurigo.AMP3.Resources.TerminologyResources.ResourceFactory.Instance.GetString(&#39;Error in uploading attachments.\\n Contract terms created successfully.&#39;) %&gt;); &lt;/script&gt;&quot;);
                    }
                }
            }
            else
            {
                savedToken = hdnContTermID.Value;
            }
            #endregion

        }

        private bool SaveAttachments(int ContTermID, UserDetail user, bool IsVersion)
        {
            try
            {
                ((AttachmentsControl)attachments).ParentInstanceID = _ContractID;
                ((AttachmentsControl)attachments).ParentModuleID = Constants.MODID_CONTMGT;
                return ((IsVersion)
                            ? ((AttachmentsControl)attachments).CreateAttachmentsForVersions(ContTermID.ToString2(),
                                                                                              &quot;CONTERM&quot;, user.UID,
                                                                                              user.UserName,
                                                                                              &quot;Contract Term Attachments&quot;)
                            : ((AttachmentsControl)attachments).SaveAttachments(ContTermID.ToString2(), &quot;CONTERM&quot;,
                                                                                 user.UID, user.UserName,
                                                                                 &quot;Contract Term Attachments&quot;));
            }
            catch
            {
                return false;
            }
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=CONTERM&amp;PID=&quot; + Request[Constants.QRY_PROJECTID] +
                              &quot;&amp;ContractID=&quot; + (Request.QueryString[&quot;ContractID&quot;] ?? string.Empty) + &quot;&amp;ParentID=&quot; + (Request.QueryString[&quot;ContractID&quot;] ?? string.Empty));
        }

        private void ShowDiv(ItemDivEnums divType)
        {
            bool prepaymentPicker = (ItemDivEnums.PrepaymentPicker == divType);
            bool retentionPicker = (ItemDivEnums.RetentionPicker == divType);
            bool woPicker = (ItemDivEnums.CreateTerm == divType);

            DivTC.Visible = woPicker;
            DivPrepaymentPicker.Visible = prepaymentPicker;
            DivRetentionPicker.Visible = retentionPicker;
            string heading = string.Empty;
            if (prepaymentPicker) heading = &quot;Select Pre-Payment Rule&quot;;
            if (retentionPicker) heading = &quot;Select Retention Rule&quot;;
            PageTitle = ((prepaymentPicker || retentionPicker)
                             ? heading
                             : (IsNewInstance
                                    ? &quot;New Contractual Terms And Conditions&quot;
                                    : &quot;Edit Contractual Terms And Conditions&quot;));

            switch (divType)
            {
                case ItemDivEnums.PrepaymentPicker:
                case ItemDivEnums.RetentionPicker:
                    MainToolBar.Visible = false;
                    break;
                case ItemDivEnums.CreateTerm:
                    MainToolBar.Visible = true;
                    break;
            }
        }

        private void SetReadOnly(bool value)
        {
            txtName.ReadOnly =
                txtDescription.ReadOnly =
                txtNotes.ReadOnly = value;
            dtContractDate.Enabled = !value;
            //ddlStatus.Enabled = !value;

            ColumnsCollection cols = uwgPrepaymentTypes.Columns;
            if (value)
            {
                if (cols.Exists(&quot;PrepaymentValue&quot;)) cols.FromKey(&quot;PrepaymentValue&quot;).AllowUpdate = AllowUpdate.No;
                if (cols.Exists(&quot;RecoveryValue&quot;)) cols.FromKey(&quot;RecoveryValue&quot;).AllowUpdate = AllowUpdate.No;
                if (cols.Exists(&quot;RABillNumber&quot;)) cols.FromKey(&quot;RABillNumber&quot;).AllowUpdate = AllowUpdate.No;
                if (cols.Exists(&quot;PrepaymentValue&quot;))
                    cols.FromKey(&quot;PrepaymentValue&quot;).CellStyle.BackColor = Color.Transparent;
                if (cols.Exists(&quot;RecoveryValue&quot;)) cols.FromKey(&quot;RecoveryValue&quot;).CellStyle.BackColor = Color.Transparent;
                if (cols.Exists(&quot;RABillNumber&quot;)) cols.FromKey(&quot;RABillNumber&quot;).CellStyle.BackColor = Color.Transparent;
            }
            else
            {
                if (cols.Exists(&quot;PrepaymentValue&quot;)) cols.FromKey(&quot;PrepaymentValue&quot;).AllowUpdate = AllowUpdate.Yes;
                if (cols.Exists(&quot;RecoveryValue&quot;)) cols.FromKey(&quot;RecoveryValue&quot;).AllowUpdate = AllowUpdate.Yes;
                if (cols.Exists(&quot;RABillNumber&quot;)) cols.FromKey(&quot;RABillNumber&quot;).AllowUpdate = AllowUpdate.Yes;
                if (cols.Exists(&quot;PrepaymentValue&quot;)) cols.FromKey(&quot;PrepaymentValue&quot;).CellStyle.BackColor = Color.Yellow;
                if (cols.Exists(&quot;RecoveryValue&quot;)) cols.FromKey(&quot;RecoveryValue&quot;).CellStyle.BackColor = Color.Yellow;
                if (cols.Exists(&quot;RABillNumber&quot;)) cols.FromKey(&quot;RABillNumber&quot;).CellStyle.BackColor = Color.Yellow;
            }

            attachments.ReadOnly = value;
        }

        protected override void SetModes()
        {
            _IsNew = ((!string.IsNullOrEmpty(Request.QueryString[&quot;Version&quot;]) &amp;&amp;
                       Request.QueryString[&quot;Version&quot;].ToString2() == &quot;true&quot;) ||
                      string.IsNullOrEmpty(Request.QueryString[&quot;ContTermID&quot;]));
            _IsEdit = (!string.IsNullOrEmpty(Request.QueryString[&quot;ContTermID&quot;]) &amp;&amp;
                       Request.QueryString[&quot;ContTermID&quot;].ToInt32_2() &gt; 0);
            _IsView = (!string.IsNullOrEmpty(Request.QueryString[&quot;PageMode&quot;]) &amp;&amp;
                       Request.QueryString[&quot;PageMode&quot;].ToString2().ToLower2().Equals(&quot;view&quot;,
                                                                                     StringComparison.
                                                                                         InvariantCultureIgnoreCase));
        }

        private void TogglePrePaymentRuleSectionVisibility(bool visible)
        {
            trPPHeading.Visible = visible;
            trPPName.Visible = visible;
            trMaxAmount.Visible = visible;
            trMaxPercentage.Visible = visible;
            trPPGrid.Visible = visible;
        }

        #region Prepayment rule and retention rule association

        #region Event handlers

        public void prepaymentRulePicker_BindData(string Filter, string SortOrder, out DataSet DsResult,
                                                  ref int CurrentPage, int PageSize, out int PageCount)
        {
            DsResult = new DataSet();
            DataTable dtPrepaymentDetails = new BrixDataTable();
            if (!string.IsNullOrEmpty(Filter))
            {
                prepaymentPicker.Currency = LocalizationManager.GetModuleCurrency(&quot;CONTMGT&quot;, _ContractID.ToString2());
                var doc = new XmlDocument();
                doc.LoadXml(Filter);
                string prepaymentRule = ((doc).DocumentElement.SelectSingleNode(&quot;PrepaymentRuleName&quot;)) == null
                                            ? string.Empty
                                            : ((doc).DocumentElement.SelectSingleNode(&quot;PrepaymentRuleName&quot;)).InnerText.
                                                  ToString2();
                string description = ((doc).DocumentElement.SelectSingleNode(&quot;Description&quot;)) == null
                                         ? string.Empty
                                         : ((doc).DocumentElement.SelectSingleNode(&quot;Description&quot;)).InnerText.ToString2();
                try
                {
                    //Exception is thrown if the select query returns zero rows.
                    dtPrepaymentDetails =
                        dtRecovery.Copy().Select(&quot;RecoveryRuleName like &#39;%&quot; + prepaymentRule.ToString().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) +
                                                 &quot;%&#39; and Description like &#39;%&quot; + description.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;%&#39;&quot;).CopyToDataTable();
                }
                catch
                {
                }
            }
            else
            {
                dtPrepaymentDetails = dtRecovery.Copy();
            }
            dtPrepaymentDetails.Columns.Add(&quot;PrepayValue&quot;, typeof(string));
            for (int i = 0; i &lt; dtPrepaymentDetails.Rows.Count; i++)
            {
                if (dtPrepaymentDetails.Rows[i][&quot;prepaymentmode&quot;].ToString2().ToLower2() == &quot;true&quot; ||
                    dtPrepaymentDetails.Rows[i][&quot;prepaymentmode&quot;].ToString2() == &quot;1&quot;)
                    dtPrepaymentDetails.Rows[i][&quot;PrepayValue&quot;] =
                        dtPrepaymentDetails.Rows[i][&quot;Value&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE,
                                                                                   CultureInfo.CurrentCulture) + &quot; %&quot;;
                else
                    dtPrepaymentDetails.Rows[i][&quot;PrepayValue&quot;] =
                        dtPrepaymentDetails.Rows[i][&quot;Value&quot;].ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE,
                                                                                   CultureInfo.CurrentCulture) + &quot; in &quot; +
                        LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2());
            }
            dtPrepaymentDetails.AcceptChanges();
            DsResult.Tables.Add(dtPrepaymentDetails);
            PageCount = (int)Math.Ceiling(dtPrepaymentDetails.Rows.Count.ToDecimal2() / PageSize);
        }

        private void prepaymentRulePicker_BackClicked(object sender, EventArgs e)
        {
            ShowDiv(ItemDivEnums.CreateTerm);
        }

        private void prepaymentRulePicker_SelectedIndexChanged(object sender, ItemSelectedEventArgs e)
        {
            string mode = string.Empty;
            string format = string.Empty;
            string recoveryID = e.SelectedItems.Rows[0][&quot;RecoveryID&quot;].ToString2();
            bool addPrepayment = false;

            if (isVersion)
            {
                int isValid = BL.Instance.ValidatePrepaymentRule(_ContractID, recoveryID.ToInt32_2());
                if (isValid == 0)
                    addPrepayment = true;
                else
                    addPrepayment = false;
            }
            else
                addPrepayment = true;

            if (addPrepayment)
            {
                DataRow[] dtRec = dtRecovery.Select(&quot;RecoveryId=&quot; + recoveryID);
                DataRow rowPrepaymentDetails = dtRec[0];
                mode = ((rowPrepaymentDetails[&quot;Prepaymentmode&quot;].ToString2() == &quot;False&quot; ||
                         rowPrepaymentDetails[&quot;Prepaymentmode&quot;].ToString2() == &quot;1&quot;)
                            ? &quot;A&quot;
                            : &quot;P&quot;);
                format = (mode == &quot;P&quot; ? AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE : AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                wneMaxPercentage.Value =
                    ((rowPrepaymentDetails[&quot;Prepaymentmode&quot;].ToString2() == &quot;True&quot; ||
                      rowPrepaymentDetails[&quot;Prepaymentmode&quot;].ToString2() == &quot;0&quot;)
                         ? rowPrepaymentDetails[&quot;Value&quot;].ToString2()
                         : &quot;0&quot;).ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
                wneMaxAmount.Value =
                    ((rowPrepaymentDetails[&quot;Prepaymentmode&quot;].ToString2() == &quot;False&quot; ||
                      rowPrepaymentDetails[&quot;Prepaymentmode&quot;].ToString2() == &quot;1&quot;)
                         ? rowPrepaymentDetails[&quot;Value&quot;].ToString2()
                         : &quot;0&quot;).ToDecimal2().ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
                txtPrepaymentRule.Text = e.SelectedItems.Rows[0][&quot;RecoveryRuleName&quot;].ToString2();

                CalculateAmountOrPercentage(mode);
                HideShowTB(mode);

                DataTable dtPrepaymentType = GetSchema();
                var col = new DataColumn[] { };



                int i = 0;
                foreach (DataRow row in dtPrepayment.Rows)
                {
                    if (recoveryID == row[&quot;RecoveryID&quot;].ToString2())
                    {
                        i++;
                        DataRow r = dtPrepaymentType.NewRow();
                        r[&quot;S.NO&quot;] = i;
                        r[&quot;PrepaymentType&quot;] = row[&quot;PrepaymentType&quot;];
                        r[&quot;PrepaymentValue&quot;] =
                            (row[&quot;PrepaymentValue&quot;].ToString2() == &quot;&quot; ? &quot;0&quot; : row[&quot;PrepaymentValue&quot;]).ToDecimal2().
                                ToString(format, CultureInfo.CurrentCulture).ToDecimal2();
                        r[&quot;RecoveryValue&quot;] =
                            (row[&quot;RecoveryValue&quot;].ToString2() == &quot;&quot; ? &quot;0&quot; : row[&quot;RecoveryValue&quot;]).ToDecimal2().ToString(
                                format, CultureInfo.CurrentCulture).ToDecimal2();
                        r[&quot;Recovery Amount&quot;] =
                            CalculateRecoveryValueInEachRAB(row[&quot;RecoveryValue&quot;].ToString2(),
                                                            row[&quot;PrepaymentValue&quot;].ToString2(), mode).ToDecimal2().
                                ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture).ToDecimal2();
                        r[&quot;RABillNumber&quot;] = row[&quot;RABillNumber&quot;];
                        r[&quot;Amount Paid&quot;] =
                            row[&quot;Amount Paid&quot;].ToDecimal2().ToString(format, CultureInfo.CurrentCulture).ToDecimal2();
                        r[&quot;Recovered Amount&quot;] =
                            row[&quot;Recovered Amount&quot;].ToDecimal2().ToString(format, CultureInfo.CurrentCulture).ToDecimal2
                                ();
                        dtPrepaymentType.Rows.Add(r);
                        dtPrepaymentType.AcceptChanges();
                    }
                }
                hdnRecoveryID.Value = recoveryID;
                uwgPrepaymentTypes.DataSource = dtPrepaymentType;
                uwgPrepaymentTypes.DataBind();

                FormatPrepaymentTypesGrid(mode);

                ShowDiv(ItemDivEnums.CreateTerm);
            }
            else
                Page.ClientScript.RegisterStartupScript(GetType(), &quot;Prepayment&quot;,
                                                        &quot;ShowError(&#39;This pre-payment rule does not have all the pre-payment types for which the pre-payments have already been raised. Request denied.&#39;);&quot;,
                                                        true);
        }

        public void retentionRulePicker_BindData(string Filter, string SortOrder, out DataSet DsResult,
                                                 ref int CurrentPage, int PageSize, out int PageCount)
        {
            DsResult = new DataSet();

            prepaymentPicker.Currency = LocalizationManager.GetModuleCurrency(&quot;CONTMGT&quot;, _ContractID.ToString2());
            DataTable dtRetentionDetails = new BrixDataTable();
            if (Filter != null)
            {
                prepaymentPicker.Currency = LocalizationManager.GetModuleCurrency(&quot;CONTMGT&quot;, _ContractID.ToString2());
                var doc = new XmlDocument();
                doc.LoadXml(Filter);
                string prepaymentRule = ((doc).DocumentElement.SelectSingleNode(&quot;RetentionRuleName&quot;)) == null
                                            ? string.Empty
                                            : ((doc).DocumentElement.SelectSingleNode(&quot;RetentionRuleName&quot;)).InnerText.
                                                  ToString2();
                string description = ((doc).DocumentElement.SelectSingleNode(&quot;Description&quot;)) == null
                                         ? string.Empty
                                         : ((doc).DocumentElement.SelectSingleNode(&quot;Description&quot;)).InnerText.ToString2();
                try
                {
                    //Exception is thrown if the select queries returns zero rows.
                    dtRetentionDetails =
                        dtRetention.Copy().Select(&quot;RetentionRuleName like &#39;%&quot; + prepaymentRule.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) +
                                                  &quot;%&#39; and Description like &#39;%&quot; + description.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;%&#39;&quot;).CopyToDataTable();
                }
                catch
                {
                }
            }
            else
            {
                dtRetentionDetails = dtRetention.Copy();
            }
            dtRetentionDetails.Columns.Add(&quot;RetentnValue&quot;, typeof(string));
            for (int i = 0; i &lt; dtRetentionDetails.Rows.Count; i++)
            {
                if (dtRetentionDetails.Rows[i][&quot;RetentionCeilingMode&quot;].ToString2().ToLower2() == &quot;true&quot; ||
                    dtRetentionDetails.Rows[i][&quot;RetentionCeilingMode&quot;].ToString2() == &quot;1&quot;)
                    dtRetentionDetails.Rows[i][&quot;RetentnValue&quot;] =
                        dtRetentionDetails.Rows[i][&quot;RetentionCeilingValue&quot;].ToDecimal2().ToString(
                            AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture) + &quot; %&quot;;
                else
                    dtRetentionDetails.Rows[i][&quot;RetentnValue&quot;] =
                        dtRetentionDetails.Rows[i][&quot;RetentionCeilingValue&quot;].ToDecimal2().ToString(
                            AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture) + &quot; in &quot; +
                        LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT, _ContractID.ToString2());
                dtRetentionDetails.Rows[i][&quot;RetentionPercentage&quot;] =
                    dtRetentionDetails.Rows[i][&quot;RetentionPercentage&quot;].ToDecimal2().ToString(
                        AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
            }
            dtRetentionDetails.AcceptChanges();
            DsResult.Tables.Add(dtRetentionDetails);
            PageCount = (int)Math.Ceiling(dtRetentionDetails.Rows.Count.ToDecimal2() / PageSize);
        }

        private void retentionRulePicker_BackClicked(object sender, EventArgs e)
        {
            ShowDiv(ItemDivEnums.CreateTerm);
        }

        private void retentionRulePicker_SelectedIndexChanged(object sender, ItemSelectedEventArgs e)
        {
            string mode = string.Empty;
            string retentionId = e.SelectedItems.Rows[0][&quot;RetentionID&quot;].ToString2();
            DataRow[] dtRet = dtRetention.Select(&quot;RetentionID=&quot; + retentionId);
            DataRow row = dtRet[0];

            mode = ((row[&quot;RetentionCeilingMode&quot;].ToString2() == &quot;False&quot; ||
                     row[&quot;RetentionCeilingMode&quot;].ToString2() == &quot;1&quot;)
                        ? &quot;A&quot;
                        : &quot;P&quot;);
            lblRetentionCeiling.Text = (mode == &quot;P&quot;
                                            ? &quot;Retention Ceiling Percentage :&quot;
                                            : &quot;Retention Ceiling Amount in &quot; +
                                              LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT,
                                                                                    _ContractID.ToString2()) + &quot; :&quot;);
            wneRetentionPercentage.Value = (row[&quot;RetentionPercentage&quot;].ToString2() == &quot;&quot;
                                                ? &quot;0&quot;
                                                : row[&quot;RetentionPercentage&quot;]).ToDecimal2().ToString(
                                                    AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
            wneRetentionCeiling.Value = (row[&quot;RetentionCeilingValue&quot;].ToString2() == &quot;&quot;
                                             ? &quot;0&quot;
                                             : row[&quot;RetentionCeilingValue&quot;]).ToDecimal2().ToString(
                                                 mode == &quot;P&quot; ? AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE : AMP3ApplicationSettings.Instance.FORMAT_AMOUNT,
                                                 CultureInfo.CurrentCulture);
            txtRetentionRule.Text = e.SelectedItems.Rows[0][&quot;RetentionRuleName&quot;].ToString2();

            hdnRetentionID.Value = retentionId;

            ShowDiv(ItemDivEnums.CreateTerm);
            HideShowTB(mode);
        }

        protected void btnPrepaymentRulePicker_Click(object sender, EventArgs e)
        {
            ShowDiv(ItemDivEnums.PrepaymentPicker);
            prepaymentPicker.BindData += prepaymentRulePicker_BindData;
            prepaymentPicker.ChangeTableOrViewAndBind(&quot;prepayment&quot;);
        }

        protected void btnRetentionRulePicker_Click(object sender, EventArgs e)
        {
            ShowDiv(ItemDivEnums.RetentionPicker);
            retentionPicker.BindData += retentionRulePicker_BindData;
            retentionPicker.ChangeTableOrViewAndBind(&quot;retention&quot;);
        }

        #endregion

        #region Custom Functions

        private void FormatPrepaymentTypesGrid(string mode)
        {
            //int stage = int.Parse(hdnStage.Value == &quot;&quot; ? &quot;0&quot; : hdnStage.Value);
            //stage 1 - Draft; 2 - Approve; 3 - Issued.

            ColumnsCollection cols = uwgPrepaymentTypes.Columns;

            if (cols.Exists(&quot;S.No&quot;))
                cols.FromKey(&quot;S.No&quot;).Width = 40;

            if (cols.Exists(&quot;PrepaymentValue&quot;))
            {
                cols.FromKey(&quot;PrepaymentValue&quot;).Header.Caption = (mode == &quot;A&quot;
                                                                      ? &quot;Pre-Payment Amount&quot;
                                                                      : &quot;Pre-Payment Percentage&quot;);
                cols.FromKey(&quot;PrepaymentValue&quot;).Width = 125;
                cols.FromKey(&quot;PrepaymentValue&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;PrepaymentValue&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;PrepaymentValue&quot;).Header.Caption = cols.FromKey(&quot;PrepaymentValue&quot;).Header.Caption + &quot; &quot; +
                                                                 (mode == &quot;P&quot;
                                                                      ? &quot;&quot;
                                                                      : &quot; in &quot; +
                                                                        LocalizationManager.GetModuleCurrency(
                                                                            Constants.MODID_CONTMGT,
                                                                            _ContractID.ToString2()));

                cols.FromKey(&quot;PrepaymentValue&quot;).AllowUpdate = editRecoveryDetails ? AllowUpdate.Yes : AllowUpdate.No;
                cols.FromKey(&quot;PrepaymentValue&quot;).CellStyle.BackColor = editRecoveryDetails
                                                                          ? Color.Yellow
                                                                          : Color.Transparent;
            }
            if (cols.Exists(&quot;RecoveryValue&quot;))
            {
                cols.FromKey(&quot;RecoveryValue&quot;).Header.Caption = (mode == &quot;A&quot; ? &quot;Recovery Amount&quot; : &quot;Recovery Percentage&quot;);
                cols.FromKey(&quot;RecoveryValue&quot;).Width = 125;
                cols.FromKey(&quot;RecoveryValue&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;RecoveryValue&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;RecoveryValue&quot;).Header.Caption = cols.FromKey(&quot;RecoveryValue&quot;).Header.Caption + &quot; &quot; +
                                                               (mode == &quot;P&quot;
                                                                    ? &quot;&quot;
                                                                    : &quot; in &quot; +
                                                                      LocalizationManager.GetModuleCurrency(
                                                                          Constants.MODID_CONTMGT,
                                                                          _ContractID.ToString2()));


                cols.FromKey(&quot;RecoveryValue&quot;).AllowUpdate = editRecoveryDetails ? AllowUpdate.Yes : AllowUpdate.No;
                cols.FromKey(&quot;RecoveryValue&quot;).CellStyle.BackColor = editRecoveryDetails
                                                                        ? Color.Yellow
                                                                        : Color.Transparent;
            }
            if (cols.Exists(&quot;RABillNumber&quot;))
            {
                cols.FromKey(&quot;RABillNumber&quot;).Hidden = true;
                cols.FromKey(&quot;RABillNumber&quot;).Header.Caption = &quot;Start Recovery from &quot; +
                                                              LocalizationManager.GetString(&quot;RAB&quot;) + &quot; No&quot;;
                cols.FromKey(&quot;RABillNumber&quot;).Width = 100;

                cols.FromKey(&quot;RABillNumber&quot;).AllowUpdate = editRecoveryDetails ? AllowUpdate.Yes : AllowUpdate.No;
                cols.FromKey(&quot;RABillNumber&quot;).CellStyle.BackColor = editRecoveryDetails
                                                                       ? Color.Yellow
                                                                       : Color.Transparent;
            }
            if (cols.Exists(&quot;Recovery Amount&quot;))
            {
                cols.FromKey(&quot;Recovery Amount&quot;).Width = 125;
                cols.FromKey(&quot;Recovery Amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Recovery Amount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Recovery Amount&quot;).Header.Caption = cols.FromKey(&quot;Recovery Amount&quot;).Header.Caption + &quot; &quot; +
                                                                 &quot; in &quot; +
                                                                 LocalizationManager.GetModuleCurrency(
                                                                     Constants.MODID_CONTMGT, _ContractID.ToString2());
            }

            if (cols.Exists(&quot;Amount Paid&quot;))
            {
                cols.FromKey(&quot;Amount Paid&quot;).Width = 100;
                cols.FromKey(&quot;Amount Paid&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Amount Paid&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Amount Paid&quot;).Header.Caption = cols.FromKey(&quot;Amount Paid&quot;).Header.Caption + &quot; &quot; + &quot; in &quot; +
                                                             LocalizationManager.GetModuleCurrency(
                                                                 Constants.MODID_CONTMGT, _ContractID.ToString2());
                cols.FromKey(&quot;Amount Paid&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            }

            if (cols.Exists(&quot;Recovered Amount&quot;))
            {
                cols.FromKey(&quot;Recovered Amount&quot;).Width = 100;
                cols.FromKey(&quot;Recovered Amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;Recovered Amount&quot;).Header.Style.HorizontalAlign = HorizontalAlign.Right;

                //we do not need this as the field is renamed as part of customization. This piece of code adds extra &#39;in $&#39;                
                //cols.FromKey(&quot;Recovered Amount&quot;).Header.Caption = cols.FromKey(&quot;Recovered Amount&quot;).Header.Caption + &quot; &quot; +
                //                                                   &quot; in &quot; +
                //                                                  LocalizationManager.GetModuleCurrency(
                //                                                      Constants.MODID_CONTMGT, _ContractID.ToString2());
            }


            if (cols.Exists(&quot;PrepaymentTypeID&quot;))
            {
                cols.FromKey(&quot;PrepaymentTypeID&quot;).Hidden = true;
                if (cols.Exists(&quot;Recovery Amount&quot;))
                    cols.FromKey(&quot;Recovery Amount&quot;).Move(5);
            }
            else if (cols.Exists(&quot;Recovery Amount&quot;))
                cols.FromKey(&quot;Recovery Amount&quot;).Move(4);

            if (cols.Exists(&quot;PrepaymentType&quot;))
            {
                cols.FromKey(&quot;PrepaymentType&quot;).Header.Caption = &quot;Pre-Payment Type&quot;;
                cols.FromKey(&quot;PrepaymentType&quot;).Width = 125;
            }

            if (cols.Exists(&quot;Prepayment Type&quot;))
            {
                cols.FromKey(&quot;Prepayment Type&quot;).Header.Caption = &quot;Pre-Payment Type&quot;;
                cols.FromKey(&quot;Prepayment Type&quot;).Width = 125;
            }

            if (mode == &quot;P&quot;)
            {
                //Percentage Based Prepayment rule
                if (cols.Exists(&quot;Recovery Amount&quot;))
                {
                    cols.FromKey(&quot;Recovery Amount&quot;).Hidden = false;
                    cols.FromKey(&quot;Recovery Amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                }

                if (cols.Exists(&quot;PrepaymentValue&quot;))
                    cols.FromKey(&quot;PrepaymentValue&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE;

                if (cols.Exists(&quot;RecoveryValue&quot;))
                    cols.FromKey(&quot;RecoveryValue&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE;
            }
            else if (mode == &quot;A&quot;)
            {
                //Amount Based Prepayment rule
                if (cols.Exists(&quot;Recovery Amount&quot;))
                    cols.FromKey(&quot;Recovery Amount&quot;).Hidden = true;

                if (cols.Exists(&quot;PrepaymentValue&quot;))
                    cols.FromKey(&quot;PrepaymentValue&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;

                if (cols.Exists(&quot;RecoveryValue&quot;))
                    cols.FromKey(&quot;RecoveryValue&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
            }
            uwgPrepaymentTypes.DisplayLayout.AllowSortingDefault = AllowSorting.OnClient;

            #region Enabling or disabling controls based on permission

            if (editRecoveryDetails)
            {
                if (mode == &quot;A&quot;)
                {
                    if (mode == &quot;A&quot;) wneMaxAmount.Enabled = true;
                    wneMaxPercentage.Enabled = false;
                }
                else if (mode == &quot;P&quot;)
                {
                    if (mode == &quot;P&quot;) wneMaxPercentage.Enabled = true;
                    wneMaxAmount.Enabled = false;
                }
            }
            else
            {
                wneMaxPercentage.Enabled = false;
                wneMaxAmount.Enabled = false;
            }

            if (editRetentionDetails)
            {
                if (txtRetentionRule.Text != string.Empty) wneRetentionPercentage.Enabled = true;
                if (txtRetentionRule.Text != string.Empty) wneRetentionCeiling.Enabled = true;
            }
            else
            {
                wneRetentionCeiling.Enabled = false;
                wneRetentionPercentage.Enabled = false;
            }

            #endregion

            foreach (UltraGridColumn col in uwgPrepaymentTypes.Columns)
            {
                col.HTMLEncodeContent = true;
            }
        }

        private decimal CalculateRecoveryValueInEachRAB(string RecoveryValue, string prepaymentValue, string mode)
        {
            string contAmt = hdnTotalAmt.Value;
            decimal rabRecoveryValue = 0;

            if (mode == &quot;P&quot;)
            {
                decimal prepaymentAmt = decimal.Parse(prepaymentValue) / 100 * decimal.Parse(contAmt);
                rabRecoveryValue = (decimal.Parse(RecoveryValue) / 100 * prepaymentAmt);
            }
            return rabRecoveryValue;
        }

        private void PopulateDataTables()
        {
            //DataSet dsPrepaymentRecovery = BL.Instance.GetPrepaymentRecoveryRules(&quot;CONTMGT&quot;, _ContractID);
            //Populate Records from Library
            DataSet dsPrepaymentRecovery = BL.Instance.GetPrepaymentRecoveryRules(Constants.MODID_LIBRARY, 0);
            if (dsPrepaymentRecovery != null &amp;&amp; dsPrepaymentRecovery.Tables.Count &gt; 0)
            {
                if (dsPrepaymentRecovery.Tables[0].Rows.Count &gt; 0)
                {
                    dsPrepaymentRecovery.Tables[0].DefaultView.RowFilter = &quot;isActive=1&quot;;
                    dtRecovery = dsPrepaymentRecovery.Tables[0].DefaultView.ToTable();
                }
                else
                    dtRecovery = new BrixDataTable();

                dtPrepayment = (dsPrepaymentRecovery.Tables[1].Rows.Count &gt; 0)
                                   ? dsPrepaymentRecovery.Tables[1]
                                   : new BrixDataTable();
            }

            DataSet dsRetentionRule = BL.Instance.GetRetentionRules(Constants.MODID_LIBRARY, 0);
            if (dsRetentionRule != null &amp;&amp; dsRetentionRule.Tables.Count &gt; 0)
            {
                if (dsRetentionRule.Tables[0].Rows.Count &gt; 0)
                {
                    dsRetentionRule.Tables[0].DefaultView.RowFilter = &quot;isActive=1&quot;;
                    dtRetention = dsRetentionRule.Tables[0].DefaultView.ToTable();
                }
                else
                    dtRetention = new BrixDataTable();
            }
        }

        private void CalculateAmountOrPercentage(string mode)
        {
            if (mode == &quot;P&quot;)
                wneMaxAmount.Value =
                    (wneMaxPercentage.ValueDecimal / 100 * decimal.Parse(hdnTotalAmt.Value)).ToDecimal2().ToString(
                        AMP3ApplicationSettings.Instance.FORMAT_PERCENTAGE, CultureInfo.CurrentCulture);
            else
                wneMaxPercentage.Value =
                    (wneMaxAmount.ValueDecimal / decimal.Parse(hdnTotalAmt.Value) * 100).ToDecimal2().ToString(
                        AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, CultureInfo.CurrentCulture);
        }

        private void HideShowTB(string mode)
        {
            mode = (mode == &quot;&quot; ? &quot;Z&quot; : mode);
            ScriptManager.RegisterStartupScript(this, typeof(Page), &quot;HideShow&quot;, &quot;HideShowTB(&#39;&quot; + UIHelper.JavascriptEncode(mode) + &quot;&#39;);&quot;, true);
        }

        private BrixFilter[] GetRetentionFilters()
        {
            var filters = new BrixFilter[2];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Retention Rule Name :&quot;;
            filters[0].Name = &quot;RetentionRuleName&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Description :&quot;;
            filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        private BrixFilter[] GetPrepaymentFilters()
        {
            var filters = new BrixFilter[2];

            filters[0] = new BrixFilter();
            filters[0].Title = &quot;Pre-Payment Rule Name :&quot;;
            filters[0].Name = &quot;PrepaymentRuleName&quot;;
            filters[0].FilterType = BrixFilter.Type.Text;

            filters[1] = new BrixFilter();
            filters[1].Title = &quot;Description :&quot;;
            filters[1].Name = &quot;Description&quot;;
            filters[1].FilterType = BrixFilter.Type.Text;

            return filters;
        }

        #endregion

        #endregion

        #region &quot;ToolBar Menu&quot;

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();

            if (Request.QueryString[&quot;PageMode&quot;] == null)
                AddSaveButton(menus);
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));

            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += btnCancel_Click;
            if (Request.QueryString[&quot;PageMode&quot;] == null)
            {
                if (HasSaveButton)
                {
                    Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        lnkSave.Click += btnSave_Click;
                        if (_WorkflowsInitiated != null &amp;&amp; _WorkflowsInitiated.Count &gt; 0)
                            lnkSave.OnClientClick = &quot; DisableControlsOnSaveAndWFAction(&#39;&quot; + _WorkflowsInitiated[0].ToString() + &quot;&#39;); var  result= Validate(); if(!result){  EnableControlsOnSaveAndWFAction(&#39;&quot; + _WorkflowsInitiated[0].ToString() + &quot;&#39;);return false;} else return true;&quot;;
                            else
                        lnkSave.OnClientClick = &quot;return Validate();&quot;;
                    }
                }
            }
        }

        #endregion

        public override int GetProjectIdFromInstanceId()
        {
            if (!string.IsNullOrEmpty(Request[&quot;ContractID&quot;]))
                return BL.Instance.GetPIDFromContractId(Request[&quot;ContractID&quot;].ToInt32_2());
            else
                return -1;
        }
    }

    [CustomResourceType(&quot;Forms&quot;, &quot;XCONTTC&quot;)]
    public class PerformCTCOperation : FormsCustomResource
    {
        public PerformCTCOperation()
        {
            _Namespace = &quot;Forms&quot;;
            _Path = &quot;Forms.Contract.MB&quot;;
            _Name = &quot;Perform CTC Operation&quot;;
            _Desc = &quot;Perform CTC Operations&quot;;

            _InParameters = new[] { &quot;Operation,System.String&quot; };
            _OutParameters = new[] { &quot;IsSuccessful,System.Boolean&quot;, &quot;Reason,System.String&quot; };
        }

        public override void ExecuteDerived()
        {
            string operation = GetInputParam(&quot;Operation&quot;).ToString();
            string culture = GetInputParam(&quot;Culture&quot;).ToString();
            string uiCulture = GetInputParam(&quot;UICulture&quot;).ToString();
            Thread.CurrentThread.CurrentCulture = new CultureInfo(culture);
            Thread.CurrentThread.CurrentUICulture = new CultureInfo(uiCulture);

            try
            {
                switch (operation.ToUpper())
                {
                    case &quot;COMPLETE&quot;:
                        CTCComplete();
                        break;
                    case &quot;VALIDATEAPPROVE&quot;:
                        CTCValidateApprove();
                        break;
                    case &quot;APPROVE&quot;:
                        CTCApprove();
                        break;
                    case &quot;REDRAFT&quot;:
                        CTCReDraft();
                        break;
                }
            }
            catch (Exception ex)
            {
                SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Reason&quot;, ex.Message, &quot;System.string&quot;);
                throw ex;
            }
        }

        private void CTCComplete()
        {
            //ContTermCondDTO ContTermDTO = BL.Instance.GetContractTermDetails(InstanceId.ToInt32_2());
            //ContTermDTO.Status = 2;
            //ContTermDTO.Mode = &quot;E&quot;;

            int result = BL.Instance.UpdateTermsAndConditions(InstanceId.ToInt32_2(), &quot;C&quot;, null, null);
            if (result == 0)
                SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
            else
                SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
        }

        private void CTCValidateApprove()
        {
            int currentuserid = GetInputParam(&quot;_currentuserid&quot;).ToInt32_2();
            string selCTID = InstanceId;
            if (!String.IsNullOrEmpty(selCTID))
            {
                int CTID = 0;
                int.TryParse(selCTID, out CTID);

                int isApproved = BL.Instance.ValidateUpdateTermsAndConditions(CTID, &quot;A&quot;, currentuserid, DateTime.UtcNow);

                if (isApproved == -2)
                    throw new Exception(&quot;One or more &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) +
                                        &quot; exist. Request denied.&quot;);
                else if (isApproved == -1)
                    throw new Exception(&quot;The contractual term may have been deleted by another user.&quot;);
                else
                {
                    SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
                    SetOutParam(&quot;Message&quot;, &quot;Approved Sucessfully&quot;, &quot;System.String&quot;);
                }
            }
        }

        private void CTCApprove()
        {
            int currentuserid = GetInputParam(&quot;_currentuserid&quot;).ToInt32_2();
            string selCTID = InstanceId;
            if (!String.IsNullOrEmpty(selCTID))
            {
                int CTID = 0;
                int.TryParse(selCTID, out CTID);

                int isApproved = BL.Instance.UpdateTermsAndConditions(CTID, &quot;A&quot;, currentuserid, DateTime.UtcNow);

                if (isApproved == 0)
                    SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
                else if (isApproved == -2)
                    throw new Exception(&quot;One or more &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) +
                                        &quot; exist. Request denied.&quot;);
                else if (isApproved == -1)
                    throw new Exception(&quot;The contractual term may have been deleted by another user.&quot;);
                else
                    SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
            }
        }

        private void CTCReDraft()
        {
            //int currentuserid = GetInputParam(&quot;_currentuserid&quot;).ToInt32_2();
            string selCTID = InstanceId;
            if (!String.IsNullOrEmpty(selCTID))
            {
                int CTID = 0;
                int.TryParse(selCTID, out CTID);
                //ContTermCondDTO ContTermDTO = BL.Instance.GetContractTermDetails(CTID);
                //if (ContTermDTO == null)
                //throw new Exception(&quot;The contractual term may have been deleted by another user.&quot;);
                //ContTermDTO.CreatedBy = currentuserid;
                //ContTermDTO.CreatedOn = DateTime.UtcNow;
                //ContTermDTO.Mode = &quot;E&quot;;
                //ContTermDTO.Status = 1;

                int isRejected = BL.Instance.UpdateTermsAndConditions(CTID, &quot;R&quot;, null, null);
                if (isRejected == 0)
                    SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
                else
                    SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[46,9,46,43,1],[53,9,53,49,1],[54,9,54,50,1],[58,9,58,61,1],[65,17,65,18,0],[65,19,65,95,0],[65,96,65,97,0],[73,17,73,18,0],[73,19,73,77,0],[73,78,73,79,0],[81,17,81,18,1],[81,19,81,80,1],[81,81,81,82,1],[89,9,89,10,0],[90,13,90,49,0],[96,13,96,14,1],[97,17,97,29,1],[98,17,100,77,1],[101,21,101,29,1],[103,17,103,18,1],[104,21,104,89,1],[105,21,105,44,1],[106,17,106,18,1],[108,17,108,39,1],[109,13,109,14,1],[112,37,112,38,1],[112,39,112,88,1],[112,89,112,90,1],[112,95,112,96,0],[112,97,112,118,0],[112,119,112,120,0],[117,17,117,18,1],[117,19,117,36,1],[117,37,117,38,1],[122,17,122,18,1],[122,19,122,39,1],[122,40,122,41,1],[127,17,127,18,0],[127,19,127,31,0],[127,32,127,33,0],[132,17,132,18,1],[132,19,132,65,1],[132,66,132,67,1],[138,13,138,14,1],[139,17,141,98,1],[142,17,142,27,1],[143,13,143,14,1],[149,13,149,14,0],[150,17,152,54,0],[153,13,153,14,0],[157,9,157,10,1],[158,13,160,50,1],[161,9,161,10,1],[165,9,165,10,1],[166,13,166,38,1],[167,13,167,26,1],[168,13,168,30,1],[169,13,169,56,1],[170,13,170,60,1],[171,17,171,29,1],[173,17,173,30,0],[174,9,174,10,1],[179,9,179,10,1],[180,13,180,75,1],[182,13,182,31,1],[183,13,183,14,1],[185,17,185,52,1],[186,13,186,14,1],[187,18,187,67,1],[188,13,188,14,1],[190,17,190,50,1],[191,13,191,14,1],[193,13,193,14,1],[195,17,195,50,1],[196,13,196,14,1],[202,13,202,77,1],[203,13,203,49,1],[204,13,204,51,1],[205,13,205,78,1],[206,13,206,88,1],[207,13,207,72,1],[208,13,208,85,1],[209,13,209,62,1],[210,13,210,63,1],[212,13,212,98,1],[213,13,213,96,1],[214,13,214,104,1],[215,13,215,102,1],[216,13,216,93,1],[217,13,217,93,1],[218,13,218,96,1],[220,13,221,73,1],[222,13,222,121,1],[228,13,228,75,1],[229,13,229,48,1],[230,13,230,50,1],[231,13,231,76,1],[232,13,232,86,1],[233,13,233,70,1],[234,13,234,84,1],[235,13,235,60,1],[236,13,236,61,1],[238,13,238,98,1],[239,13,239,95,1],[240,13,240,103,1],[241,13,241,107,1],[242,13,242,108,1],[243,13,243,92,1],[244,13,244,95,1],[246,13,247,75,1],[248,13,249,76,1],[250,13,251,79,1],[255,13,255,138,1],[256,13,257,122,1],[259,13,259,28,1],[260,9,260,10,1],[263,9,263,10,1],[264,13,264,31,1],[265,13,265,56,1],[266,13,266,14,1],[268,17,268,18,1],[269,21,270,133,1],[271,21,271,46,1],[272,21,275,40,1],[276,17,276,18,1],[277,17,277,22,0],[278,17,278,18,0],[279,21,279,32,0],[280,17,280,18,0],[281,13,281,14,1],[282,13,282,30,1],[284,9,284,10,1],[287,9,287,10,1],[288,13,288,73,1],[289,13,289,75,1],[290,13,290,32,1],[291,17,291,77,1],[292,13,293,75,1],[294,13,294,31,1],[295,17,295,49,1],[296,13,296,34,1],[297,13,297,29,1],[298,13,298,14,1],[299,17,299,96,1],[300,17,300,35,1],[301,17,301,18,1],[302,21,302,136,1],[303,21,303,140,1],[304,21,304,134,1],[305,17,305,18,1],[306,17,306,65,1],[309,17,309,36,1],[310,17,310,18,1],[312,21,312,55,1],[313,17,313,18,1],[315,17,315,18,1],[316,21,316,62,1],[317,21,317,70,1],[318,21,318,51,1],[319,21,319,67,1],[320,17,320,18,1],[321,13,321,14,1],[323,13,323,31,1],[324,13,324,14,1],[326,17,326,68,1],[327,17,327,111,1],[328,13,328,14,1],[329,18,329,67,1],[330,13,330,14,1],[331,17,331,69,1],[332,17,333,60,1],[334,17,334,35,1],[335,13,335,14,1],[337,13,337,14,1],[338,17,338,69,1],[339,17,339,36,1],[340,13,340,14,1],[342,13,342,120,1],[343,13,343,51,1],[344,13,344,14,1],[345,17,345,55,1],[346,13,346,14,1],[348,13,348,50,1],[349,13,349,14,1],[350,17,350,53,1],[351,13,351,14,1],[353,13,353,42,1],[354,17,354,80,1],[356,13,356,60,1],[356,60,356,99,1],[356,99,356,101,1],[356,13,356,101,1],[357,17,357,45,0],[359,17,359,44,1],[362,13,362,72,1],[363,9,363,10,1],[366,9,366,10,1],[367,13,367,66,1],[368,13,378,58,1],[379,13,379,37,1],[380,9,380,10,1],[383,9,383,10,1],[384,13,384,91,1],[386,13,386,37,1],[387,13,387,14,0],[388,17,388,24,0],[391,13,391,64,1],[392,13,392,59,1],[393,13,393,47,1],[394,13,394,45,1],[395,13,397,47,1],[399,13,399,76,1],[400,13,400,82,1],[401,13,401,71,1],[402,13,402,42,1],[403,13,404,119,1],[406,13,406,83,1],[407,13,407,67,1],[408,13,408,65,1],[412,13,412,99,1],[417,13,417,40,1],[418,13,418,96,1],[419,13,419,14,1],[422,17,422,37,1],[423,17,423,61,1],[424,17,427,36,1],[428,17,431,135,1],[432,17,436,131,1],[438,17,438,78,1],[440,17,440,69,1],[446,17,446,59,1],[447,17,447,79,1],[448,17,448,77,1],[449,17,449,75,1],[450,17,450,80,1],[452,17,452,73,1],[453,17,453,149,1],[454,17,454,24,1],[454,26,454,36,1],[454,37,454,39,1],[454,40,454,52,1],[455,17,455,18,1],[456,21,459,137,1],[460,21,460,22,1],[461,21,462,114,1],[463,21,464,119,1],[465,17,465,18,1],[466,17,466,41,1],[467,17,467,57,1],[468,17,468,47,1],[470,17,470,49,1],[471,17,471,34,1],[474,13,474,14,1],[475,13,475,55,1],[476,13,476,14,1],[479,17,479,62,1],[480,17,483,36,1],[484,17,488,122,1],[489,17,491,114,1],[492,17,495,63,1],[497,17,497,79,1],[499,17,499,72,1],[502,13,502,14,1],[503,13,503,27,1],[504,13,504,14,1],[506,17,506,41,1],[507,13,507,14,1],[508,13,508,41,1],[509,13,509,14,1],[510,17,510,87,1],[511,17,511,97,1],[512,17,512,44,1],[513,17,514,60,1],[515,17,515,32,1],[516,17,516,18,1],[517,21,520,64,1],[521,21,521,39,1],[522,17,522,18,1],[524,17,524,18,1],[525,21,526,63,1],[527,21,527,50,1],[528,21,528,40,1],[529,17,529,18,1],[530,13,530,14,1],[532,13,532,14,1],[533,17,533,46,1],[534,13,534,14,1],[537,9,537,10,1],[540,9,540,10,1],[541,13,541,42,1],[542,9,542,10,0],[545,9,545,10,1],[548,13,548,103,1],[549,13,549,14,0],[550,17,550,121,0],[555,13,555,39,1],[556,13,557,92,1],[558,13,558,14,1],[559,17,559,57,1],[560,17,560,35,1],[561,21,561,58,1],[563,21,563,65,1],[564,17,564,54,1],[565,17,565,49,1],[566,17,566,63,1],[567,17,567,51,1],[568,17,568,118,1],[570,17,570,79,1],[571,17,571,70,1],[572,17,572,75,1],[573,17,573,84,1],[577,17,577,62,1],[578,17,578,36,1],[579,17,579,46,1],[580,17,580,83,1],[583,17,583,34,1],[584,17,584,18,1],[585,21,585,93,1],[586,21,586,28,1],[586,30,586,46,1],[586,47,586,49,1],[586,50,586,87,1],[587,21,587,22,1],[588,25,588,91,1],[589,25,592,98,1],[593,25,593,80,1],[594,25,594,120,1],[596,25,597,93,1],[598,25,599,86,1],[600,25,601,91,1],[603,25,603,38,1],[604,21,604,22,1],[607,21,609,113,1],[610,21,610,63,1],[611,21,611,98,1],[613,21,613,52,1],[614,21,614,22,1],[615,25,615,139,1],[616,25,616,53,1],[617,25,617,26,1],[618,29,618,106,1],[619,29,619,96,1],[620,29,623,82,1],[624,29,627,71,1],[628,25,628,26,1],[629,25,631,111,1],[632,21,632,22,1],[633,17,633,18,1],[634,17,634,61,1],[636,17,636,49,1],[637,17,637,18,1],[638,21,638,136,1],[640,21,640,49,1],[641,21,641,22,1],[642,25,644,118,1],[645,25,645,106,1],[646,25,646,94,1],[647,25,647,95,1],[648,25,652,75,1],[653,25,653,96,1],[654,25,656,103,1],[657,21,657,22,1],[658,17,658,18,1],[662,17,662,64,1],[663,17,663,51,1],[664,17,664,97,1],[665,17,665,18,1],[666,21,666,58,1],[668,21,668,101,1],[669,21,669,22,0],[670,25,671,262,0],[672,21,672,22,0],[673,17,673,18,1],[674,13,674,14,1],[676,13,676,14,0],[677,17,677,50,0],[678,13,678,14,0],[681,9,681,10,1],[684,9,684,10,1],[686,13,686,14,1],[687,17,687,82,1],[688,17,688,92,1],[689,17,696,112,1],[698,13,698,18,0],[699,13,699,14,0],[700,17,700,30,0],[702,9,702,10,1],[705,9,705,10,1],[706,13,707,170,1],[708,9,708,10,0],[711,9,711,10,1],[712,13,712,80,1],[713,13,713,78,1],[714,13,714,66,1],[716,13,716,38,1],[717,13,717,60,1],[718,13,718,58,1],[719,13,719,43,1],[720,13,720,34,1],[720,35,720,71,1],[721,13,721,33,1],[721,34,721,68,1],[722,13,726,81,1],[728,13,728,29,1],[732,21,732,49,1],[733,21,733,27,1],[735,21,735,48,1],[736,21,736,27,1],[738,9,738,10,1],[741,9,741,10,1],[742,13,744,43,1],[745,13,745,45,1],[748,13,748,65,1],[749,13,749,23,1],[750,13,750,14,1],[751,17,751,52,1],[751,53,751,114,1],[752,17,752,50,1],[752,51,752,110,1],[753,17,753,49,1],[753,50,753,108,1],[754,17,754,52,1],[755,21,755,93,1],[756,17,756,50,1],[756,51,756,121,1],[757,17,757,49,1],[757,50,757,119,1],[758,13,758,14,1],[760,13,760,14,1],[761,17,761,52,1],[761,53,761,115,1],[762,17,762,50,1],[762,51,762,111,1],[763,17,763,49,1],[763,50,763,109,1],[764,17,764,52,1],[764,53,764,120,1],[765,17,765,50,1],[765,51,765,116,1],[766,17,766,49,1],[766,50,766,114,1],[767,13,767,14,1],[769,13,769,42,1],[770,9,770,10,1],[773,9,773,10,1],[774,13,776,80,1],[777,13,778,75,1],[779,13,782,119,1],[783,9,783,10,1],[786,9,786,10,1],[787,13,787,43,1],[788,13,788,40,1],[789,13,789,43,1],[790,13,790,47,1],[791,13,791,40,1],[792,9,792,10,1],[800,9,800,10,1],[801,13,801,38,1],[802,13,802,65,1],[803,13,803,47,1],[804,13,804,14,0],[805,17,805,119,0],[806,17,806,45,0],[807,17,807,37,0],[808,17,811,63,0],[812,17,814,122,0],[816,17,816,18,0],[818,21,820,138,0],[821,17,821,18,0],[822,17,822,22,0],[823,17,823,18,0],[824,17,824,18,0],[825,13,825,14,0],[827,13,827,14,1],[828,17,828,57,1],[829,13,829,14,1],[830,13,830,76,1],[831,18,831,27,1],[831,29,831,63,1],[831,65,831,68,1],[832,13,832,14,1],[833,17,834,86,1],[835,21,837,119,1],[839,21,842,113,1],[843,13,843,14,1],[844,13,844,49,1],[845,13,845,54,1],[846,13,846,99,1],[847,9,847,10,1],[850,9,850,10,0],[851,13,851,46,0],[852,9,852,10,0],[855,9,855,10,1],[856,13,856,40,1],[857,13,857,42,1],[858,13,858,83,1],[859,13,859,40,1],[861,13,861,27,1],[862,13,862,14,0],[863,17,863,103,0],[864,17,864,34,0],[865,21,865,42,0],[867,21,867,43,0],[868,13,868,14,0],[870,17,870,38,1],[872,13,872,31,1],[873,13,873,14,1],[874,17,874,81,1],[875,17,875,57,1],[876,17,879,36,1],[880,17,880,142,1],[881,17,885,135,1],[886,17,890,131,1],[891,17,891,98,1],[893,17,893,51,1],[894,17,894,34,1],[896,17,896,58,1],[897,17,897,48,1],[901,17,901,27,1],[902,17,902,24,1],[902,26,902,37,1],[902,38,902,40,1],[902,41,902,58,1],[903,17,903,18,1],[904,21,904,69,1],[905,21,905,22,1],[906,25,906,29,1],[907,25,907,63,1],[908,25,908,39,1],[909,25,909,69,1],[910,25,912,91,1],[913,25,915,82,1],[916,25,919,131,1],[920,25,920,65,1],[921,25,922,119,1],[923,25,925,36,1],[926,25,926,54,1],[927,25,927,58,1],[928,21,928,22,1],[929,17,929,18,1],[930,17,930,50,1],[931,17,931,66,1],[932,17,932,47,1],[934,17,934,49,1],[936,17,936,50,1],[937,13,937,14,1],[939,17,941,63,0],[942,9,942,10,1],[946,9,946,10,1],[947,13,947,38,1],[949,13,949,115,1],[950,13,950,64,1],[951,13,951,32,1],[952,13,952,14,0],[953,17,953,119,0],[954,17,954,45,0],[955,17,955,37,0],[956,17,959,63,0],[960,17,962,122,0],[964,17,964,18,0],[966,21,968,139,0],[969,17,969,18,0],[970,17,970,22,0],[971,17,971,18,0],[972,17,972,18,0],[973,13,973,14,0],[975,13,975,14,1],[976,17,976,57,1],[977,13,977,14,1],[978,13,978,76,1],[979,18,979,27,1],[979,29,979,62,1],[979,64,979,67,1],[980,13,980,14,1],[981,17,982,91,1],[983,21,985,116,1],[987,21,990,113,0],[991,17,993,105,1],[994,13,994,14,1],[995,13,995,48,1],[996,13,996,53,1],[997,13,997,98,1],[998,9,998,10,1],[1001,9,1001,10,0],[1002,13,1002,46,0],[1003,9,1003,10,0],[1006,9,1006,10,1],[1007,13,1007,40,1],[1008,13,1008,85,1],[1009,13,1009,80,1],[1010,13,1010,36,1],[1012,13,1015,32,1],[1016,13,1020,118,1],[1021,13,1024,133,1],[1025,13,1029,78,1],[1030,13,1030,94,1],[1032,13,1032,48,1],[1034,13,1034,46,1],[1035,13,1035,30,1],[1036,9,1036,10,1],[1039,9,1039,10,1],[1040,13,1040,52,1],[1041,13,1041,72,1],[1042,13,1042,69,1],[1043,9,1043,10,1],[1046,9,1046,10,1],[1047,13,1047,51,1],[1048,13,1048,70,1],[1049,13,1049,67,1],[1050,9,1050,10,1],[1057,9,1057,10,1],[1061,13,1061,65,1],[1063,13,1063,37,1],[1064,17,1064,49,1],[1066,13,1066,48,1],[1067,13,1067,14,1],[1068,17,1070,99,1],[1071,17,1071,61,1],[1072,17,1072,99,1],[1073,17,1073,102,1],[1074,17,1080,103,1],[1082,17,1082,118,1],[1083,17,1085,95,1],[1086,13,1086,14,1],[1087,13,1087,46,1],[1088,13,1088,14,1],[1089,17,1089,122,1],[1090,17,1090,59,1],[1091,17,1091,97,1],[1092,17,1092,100,1],[1093,17,1099,101,1],[1102,17,1102,116,1],[1103,17,1105,93,1],[1106,13,1106,14,1],[1107,13,1107,45,1],[1108,13,1108,14,1],[1109,17,1109,60,1],[1110,17,1111,108,1],[1112,17,1112,58,1],[1114,17,1114,115,1],[1115,17,1117,92,1],[1118,13,1118,14,1],[1119,13,1119,48,1],[1120,13,1120,14,1],[1121,17,1121,61,1],[1122,17,1122,99,1],[1123,17,1123,102,1],[1124,17,1127,120,1],[1128,13,1128,14,1],[1130,13,1130,44,1],[1131,13,1131,14,1],[1132,17,1132,57,1],[1133,17,1133,95,1],[1134,17,1134,98,1],[1135,17,1137,116,1],[1138,17,1138,101,1],[1139,13,1139,14,1],[1141,13,1141,49,1],[1142,13,1142,14,1],[1143,17,1143,62,1],[1144,17,1144,100,1],[1145,17,1145,103,1],[1152,13,1152,14,1],[1155,13,1155,49,1],[1156,13,1156,14,1],[1157,17,1157,64,1],[1158,17,1158,52,1],[1159,21,1159,61,1],[1160,13,1160,14,1],[1161,18,1161,53,1],[1162,17,1162,57,1],[1164,13,1164,47,1],[1165,13,1165,14,1],[1166,17,1166,84,1],[1167,17,1167,60,1],[1168,13,1168,14,1],[1170,13,1170,48,1],[1171,13,1171,14,0],[1172,17,1172,85,0],[1173,17,1173,61,0],[1174,13,1174,14,0],[1176,13,1176,29,1],[1177,13,1177,14,1],[1179,17,1179,52,1],[1180,17,1180,18,1],[1181,21,1181,68,1],[1182,21,1182,109,1],[1183,17,1183,18,1],[1185,17,1185,52,1],[1186,21,1186,113,1],[1188,17,1188,50,1],[1189,21,1189,111,1],[1190,13,1190,14,1],[1191,18,1191,34,1],[1192,13,1192,14,1],[1194,17,1194,52,1],[1195,21,1195,67,1],[1197,17,1197,52,1],[1198,21,1198,109,1],[1200,17,1200,50,1],[1201,21,1201,107,1],[1202,13,1202,14,1],[1203,13,1203,90,1],[1207,13,1207,37,1],[1208,13,1208,14,1],[1209,17,1209,33,1],[1210,17,1210,18,1],[1211,21,1211,37,1],[1211,38,1211,66,1],[1212,21,1212,54,1],[1213,17,1213,18,1],[1214,22,1214,38,1],[1215,17,1215,18,1],[1216,21,1216,37,1],[1216,38,1216,70,1],[1217,21,1217,50,1],[1218,17,1218,18,1],[1219,13,1219,14,1],[1221,13,1221,14,0],[1222,17,1222,50,0],[1223,17,1223,46,0],[1224,13,1224,14,0],[1226,13,1226,38,1],[1227,13,1227,14,1],[1228,17,1228,59,1],[1228,60,1228,98,0],[1229,17,1229,59,1],[1229,60,1229,95,0],[1230,13,1230,14,1],[1232,13,1232,14,0],[1233,17,1233,53,0],[1234,17,1234,56,0],[1235,13,1235,14,0],[1239,13,1239,20,1],[1239,22,1239,41,1],[1239,42,1239,44,1],[1239,45,1239,71,1],[1240,13,1240,14,1],[1241,17,1241,46,1],[1242,13,1242,14,1],[1243,9,1243,10,1],[1246,9,1246,10,1],[1247,13,1247,48,1],[1248,13,1248,42,1],[1250,13,1250,29,1],[1251,13,1251,14,1],[1252,17,1252,103,1],[1253,17,1253,89,1],[1254,13,1254,14,1],[1255,13,1255,37,1],[1256,9,1256,10,1],[1259,9,1259,10,1],[1262,13,1262,111,1],[1263,13,1263,87,1],[1264,13,1264,14,1],[1265,17,1265,67,1],[1266,17,1266,18,1],[1267,21,1267,89,1],[1268,21,1268,87,1],[1269,17,1269,18,1],[1271,21,1271,54,0],[1273,17,1275,58,1],[1276,13,1276,14,1],[1278,13,1278,97,1],[1279,13,1279,77,1],[1280,13,1280,14,1],[1281,17,1281,62,1],[1282,17,1282,18,1],[1283,21,1283,84,1],[1284,21,1284,83,1],[1285,17,1285,18,1],[1287,21,1287,55,0],[1288,13,1288,14,1],[1289,9,1289,10,1],[1292,9,1292,10,1],[1293,13,1293,29,1],[1294,17,1296,105,1],[1298,17,1300,101,1],[1301,9,1301,10,1],[1304,9,1304,10,1],[1305,13,1305,46,1],[1306,13,1306,145,1],[1307,9,1307,10,1],[1310,9,1310,10,1],[1311,13,1311,45,1],[1313,13,1313,43,1],[1314,13,1314,56,1],[1315,13,1315,51,1],[1316,13,1316,58,1],[1318,13,1318,43,1],[1319,13,1319,48,1],[1320,13,1320,45,1],[1321,13,1321,58,1],[1323,13,1323,28,1],[1324,9,1324,10,1],[1327,9,1327,10,1],[1328,13,1328,45,1],[1330,13,1330,43,1],[1331,13,1331,58,1],[1332,13,1332,52,1],[1333,13,1333,58,1],[1335,13,1335,43,1],[1336,13,1336,48,1],[1337,13,1337,45,1],[1338,13,1338,58,1],[1340,13,1340,28,1],[1341,9,1341,10,1],[1350,9,1350,10,1],[1351,13,1351,41,1],[1353,13,1353,57,1],[1354,17,1354,38,1],[1355,13,1355,82,1],[1357,13,1357,44,1],[1358,9,1358,10,1],[1361,9,1361,10,1],[1362,13,1362,80,1],[1363,13,1363,57,1],[1364,13,1364,14,1],[1365,17,1365,35,1],[1366,17,1366,18,1],[1367,21,1367,82,1],[1368,21,1368,41,1],[1369,21,1369,22,1],[1370,25,1370,56,1],[1371,25,1371,90,1],[1372,29,1372,284,1],[1374,25,1374,70,0],[1375,21,1375,22,1],[1376,17,1376,18,1],[1377,13,1377,14,1],[1378,9,1378,10,1],[1383,9,1383,10,1],[1384,13,1384,62,1],[1385,17,1385,92,1],[1387,17,1387,27,0],[1388,9,1388,10,1],[1394,9,1394,37,1],[1395,9,1395,10,1],[1396,13,1396,34,1],[1397,13,1397,41,1],[1398,13,1398,45,1],[1399,13,1399,46,1],[1401,13,1401,65,1],[1402,13,1402,94,1],[1403,9,1403,10,1],[1406,9,1406,10,1],[1407,13,1407,70,1],[1408,13,1408,66,1],[1409,13,1409,70,1],[1410,13,1410,76,1],[1411,13,1411,80,1],[1414,13,1414,14,1],[1415,17,1415,45,1],[1418,25,1418,39,1],[1419,25,1419,31,1],[1421,25,1421,46,0],[1422,25,1422,31,0],[1424,25,1424,38,1],[1425,25,1425,31,1],[1427,25,1427,38,1],[1428,25,1428,31,1],[1430,13,1430,14,1],[1431,13,1431,33,0],[1432,13,1432,14,0],[1433,17,1433,70,0],[1434,17,1434,68,0],[1435,17,1435,26,0],[1437,9,1437,10,1],[1440,9,1440,10,1],[1445,13,1445,104,1],[1446,13,1446,29,1],[1447,17,1447,69,1],[1449,17,1449,70,0],[1450,9,1450,10,1],[1453,9,1453,10,0],[1454,13,1454,77,0],[1455,13,1455,41,0],[1456,13,1456,48,0],[1457,13,1457,14,0],[1458,17,1458,30,0],[1459,17,1459,49,0],[1461,17,1461,122,0],[1463,17,1463,38,0],[1464,21,1465,68,0],[1466,22,1466,43,0],[1467,21,1467,104,0],[1469,17,1469,18,0],[1470,21,1470,73,0],[1471,21,1471,85,0],[1472,17,1472,18,0],[1473,13,1473,14,0],[1474,9,1474,10,0],[1477,9,1477,10,1],[1478,13,1478,77,1],[1479,13,1479,41,1],[1480,13,1480,48,1],[1481,13,1481,14,1],[1482,17,1482,30,1],[1483,17,1483,49,1],[1485,17,1485,114,1],[1487,17,1487,37,1],[1488,21,1488,73,1],[1489,22,1489,43,0],[1490,21,1491,68,0],[1492,22,1492,43,0],[1493,21,1493,104,0],[1495,21,1495,74,0],[1496,13,1496,14,1],[1497,9,1497,10,1],[1500,9,1500,10,1],[1502,13,1502,41,1],[1503,13,1503,48,1],[1504,13,1504,14,1],[1505,17,1505,30,1],[1506,17,1506,49,1],[1515,17,1515,94,1],[1516,17,1516,37,1],[1517,21,1517,73,1],[1519,21,1519,74,0],[1520,13,1520,14,1],[1521,9,1521,10,1]]);
    </script>
  </body>
</html>