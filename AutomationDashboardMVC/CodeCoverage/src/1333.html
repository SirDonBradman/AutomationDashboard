<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Common\BrixReportPage.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.Configuration;
using System.Web.Script.Serialization;
using System.Web.UI;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.BusinessLayer.DTO;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.UserControls;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using DataDynamics.ActiveReports;
using DataDynamics.ActiveReports.Web;
using Infragistics.WebUI.UltraWebGrid;
using Telerik.Web.UI;

namespace Aurigo.AMP3.Core
{
    public partial class BrixReportPage : BrixPageBase
    {
        public global::Aurigo.Brix.Platform.BusinessLayer.CustomControls.GroupDropDownList ddlContractors;

        #region &quot;Class Variables&quot;

        public int pageno
        {
            get { return (int)ViewState[&quot;pageno&quot;]; }
            set { ViewState[&quot;pageno&quot;] = value; }
        }

        protected UltraWebGrid brixGrid;
        private string context;
        private ItemPickerControl itemPicker;
        protected PagerControl mypager;
        private StateManagementBase pageState;
        protected ReportModel reportModel;
        private BrixFormModel xmlmodel;
        private XMLFormManagerModel managerModel;

        private int PageSize
        {
            get { return brixGrid.DisplayLayout.Pager.PageSize; }
        }

        #endregion

        #region &quot;Overriden Functions&quot;

        protected override void CreateChildControls()
        {
            try
            {
                InSiteCore master = (InSiteCore)this.Master;
                if (MainToolBar == null) master.SetMainToolbar();
                base.OnInit(null);
                base.CreateChildControls();

                // create the child controls if the server control does not contains child controls
                EnsureChildControls();

                // Creates a new ControlCollection. 
                CreateControlCollection();

                var menus = new MenuArray();
                //--[Get FeaturesList]
                menus.Add(new BrixMenu(&quot;lnkHtml&quot;, &quot;HTML&quot;, &quot;IcnHtml.png&quot;, 55));
                //menus.Add(new BrixMenu(&quot;lnkRawHtml&quot;, &quot;Raw Html&quot;, &quot;IcnView.png&quot;, 55));
                //menus.Add(new BrixMenu(&quot;lnkActiveX&quot;, &quot;ActiveX Viewer&quot;, &quot;IcnView.png&quot;, 55));
                menus.Add(new BrixMenu(&quot;lnkPDF&quot;, &quot;PDF&quot;, &quot;IcnPdf.png&quot;, 55)); //Icn_viewPDF.gif
                menus.Add(new BrixMenu(&quot;lnkBack&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;, 55));
                CreateToolBarMenu(menus, null);

                if (string.IsNullOrEmpty(Request[&quot;XMLReport&quot;]))
                {
                    // Generate report
                    if (!reportModel.HasFilter)
                    {
                        tblFilter.Style.Value = &quot;display:none;&quot;;
                        ifrmReport.Style.Value = &quot;display:none;&quot;;
                        if (reportModel.HasGrid &amp;&amp; !Page.IsPostBack)
                        {
                            tblChngOrder.Style.Value = &quot;display:table;&quot;;
                            pageState = new StateManagementBase(context);
                            UIHelper.UpdateModuleStateBag(context, pageState, Context);
                            pageState.FilterCriterion = reportModel.FilterCriterion(null);
                            BindGridControl();
                        }
                        else
                        {
                            if (!Page.IsPostBack)
                            {
                                GenerateReportByFilter(string.Empty);
                            }
                        }
                    }
                    else
                    {
                        if (reportModel.HasItemPicker)
                            tblItemPicker.Style.Value = &quot;display:table;&quot;;
                        if (reportModel.HasStaticFilter)
                            tblStaticFilter.Style.Value = &quot;display:table;&quot;;
                        if (!reportModel.HasFilter)
                            tblFilter.Style.Add(&quot;display&quot;, &quot;none&quot;);
                    }

                    // Create filter controls
                    CreateControls();

                    InitSortAndFilter();
                    if (!Page.IsPostBack &amp;&amp; reportModel.HasGrid)
                    {
                        brixGrid.Visible = true;
                        if (!string.IsNullOrEmpty(pageState.SortKey))
                            ApplySort(pageState.SortKey, pageState.SortOrder, false);
                    }
                }
                else
                {
                    tblFilter.Style.Value = &quot;display:none;&quot;;
                    ifrmReport.Style.Value = &quot;width: 100%; height: 100%;display:block;&quot;;
                    ifrmReport.Attributes.Add(&quot;src&quot;, &quot;GenerateReport.aspx&quot;);
                }

                // Prevent child controls from being created again.
                ChildControlsCreated = true;
            }
            catch
            {
            }
        }

        protected override void CustomizeToolBar()
        {
            if (MainToolBar.GetMenuReference(&quot;lnkBack&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).Click += lnkBack_Click;

            if (MainToolBar.GetMenuReference(&quot;lnkHtml&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkHtml&quot;).Click += Viewer_Click;
            //if (MainToolBar.GetMenuReference(&quot;lnkRawHtml&quot;) != null)
            //    MainToolBar.GetMenuReference(&quot;lnkRawHtml&quot;).Click += Viewer_Click;
            //if (MainToolBar.GetMenuReference(&quot;lnkActiveX&quot;) != null)
            //    MainToolBar.GetMenuReference(&quot;lnkActiveX&quot;).Click += Viewer_Click;
            if (MainToolBar.GetMenuReference(&quot;lnkPDF&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkPDF&quot;).Click += Viewer_Click;
        }


        protected override void OnPreInit(EventArgs e)
        {
            if (string.IsNullOrEmpty(Request[&quot;XMLReport&quot;]))
            {
                reportModel = SetReportModel();

                if (reportModel == null)
                {
                    //TODO: Display approrinate message
                    UIHelper.RedirectURL(
                        MessageResourceManager.GetString(&quot;Default&quot;, Enumerations.MessageType.ErrorMessage),
                        ResolveUrl(Constants.URL_ENTERPRISE), null, Context);

                    return;
                }
                ModuleId = reportModel.ModuleID;
            }
            else
            {
                if (!string.IsNullOrEmpty(Request[&quot;xContext&quot;]) &amp;&amp; Request[&quot;xContext&quot;] == &quot;FAVMGMT&quot;)
                    ModuleId = Request[&quot;xContext&quot;];
                else
                    ModuleId = string.IsNullOrEmpty(Request[&quot;Module&quot;])
                        ? ((Request.QueryString[&quot;PID&quot;] == &quot;0&quot;)
                            ? &quot;LANDMGT&quot;
                            : Request[&quot;xContext&quot;])
                        : Request[&quot;Module&quot;];

                xmlmodel = BrixFormModel.GetInstance((Request[&quot;xContext&quot;] ?? Request[&quot;Context&quot;]),
                    Request[&quot;module&quot;], Request, Response);

                if (!string.IsNullOrEmpty(xmlmodel.form.ManagerDLL) &amp;&amp;
                    !string.IsNullOrEmpty(xmlmodel.form.FormManagerClass))
                    managerModel = AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(xmlmodel.form.ManagerDLL,
                        xmlmodel.form.FormManagerClass);

                var formEvent = new XmlFormArgs();
                if (managerModel != null) managerModel.OnPreInit(xmlmodel, formEvent);
            }

            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            if (string.IsNullOrEmpty(Request[&quot;XMLReport&quot;]))
            {
                (mypager).ItemClicked += HandlePagerEvent;
                mypager.EnableViewState = true;
                brixGrid.InitializeLayout += brixGrid_InitializeLayout;
                if (reportModel.HasItemPicker)
                {
                    #region Init ItemPicker

                    itemPicker = (ucItemPicker as ItemPickerControl);
                    itemPicker.SelectedIndexChanged += itemPicker_SelectedIndexChanged;
                    itemPicker.ModuleID = Constants.MODID_CONTMGT;
                    itemPicker.ParentInstanceID = Request.QueryString[&quot;ParentID&quot;].ToInt32_2();

                    itemPicker.CustomizeGridColumns +=
                        new ItemPickerControl.CustomizeColumns(itemPicker_CustomizeGridColumns);
                    //ifrmReport
                    InSiteCore master = (InSiteCore)this.Master;
                    itemPicker.PickerParent = null == master ? div1.ClientID : master.PickerHook.ClientID;
                    itemPicker.PreLaunchCall =
                        string.Format(&quot;$(&#39;#{0}&#39;).css({{&#39;display&#39; : &#39;none&#39;}});$(&#39;#{1}&#39;).css({{&#39;display&#39; : &#39;none&#39;}});&quot;,
                            frmRep.ClientID, frmARep.ClientID);
                    itemPicker.PostSelectCallBack =
                        string.Format(
                            &quot;$(&#39;#{0}&#39;).css({{&#39;display&#39; : &#39;inline&#39;}});$(&#39;#{1}&#39;).css({{&#39;display&#39; : &#39;inline&#39;}});&quot;,
                            frmRep.ClientID, frmARep.ClientID);
                    itemPicker.OnCancelScript =
                        string.Format(
                            &quot;$(&#39;#{0}&#39;).css({{&#39;display&#39; : &#39;inline&#39;}});$(&#39;#{1}&#39;).css({{&#39;display&#39; : &#39;inline&#39;}});&quot;,
                            frmRep.ClientID, frmARep.ClientID);
                    itemPicker.DoPostBackAfterSelect = true;
                    //RPTWebViewer.FindControl();

                    #endregion
                }
                if (reportModel.HasStaticFilter)
                {
                    DataSet ds = reportModel.GetData(0, string.Empty);
                    ddlContractors.DataSource = ds.Tables[0].ToMWDateTime();
                    ddlContractors.DataValueField = ds.Tables[0].Columns[&quot;ValueandType&quot;].ColumnName;
                    ddlContractors.DataTextField = ds.Tables[0].Columns[&quot;Contact&quot;].ColumnName;
                    ddlContractors.DataGroupField = ds.Tables[0].Columns[&quot;ContractorType&quot;].ColumnName;
                    ddlContractors.DataBind();
                    ddlContractors.Items.Insert(0, &quot;Select&quot;);
                    ddlWorkOrders.Enabled = false;
                    ddlWorkOrders.Items.Insert(0, &quot;Select&quot;);
                }
                PageTitle = reportModel.Header;
            }
            else
            {
                PageTitle = xmlmodel.form.ParseDynamicString(Session[&quot;Header&quot;].ToString());
            }

            var formEvent = new XmlFormArgs();
            if (managerModel != null) managerModel.OnInit(xmlmodel, formEvent);

            base.OnInit(e);
        }

        #endregion

        void itemPicker_CustomizeGridColumns(ref List&lt;PickerColumnDetails&gt; lst)
        {
            List&lt;string&gt; components = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
            for (int i = 0; i &lt; lst.Count; i++)
            {
                if (lst[i].ColumnName == &quot;UnitCost&quot;)
                    if (!components.Contains(&quot;ItemUnitCost&quot;))
                        lst.RemoveAt(i);
                if (lst[i].ColumnName == &quot;OverheadCost&quot;)
                    if (!components.Contains(&quot;ItemOverheadCost&quot;))
                        lst.RemoveAt(i);
            }
        }

        #region &quot;Page Events&quot;

        protected void Page_Load(object sender, EventArgs e)
        {
            //Disable Role Selection
            UIHelper.DisableRoleSelection(Page);

            if (!string.IsNullOrEmpty(Request[&quot;XMLReport&quot;]))
            {
                var formEvent = new XmlFormArgs();
                if (managerModel != null) managerModel.OnPageLoad(xmlmodel, formEvent);
                if (!string.IsNullOrEmpty(Request.Form[&quot;__EVENTTARGET&quot;]) &amp;&amp;
                    (Request.Form[&quot;__EVENTTARGET&quot;].EndsWith(&quot;MainToolBar$lnkHtml&quot;) ||
                     Request.Form[&quot;__EVENTTARGET&quot;].EndsWith(&quot;RPTWebViewer&quot;)))
                    Context.Items[&quot;ViewerType&quot;] = ViewerType.HtmlViewer;
                RenderDataDynamics();
            }

            // set the page unique context for breadcrum from the list model
            if (reportModel == null &amp;&amp; !string.IsNullOrEmpty(Request.QueryString[&quot;XMLReport&quot;]))
            {
                string context = Request.QueryString[&quot;xContext&quot;];
                if (!string.IsNullOrEmpty(context))
                {
                    ListModel listModel = ListModel.GetXMLInstance(context, Request, Response, string.Empty);

                    if (!string.IsNullOrEmpty(listModel.PageUniqueID))
                    {
                        base.PageUniqueID = listModel.PageUniqueID;
                    }
                }
            }
            else if (!string.IsNullOrEmpty(reportModel.PageUniqueID))
            {
                base.PageUniqueID = reportModel.PageUniqueID;
            }
        }

        public override bool CheckAccess()
        {
            UserDetail ud = UserDetail.GetCurrentUserDetail();

            if (!reportModel.CheckAccess(ud))
            {
                return false;
            }
            return true;
        }

        private ReportModel SetReportModel()
        {
            try
            {
                context = Request.QueryString[&quot;context&quot;] + (Request.QueryString[&quot;Type&quot;] ?? &quot;&quot;);
                ReportModel reportModel = ReportModel.GetInstance(Request, Response,
                    Session[Constants.EIS_ADDITIONAL_INFO] == null
                        ? string.Empty
                        : Session[Constants.EIS_ADDITIONAL_INFO].ToString2
                            ());
                columnInfo = reportModel.ColumnInfo;
                return reportModel;
            }
            catch
            {
                return null;
            }
        }

        private void InitHtmlData()
        {
            ScriptManager.RegisterArrayDeclaration(tblFilter, &quot;FilterFields&quot;, reportModel.GetFilterHtml(tblFilter));
        }

        private void BindGridControl()
        {
            try
            {
                mypager.Visible = true;
                int pagecount;
                pageno = mypager.CurrentPage;
                int pgNo = pageno;
                var ContractorDT =
                    (DataTable)
                        reportModel.GetList(PageSize, UIHelper.GetSortOrder(pageState.SortKey, pageState.SortOrder),
                            pageState.FilterCriterion, ref pgNo, out pagecount);
                pageno = pgNo;
                mypager.Set_Page(pageno, pagecount);
                if (ContractorDT == null || ContractorDT.Rows.Count == 0)
                {
                    brixGrid.Columns.Clear();
                    mypager.Visible = false;
                    brixGrid.DisplayLayout.NoDataMessage = &quot;No Data To Display&quot;;
                }
                else
                {
                    brixGrid.DataSource = ContractorDT.ToMWDateTime();
                    brixGrid.DataBind();

                    // to fix XSS attack
                    foreach (UltraGridColumn col in brixGrid.Columns)
                    {
                        col.HTMLEncodeContent = true;
                    }

                    brixGrid.Bands[0].Columns.FromKey(&quot;Multi&quot;).AllowUpdate = AllowUpdate.Yes;
                    if (brixGrid.Columns.Exists(&quot;Rate&quot;))
                        brixGrid.Columns.FromKey(&quot;Rate&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    brixGrid.DisplayLayout.Pager.PagerStyle.CustomRules = &quot;display:none&quot;;
                }
                pageState.MaintainState(pageState.PageIndex, pageState.SortKey, pageState.SortOrder,
                    pageState.FilterCriterion);
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                    &quot;ShowError(&quot; + JS.Serialize(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;)) + &quot;);&quot;, true);
            }
        }

        private void InitSortAndFilter()
        {
            bool stateMgmt = WebConfigurationManager.AppSettings[&quot;StateMgmtGlobal&quot;].ToBoolean2();
            bool userCanAcessModule = false;
            if (Request.UrlReferrer != null)
            {
                userCanAcessModule = Array.Exists(Request.UrlReferrer.Segments,
                    delegate(string s) { return (s != null &amp;&amp; s.StartsWith2(Constants.MODID_USRMGMT)); });
            }
            pageState = UIHelper.GetModuleFromStateBag(context, Context) as StateManagementBase;
            if (pageState == null)
            {
                pageState = new StateManagementBase(context);
                UIHelper.UpdateModuleStateBag(context, pageState, Context);
            }
        }

        private void GenerateReportByFilter(string queryStringName)
        {
            try
            {
                string logoPath = Server.MapPath(AMP3ApplicationSettings.Instance.AppLogo);
                string path = Server.MapPath(reportModel.ReportPath);
                Dictionary&lt;string, string&gt; dic =
                    reportModel.GetFilterXML(tblFilter.UniqueID.Remove(tblFilter.UniqueID.Length - 9), Request);
                if (queryStringName != &quot;&quot;)
                {
                    dic.Add(reportModel.QueryStringName + &quot;_0&quot;, queryStringName);
                }
                //Session.Add(&quot;Stream&quot;, reportModel.GenerateReportByFilter(path, logoPath, dic));
                //ifrmReport.Style.Value = &quot;width: 100%; height: 100%;display:block;&quot;;
                //ifrmReport.Attributes.Add(&quot;src&quot;, &quot;GenerateReport.aspx&quot;);
                GenerateReportByFilter(path, logoPath, dic);
                return;
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                if (ex.Message == &quot;The given key was not present in the dictionary.&quot;)
                    ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                        &quot;ShowError(&#39;Please provide the required information.&#39;);&quot;, true);
                else
                    ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                        &quot;ShowError(&quot; + JS.Serialize(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;)) + &quot;);&quot;, true);
            }
        }

        #region &quot;Custom Event Handlers&quot;

        private void GenerateReportByFilter(string reportPath, string logoPath, Dictionary&lt;string, string&gt; dicFilter)
        {
            Report repObj = reportModel.GetReportObject(dicFilter);

            RPTWebViewer.ClearCachedReport();

            RPTWebViewer.ViewerType = (ViewerType)(Context.Items[&quot;ViewerType&quot;] ?? ViewerType.AcrobatReader);
            var rpt = new ActiveReport();
            try
            {
                if (repObj != null)
                {
                    rpt = reportModel.GetActiveReport(repObj, rpt);
                    // Set the Viewer for the report
                    RPTWebViewer.Report = rpt;
                }
            }
            catch (Exception)
            {
                throw;
            }
            finally
            {
                rpt.Dispose();
            }
        }

        private void GenerateReportByFilter(ActiveReport rpt)
        {
            RPTWebViewer.ClearCachedReport();
            RPTWebViewer.ViewerType = (ViewerType)(Context.Items[&quot;ViewerType&quot;] ?? ViewerType.AcrobatReader);
            RPTWebViewer.Report = rpt;
        }

        #region &quot;Generic Events&quot;

        public void HandlePagerEvent(object sender, ItemClickEventArgs e)
        {
            BindGridControl();
            brixGrid.DisplayLayout.Pager.CurrentPageIndex = 1;
        }

        protected void lnkBack_Click(object sender, EventArgs e)
        {
            if ((sender as Aurigo.AMP3.Core.UserControls.Menu).Enabled == false)
                return;
            //Return path is now obtained from the concrete models as an abstract property
            //called &quot;ReturnURL&quot;.
            if (string.IsNullOrEmpty(Request[&quot;XMLReport&quot;]))
            {
                Response.Redirect(UIHelper.BuildURL(reportModel.ReturnURL,
                    new List&lt;string&gt;() { &quot;Context&quot;, &quot;Code&quot;, &quot;MODID&quot;, &quot;nt&quot; }, HttpContext.Current));
            }
            else
            {
                string returnUrl = @&quot;~/Common/BrixListPage.aspx?&quot;;
                foreach (string key in Request.QueryString.AllKeys)
                {
                    if (key != null &amp;&amp; !key.Equals(&quot;XMLReport&quot;) &amp;&amp; !key.Equals(&quot;InstanceID&quot;))
                        returnUrl += key + &quot;=&quot; + Request[key] + &quot;&amp;&quot;;
                }
                Response.Redirect(returnUrl.Trim(&#39;&amp;&#39;));
            }
        }

        #endregion

        #region &quot;Infragistics Events&quot;

        protected void brixGrid_initializerow(object sender, RowEventArgs e)
        {
            SetColumnAttributes();

            foreach (DataRow row in reportModel.GridImageInfo.Rows)
            {
                string imgkey = &quot;img_&quot; + row[&quot;Key&quot;].ToString2();
                string key = row[&quot;Key&quot;].ToString2();
                string value = e.Row.Cells.FromKey(key).Value.ToString2();
                if (row[&quot;Value&quot;].ToString2().Equals(value))
                {
                    e.Row.Cells.FromKey(imgkey).Style.BackgroundImage = row[&quot;ImageFile&quot;].ToString2();
                    e.Row.Cells.FromKey(imgkey).Style.CustomRules =
                        &quot;Background-repeat:no-repeat;background-position: center center&quot;;
                    e.Row.Cells.FromKey(imgkey).Style.ForeColor = Color.White;
                    e.Row.Cells.FromKey(imgkey).Style.Font.Size = FontUnit.Point(1);
                    e.Row.Cells.FromKey(imgkey).Title = row[&quot;Caption&quot;].ToString2();
                }
            }
        }

        protected void brixGrid_SortColumn(object sender, SortColumnEventArgs e)
        {
            ApplySort(brixGrid.Columns[e.ColumnNo].Key, pageState.SortOrder, true);
        }

        protected void brixGrid_InitializeLayout(object sender, LayoutEventArgs e)
        {
            brixGrid.DisplayLayout.AllowSortingDefault = AllowSorting.Yes;
            brixGrid.DisplayLayout.HeaderClickActionDefault = HeaderClickAction.SortSingle;
            brixGrid.DisplayLayout.EnableInternalRowsManagement = false;
        }

        protected void brixGrid_DblClick(object sender, ClickEventArgs e)
        {
            GenerateReportByFilter(e.Row.Cells.FromKey(reportModel.QueryStringName).ToString2());
            RPTWebViewer.Style.Value = &quot;width: 100%; display:block; height: 100%&quot;;
        }

        protected void btnDone_OnClick(object sender, EventArgs e)
        {
            GenerateReportByFilter(
                brixGrid.DisplayLayout.ActiveRow.Cells.FromKey(reportModel.QueryStringName).ToString2());
        }

        protected void btnGridCancel_OnClick(object sender, EventArgs e)
        {
            lnkBack_Click(sender, e);
        }

        #endregion

        #endregion

        #endregion

        #region &quot;Custom functions&quot;

        private void SetColumnAttributes()
        {
            int i = 1;
            Dictionary&lt;string, string&gt; dic = reportModel.GetGridImageKeys();

            foreach (string key in dic.Keys)
            {
                brixGrid.Columns.Add(&quot;img_&quot; + key);
                brixGrid.Columns.FromKey(&quot;img_&quot; + key).Header.Caption = dic[key];
                brixGrid.Columns.FromKey(&quot;img_&quot; + key).Move(i++);
            }
        }

        protected void ApplyFilter()
        {
            try
            {
                if (reportModel.HasGrid)
                {
                    pageState.FilterCriterion =
                        reportModel.GetFilterCriterion(tblFilter.UniqueID.Remove(tblFilter.UniqueID.Length - 9), Request);
                    tblChngOrder.Style.Value = &quot;display:table;&quot;;
                    BindGridControl();
                }
                else if (reportModel.HasItemPicker || reportModel.HasStaticFilter)
                {
                    string values = &quot;&quot;;
                    if (reportModel.HasItemPicker)
                    {
                        values = hdnStdItemID.Value;
                    }
                    if (reportModel.HasStaticFilter)
                    {
                        if (ddlContractors.SelectedIndex &gt; 0)
                        {
                            if ((ddlContractors.SelectedValue.Split(&#39;,&#39;))[1].Equals(&quot;P&quot;) ||
                                ddlWorkOrders.SelectedIndex &gt; 0 || ddlWorkOrders.Items.Count == 1)
                            {
                                values += &quot;,&quot; + ddlContractors.SelectedValue + &quot;,&quot; + ddlWorkOrders.SelectedValue;
                            }
                            else
                                ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                    &quot;ShowError(&#39;Please select a Work Order&#39;);&quot;, true);
                        }
                        else
                            ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                &quot;ShowError(&#39;Please select a Contractor&#39;);&quot;, true);
                    }
                    if (!reportModel.HasItemPicker || !string.IsNullOrEmpty(hdnStdItemID.Value))
                    {
                        if (!string.IsNullOrEmpty(values))
                            GenerateReportByFilter(values);
                    }
                    else
                        ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                            &quot;ShowError(&#39;Please select a &quot; + UIHelper.JavascriptEncode(ItemNameAbbr) + &quot;&#39;);&quot;, true);
                }
                else
                    GenerateReportByFilter(string.Empty);
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                if (ex.Message == &quot;The given key was not present in the dictionary.&quot;)
                    ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                        &quot;ShowError(&#39;Please provide the required information.&#39;);&quot;, true);
                else
                    ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                        &quot;ShowError(&quot; + JS.Serialize(ex.Message.Replace(&quot;|&quot;, &quot;\\n&quot;)) + &quot;);&quot;, true);
            }
        }

        protected void ApplySort(string sortKey, GridSortOrder sortOrder, bool changeIndicator)
        {
            //string sortOrder = &quot; ASC&quot;;
            mypager.CurrentPage = pageno;
            if (!string.IsNullOrEmpty(sortKey))
            {
                if (pageState.SortOrder != GridSortOrder.None &amp;&amp; !changeIndicator &amp;&amp; sortKey == pageState.SortKey)
                    sortOrder = pageState.SortOrder;
                else if (pageState.SortOrder != GridSortOrder.None &amp;&amp; changeIndicator &amp;&amp; sortKey == pageState.SortKey)
                    sortOrder = (pageState.SortOrder == GridSortOrder.Ascending)
                        ? GridSortOrder.Descending
                        : GridSortOrder.Ascending;
                pageState.SortKey = sortKey;
                pageState.SortOrder = sortOrder;
            }
            BindGridControl();
            foreach (UltraGridColumn uwgcol in brixGrid.DisplayLayout.Bands[0].Columns)
                if (uwgcol.SortIndicator != SortIndicator.None)
                    uwgcol.SortIndicator = SortIndicator.None;

            if (brixGrid.Columns.Exists(sortKey))
                brixGrid.Bands[0].Columns.FromKey(sortKey).SortIndicator = (sortOrder == GridSortOrder.Ascending)
                    ? SortIndicator.Ascending
                    : (sortOrder == GridSortOrder.Descending ? SortIndicator.Descending : SortIndicator.None);
        }

        private void itemPicker_SelectedIndexChanged(object sender, ClickEventArgs e)
        {
            Item stdItem = itemPicker.GetDTOFromHTTP(e);
            if (stdItem != null)
            {
                //itemPicker.Text = stdItem.Description;
                hdnStdItemID.Value = stdItem.ItemID.ToString2();
            }
            btnFilter.Visible = true;
            tblItemPicker.Style.Value = &quot;display:table;&quot;;
            if (reportModel.HasStaticFilter)
                tblStaticFilter.Style.Value = &quot;display:table;&quot;;
            ifrmReport.Style.Value = &quot;width: 100%; display:none;&quot;;
        }

        protected void ddlContractors_SelectedIndexChanged(object sender, EventArgs e)
        {
            ifrmReport.Style.Value = &quot;display:none;&quot;;
            if (ddlContractors.SelectedIndex &gt; 0)
            {
                string[] contractor = ddlContractors.SelectedValue.Split(&#39;,&#39;);
                if (contractor[1].Equals(&quot;S&quot;))
                {
                    ddlWorkOrders.Enabled = true;
                    DataSet ds = reportModel.GetData(1, contractor[0]);
                    ddlWorkOrders.DataSource = ds.Tables[0].ToMWDateTime();
                    ddlWorkOrders.DataValueField = ds.Tables[0].Columns[0].ColumnName;
                    ddlWorkOrders.DataTextField = ds.Tables[0].Columns[1].ColumnName;
                    ddlWorkOrders.DataBind();
                    ddlWorkOrders.Items.Insert(0, &quot;Select&quot;);
                }
                else
                {
                    ddlWorkOrders.SelectedIndex = 0;
                    ddlWorkOrders.Enabled = false;
                }
            }
            else
            {
                ddlWorkOrders.SelectedIndex = 0;
                ddlWorkOrders.Enabled = false;
            }
        }

        protected void ddlWorkOrders_SelectedIndexChanged(object sender, EventArgs e)
        {
            ifrmReport.Style.Value = &quot;display:none;&quot;;
        }

        #endregion

        protected void btnFilter_Click(object sender, EventArgs e)
        {
            ifrmReport.Style.Value = &quot;width: 100%; display:none;&quot;;
            ApplyFilter();
        }

        protected void Viewer_Click(object sender, EventArgs e)
        {
            var link = (sender as Aurigo.AMP3.Core.UserControls.Menu);
            if (!link.Enabled)
                return;
            if (link.ID.Equals(&quot;lnkHtml&quot;))
                Context.Items[&quot;ViewerType&quot;] = ViewerType.HtmlViewer;
            //else if (link.ID.Equals(&quot;lnkRawHtml&quot;))
            //    Context.Items[&quot;ViewerType&quot;] = ViewerType.RawHtml;
            //else if (link.ID.Equals(&quot;lnkActiveX&quot;))
            //    Context.Items[&quot;ViewerType&quot;] = ViewerType.ActiveXViewer;
            else if (link.ID.Equals(&quot;lnkPDF&quot;))
                Context.Items[&quot;ViewerType&quot;] = ViewerType.AcrobatReader;
            if (!string.IsNullOrEmpty(Request[&quot;XMLReport&quot;]))
                RenderDataDynamics();
            else
                ApplyFilter();
        }

        private void RenderDataDynamics()
        {
            xmlmodel.form.Header = xmlmodel.form.ParseDynamicString(xmlmodel.form.Header);

            var engine = new XMLRenderingEngine(this, xmlmodel, null);

            engine.Initialize();

            xmlmodel.form.instanceID = Request.QueryString[&quot;InstanceID&quot;];
            try
            {
                engine.Render(RenderFormat.RenderDataDynamics);
                if (engine.RenderParent != null &amp;&amp; engine.RenderParent is ActiveReport)
                {
                    GenerateReportByFilter((ActiveReport)engine.RenderParent);
                }
                //if (Session[&quot;Stream&quot;] != null)
                //    GenerateReportByFilter((ActiveReport)Session[&quot;Stream&quot;]);
            }
            catch (Exception ex)
            {
                Logger.Log(Enumerations.LogType.Error, ex.StackTrace, &quot;&quot;);
            }
        }

        private void CreateControls()
        {
           InitHtmlData();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[38,17,38,18,0],[38,19,38,51,0],[38,52,38,53,0],[39,17,39,18,0],[39,19,39,47,0],[39,48,39,49,0],[53,17,53,18,0],[53,19,53,64,0],[53,65,53,66,0],[61,9,61,10,0],[63,13,63,14,0],[64,17,64,61,0],[65,17,65,41,0],[65,42,65,66,0],[66,17,66,35,0],[67,17,67,44,0],[70,17,70,39,0],[73,17,73,43,0],[75,17,75,45,0],[77,17,77,79,0],[80,17,80,76,0],[81,17,81,80,0],[82,17,82,48,0],[84,17,84,64,0],[85,17,85,18,0],[87,21,87,48,0],[88,21,88,22,0],[89,25,89,65,0],[90,25,90,66,0],[91,25,91,69,0],[92,25,92,26,0],[93,29,93,73,0],[94,29,94,74,0],[95,29,95,88,0],[96,29,96,91,0],[97,29,97,47,0],[98,25,98,26,0],[100,25,100,26,0],[101,29,101,50,0],[102,29,102,30,0],[103,33,103,70,0],[104,29,104,30,0],[105,25,105,26,0],[106,21,106,22,0],[108,21,108,22,0],[109,25,109,55,0],[110,29,110,74,0],[111,25,111,57,0],[112,29,112,76,0],[113,25,113,52,0],[114,29,114,68,0],[115,21,115,22,0],[118,21,118,38,0],[120,21,120,41,0],[121,21,121,65,0],[122,21,122,22,0],[123,25,123,49,0],[124,25,124,70,0],[125,29,125,86,0],[126,21,126,22,0],[127,17,127,18,0],[129,17,129,18,0],[130,21,130,61,0],[131,21,131,89,0],[132,21,132,77,0],[133,17,133,18,0],[136,17,136,45,0],[137,13,137,14,0],[138,13,138,18,0],[139,13,139,14,0],[140,13,140,14,0],[141,9,141,10,0],[144,9,144,10,0],[145,13,145,65,0],[146,17,146,80,0],[148,13,148,65,0],[149,17,149,79,0],[154,13,154,64,0],[155,17,155,78,0],[156,9,156,10,0],[160,9,160,10,0],[161,13,161,60,0],[162,13,162,14,0],[163,17,163,48,0],[165,17,165,41,0],[166,17,166,18,0],[168,21,170,78,0],[172,21,172,28,0],[174,17,174,49,0],[175,13,175,14,0],[177,13,177,14,0],[178,17,178,100,0],[179,21,179,52,0],[181,21,185,45,0],[187,17,188,59,0],[190,17,191,75,0],[192,21,193,57,0],[195,17,195,51,0],[196,17,196,42,0],[196,43,196,87,0],[197,13,197,14,0],[199,13,199,31,0],[200,9,200,10,0],[203,9,203,10,0],[204,13,204,60,0],[205,13,205,14,0],[206,17,206,59,0],[207,17,207,48,0],[208,17,208,72,0],[209,17,209,47,0],[210,17,210,18,0],[213,21,213,70,0],[214,21,214,88,0],[215,21,215,67,0],[216,21,216,95,0],[218,21,219,97,0],[221,21,221,65,0],[222,21,222,107,0],[223,21,225,64,0],[226,21,229,64,0],[230,21,233,64,0],[234,21,234,61,0],[238,17,238,18,0],[239,17,239,49,0],[240,17,240,18,0],[241,21,241,71,0],[242,21,242,77,0],[243,21,243,101,0],[244,21,244,95,0],[245,21,245,103,0],[246,21,246,47,0],[247,21,247,62,0],[248,21,248,51,0],[249,21,249,61,0],[250,17,250,18,0],[251,17,251,48,0],[252,13,252,14,0],[254,13,254,14,0],[255,17,255,92,0],[256,13,256,14,0],[258,13,258,47,0],[259,13,259,38,0],[259,39,259,80,0],[261,13,261,28,0],[262,9,262,10,0],[267,9,267,10,0],[268,13,268,105,0],[269,18,269,27,0],[269,29,269,42,0],[269,44,269,47,0],[270,13,270,14,0],[271,17,271,53,0],[272,21,272,62,0],[273,25,273,41,0],[274,17,274,57,0],[275,21,275,66,0],[276,25,276,41,0],[277,13,277,14,0],[278,9,278,10,0],[283,9,283,10,0],[285,13,285,49,0],[287,13,287,61,0],[288,13,288,14,0],[289,17,289,51,0],[290,17,290,42,0],[290,43,290,88,0],[291,17,293,78,0],[294,21,294,73,0],[295,17,295,38,0],[296,13,296,14,0],[299,13,299,96,0],[300,13,300,14,0],[301,17,301,66,0],[302,17,302,52,0],[303,17,303,18,0],[304,21,304,110,0],[306,21,306,71,0],[307,21,307,22,0],[308,25,308,68,0],[309,21,309,22,0],[310,17,310,18,0],[311,13,311,14,0],[312,18,312,70,0],[313,13,313,14,0],[314,17,314,62,0],[315,13,315,14,0],[316,9,316,10,0],[319,9,319,10,0],[320,13,320,63,0],[322,13,322,46,0],[323,13,323,14,0],[324,17,324,30,0],[326,13,326,25,0],[327,9,327,10,0],[330,9,330,10,0],[332,13,332,14,0],[333,17,333,96,0],[334,17,338,33,0],[339,17,339,53,0],[340,17,340,36,0],[342,13,342,18,0],[343,13,343,14,0],[344,17,344,29,0],[346,9,346,10,0],[349,9,349,10,0],[350,13,350,117,0],[351,9,351,10,0],[354,9,354,10,0],[356,13,356,14,0],[357,17,357,40,0],[359,17,359,46,0],[360,17,360,35,0],[361,17,364,81,0],[365,17,365,31,0],[366,17,366,53,0],[367,17,367,74,0],[368,17,368,18,0],[369,21,369,46,0],[370,21,370,45,0],[371,21,371,81,0],[372,17,372,18,0],[374,17,374,18,0],[375,21,375,71,0],[376,21,376,41,0],[379,21,379,28,0],[379,30,379,49,0],[379,50,379,52,0],[379,53,379,69,0],[380,21,380,22,0],[381,25,381,54,0],[382,21,382,22,0],[384,21,384,94,0],[385,21,385,57,0],[386,25,386,108,0],[387,21,387,90,0],[388,17,388,18,0],[389,17,390,48,0],[391,13,391,14,0],[392,13,392,33,0],[393,13,393,14,0],[394,17,394,70,0],[395,17,396,95,0],[397,13,397,14,0],[398,9,398,10,0],[401,9,401,10,0],[402,13,402,98,0],[403,13,403,45,0],[404,13,404,45,0],[405,13,405,14,0],[406,17,407,40,0],[407,40,407,41,0],[407,41,407,42,0],[407,42,407,103,0],[407,103,407,104,0],[407,104,407,105,0],[407,105,407,107,0],[406,17,407,107,0],[408,13,408,14,0],[409,13,409,97,0],[410,13,410,35,0],[411,13,411,14,0],[412,17,412,62,0],[413,17,413,76,0],[414,13,414,14,0],[415,9,415,10,0],[418,9,418,10,0],[420,13,420,14,0],[421,17,421,92,0],[422,17,422,70,0],[423,17,424,113,0],[425,17,425,43,0],[426,17,426,18,0],[427,21,427,82,0],[428,17,428,18,0],[432,17,432,61,0],[433,17,433,24,0],[435,13,435,33,0],[436,13,436,14,0],[437,17,437,70,0],[438,17,438,86,0],[439,21,440,89,0],[442,21,443,99,0],[444,13,444,14,0],[445,9,445,10,0],[450,9,450,10,0],[451,13,451,68,0],[453,13,453,46,0],[455,13,455,109,0],[456,13,456,42,0],[458,13,458,14,0],[459,17,459,36,0],[460,17,460,18,0],[461,21,461,68,0],[463,21,463,47,0],[464,17,464,18,0],[465,13,465,14,0],[466,13,466,30,0],[467,13,467,14,0],[468,17,468,23,0],[471,13,471,14,0],[472,17,472,31,0],[473,13,473,14,0],[474,9,474,10,0],[477,9,477,10,0],[478,13,478,46,0],[479,13,479,109,0],[480,13,480,39,0],[481,9,481,10,0],[486,9,486,10,0],[487,13,487,31,0],[488,13,488,63,0],[489,9,489,10,0],[492,9,492,10,0],[493,13,493,81,0],[494,17,494,24,0],[497,13,497,60,0],[498,13,498,14,0],[499,17,500,100,0],[501,13,501,14,0],[503,13,503,14,0],[504,17,504,67,0],[505,17,505,24,0],[505,26,505,36,0],[505,37,505,39,0],[505,40,505,67,0],[506,17,506,18,0],[507,21,507,94,0],[508,25,508,69,0],[509,17,509,18,0],[510,17,510,56,0],[511,13,511,14,0],[512,9,512,10,0],[519,9,519,10,0],[520,13,520,35,0],[522,13,522,20,0],[522,22,522,33,0],[522,34,522,36,0],[522,37,522,67,0],[523,13,523,14,0],[524,17,524,65,0],[525,17,525,53,0],[526,17,526,75,0],[527,17,527,60,0],[528,17,528,18,0],[529,21,529,102,0],[530,21,531,90,0],[532,21,532,79,0],[533,21,533,85,0],[534,21,534,84,0],[535,17,535,18,0],[536,13,536,14,0],[537,9,537,10,0],[540,9,540,10,0],[541,13,541,84,0],[542,9,542,10,0],[545,9,545,10,0],[546,13,546,75,0],[547,13,547,92,0],[548,13,548,73,0],[549,9,549,10,0],[552,9,552,10,0],[553,13,553,98,0],[554,13,554,83,0],[555,9,555,10,0],[558,9,558,10,0],[559,13,560,106,0],[561,9,561,10,0],[564,9,564,10,0],[565,13,565,38,0],[566,9,566,10,0],[577,9,577,10,0],[578,13,578,23,0],[579,13,579,77,0],[581,13,581,20,0],[581,22,581,32,0],[581,33,581,35,0],[581,36,581,44,0],[582,13,582,14,0],[583,17,583,52,0],[584,17,584,82,0],[585,17,585,66,0],[586,13,586,14,0],[587,9,587,10,0],[590,9,590,10,0],[592,13,592,14,0],[593,17,593,41,0],[594,17,594,18,0],[595,21,596,123,0],[597,21,597,65,0],[598,21,598,39,0],[599,17,599,18,0],[600,22,600,83,0],[601,17,601,18,0],[602,21,602,40,0],[603,21,603,51,0],[604,21,604,22,0],[605,25,605,53,0],[606,21,606,22,0],[607,21,607,53,0],[608,21,608,22,0],[609,25,609,62,0],[610,25,610,26,0],[611,29,612,99,0],[613,29,613,30,0],[614,33,614,114,0],[615,29,615,30,0],[617,33,618,87,0],[619,25,619,26,0],[621,29,622,83,0],[623,21,623,22,0],[624,21,624,97,0],[625,21,625,22,0],[626,25,626,59,0],[627,29,627,60,0],[628,21,628,22,0],[630,25,631,116,0],[632,17,632,18,0],[634,21,634,58,0],[635,13,635,14,0],[636,13,636,33,0],[637,13,637,14,0],[638,17,638,70,0],[639,17,639,86,0],[640,21,641,89,0],[643,21,644,99,0],[645,13,645,14,0],[646,9,646,10,0],[649,9,649,10,0],[651,13,651,42,0],[652,13,652,48,0],[653,13,653,14,0],[654,17,654,115,0],[655,21,655,53,0],[656,22,656,119,0],[657,21,659,51,0],[660,17,660,45,0],[661,17,661,49,0],[662,13,662,14,0],[663,13,663,31,0],[664,13,664,20,0],[664,22,664,44,0],[664,45,664,47,0],[664,48,664,87,0],[665,17,665,64,0],[666,21,666,63,0],[668,13,668,50,0],[669,17,671,111,0],[672,9,672,10,0],[675,9,675,10,0],[676,13,676,57,0],[677,13,677,33,0],[678,13,678,14,0],[680,17,680,65,0],[681,13,681,14,0],[682,13,682,38,0],[683,13,683,58,0],[684,13,684,45,0],[685,17,685,64,0],[686,13,686,67,0],[687,9,687,10,0],[690,9,690,10,0],[691,13,691,54,0],[692,13,692,50,0],[693,13,693,14,0],[694,17,694,79,0],[695,17,695,47,0],[696,17,696,18,0],[697,21,697,50,0],[698,21,698,72,0],[699,21,699,76,0],[700,21,700,87,0],[701,21,701,86,0],[702,21,702,46,0],[703,21,703,61,0],[704,17,704,18,0],[706,17,706,18,0],[707,21,707,53,0],[708,21,708,51,0],[709,17,709,18,0],[710,13,710,14,0],[712,13,712,14,0],[713,17,713,49,0],[714,17,714,47,0],[715,13,715,14,0],[716,9,716,10,0],[719,9,719,10,0],[720,13,720,54,0],[721,9,721,10,0],[726,9,726,10,0],[727,13,727,67,0],[728,13,728,27,0],[729,9,729,10,0],[732,9,732,10,0],[733,13,733,71,0],[734,13,734,31,0],[735,17,735,24,0],[736,13,736,43,0],[737,17,737,69,0],[742,18,742,47,0],[743,17,743,72,0],[744,13,744,61,0],[745,17,745,38,0],[747,17,747,31,0],[748,9,748,10,0],[751,9,751,10,0],[752,13,752,91,0],[754,13,754,71,0],[756,13,756,33,0],[758,13,758,74,0],[760,13,760,14,0],[761,17,761,64,0],[762,17,762,88,0],[763,17,763,18,0],[764,21,764,79,0],[765,17,765,18,0],[768,13,768,14,0],[769,13,769,33,0],[770,13,770,14,0],[771,17,771,75,0],[772,13,772,14,0],[773,9,773,10,0],[776,9,776,10,0],[777,12,777,27,0],[778,9,778,10,0]]);
    </script>
  </body>
</html>