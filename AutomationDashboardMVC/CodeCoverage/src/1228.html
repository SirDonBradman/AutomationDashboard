<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\USRMGMT\AddUser.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Globalization;
using System.Data;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.Logging;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.AMP3.UserManagementDTO;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DTO;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common.Utility;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Platform.UI.Common.Helpers;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.AMP3.UserManagementUI
{
    public partial class AddUser : BrixPageBase, IXMLControl
    {
        protected Dictionary&lt;string, string&gt; settinght;
        private XMLFormManagerModel managerModel;
        private BrixFormModel model;
        private int userIDForIXMLControl = 0;
        
        private Dictionary&lt;int, string&gt; ActiveRoles
        {
            get
            {
                if (null == ViewState[&quot;AddUserPage_ActiveRoles&quot;])
                    ViewState[&quot;AddUserPage_ActiveRoles&quot;] = UserManager.Instance.GetUnassignedRolesOfUser(0);
                // Use UID 0 as a special case, to get all available roles
                return ViewState[&quot;AddUserPage_ActiveRoles&quot;] as Dictionary&lt;int, string&gt;;
            }
        }

        #region IXMLControl Members

        public object[] ParentFormInstanceID
        {
                get { return new object[] { userIDForIXMLControl }; }
        }

        public HtmlGenericControl XMLContainterDiv
        {
            get { return additionaldiv; }
            set { }
        }

        public bool SkipDefaultXMLInjectionSave
        {
            get; set;
        }

        public void HandleInjectionSaveException(object model, Exception ex, string parentFormInstanceId)
        {
            try
            {
                if (managerModel != null)
                    managerModel.HandleInjectionSaveException((model as BrixFormModel), ex, parentFormInstanceId);
            }
            catch (Exception ex1)
            {
                throw ex1;
            }
        }


        public void HandleInjectionAfterSave(object model, string parentFormInstanceId)
        {
            try
            {
                if (managerModel != null)
                    managerModel.HandleInjectionAfterSave((model as BrixFormModel), parentFormInstanceId);
            }
            catch (Exception ex1)
            {
                throw ex1;
            }
        }

        #endregion

        public override void InclueScriptAndStyleFiles()
        {
            base.InclueScriptAndStyleFiles();
            RegisterClientScriptInclude(&quot;~/Scripts/usermgmt/AddOrEditUser.js&quot;);
        }

        protected override void OnPreInit(EventArgs e)
        {
            if (!string.IsNullOrEmpty(Request[&quot;UID&quot;]))
                userIDForIXMLControl = Request[&quot;UID&quot;].ToInt32_2();
            base.OnPreInit(e);
            SetManagerModel();
            if (managerModel != null)
                managerModel.OnPreInit(model, new XmlFormArgs());
        }

        private void SetManagerModel()
        {
            model = BrixFormModel.GetInstance(&quot;XUSRMGT&quot;, &quot;XUSRMGT&quot;, Request, Response);

            if (!string.IsNullOrEmpty(model.form.ManagerDLL) &amp;&amp; !string.IsNullOrEmpty(model.form.FormManagerClass))
            {
                managerModel = AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(model.form.ManagerDLL,
                    model.form.FormManagerClass);
            }
        }

        public string GetInitilize_ClientId_ForUseInJavascript()
        {
            JavascriptRenderFramework jrf = new JavascriptRenderFramework(&quot;CONST_AddEditUser&quot;);

            jrf.Add_ClientId(
                 leftlist
                 , rightlist
                 , hdnroleid
                 , chlListUType
                 , txtUserID
                 , txtPassword
            );

            jrf.Add_Message(&quot;hdnSelectRoleFromAvailableRoles&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_SELECT_ROLE_FROM_AVAILABLE_ROLES&quot;, Enumerations.MessageType.WarningMessage));

            jrf.Add_Message(&quot;hdnSelectRoleFromSavedRoles&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_SELECT_ROLE_FROM_SAVED_ROLES&quot;, Enumerations.MessageType.WarningMessage));
            jrf.Add_Message(&quot;hdnExpiryDateVerification&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_VERIFY_ACCOUNT_EXPIRY_DATE&quot;, Enumerations.MessageType.WarningMessage));
            jrf.Add_Message(&quot;hdnSelectRoleToAssociateWithUser&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_SELECT_ROLE_TO_ASSOCIATE_WITH_USER&quot;, Enumerations.MessageType.WarningMessage));

            //The below two does not seems to have been used.But maintaining it to prevent breaking of any code
            jrf.Add_Message(&quot;hdnNoRolesAvailable&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_NO_ROLES_AVAILABLE&quot;, Enumerations.MessageType.WarningMessage));
            jrf.Add_Message(&quot;hdnUpdateDetails&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_CONFIRM_UPDATE_DETAILS&quot;, Enumerations.MessageType.WarningMessage));

            jrf.Add_Message(&quot;hdnCheckUidPassword&quot;, MessageResourceManager.GetString(&quot;W_USRMGMT_UID_PASSWORD_CANNOT_BE_SAME&quot;, Enumerations.MessageType.WarningMessage));
            jrf.Add_URL(&quot;cancelURL&quot;, &quot;~/Common/BrixListPage.aspx?context=USRMGMT&amp;IsRegistered=1&quot;, true, this);

            string scriptString = jrf.Generate();

            return scriptString;
        }

        protected override void OnInit(EventArgs e)
        {
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);
            PermissionsToCheck.Add(Constants.MODFEAT_CREATE);

            base.OnInit(e);

            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.OnInit(model, args);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                settinght = UserManager.Instance.GetUserSettings();

                lblMessage.Text = &quot;&quot;;

                // Populate Available Roles listbox
                leftlist.Items.Clear();
                // Since we are creating the user, there are no Saved roles.
                rightlist.Items.Clear();

                foreach (var kvp in ActiveRoles)
                    leftlist.Items.Add(new ListItem(kvp.Value, kvp.Key.ToString2()));

                if (_ModuleComponents != null &amp;&amp; _ModuleComponents.Contains(&quot;EnableADASupport&quot;))
                    trIsADACompliant.Visible = true;
                else
                    trIsADACompliant.Visible = false;

                if (!Page.IsPostBack)
                {
                    // Disable the Roles dropdown list
                    UIHelper.DisableRoleSelection(Page);

                    //setting default button for the page
                    var myForm = (HtmlForm)Page.Master.FindControl(&quot;form1&quot;);
                    myForm.DefaultButton = btnSave.UniqueID;

                    //for setting the regular exp for password from settings dictionary
                    SetPasswordRegexp(settinght[&quot;PasswordFormat&quot;]);

                    hdnNoRolesAvailable.Value = MessageResourceManager.GetString(&quot;W_USRMGMT_NO_ROLES_AVAILABLE&quot;, Enumerations.MessageType.WarningMessage);
                    
                    //hdnConfirmSaveDetails.Value =
                    //    MessageResourceManager.GetString(&quot;W_USRMGMT_CONFIRM_SAVE_DETAILS&quot;,
                    //        Enumerations.MessageType.WarningMessage);


                    //setting default expiry date from settings
                    string datestr = &quot;&quot;;
                    if (settinght.Count &gt; 0)
                    {
                        foreach (var kvp in settinght)
                        {
                            if (kvp.Key.ToString2() == &quot;AccountExpiry&quot;)
                            {
                                datestr = kvp.Value.ToString2();
                                break;
                            }
                        }

                        string[] datesplit = datestr.Split(&#39;|&#39;);
                        if (datesplit[0].ToInt32_2() &gt; 0)
                        {
                            webExpiryDate.Value = MWDateTimeHelper.MWToday.AddDays(datesplit[0].ToInt32_2() * 7);
                        }
                        else
                        {
                            DateTime? dt = MWDateTimeHelper.ToMWDateTimeFromUtcDateTimeInDBOpenXml(datesplit[1]);
                            webExpiryDate.Value = dt.HasValue ? dt.Value : MWDateTimeHelper.MWToday.AddDays(30);
                        }
                    }
                    else
                    {
                        webExpiryDate.Value = MWDateTimeHelper.MWToday.AddDays(30);
                    }

                    leftlist.Visible = true;
                    rightlist.Visible = true;
                    Addbutton.Visible = true;
                    Removebutton.Visible = true;

                    List&lt;string&gt; USRMGMTcomponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_USRMGMT);
                    if (!USRMGMTcomponents.Contains(&quot;ShowMandatoryLastName&quot;))
                    {
                        errlastname.Style.Value = &quot;display:none&quot;;
                        RequiredFieldValidatorLastName.Enabled = false;
                    }
                    if (USRMGMTcomponents.Contains(&quot;ADAuthentication&quot;))
                    {
                        txtCertNo.Enabled =
                            txtPassword.Enabled =
                                txtConfirmPassword.Enabled = passwordrfv.Enabled = confpasswordrfv.Enabled = false;
                        PwdErr.Style.Value = ConfirmPwdErr.Style.Value = &quot;display:none&quot;;
                    }

                    InitilizeBusinessUnits();
                    lblBusinessUnit.Text = LocalizationManager.GetString(&quot;BusinessUnit&quot;) + &quot; :&quot;;
                }
                else
                {
                    if (!string.IsNullOrEmpty(hdnroleid.Value))
                    {
                        string[] val = hdnroleid.Value.Split(&#39;,&#39;);
                        for (int i = 0; i &lt; val.Length; i++)
                        {
                            ListItem item = leftlist.Items.FindByValue(val[i]);
                            if (item != null)
                            {
                                rightlist.Items.Add(new ListItem(item.Text, item.Value));
                                leftlist.Items.Remove(item);
                            }
                        }
                    }
                }
                XmlFormArgs args = new XmlFormArgs();
                if (managerModel != null)
                    managerModel.OnPageLoad(model, args);
            }
            catch (Exception ex)
            {
                Logger.Log(Enumerations.LogType.Error, ex.Message, Constants.MODID_USRMGMT);
                throw;
            }

            List&lt;string&gt; UTILITYcomponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_UTILITY);
            if (!UTILITYcomponents.Contains(&quot;EnableMobile&quot;))
            {
                lblSMSAlert.Style.Add(&quot;display&quot;, &quot;none&quot;);
                chkSMSNotification.Style.Add(&quot;display&quot;, &quot;none&quot;);

                chlListUType.Items.FindByText(&quot;Mobile user&quot;).Attributes.CssStyle.Add(&quot;display&quot;, &quot;none&quot;);
            }

            PageTitle = &quot;Add User&quot;;
        }

        /// &lt;summary&gt;       
        /// Comments : Get Business Units and Bind for Adduser
        /// &lt;/summary&gt;
        private void InitilizeBusinessUnits()
        {
            DataTable dt_BusinessUnits = UserManager.Instance.GetBusinessUnits_ActiveOnly();
            // to fix XSS
            foreach (DataRow row in dt_BusinessUnits.Rows)
            {
                row[&quot;Name&quot;] = System.Web.HttpUtility.HtmlEncode(row[&quot;Name&quot;].ToString());
            }            

            radddlBusinessUnitTree.DataTextField = &quot;Name&quot;;
            radddlBusinessUnitTree.DataValueField = &quot;ID&quot;;
            radddlBusinessUnitTree.DataFieldID = &quot;ID&quot;;
            radddlBusinessUnitTree.DataFieldParentID = &quot;ParentID&quot;;
            radddlBusinessUnitTree.DataSource = dt_BusinessUnits;
            radddlBusinessUnitTree.DataBind();
            radddlBusinessUnitTree.ExpandAllDropDownNodes();
            if (dt_BusinessUnits.Rows.Count == 1) radddlBusinessUnitTree.SelectedText = dt_BusinessUnits.Rows[0][&quot;Name&quot;].ToString();
        }

        protected void SetPasswordRegexp(string pwdformat)
        {
            //int indx = pwdformat.IndexOf(&quot;{&quot;);
            int noofchars =
                pwdformat.Substring(pwdformat.IndexOf(&quot;{&quot;, StringComparison.CurrentCultureIgnoreCase) + 1,
                    pwdformat.IndexOf(&quot;,&quot;, StringComparison.CurrentCultureIgnoreCase) -
                    pwdformat.IndexOf(&quot;{&quot;, StringComparison.CurrentCultureIgnoreCase) - 1).ToInt32_2();

            //if (pwdformat.Contains(&quot;(?=[0-9]*)(?=.*[a-zA-Z])&quot;))
            //{
            //    regPassword.ErrorMessage =
            //        MessageResourceManager.GetString(&quot;M_USRMGMT_PASSWORD_FORMAT_ALPHABET&quot;,
            //                                         Enumerations.MessageType.InfoMessage, noofchars);
            //}
            //else if (pwdformat.Contains(&quot;(?=.*[0-9])(?=[a-zA-Z]*)&quot;))
            //{
            //    regPassword.ErrorMessage =
            //        MessageResourceManager.GetString(&quot;M_USRMGMT_PASSWORD_FORMAT_NUMBER&quot;,
            //                                         Enumerations.MessageType.InfoMessage, noofchars);
            //}
            //else if (pwdformat.Contains(&quot;(?=.*[0-9])(?=.*[a-zA-Z])&quot;))
            //{
            //    regPassword.ErrorMessage =
            //        MessageResourceManager.GetString(&quot;M_USRMGMT_PASSWORD_FORMAT_ALPHANUMERIC&quot;,
            //                                         Enumerations.MessageType.InfoMessage, noofchars);
            //}
            //else if (pwdformat.Contains(&quot;?=[0-9]*)(?=[a-zA-Z]*)&quot;))
            //{
            //    regPassword.ErrorMessage =
            //        MessageResourceManager.GetString(&quot;M_USRMGMT_PASSWORD_FORMAT_UNCONDITIONAL&quot;,
            //                                         Enumerations.MessageType.InfoMessage, noofchars);
            //}

            string errorMessage = UserManager.Instance.PasswordValidationMessage(pwdformat, noofchars);

            regPassword.ErrorMessage = errorMessage;
            regPassword.ValidationExpression = pwdformat;
            txtUserID.Focus();
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            try
            {
                Page.Validate();
                if (Page.IsValid)
                {
                    if (webExpiryDate.Value.ToDateTime_MWCulture() &lt;= MWDateTimeHelper.MWNow)
                    {
                        lblMessage.Text = MessageResourceManager.GetString(&quot;W_USRMGMT_VERIFY_ACCOUNT_EXPIRY_DATE&quot;, Enumerations.MessageType.WarningMessage);
                        return;
                    }

                    string errorMsg = string.Empty;
                    if (!UserManager.Instance.ValidationPasswordAgaintUserID(txtUserID.Text.Trim(), txtPassword.Text.ToString2(), out errorMsg))
                    {
                        lblMessage.Text = errorMsg;
                        return;
                    }

                    if (!string.IsNullOrEmpty(ConnectionHelper.GetCurrentCompany()) &amp;&amp;
                        CompanyManager.Instance.GetCurrentCompanyDetails().UserLicenseType == UserLicenseType.Named)
                    {
                        if (UserManager.Instance.GetAllUsersCount(null) &gt;=
                            CompanyManager.Instance.GetCurrentCompanyDetails().UserLimit)
                            throw new Exception(&quot;Please upgrade to create more users.&quot;);
                    }

                    List&lt;string&gt; USRMGMTcomponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_USRMGMT);
                    if (USRMGMTcomponents.Contains(&quot;AllowDuplicateEmailID&quot;) ||
                        UserManager.Instance.CheckForUniqueEmail(txtEmailID.Text.Trim(), txtUserID.Text.Trim()))
                    {
                        XmlFormArgs args = new XmlFormArgs();
                        if (managerModel != null)
                            managerModel.BeforeSave(model, args);
                        if (managerModel == null || args.IsValid)
                        {

                            int uid;

                            //instantiate DTO class
                            var UserDTO = new User();

                            //assign values to DTO properties
                            UserDTO.UserName = txtUserID.Text.Trim();
                            UserDTO.FirstName = txtFirstName.Text.Trim();
                            UserDTO.MiddleName = txtMiddleName.Text.Trim();
                            UserDTO.LastName = txtLastName.Text.Trim();
                            UserDTO.Password = txtPassword.Text.Trim();
                            UserDTO.Email = txtEmailID.Text.Trim();

                            UserDTO.CompanyName = txtCompany.Text.Trim();
                            UserDTO.Address1 = txtAddressLine1.Text.Trim();
                            UserDTO.Address2 = txtAddressLine2.Text.Trim();
                            UserDTO.Address3 = txtAddressLine3.Text.Trim();
                            UserDTO.City = txtCity.Text.Trim();
                            UserDTO.State = txtState.Text.Trim();
                            UserDTO.Country = txtCountry.Text.Trim();
                            UserDTO.Zipcode = txtZIP.Text.Trim();
                            UserDTO.Telephone = txtTelephone.Text.Trim();
                            UserDTO.Fax = txtFax.Text.Trim();
                            UserDTO.WebUser = chlListUType.Items[0].Selected ? 1 : 0;
                            UserDTO.MobileUser = chlListUType.Items[1].Selected ? 1 : 0;
                            //UserDTO.SendEmail = chkSendNotification.Checked;
                            UserDTO.IsSMS = chkSMSNotification.Checked;
                            UserDTO.MobileNo = txtMobile.Text.Trim();

                            UserDTO.AUR_ModifiedBy = UserDetail.GetCurrentUserDetail().UID;
                            UserDTO.AUR_ModifiedOn = DateTime.UtcNow;
                            UserDTO.IsADACompliant = chkIsADACompliant.Checked;

                            //If the MustChangePasswordOnFirstLogin is not set, update PasswordlastChangedOn to current date.
                            if (settinght[&quot;MustChangePasswordOnFirstLogin&quot;] == &quot;0&quot;)
                            {
                                UserDTO.PasswordLastChangedOn = DateTime.UtcNow;
                            }

                            if (webExpiryDate.Value == null)
                            {
                                string datestr = &quot;&quot;;
                                if (settinght.Count &gt; 0)
                                {
                                    foreach (var kvp in settinght)
                                    {
                                        if (kvp.Key.ToString2() == &quot;AccountExpiry&quot;)
                                        {
                                            datestr = kvp.Value.ToString2(); // value coming from settings should be in utc
                                            break;
                                        }
                                    }

                                    string[] datesplit = datestr.Split(&#39;|&#39;);
                                    //UserDTO.ExpiryDate = Convert.ToDateTime(datesplit[1], CultureInfo.InvariantCulture);

                                    if (datesplit[0].ToInt32_2() &gt; 0)
                                    {
                                        UserDTO.ExpiryDate =MWDateTimeHelper.MWToday.ToUtc().AddDays(datesplit[0].ToInt32_2() * 7);
                                    }
                                    else
                                    {
                                        DateTime? dt = MWDateTimeHelper.ToMWDateTimeFromUtcDateTimeInDBOpenXml(datesplit[1]);
                                        UserDTO.ExpiryDate = dt.HasValue ? dt.Value.ToMWUtcDateTime() : MWDateTimeHelper.MWToday.ToUtc().AddDays(30); //Convert.ToDateTime(datesplit[1], CultureInfo.InvariantCulture).ToDateTime_MWCulture();
                                    }
                                }
                                else
                                {
                                    UserDTO.ExpiryDate = MWDateTimeHelper.MWToday.ToUtc().AddDays(30);
                                }
                            }
                            else
                            {
                                UserDTO.ExpiryDate = webExpiryDate.Value.ToDateTime_MWCulture().ToMWUtcDateTime();
                            }
                            UserDTO.RegDate = DateTime.UtcNow;
                            UserDTO.IsRegistered = true;
                            UserDTO.IsActive = true;
                            UserDTO.CertNo = (txtCertNo.Text.Trim() == &quot;&quot;) ? &quot;NA&quot; : txtCertNo.Text;


                            // Checking for the license
                            string errMsg = string.Empty;
                            if (!LicenseManager.Instance.ValidateLicense(ref errMsg, &quot;0&quot;, &quot;MobileLicense&quot;))
                            {
                                lblMessage.Text = errMsg;
                                return;
                            }

                            //call the BL createuser method
                            uid = UserManager.Instance.CreateUser(UserDTO, &quot;adduser&quot;);

                            //Change: Send Email Notification After User Id is created in System 
                            if (chkSendNotification.Checked)
                            {
                                try
                                {
                                    string body = &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot; +
                                        &quot;Your new &quot; + AMP3ApplicationSettings.Instance.AppName +
                                        &quot; account login details are given below. You can now login to &quot; +
                                        AMP3ApplicationSettings.Instance.AppName
                                        + &quot; with this User Id and Password.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td &gt;User Id: &quot; +
                                        txtUserID.Text.Trim() + &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Password: &quot; + txtPassword.Text.Trim() +
                                        &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
                                    Mailer.SendEmail(txtEmailID.Text.Trim(),
                                        &quot;New &quot; + AMP3ApplicationSettings.Instance.AppName + &quot; Account&quot;, body, isBodyHtml:true);
                                }
                                catch (Exception ex)
                                {
                                    lblMessage.Text = ex.Message;
                                    return;
                                }
                            }

                            if (uid &gt; 0)
                            {
                                userIDForIXMLControl = uid;

                                // Call Save BusinessUnit Method
                                int rowAffected = UserManager.Instance.AddMultipleBusinessUnitIdsToUser(radddlBusinessUnitTree.SelectedValue, uid);

                                //when a user is created, create an entry in the PasswordChangeHistory table
                                //as this is the first password that the user has used
                                string userIP = Request.UserHostAddress;

                                UserManager.Instance.AddPasswordChangeHistory(null, UserDTO.UserName, UserDTO.Password,
                                    userIP, null, &quot;New user created&quot;);

                                UserMapping mappingdto = new UserMapping();
                                mappingdto.EmailID = UserDTO.Email;
                                mappingdto.UserName = UserDTO.UserName;
                                mappingdto.CompanyCode = Session[&quot;CompanyCode&quot;].ToString();
                                mappingdto.IsCompanyActive = true;
                                mappingdto.IsAdmin = false;
                                mappingdto.Mode = &quot;C&quot;;

                                SignUpManager.Instance.CUDUserMapping(mappingdto);

                                string roleids = hdnroleid.Value.ToString2();
                                int result = 0;

                                if (!String.IsNullOrEmpty(roleids))
                                {
                                    string[] val = roleids.Split(&#39;,&#39;);
                                    for (int i = 0; i &lt; val.Length; i++)
                                    {
                                        result = UserManager.Instance.AddRolesToUser(uid, val[i].ToInt32_2());
                                    }
                                }
                                else
                                {
                                    // Add default role, if no role selected(default role is User)
                                    result = UserManager.Instance.AddRolesToUser(uid, Constants.USRMGMT_USER_RID);
                                }

                                if (result &gt; 0)
                                {
                                    if (chkSMSNotification.Checked &amp;&amp; !string.IsNullOrEmpty(txtMobile.Text.Trim()))
                                        SMSManager.SendSMS(txtMobile.Text.Trim(),
                                            &quot;Your new &quot; + AMP3ApplicationSettings.Instance.AppName +
                                            &quot; account is now active. You can now logon with your credentials.&quot;);
                                    if (chkSendNotification.Checked)
                                    {
                                        User adminUser = UserManager.Instance.GetAUser(Constants.USRMGMT_ADMIN_UID);
                                        string port = Request.ServerVariables[&quot;SERVER_PORT&quot;];
                                        string protocol = Request.ServerVariables[&quot;SERVER_PORT_SECURE&quot;];

                                        port = (port == null || port == &quot;80&quot; || (port == &quot;443&quot; &amp;&amp; protocol != &quot;0&quot;))
                                            ? string.Empty
                                            : port = &quot;:&quot; + port;

                                        protocol = (protocol == null || protocol == &quot;0&quot;) ? &quot;http://&quot; : &quot;https://&quot;;

                                        string baseURL = protocol + Request.ServerVariables[&quot;SERVER_NAME&quot;] +
                                                         port + Request.ApplicationPath;

                                        string body =
                                            &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;{0}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;tr&gt;&lt;td&gt;&lt;tr&gt;&lt;td&gt; User Id: {1}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Password: {2}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;tr&gt;&lt;td&gt;&lt;tr&gt;&lt;td&gt;{3}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;tr&gt;&lt;td&gt;&lt;tr&gt;&lt;td&gt;{4}&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;
                                                .Format2(
                                                    &quot;Your new &quot; + AMP3ApplicationSettings.Instance.AppName +
                                                    &quot;  account is now active; your login information is: &quot;,
                                                    txtUserID.Text.Trim(),
                                                    txtPassword.Text.Trim(),
                                                    &quot;You can now logon to the &quot; + AMP3ApplicationSettings.Instance.AppName +
                                                    &quot;  with this User Id and Password at &quot; + baseURL,
                                                    &quot;If you have any problems or questions, you can email the &quot;
                                                    + AMP3ApplicationSettings.Instance.AppName
                                                    + &quot;  administrator at &quot;
                                                    + &quot;&lt;A title=mailto:&quot; + adminUser.Email + &quot; href=\&quot;mailto:&quot; +
                                                    adminUser.Email +
                                                    &quot;\&quot;&gt;&quot; + adminUser.Email + &quot;&lt;/A&gt;&quot;
                                                    +
                                                    (String.IsNullOrEmpty(adminUser.Telephone)
                                                        ? &quot;.&quot;
                                                        : (&quot; or call the administrator desk at &quot; + adminUser.Telephone)));
                                        try
                                        {
                                            Mailer.SendEmail(txtEmailID.Text.Trim(),
                                                &quot;New &quot; + AMP3ApplicationSettings.Instance.AppName + &quot;  Account&quot;,
                                                body,isBodyHtml:true);
                                        }
                                        catch (Exception ex)
                                        {
                                            Logger.Log(Enumerations.LogType.Error, ex.ToString2(), Constants.MODID_USRMGMT);
                                        }
                                    }
                                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=USRMGMT&amp;IsRegistered=1&quot;, false);
                                }
                                model.form.instanceID = uid.ToString();
                                if (managerModel != null)
                                    managerModel.AfterSave(model, args);
                            }
                            else if (uid == -1)
                            {
                                lblMessage.Text =
                                    MessageResourceManager.GetString(&quot;W_USRMGMT_USERID_ALREADY_EXISTS&quot;,
                                        Enumerations.MessageType.WarningMessage);
                                SkipDefaultXMLInjectionSave = true;
                                //resourcemgr.GetString(&quot;ModifyUsername&quot;);
                            }
                            else if (uid == -2)
                            {
                                lblMessage.Text =
                                    MessageResourceManager.GetString(&quot;W_USRMGMT_EMAILID_ALREADY_EXISTS&quot;,
                                        Enumerations.MessageType.WarningMessage);
                                SkipDefaultXMLInjectionSave = true;
                                //resourcemgr.GetString(&quot;ModifyUseremail&quot;);
                            }
                            else
                            {
                                lblMessage.Text = &quot;Cert. No. already exists.&quot;;
                                SkipDefaultXMLInjectionSave = true;
                            }
                        }
                    }
                    else
                    {
                        lblMessage.Text = &quot;Please enter a unique Email ID&quot;;
                        SkipDefaultXMLInjectionSave = true;
                    }
                }
                else
                {
                    SkipDefaultXMLInjectionSave = true;
                }
            }
            catch (Exception ex)
            {
                SkipDefaultXMLInjectionSave = true;
                Logger.Log(Enumerations.LogType.Error, ex.Message, Constants.MODID_USRMGMT);
                throw;
            }
        }

        protected void btnReset_Click(object sender, EventArgs e)
        {
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            Response.Redirect(&quot;~/Common/BrixListPage.aspx?Context=USRMGMT&amp;IsRegistered=1&quot;, true);
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            menus.Add(new BrixMenu(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;, 55));
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            Core.UserControls.Menu saveMenu = MainToolBar.GetMenuReference(&quot;lnkSave&quot;);
            if (saveMenu != null)
            {
                saveMenu.OnClientClick = &quot;return fnSave_ForAddUserPage()&quot;;
                saveMenu.Click += btnSave_Click;
            }
            Core.UserControls.Menu cancelMenu = MainToolBar.GetMenuReference(&quot;lnkCancel&quot;);
            if (cancelMenu != null)
            {
                cancelMenu.PostBackUrl = &quot;~/Common/BrixListPage.aspx?Context=USRMGMT&amp;IsRegistered=1&quot;;
                cancelMenu.CausesValidation = false;
            }
            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.AfterCustomizeToolbar(model, MainToolBar, args);
        }        
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,46,1],[38,13,38,14,1],[39,17,39,66,1],[40,21,40,109,1],[42,17,42,88,1],[43,13,43,14,1],[50,21,50,22,1],[50,23,50,68,1],[50,69,50,70,1],[55,17,55,18,0],[55,19,55,40,0],[55,41,55,42,0],[56,17,56,18,0],[56,19,56,20,0],[61,13,61,17,0],[61,18,61,22,1],[65,9,65,10,0],[67,13,67,14,0],[68,17,68,42,0],[69,21,69,115,0],[70,13,70,14,0],[71,13,71,34,0],[72,13,72,14,0],[73,17,73,27,0],[75,9,75,10,0],[79,9,79,10,0],[81,13,81,14,0],[82,17,82,42,0],[83,21,83,107,0],[84,13,84,14,0],[85,13,85,34,0],[86,13,86,14,0],[87,17,87,27,0],[89,9,89,10,0],[94,9,94,10,1],[95,13,95,46,1],[96,13,96,80,1],[97,9,97,10,1],[100,9,100,10,1],[101,13,101,55,1],[102,17,102,67,0],[103,13,103,31,1],[104,13,104,31,1],[105,13,105,38,1],[106,17,106,66,0],[107,9,107,10,1],[110,9,110,10,1],[111,13,111,88,1],[113,13,113,116,1],[114,13,114,14,0],[115,17,116,50,0],[117,13,117,14,0],[118,9,118,10,1],[121,9,121,10,1],[122,13,122,96,1],[124,13,131,15,1],[133,13,133,185,1],[135,13,135,177,1],[136,13,136,173,1],[137,13,137,188,1],[140,13,140,159,1],[141,13,141,160,1],[143,13,143,168,1],[144,13,144,111,1],[146,13,146,50,1],[148,13,148,33,1],[149,9,149,10,1],[152,9,152,10,1],[153,13,153,66,1],[154,13,154,62,1],[156,13,156,28,1],[158,13,158,50,1],[159,13,159,38,1],[160,17,160,50,0],[161,9,161,10,1],[164,9,164,10,1],[166,13,166,14,1],[167,17,167,68,1],[169,17,169,38,1],[172,17,172,40,1],[174,17,174,41,1],[176,17,176,24,1],[176,26,176,33,1],[176,34,176,36,1],[176,37,176,48,1],[177,21,177,86,1],[179,17,179,97,1],[180,21,180,53,0],[182,21,182,54,1],[184,17,184,38,1],[185,17,185,18,1],[187,21,187,57,1],[190,21,190,77,1],[191,21,191,61,1],[194,21,194,68,1],[196,21,196,155,1],[204,21,204,41,1],[205,21,205,45,1],[206,21,206,22,1],[207,25,207,32,1],[207,34,207,41,1],[207,42,207,44,1],[207,45,207,54,1],[208,25,208,26,1],[209,29,209,72,1],[210,29,210,30,1],[211,33,211,65,1],[212,33,212,39,1],[214,25,214,26,1],[216,25,216,65,1],[217,25,217,58,1],[218,25,218,26,1],[219,29,219,114,1],[220,25,220,26,1],[222,25,222,26,1],[223,29,223,114,1],[224,29,224,113,1],[225,25,225,26,1],[226,21,226,22,1],[228,21,228,22,0],[229,25,229,84,0],[230,21,230,22,0],[232,21,232,45,1],[233,21,233,46,1],[234,21,234,46,1],[235,21,235,49,1],[237,21,237,123,1],[238,21,238,78,1],[239,21,239,22,1],[240,25,240,66,1],[241,25,241,72,1],[242,21,242,22,1],[243,21,243,72,1],[244,21,244,22,0],[245,25,247,116,0],[248,25,248,89,0],[249,21,249,22,0],[251,21,251,46,1],[252,21,252,97,1],[253,17,253,18,1],[255,17,255,18,1],[256,21,256,64,1],[257,21,257,22,1],[258,25,258,67,1],[259,30,259,39,1],[259,41,259,55,1],[259,57,259,60,1],[260,25,260,26,1],[261,29,261,80,1],[262,29,262,46,1],[263,29,263,30,1],[264,33,264,90,1],[265,33,265,61,1],[266,29,266,30,1],[267,25,267,26,1],[268,21,268,22,1],[269,17,269,18,1],[270,17,270,54,1],[271,17,271,42,1],[272,21,272,58,0],[273,13,273,14,1],[274,13,274,33,0],[275,13,275,14,0],[276,17,276,93,0],[277,17,277,23,0],[280,13,280,115,1],[281,13,281,61,1],[282,13,282,14,0],[283,17,283,58,0],[284,17,284,65,0],[286,17,286,105,0],[287,13,287,14,0],[289,13,289,36,1],[290,9,290,10,1],[296,9,296,10,1],[297,13,297,93,1],[299,13,299,20,1],[299,22,299,33,1],[299,34,299,36,1],[299,37,299,58,1],[300,13,300,14,1],[301,17,301,89,1],[302,13,302,14,1],[304,13,304,59,1],[305,13,305,58,1],[306,13,306,55,1],[307,13,307,67,1],[308,13,308,66,1],[309,13,309,47,1],[310,13,310,61,1],[311,13,311,50,1],[311,51,311,133,0],[312,9,312,10,1],[315,9,315,10,1],[317,13,320,104,1],[347,13,347,104,1],[349,13,349,53,1],[350,13,350,58,1],[351,13,351,31,1],[352,9,352,10,1],[355,9,355,10,1],[357,13,357,14,1],[358,17,358,33,1],[359,17,359,34,1],[360,17,360,18,1],[361,21,361,94,1],[362,21,362,22,0],[363,25,363,157,0],[364,25,364,32,0],[367,21,367,52,1],[368,21,368,145,1],[369,21,369,22,1],[370,25,370,52,1],[371,25,371,32,1],[374,21,375,117,1],[376,21,376,22,0],[377,25,378,90,0],[379,29,379,89,0],[380,21,380,22,0],[382,21,382,123,1],[383,21,384,113,1],[385,21,385,22,1],[386,25,386,62,1],[387,25,387,50,1],[388,29,388,66,0],[389,25,389,66,1],[390,25,390,26,1],[395,29,395,54,1],[398,29,398,70,1],[399,29,399,74,1],[400,29,400,76,1],[401,29,401,72,1],[402,29,402,72,1],[403,29,403,68,1],[405,29,405,74,1],[406,29,406,76,1],[407,29,407,76,1],[408,29,408,76,1],[409,29,409,64,1],[410,29,410,66,1],[411,29,411,70,1],[412,29,412,66,1],[413,29,413,74,1],[414,29,414,62,1],[415,29,415,86,1],[416,29,416,89,1],[418,29,418,72,1],[419,29,419,70,1],[421,29,421,92,1],[422,29,422,70,1],[423,29,423,80,1],[426,29,426,84,1],[427,29,427,30,1],[428,33,428,81,1],[429,29,429,30,1],[431,29,431,61,1],[432,29,432,30,0],[433,33,433,53,0],[434,33,434,57,0],[435,33,435,34,0],[436,37,436,44,0],[436,46,436,53,0],[436,54,436,56,0],[436,57,436,66,0],[437,37,437,38,0],[438,41,438,84,0],[439,41,439,42,0],[440,45,440,77,0],[441,45,441,51,0],[443,37,443,38,0],[445,37,445,77,0],[448,37,448,70,0],[449,37,449,38,0],[450,41,450,132,0],[451,37,451,38,0],[453,37,453,38,0],[454,41,454,126,0],[455,41,455,150,0],[456,37,456,38,0],[457,33,457,34,0],[459,33,459,34,0],[460,37,460,103,0],[461,33,461,34,0],[462,29,462,30,0],[464,29,464,30,1],[465,33,465,115,1],[466,29,466,30,1],[467,29,467,63,1],[468,29,468,57,1],[469,29,469,53,1],[470,29,470,100,1],[474,29,474,58,1],[475,29,475,108,1],[476,29,476,30,0],[477,33,477,58,0],[478,33,478,40,0],[482,29,482,87,1],[485,29,485,61,1],[486,29,486,30,0],[488,33,488,34,0],[489,37,495,62,0],[496,37,497,128,0],[498,33,498,34,0],[499,33,499,53,0],[500,33,500,34,0],[501,37,501,66,0],[502,37,502,44,0],[504,29,504,30,0],[506,29,506,41,1],[507,29,507,30,1],[508,33,508,60,1],[511,33,511,148,1],[515,33,515,73,1],[517,33,518,71,1],[520,33,520,76,1],[521,33,521,68,1],[522,33,522,72,1],[523,33,523,92,1],[524,33,524,67,1],[525,33,525,60,1],[526,33,526,55,1],[528,33,528,83,1],[530,33,530,78,1],[531,33,531,48,1],[533,33,533,68,1],[534,33,534,34,1],[535,37,535,71,1],[536,42,536,51,1],[536,53,536,67,1],[536,69,536,72,1],[537,37,537,38,1],[538,41,538,111,1],[539,37,539,38,1],[540,33,540,34,1],[542,33,542,34,0],[544,37,544,115,0],[545,33,545,34,0],[547,33,547,48,1],[548,33,548,34,1],[549,37,549,116,1],[550,41,552,113,0],[553,37,553,69,1],[554,37,554,38,0],[555,41,555,117,0],[556,41,556,94,0],[557,41,557,105,0],[559,41,561,65,0],[563,41,563,115,0],[565,41,566,89,0],[568,41,586,123,0],[588,41,588,42,0],[589,45,591,71,0],[592,41,592,42,0],[593,41,593,61,0],[594,41,594,42,0],[595,45,595,125,0],[596,41,596,42,0],[597,37,597,38,0],[598,37,598,123,1],[599,33,599,34,1],[600,33,600,72,1],[601,33,601,58,1],[602,37,602,73,0],[603,29,603,30,1],[604,34,604,48,1],[605,29,605,30,1],[606,33,608,82,1],[609,33,609,68,1],[611,29,611,30,1],[612,34,612,48,0],[613,29,613,30,0],[614,33,616,82,0],[617,33,617,68,0],[619,29,619,30,0],[621,29,621,30,0],[622,33,622,79,0],[623,33,623,68,0],[624,29,624,30,0],[625,25,625,26,1],[626,21,626,22,1],[628,21,628,22,1],[629,25,629,76,1],[630,25,630,60,1],[631,21,631,22,1],[632,17,632,18,1],[634,17,634,18,0],[635,21,635,56,0],[636,17,636,18,0],[637,13,637,14,1],[638,13,638,33,0],[639,13,639,14,0],[640,17,640,52,0],[641,17,641,93,0],[642,17,642,23,0],[644,9,644,10,1],[647,9,647,10,0],[648,9,648,10,0],[651,9,651,10,0],[652,13,652,98,0],[653,9,653,10,0],[656,9,656,10,1],[657,13,657,41,1],[658,13,658,76,1],[659,13,659,82,1],[660,13,660,44,1],[661,9,661,10,1],[664,9,664,10,1],[665,13,665,87,1],[666,13,666,34,1],[667,13,667,14,1],[668,17,668,75,1],[669,17,669,49,1],[670,13,670,14,1],[671,13,671,91,1],[672,13,672,36,1],[673,13,673,14,1],[674,17,674,102,1],[675,17,675,53,1],[676,13,676,14,1],[677,13,677,50,1],[678,13,678,38,1],[679,17,679,78,0],[680,9,680,10,1]]);
    </script>
  </body>
</html>