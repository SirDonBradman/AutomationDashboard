<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Main Modules\Contract Manager\UI\AXForecast.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Drawing;
using System.Globalization;
using System.Linq;
using System.Reflection;
using System.Threading;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ContractManager.BusinessLayer;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.BusinessLayer.BL;
using Aurigo.AMP3.Core.BusinessLayer.DTO;
using Aurigo.AMP3.Core.IntegrationConnector;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Construction.ContractManager.BusinessLayer.BL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Infragistics.WebUI.UltraWebGrid;
using Microsoft.Practices.EnterpriseLibrary.Data;
using System.Web.Script.Serialization;
namespace Aurigo.AMP3.ContmgtUI
{
    public partial class AXForecast : BrixPageBase, IWorkflowEnabled
    {
        public static StoredProcedure usp_AXFRCSTCUItemDetails =
            new StoredProcedure
                {Name = &quot;usp_AXFRCSTCUItemDetails&quot;, Input = &quot;ForecastID,ItemID,Quantity,UnitPrice,Amount&quot;};

        public static StoredProcedure usp_AXFRCSTCUResourceDetails =
            new StoredProcedure
                {
                    Name = &quot;usp_AXFRCSTCUResourceDetails&quot;,
                    Input =
                        &quot;ForecastID,ResItemID,ParentResItemId,ResourceTypeName,Description,Unit,Quantity,Rate,Cost,RateAnalysisRate,Size,Color,Configuration&quot;
                };

        public static StoredProcedure usp_QTYPLANGetForecastQty =
            new StoredProcedure {Name = &quot;usp_QTYPLANGetForecastQty&quot;, Input = &quot;ContractID,StartDate,EndDate&quot;};

        public static StoredProcedure usp_QTYPLANGetForecastOverheadCost =
            new StoredProcedure {Name = &quot;usp_QTYPLANGetForecastOverheadCost&quot;, Input = &quot;ContractID,StartDate,EndDate&quot;};

        public static StoredProcedure usp_QTYPLANGetForecastSubcontractQty =
            new StoredProcedure {Name = &quot;usp_QTYPLANGetForecastSubcontractQty&quot;, Input = &quot;ContractID,StartDate,EndDate&quot;};

        public static StoredProcedure usp_CONTMGTAXFRCSTMain =
           new StoredProcedure { Name = &quot;usp_CONTMGTAXFRCSTMain&quot;, Input = &quot;ForecastID&quot; };
        public static StoredProcedure usp_CONTMGTAXFRCSTResourcedetails =
           new StoredProcedure { Name = &quot;usp_CONTMGTAXFRCSTResourcedetails&quot;, Input = &quot;ForecastID&quot; };
        public static StoredProcedure usp_CONTMGTAXFRCSTAXFRCSTItemDetails =
           new StoredProcedure { Name = &quot;usp_CONTMGTAXFRCSTAXFRCSTItemDetails&quot;, Input = &quot;ForecastID&quot; };
        public static StoredProcedure usp_CONTMGTAXFRCSTDeleteAXFRCSTResourceDetails =
          new StoredProcedure { Name = &quot;usp_CONTMGTAXFRCSTDeleteAXFRCSTResourceDetails&quot;, Input = &quot;forecastID&quot; };
        public static StoredProcedure usp_CONTMGTAXFRCSTDeleteAXFRCSTItemDetails =
           new StoredProcedure { Name = &quot;usp_CONTMGTAXFRCSTDeleteAXFRCSTItemDetails&quot;, Input = &quot;forecastID&quot; };
        private bool isApproved;
        private List&lt;String&gt; permission;

        private string ProjectMode
        {
            get
            {
                return (CacheManager.Instance.IsIntegrated(Request.QueryString[Constants.QRY_PROJECTID].ToInt32_2())
                            ? &quot;I&quot;
                            : &quot;L&quot;);
            }
        }

        /// Gets the Integration Cutoff Date
        /// &lt;/summary&gt;
        private DateTime IntegrationCutoffDate
        {
            get { return ((DateTime) Session[Constants.APP_IntegrationCutoffDate]).AddDays(-1); }
        }

        /// &lt;summary&gt;
        /// Gets the Default Record Date
        /// &lt;/summary&gt;
        private DateTime DefaultRecordDate
        {
            get { return (DateTime) Session[Constants.APP_DefaultRecordDate]; }
        }

        private string CurrentVersion
        {
            get { return Constants.MODID_CONTMGT; }
        }

        #region IWorkflowEnabled Members

        public void CancelHandler(object sender, bool bAfterSave, out string sRedirectTo)
        {
            throw new NotImplementedException();
        }

        public string ClientValidationFunction
        {
            get { return string.Empty; }
        }


        public string FormInstanceId
        {
            get
            {
                int id = (String.IsNullOrEmpty(Request.QueryString[&quot;InstanceID&quot;]) ||
                          Request.QueryString[&quot;InstanceID&quot;] == &quot;0&quot;)
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;InstanceID&quot;], out id) ? id : -1;
                return id.ToString();
            }
        }

        public string FormKey { get { return string.Format(&quot;Start Date : {0}, End Date : {1}&quot;, ((DateTime)dtStartDate.Value).ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture), ((DateTime)dtEndDate.Value).ToString(AMP3ApplicationSettings.Instance.FORMAT_DATE, CultureInfo.CurrentCulture)); } }

        public string FormName
        {
            get { return &quot;XFRCAST&quot;; }
        }

        public bool IsOldWorkflow
        {
            get { return true; }
        }

        public int PID
        {
            get { return Request.QueryString[&quot;PID&quot;].ToInt32_2(); }
        }

        public int ParentModuleId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;ParentID&quot;])
                             ? -1
                             : int.TryParse(Request.QueryString[&quot;ParentID&quot;], out id) ? id : -1;
                return id;
            }
        }

        public string PostCancelRedirectUrl
        {
            get
            {
                return String.Format(CultureInfo.CurrentCulture,
                                     &quot;~/Common/BrixListPage.aspx?context=AXFRCST&amp;PID={0}&amp;ParentID={1}&quot;, PID,
                                     ParentModuleId);
            }
        }

        public string PostSaveRedirectUrl(string sSavedToken = &quot;&quot;)
        {
            return PostCancelRedirectUrl;
        }

        public bool SaveHandler(object sender, out string sSavedInstanceToken, out string sErrors,
                                out string sRedirectTo)
        {
            sSavedInstanceToken = &quot;&quot;;
            sErrors = &quot;&quot;;
            sRedirectTo = &quot;&quot;;

            SaveForecast(out sSavedInstanceToken, out sErrors);

            if (sSavedInstanceToken != &quot;-1&quot; &amp;&amp; string.IsNullOrEmpty(sErrors))
                return true;
            else
                throw new Exception(sErrors);
        }

        #endregion

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            if (!IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
            {
                hdnIsAXConnected.Value = &quot;No&quot;;
                trForecastModel.Style.Add(&quot;display&quot;, &quot;none&quot;);
            }
            else
                hdnIsAXConnected.Value = &quot;Yes&quot;;
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;V&quot;)))
                AddSaveButton(menus);
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
        }

        protected override void CustomizeToolBar()
        {
            if (!(Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;].Equals(&quot;V&quot;)))
            {
                if (HasSaveButton)
                {
                    Aurigo.AMP3.Core.UserControls.Menu lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        lnkSave.Click += btnSave_Click;           
                        lnkSave.OnClientClick = &quot;return ValidateSave();&quot;;
                    }
                }              
            }
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += lnkBack_Click;
            MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(Request[&quot;Mode&quot;]))
                Response.Redirect(@&quot;~/Common/BrixListPage.aspx?Context=AXFRCST&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ParentID=&quot; +
                                  Request[&quot;ParentID&quot;]);

            if (Request[&quot;InstanceID&quot;] != null &amp;&amp; Request[&quot;InstanceID&quot;] != &quot;0&quot;)
            {
                isApproved = (from f in ContractManagerDb.Db.ForecastMain
                              where f.ForecastID == Request[&quot;InstanceID&quot;].ToInt32_2()
                              select f.IsApproved).FirstOrDefault();
            }
            if ((Request[&quot;Mode&quot;].Equals(&quot;E&quot;) &amp;&amp; isApproved) ||
                (Request[&quot;Mode&quot;].Equals(&quot;N&quot;) &amp;&amp; Request[&quot;InstanceID&quot;] != &quot;0&quot;))
                Response.Redirect(@&quot;~/Common/BrixListPage.aspx?Context=AXFRCST&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ParentID=&quot; +
                                  Request[&quot;ParentID&quot;]);

            permission = ModuleManager.Instance.GetPermissionByUserOrRole(CurrentVersion, UserDetail.GetCurrentUserDetail().UID,
                            UserDetail.GetCurrentUserDetail().RID, Request.QueryString[&quot;PID&quot;].ToInt32_2());
            hdnBOQ.Value = ItemNameAbbr;
            EnsureChildControls();
            dtEndDate.CalendarLayout.Culture = DateFormatCulture.GetDateFormatCulture();
            dtStartDate.CalendarLayout.Culture = DateFormatCulture.GetDateFormatCulture();

            if (!Page.IsPostBack)
            {
                dtCreatedOn.MinDate = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : DefaultRecordDate.ToMWDateTime();
                dtCreatedOn.MaxDate = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : IntegrationCutoffDate.ToMWDateTime();
                dtCreatedOn.Value = ProjectMode.Equals(&quot;L&quot;) ? DateTime.UtcNow.ToMWDateTime() : DefaultRecordDate.ToMWDateTime();
                dtCreatedOn.Enabled = !ProjectMode.Equals(&quot;L&quot;);

                dtStartDate.Value = MWDateTimeHelper.MWNow;
                dtEndDate.Value = MWDateTimeHelper.MWNow;

                //Get the Forecast Models available in AX
                if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                {
                    DataTable dtBudgetModels = null;
                    int forecastCount = 0;
                    var dsForecast = new DataSet();
                    var dictAdditionalInfo = new Dictionary&lt;RegisteredEIS, EISAdditionalInfo&gt;();
                    dictAdditionalInfo.Add(RegisteredEIS.AX,
                                           new EISAdditionalInfo(RegisteredEIS.AX).AddInfo(&quot;AXCompany&quot;,
                                                                                           Session[
                                                                                               Constants.
                                                                                                   EIS_ADDITIONAL_INFO].
                                                                                               ToString()));

                    var connectorParameters =
                        new ConnectorParameters(dictAdditionalInfo, MethodBase.GetCurrentMethod(),
                                                AMP3ObjectType.Unknown,
                                                new ConnectionFilter(null, null, null, null, null), null);
                    if (IntegrationConnectorManager.HandleIntegration(connectorParameters, ref forecastCount,
                                                                      ref dsForecast, true))
                    {
                        if (dsForecast.Tables[0] != null &amp;&amp; dsForecast.Tables[0].Rows.Count &gt; 0)
                        {
                            dtBudgetModels = dsForecast.Tables[0];
                            ddlBudgetModel.DataSource = dtBudgetModels;
                            ddlBudgetModel.DataTextField = &quot;Txt&quot;;
                            ddlBudgetModel.DataValueField = &quot;ModelId&quot;;
                            ddlBudgetModel.DataBind();
                            ddlBudgetModel.Items.Insert(0, new ListItem(&quot;Select&quot;, &quot;-1&quot;));
                        }
                    }
                }
                if (Request[&quot;InstanceID&quot;] != null &amp;&amp; Request[&quot;InstanceID&quot;] != &quot;0&quot;)
                {
                    int ForecastID = Request[&quot;InstanceID&quot;].ToInt32_2();
                    //DataTable dtForecastDetails =
                    //    ComponentHelper.Instance.ExecuteDataSet(&quot;SELECT * FROM AXFRCSTMain WHERE ForecastID = &#39;&quot; +
                    //                                            Request[&quot;InstanceID&quot;] + &quot;&#39;&quot;).Tables[0];
                    DataTable dtForecastDetails =
                        ComponentHelper.Instance.ExecuteDataSet(usp_CONTMGTAXFRCSTMain, null, ForecastID).Tables[0];
                    //DataTable dtResourceDeatils =
                    //    ComponentHelper.Instance.ExecuteDataSet(
                    //        &quot;SELECT * FROM AXFRCSTResourcedetails WHERE ForecastID = &#39;&quot; + Request[&quot;InstanceID&quot;] + &quot;&#39;&quot;).
                    //        Tables[0];
                    DataTable dtResourceDeatils =
                        ComponentHelper.Instance.ExecuteDataSet(usp_CONTMGTAXFRCSTResourcedetails, null, ForecastID).Tables[0];
                    //DataTable dtItemDeatils =
                    //    ComponentHelper.Instance.ExecuteDataSet(
                    //        &quot;SELECT * FROM AXFRCSTItemDetails WHERE ForecastID = &#39;&quot; + Request[&quot;InstanceID&quot;] + &quot;&#39;&quot;).
                    //        Tables[0];
                    DataTable dtItemDeatils =
                        ComponentHelper.Instance.ExecuteDataSet(usp_CONTMGTAXFRCSTAXFRCSTItemDetails,null, ForecastID).Tables[0];
                    AttachItemDetails(dtItemDeatils);

                    dtStartDate.Value = dtForecastDetails.Rows[0][&quot;StartDate&quot;].ToMWDateTime();
                    dtEndDate.Value = dtForecastDetails.Rows[0][&quot;EndDate&quot;].ToMWDateTime();
                    ddlBudgetModel.SelectedValue = (string) dtForecastDetails.Rows[0][&quot;ModelID&quot;];

                    BindItemGrid(dtItemDeatils);
                    //FormOverheadSummary(resources,false) : true represents Forecast Generate button is not clicked and after selecting
                    // a particular forecast in forecast list page, we either click the view or edit button.
                    BindOverheadsGrid(FormOverheadSummary(dtResourceDeatils, false));
                    BindResourceGrid(dtResourceDeatils);
                }
                if (Request[&quot;Mode&quot;] == &quot;N&quot; || Request[&quot;Mode&quot;] == &quot;E&quot;)
                {
                    dtStartDate.Enabled = dtEndDate.Enabled = ddlBudgetModel.Enabled =
                                                              btnForecast.Enabled = true;
                }
                else
                {
                    dtStartDate.Enabled = dtEndDate.Enabled = ddlBudgetModel.Enabled =
                                                              btnForecast.Enabled = false;
                }
            }
            grdItem.DisplayLayout.ClientSideEvents.EditKeyDownHandler = &quot;grdResource_EditKeyDownHandler&quot;;
            grdResource.DisplayLayout.ClientSideEvents.EditKeyDownHandler = &quot;grdResource_EditKeyDownHandler&quot;;
            grdOverheads.DisplayLayout.ClientSideEvents.EditKeyDownHandler = &quot;grdResource_EditKeyDownHandler&quot;;

            PageTitle = &quot;Forecast Details&quot;;
        }

        protected void btnForecast_Click(object sender, EventArgs e)
        {
            try
            {
                tblResources.Style.Add(&quot;display&quot;, &quot;none&quot;);
                tblItems.Style.Add(&quot;display&quot;, &quot;none&quot;);
                tblOverheads.Style.Add(&quot;display&quot;, &quot;none&quot;);
                DateTime startDate = dtStartDate.Value.ToDateTime_MWCulture();
                DateTime endDate = dtEndDate.Value.ToDateTime_MWCulture();

                if (endDate &lt; startDate)
                {
                    ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                                       &quot;ShowError(&#39;End Date should be greater than start date.&#39;);&quot;, true);
                    return;
                }
                string parentID = Request[&quot;ParentID&quot;];
                string projectID = Request[&quot;PID&quot;];
                ItemListModel itemListModel;
                DataTable dtContractDetails;
                DataSet dsContractItems;
                // TODO : Logic to Push forecast into AX
                if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                {
                    string AXCompany = Session[Constants.EIS_ADDITIONAL_INFO] == null
                                           ? string.Empty
                                           : Session[Constants.EIS_ADDITIONAL_INFO].ToString2();

                    var conBrixInfo = new List&lt;ConnectionBrixInfo&gt;();
                    conBrixInfo.Add(new ConnectionBrixInfo(AMP3Object.CONTMGT, parentID, AMP3Object.UNKNOWN, null));

                    //Check for Brix-AX Subproject mapping
                    DataTable dtMap =
                        IntegrationConnectorManager.Instance.GetERPObjectMapInfo(conBrixInfo[0].AMP3ObjectId,
                                                                                 conBrixInfo[0].AMP3ObjectType,
                                                                                 conBrixInfo[0].AMP3ParentObjectId,
                                                                                 conBrixInfo[0].AMP3ParentObjectType,
                                                                                 RegisteredEIS.AX);

                    itemListModel = ItemListModel.GetInstance(&quot;EISCONTMGT&quot;, Request, Response, AXCompany);

                    //Input data from AX 
                    itemListModel.EISData[&quot;AXStartDate&quot;] = startDate.ToMWDateTime();
                    itemListModel.EISData[&quot;AXEndDate&quot;] = endDate.ToMWDateTime();

                    //Get Data from Brix
                    itemListModel.GetEISData(RegisteredEIS.AX);

                    //Data got from Brix
                    dtContractDetails = (DataTable) itemListModel.EISData[&quot;ContractTable&quot;];
                    dsContractItems = (DataSet) itemListModel.EISData[&quot;ContractItemsDS&quot;];
                }
                else
                {
                    int pagecount;
                    int pageno = 1;
                    itemListModel = ItemListModel.GetInstance(&quot;CONTMGT&quot;, Request, Response, string.Empty);
                    //Data got from Brix
                    dtContractDetails = BL.Instance.GetContractDetails(parentID.ToInt32_2()).Tables[0];
                    dsContractItems = itemListModel.GetList(200, null, null, ref pageno, out pagecount);
                }

                //Prepare data for Forecast
                DateTime ContractStartDate = MWDateTimeHelper.MWNow;
                string ContractName = &quot;&quot;;
                if (dtContractDetails.Rows.Count &gt; 0)
                {
                    ContractName = dtContractDetails.Rows[0][&quot;Contract Name&quot;].ToString2();
                    ContractStartDate = Convert.ToDateTime(dtContractDetails.Rows[0][&quot;Start Date&quot;],
                                                           DateFormatCulture.GetDateFormatCulture());
                }
                var values = new Dictionary&lt;string, object&gt;();
                values.Add(&quot;ContractName&quot;, ContractName);
                values.Add(&quot;ContractStartDate&quot;, ContractStartDate.ToUtc());
                values.Add(&quot;ContractDetails&quot;, dtContractDetails);
                values.Add(&quot;ContractItems&quot;, dsContractItems.Tables[0].Copy());
                values.Add(&quot;ForecastModel&quot;,
                           (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                               ? ddlBudgetModel.SelectedValue
                               : &quot;&quot;);
                values.Add(&quot;StartDate&quot;, startDate.ToUtc());
                values.Add(&quot;EndDate&quot;, endDate.ToUtc());

                //Check for MSP Sync/Fetch done or not
                DataSet dsData = IntegrationConnectorManager.Instance.GetResourcesForForecast(parentID.ToInt32_2(),
                                                                                              startDate.ToUtc(), endDate.ToUtc(), &quot;Y&quot;);
                if (dsData != null &amp;&amp; dsData.Tables.Count &gt; 0)
                {
                    if (hdnConfirm.Value != &quot;Confirmed&quot;)
                    {
                        if (dsData.Tables[0].Columns.Contains(&quot;DataCount&quot;))
                        {
                            ViewState[&quot;DataCount&quot;] = dsData.Tables[0].Rows[0][&quot;DataCount&quot;].ToString2();
                            if (dsData.Tables[0].Columns.Contains(&quot;IsApprovedQPExists&quot;))
                                ViewState[&quot;IsApprovedQPExists&quot;] =
                                    dsData.Tables[0].Rows[0][&quot;IsApprovedQPExists&quot;].ToString2();

                            if (ViewState[&quot;DataCount&quot;].Equals(&quot;0&quot;))
                            {
                                ScriptManager.RegisterStartupScript(this, GetType(), &quot;Confirm&quot;, &quot;confirmForecast();&quot;,
                                                                    true);
                                return;
                            }
                            else if (ViewState[&quot;DataCount&quot;].Equals(&quot;-1&quot;) &amp;&amp; ViewState[&quot;IsApprovedQPExists&quot;].Equals(&quot;0&quot;))
                            {
                                ScriptManager.RegisterStartupScript(this, GetType(), &quot;Confirm&quot;,
                                                                    &quot;confirmForecastForQuantityPlan();&quot;, true);
                                return;
                            }
                        }
                    }
                    if (ViewState[&quot;DataCount&quot;] != null &amp;&amp; !ViewState[&quot;DataCount&quot;].ToString2().Equals(&quot;0&quot;) &amp;&amp;
                        !ViewState[&quot;DataCount&quot;].ToString2().Equals(&quot;-1&quot;))
                    {
                        if (dsData.Tables.Count &gt; 1 &amp;&amp; dsData.Tables[1].Rows.Count == 0)
                        //Check for Activity Availbility for the given time duration
                        {
                            ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                                               &quot;ShowError(&#39;No activities available for the given time duration. Forecast is not created.&#39;);&quot;,
                                                               true);
                            return;
                        }
                    }
                    if (dsData.Tables.Count &gt; 2)
                    {
                        values.Add(&quot;ActivityDataCount&quot;, (ViewState[&quot;DataCount&quot;] != null) ? ViewState[&quot;DataCount&quot;].ToString2() : &quot;0&quot;);
                        values.Add(&quot;ForecastDataSet&quot;, dsData);
                        values.Add(&quot;ContractID&quot;, parentID.ToInt32_2());
                        values.Add(&quot;ProjectID&quot;, projectID.ToInt32_2());

                        //Fetch Misc charges
                        dsData = EISPageDataManager.GetPageDataForForecast(values);

                        if (dsData.Tables[2].Rows.Count &gt; 0 ||
                            (dsData.Tables.Count &gt; 4 &amp;&amp; dsData.Tables.Contains(&quot;ContractMiscItems&quot;) &amp;&amp; dsData.Tables[&quot;ContractMiscItems&quot;].Rows.Count &gt; 0))
                        {
                            //Now the resources with zero quantity are also shown in the forecast page and they will be filtered only when the 
                            //resources are pushed to AX.(NCC-19789)
                            //CheckForZeroQuantity(dsData);
                            if (dsData.Tables[2].Rows.Count &gt; 0 ||
                                (dsData.Tables.Count &gt; 4 &amp;&amp; dsData.Tables[&quot;ContractMiscItems&quot;].Rows.Count &gt; 0))
                            {
                                if (dsData.Tables[4].Rows.Count &gt; 0)
                                {
                                    DataRow dr = dsData.Tables[2].NewRow();
                                    dr[&quot;ResourceTypeName&quot;] = &quot;Miscellaneous&quot;;
                                    dr[&quot;Cost&quot;] = dsData.Tables[4].Rows[0][&quot;Cost&quot;];
                                    dr[&quot;Quantity&quot;] = dsData.Tables[4].Rows[0][&quot;Quantity&quot;];
                                    dr[&quot;ResItemID&quot;] =
                                        dr[&quot;Description&quot;] =
                                        dr[&quot;Unit&quot;] = &quot;...&quot;;
                                    dr[&quot;Rate&quot;] = decimal.MinValue;
                                    DataRow[] drTemp = dsData.Tables[2].Select(&quot;ResourceTypeName &lt;&gt; &#39;Miscellaneous&#39;&quot;);
                                    if (drTemp.Length &gt; 0)
                                    {
                                        dr[&quot;StartDate&quot;] = drTemp[0][&quot;StartDate&quot;].ToMWDateTime();
                                        dr[&quot;EndDate&quot;] = drTemp[0][&quot;EndDate&quot;].ToMWDateTime();
                                    }
                                    dsData.Tables[2].Rows.Add(dr);
                                }
                                ViewState[&quot;StartDate&quot;] = dsData.Tables[2].Rows[0][&quot;StartDate&quot;].ToMWDateTime();
                                ViewState[&quot;EndDate&quot;] = dsData.Tables[2].Rows[0][&quot;EndDate&quot;].ToMWDateTime();
                                ModifyResourceDetails(dsData.Tables[2]);
                                BindResourceGrid(dsData.Tables[2]);
                                if (dsContractItems.Tables.Count &gt; 1)
                                {
                                    ModifyItemTable(dsContractItems.Tables[1]);
                                    BindItemGrid(dsContractItems.Tables[1]);
                                }
                            }
                            else
                            {
                                ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                                                   &quot;ShowError(&#39;Activities Quantities is zero. Forecast cannot be created.&#39;);&quot;,
                                                                   true);
                                return;
                            }
                        }
                        else if (dsData.Tables[2].Rows.Count == 0 &amp;&amp; dsData.Tables[&quot;ContractMiscItems&quot;].Rows.Count == 0)
                        {
                            ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                                               &quot;ShowError(&#39;No Rate Analysis for the Activities. Forecast cannot be created.&#39;);&quot;,
                                                               true);
                            return;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;, &quot;ShowError(&quot; + JS.Serialize(ex.Message) + &quot;);&quot;, true);
            }
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            WorkflowEnabledSaveHandler();
        }

        private void SaveForecast(out string sSavedInstanceToken, out string sErrors)
        {
            sErrors = sSavedInstanceToken = string.Empty;
            if (tblItems.Style[&quot;display&quot;].ToLower2() == &quot;none&quot;)
            {
                sErrors = &quot;Please generate the forecast before saving the record.&quot;;
                sSavedInstanceToken = &quot;-1&quot;;
                return;
            }
            var dtResource = (DataTable) ViewState[&quot;dtData&quot;];
            var dtItems = (DataTable) ViewState[&quot;dtItemData&quot;];
            DataTable dtResourceTypes = ItemManager.Instance.GetResourceTypes();

            using (var conn = new ConnHolder(ConnectionHelper.GetConnectionString()))
            {
                int forecastID = Request[&quot;InstanceID&quot;].ToInt32_2();
                DateTime startDate, endDate;
                DateTime createdDate = (dtCreatedOn.Value.ToDateTime_MWCulture());
                //If Approved Quantity Plan exist, then the UI Start Date and End Date will be stored as the Forecast Period.
                if (ViewState[&quot;StartDate&quot;] == null || ViewState[&quot;StartDate&quot;] == DBNull.Value ||
                    (ViewState[&quot;DataCount&quot;] != null &amp;&amp; ViewState[&quot;IsApprovedQPExists&quot;].ToInt32_2() &gt; 0))
                {
                    startDate = dtStartDate.Value.ToDateTime_MWCulture();
                    endDate = dtEndDate.Value.ToDateTime_MWCulture();
                }
                else
                {
                    startDate = ViewState[&quot;StartDate&quot;].ToDateTime_MWCulture();
                    endDate = ViewState[&quot;EndDate&quot;].ToDateTime_MWCulture();
                }

                if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                {
                    //Validation for Inventory Dimensions for Resources Before Saving the Forecast
                    foreach (UltraGridRow ugr in grdResource.Rows)
                    {
                        //If Inventory Dimensions are not there for grouped resources, then if quanity is not 0, it will validate.
                        string resTypeName = ugr.Cells.FromKey(&quot;ResourceTypeName&quot;).Value.ToString2();
                        if (!resTypeName.Equals(&quot;Equipment&quot;) &amp;&amp; !resTypeName.Equals(&quot;Miscellaneous&quot;) &amp;&amp;
                            ugr.Cells.FromKey(&quot;Quantity&quot;).Value.ToDecimal2() != 0)
                        {
                            string parentResitemId = ugr.Cells.FromKey(&quot;ParentResItemID&quot;).Value.ToString2();
                            string size = ugr.Cells.FromKey(&quot;Size&quot;) == null
                                              ? &quot;&quot;
                                              : Convert.ToString(ugr.Cells.FromKey(&quot;Size&quot;).Value).Trim();
                            string color = ugr.Cells.FromKey(&quot;Color&quot;) == null
                                               ? &quot;&quot;
                                               : Convert.ToString(ugr.Cells.FromKey(&quot;Color&quot;).Value).Trim();
                            string configuration = ugr.Cells.FromKey(&quot;Configuration&quot;) == null
                                                       ? &quot;&quot;
                                                       : Convert.ToString(ugr.Cells.FromKey(&quot;Configuration&quot;).Value).Trim();

                            if (string.IsNullOrEmpty(size) &amp;&amp; string.IsNullOrEmpty(color) &amp;&amp;
                                string.IsNullOrEmpty(configuration))
                            {
                                if (!ValidateResourceForAXDimensions(parentResitemId, size, color, configuration))
                                {
                                    //Message for validation
                                    sErrors += &quot;Inventory Dimensions are mandatory for the resource.&quot; + parentResitemId +
                                               &quot;,&quot;;
                                }
                                if (!string.IsNullOrEmpty(sErrors))
                                {
                                    sErrors = &quot;Cannot create the forecast. &quot; + sErrors +
                                              &quot; Please add dimensions for the resources in cost revision.&quot;;
                                    return;
                                }
                            }
                        }
                    }
                }

                decimal value;

                using (DbCommand cmd1 = conn.DB.GetStoredProcCommand(&quot;usp_AXFRCSTCUForecastDetails&quot;))
                {
                    conn.DB.AddInParameter(cmd1, &quot;ContractID&quot;, DbType.Int32, Request[&quot;ParentID&quot;].ToInt32_2());
                    conn.DB.AddInParameter(cmd1, &quot;ProjectID&quot;, DbType.Int32, Request[&quot;PID&quot;].ToInt32_2());
                    conn.DB.AddInParameter(cmd1, &quot;StartDate&quot;, DbType.DateTime, startDate.ToUtc());
                    conn.DB.AddInParameter(cmd1, &quot;EndDate&quot;, DbType.DateTime, endDate.ToUtc());
                    conn.DB.AddInParameter(cmd1, &quot;ModelID&quot;, DbType.String,
                                      (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                                          ? ddlBudgetModel.SelectedValue
                                          : string.Empty);
                    conn.DB.AddInParameter(cmd1, &quot;ForecastModel&quot;, DbType.String,
                                      (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
                                          ? ddlBudgetModel.SelectedItem.Text
                                          : string.Empty);
                    conn.DB.AddInParameter(cmd1, &quot;CreatedDate&quot;, DbType.DateTime, createdDate.ToUtc());
                    if (forecastID == 0)
                    {
                        conn.DB.AddOutParameter(cmd1, &quot;ForecastID&quot;, DbType.Int32, sizeof(int));
                        conn.DB.ExecuteNonQuery(cmd1);
                        forecastID = conn.DB.GetParameterValue(cmd1, &quot;ForecastID&quot;).ToInt32_2();
                    }
                    else
                    {
                        conn.DB.AddInParameter(cmd1, &quot;ForecastID&quot;, DbType.Int32, forecastID);
                        conn.DB.ExecuteNonQuery(cmd1);
                    }
                }

                int result;
                if (Request[&quot;Mode&quot;] != null &amp;&amp; Request[&quot;Mode&quot;] == &quot;E&quot;)
                {
                    //result =
                    //    ComponentHelper.Instance.ExecuteNonQuery(&quot;DELETE FROM AXFRCSTResourceDetails WHERE ForecastID = &#39;&quot; +
                    //                                             forecastID + &quot;&#39;&quot;);
                    result = ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(usp_CONTMGTAXFRCSTDeleteAXFRCSTResourceDetails,null,forecastID);
                    //result =
                    //    ComponentHelper.Instance.ExecuteNonQuery(&quot;DELETE FROM AXFRCSTItemDetails WHERE ForecastID = &#39;&quot; +
                    //                                             forecastID + &quot;&#39;&quot;);
                    result = ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(usp_CONTMGTAXFRCSTDeleteAXFRCSTItemDetails, null, forecastID);
                }

                foreach (UltraGridRow ugr in grdItem.Rows)
                {
                    result = ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                        usp_AXFRCSTCUItemDetails, null,
                        forecastID, ugr.Cells.FromKey(&quot;ItemID&quot;).Value.ToInt32_2(),
                        decimal.TryParse(ugr.Cells.FromKey(&quot;Quantity&quot;).Value.ToString2(), out value) ? value : 0,
                        decimal.TryParse(ugr.Cells.FromKey(&quot;UnitPrice&quot;).Value.ToString2(), out value) ? value : 0,
                        decimal.TryParse(ugr.Cells.FromKey(&quot;Amount&quot;).Value.ToString2(), out value) ? value : 0);
                }

                SaveResourcesDetails(grdResource, forecastID);
                SaveResourcesDetails(grdOverheads, forecastID);

                sSavedInstanceToken = forecastID.ToString2();
            }
        }

        private void SaveResourcesDetails(UltraWebGrid grid, int forecastID)
        {
            int result;
            decimal value;
            foreach (UltraGridRow ugr in grid.Rows)
            {
                string ParentResItemID;
                //If the ParentResItemID is null, then the value of ResItemID is assigned to it.
                //It was made like this as it was throwing the Object Reference error while saving the forecast(overheads).
                if (ugr.Cells.FromKey(&quot;ParentResItemID&quot;) != null)
                    ParentResItemID = ugr.Cells.FromKey(&quot;ParentResItemID&quot;).Value.ToString2();
                else
                    ParentResItemID = ugr.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2();

                result = ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(
                    usp_AXFRCSTCUResourceDetails, null, forecastID,
                    ugr.Cells.FromKey(&quot;ResItemID&quot;).Value.ToString2(), ParentResItemID,
                    ugr.Cells.FromKey(&quot;ResourceTypeName&quot;).Value.ToString2(),
                    ugr.Cells.FromKey(&quot;Description&quot;).Value.ToString2(), ugr.Cells.FromKey(&quot;Unit&quot;).Value.ToString2(),
                    decimal.TryParse(ugr.Cells.FromKey(&quot;Quantity&quot;).Value.ToString2(), out value) ? value : 0,
                    decimal.TryParse(ugr.Cells.FromKey(&quot;Rate&quot;).Value.ToString2(), out value) ? value : 0,
                    decimal.TryParse(ugr.Cells.FromKey(&quot;Cost&quot;).Value.ToString2(), out value) ? value : 0,
                    decimal.TryParse(ugr.Cells.FromKey(&quot;RateAnalysisRate&quot;).Value.ToString2(), out value) ? value : 0,
                    ugr.Cells.FromKey(&quot;Size&quot;) == null ? &quot;&quot; : Convert.ToString(ugr.Cells.FromKey(&quot;Size&quot;).Value),
                    ugr.Cells.FromKey(&quot;Color&quot;) == null ? &quot;&quot; : Convert.ToString(ugr.Cells.FromKey(&quot;Color&quot;).Value),
                    ugr.Cells.FromKey(&quot;Configuration&quot;) == null
                        ? &quot;&quot;
                        : Convert.ToString(ugr.Cells.FromKey(&quot;Configuration&quot;).Value));
            }
        }

        protected void lnkBack_Click(object sender, EventArgs e)
        {
            Response.Redirect(@&quot;~/Common/BrixListPage.aspx?Context=AXFRCST&amp;PID=&quot; + Request[&quot;PID&quot;] + &quot;&amp;ParentID=&quot; +
                              Request[&quot;ParentID&quot;]);
        }

        private void AttachItemDetails(DataTable dtItemDeatils)
        {
            dtItemDeatils.Columns.Add(&quot;LineNo&quot;, typeof (Int32));
            dtItemDeatils.Columns.Add(&quot;StandardItemNo&quot;, typeof (string));
            dtItemDeatils.Columns.Add(&quot;Description&quot;, typeof (string));
            dtItemDeatils.Columns.Add(&quot;Unit&quot;, typeof (string));
            dtItemDeatils.Columns.Add(&quot;Path&quot;, typeof (string));
            dtItemDeatils.Columns.Add(&quot;RemainingQuantity&quot;, typeof (decimal));
            dtItemDeatils.AcceptChanges();

            decimal cumulativeItemQuantity = 0;

            Item item;
            foreach (DataRow dr in dtItemDeatils.Select())
            {
                try
                {
                    cumulativeItemQuantity = (from f in ContractManagerDb.Db.ForecastItems
                                              where f.ItemID == dr[&quot;ItemID&quot;].ToInt32_2()
                                              where f.ForecastID != Request[&quot;InstanceID&quot;].ToInt32_2()
                                              select (f.Quantity == null ? 0 : f.Quantity)).Sum();
                }
                catch
                {
                    cumulativeItemQuantity = 0;
                }
                item = ItemManager.Instance.GetItemDetails(&quot;CONTMGT&quot;, Request[&quot;ParentID&quot;].ToInt32_2(),
                                                           dr[&quot;ItemID&quot;].ToInt32_2());
                dr[&quot;LineNo&quot;] = item.LineNo;
                dr[&quot;StandardItemNo&quot;] = item.StandardItemNo;
                dr[&quot;Description&quot;] = item.Description;
                dr[&quot;Path&quot;] = item.Path;
                dr[&quot;Unit&quot;] = item.Unit;
                dr[&quot;RemainingQuantity&quot;] = item.Quantity - cumulativeItemQuantity;
            }
        }

        private void ModifyItemTable(DataTable itemTable)
        {
            string getPath, getForecastedQuantity;
            decimal cumulativeItemQuantity = 0;
            DateTime startDate = dtStartDate.Value.ToDateTime_MWCulture();
            DateTime endDate = dtEndDate.Value.ToDateTime_MWCulture();
            string invalidItems = string.Empty;


            itemTable.Columns.Add(&quot;RemainingQuantity&quot;, typeof (decimal));
            itemTable.AcceptChanges();

            DataTable planningQtyInfo =
                ComponentHelper.Instance.ExecuteDataSet(usp_QTYPLANGetForecastQty, null, Request[&quot;ParentID&quot;].ToInt32_2(),
                                                        dtStartDate.Value.ToUtc(), dtEndDate.Value.ToUtc()).
                    Tables[0];
            if (!planningQtyInfo.Columns.Contains(&quot;MSP&quot;) &amp;&amp; ViewState[&quot;IsApprovedQPExists&quot;].ToInt32_2() &gt; 0)
            {
                ResetResourcesGrid();
            }
            foreach (DataRow currentRow in itemTable.Select())
            {
                object quantity = 0;
                if (hdnConfirm.Value != &quot;Confirmed&quot; || planningQtyInfo.Columns.Contains(&quot;MSP&quot;))
                {
                    if (planningQtyInfo.Columns.Contains(&quot;MSP&quot;))
                    {
                        getForecastedQuantity = &quot;SELECT dbo.fnForecastQtyforItem({0},{1},{2})&quot;;
                        quantity = ComponentHelper.Instance.ExecuteScalar(getForecastedQuantity, currentRow[&quot;ItemID&quot;], startDate.ToUtc(), endDate.ToUtc());
                    }
                    else
                    {
                        quantity = planningQtyInfo.Select(&quot;ItemID = &#39;&quot; + currentRow[&quot;ItemID&quot;] + &quot;&#39;&quot;).Length &gt; 0
                                       ? planningQtyInfo.Select(&quot;ItemID = &#39;&quot; + currentRow[&quot;ItemID&quot;] + &quot;&#39;&quot;)[0][&quot;Qty&quot;].
                                             ToDecimal2()
                                       : 0;

                        ModifyResourcesForItem(currentRow[&quot;ItemID&quot;].ToInt32_2(), quantity.ToDecimal2(), false, false);
                    }

                    if (quantity == DBNull.Value)
                    {
                        invalidItems += currentRow[&quot;ItemID&quot;] + &quot;,&quot;;
                        continue;
                    }
                }

                getPath = &quot;SELECT dbo.GetItemPath({0},{1},{2})&quot;;
                currentRow[&quot;Path&quot;] = ComponentHelper.Instance.ExecuteScalar(getPath, &quot;CONTMGT&quot;,currentRow[&quot;ParentInstanceID&quot;], currentRow[&quot;ContainerID&quot;]).ToString2();
                try
                {
                    cumulativeItemQuantity = (from f in ContractManagerDb.Db.ForecastItems
                                              where f.ItemID == currentRow[&quot;ItemID&quot;].ToInt32_2()
                                              where f.ForecastID != Request[&quot;InstanceID&quot;].ToInt32_2()
                                              select (f.Quantity == null ? 0 : f.Quantity)).Sum();
                }
                catch
                {
                    //do nothing
                    cumulativeItemQuantity = 0;
                }
                currentRow[&quot;RemainingQuantity&quot;] = currentRow[&quot;Quantity&quot;].ToDecimal2() - cumulativeItemQuantity;

                if (hdnConfirm.Value != &quot;Confirmed&quot;)
                    currentRow[&quot;Quantity&quot;] = quantity == DBNull.Value ? 0 : quantity.ToDecimal2();

                currentRow[&quot;Amount&quot;] = currentRow[&quot;Quantity&quot;].ToDecimal2()*currentRow[&quot;UnitPrice&quot;].ToDecimal2();
            }

            if (!string.IsNullOrEmpty(invalidItems) &amp;&amp; !planningQtyInfo.Columns.Contains(&quot;MSP&quot;))
            {
                foreach (string item in invalidItems.Split(&#39;,&#39;))
                {
                    if (!string.IsNullOrEmpty(item))
                    {
                        DataRow[] invalidItemRow = itemTable.Select(&quot;ItemID = &#39;&quot; + item + &quot;&#39;&quot;);
                        if (invalidItemRow.Count() &gt; 0) itemTable.Rows.Remove(invalidItemRow[0]);
                    }
                }

                ClientScript.RegisterStartupScript(GetType(), &quot;ShowAlert&quot;,
                                                   &quot;ShowError(&#39;Some &quot; + UIHelper.JavascriptEncode(ItemNameAbbr) +
                                                   &quot;(s) are not scheduled in the selected date range or &quot; + UIHelper.JavascriptEncode(ItemNameAbbr) +
                                                   &quot;(s) have been added to the contract after the previous Sync/Fetch. &quot; +
                                                   &quot;You need to reschedule or Sync/Fetch the contract again inorder to include missing &quot; +
                                                    UIHelper.JavascriptEncode(ItemNameAbbr) + &quot;(s) in the Forecast.&#39;);&quot;, true);
            }
        }

        private void ModifyResourceDetails(DataTable resources)
        {
            resources.Columns.Add(&quot;RateAnalysisRate&quot;, typeof (decimal));
            resources.AcceptChanges();
            foreach (DataRow resource in resources.Select(&quot;ResourceTypeName NOT IN (&#39;Miscellaneous&#39;, &#39;Overhead&#39;)&quot;))
            {
                resource[&quot;RateAnalysisRate&quot;] = resource[&quot;Rate&quot;];
            }
            //FormOverheadSummary(resources,true) : true represents Forecast Generate button is clicked
            BindOverheadsGrid(FormOverheadSummary(resources, true));
        }

        private DataTable FormOverheadSummary(DataTable resources, bool isForecastClick)
        {
            DataRow[] overheadRows = resources.Select(&quot;ResourceTypeName = &#39;Overhead&#39;&quot;);

            var overheadTableData = from overhead in overheadRows
                                    group overhead by overhead[&quot;ResItemID&quot;]
                                    into g
                                    select new
                                               {
                                                   ResItemID = g.Max(k =&gt; k[&quot;ResItemID&quot;].ToString2()),
                                                   ResourceTypeName = g.Max(k =&gt; k[&quot;ResourceTypeName&quot;].ToString2()),
                                                   Description = g.Max(k =&gt; k[&quot;Description&quot;].ToString2()),
                                                   Unit = g.Max(k =&gt; k[&quot;Unit&quot;].ToString2()),
                                                   Rate = 0.0,
                                                   Quantity = 0.0,
                                                   Cost = g.Sum(k =&gt; k[&quot;Cost&quot;].ToDecimal2()),
                                                   RateAnalysisRate = 0.0
                                               };

            DataTable overheadDetails = GetResourceTableSchema();

            // Calling the usp_QTYPLANGetForecastOverheadCost to get wheather it is MSP or QP. If it is QP, the SP will return 
            //Category ID, Category Name and the Overhead Cost.
            DataTable overheadCostInfo =
                ComponentHelper.Instance.ExecuteDataSet(usp_QTYPLANGetForecastOverheadCost, null,
                                                        Request[&quot;ParentID&quot;].ToInt32_2(), dtStartDate.Value.ToUtc(),
                                                        dtEndDate.Value.ToUtc()).Tables[0];

            foreach (var overheadEntry in overheadTableData)
            {
                decimal overheadCost = overheadEntry.Cost;
                //Checking for QP and wheather forecast button is clicked
                //If it is QP and forecast generate button is clicked, then calculate the overhead cost from QP Schedule
                if (!overheadCostInfo.Columns.Contains(&quot;MSP&quot;) &amp;&amp; isForecastClick &amp;&amp;
                    ViewState[&quot;IsApprovedQPExists&quot;].ToInt32_2() &gt; 0)
                {
                    overheadCost = overheadCostInfo.Select(&quot;CategoryID = &#39;&quot; + overheadEntry.ResItemID + &quot;&#39;&quot;).Length &gt; 0
                                       ? overheadCostInfo.Select(&quot;CategoryID = &#39;&quot; + overheadEntry.ResItemID + &quot;&#39;&quot;)[0][
                                           &quot;Cost&quot;].ToDecimal2()
                                       : 0;
                }

                DataRow newEntry = overheadDetails.NewRow();
                newEntry.ItemArray = new object[]
                                         {
                                             overheadEntry.ResItemID,
                                             overheadEntry.ResourceTypeName,
                                             overheadEntry.Description,
                                             overheadEntry.Unit,
                                             overheadEntry.Rate,
                                             overheadEntry.Quantity,
                                             overheadCost,
                                             overheadEntry.RateAnalysisRate
                                         };
                overheadDetails.Rows.Add(newEntry);
            }

            RemoveOverheadRows(resources, overheadRows);

            return overheadDetails;
        }

        private void RemoveOverheadRows(DataTable resources, DataRow[] overheadRows)
        {
            foreach (DataRow overheadRow in overheadRows)
                resources.Rows.Remove(overheadRow);
        }

        private void BindItemGrid(DataTable itemTable)
        {
            tblItems.Style.Add(&quot;display&quot;, &quot;table&quot;);
            ViewState[&quot;dtItemData&quot;] = itemTable;
            grdItem.DataSource = itemTable;
            grdItem.DataBind();
            SetItemGridColumnProperties();
        }

        private void BindResourceGrid(DataTable dtData)
        {
            tblResources.Style.Add(&quot;display&quot;, &quot;table&quot;);
            ViewState[&quot;dtData&quot;] = dtData;
            grdResource.DataSource = dtData;
            grdResource.DataBind();
            SetResourceGridColumnProperties();
        }

        private void BindOverheadsGrid(DataTable dtOverheads)
        {
            tblOverheads.Style.Add(&quot;display&quot;, &quot;table&quot;);
            ViewState[&quot;dtOverheadData&quot;] = dtOverheads;
            grdOverheads.DataSource = dtOverheads;
            grdOverheads.DataBind();
            SetOverheadsGridColumnProperties();
        }

        private void SetItemGridColumnProperties()
        {
            var visibleColumnsInOrder = new ArrayList
                                            {
                                                &quot;LineNo&quot;,
                                                &quot;StandardItemNo&quot;,
                                                &quot;Description&quot;,
                                                &quot;Path&quot;,
                                                &quot;Unit&quot;,
                                                &quot;UnitPrice&quot;,
                                                &quot;Quantity&quot;,
                                                &quot;Amount&quot;,
                                                &quot;RemainingQuantity&quot;
                                            };
            if (!permission.Contains(&quot;ViewCost&quot;))
            {
                visibleColumnsInOrder.Remove(&quot;UnitPrice&quot;);
                visibleColumnsInOrder.Remove(&quot;Amount&quot;);
            }
            if (Request[&quot;Mode&quot;].Equals(&quot;V&quot;)) visibleColumnsInOrder.Remove(&quot;RemainingQuantity&quot;);
            ArrangeVisibleColumnsInOrder(grdItem, visibleColumnsInOrder);

            FormatNumericCells(grdItem);
            FormatCell(grdItem, &quot;RemainingQuantity&quot;, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, HorizontalAlign.Right,
                       &quot;Remaining Quantity&quot;);

            MakeCellEditable(grdItem, new ArrayList {&quot;Quantity&quot;});
        }

        private void SetResourceGridColumnProperties()
        {
            var visibleColumnsInOrder = new ArrayList
                                            {
                                                &quot;ParentResItemID&quot;,
                                                &quot;ResourceTypeName&quot;,
                                                &quot;Description&quot;,
                                                &quot;Unit&quot;,
                                                &quot;Rate&quot;,
                                                &quot;Quantity&quot;,
                                                &quot;Cost&quot;,
                                                &quot;Size&quot;,
                                                &quot;Color&quot;,
                                                &quot;Configuration&quot;
                                            };
            if (!permission.Contains(&quot;ViewCost&quot;))
            {
                visibleColumnsInOrder.Remove(&quot;Rate&quot;);
                visibleColumnsInOrder.Remove(&quot;Cost&quot;);
            }
            ArrangeVisibleColumnsInOrder(grdResource, visibleColumnsInOrder);

            grdResource.Columns.FromKey(&quot;ResourceTypeName&quot;).Header.Caption = &quot;Resource Type Name&quot;;
            if (grdResource.Columns.FromKey(&quot;ParentResItemID&quot;) != null)
                grdResource.Columns.FromKey(&quot;ParentResItemID&quot;).Header.Caption = &quot;Resource ID&quot;;

            FormatNumericCells(grdResource);

            MakeCellEditable(grdResource, new ArrayList {&quot;Quantity&quot;, &quot;Rate&quot;, &quot;Cost&quot;});
        }

        private void SetOverheadsGridColumnProperties()
        {
            var visibleColumnsInOrder = new ArrayList {&quot;ResItemID&quot;, &quot;Description&quot;, &quot;Cost&quot;};
            if (!permission.Contains(&quot;ViewCost&quot;))
            {
                visibleColumnsInOrder.Remove(&quot;Cost&quot;);
            }
            ArrangeVisibleColumnsInOrder(grdOverheads, visibleColumnsInOrder);

            grdOverheads.Columns.FromKey(&quot;ResItemID&quot;).Header.Caption = &quot;Category ID&quot;;
            grdOverheads.Columns.FromKey(&quot;Description&quot;).Header.Caption = &quot;Category Name&quot;;

            FormatNumericCells(grdOverheads);

            MakeCellEditable(grdOverheads, new ArrayList {&quot;Cost&quot;});
        }

        private void ArrangeVisibleColumnsInOrder(UltraWebGrid grid, ArrayList visibleColumnsInOrder)
        {
            foreach (UltraGridColumn col in grid.Columns)
                col.Hidden = true;

            int columnNo = 0;
            foreach (string column in visibleColumnsInOrder)
            {
                if (grid.Columns.Exists(column))
                {
                    grid.Columns.FromKey(column).Hidden = false;
                    grid.Columns.FromKey(column).Move(columnNo++);
                }
            }
        }

        private void MakeCellEditable(UltraWebGrid grid, ArrayList editableCells)
        {
            if (Request[&quot;Mode&quot;] == &quot;N&quot; || Request[&quot;Mode&quot;] == &quot;E&quot;)
            {
                foreach (string cell in editableCells)
                {
                    if (grid.Columns.Exists(cell))
                    {
                        grid.Columns.FromKey(cell).AllowUpdate = AllowUpdate.Yes;
                        grid.Columns.FromKey(cell).CellStyle.BackColor = Color.Yellow;
                        grid.Columns.FromKey(cell).EditorControlID = &quot;wneCell&quot;;
                        grid.Columns.FromKey(cell).Type = ColumnType.Custom;
                    }
                }
            }
        }

        private DataTable GetResourceTableSchema()
        {
            DataTable resourceTable = new BrixDataTable();
            resourceTable.Columns.Add(&quot;ResItemID&quot;, typeof (string));
            resourceTable.Columns.Add(&quot;ResourceTypeName&quot;, typeof (string));
            resourceTable.Columns.Add(&quot;Description&quot;, typeof (string));
            resourceTable.Columns.Add(&quot;Unit&quot;, typeof (string));
            resourceTable.Columns.Add(&quot;Rate&quot;, typeof (decimal));
            resourceTable.Columns.Add(&quot;Quantity&quot;, typeof (decimal));
            resourceTable.Columns.Add(&quot;Cost&quot;, typeof (decimal));
            resourceTable.Columns.Add(&quot;RateAnalysisRate&quot;, typeof (decimal));
            resourceTable.AcceptChanges();
            return resourceTable;
        }

        private void FormatNumericCells(UltraWebGrid grid)
        {
            FormatCell(grid, &quot;Quantity&quot;, AMP3ApplicationSettings.Instance.FORMAT_QUANTITY, HorizontalAlign.Right);
            FormatCell(grid, &quot;UnitPrice&quot;, AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE, HorizontalAlign.Right);
            FormatCell(grid, &quot;Amount&quot;, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, HorizontalAlign.Right);
            FormatCell(grid, &quot;Rate&quot;, AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE, HorizontalAlign.Right);
            FormatCell(grid, &quot;Cost&quot;, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, HorizontalAlign.Right);
        }

        private void FormatCell(UltraWebGrid grid, string columnName, string format, HorizontalAlign horizontalAlign)
        {
            FormatCell(grid, columnName, format, horizontalAlign, null);
        }

        private void FormatCell(UltraWebGrid grid, string columnName, string format, HorizontalAlign horizontalAlign,
                                string caption)
        {
            if (grid.Columns.Exists(columnName))
            {
                grid.Columns.FromKey(columnName).Format = format;
                grid.Columns.FromKey(columnName).CellStyle.HorizontalAlign = horizontalAlign;
                grid.Columns.FromKey(columnName).Header.Style.HorizontalAlign = horizontalAlign;
                if (!string.IsNullOrEmpty(caption)) grid.Columns.FromKey(columnName).Header.Caption = caption;
            }
        }

        private void CheckForZeroQuantity(DataSet ds)
        {
            DataTable dtResourceItems = ds.Tables[2];

            foreach (DataRow dr in dtResourceItems.Select())
            {
                if (string.IsNullOrEmpty(dr[&quot;Quantity&quot;].ToString2()) || dr[&quot;Quantity&quot;].ToDecimal2() == 0)
                {
                    dtResourceItems.Rows.Remove(dr);
                    dtResourceItems.AcceptChanges();
                }
            }
        }

        protected void grdResource_initializerow(object sender, RowEventArgs e)
        {
            if (e.Row.Cells.FromKey(&quot;ResourceTypeName&quot;).Text == &quot;Miscellaneous&quot;)
            {
                e.Row.Cells.FromKey(&quot;Rate&quot;).Text = &quot;...&quot;;
                e.Row.Cells.FromKey(&quot;Rate&quot;).AllowEditing = AllowEditing.No;
                e.Row.Cells.FromKey(&quot;Rate&quot;).Style.BackColor = Color.Transparent;
                e.Row.Cells.FromKey(&quot;Quantity&quot;).Text = &quot;...&quot;;
                e.Row.Cells.FromKey(&quot;Quantity&quot;).AllowEditing = AllowEditing.No;
                e.Row.Cells.FromKey(&quot;Quantity&quot;).Style.BackColor = Color.Transparent;
            }
            else
            {
                e.Row.Cells.FromKey(&quot;Cost&quot;).AllowEditing = AllowEditing.No;
                e.Row.Cells.FromKey(&quot;Cost&quot;).Style.BackColor = Color.Transparent;
            }
        }

        public void btnUpdateResourceGhost_Click(object sender, EventArgs e)
        {
            int itemId = 0;
            decimal itemQuantity = 0;
            ResetResourcesGrid();
            ResetOverheadsGrid();
            foreach (UltraGridRow item in grdItem.Rows)
            {
                itemId = item.Cells.FromKey(&quot;ItemID&quot;).Value.ToInt32_2();
                itemQuantity = item.Cells.FromKey(&quot;Quantity&quot;).Value.ToDecimal2();
                ModifyResourcesForItem(itemId, itemQuantity, true, true);
            }
        }

        private void ModifyResourcesForItem(int itemId, decimal itemQuantity, bool modifyOverheads,
                                            bool modifySubContractingResources)
        {
            DataTable rateAnalysisDetails =
                ItemManager.Instance.GetRateAnalysis(Constants.MODID_CONTMGT, Request[&quot;ParentID&quot;].ToInt32_2(), itemId,
                                                     true).Tables[1];

            foreach (DataRow resource in rateAnalysisDetails.Select())
            {
                if (resource[&quot;ResourceTypeName&quot;].ToString2() != &quot;Overhead&quot;)
                {
                    foreach (UltraGridRow row in grdResource.Rows)
                    {
                        if (resource[&quot;ResourceTypeName&quot;].ToString2() != &quot;SubContract&quot; || modifySubContractingResources)
                        {
                            if (resource[&quot;ResourceTypeID&quot;].ToInt16_2() != 4)
                            {
                                //The same resource might be added with different rate and unit. 
                                //The ResItemID, Rate and Unit combination will always be unique.
                                if (row.Cells.FromKey(&quot;ResItemID&quot;).Value.Equals(resource[&quot;ResItemID&quot;]) &amp;&amp;
                                    row.Cells.FromKey(&quot;Rate&quot;).Value.Equals(resource[&quot;Rate&quot;]) &amp;&amp;
                                    row.Cells.FromKey(&quot;Unit&quot;).Value.Equals(resource[&quot;Unit&quot;]))
                                {
                                    row.Cells.FromKey(&quot;Quantity&quot;).Value =
                                        row.Cells.FromKey(&quot;Quantity&quot;).Value.ToDecimal2() +
                                        (itemQuantity*
                                         (resource[&quot;Quantity&quot;].ToDecimal2() + resource[&quot;WasteInitialQty&quot;].ToDecimal2()));
                                    row.Cells.FromKey(&quot;Cost&quot;).Value = row.Cells.FromKey(&quot;Quantity&quot;).Value.ToDecimal2()*
                                                                      row.Cells.FromKey(&quot;Rate&quot;).Value.ToDecimal2();
                                }
                            }
                            else
                            {
                                if (row.Cells.FromKey(&quot;ResourceTypeName&quot;).Value.ToString2() == &quot;Miscellaneous&quot;)
                                    row.Cells.FromKey(&quot;Cost&quot;).Value = row.Cells.FromKey(&quot;Cost&quot;).Value.ToDecimal2() +
                                                                      (itemQuantity*resource[&quot;Cost&quot;].ToDecimal2());
                            }
                        }
                    }
                }
                else if (modifyOverheads)
                {
                    foreach (UltraGridRow row in grdOverheads.Rows)
                    {
                        //Checking for each and every overheads and calculating the Cost on change of Item Quantity.
                        if (row.Cells.FromKey(&quot;ResItemID&quot;).Value.Equals(resource[&quot;ResItemID&quot;]))
                        {
                            row.Cells.FromKey(&quot;Cost&quot;).Value = row.Cells.FromKey(&quot;Cost&quot;).Value.ToDecimal2() +
                                                              (itemQuantity*resource[&quot;Cost&quot;].ToDecimal2());
                        }
                    }
                }
            }

            if (!modifySubContractingResources)
            {
                DataTable subContractingQty =
                    ComponentHelper.Instance.ExecuteDataSet(usp_QTYPLANGetForecastSubcontractQty, null,
                                                            Request[&quot;ParentID&quot;].ToInt32_2(),
                                                            dtStartDate.Value.ToUtc(),
                                                            dtEndDate.Value.ToUtc()).Tables[0];
                foreach (DataRow subContractingData in subContractingQty.Select())
                {
                    UltraGridRow subContractingResource =
                        grdResource.Rows.OfType&lt;UltraGridRow&gt;().ToList().Find(
                            row =&gt;
                            (row.Cells.FromKey(&quot;ResItemID&quot;).Text.Equals(subContractingData[&quot;ResItemID&quot;].ToString2(),
                                                                        StringComparison.CurrentCultureIgnoreCase) &amp;&amp;
                             (row.Cells.FromKey(&quot;Unit&quot;).Text.Equals(subContractingData[&quot;Unit&quot;].ToString2(),
                                                                    StringComparison.CurrentCultureIgnoreCase)) &amp;&amp;
                             (row.Cells.FromKey(&quot;Rate&quot;).Text.Equals(subContractingData[&quot;Rate&quot;].ToString2(),
                                                                    StringComparison.CurrentCultureIgnoreCase))));

                    subContractingResource.Cells.FromKey(&quot;Quantity&quot;).Value = subContractingData[&quot;Qty&quot;].ToDecimal2();
                    subContractingResource.Cells.FromKey(&quot;Cost&quot;).Value = subContractingData[&quot;Qty&quot;].ToDecimal2()*
                                                                         subContractingData[&quot;Rate&quot;].ToDecimal2();
                }
            }
        }

        private void ResetResourcesGrid()
        {
            foreach (UltraGridRow row in grdResource.Rows)
            {
                if (row.Cells.FromKey(&quot;ResourceTypeName&quot;).Value.ToString2() != &quot;Miscellaneous&quot;)
                {
                    row.Cells.FromKey(&quot;Rate&quot;).Value = row.Cells.FromKey(&quot;RateAnalysisRate&quot;).Value;
                    row.Cells.FromKey(&quot;Quantity&quot;).Value = 0.0;
                    row.Cells.FromKey(&quot;Cost&quot;).Value = 0.0;
                }
                else
                    row.Cells.FromKey(&quot;Cost&quot;).Value = 0.0;
            }
        }

        private void ResetOverheadsGrid()
        {
            foreach (UltraGridRow row in grdOverheads.Rows)
            {
                row.Cells.FromKey(&quot;Cost&quot;).Value = 0.0;
            }
        }

        private bool ValidateResourceForAXDimensions(string parentResItemId, string size, string color,
                                                     string configuration)
        {
            string validate = &quot;&quot;;
            if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX))
            {
                string AXCompany = ((Page) HttpContext.Current.Handler).Session[Constants.EIS_ADDITIONAL_INFO] == null
                                       ? string.Empty
                                       : ((Page) HttpContext.Current.Handler).Session[Constants.EIS_ADDITIONAL_INFO].
                                             ToString();
                validate = ItemManager.Instance.ValidateInventoryDimensions(AXCompany, parentResItemId, size, color,
                                                                            configuration);
                if (string.IsNullOrEmpty(validate))
                    return true;
                else
                    return false;
            }
            else
                return true;
        }

        protected override void SetModes()
        {
            base.SetModes();
            _IsNew = !string.IsNullOrEmpty(Request.QueryString[&quot;Mode&quot;]) &amp;&amp; Request.QueryString[&quot;Mode&quot;] == &quot;N&quot;;
            _IsEdit = !string.IsNullOrEmpty(Request.QueryString[&quot;Mode&quot;]) &amp;&amp; Request.QueryString[&quot;Mode&quot;] == &quot;E&quot;;
            _IsView = !string.IsNullOrEmpty(Request.QueryString[&quot;Mode&quot;]) &amp;&amp; Request.QueryString[&quot;Mode&quot;] == &quot;V&quot;;
        }
    }

    [CustomResourceType(&quot;Forms&quot;, &quot;XFRCAST&quot;)]
    public class PerformForecastOperation : FormsCustomResource
    {
        public PerformForecastOperation()
        {
            _Namespace = &quot;Forms&quot;;
            _Path = &quot;Contract.Planning.Forecast&quot;;
            _Name = &quot;PerformForecastOperation&quot;;
            _Desc = &quot;Perform Forecast Operation&quot;;

            _InParameters = new[] {&quot;Operation,System.String&quot;};
            _OutParameters = new[] {&quot;IsSuccessful,System.Boolean&quot;, &quot;Message,System.String&quot;};
        }

        public override void ExecuteDerived()
        {
            string operation = GetInputParam(&quot;Operation&quot;).ToString();
            string currentUser = GetInputParam(&quot;_CurrentUserId&quot;).ToString();
            string company = GetInputParam(&quot;Company&quot;).ToString();
            string culture = GetInputParam(&quot;Culture&quot;).ToString();
            string uiCulture = GetInputParam(&quot;UICulture&quot;).ToString();
            Thread.CurrentThread.CurrentCulture = new CultureInfo(culture);
            Thread.CurrentThread.CurrentUICulture = new CultureInfo(uiCulture);

            switch (operation.ToUpper2())
            {
                case &quot;APPROVE&quot;:
                    ApproveForecast(currentUser, company);
                    break;
            }
        }

        private void ApproveForecast(string currentUser, string AXCompany)
        {
            string selForecastID = InstanceId;
            string ParentID =
                ComponentHelper.Instance.ExecuteScalar(&quot;SELECT ParentID FROM AXFRCSTMain WHERE ForecastID = {0}&quot;, InstanceId).ToString2();

            if (IntegrationConnectorManager.Instance.IsIntegrationConnectorAttached(RegisteredEIS.AX) &amp;&amp;
                BL.Instance.GetContractDetails(ParentID.ToInt32_2()).Tables[0].Rows[0][&quot;PushFRCSTtoAX&quot;].ToBoolean2())
            {
                //Check for Brix-AX Subproject mapping
                DataTable dtMap =
                    IntegrationConnectorManager.Instance.GetERPObjectMapInfo(ParentID,
                                                                             AMP3Object.CONTMGT, null,
                                                                             AMP3Object.UNKNOWN, RegisteredEIS.AX);

                if (dtMap.Rows.Count &gt; 0)
                {
                    var conBrixInfo = new List&lt;ConnectionBrixInfo&gt;();
                    conBrixInfo.Add(new ConnectionBrixInfo(AMP3Object.CONTMGT, ParentID,
                                                           AMP3Object.UNKNOWN, null));
                    var AdditionalInfo = new EISAdditionalInfo(RegisteredEIS.AX);
                    AdditionalInfo.AddInfo(&quot;AXCompany&quot;, AXCompany);
                    var dictAdditionalInfo =
                        new Dictionary&lt;RegisteredEIS, EISAdditionalInfo&gt;();
                    dictAdditionalInfo.Add(RegisteredEIS.AX, AdditionalInfo);
                    var connectorParameters = new ConnectorParameters(dictAdditionalInfo,
                                                                      MethodBase.GetCurrentMethod(),
                                                                      AMP3ObjectType.Unknown, null,
                                                                      conBrixInfo);

                    int recordCount = 0;
                    DataSet dsData = new BrixDataSet();
                    dsData.Tables.Add();
                    dsData.Tables.Add();
                    DataTable forecastDetails =
                        ComponentHelper.Instance.ExecuteDataSet(&quot;SELECT * FROM AXFRCSTMain WHERE ForecastID = {0}&quot;, selForecastID).Tables[0];
                    DataTable resourceDetails =
                        ComponentHelper.Instance.ExecuteDataSet(&quot;SELECT * FROM AXFRCSTResourceDetails WHERE ForecastID = {0}&quot;, selForecastID).Tables[0];
                    DataTable Items = new BrixDataTable();
                    GetItemsTable(Items);

                    foreach (
                        DataRow dr in
                            resourceDetails.Select(
                                &quot;ResourceTypeName &lt;&gt; &#39;Miscellaneous&#39; and ResourceTypeName &lt;&gt; &#39;Overhead&#39; AND Quantity &lt;&gt; 0&quot;)
                        )
                    {
                        DataRow drNew = Items.NewRow();
                        drNew[&quot;ResItemID&quot;] = dr[&quot;ParentResItemID&quot;];
                        drNew[&quot;ResourceTypeName&quot;] = dr[&quot;ResourceTypeName&quot;];
                        drNew[&quot;Description&quot;] = dr[&quot;Description&quot;];
                        drNew[&quot;Quantity&quot;] = dr[&quot;Quantity&quot;].ToDouble2();
                        drNew[&quot;Rate&quot;] = dr[&quot;Rate&quot;].ToDouble2();
                        drNew[&quot;Cost&quot;] = dr[&quot;Cost&quot;].ToDouble2();
                        drNew[&quot;StartDate&quot;] = forecastDetails.Rows[0][&quot;StartDate&quot;].ToDateTime_MWCulture();
                        drNew[&quot;EndDate&quot;] = forecastDetails.Rows[0][&quot;EndDate&quot;].ToDateTime_MWCulture();
                        drNew[&quot;Unit&quot;] = dr[&quot;Unit&quot;];
                        drNew[&quot;ModelID&quot;] = forecastDetails.Rows[0][&quot;ModelID&quot;];
                        drNew[&quot;Size&quot;] = dr[&quot;Size&quot;];
                        drNew[&quot;Color&quot;] = dr[&quot;Color&quot;];
                        drNew[&quot;Configuration&quot;] = dr[&quot;Configuration&quot;];
                        drNew[&quot;ContractCurrency&quot;] = LocalizationManager.GetModuleCurrency(Constants.MODID_CONTMGT,
                                                                                          ParentID, AXCompany);
                        Items.Rows.Add(drNew);
                    }


                    DataTable miscelleneous = new BrixDataTable();
                    GetMiscalleneousTable(miscelleneous);

                    foreach (
                        DataRow dr in
                            resourceDetails.Select(
                                &quot;Cost &lt;&gt; 0 AND (ResourceTypeName = &#39;Miscellaneous&#39; or ResourceTypeName = &#39;Overhead&#39;)&quot;))
                    {
                        DataRow drNew = miscelleneous.NewRow();
                        drNew[&quot;ContractName&quot;] =
                            ComponentHelper.Instance.ExecuteScalar(&quot;SELECT [Name] FROM CONTMGTMaster WHERE [ID] = {0}&quot;, ParentID).ToString();
                        drNew[&quot;ModelId&quot;] = forecastDetails.Rows[0][&quot;ModelID&quot;];
                        drNew[&quot;Cost&quot;] = dr[&quot;Cost&quot;].ToDouble2();
                        drNew[&quot;Quantity&quot;] = dr[&quot;Quantity&quot;].ToDouble2();
                        drNew[&quot;StartDate&quot;] = forecastDetails.Rows[0][&quot;StartDate&quot;].ToDateTime_MWCulture();
                        drNew[&quot;ResourceTypeName&quot;] = dr[&quot;ResourceTypeName&quot;].ToString2();
                        drNew[&quot;CategoryId&quot;] = dr[&quot;ResItemId&quot;].ToString2();
                        drNew[&quot;OverheadDescription&quot;] = dr[&quot;Description&quot;].ToString2();
                        miscelleneous.Rows.Add(drNew);
                    }
                    dsData.Tables.Add(miscelleneous);
                    dsData.Tables.Add(Items);

                    try
                    {
                        if (IntegrationConnectorManager.HandleIntegration(connectorParameters, ref recordCount,
                                                                          ref dsData,
                                                                          false))
                        {
                            int result2 =
                                ComponentHelper.Instance.ExecuteNonQuery(
                                    &quot;UPDATE AXFRCSTMain SET IsApproved = &#39;1&#39;, ApprovedDate = &#39;&quot; +
                                    DateTime.UtcNow.ToString(&quot;MM/dd/yyyy hh:mm:ss tt&quot;) + &quot;&#39; Where ForecastId = {0}&quot;, selForecastID.ToInt32_2());
                            //throw new Exception(
                            //    &quot;Successfully approved the record and Forecast has been created in Dynamics AX&quot;);
                            SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
                            SetOutParam(&quot;Message&quot;,
                                        &quot;Successfully approved the record and Forecast has been created in Dynamics AX&quot;,
                                        &quot;System.String&quot;);
                        }
                    }
                    catch (Exception ex)
                    {
                        throw ex;
                    }
                }
                else
                {
                    SetOutParam(&quot;IsSuccessful&quot;, false, &quot;System.Boolean&quot;);
                    SetOutParam(&quot;Message&quot;, &quot;Approve Unsuccesful&quot;, &quot;System.String&quot;);
                    throw new Exception(
                        &quot;Approval Cancelled. Contract is not mapped with the AX Sub Project. Forecast is not created in Dynamics AX.&quot;);
                }
            }
            else
            {
                ComponentHelper.Instance.ExecuteNonQuery(
                    &quot;UPDATE AXFRCSTMain SET IsApproved = &#39;1&#39;, ApprovedDate = GETDATE() Where ForecastId = {0}&quot;, selForecastID.ToInt32_2());
                SetOutParam(&quot;IsSuccessful&quot;, true, &quot;System.Boolean&quot;);
                SetOutParam(&quot;Message&quot;, &quot;Approve Succesful&quot;, &quot;System.String&quot;);
            }
        }

        private void GetItemsTable(DataTable Items)
        {
            Items.TableName = &quot;ItemLock&quot;;
            var columns = new[]
                              {
                                  &quot;ResItemID&quot;, &quot;ResourceTypeName&quot;, &quot;Description&quot;, &quot;Quantity&quot;,
                                  &quot;Rate&quot;, &quot;Cost&quot;, &quot;StartDate&quot;, &quot;EndDate&quot;, &quot;Unit&quot;, &quot;ModelID&quot;, &quot;Size&quot;, &quot;Color&quot;,
                                  &quot;Configuration&quot;, &quot;ContractCurrency&quot;
                              };

            foreach (string column in columns)
                Items.Columns.Add(column);
            Items.Columns[&quot;Quantity&quot;].DataType =
                Items.Columns[&quot;Rate&quot;].DataType =
                Items.Columns[&quot;Cost&quot;].DataType = typeof (Double);
            Items.Columns[&quot;StartDate&quot;].DataType =
                Items.Columns[&quot;EndDate&quot;].DataType = typeof (DateTime);

            Items.AcceptChanges();
        }

        private void GetMiscalleneousTable(DataTable miscelleneous)
        {
            miscelleneous.TableName = &quot;ContractMiscItems&quot;;
            var columns = new[]
                              {
                                  &quot;ContractName&quot;, &quot;ModelId&quot;, &quot;Cost&quot;, &quot;Quantity&quot;, &quot;StartDate&quot;, &quot;ResourceTypeName&quot;,
                                  &quot;CategoryId&quot;, &quot;OverheadDescription&quot;
                              };
            foreach (string column in columns)
                miscelleneous.Columns.Add(column);
            miscelleneous.Columns[&quot;Quantity&quot;].DataType =
                miscelleneous.Columns[&quot;Cost&quot;].DataType = typeof (Double);
            miscelleneous.Columns[&quot;StartDate&quot;].DataType = typeof (DateTime);
            miscelleneous.AcceptChanges();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[38,9,40,108,0],[42,9,48,19,0],[50,9,51,110,0],[53,9,54,119,0],[56,9,57,121,0],[59,9,60,90,0],[61,9,62,101,0],[63,9,64,104,0],[65,9,66,113,0],[67,9,68,110,0],[75,13,75,14,0],[76,17,78,36,0],[79,13,79,14,0],[86,17,86,18,0],[86,19,86,96,0],[86,97,86,98,0],[94,17,94,18,0],[94,19,94,78,0],[94,79,94,80,0],[99,17,99,18,0],[99,19,99,50,0],[99,51,99,52,0],[105,9,105,10,0],[106,13,106,49,0],[111,17,111,18,0],[111,19,111,39,0],[111,40,111,41,0],[118,13,118,14,0],[119,17,122,98,0],[123,17,123,38,0],[124,13,124,14,0],[127,37,127,38,0],[127,39,127,322,0],[127,323,127,324,0],[131,17,131,18,0],[131,19,131,36,0],[131,37,131,38,0],[136,17,136,18,0],[136,19,136,31,0],[136,32,136,33,0],[141,17,141,18,0],[141,19,141,65,0],[141,66,141,67,0],[147,13,147,14,0],[148,17,150,96,0],[151,17,151,27,0],[152,13,152,14,0],[158,13,158,14,0],[159,17,161,54,0],[162,13,162,14,0],[166,9,166,10,0],[167,13,167,42,0],[168,9,168,10,0],[172,9,172,10,0],[173,13,173,38,0],[174,13,174,26,0],[175,13,175,30,0],[177,13,177,64,0],[179,13,179,78,0],[180,17,180,29,0],[182,17,182,46,0],[183,9,183,10,0],[188,9,188,10,0],[189,13,189,28,0],[191,13,191,104,0],[192,13,192,14,0],[193,17,193,47,0],[194,17,194,62,0],[195,13,195,14,0],[197,17,197,48,0],[198,9,198,10,0],[201,9,201,10,0],[202,13,202,41,0],[203,13,203,75,0],[204,17,204,38,0],[205,13,205,82,0],[206,13,206,44,0],[207,9,207,10,0],[210,9,210,10,0],[211,13,211,75,0],[212,13,212,14,0],[213,17,213,35,0],[214,17,214,18,0],[215,21,215,82,0],[216,21,216,41,0],[217,21,217,22,0],[218,25,218,56,0],[219,25,219,74,0],[220,21,220,22,0],[221,17,221,18,0],[222,13,222,14,0],[223,13,223,78,0],[224,13,224,80,0],[225,9,225,10,0],[228,9,228,10,0],[229,13,229,55,0],[230,17,231,56,0],[233,13,233,79,0],[234,13,234,14,0],[235,17,237,69,0],[238,13,238,14,0],[239,13,240,79,0],[241,17,242,56,0],[244,13,245,108,0],[246,13,246,41,0],[247,13,247,35,0],[248,13,248,89,0],[249,13,249,91,0],[251,13,251,34,0],[252,13,252,14,0],[253,17,253,131,0],[254,17,254,135,0],[255,17,255,129,0],[256,17,256,64,0],[258,17,258,60,0],[259,17,259,58,0],[262,17,262,107,0],[263,17,263,18,0],[264,21,264,53,0],[265,21,265,43,0],[266,21,266,52,0],[267,21,267,97,0],[268,21,273,109,0],[275,21,278,107,0],[279,21,280,93,0],[281,21,281,22,0],[282,25,282,97,0],[283,25,283,26,0],[284,29,284,67,0],[285,29,285,72,0],[286,29,286,66,0],[287,29,287,71,0],[288,29,288,55,0],[289,29,289,90,0],[290,25,290,26,0],[291,21,291,22,0],[292,17,292,18,0],[293,17,293,83,0],[294,17,294,18,0],[295,21,295,72,0],[299,21,300,117,0],[305,21,306,128,0],[311,21,312,130,0],[313,21,313,54,0],[315,21,315,95,0],[316,21,316,91,0],[317,21,317,98,0],[319,21,319,49,0],[322,21,322,86,0],[323,21,323,57,0],[324,17,324,18,0],[325,17,325,70,0],[326,17,326,18,0],[327,21,328,90,0],[329,17,329,18,0],[331,17,331,18,0],[332,21,333,91,0],[334,17,334,18,0],[335,13,335,14,0],[336,13,336,106,0],[337,13,337,110,0],[338,13,338,111,0],[340,13,340,44,0],[341,9,341,10,0],[344,9,344,10,0],[346,13,346,14,0],[347,17,347,59,0],[348,17,348,55,0],[349,17,349,59,0],[350,17,350,79,0],[351,17,351,75,0],[353,17,353,41,0],[354,17,354,18,0],[355,21,356,123,0],[357,21,357,28,0],[359,17,359,55,0],[360,17,360,51,0],[365,17,365,107,0],[366,17,366,18,0],[367,21,369,97,0],[371,21,371,70,0],[372,21,372,117,0],[375,21,380,100,0],[382,21,382,107,0],[385,21,385,85,0],[386,21,386,81,0],[389,21,389,64,0],[392,21,392,92,0],[393,21,393,90,0],[394,17,394,18,0],[396,17,396,18,0],[398,21,398,36,0],[399,21,399,107,0],[401,21,401,104,0],[402,21,402,105,0],[403,17,403,18,0],[406,17,406,69,0],[407,17,407,42,0],[408,17,408,54,0],[409,17,409,18,0],[410,21,410,91,0],[411,21,412,102,0],[413,17,413,18,0],[414,17,414,63,0],[415,17,415,58,0],[416,17,416,76,0],[417,17,417,66,0],[418,17,418,79,0],[419,17,422,38,0],[423,17,423,60,0],[424,17,424,56,0],[427,17,428,136,0],[429,17,429,63,0],[430,17,430,18,0],[431,21,431,57,0],[432,21,432,22,0],[433,25,433,76,0],[434,25,434,26,0],[435,29,435,104,0],[436,29,436,89,0],[437,33,438,96,0],[440,29,440,68,0],[441,29,441,30,0],[442,33,443,75,0],[444,33,444,40,0],[446,34,446,121,0],[447,29,447,30,0],[448,33,449,112,0],[450,33,450,40,0],[452,25,452,26,0],[453,21,453,22,0],[454,21,455,74,0],[456,21,456,22,0],[457,25,457,89,0],[459,25,459,26,0],[460,29,462,70,0],[463,29,463,36,0],[465,21,465,22,0],[466,21,466,49,0],[467,21,467,22,0],[468,25,468,134,0],[469,25,469,63,0],[470,25,470,72,0],[471,25,471,72,0],[474,25,474,84,0],[476,25,477,155,0],[478,25,478,26,0],[482,29,483,112,0],[484,29,484,30,0],[485,33,485,69,0],[486,33,486,34,0],[487,37,487,76,0],[488,37,488,78,0],[489,37,489,83,0],[490,37,490,91,0],[491,37,493,60,0],[494,37,494,67,0],[495,37,495,119,0],[496,37,496,59,0],[497,37,497,38,0],[498,41,498,97,0],[499,41,499,93,0],[500,37,500,38,0],[501,37,501,67,0],[502,33,502,34,0],[503,33,503,111,0],[504,33,504,107,0],[505,33,505,73,0],[506,33,506,68,0],[507,33,507,70,0],[508,33,508,34,0],[509,37,509,80,0],[510,37,510,77,0],[511,33,511,34,0],[512,29,512,30,0],[514,29,514,30,0],[515,33,517,74,0],[518,33,518,40,0],[520,25,520,26,0],[521,30,521,121,0],[522,25,522,26,0],[523,29,525,70,0],[526,29,526,36,0],[528,21,528,22,0],[529,17,529,18,0],[530,13,530,14,0],[531,13,531,33,0],[532,13,532,14,0],[533,17,533,70,0],[534,17,534,130,0],[535,13,535,14,0],[536,9,536,10,0],[539,9,539,10,0],[540,13,540,42,0],[541,9,541,10,0],[544,9,544,10,0],[545,13,545,58,0],[546,13,546,64,0],[547,13,547,14,0],[548,17,548,84,0],[549,17,549,44,0],[550,17,550,24,0],[552,13,552,62,0],[553,13,553,63,0],[554,13,554,81,0],[556,20,556,85,0],[557,13,557,14,0],[558,17,558,68,0],[560,17,560,83,0],[562,17,563,105,0],[564,17,564,18,0],[565,21,565,74,0],[566,21,566,70,0],[567,17,567,18,0],[569,17,569,18,0],[570,21,570,79,0],[571,21,571,75,0],[572,17,572,18,0],[574,17,574,107,0],[575,17,575,18,0],[577,21,577,28,0],[577,30,577,46,0],[577,47,577,49,0],[577,50,577,66,0],[578,21,578,22,0],[580,25,580,102,0],[581,25,582,83,0],[583,25,583,26,0],[584,29,584,109,0],[585,29,587,106,0],[588,29,590,108,0],[591,29,593,124,0],[595,29,596,69,0],[597,29,597,30,0],[598,33,598,115,0],[599,33,599,34,0],[601,37,602,52,0],[603,33,603,34,0],[604,33,604,68,0],[605,33,605,34,0],[606,37,607,108,0],[608,37,608,44,0],[610,29,610,30,0],[611,25,611,26,0],[612,21,612,22,0],[613,17,613,18,0],[617,24,617,101,0],[618,17,618,18,0],[619,21,619,111,0],[620,21,620,105,0],[621,21,621,99,0],[622,21,622,95,0],[623,21,626,59,0],[627,21,630,59,0],[631,21,631,103,0],[632,21,632,41,0],[633,21,633,22,0],[634,25,634,96,0],[635,25,635,55,0],[636,25,636,96,0],[637,21,637,22,0],[639,21,639,22,0],[640,25,640,94,0],[641,25,641,55,0],[642,21,642,22,0],[643,17,643,18,0],[646,17,646,71,0],[647,17,647,18,0],[651,21,651,157,0],[655,21,655,155,0],[656,17,656,18,0],[658,17,658,24,0],[658,26,658,42,0],[658,43,658,45,0],[658,46,658,58,0],[659,17,659,18,0],[660,21,665,113,0],[666,17,666,18,0],[668,17,668,63,0],[669,17,669,64,0],[671,17,671,62,0],[672,13,672,14,0],[673,9,673,10,0],[676,9,676,10,0],[679,13,679,20,0],[679,22,679,38,0],[679,39,679,41,0],[679,42,679,51,0],[680,13,680,14,0],[684,17,684,66,0],[685,21,685,94,0],[687,21,687,88,0],[689,17,702,87,0],[703,13,703,14,0],[704,9,704,10,0],[707,9,707,10,0],[708,13,709,52,0],[710,9,710,10,0],[713,9,713,10,0],[714,13,714,65,0],[715,13,715,74,0],[716,13,716,71,0],[717,13,717,64,0],[718,13,718,64,0],[719,13,719,78,0],[720,13,720,43,0],[722,13,722,48,0],[725,13,725,20,0],[725,22,725,32,0],[725,33,725,35,0],[725,36,725,58,0],[726,13,726,14,0],[728,17,728,18,0],[729,21,732,99,0],[733,17,733,18,0],[734,17,734,22,0],[735,17,735,18,0],[736,21,736,48,0],[737,17,737,18,0],[738,17,739,86,0],[740,17,740,44,0],[741,17,741,60,0],[742,17,742,54,0],[743,17,743,40,0],[744,17,744,40,0],[745,17,745,82,0],[746,13,746,14,0],[747,9,747,10,0],[750,9,750,10,0],[752,13,752,48,0],[753,13,753,75,0],[754,13,754,71,0],[755,13,755,48,0],[758,13,758,74,0],[759,13,759,39,0],[761,13,764,31,0],[765,13,765,109,0],[766,13,766,14,0],[767,17,767,38,0],[768,13,768,14,0],[769,13,769,20,0],[769,22,769,40,0],[769,41,769,43,0],[769,44,769,62,0],[770,13,770,14,0],[771,17,771,37,0],[772,17,772,96,0],[773,17,773,18,0],[774,21,774,65,0],[775,21,775,22,0],[776,25,776,96,0],[777,25,777,156,0],[778,21,778,22,0],[780,21,780,22,0],[781,25,784,44,0],[786,25,786,119,0],[787,21,787,22,0],[789,21,789,50,0],[790,21,790,22,0],[791,25,791,68,0],[792,25,792,34,0],[794,17,794,18,0],[796,17,796,65,0],[797,17,797,167,0],[799,17,799,18,0],[800,21,803,99,0],[804,17,804,18,0],[805,17,805,22,0],[806,17,806,18,0],[808,21,808,48,0],[809,17,809,18,0],[810,17,810,112,0],[812,17,812,53,0],[813,21,813,99,0],[815,17,815,113,0],[816,13,816,14,0],[818,13,818,97,0],[819,13,819,14,0],[820,17,820,24,0],[820,26,820,37,0],[820,38,820,40,0],[820,41,820,64,0],[821,17,821,18,0],[822,21,822,53,0],[823,21,823,22,0],[824,25,824,96,0],[825,25,825,56,0],[825,57,825,98,0],[826,21,826,22,0],[827,17,827,18,0],[829,17,834,128,0],[835,13,835,14,0],[836,9,836,10,0],[839,9,839,10,0],[840,13,840,73,0],[841,13,841,39,0],[842,13,842,20,0],[842,22,842,38,0],[842,39,842,41,0],[842,42,842,115,0],[843,13,843,14,0],[844,17,844,65,0],[845,13,845,14,0],[847,13,847,69,0],[848,9,848,10,0],[851,9,851,10,0],[852,13,852,88,0],[854,13,855,55,0],[855,55,855,76,0],[855,76,857,44,0],[857,44,859,75,0],[859,75,859,101,0],[859,101,860,82,0],[860,82,860,115,0],[860,115,861,77,0],[861,77,861,105,0],[861,105,862,70,0],[862,70,862,91,0],[862,91,865,70,0],[865,70,865,92,0],[865,92,867,49,0],[857,44,867,49,0],[867,49,867,50,0],[854,13,867,50,0],[869,13,869,66,0],[873,13,876,92,0],[878,13,878,20,0],[878,22,878,39,0],[878,40,878,42,0],[878,43,878,60,0],[879,13,879,14,0],[880,17,880,59,0],[883,17,884,69,0],[885,17,885,18,0],[886,21,889,44,0],[890,17,890,18,0],[892,17,892,61,0],[893,17,903,44,0],[904,17,904,52,0],[905,13,905,14,0],[907,13,907,57,0],[909,13,909,36,0],[910,9,910,10,0],[913,9,913,10,0],[914,13,914,20,0],[914,22,914,41,0],[914,42,914,44,0],[914,45,914,57,0],[915,17,915,52,0],[916,9,916,10,0],[919,9,919,10,0],[920,13,920,52,0],[921,13,921,49,0],[922,13,922,44,0],[923,13,923,32,0],[924,13,924,43,0],[925,9,925,10,0],[928,9,928,10,0],[929,13,929,56,0],[930,13,930,42,0],[931,13,931,45,0],[932,13,932,36,0],[933,13,933,47,0],[934,9,934,10,0],[937,9,937,10,0],[938,13,938,56,0],[939,13,939,55,0],[940,13,940,51,0],[941,13,941,37,0],[942,13,942,48,0],[943,9,943,10,0],[946,9,946,10,0],[947,13,958,47,0],[959,13,959,50,0],[960,13,960,14,0],[961,17,961,59,0],[962,17,962,56,0],[963,13,963,14,0],[964,13,964,45,0],[964,46,964,96,0],[965,13,965,74,0],[967,13,967,41,0],[968,13,969,46,0],[971,13,971,67,0],[972,9,972,10,0],[975,9,975,10,0],[976,13,988,47,0],[989,13,989,50,0],[990,13,990,14,0],[991,17,991,54,0],[992,17,992,54,0],[993,13,993,14,0],[994,13,994,78,0],[996,13,996,99,0],[997,13,997,72,0],[998,17,998,95,0],[1000,13,1000,45,0],[1002,13,1002,87,0],[1003,9,1003,10,0],[1006,9,1006,10,0],[1007,13,1007,92,0],[1008,13,1008,50,0],[1009,13,1009,14,0],[1010,17,1010,54,0],[1011,13,1011,14,0],[1012,13,1012,79,0],[1014,13,1014,86,0],[1015,13,1015,90,0],[1017,13,1017,46,0],[1019,13,1019,68,0],[1020,9,1020,10,0],[1023,9,1023,10,0],[1024,13,1024,20,0],[1024,22,1024,41,0],[1024,42,1024,44,0],[1024,45,1024,57,0],[1025,17,1025,35,0],[1027,13,1027,30,0],[1028,13,1028,20,0],[1028,22,1028,35,0],[1028,36,1028,38,0],[1028,39,1028,60,0],[1029,13,1029,14,0],[1030,17,1030,49,0],[1031,17,1031,18,0],[1032,21,1032,65,0],[1033,21,1033,67,0],[1034,17,1034,18,0],[1035,13,1035,14,0],[1036,9,1036,10,0],[1039,9,1039,10,0],[1040,13,1040,66,0],[1041,13,1041,14,0],[1042,17,1042,24,0],[1042,26,1042,37,0],[1042,38,1042,40,0],[1042,41,1042,54,0],[1043,17,1043,18,0],[1044,21,1044,51,0],[1045,21,1045,22,0],[1046,25,1046,82,0],[1047,25,1047,87,0],[1048,25,1048,80,0],[1049,25,1049,77,0],[1050,21,1050,22,0],[1051,17,1051,18,0],[1052,13,1052,14,0],[1053,9,1053,10,0],[1056,9,1056,10,0],[1057,13,1057,59,0],[1058,13,1058,69,0],[1059,13,1059,76,0],[1060,13,1060,71,0],[1061,13,1061,64,0],[1062,13,1062,65,0],[1063,13,1063,69,0],[1064,13,1064,65,0],[1065,13,1065,77,0],[1066,13,1066,43,0],[1067,13,1067,34,0],[1068,9,1068,10,0],[1071,9,1071,10,0],[1072,13,1072,115,0],[1073,13,1073,118,0],[1074,13,1074,111,0],[1075,13,1075,113,0],[1076,13,1076,109,0],[1077,9,1077,10,0],[1080,9,1080,10,0],[1081,13,1081,73,0],[1082,9,1082,10,0],[1086,9,1086,10,0],[1087,13,1087,49,0],[1088,13,1088,14,0],[1089,17,1089,66,0],[1090,17,1090,94,0],[1091,17,1091,97,0],[1092,17,1092,52,0],[1092,53,1092,111,0],[1093,13,1093,14,0],[1094,9,1094,10,0],[1097,9,1097,10,0],[1098,13,1098,54,0],[1100,13,1100,20,0],[1100,22,1100,32,0],[1100,33,1100,35,0],[1100,36,1100,60,0],[1101,13,1101,14,0],[1102,17,1102,106,0],[1103,17,1103,18,0],[1104,21,1104,53,0],[1105,21,1105,53,0],[1106,17,1106,18,0],[1107,13,1107,14,0],[1108,9,1108,10,0],[1111,9,1111,10,0],[1112,13,1112,81,0],[1113,13,1113,14,0],[1114,17,1114,58,0],[1115,17,1115,76,0],[1116,17,1116,81,0],[1117,17,1117,62,0],[1118,17,1118,80,0],[1119,17,1119,85,0],[1120,13,1120,14,0],[1122,13,1122,14,0],[1123,17,1123,76,0],[1124,17,1124,81,0],[1125,13,1125,14,0],[1126,9,1126,10,0],[1129,9,1129,10,0],[1130,13,1130,28,0],[1131,13,1131,38,0],[1132,13,1132,34,0],[1133,13,1133,34,0],[1134,13,1134,20,0],[1134,22,1134,39,0],[1134,40,1134,42,0],[1134,43,1134,55,0],[1135,13,1135,14,0],[1136,17,1136,73,0],[1137,17,1137,82,0],[1138,17,1138,74,0],[1139,13,1139,14,0],[1140,9,1140,10,0],[1144,9,1144,10,0],[1145,13,1147,70,0],[1149,13,1149,20,0],[1149,22,1149,38,0],[1149,39,1149,41,0],[1149,42,1149,70,0],[1150,13,1150,14,0],[1151,17,1151,76,0],[1152,17,1152,18,0],[1153,21,1153,28,0],[1153,30,1153,46,0],[1153,47,1153,49,0],[1153,50,1153,66,0],[1154,21,1154,22,0],[1155,25,1155,120,0],[1156,25,1156,26,0],[1157,29,1157,77,0],[1158,29,1158,30,0],[1161,33,1163,94,0],[1164,33,1164,34,0],[1165,37,1168,122,0],[1169,37,1170,116,0],[1171,33,1171,34,0],[1172,29,1172,30,0],[1174,29,1174,30,0],[1175,33,1175,112,0],[1176,37,1177,116,0],[1178,29,1178,30,0],[1179,25,1179,26,0],[1180,21,1180,22,0],[1181,17,1181,18,0],[1182,22,1182,42,0],[1183,17,1183,18,0],[1184,21,1184,28,0],[1184,30,1184,46,0],[1184,47,1184,49,0],[1184,50,1184,67,0],[1185,21,1185,22,0],[1187,25,1187,96,0],[1188,25,1188,26,0],[1189,29,1190,108,0],[1191,25,1191,26,0],[1192,21,1192,22,0],[1193,17,1193,18,0],[1194,13,1194,14,0],[1196,13,1196,48,0],[1197,13,1197,14,0],[1198,17,1202,96,0],[1203,17,1203,24,0],[1203,26,1203,52,0],[1203,53,1203,55,0],[1203,56,1203,82,0],[1204,17,1204,18,0],[1205,21,1208,29,0],[1208,29,1213,113,0],[1213,113,1213,115,0],[1205,21,1213,115,0],[1215,21,1215,117,0],[1216,21,1217,114,0],[1218,17,1218,18,0],[1219,13,1219,14,0],[1220,9,1220,10,0],[1223,9,1223,10,0],[1224,13,1224,20,0],[1224,22,1224,38,0],[1224,39,1224,41,0],[1224,42,1224,58,0],[1225,13,1225,14,0],[1226,17,1226,96,0],[1227,17,1227,18,0],[1228,21,1228,99,0],[1229,21,1229,63,0],[1230,21,1230,59,0],[1231,17,1231,18,0],[1233,21,1233,59,0],[1234,13,1234,14,0],[1235,9,1235,10,0],[1238,9,1238,10,0],[1239,13,1239,20,0],[1239,22,1239,38,0],[1239,39,1239,41,0],[1239,42,1239,59,0],[1240,13,1240,14,0],[1241,17,1241,55,0],[1242,13,1242,14,0],[1243,9,1243,10,0],[1247,9,1247,10,0],[1248,13,1248,34,0],[1249,13,1249,103,0],[1250,13,1250,14,0],[1251,17,1254,57,0],[1255,17,1256,92,0],[1257,17,1257,52,0],[1258,21,1258,33,0],[1260,21,1260,34,0],[1263,17,1263,29,0],[1264,9,1264,10,0],[1267,9,1267,10,0],[1268,13,1268,29,0],[1269,13,1269,111,0],[1270,13,1270,112,0],[1271,13,1271,112,0],[1272,9,1272,10,0],[1278,9,1278,42,0],[1279,9,1279,10,0],[1280,13,1280,34,0],[1281,13,1281,50,0],[1282,13,1282,48,0],[1283,13,1283,50,0],[1285,13,1285,63,0],[1286,13,1286,93,0],[1287,9,1287,10,0],[1290,9,1290,10,0],[1291,13,1291,70,0],[1292,13,1292,77,0],[1293,13,1293,66,0],[1294,13,1294,66,0],[1295,13,1295,70,0],[1296,13,1296,76,0],[1297,13,1297,80,0],[1299,13,1299,42,0],[1302,21,1302,59,0],[1303,21,1303,27,0],[1305,9,1305,10,0],[1308,9,1308,10,0],[1309,13,1309,47,0],[1310,13,1311,139,0],[1313,13,1314,118,0],[1315,13,1315,14,0],[1317,17,1320,116,0],[1322,17,1322,42,0],[1323,17,1323,18,0],[1324,21,1324,70,0],[1325,21,1326,87,0],[1327,21,1327,82,0],[1328,21,1328,68,0],[1329,21,1330,76,0],[1331,21,1331,78,0],[1332,21,1335,84,0],[1337,21,1337,41,0],[1338,21,1338,56,0],[1339,21,1339,41,0],[1340,21,1340,41,0],[1341,21,1342,142,0],[1343,21,1344,153,0],[1345,21,1345,59,0],[1346,21,1346,42,0],[1348,21,1348,28,0],[1349,25,1349,35,0],[1349,36,1349,38,0],[1350,29,1351,124,0],[1353,21,1353,22,0],[1354,25,1354,56,0],[1355,25,1355,68,0],[1356,25,1356,76,0],[1357,25,1357,66,0],[1358,25,1358,72,0],[1359,25,1359,64,0],[1360,25,1360,64,0],[1361,25,1361,106,0],[1362,25,1362,102,0],[1363,25,1363,52,0],[1364,25,1364,79,0],[1365,25,1365,52,0],[1366,25,1366,54,0],[1367,25,1367,70,0],[1368,25,1369,112,0],[1370,25,1370,47,0],[1371,21,1371,22,0],[1374,21,1374,67,0],[1375,21,1375,58,0],[1377,21,1377,28,0],[1378,25,1378,35,0],[1378,36,1378,38,0],[1379,29,1380,119,0],[1381,21,1381,22,0],[1382,25,1382,64,0],[1383,25,1384,142,0],[1385,25,1385,79,0],[1386,25,1386,64,0],[1387,25,1387,72,0],[1388,25,1388,106,0],[1389,25,1389,88,0],[1390,25,1390,75,0],[1391,25,1391,86,0],[1392,25,1392,55,0],[1393,21,1393,22,0],[1394,21,1394,54,0],[1395,21,1395,46,0],[1398,21,1398,22,0],[1399,25,1401,82,0],[1402,25,1402,26,0],[1403,29,1406,145,0],[1409,29,1409,81,0],[1410,29,1412,58,0],[1413,25,1413,26,0],[1414,21,1414,22,0],[1415,21,1415,41,0],[1416,21,1416,22,0],[1417,25,1417,34,0],[1419,17,1419,18,0],[1421,17,1421,18,0],[1422,21,1422,74,0],[1423,21,1423,84,0],[1424,21,1425,136,0],[1427,13,1427,14,0],[1429,13,1429,14,0],[1430,17,1431,140,0],[1432,17,1432,69,0],[1433,17,1433,78,0],[1434,13,1434,14,0],[1435,9,1435,10,0],[1438,9,1438,10,0],[1439,13,1439,42,0],[1440,13,1445,33,0],[1447,13,1447,20,0],[1447,22,1447,35,0],[1447,36,1447,38,0],[1447,39,1447,46,0],[1448,17,1448,43,0],[1449,13,1451,66,0],[1452,13,1453,71,0],[1455,13,1455,35,0],[1456,9,1456,10,0],[1459,9,1459,10,0],[1460,13,1460,59,0],[1461,13,1465,33,0],[1466,13,1466,20,0],[1466,22,1466,35,0],[1466,36,1466,38,0],[1466,39,1466,46,0],[1467,17,1467,51,0],[1468,13,1469,74,0],[1470,13,1470,77,0],[1471,13,1471,43,0],[1472,9,1472,10,0]]);
    </script>
  </body>
</html>