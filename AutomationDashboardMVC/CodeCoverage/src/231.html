<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Addon Modules\Contract Manager\Pay Estimates\ProcurementPE.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.UI;
using System.Web.UI.WebControls;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.AMP3.Core.UserControls;
using System.Data;
using Infragistics.WebUI.UltraWebGrid;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Platform.BusinessLayer.UserControls;
using System.Drawing;
using Aurigo.Common;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DTO;
using System.Web.Script.Serialization;
using Aurigo.AMP3.CONTMGTPEBL;
using System.Collections;
using System.Text;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.Brix.Construction.ContractManager.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Telerik.Web.UI;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;


namespace Aurigo.AMP3.CONTMGTPEUI
{
    public partial class ProcurementPE : BrixPageBase, IWorkflowEnabled, IXMLControl
    {
        public global::Infragistics.WebUI.WebSchedule.WebDateChooser dtFromDate;
        public global::Infragistics.WebUI.WebSchedule.WebDateChooser dtEndDate;

        public global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneRetainagePercentage;
        public global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneRetainageAmount;

        public global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneRetainageReleasePercentage;
        public global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneRetainageReleaseAmount;

        public global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneHoldPercentage;
        public global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneHoldAmount;

        public global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneHoldReleasePercentage;
        public global::Infragistics.WebUI.WebDataInput.WebNumericEdit wneHoldReleaseAmount;

        public global::Telerik.Web.UI.RadGrid grdWorkDone;
        public global::Telerik.Web.UI.RadGrid grdAdvances;
        public global::Telerik.Web.UI.RadGrid grdAdjustments;
        public global::Telerik.Web.UI.RadGrid grdRecoveries;
        protected global::Aurigo.Brix.Platform.BusinessLayer.UserControls.PickerGrid pickerAdjustments;
        protected global::Aurigo.Brix.Platform.BusinessLayer.UserControls.PickerGrid pickerWorkDone;

        protected global::Aurigo.AMP3.Core.UserControls.AttachmentsControl peAttachments;

        string POType
        {
            get
            {
                return Request[&quot;POType&quot;] ?? &quot;&quot;;
            }
        }

        int POTypeInstanceID
        {
            get
            {
                return Request[&quot;POTypeInstanceID&quot;] == null ? 0 : Request[&quot;POTypeInstanceID&quot;].ToInt32_2();
            }
        }

        public int POID
        {
            get { return string.IsNullOrEmpty(hdnPOID.Value) ? 0 : hdnPOID.Value.ToInt32_2(); }
            set { hdnPOID.Value = value.ToString(); }
        }

        int PEID
        {
            get
            {
                return Request[&quot;PEID&quot;] == null ? 0 : Request[&quot;PEID&quot;].ToInt32_2();
            }
        }

        string Mode
        {
            get
            {
                return Request.QueryString[&quot;Mode&quot;] == null ? &quot;New&quot; : Request.QueryString[&quot;Mode&quot;];
            }
        }

        bool IsLatestPE
        {
            get { return (string.IsNullOrEmpty(hdnIsLatestPE.Value) ? &quot;false&quot; : hdnIsLatestPE.Value).ToBoolean2(); }
            set { hdnIsLatestPE.Value = value.ToString(); }
        }

        bool AllowPartRate { get; set; }
        bool AllowPartQuantity { get; set; }
        private BrixFormModel model;
        private XMLFormManagerModel managerModel;
        protected override void OnInit(EventArgs e)
        {
            PageTitle = LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE);

            peAttachments.InstanceID = FormInstanceId;
            peAttachments.SrcType = &quot;PAYESTM&quot;;
            peAttachments.ReadOnly = IsView;

            InitializeAdjustmentsPicker();
            InitializeWorkDonePicker();

            hdnRequestMode.Value = Mode;

            base.OnInit(e);
            SetManagerModel();
            if (managerModel != null)
                managerModel.OnInit(model, new XmlFormArgs());

        }

        protected override void CreateChildControls()
        {
            var menuGroups = new List&lt;MenuGroup&gt;();
            MenuGroup generalGroup = new MenuGroup(&quot;General&quot;);
            if (!Mode.Equals(&quot;View&quot;, StringComparison.CurrentCultureIgnoreCase))
                if (AllowSave)
                    generalGroup.AddMenu(new LargeButton(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;));
            generalGroup.AddMenu(new LargeButton(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;));
            menuGroups.Add(generalGroup);
            CreateToolBarMenu(menuGroups, null);
            base.CreateChildControls();
        }

        protected override void CustomizeToolBar()
        {
            if (!Mode.Equals(&quot;View&quot;, StringComparison.CurrentCultureIgnoreCase))
                if (MainToolBar.GetMenuReference(&quot;lnkSave&quot;) != null)
                {
                    if (_WorkflowsInitiated != null &amp;&amp; _WorkflowsInitiated.Count &gt; 0)
                        MainToolBar.GetMenuReference(&quot;lnkSave&quot;).OnClientClick = &quot; DisableControlsOnSaveAndWFAction(&#39;&quot; + _WorkflowsInitiated[0].ToString() + &quot;&#39;);var result= ValidateSave(&#39;&quot; + Mode + &quot;&#39;); if(!result){EnableControlsOnSaveAndWFAction(&#39;&quot; + _WorkflowsInitiated[0].ToString() + &quot;&#39;); return false;} else return true;&quot;;
                   else
                        MainToolBar.GetMenuReference(&quot;lnkSave&quot;).OnClientClick = &quot;return ValidateSave(&#39;&quot; + Mode + &quot;&#39;);&quot;;

                    MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += new EventHandler(lnkSave_Click);
                }

            if (MainToolBar.GetMenuReference(&quot;lnkCancel&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += new EventHandler(lnkCancel_Click);
            }

            base.CustomizeToolBar();
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            //TODO: Get these values from module components
            AllowPartQuantity = AllowPartRate = false;

            wneRetainagePercentage.MinDecimalPlaces = Infragistics.WebUI.WebDataInput.MinDecimalPlaces.Eight;

            ClientScript.RegisterClientScriptInclude(&quot;JS&quot;, ResolveUrl(&quot;~/Modules/PAYESTM/Scripts/Procurement_20170123_1232.js&quot;));

            if (!IsPostBack)
            {
                lblRABillNoTitle.Text = LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; Number :&quot;;
                LoadCommitmentDetails();

                IsLatestPE = CONTMGTPEBL.BL.Instance.IsLatestPE(POID, PEID);

                if (!IsLatestPE)
                    MainToolBar.HideMenu(&quot;lnkSave&quot;);
                else
                    MainToolBar.ShowMenu(&quot;lnkSave&quot;);

                LoadHoldAndRetainageDetails();
                GetGridSchema();
                SetRetentionRules();

                if (Mode.Equals(&quot;Edit&quot;, StringComparison.CurrentCultureIgnoreCase))
                {
                    PageTitle = &quot;Edit &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE);
                    LoadPayEstimateDetails();
                    if (!IsLatestPE)
                        ViewMode();
                }
                else if (Mode.Equals(&quot;View&quot;, StringComparison.CurrentCultureIgnoreCase))
                {
                    PageTitle = &quot;View &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE);
                    LoadPayEstimateDetails();
                    ViewMode();
                }
                else
                {
                    PageTitle = &quot;New &quot; + LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE);
                    lblPayEstimateNo.Text = BL.Instance.GetPENextRANumber(POID);
                    //Unless the generate button is clicked, you should not be allowed to add Work Done the first time.
                    if (hdnGenerateClicked.Value.Equals(&quot;true&quot;, StringComparison.CurrentCultureIgnoreCase))
                    {
                        btnAddWorkDone.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                        btnDeleteWorkDone.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                    }
                    else
                    {
                        btnAddWorkDone.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                        btnDeleteWorkDone.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                    }
                }

                hdnCurrencySymbol.Value = LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL);
                hdnAmountDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT).ToString2();
                hdnQuantityDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_QUANTITY).ToString2();
                hdnRateDigits.Value = CoreDatabaseHelper.GetDigitsAfterDecimal(AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE).ToString2();
                hdnTodate.Value = Convert.ToString(Convert.ToDateTime(dtEndDate.Value));
                hdnRetentionOnAdjustments.Value = (BL.Instance.RetentionOnAdjustments()) ? &quot;1&quot; : &quot;0&quot;;
                hdnRetentionOnAdvances.Value = (BL.Instance.RetentionOnAdvances()) ? &quot;1&quot; : &quot;0&quot;;
                hdnCulture.Value = AMP3ApplicationSettings.Instance.Culture.ToString2();

                string errDocuSign = string.Empty;
                if (Session[&quot;DocuSignErr&quot;] != null)
                    errDocuSign = Session[&quot;DocuSignErr&quot;].ToString();

                if (!string.IsNullOrEmpty(errDocuSign))
                {
                    ShowError(errDocuSign);
                    Session.Remove(&quot;DocuSignErr&quot;);
                }
            }

            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.OnPageLoad(model, args);
        }

        void ViewMode()
        {
            btnGenerate.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            btnAddWorkDone.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            btnDeleteWorkDone.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            btnAddAdjustment.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            btnDeleteAdjustment.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            wneRetainagePercentage.Enabled =
            wneRetainageAmount.Enabled =
            rbRetainagePercentage.Enabled =
            rbRetainageAmount.Enabled =
            wneRetainageReleasePercentage.Enabled =
            wneRetainageReleaseAmount.Enabled =
            rbRetainageReleasePercentage.Enabled =
            rbRetainageReleaseAmount.Enabled =
            dtFromDate.Enabled =
            dtEndDate.Enabled =
            wneHoldPercentage.Enabled =
            wneHoldAmount.Enabled =
            rbHoldPercentage.Enabled =
            rbHoldAmount.Enabled =
            wneHoldReleasePercentage.Enabled =
            wneHoldReleaseAmount.Enabled =
            rbHoldReleasePercentage.Enabled =
            rbHoldReleaseAmount.Enabled =
            txtNotes.Enabled = false;
        }

        private void LoadPayEstimateDetails()
        {
            DataSet dsPE = BL.Instance.GetPayEstimateDetails(PEID, dtEndDate.Value.ToUtc());
            if (dsPE != null &amp;&amp; dsPE.Tables.Count == 6)
            {
                //Load Pay estimate details
                if (dsPE.Tables[0].Rows.Count == 1)
                {
                    DataRow row = dsPE.Tables[0].Rows[0];
                    dtFromDate.Value = row[&quot;FromDate&quot;].ToMWDateTime();
                    dtEndDate.Value = row[&quot;ToDate&quot;].ToMWDateTime();
                    txtNotes.Text = row[&quot;Notes&quot;].ToString();
                    lblPayEstimateNo.Text = row[&quot;PENum&quot;].ToString();
                    hdnStage.Value = row[&quot;Status&quot;].ToString();
                }

                if (hdnStage.Value != &quot;Draft&quot;)
                {
                    ViewMode();
                    txtNotes.Enabled = true;
                    //not allowing to add attacments for approved pay estimate  
                    if (hdnStage.Value == &quot;Approved&quot;)
                    {
                        peAttachments.ReadOnly = true;
                        MainToolBar.HideMenu(&quot;lnkSave&quot;);
                    }
                }
                //Load Current Postings 
                LoadPostingGrid(dsPE.Tables[1]);

                //Load Current Advances
                LoadAdvancesGrid(dsPE.Tables[2]);

                //Load Current Adjustments
                LoadAdjustmentsGrid(dsPE.Tables[3]);

                //Load Current Recoveries
                LoadRecoveryGrid(dsPE.Tables[4]);

                //Load Current Hold and Retention
                LoadHoldRetDetails(dsPE.Tables[5]);

                //Load the Recovery details
                DataSet ds = BL.Instance.GetPendingRecoveries(POID, PEID, ConvertDateForSPs(dtEndDate.Value));
                if (ds != null &amp;&amp; ds.Tables.Count &gt; 1)
                    hdnRecoveryDetailsJSON.Value = LoadRecoveryDetails(ds.Tables[1]);

                //RadScriptManager.RegisterStartupScript(Page, Page.GetType(), &quot;editLoad&quot;, &quot;$(document).ready(function() { debugger; showPane($(&#39;#tabWD&#39;));CalculateTotal();});&quot;, true);

            }
        }

        private void LoadCommitmentDetails()
        {
            //ProcurementCommitmentsDTO dto = ProcurementCommitments.Instance.GetCommiments(null, POType, POTypeInstanceID);
            ProcurementCommitmentsDTO dto = BL.Instance.GetCommiments(null, POType, POTypeInstanceID);
            lblContractor.Text = dto.VendorName;
            lblCommitment.Text = dto.PODescription;
            //dtEndDate.MaxDate = DateTime.UtcNow;
            POID = dto.POID;
        }

        private void LoadHoldAndRetainageDetails()
        {
            DataSet ds = BL.Instance.GetPreviousPEDetails(POID, PEID);
            if (ds != null &amp;&amp; ds.Tables.Count &gt; 1)
            {
                DataTable dt = ds.Tables[0];
                if (dt != null &amp;&amp; dt.Rows.Count == 1)
                {
                    decimal holdAmt = dt.Rows[0][&quot;HoldRetentionAmount&quot;].ToDecimal2();
                    decimal retAmt = dt.Rows[0][&quot;RetainageRetentionAmount&quot;].ToDecimal2();
                    hdnPrevHoldAmt.Value = holdAmt.ToString();
                    hdnPrevRetainageAmt.Value = retAmt.ToString();

                    spHoldTotal.InnerText = LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL) + &quot; &quot; +
                        holdAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                    spRetentionTotal.InnerText = LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL) + &quot; &quot; +
                       retAmt.ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
                }
                if (ds.Tables[1].Rows.Count == 1 &amp;&amp; Mode == &quot;New&quot;)
                {
                    dtFromDate.Value = ds.Tables[1].Rows[0][&quot;LastPEToDate&quot;].ToMWDateTime();
                    dtEndDate.Value = dtFromDate.Value;
                }
            }
        }

        protected void btnGen_Click(object sender, EventArgs e)
        {
            try
            { 
                hdnGenerateClicked.Value = &quot;false&quot;;

                if (dtFromDate.Value == null)
                    throw new Exception(&quot;From Date is mandatory.&quot;);

                if (dtEndDate.Value == null)
                    throw new Exception(&quot;To Date is mandatory.&quot;);

                DateTime dtFrm = Convert.ToDateTime(dtFromDate.Value);
                DateTime dtTo = Convert.ToDateTime(dtEndDate.Value);

                hdnTodate.Value = Convert.ToString(Convert.ToDateTime(dtEndDate.Value));

                if (dtFrm.Date &gt; dtTo.Date)
                    throw new Exception(&quot;To Date cannot be less than From Date&quot;);
                double amt = Convert.ToDouble(hdnPrevRetainageAmt.Value) + Convert.ToDouble(wneRetainagePercentage.Value);
                double ceilingValue = Convert.ToDouble(hdnRetentionCeilingValue.Value);
                if (amt &gt; ceilingValue)
                {

                }
                string deletedWDs = LoadAvailableWorkPostings();
                if (!string.IsNullOrEmpty(deletedWDs))
                    hdnDeletedPostingIds.Value = (string.IsNullOrEmpty(hdnDeletedPostingIds.Value)) ? deletedWDs : hdnDeletedPostingIds.Value + deletedWDs;

                string deletedAdvancePayments = LoadAvailableAdvances();
                if (!string.IsNullOrEmpty(deletedAdvancePayments))
                    hdnDeletedAdvancePayments.Value = (string.IsNullOrEmpty(hdnDeletedAdvancePayments.Value)) ? deletedAdvancePayments : hdnDeletedAdvancePayments.Value + deletedAdvancePayments;

                string recoveryDet = LoadAvailableRecoveries();
                hdnRecoveryDetailsJSON.Value = recoveryDet;

                hdnGenerateClicked.Value = &quot;true&quot;;
            }
            catch (Exception ex)
            {
                ScriptManager.RegisterStartupScript(this.Page, this.Page.GetType(), &quot;alert&quot;, &quot;ShowError(&#39;&quot; +
                                                                                 ex.Message.Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;) + &quot;&#39;);&quot;, true);

            }
        }

        private void LoadPostingGrid(DataTable dt)
        {
            grdWorkDone.DataSource = dt.ToMWDateTime();
            grdWorkDone.DataBind();

            // to fix XSS attack
            foreach (DataColumn col in dt.Columns)
            {
                (grdWorkDone.MasterTableView.GetColumnSafe(col.ColumnName) as GridBoundColumn).HtmlEncode = true;
            }

            double sum = 0;
            foreach (DataRow row in dt.Rows)
            {
                sum += row[&quot;Amount&quot;].ToDouble2();
            }
            hdnWorkDone.Value = sum.ToString();

            FormatWorkDoneGrid();
        }

        private void SetRetentionRules()
        {
            //Get Retension amount by selected retention rule using contractid or workorder id
            DataTable dt = CONTMGTPEBL.BL.Instance.GetRetentionPercent(POTypeInstanceID, POType);
            if (dt.Rows.Count &gt; 0)
            {
                if (Mode.Equals(&quot;New&quot;, StringComparison.CurrentCultureIgnoreCase))
                {
                    rbRetainagePercentage.Checked = true;
                    wneRetainagePercentage.Value = dt.Rows[0][&quot;RetentionValue&quot;];
                }
                hdnRetentionCeilingValue.Value = dt.Rows[0][&quot;RetentionCeilingvalue&quot;].ToString2();
                if (Convert.ToDouble(hdnPrevRetainageAmt.Value) &gt;= Convert.ToDouble(hdnRetentionCeilingValue.Value))
                {
                    wneRetainagePercentage.Value = wneRetainageAmount.Value = 0;
                    wneRetainagePercentage.Enabled = wneRetainageAmount.Enabled =
                    rbRetainageAmount.Enabled = rbRetainagePercentage.Enabled = false;
                }
                if (Convert.ToDouble(hdnPrevRetainageAmt.Value) == 0)
                {
                    wneRetainageReleasePercentage.Value = wneRetainageReleaseAmount.Value = 0;
                    wneRetainageReleasePercentage.Enabled = wneRetainageReleaseAmount.Enabled =
                    rbRetainageReleaseAmount.Enabled = rbRetainageReleasePercentage.Enabled = false;
                }
                if (Convert.ToDouble(hdnPrevHoldAmt.Value) == 0)
                {
                    wneHoldReleaseAmount.Value = wneHoldReleasePercentage.Value = 0;
                    wneHoldReleaseAmount.Enabled = wneHoldReleasePercentage.Enabled =
                    rbHoldReleaseAmount.Enabled = rbHoldReleasePercentage.Enabled = false;
                }
                //RadScriptManager.RegisterClientScriptBlock(Page, Page.GetType(), &quot;DefaultRetainageLoad&quot;, &quot;$(document).ready(function() { CalculateTotal();});&quot;, true);
            }

        }

        private void LoadAdvancesGrid(DataTable dt)
        {
            grdAdvances.DataSource = dt.ToMWDateTime();
            grdAdvances.DataBind();

            double sum = 0;
            foreach (DataRow row in dt.Rows)
            {
                sum += row[&quot;Amount&quot;].ToDouble2();
            }
            hdnTotalAdvancePaid.Value = sum.ToString();

            FormatAdvanceGrid();

        }

        private void LoadAdjustmentsGrid(DataTable dt)
        {
            grdAdjustments.DataSource = dt.ToMWDateTime();
            grdAdjustments.DataBind();

            double sum = 0;
            foreach (DataRow row in dt.Rows)
            {
                sum += row[&quot;Amount&quot;].ToDouble2();
            }
            hdnAdjustmentTotal.Value = sum.ToString();
            FormatAdjustmentGrid();

        }

        private void LoadRecoveryGrid(DataTable dt)
        {
            grdRecoveries.DataSource = dt.ToMWDateTime();
            grdRecoveries.DataBind();

            double sum = 0;
            foreach (DataRow row in dt.Rows)
            {
                sum += row[&quot;RecoveringAmount&quot;].ToDouble2();
            }
            hdnTotalRecovery.Value = sum.ToString();
            FormatRecoveryGrid();

        }

        private void LoadHoldRetDetails(DataTable dt)
        {
            DataRow[] holdDr = dt.Select(&quot;BucketType=&#39;Hold&#39;&quot;);
            if (holdDr.Length &gt; 0)
            {
                string holdType = holdDr[0][&quot;RetentionType&quot;].ToString();

                if (holdType == &quot;P&quot;)
                    rbHoldPercentage.Checked = true;
                else
                    rbHoldAmount.Checked = true;

                wneHoldPercentage.Value = holdDr[0][&quot;RetentionPercentage&quot;];
                wneHoldAmount.Value = holdDr[0][&quot;RetentionAmount&quot;];

                string holdRelType = holdDr[0][&quot;ReleaseType&quot;].ToString();

                if (holdRelType == &quot;P&quot;)
                    rbHoldReleasePercentage.Checked = true;
                else
                    rbHoldReleaseAmount.Checked = true;

                wneHoldReleasePercentage.Value = holdDr[0][&quot;ReleasePercentage&quot;];
                wneHoldReleaseAmount.Value = holdDr[0][&quot;ReleaseAmount&quot;];

                hdnHoldId.Value = holdDr[0][&quot;RetentionID&quot;].ToString();
            }

            DataRow[] retDr = dt.Select(&quot;BucketType=&#39;Retainage&#39;&quot;);
            if (retDr.Length &gt; 0)
            {
                string retType = retDr[0][&quot;RetentionType&quot;].ToString();

                if (retType == &quot;P&quot;)
                    rbRetainagePercentage.Checked = true;
                else
                    rbRetainageAmount.Checked = true;

                wneRetainagePercentage.Value = retDr[0][&quot;RetentionPercentage&quot;];
                wneRetainageAmount.Value = retDr[0][&quot;RetentionAmount&quot;];

                string holdRelType = retDr[0][&quot;ReleaseType&quot;].ToString();

                if (holdRelType == &quot;P&quot;)
                    rbRetainageReleasePercentage.Checked = true;
                else
                    rbRetainageReleaseAmount.Checked = true;

                wneRetainageReleasePercentage.Value = retDr[0][&quot;ReleasePercentage&quot;];
                wneRetainageReleaseAmount.Value = retDr[0][&quot;ReleaseAmount&quot;];

                hdnRetainageId.Value = retDr[0][&quot;RetentionID&quot;].ToString();
            }
        }

        private string LoadAvailableWorkPostings()
        {
            //get the from date , todate , poid 
            //get all the posting in this date range for this poid + all records where its not added in prev PE and parentid is not null 
            //get the DT and bind grdWorkDone grid

            //get all the previously added work postings so that it can be deleted while saving
            string deletedIds = string.Empty;

            foreach (var rowItem in grdWorkDone.Items)
            {
                if (rowItem is GridDataItem)
                {
                    GridDataItem item = rowItem as GridDataItem;
                    if (item[&quot;PEDetailsID&quot;].Text != null &amp;&amp; item[&quot;PEDetailsID&quot;].Text == &quot;0&quot;) continue;
                    else
                        deletedIds += item[&quot;PEDetailsID&quot;].Text + &quot;,&quot;;
                }

            }

            DataSet ds = BL.Instance.GetAvailablePostings(POID, ConvertDateForSPs(dtFromDate.Value), ConvertDateForSPs(dtEndDate.Value), PEID);
            if (ds.Tables.Count &gt; 0)
            {
                LoadPostingGrid(ds.Tables[0]);
            }

            return deletedIds.TrimEnd(&#39;,&#39;);
        }

        private DateTime ConvertDateForSPs(object dt)
        {
            // To Fix:: Bug 95347, taking only date part from  todate
            return ((DateTime)dt).Date.ToUtc();
        }

        private string LoadAvailableAdvances()
        {
            string deletedIds = string.Empty;

            foreach (var row in grdAdvances.Items)
            {
                if (row is GridDataItem)
                {
                    GridDataItem item = row as GridDataItem;
                    if (item[&quot;PEAdvanceID&quot;].Text != null &amp;&amp; item[&quot;PEAdvanceID&quot;].Text == &quot;0&quot;) continue;
                    else
                        deletedIds += item[&quot;PEAdvanceID&quot;].Text + &quot;,&quot;;

                }
            }

            //Get all adavances which are not added in the previous PE.
            DataTable dt = BL.Instance.GetUnbilledAdvance(POID, PEID, ConvertDateForSPs(dtEndDate.Value));
            LoadAdvancesGrid(dt);

            return deletedIds.TrimEnd(&#39;,&#39;);
        }

        private string LoadAvailableRecoveries()
        {
            string recoveryDet = string.Empty;
            //Get all the advances which are not completely recovered which are added to the prev PEs
            DataSet ds = BL.Instance.GetPendingRecoveries(POID, PEID, ConvertDateForSPs(dtEndDate.Value));
            if (ds != null &amp;&amp; ds.Tables.Count &gt; 0)
                LoadRecoveryGrid(ds.Tables[0]);
            if (ds != null &amp;&amp; ds.Tables.Count &gt; 1)
                recoveryDet = LoadRecoveryDetails(ds.Tables[1]);
            return recoveryDet;
        }

        private string LoadRecoveryDetails(DataTable dt)
        {
            JavaScriptSerializer serializer = new JavaScriptSerializer();
            List&lt;RecoveryDetails&gt; lstDetails = new List&lt;RecoveryDetails&gt;();

            foreach (DataRow row in dt.Rows)
            {
                RecoveryDetails det = new RecoveryDetails();
                det.AdvanceID = row[&quot;AdvanceID&quot;].ToInt32_2();
                det.WorkPostingID = row[&quot;WorkPostingID&quot;].ToInt32_2();
                det.ItemID = row[&quot;ItemID&quot;].ToInt32_2();
                det.Amount = row[&quot;Amount&quot;].ToDouble2();
                det.DetailID = row[&quot;DetailID&quot;].ToInt32_2();

                lstDetails.Add(det);
            }

            return serializer.Serialize(lstDetails);
        }

        protected void lnkSave_Click(object sender, EventArgs e)
        {
            WorkflowEnabledSaveHandler(true);
            if (hdnGenerateClicked.Value == &quot;true&quot;)
            {
                btnAddWorkDone.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
                btnDeleteWorkDone.Style.Add(HtmlTextWriterStyle.Display, &quot;block&quot;);
            }
        }

        protected void lnkCancel_Click(object sender, EventArgs e)
        {
            Response.Redirect(PostCancelRedirectUrl);
        }

        #region Formats and Schema

        private void GetGridSchema()
        {
            SetWorkDoneGridSchema();
            FormatWorkDoneGrid();

            SetAdvanceGridSchema();
            FormatAdvanceGrid();

            SetAdjustmentGridSchema();
            FormatAdjustmentGrid();

            SetRecoveryGridSchema();
            FormatRecoveryGrid();
        }

        private DataColumn[] GetColumnArray_ForWorkDoneGrid()
        {
            return new DataColumn[] {
                new DataColumn(&quot;PEDetailsID&quot;, typeof(int)),
                new DataColumn(&quot;WorkPostingID&quot;, typeof(int)),
                new DataColumn(&quot;WorkItemID&quot;, typeof(int)),
                new DataColumn(&quot;LineNo&quot;, typeof(int)),
                new DataColumn(&quot;StandardItemNo&quot;, typeof(string)),
                new DataColumn(&quot;Description&quot;, typeof(string)),
                new DataColumn(&quot;PostingDate&quot;, typeof(DateTime)),
                new DataColumn(&quot;AvailableQty&quot;, typeof(decimal)),
                new DataColumn(&quot;BillingQty&quot;, typeof(decimal)),
                new DataColumn(&quot;AvailableRate&quot;, typeof(decimal)),
                new DataColumn(&quot;BillingRate&quot;, typeof(decimal)),
                new DataColumn(&quot;Amount&quot;, typeof(decimal))
            };
        }

        private void SetWorkDoneGridSchema()
        {
            DataTable dtWD = new DataTable();
            dtWD.Columns.AddRange(GetColumnArray_ForWorkDoneGrid());
            grdWorkDone.DataSource = dtWD;
            grdWorkDone.DataBind();

        }

        private void FormatWorkDoneGrid()
        {
            GridTableView cols = grdWorkDone.MasterTableView;
            addReadonlyProp(cols, new List&lt;string&gt;() { &quot;PEDetailsID&quot;, &quot;WorkPostingID&quot;, &quot;WorkItemID&quot;, &quot;LineNo&quot;, &quot;StandardItemNo&quot;, &quot;Description&quot;, &quot;PostingDate&quot;, &quot;AvailableQty&quot;, &quot;BillingQty&quot;, &quot;AvailableRate&quot;, &quot;BillingRate&quot;, &quot;Amount&quot; });
            //Hiding all the unwanted columns
            HideColumns(cols, new List&lt;string&gt;() { &quot;PEDetailsID&quot;, &quot;WorkPostingID&quot;, &quot;WorkItemID&quot;, (AllowPartRate ? &quot;&quot; : &quot;BillingRate&quot;), (AllowPartQuantity ? &quot;&quot; : &quot;BillingQty&quot;), &quot;Context&quot; });
            FormatQuantityCols(cols, new List&lt;string&gt;() { &quot;AvailableQty&quot;, &quot;BillingQty&quot; });
            FormatUnitPriceCols(cols, new List&lt;string&gt;() { &quot;AvailableRate&quot;, &quot;BillingRate&quot; });
            FormatDateCols(cols, new List&lt;string&gt;() { &quot;PostingDate&quot; });
            FormatAmountCols(cols, new List&lt;string&gt;() { &quot;Amount&quot; });
            Dictionary&lt;string, string[]&gt; renameCols = new Dictionary&lt;string, string[]&gt;();
            renameCols.Add(&quot;LineNo&quot;, new string[] { &quot;Line No&quot;, &quot;50px&quot; });
            renameCols.Add(&quot;StandardItemNo&quot;, new string[] { LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO), &quot;100px&quot; });
            renameCols.Add(&quot;PostingDate&quot;, new string[] { &quot;Posting Date&quot;, &quot;80px&quot; });
            renameCols.Add(&quot;Description&quot;, new string[] { &quot;Description&quot;, &quot;300px&quot; });
            renameCols.Add(&quot;AvailableQty&quot;, new string[] { (AllowPartQuantity ? &quot;Available Qty&quot; : &quot;Quantity&quot;), &quot;80px&quot; });
            renameCols.Add(&quot;BillingQty&quot;, new string[] { &quot;Billing Qty&quot;, &quot;80px&quot; });
            renameCols.Add(&quot;AvailableRate&quot;, new string[] { (AllowPartRate ? &quot;Available &quot; : &quot;&quot;) + &quot;Rate in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL), &quot;85px&quot; });
            renameCols.Add(&quot;BillingRate&quot;, new string[] { &quot;Billing Rate in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL), &quot;80px&quot; });
            renameCols.Add(&quot;Amount&quot;, new string[] { &quot;Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL), &quot;80px&quot; });

            RenameColumns(cols, renameCols);
            AddFooter(grdWorkDone, &quot;Amount&quot;, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);

            grdWorkDone.AllowAutomaticInserts = true; // AllowAddNew.Yes.ToBoolean();
            grdWorkDone.AllowAutomaticDeletes = true;//AllowDelete.Yes;

        }

        private DataColumn[] GetColumnArray_ForAdvanceGrid()
        {
            return new DataColumn[] {
                new DataColumn(&quot;PEAdvanceID&quot;, typeof(int)),
                new DataColumn(&quot;PEID&quot;, typeof(int)),
                new DataColumn(&quot;AdvanceTypeID&quot;, typeof(int)),
                new DataColumn(&quot;AdvanceDescription&quot;, typeof(string)),
                new DataColumn(&quot;AdvanceTypeDesc&quot;, typeof(string)),
                new DataColumn(&quot;AdvanceDate&quot;, typeof(DateTime)),
                new DataColumn(&quot;Amount&quot;, typeof(decimal))
             };
        }

        private void SetAdvanceGridSchema()
        {
            DataTable dtA = new DataTable();
            dtA.Columns.AddRange(GetColumnArray_ForAdvanceGrid());

            grdAdvances.DataSource = dtA;
            grdAdvances.DataBind();
        }

        private void FormatAdvanceGrid()
        {
            GridTableView tbl = grdAdvances.MasterTableView;
            addReadonlyProp(tbl, new List&lt;string&gt;() { &quot;PEAdvanceID&quot;, &quot;PEID&quot;, &quot;AdvanceTypeID&quot;, &quot;AdvanceDescription&quot;, &quot;AdvanceTypeDesc&quot;, &quot;AdvanceDate&quot;, &quot;Amount&quot; });
            HideColumns(tbl, new List&lt;string&gt;() { &quot;PEAdvanceID&quot;, &quot;PEID&quot;, &quot;AdvanceTypeID&quot; });
            FormatDateCols(tbl, new List&lt;string&gt;() { &quot;AdvanceDate&quot; });
            FormatAmountCols(tbl, new List&lt;string&gt;() { &quot;Amount&quot; });

            Dictionary&lt;string, string[]&gt; renameCols = new Dictionary&lt;string, string[]&gt;();
            renameCols.Add(&quot;AdvanceDescription&quot;, new string[] { &quot;Description&quot;, &quot;120px&quot; });
            renameCols.Add(&quot;AdvanceTypeDesc&quot;, new string[] { &quot;Type&quot;, &quot;120px&quot; });
            renameCols.Add(&quot;AdvanceDate&quot;, new string[] { &quot;Date&quot;, &quot;80px&quot; });
            renameCols.Add(&quot;Amount&quot;, new string[] { &quot;Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL), &quot;100px&quot; });

            RenameColumns(tbl, renameCols);

            AddFooter(grdAdvances, &quot;Amount&quot;, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
        }

        private DataColumn[] GetColumnArray_ForAdjustmentGrid()
        {
            return new DataColumn[] {
                new DataColumn(&quot;AdjustmentID&quot;, typeof(int)),
                new DataColumn(&quot;AdjustmentDescription&quot;, typeof(string)),
                new DataColumn(&quot;AdjustmentNotes&quot;, typeof(string)),
                new DataColumn(&quot;Amount&quot;, typeof(decimal)),
             };
        }

        private void SetAdjustmentGridSchema()
        {
            DataTable dtA = new DataTable();
            dtA.Columns.AddRange(GetColumnArray_ForAdjustmentGrid());

            grdAdjustments.DataSource = dtA;
            grdAdjustments.DataBind();
            // to fix xss attack
            foreach (DataColumn col in dtA.Columns)
            {
                (grdAdjustments.MasterTableView.GetColumnSafe(col.ColumnName) as GridBoundColumn).HtmlEncode = true;
            }

        }

        private void FormatAdjustmentGrid()
        {
            GridTableView cols = grdAdjustments.MasterTableView;
            addReadonlyProp(cols, new List&lt;string&gt;() { &quot;AdjustmentID&quot;, &quot;AdjustmentDescription&quot;, &quot;AdjustmentNotes&quot;, &quot;Amount&quot; });//
            HideColumns(cols, new List&lt;string&gt;() { &quot;AdjustmentID&quot;, &quot;PEID&quot; });
            FormatAmountCols(cols, new List&lt;string&gt;() { &quot;Amount&quot; });
            // Enable edit only when it is not in view and latest pay estimate and either in draft - in case if edit or new where hdnStage is empty
            if (!Mode.Equals(&quot;View&quot;, StringComparison.CurrentCultureIgnoreCase) &amp;&amp; IsLatestPE &amp;&amp; (String.IsNullOrEmpty(hdnStage.Value) || hdnStage.Value.Equals(&quot;Draft&quot;, StringComparison.CurrentCultureIgnoreCase)))
            {
                grdAdjustments.MasterTableView.GetColumnSafe(&quot;Amount&quot;).ItemStyle.BackColor = Color.Yellow;
                grdAdjustments.MasterTableView.GetColumnSafe(&quot;AdjustmentNotes&quot;).ItemStyle.BackColor = Color.Yellow;
                removeReadonlyProp(cols, new List&lt;string&gt;() { &quot;AdjustmentNotes&quot;, &quot;Amount&quot; });
            }

            Dictionary&lt;string, string[]&gt; renameCols = new Dictionary&lt;string, string[]&gt;();
            renameCols.Add(&quot;AdjustmentDescription&quot;, new string[] { &quot;Adjustment&quot;, &quot;150px&quot; });
            renameCols.Add(&quot;AdjustmentNotes&quot;, new string[] { &quot;Description&quot;, &quot;150px&quot; });
            renameCols.Add(&quot;Amount&quot;, new string[] { &quot;Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL), &quot;100px&quot; });

            RenameColumns(cols, renameCols);

            AddFooter(grdAdjustments, &quot;Amount&quot;, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);

            grdAdjustments.AllowAutomaticInserts = AllowAddNew.Yes.ToBoolean2();
            grdAdjustments.AllowAutomaticDeletes = AllowDelete.Yes.ToBoolean2();
        }

        private void SetRecoveryGridSchema()
        {
            DataTable dtAR = new DataTable();
            dtAR.Columns.AddRange(new DataColumn[] {
                new DataColumn(&quot;RecoveryID&quot;, typeof(int)),
                new DataColumn(&quot;PEAdvanceID&quot;, typeof(int)),
                new DataColumn(&quot;AdvanceDescription&quot;, typeof(string)),
                new DataColumn(&quot;AdvanceTypeDesc&quot;, typeof(string)),
                new DataColumn(&quot;AdvanceDate&quot;, typeof(DateTime)),
                new DataColumn(&quot;TotalAmount&quot;, typeof(decimal)),
                new DataColumn(&quot;RecoveredTillDate&quot;, typeof(decimal)),
                new DataColumn(&quot;RemainingAmount&quot;, typeof(decimal)),
                new DataColumn(&quot;RecoveringAmount&quot;, typeof(decimal)),
            });

            grdRecoveries.DataSource = dtAR;
            grdRecoveries.DataBind();

            // to fix XSS attack
            foreach (DataColumn col in dtAR.Columns)
            {
                (grdRecoveries.MasterTableView.GetColumnSafe(col.ColumnName) as GridBoundColumn).HtmlEncode = true;
            }
        }

        private void FormatRecoveryGrid()
        {
            // to fix XSS attack
            foreach (DataColumn col in (grdRecoveries.DataSource as DataTable).Columns)
            {
                (grdRecoveries.MasterTableView.GetColumnSafe(col.ColumnName) as GridBoundColumn).HtmlEncode = true;
            }

            GridTableView tbl = grdRecoveries.MasterTableView;
            addReadonlyProp(tbl, new List&lt;string&gt;() { &quot;RecoveryID&quot;, &quot;PEAdvanceID&quot;, &quot;AdvanceType&quot;, &quot;AdvanceDescription&quot;, &quot;AdvanceTypeDesc&quot;, &quot;AdvanceDate&quot;, &quot;TotalAmount&quot;, &quot;RecoveredTillDate&quot;, &quot;RemainingAmount&quot;, &quot;RecoveringAmount&quot; });
            HideColumns(tbl, new List&lt;string&gt;() { &quot;RecoveryID&quot;, &quot;PEAdvanceID&quot;, &quot;AdvanceType&quot; });
            FormatDateCols(tbl, new List&lt;string&gt;() { &quot;AdvanceDate&quot; });
            FormatAmountCols(tbl, new List&lt;string&gt;() { &quot;TotalAmount&quot;, &quot;RecoveredTillDate&quot;, &quot;RemainingAmount&quot;, &quot;RecoveringAmount&quot; });
            if (!Mode.Equals(&quot;View&quot;, StringComparison.CurrentCultureIgnoreCase) &amp;&amp; IsLatestPE &amp;&amp; (String.IsNullOrEmpty(hdnStage.Value) || hdnStage.Value.Equals(&quot;Draft&quot;, StringComparison.CurrentCultureIgnoreCase)))
            {
                GridColumn col = tbl.GetColumnSafe(&quot;RecoveringAmount&quot;);
                //grdRecoveries.Columns.FromKey(&quot;RecoveringAmount&quot;).AllowUpdate = AllowUpdate.Yes;
                if (col != null &amp;&amp; col is GridBoundColumn)
                {
                    //    col.ItemStyle.BackColor = Color.Yellow;
                    (col as GridBoundColumn).ReadOnly = false;
                }
            }

            Dictionary&lt;string, string[]&gt; renameCols = new Dictionary&lt;string, string[]&gt;();
            renameCols.Add(&quot;AdvanceDescription&quot;, new string[] { &quot;Description&quot; });
            renameCols.Add(&quot;AdvanceTypeDesc&quot;, new string[] { &quot;Type&quot; });
            renameCols.Add(&quot;AdvanceDate&quot;, new string[] { &quot;Date&quot; });
            renameCols.Add(&quot;TotalAmount&quot;, new string[] { &quot;Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL) });
            renameCols.Add(&quot;RecoveredTillDate&quot;, new string[] { &quot;Recovered Till Date in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL) + &quot;&quot;, &quot;135px&quot; });
            renameCols.Add(&quot;RemainingAmount&quot;, new string[] { &quot;Remaining Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL), &quot;135px&quot; });
            renameCols.Add(&quot;RecoveringAmount&quot;, new string[] { &quot;Recover In This &quot; + LocalizationManager.GetString(KeyConstants.LOC_BILL) + &quot; in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL) + &quot;&quot;, &quot;160px&quot; });

            RenameColumns(tbl, renameCols);

            AddFooter(grdRecoveries, &quot;RecoveringAmount&quot;, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);

            grdRecoveries.AllowAutomaticInserts = AllowAddNew.Yes.ToBoolean2();
            grdRecoveries.AllowAutomaticDeletes = AllowDelete.Yes.ToBoolean2();

            // Enable edit only when it is not in view and latest pay estimate and either in draft - in case if edit or new where hdnStage is empty
        }

        private void HideColumns(GridTableView cols, List&lt;string&gt; colsToBeHidden)
        {
            foreach (string col in colsToBeHidden)
                if (!string.IsNullOrEmpty(col) &amp;&amp; cols.GetColumnSafe(col) != null)
                    cols.GetColumnSafe(col).Display = false;
        }

        private void FormatQuantityCols(GridTableView cols, List&lt;string&gt; colsToBeFormated)
        {
            foreach (string col in colsToBeFormated)
            {
                var item = cols.GetColumnSafe(col);
                item.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                if (item != null &amp;&amp; item is GridNumericColumn)
                {
                    (item as GridNumericColumn).DataFormatString = &quot;{0:&quot; + AMP3ApplicationSettings.Instance.FORMAT_QUANTITY + &quot;}&quot;;
                }
            }
        }

        private void FormatUnitPriceCols(GridTableView cols, List&lt;string&gt; colsToBeFormated)
        {
            foreach (string col in colsToBeFormated)
            {
                var item = cols.GetColumnSafe(col);
                item.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                if (item != null &amp;&amp; item is GridNumericColumn)
                {
                    (item as GridNumericColumn).DataFormatString = &quot;{0:&quot; + AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE + &quot;}&quot;;
                }
            }
        }

        private void FormatAmountCols(GridTableView cols, List&lt;string&gt; colsToBeFormated)
        {
            foreach (string col in colsToBeFormated)
            {
                var item = cols.GetColumnSafe(col);
                item.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                if (item != null &amp;&amp; item is GridNumericColumn)
                {
                    (item as GridNumericColumn).DataFormatString = &quot;{0:&quot; + AMP3ApplicationSettings.Instance.FORMAT_AMOUNT + &quot;}&quot;;
                }
            }
        }

        private void FormatDateCols(GridTableView cols, List&lt;string&gt; colsToBeFormated)
        {
            foreach (string col in colsToBeFormated)
            {
                var item = cols.GetColumnSafe(col);
                if (item != null &amp;&amp; item is GridDateTimeColumn)
                {
                    (item as GridDateTimeColumn).DataFormatString = &quot;{0:&quot; + AMP3ApplicationSettings.Instance.FORMAT_DATE + &quot;}&quot;;
                }
            }
        }

        private void RenameColumns(GridTableView cols, Dictionary&lt;string, string[]&gt; colsToBeRenamed)
        {
            foreach (KeyValuePair&lt;string, string[]&gt; kvp in colsToBeRenamed)
            {
                if (cols.GetColumnSafe(kvp.Key) != null)
                {
                    cols.GetColumnSafe(kvp.Key).HeaderText = kvp.Value[0];
                    if (kvp.Value.Length &gt; 1) cols.GetColumnSafe(kvp.Key).HeaderStyle.Width = new Unit(kvp.Value[1]);
                }
                cols.Rebind();
            }
        }

        private void addReadonlyProp(GridTableView grid, List&lt;string&gt; columnlist)
        {
            foreach (string col in columnlist)
            {
                var column = grid.GetColumnSafe(col);
                if (column != null &amp;&amp; column is GridBoundColumn)
                {
                    (column as GridBoundColumn).ReadOnly = true;
                }
            }
        }

        private void removeReadonlyProp(GridTableView grid, List&lt;string&gt; columnlist)
        {
            foreach (string col in columnlist)
            {
                var column = grid.GetColumnSafe(col);
                if (column != null &amp;&amp; column is GridBoundColumn)
                {
                    (column as GridBoundColumn).ReadOnly = false;
                }
            }
        }
        private void AddFooter(RadGrid grid, string column, string format)
        {
            grid.ShowFooter = ShowMarginInfo.Yes.ToBoolean2();
            var item = grid.MasterTableView.GetItems(GridItemType.Footer)[0];
            if (item != null)
            {
                GridFooterItem footer = item as GridFooterItem;
                if (footer[column] != null)
                {
                    //footer[column].Text = &quot;0&quot;;//SummaryInfo.Sum;
                    grid.MasterTableView.GetColumnSafe(column).ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                    grid.MasterTableView.GetColumnSafe(column).HeaderStyle.HorizontalAlign = HorizontalAlign.Right;
                    grid.MasterTableView.GetColumnSafe(column).FooterStyle.HorizontalAlign = HorizontalAlign.Right;
                }
            }
        }


        #endregion

        #region Pickers

        #region Adjustment Picker

        private void InitializeAdjustmentsPicker()
        {
            pickerAdjustments.InitializePicker(&quot;/api/Adjustments&quot;, GetAdjustmentGridColumns(), &quot;AdjustmentID&quot;);
            pickerAdjustments.TriggerButton.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            pickerAdjustments.EnableMultiSelect = true;
            pickerAdjustments.BeforePickerLoadScript = &quot;FilterAddedAdjustment(&#39;&quot; + grdAdjustments.ClientID + &quot;&#39;)&quot;;
            pickerAdjustments.AfterPickerSelectScript = &quot;ConsumeSelectedAdjustments({0},&#39;&quot; + grdAdjustments.ClientID + &quot;&#39;)&quot;;
            pickerAdjustments.Title = &quot;Adjustments List&quot;;
            btnAddAdjustment.OnClientClick = &quot;return OpenPicker(&#39;&quot; + pickerAdjustments.TriggerButton.ClientID + &quot;&#39;);&quot;;
        }

        private List&lt;PickerColumnDetails&gt; GetAdjustmentGridColumns()
        {
            List&lt;PickerColumnDetails&gt; gridColumns = new List&lt;PickerColumnDetails&gt;();
            List&lt;string&gt; allColumns = new List&lt;string&gt;() { &quot;AdjustmentID&quot;, &quot;AdjustmentDescription&quot; };
            Dictionary&lt;string, string&gt; visibleColumns = new Dictionary&lt;string, string&gt;();
            visibleColumns.Add(&quot;AdjustmentID&quot;, &quot;Adjustment&quot;);
            visibleColumns.Add(&quot;AdjustmentDescription&quot;, &quot;Description&quot;);
            foreach (string col in allColumns)
            {
                if (!visibleColumns.ContainsKey(col))
                {
                    PickerColumnDetails tCol = new PickerColumnDetails { Caption = col, ColumnName = col, Hidden = true, Type = &quot;number&quot;, Width = 0 };
                    gridColumns.Add(tCol);
                }
                else
                {
                    PickerColumnDetails tCol = new PickerColumnDetails { Caption = visibleColumns[col], ColumnName = col, Hidden = false, Width = 240, Type = &quot;string&quot; };
                    gridColumns.Add(tCol);
                }
            }

            return gridColumns;
        }

        #endregion

        #region workdonePicker

        private void InitializeWorkDonePicker()
        {
            pickerWorkDone.InitializePicker(&quot;/api/WorkDone&quot;, GetWorkDoneGridColumns(), &quot;WorkPostingID&quot;);
            pickerWorkDone.TriggerButton.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            pickerWorkDone.EnableMultiSelect = true;
            string json = &quot;{}&quot;;
            pickerWorkDone.OptionalParamaters = pickerWorkDone.BuildOptionalParameters(json);
            pickerWorkDone.BeforePickerLoadScript = &quot;FilterAddedWorkDone(&#39;&quot; + grdWorkDone.ClientID + &quot;&#39;)&quot;;
            pickerWorkDone.AfterPickerSelectScript = &quot;ConsumeSelectedWorkDone({0},&#39;&quot; + grdWorkDone.ClientID + &quot;&#39;)&quot;;
            pickerWorkDone.OnGridLoad += new PickerGrid.GridLoad(pickerWorkDone_OnGridLoad);
            pickerWorkDone.Title = &quot;Workdone List&quot;;
            btnAddWorkDone.OnClientClick = &quot;return OpenPicker(&#39;&quot; + pickerWorkDone.TriggerButton.ClientID + &quot;&#39;);&quot;;
        }

        void pickerWorkDone_OnGridLoad(PickerGrid grid)
        {
            string json = &quot;{&quot;;
            json += &quot;\&quot;POID\&quot;:\&quot;&quot; + POID + &quot;\&quot;,&quot;;
            json += &quot;\&quot;dtFrom\&quot;:\&quot;&quot; + dtFromDate.Value.ToMWDateTimeString_FormatDateTime() + &quot;\&quot;,&quot;;
            json += &quot;\&quot;dtTo\&quot;:\&quot;&quot; + dtEndDate.Value.ToMWDateTimeString_FormatDateTime() + &quot;\&quot;,&quot;;
            json += &quot;\&quot;PEID\&quot;:\&quot;&quot; + PEID + &quot;\&quot;}&quot;;
            pickerWorkDone.OptionalParamaters = pickerWorkDone.BuildOptionalParameters(json);
        }


        private List&lt;PickerColumnDetails&gt; GetWorkDoneGridColumns()
        {
            List&lt;PickerColumnDetails&gt; gridColumns = new List&lt;PickerColumnDetails&gt;();
            List&lt;string&gt; allColumns = new List&lt;string&gt;() {&quot;PEDetailsID&quot;,&quot;WorkPostingID&quot;,&quot;WorkItemID&quot;,&quot;LineNo&quot;, &quot;StandardItemNo&quot;, &quot;Description&quot;, &quot;PostingDate&quot; ,&quot;AvailableQty&quot;, &quot;BillingQty&quot;, &quot;AvailableRate&quot;,
                &quot;BillingRate&quot;,&quot;Amount&quot;};
            Dictionary&lt;string, string&gt; visibleColumns = new Dictionary&lt;string, string&gt;();
            visibleColumns.Add(&quot;LineNo&quot;, &quot;Line No&quot;);
            visibleColumns.Add(&quot;StandardItemNo&quot;, LocalizationManager.GetString(KeyConstants.LOC_PAY_ITEM_NO));
            visibleColumns.Add(&quot;Description&quot;, &quot;Description&quot;);
            visibleColumns.Add(&quot;PostingDate&quot;, &quot;Posting Date&quot;);
            visibleColumns.Add(&quot;AvailableQty&quot;, &quot;Available Qty&quot;);
            if (AllowPartRate) visibleColumns.Add(&quot;BillingQty&quot;, &quot;Billing Qty&quot;);
            visibleColumns.Add(&quot;AvailableRate&quot;, &quot;Available Rate in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL));
            if (AllowPartRate) visibleColumns.Add(&quot;BillingRate&quot;, &quot;Billing Rate in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL));
            visibleColumns.Add(&quot;Amount&quot;, &quot;Amount in &quot; + LocalizationManager.GetString(KeyConstants.LOC_CURRENCY_DOL));

            List&lt;string&gt; qtyColumns = new List&lt;string&gt;() { &quot;AvailableQty&quot;, &quot;BillingQty&quot; };
            List&lt;string&gt; rateColumns = new List&lt;string&gt;() { &quot;AvailableRate&quot;, &quot;BillingRate&quot; };
            List&lt;string&gt; amtColumns = new List&lt;string&gt;() { &quot;Amount&quot; };
            List&lt;string&gt; dateColumns = new List&lt;string&gt;() { &quot;PostingDate&quot; };
            List&lt;string&gt; numberColumns = new List&lt;string&gt;() { &quot;LineNo&quot; };

            foreach (string col in allColumns)
            {
                if (!visibleColumns.ContainsKey(col))
                {
                    PickerColumnDetails tCol = new PickerColumnDetails { Caption = col, ColumnName = col, Hidden = true };
                    gridColumns.Add(tCol);
                }
                else
                {
                    PickerColumnDetails tCol = new PickerColumnDetails { Caption = visibleColumns[col], ColumnName = col, Hidden = false, Width = 100, Type = &quot;string&quot; };
                    if (qtyColumns.Contains(col))
                    {
                        tCol.Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                        tCol.Type = &quot;number&quot;;
                    }
                    else if (rateColumns.Contains(col))
                    {
                        tCol.Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                        tCol.Type = &quot;number&quot;;
                        tCol.Width = 110;
                    }
                    else if (amtColumns.Contains(col))
                    {
                        tCol.Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;
                        tCol.Type = &quot;number&quot;;
                    }
                    else if (dateColumns.Contains(col))
                    {
                        tCol.Format = AMP3ApplicationSettings.Instance.FORMAT_DATE;
                        tCol.Type = &quot;date&quot;;
                    }
                    else if (numberColumns.Contains(col))
                    {
                        tCol.Type = &quot;number&quot;;
                    }
                    gridColumns.Add(tCol);
                }
            }

            return gridColumns;
        }

        protected void grdWorkDone_ItemDataBound(object sender, GridItemEventArgs e)
        {
            double sum = 0;
            if (e.Item is GridDataItem)
            {
                GridDataItem item = e.Item as GridDataItem;
                //item.Edit = false;
                //sum += double.Parse((item[&quot;Amount&quot;] as TextBox).Text);
                //item.OwnerTableView.Name
            }
            else if (e.Item is GridFooterItem)
            {
                GridFooterItem footer = (GridFooterItem)e.Item;
                footer[&quot;Amount&quot;].Text = hdnWorkDone.Value;
            }
        }
        protected void grdWorkDone_UpdateCommand(object sender, GridCommandEventArgs e)
        {
            GridEditableItem editItem = e.Item as GridEditableItem;
            Hashtable newValues = new Hashtable();
            e.Item.OwnerTableView.ExtractValuesFromItem(newValues, editItem);
            //string id = newValues[&quot;UniqueName&quot;].ToString();
        }

        protected void grdAdvances_ItemDataBound(object sender, GridItemEventArgs e)
        {
            double sum = 0;
            if (e.Item is GridDataItem)
            {
                GridDataItem item = e.Item as GridDataItem;
                item.Edit = false;
                //sum += double.Parse((item[&quot;Amount&quot;] as TextBox).Text);
                //item.OwnerTableView.Name
            }
            else if (e.Item is GridFooterItem)
            {
                GridFooterItem footer = (GridFooterItem)e.Item;
                footer[&quot;Amount&quot;].Text = string.IsNullOrEmpty(hdnTotalAdvancePaid.Value) ? &quot;&quot; : (hdnTotalAdvancePaid.Value.ToDecimal2()).ToString(AMP3ApplicationSettings.Instance.FORMAT_AMOUNT);
            }
        }
        protected void grdRecoveries_ItemDataBound(object sender, GridItemEventArgs e)
        {
            double sum = 0;
            
            if (e.Item is GridDataItem)
            {
                GridDataItem item = e.Item as GridDataItem;
                if(item[&quot;AdvanceType&quot;].Text != null &amp;&amp; item[&quot;AdvanceType&quot;].Text.ToUpper() == &quot;MONHAND&quot;)
                {
                    item.Attributes.Add(&quot;isMOH&quot;, &quot;1&quot;);
                }
                else
                {
                    item.Attributes.Add(&quot;isMOH&quot;, &quot;0&quot;);
                    item[&quot;RecoveringAmount&quot;].Style[&quot;background-color&quot;] = &quot;yellow&quot;;
                }
            }
            else if (e.Item is GridFooterItem)
            {
                GridFooterItem footer = (GridFooterItem)e.Item;
                footer[&quot;RecoveringAmount&quot;].Text = hdnTotalRecovery.Value;
            }
        }
        protected void grdAdjustments_ItemDataBound(object sender, GridItemEventArgs e)
        {
            if (e.Item is GridDataItem)
            {
                GridDataItem item = e.Item as GridDataItem;
                //item.OwnerTableView.Name
            }
            if (e.Item is GridFooterItem)
            {
                GridFooterItem footerItem = e.Item as GridFooterItem;
                footerItem[&quot;Amount&quot;].Text = hdnAdjustmentTotal.Value;
                //if(footerItem[&quot;Amount&quot;] != null) footerItem[&quot;Amount&quot;].Text = &quot;total: &quot; + SummaryInfo.Sum.ToString2();
            }
        }
        protected void grdAdjustments_BatchEditCommand(object sender, GridBatchEditingEventArgs e)
        {
            var eee = e.Item;
            foreach (GridBatchEditingCommand command in e.Commands)
            {
            }
        }
        protected void grdRecoveries_BatchEditCommand(object sender, GridBatchEditingEventArgs e)
        {
            var eee = e.Item;
            foreach (GridBatchEditingCommand command in e.Commands)
            {
            }
        }

        protected void grdWorkDone_ItemCommand(object source, GridCommandEventArgs e)
        {
            if (e.CommandName == RadGrid.InitInsertCommandName)
            {

            }
        }

        protected void grdWorkDone_ItemCreated(object sender, GridItemEventArgs e)
        {
            //foreach(var item in e.Item) {
            if (e.Item is GridDataItem)
            {
                var row = e.Item as GridDataItem;
            }
        }


        #endregion

        #endregion

        public void CancelHandler(object sender, bool bAfterSave, out string sRedirectTo)
        {
            sRedirectTo = string.Empty;
        }

        private string payEstimatimateClientValidation = &quot;ValidateSave();&quot;;
        public string ClientValidationFunction
        {
            get { return payEstimatimateClientValidation; }
        }

        public string FormInstanceId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;PEID&quot;])
                                ? -1
                                : int.TryParse(Request.QueryString[&quot;PEID&quot;], out id) ? id : -1;
                return id.ToString();
            }
        }

        public string FormKeyWONO
        {
            get
            {

                //return (!string.IsNullOrEmpty(Request.QueryString[&quot;POType&quot;]) &amp;&amp; Request.QueryString[&quot;POType&quot;] == &quot;WORKORD&quot;) ? Convert.ToString(ComponentHelper.Instance.ExecuteScalar(
                //          &quot;select WorkOrderNo from WORKORDMain where WorkOrderID = &#39;&quot; + Request.QueryString[&quot;POTypeInstanceID&quot;] + &quot;&#39;&quot;)) : string.Empty;
                return (!string.IsNullOrEmpty(Request.QueryString[&quot;POType&quot;]) &amp;&amp; Request.QueryString[&quot;POType&quot;] == &quot;WORKORD&quot;) ? Convert.ToString(ComponentHelper.Instance.ExecuteScalar(
               WOStoredProcedure.usp_WORKORDGetWorkOrderNoOfWorkOrder, null, Request.QueryString[&quot;POTypeInstanceID&quot;])) : string.Empty;

            }
        }


        public string FormKey
        {
            get
            {
                return string.Format(&quot;{0} Number: {1}&quot; + (String.IsNullOrEmpty(FormKeyWONO) ? &quot;&quot; : &quot;,WorkOrder No:&quot; + FormKeyWONO), LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE), lblPayEstimateNo.Text);
            }
        }

        public string FormName
        {
            get { return &quot;XPRCMGT&quot;; }
        }

        public bool IsOldWorkflow
        {
            get { return false; }
        }

        public int PID
        {
            get { return Request.QueryString[&quot;PID&quot;].ToInt32_2(); }
        }

        public int ParentModuleId
        {
            get
            {
                int id = String.IsNullOrEmpty(Request.QueryString[&quot;ContractID&quot;])
                          ? -1
                          : int.TryParse(Request.QueryString[&quot;ContractID&quot;], out id) ? id : -1;
                return id;
            }
        }

        public string PostCancelRedirectUrl
        {
            get
            {
                return string.Format(&quot;~/Common/BrixListPage.aspx?Context=PROCMGT&amp;PID={0}&amp;ContractID={1}&amp;ParentID={1}&amp;POType={2}&amp;POTypeInstanceID={3}&quot;
                    , Request.QueryString[&quot;PID&quot;], Request.QueryString[&quot;ContractID&quot;], Request.QueryString[&quot;POType&quot;], Request.QueryString[&quot;POTypeInstanceID&quot;]);
            }
        }

        public string PostSaveRedirectUrl(string sSavedToken = &quot;&quot;)
        {
            return PostCancelRedirectUrl;
        }

        string ErrLocalized(string strErr)
        {
            if (strErr.Contains(&quot;LOC_ITEM_ABBR&quot;))
                strErr = strErr.Replace(&quot;LOC_ITEM_ABBR&quot;, LocalizationManager.GetString(&quot;LOC_ITEM_ABBR&quot;));
            return strErr;
        }

        
        /// &lt;summary&gt;
        /// Validates the Settings: Where payment cannot be made for excess qty if settings are defined.
        /// return true if valid else false
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;isNewRecord&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;availableQtyTotal&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;currentBillintQtyTotal&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;errorMessage&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;true if data is valid&lt;/returns&gt;
        private bool TryValidate_PayEstimateQtyRule(bool isNewRecord, Tuple&lt;int, string, decimal&gt;[] workItemIdAndIdentifierTupleAndQty_TupleArray, out string errorMessage)
        {
            bool isValid = false;
            errorMessage = string.Empty;

            int contractID = Request[&quot;ContractID&quot;].ToInt32_2();
            DataTable dtSettings = BL.Instance.GetPEBasicSettings(contractID, Constants.MODID_CONTMGT);

            bool allowPayEstimateQtyBeyondContractQty = false;
            decimal excessQtyPercentage = 0;
            if (dtSettings.Rows.Count == 0)
            {
                //by default allow : Allow Pay Estimate Quantity greater than Contract Quantity 
                allowPayEstimateQtyBeyondContractQty = false;
            }
            else
            {
                allowPayEstimateQtyBeyondContractQty = dtSettings.Rows[0][&quot;ValidateRABContractQty&quot;].ToBoolean2();
                if (allowPayEstimateQtyBeyondContractQty)
                    excessQtyPercentage = dtSettings.Rows[0][&quot;ExcessPayAmtPercentage&quot;].ToDecimal2();
            }

            //if (!allowPayEstimateQtyBeyondContractQty)
            //    isValid = true;
            //else
            //{
            List&lt;int&gt; workItemIdList = workItemIdAndIdentifierTupleAndQty_TupleArray.Distinct().Select(t =&gt; t.Item1).ToList();

            Dictionary&lt;int, PayEstimate_WorkItemDto&gt; lookupWorkItemData = BL.Instance.GetPEDetailsQtyByPOTypeInstanceID(workItemIdList, POTypeInstanceID, (isNewRecord ? (int?)null : PEID));

            List&lt;string&gt; invalidItemIdentifierList = new List&lt;string&gt;();

            //Generate distinct tuples because same workItem can be repeated
            List&lt;Tuple&lt;int, string, decimal&gt;&gt; groupedTuples = workItemIdAndIdentifierTupleAndQty_TupleArray.GroupBy(t =&gt; t.Item1).Select(cl =&gt; new Tuple&lt;int, string, decimal&gt;(cl.Key, cl.First().Item2, cl.Sum(c =&gt; c.Item3))).ToList();

            foreach (Tuple&lt;int, string, decimal&gt; t in groupedTuples)
            {
                int worItemId = t.Item1;
                string userFriendlyIdentifier = t.Item2;
                decimal currentQty = t.Item3;

                PayEstimate_WorkItemDto item = lookupWorkItemData[worItemId];

                decimal maxQtyValueAllowed = item.MaxAllowedQty + (item.MaxAllowedQty * excessQtyPercentage) / 100;

                decimal newQtyAfterUpdate = currentQty + item.TotalPostedQty;

                if (newQtyAfterUpdate &gt; maxQtyValueAllowed)
                    invalidItemIdentifierList.Add(userFriendlyIdentifier);
            }

            if (!invalidItemIdentifierList.Any())
                isValid = true;
            else
            {
                isValid = false;
                string faultyItemNames = string.Join(&quot;,&quot;, invalidItemIdentifierList);
                if (excessQtyPercentage &gt;= 0)
                    errorMessage = string.Format(LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; amount cannot be more than max item qty for Item [{0}]. Cannot proceed further.&quot;, faultyItemNames);
                else
                    errorMessage = string.Format(LocalizationManager.GetString(KeyConstants.LOC_PAY_ESTIMATE) + &quot; amount is more than {1}% than the contract amount for Item [{0}]. Cannot proceed further.&quot;, faultyItemNames, excessQtyPercentage);
            }
            //}

            return isValid;
        }

        public bool SaveHandler(object sender, out string sSavedInstanceToken, out string sErrors, out string sRedirectTo)
        {
            sSavedInstanceToken = &quot;&quot;;
            sRedirectTo = &quot;&quot;;
            sErrors = &quot;&quot;;
            try
            {
                if (!string.IsNullOrEmpty(hdnTodate.Value) &amp;&amp; Convert.ToDateTime(hdnTodate.Value).ToString(&quot;dd/MM/yyyy&quot;) != Convert.ToDateTime(dtEndDate.Value).ToString(&quot;dd/MM/yyyy&quot;))
                    throw new Exception(&quot;To Date has changed since the last time Postings were generated. Please Generate Postings again for the chosen To Date.&quot;);

                bool isNewRecord = Mode.Equals(&quot;New&quot;, StringComparison.CurrentCultureIgnoreCase);
                if (isNewRecord)
                {
                    if (!hdnGenerateClicked.Value.Equals(&quot;true&quot;, StringComparison.OrdinalIgnoreCase))
                    {
                        throw new Exception(&quot;Please click on generate button before saving.&quot;);
                    }
                }

                //validate if total adjustment quanity is less than total contract amount
                DataTable contractDt = ContractManager.BusinessLayer.BL.Instance.GetContractCost(ParentModuleId).Tables[0];
                if (hdnAdjustmentTotal.Value.ToDecimal2() &gt; contractDt.Rows[0][&quot;ContractCost&quot;].ToDecimal2())
                {
                    hdnAddedAdjustments.Value = string.Empty;
                    throw new Exception(&quot;Total adjustments amount should not be more than the Total Contract Items Amount&quot;);
                }

                bool isAvailable_hdnAddedPosting = !string.IsNullOrEmpty(hdnAddedPosting.Value);
                DataTable postedWorkItems = null;
                //Verify if fulfills the pay estimate rule for using the posted qty
                if (isAvailable_hdnAddedPosting)
                    postedWorkItems = JsonConvert.DeserializeObject&lt;DataTable&gt;(JArray.Parse(hdnAddedPosting.Value).ToString2());

                bool enableValidateOnSave = false;//as of now We do not validate on Save. Validate will happen only during approval time: hence this is set as false

                if (enableValidateOnSave)
                {
                    #region Validate the Settings: Where payment cannot be made for excess qty if settings are defined

                    Tuple&lt;int, string, decimal&gt;[] workItemIdAndIdentifierTupleAndQty_TupleArray = null;

                    if (isAvailable_hdnAddedPosting &amp;&amp; postedWorkItems.Rows.Count &gt; 0)
                        workItemIdAndIdentifierTupleAndQty_TupleArray =
                                            postedWorkItems.Rows.Cast&lt;DataRow&gt;().Select(t =&gt;
                                              new Tuple&lt;int, string, decimal&gt;(
                                                  t[&quot;WorkItemID&quot;].ToInt32_2(),
                                                  string.Format(&quot;{1}({0})&quot;, t[&quot;LineNo&quot;].ToString(), t[&quot;StandardItemNo&quot;].ToString()),
                                                  t[&quot;AvailableQty&quot;].ToDecimal2())
                                                ).ToArray();

                    else
                        workItemIdAndIdentifierTupleAndQty_TupleArray =
                                           grdWorkDone.Items.Cast&lt;GridDataItem&gt;().Select(t =&gt;
                                             new Tuple&lt;int, string, decimal&gt;(
                                                 t[&quot;WorkItemID&quot;].Text.ToInt32_2(),
                                                 string.Format(&quot;{1}({0})&quot;, t[&quot;LineNo&quot;].Text.ToString(), t[&quot;StandardItemNo&quot;].Text.ToString()),
                                                 t[&quot;AvailableQty&quot;].Text.ToDecimal2())
                                               ).ToArray();


                    if ((Mode != &quot;View&quot;) &amp;&amp; ((postedWorkItems != null &amp;&amp; postedWorkItems.Rows.Count &gt; 0) || grdWorkDone.Items.Count &gt; 0))
                    {
                        string errorMessage = string.Empty;

                        if (!TryValidate_PayEstimateQtyRule(isNewRecord, workItemIdAndIdentifierTupleAndQty_TupleArray, out errorMessage))
                            throw new Exception(errorMessage);
                    }
                    #endregion Validate the Settings: Where payment cannot be made for excess qty if settings are defined
                }

                //Save Pay Estimate
                Exception ex;
                DataSet ds;
                int uid = UserDetail.GetCurrentUserDetail().UID;
                DateTime utcNow = MWDateTimeHelper.UtcNow;
                ProcurementPayEstimateDTO peDto = new ProcurementPayEstimateDTO();
                peDto.PEID = PEID;
                peDto.POID = POID;


                if (isNewRecord)
                {
                    lblPayEstimateNo.Text = BL.Instance.GetPENextRANumber(POID);
                }
                peDto.PENum = !string.IsNullOrEmpty(lblPayEstimateNo.Text) ? lblPayEstimateNo.Text.ToInt32_2() : 0;
                peDto.FromDate = dtFromDate.Value.ToUtc();
                peDto.ToDate = dtEndDate.Value.ToUtc();
                DateTime dtFrom = dtFromDate.Value.ToUtc();
                DateTime dtTo = dtEndDate.Value.ToUtc();
                if (dtFrom.Date &gt; dtTo.Date)
                    throw new Exception(&quot;To Date cannot be less than From Date&quot;);
                peDto.IsFinal = null;
                peDto.Status = (PEID &gt; 0 ? null : &quot;Draft&quot;);
                peDto.Notes = txtNotes.Text;
                if (isNewRecord)
                {
                    peDto.CreatedOn = utcNow;//.ToUtc();
                    peDto.CreatedBy = uid;
                }
                else
                {
                    peDto.LastModifiedOn = utcNow;//.ToUtc();
                    peDto.LastModifiedBy = uid;
                }

                peDto = ProcurementPayEstimates.Instance.CreateUpdatePayEstimates(out ex, out ds, null, peDto);

                if (ex == null &amp;&amp; peDto != null)
                {
                    //Save WorkDone

                    //delete all deleted work done
                    if (!string.IsNullOrEmpty(hdnDeletedPostingIds.Value))
                        ProcurementPayEstimates.Instance.DeletePEDetails(out ex, out ds, hdnDeletedPostingIds.Value, &quot;PEDetails&quot;);

                    if (!string.IsNullOrEmpty(hdnDeletedAdvancePayments.Value))
                        ProcurementPayEstimates.Instance.DeletePEDetails(out ex, out ds, hdnDeletedAdvancePayments.Value, &quot;AdvancePayments&quot;);

                    if (isAvailable_hdnAddedPosting)
                    {
                        grdWorkDone.MasterTableView.IsItemInserted = true;
                        //GridTableRow dataRowInfo = new GridTableRow();

                        DataTable dtSelItems = new BrixDataTable();
                        //DataTable postedWorkItems = JsonConvert.DeserializeObject&lt;DataTable&gt;(JArray.Parse(hdnAddedPosting.Value).ToString2());
                        dtSelItems.Columns.AddRange(GetColumnArray_ForWorkDoneGrid());

                        foreach (DataRow row in postedWorkItems.Rows)
                        {
                            DataRow dr = dtSelItems.NewRow();
                            dr[&quot;PEDetailsID&quot;] = row[&quot;PEDetailsID&quot;];
                            dr[&quot;WorkPostingID&quot;] = row[&quot;WorkPostingID&quot;];
                            dr[&quot;WorkItemID&quot;] = row[&quot;WorkItemID&quot;];
                            dr[&quot;LineNo&quot;] = row[&quot;LineNo&quot;];
                            dr[&quot;StandardItemNo&quot;] = row[&quot;StandardItemNo&quot;];
                            dr[&quot;Description&quot;] = row[&quot;Description&quot;];
                            dr[&quot;PostingDate&quot;] = row[&quot;PostingDate&quot;].ToDateTime_MWCulture();
                            dr[&quot;AvailableQty&quot;] = row[&quot;AvailableQty&quot;];
                            dr[&quot;BillingQty&quot;] = row[&quot;BillingQty&quot;];
                            dr[&quot;AvailableRate&quot;] = row[&quot;AvailableRate&quot;];
                            dr[&quot;BillingRate&quot;] = row[&quot;BillingRate&quot;];
                            dr[&quot;Amount&quot;] = row[&quot;Amount&quot;];
                            dtSelItems.Rows.Add(dr);
                        }
                        grdWorkDone.DataSource = dtSelItems.ToMWDateTime();
                        grdWorkDone.DataBind();


                    }

                    foreach (var row in grdWorkDone.Items)
                    {
                        if (row is GridDataItem)
                        {
                            GridDataItem item = row as GridDataItem;
                            if (string.IsNullOrEmpty(hdnDeletedPostingIds.Value.TrimEnd(&#39;,&#39;)) || !Array.ConvertAll(hdnDeletedPostingIds.Value.TrimEnd(&#39;,&#39;).Split(&#39;,&#39;), Int32.Parse).Contains(item[&quot;PEDetailsID&quot;].Text.ToInt32_2()))
                            {
                                ProcurementPEDetailsDTO detailsDto = new ProcurementPEDetailsDTO();
                                detailsDto.PEDetailsID = item[&quot;PEDetailsID&quot;].Text.ToInt32_2();
                                detailsDto.PEID = peDto.PEID.ToInt32_2();
                                detailsDto.WorkPostingID = item[&quot;WorkPostingID&quot;].Text.ToInt32_2();
                                detailsDto.WorkItemID = item[&quot;WorkItemID&quot;].Text.ToInt32_2();
                                detailsDto.Quantity = item[&quot;BillingQty&quot;].Text.ToDecimal2();
                                detailsDto.BillingRate = item[&quot;BillingRate&quot;].Text.ToDecimal2();
                                detailsDto.Amount = item[&quot;Amount&quot;].Text.ToDecimal2();

                                ProcurementPayEstimates.Instance.CreateUpdatePEDetails(out ex, out ds, null, detailsDto);
                                if (ex != null)
                                    throw ex;
                            }
                        }

                    }


                    //Updating the WorkDOne column of the pay estimate table with the the sum of qty * rate from details table
                    ProcurementPayEstimates.Instance.UpdateWorkDoneFromDetails(peDto.PEID.ToInt32_2());

                    //Save Advances
                    foreach (var row in grdAdvances.Items)
                    {
                        if (row is GridDataItem)
                        {
                            GridDataItem item = row as GridDataItem;
                            ProcurementPEAdvanceDTO advDto = new ProcurementPEAdvanceDTO();
                            advDto.PEAdvanceID = item[&quot;PEAdvanceID&quot;].Text.ToInt32_2();
                            advDto.PEID = peDto.PEID.ToInt32_2();
                            advDto.AdvanceTypeID = item[&quot;AdvanceTypeID&quot;].Text.ToInt32_2();
                            advDto.Amount = item[&quot;Amount&quot;].Text.ToDecimal2();

                            ProcurementPayEstimates.Instance.CreateUpdatePEAdvance(out ex, out ds, null, advDto);
                            if (ex != null)
                                throw ex;
                        }

                    }



                    //Save Adjustments

                    if (!string.IsNullOrEmpty(hdnAddedAdjustments.Value))
                    {                        
                        grdAdjustments.MasterTableView.IsItemInserted = true;
                        GridTableRow dataRowInfo = new GridTableRow();

                        DataTable dtSelItems = new BrixDataTable();
                        DataTable array = JsonConvert.DeserializeObject&lt;DataTable&gt;(JArray.Parse(hdnAddedAdjustments.Value).ToString2());
                        DataColumnCollection coll = dtSelItems.Columns;
                        coll.AddRange(GetColumnArray_ForAdjustmentGrid());

                        foreach (DataRow row in array.Rows)
                        {
                            DataRow dr = dtSelItems.NewRow();
                            dr[&quot;AdjustmentID&quot;] = 0;
                            dr[&quot;Amount&quot;] = (row[&quot;Amount&quot;] == null || string.IsNullOrEmpty(row[&quot;Amount&quot;].ToString2())) ? 0 : row[&quot;Amount&quot;].ToDecimal2();
                            dr[&quot;AdjustmentDescription&quot;] = row[&quot;AdjustmentID&quot;];
                            dr[&quot;AdjustmentNotes&quot;] = row[&quot;AdjustmentDescription&quot;];
                            dtSelItems.Rows.Add(dr);
                        }
                        foreach (var row in grdAdjustments.Items)
                        {
                            if (row is GridDataItem)
                            {
                                GridDataItem item = row as GridDataItem;
                                DataRow dr = dtSelItems.NewRow();
                                dr[&quot;AdjustmentID&quot;] = item[&quot;AdjustmentID&quot;].Text.ToInt32_2();
                                dr[&quot;Amount&quot;] = item[&quot;Amount&quot;].Text.ToDecimal2();
                                dr[&quot;AdjustmentDescription&quot;] = item[&quot;AdjustmentDescription&quot;].Text.ToString2();
                                dr[&quot;AdjustmentNotes&quot;] = item[&quot;AdjustmentNotes&quot;].Text.ToString2();
                                dtSelItems.Rows.Add(dr);
                            }
                        }
                        grdAdjustments.DataSource = dtSelItems.ToMWDateTime();
                        grdAdjustments.DataBind();
                    }

                    


                    if (!string.IsNullOrEmpty(hdnDeletedAdjustments.Value))
                        ProcurementPayEstimates.Instance.DeletePEAdjustments(out ex, out ds, hdnDeletedAdjustments.Value);


                    //This is hack to prevent the crash
                    //TODO : Find the exact reason why empty rows are getting inserted into the grid
                    //CleanupEmptyRows(grdAdjustments.MasterTableView, &quot;AdjustmentDescription&quot;);

                    int[] deletedIdArray = null;

                    if (!string.IsNullOrEmpty(hdnDeletedAdjustments.Value.TrimEnd(&#39;,&#39;)))
                        deletedIdArray = Array.ConvertAll(hdnDeletedAdjustments.Value.TrimEnd(&#39;,&#39;).Split(&#39;,&#39;), Int32.Parse);


                    foreach (GridDataItem row in grdAdjustments.Items)
                    {
                        GridDataItem item = row as GridDataItem;
                        int adjustmentID = item[&quot;AdjustmentID&quot;].Text.ToInt32_2();

                        if (deletedIdArray == null || !deletedIdArray.Contains(adjustmentID))
                        {
                            ProcurementPEAdjustmentsDTO adjDto = new ProcurementPEAdjustmentsDTO();
                            adjDto.AdjustmentID = adjustmentID;
                            adjDto.PEID = peDto.PEID.ToInt32_2();
                            adjDto.AdjustmentDescription = item[&quot;AdjustmentDescription&quot;].Text.ToString();
                            adjDto.AdjustmentNotes = item[&quot;AdjustmentNotes&quot;].Text == null ? &quot;&quot; : item[&quot;AdjustmentNotes&quot;].Text.ToString();
                            adjDto.Amount = string.IsNullOrEmpty(item[&quot;Amount&quot;].Text) ? 0 :
                                item[&quot;Amount&quot;].Text.ToDecimal2();

                            if (!string.IsNullOrEmpty(hdnEditedAdjustments.Value))
                            {
                                DataTable array = JsonConvert.DeserializeObject&lt;DataTable&gt;(JArray.Parse(hdnEditedAdjustments.Value).ToString2());
                                foreach (DataRow elem in array.Rows)
                                {
                                    if (elem[&quot;AdjustmentID&quot;].ToInt32_2().Equals(adjDto.AdjustmentID))
                                    {
                                        //adjDto.AdjustmentDescription = elem[&quot;AdjustmentDescription&quot;].ToString2();
                                        adjDto.AdjustmentNotes = elem[&quot;AdjustmentNotes&quot;].ToString2();
                                        adjDto.Amount = string.IsNullOrEmpty(elem[&quot;Amount&quot;].ToString2()) ? 0 :
                                            elem[&quot;Amount&quot;].ToDecimal2();
                                    }
                                }
                            }

                            ProcurementPayEstimates.Instance.CreateUpdateEAdjustments(out ex, out ds, null, adjDto);
                            if (ex != null)
                                throw ex;
                        }

                    }

                    //Save Recoveries

                    string recoveryDetails = hdnRecoveryDetailsJSON.Value;
                    List&lt;RecoveryDetails&gt; lstDetails = new List&lt;RecoveryDetails&gt;();
                    if (recoveryDetails != null)
                    {
                        JavaScriptSerializer serializer = new JavaScriptSerializer();

                        lstDetails = (List&lt;RecoveryDetails&gt;)serializer.Deserialize(recoveryDetails, typeof(List&lt;RecoveryDetails&gt;));
                        List&lt;RecoveryDetails&gt; deleteRecoveries = new List&lt;RecoveryDetails&gt;();
                        foreach (RecoveryDetails det in lstDetails)
                        {
                            bool postingFound = false;
                            foreach (var row in grdWorkDone.Items)
                            {
                                if (row is GridDataItem)
                                {
                                    GridDataItem item = row as GridDataItem;
                                    //WorkPostingID will be -1 if the MOH is closed and recovery is pending
                                    if (det.WorkPostingID == -1 || item[&quot;WorkPostingID&quot;].Text.ToInt32_2() == det.WorkPostingID)
                                    {
                                        postingFound = true;
                                        break;
                                    }
                                }

                            }
                            if (!postingFound &amp;&amp; det.WorkPostingID != -1)
                                deleteRecoveries.Add(det);
                        }
                        string deletedIds = string.Empty;
                        foreach (RecoveryDetails det in deleteRecoveries)
                        {
                            lstDetails.Remove(det);
                            deletedIds += det.WorkPostingID + &quot;,&quot;;
                        }

                        if (!string.IsNullOrEmpty(deletedIds))
                        {
                            BL.Instance.DeleteRecoveryByWorkPostingID(deletedIds, peDto.PEID.ToInt32_2());
                        }

                    }

                    foreach (var row in grdRecoveries.Items)
                    {
                        if (row is GridDataItem)
                        {
                            var item = row as GridDataItem;
                            string advanceType = MWGrid.GetCellValue&lt;GridDataItem&gt;(item , &quot;AdvanceType&quot;).Replace(&quot;&amp;nbsp;&quot;, &quot;&quot;);

                            if (!string.IsNullOrEmpty(advanceType) &amp;&amp; advanceType.ToUpper() == &quot;CONTMOH&quot;) //Prepayment
                            {
                                //Inside inside recovery master and not in details

                                ProcurementPERecoveryMasterDTO recDto = new ProcurementPERecoveryMasterDTO();
                                recDto.RecoveryID = item[&quot;RecoveryID&quot;].Text.ToInt32_2();
                                recDto.PEAdvanceID = item[&quot;PEAdvanceID&quot;].Text.ToInt32_2();
                                recDto.PEID = peDto.PEID.ToInt32_2();
                                recDto.Amount = item[&quot;RecoveringAmount&quot;].Text == null ? 0
                                    : item[&quot;RecoveringAmount&quot;].Text.ToDecimal2();

                                if (!string.IsNullOrEmpty(hdnRecAmtForAdv.Value))
                                {
                                    DataTable array = JsonConvert.DeserializeObject&lt;DataTable&gt;(JArray.Parse(hdnRecAmtForAdv.Value).ToString2());
                                    foreach (DataRow elem in array.Rows)
                                    {
                                        if (elem[&quot;PEAdvanceID&quot;].ToInt32_2().Equals(recDto.PEAdvanceID))
                                        {
                                            recDto.Amount = elem[&quot;RecoveringAmount&quot;].ToDecimal2(); 
                                        }
                                    }
                                }

                                if (!string.IsNullOrEmpty(hdnEditedRecoveries.Value))
                                {
                                    DataTable array = JsonConvert.DeserializeObject&lt;DataTable&gt;(JArray.Parse(hdnEditedRecoveries.Value).ToString2());
                                    foreach (DataRow elem in array.Rows)
                                    {
                                        if (elem[&quot;RecoveryID&quot;].ToInt32_2().Equals(recDto.RecoveryID) &amp;&amp; elem[&quot;PEAdvanceID&quot;].ToInt32_2().Equals(recDto.PEAdvanceID))
                                        {
                                            recDto.Amount = elem[&quot;RecoveringAmount&quot;].ToDecimal2(); // only RecoveringAmount is editable 
                                        }
                                    }
                                }

                                BL.Instance.CreateUpdatePEAdvanceRecoveryMaster(out ex, out ds, null, recDto);
                                if (ex != null)
                                    throw ex;
                            }
                            else if (recoveryDetails != null)
                            {//Material On Hand

                                //Update the details table and call update summary SP later
                                foreach (RecoveryDetails det in lstDetails.FindAll(x =&gt; x.AdvanceID == item[&quot;PEAdvanceID&quot;].Text.ToInt32_2()))
                                {
                                    ProcurementPERecoveriesDTO recDto = new ProcurementPERecoveriesDTO();
                                    recDto.RecoveryID = 0;
                                    recDto.PEAdvanceID = det.AdvanceID;
                                    recDto.PEID = peDto.PEID.ToInt32_2();
                                    recDto.DetailsID = det.DetailID;
                                    recDto.WorkPostingID = det.WorkPostingID;
                                    recDto.Amount = det.Amount.ToDecimal2();

                                    BL.Instance.CreateUpdatePEAdvanceRecoveries(out ex, out ds, null, recDto);
                                    if (ex != null)
                                        throw ex;
                                }

                                //Call SP to update Summary table with PEID and Advance ID
                                BL.Instance.UpdateAdvanceSummary(peDto.PEID.ToInt32_2(), item[&quot;PEAdvanceID&quot;].Text.ToInt32_2());
                            }

                        }

                    }

                    //Save Hold And Retention

                    ProcurementPEHoldRetentionDTO holdDto = new ProcurementPEHoldRetentionDTO();
                    holdDto.RetentionID = string.IsNullOrEmpty(hdnHoldId.Value) ? 0 : hdnHoldId.Value.ToInt32_2();
                    holdDto.PEID = peDto.PEID.ToInt32_2();
                    holdDto.BucketType = &quot;Hold&quot;;
                    holdDto.RetentionType = rbHoldPercentage.Checked ? &quot;P&quot; : &quot;A&quot;;
                    holdDto.RetentionPercentage = Double.IsNaN(wneHoldPercentage.ValueDouble) ? 0 : wneHoldPercentage.ValueDouble;
                    holdDto.RetentionAmount = Double.IsNaN(wneHoldAmount.ValueDouble) ? 0 : wneHoldAmount.ValueDouble;
                    holdDto.ReleaseType = rbHoldReleasePercentage.Checked ? &quot;P&quot; : &quot;A&quot;;
                    holdDto.ReleasePercentage = Double.IsNaN(wneHoldReleasePercentage.ValueDouble) ? 0 : wneHoldReleasePercentage.ValueDouble;
                    holdDto.ReleaseAmount = Double.IsNaN(wneHoldReleaseAmount.ValueDouble) ? 0 : wneHoldReleaseAmount.ValueDouble;

                    ProcurementPayEstimates.Instance.CreateUpdatePEHoldAndRetention(out ex, out ds, null, holdDto);
                    if (ex != null)
                        throw ex;

                    ProcurementPEHoldRetentionDTO retentionDto = new ProcurementPEHoldRetentionDTO();
                    retentionDto.RetentionID = string.IsNullOrEmpty(hdnRetainageId.Value) ? 0 : hdnRetainageId.Value.ToInt32_2();
                    retentionDto.PEID = peDto.PEID.ToInt32_2();
                    retentionDto.BucketType = &quot;Retainage&quot;;
                    retentionDto.RetentionType = rbRetainagePercentage.Checked ? &quot;P&quot; : &quot;A&quot;;
                    retentionDto.RetentionPercentage = Double.IsNaN(wneRetainagePercentage.ValueDouble) ? 0 : wneRetainagePercentage.ValueDouble;
                    retentionDto.RetentionAmount = Double.IsNaN(wneRetainageAmount.ValueDouble) ? 0 : wneRetainageAmount.ValueDouble;
                    retentionDto.ReleaseType = rbRetainageReleasePercentage.Checked ? &quot;P&quot; : &quot;A&quot;;
                    retentionDto.ReleasePercentage = Double.IsNaN(wneRetainageReleasePercentage.ValueDouble) ? 0 : wneRetainageReleasePercentage.ValueDouble;
                    retentionDto.ReleaseAmount = Double.IsNaN(wneRetainageReleaseAmount.ValueDouble) ? 0 : wneRetainageReleaseAmount.ValueDouble;

                    ProcurementPayEstimates.Instance.CreateUpdatePEHoldAndRetention(out ex, out ds, null, retentionDto);
                    if (ex != null)
                        throw ex;
                    UserDetail ud = UserDetail.GetCurrentUserDetail();
                    peAttachments.ParentModuleID = Constants.MODID_CONTMGT;
                    peAttachments.ParentInstanceID = Request[&quot;ContractID&quot;].ToInt32_2();
                    peAttachments.SaveAttachments(peDto.PEID.ToString2(), &quot;PAYESTM&quot;, ud.UID, ud.UserName, PayEstimateName + &quot; Documents&quot;);

                    sSavedInstanceToken = peDto.PEID.ToString();
                    return true;
                }
                else
                {
                    sErrors = ex.Message;
                    sSavedInstanceToken = &quot;-1&quot;;
                    return false;
                }
            }
            catch (Exception ex)
            {
                sErrors = ex.Message;

                sSavedInstanceToken = &quot;-1&quot;;
                return false;
            }
        }

        private void CleanupEmptyRows(GridTableView grid, string mandatoryColumn)
        {
            if (grid.GetColumnSafe(mandatoryColumn) != null)
            {
                for (int rowCount = grid.Items.Count - 1; rowCount &gt;= 0; rowCount--)
                {
                    if (grid.Items[rowCount].GetDataKeyValue(mandatoryColumn) == null)
                        grid.PerformDelete(grid.Items[rowCount]);
                }
            }
        }

        #region IXMLControl Members

        public void HandleInjectionAfterSave(object model, string parentFormInstanceId)
        {

        }

        public void HandleInjectionSaveException(object model, Exception ex, string parentFormInstanceId)
        {

        }

        public object[] ParentFormInstanceID
        {
            get { return new object[] { PEID }; }
        }

        public System.Web.UI.HtmlControls.HtmlGenericControl XMLContainterDiv
        {
            get
            {
                return divAdditionalInjection;
            }
            set
            {

            }
        }

        public bool SkipDefaultXMLInjectionSave { get; set; }

        #endregion IXMLControl Members

        public override int GetProjectIdFromInstanceId()
        {
            if (!string.IsNullOrEmpty(Request[&quot;PEID&quot;]))
                return ProcurementPayEstimates.Instance.GetPIDFromPEID(Request[&quot;PEID&quot;].ToInt32_2());
            else
                return base.GetProjectIdFromInstanceId();
        }

        private void SetManagerModel()
        {
            model = BrixFormModel.GetInstance(&quot;XPRCMGT&quot;, &quot;XPRCMGT&quot;, Request, Response);

            if (!string.IsNullOrEmpty(model.form.ManagerDLL) &amp;&amp; !string.IsNullOrEmpty(model.form.FormManagerClass))
            {
                managerModel = AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(model.form.ManagerDLL,
                                                                                 model.form.FormManagerClass);
            }
        }

        protected void grdAdjustments_PreRender(object sender, EventArgs e)
        {
            var grid = sender as RadGrid;
            GridTableView masterTable = (sender as RadGrid).MasterTableView;

            GridNumericColumnEditor gridNumericColumnEditor = null;
            if(masterTable.GetColumnSafe(&quot;Amount&quot;).IsEditable)
            {
                gridNumericColumnEditor = masterTable.GetBatchColumnEditor(&quot;Amount&quot;) as GridNumericColumnEditor;

                if (gridNumericColumnEditor != null)
                {
                    gridNumericColumnEditor.NumericTextBox.IncrementSettings.InterceptArrowKeys = false;
                }
            }
        }
    }
}


    </pre>
    <script type="text/javascript">
      highlightRanges([[62,13,62,14,1],[63,17,63,48,1],[64,13,64,14,1],[70,13,70,14,1],[71,17,71,106,1],[72,13,72,14,1],[77,17,77,18,1],[77,19,77,94,1],[77,95,77,96,1],[78,17,78,18,1],[78,19,78,52,1],[78,53,78,54,1],[84,13,84,14,1],[85,17,85,82,1],[86,13,86,14,1],[92,13,92,14,1],[93,17,93,98,1],[94,13,94,14,1],[99,17,99,18,1],[99,19,99,115,1],[99,116,99,117,1],[100,17,100,18,1],[100,19,100,58,1],[100,59,100,60,1],[103,30,103,34,1],[103,35,103,39,1],[104,34,104,38,1],[104,39,104,43,1],[108,9,108,10,1],[109,13,109,86,1],[111,13,111,55,1],[112,13,112,47,1],[113,13,113,45,1],[115,13,115,43,1],[116,13,116,40,1],[118,13,118,41,1],[120,13,120,28,1],[121,13,121,31,1],[122,13,122,38,1],[123,17,123,63,0],[125,9,125,10,1],[128,9,128,10,1],[129,13,129,52,1],[130,13,130,63,1],[131,13,131,81,1],[132,17,132,31,1],[133,21,133,94,1],[134,13,134,92,1],[135,13,135,42,1],[136,13,136,49,1],[137,13,137,40,1],[138,9,138,10,1],[141,9,141,10,1],[142,13,142,81,1],[143,17,143,69,1],[144,17,144,18,1],[145,21,145,86,1],[146,25,146,327,1],[148,25,148,120,0],[150,21,150,102,1],[151,17,151,18,1],[153,13,153,67,1],[154,13,154,14,1],[155,17,155,102,1],[156,13,156,14,1],[158,13,158,37,1],[159,9,159,10,1],[162,9,162,10,1],[164,13,164,55,1],[166,13,166,110,1],[168,13,168,130,1],[170,13,170,29,1],[171,13,171,14,1],[172,17,172,116,1],[173,17,173,41,1],[175,17,175,77,1],[177,17,177,33,1],[178,21,178,53,0],[180,21,180,53,1],[182,17,182,47,1],[183,17,183,33,1],[184,17,184,37,1],[186,17,186,84,1],[187,17,187,18,0],[188,21,188,104,0],[189,21,189,46,0],[190,21,190,37,0],[191,25,191,36,0],[192,17,192,18,0],[193,22,193,89,1],[194,17,194,18,0],[195,21,195,104,0],[196,21,196,46,0],[197,21,197,32,0],[198,17,198,18,0],[200,17,200,18,1],[201,21,201,103,1],[202,21,202,81,1],[204,21,204,108,1],[205,21,205,22,0],[206,25,206,88,0],[207,25,207,91,0],[208,21,208,22,0],[210,21,210,22,1],[211,25,211,87,1],[212,25,212,90,1],[213,21,213,22,1],[214,17,214,18,1],[216,17,216,104,1],[217,17,217,142,1],[218,17,218,146,1],[219,17,219,144,1],[220,17,220,89,1],[221,17,221,102,1],[222,17,222,96,1],[223,17,223,89,1],[225,17,225,51,1],[226,17,226,52,1],[227,21,227,69,0],[229,17,229,56,1],[230,17,230,18,0],[231,21,231,44,0],[232,21,232,51,0],[233,17,233,18,0],[234,13,234,14,1],[236,13,236,50,1],[237,13,237,38,1],[238,17,238,54,0],[239,9,239,10,1],[242,9,242,10,0],[243,13,243,72,0],[244,13,244,75,0],[245,13,245,78,0],[246,13,246,77,0],[247,13,247,80,0],[248,13,266,38,0],[267,9,267,10,0],[270,9,270,10,0],[271,13,271,93,0],[272,13,272,56,0],[273,13,273,14,0],[275,17,275,52,0],[276,17,276,18,0],[277,21,277,58,0],[278,21,278,71,0],[279,21,279,68,0],[280,21,280,61,0],[281,21,281,69,0],[282,21,282,63,0],[283,17,283,18,0],[285,17,285,47,0],[286,17,286,18,0],[287,21,287,32,0],[288,21,288,45,0],[290,21,290,54,0],[291,21,291,22,0],[292,25,292,55,0],[293,25,293,57,0],[294,21,294,22,0],[295,17,295,18,0],[297,17,297,49,0],[300,17,300,50,0],[303,17,303,53,0],[306,17,306,50,0],[309,17,309,52,0],[312,17,312,111,0],[313,17,313,55,0],[314,21,314,86,0],[318,13,318,14,0],[319,9,319,10,0],[322,9,322,10,1],[324,13,324,103,1],[325,13,325,49,1],[326,13,326,52,1],[328,13,328,29,1],[329,9,329,10,1],[332,9,332,10,1],[333,13,333,71,1],[334,13,334,51,1],[335,13,335,14,1],[336,17,336,45,1],[337,17,337,54,1],[338,17,338,18,1],[339,21,339,86,1],[340,21,340,90,1],[341,21,341,63,1],[342,21,342,67,1],[344,21,345,90,1],[346,21,347,88,1],[348,17,348,18,1],[349,17,349,67,1],[350,17,350,18,1],[351,21,351,92,1],[352,21,352,56,1],[353,17,353,18,1],[354,13,354,14,1],[355,9,355,10,1],[358,9,358,10,1],[360,13,360,14,1],[361,17,361,52,1],[363,17,363,46,1],[364,21,364,68,0],[366,17,366,45,1],[367,21,367,66,0],[369,17,369,71,1],[370,17,370,69,1],[372,17,372,89,1],[374,17,374,44,1],[375,21,375,82,0],[376,17,376,123,1],[377,17,377,88,1],[378,17,378,40,1],[379,17,379,18,0],[381,17,381,18,0],[382,17,382,65,1],[383,17,383,55,1],[384,21,384,156,0],[386,17,386,73,1],[387,17,387,67,1],[388,21,388,195,0],[390,17,390,64,1],[391,17,391,60,1],[393,17,393,51,1],[394,13,394,14,1],[395,13,395,33,0],[396,13,396,14,0],[397,17,398,127,0],[400,13,400,14,0],[401,9,401,10,1],[404,9,404,10,1],[405,13,405,56,1],[406,13,406,36,1],[409,13,409,20,1],[409,22,409,36,1],[409,37,409,39,1],[409,40,409,50,1],[410,13,410,14,1],[411,17,411,114,1],[412,13,412,14,1],[414,13,414,28,1],[415,13,415,20,1],[415,22,415,33,0],[415,34,415,36,1],[415,37,415,44,1],[416,13,416,14,0],[417,17,417,50,0],[418,13,418,14,0],[419,13,419,48,1],[421,13,421,34,1],[422,9,422,10,1],[425,9,425,10,1],[427,13,427,98,1],[428,13,428,35,1],[429,13,429,14,1],[430,17,430,83,1],[431,17,431,18,1],[432,21,432,58,1],[433,21,433,81,1],[434,17,434,18,1],[435,17,435,98,1],[436,17,436,117,1],[437,17,437,18,0],[438,21,438,81,0],[439,21,440,87,0],[441,17,441,18,0],[442,17,442,70,1],[443,17,443,18,1],[444,21,444,95,1],[445,21,446,101,1],[447,17,447,18,1],[448,17,448,65,1],[449,17,449,18,1],[450,21,450,85,1],[451,21,452,91,1],[453,17,453,18,1],[455,13,455,14,1],[457,9,457,10,1],[460,9,460,10,1],[461,13,461,56,1],[462,13,462,36,1],[464,13,464,28,1],[465,13,465,20,1],[465,22,465,33,1],[465,34,465,36,1],[465,37,465,44,1],[466,13,466,14,1],[467,17,467,50,1],[468,13,468,14,1],[469,13,469,56,1],[471,13,471,33,1],[473,9,473,10,1],[476,9,476,10,0],[477,13,477,59,0],[478,13,478,39,0],[480,13,480,28,0],[481,13,481,20,0],[481,22,481,33,0],[481,34,481,36,0],[481,37,481,44,0],[482,13,482,14,0],[483,17,483,50,0],[484,13,484,14,0],[485,13,485,55,0],[486,13,486,36,0],[488,9,488,10,0],[491,9,491,10,1],[492,13,492,58,1],[493,13,493,38,1],[495,13,495,28,1],[496,13,496,20,1],[496,22,496,33,0],[496,34,496,36,1],[496,37,496,44,1],[497,13,497,14,0],[498,17,498,60,0],[499,13,499,14,0],[500,13,500,53,1],[501,13,501,34,1],[503,9,503,10,1],[506,9,506,10,0],[507,13,507,63,0],[508,13,508,35,0],[509,13,509,14,0],[510,17,510,73,0],[512,17,512,37,0],[513,21,513,53,0],[515,21,515,49,0],[517,17,517,76,0],[518,17,518,68,0],[520,17,520,74,0],[522,17,522,40,0],[523,21,523,60,0],[525,21,525,56,0],[527,17,527,81,0],[528,17,528,73,0],[530,17,530,71,0],[531,13,531,14,0],[533,13,533,67,0],[534,13,534,34,0],[535,13,535,14,0],[536,17,536,71,0],[538,17,538,36,0],[539,21,539,58,0],[541,21,541,54,0],[543,17,543,80,0],[544,17,544,72,0],[546,17,546,73,0],[548,17,548,40,0],[549,21,549,65,0],[551,21,551,61,0],[553,17,553,85,0],[554,17,554,77,0],[556,17,556,75,0],[557,13,557,14,0],[558,9,558,10,0],[561,9,561,10,1],[567,13,567,46,1],[569,13,569,20,1],[569,22,569,33,0],[569,34,569,36,1],[569,37,569,54,1],[570,13,570,14,0],[571,17,571,45,0],[572,17,572,18,0],[573,21,573,65,0],[574,21,574,93,0],[574,94,574,103,0],[576,25,576,70,0],[577,17,577,18,0],[579,13,579,14,0],[581,13,581,144,1],[582,13,582,37,1],[583,13,583,14,1],[584,17,584,47,1],[585,13,585,14,1],[587,13,587,44,1],[588,9,588,10,1],[591,9,591,10,1],[593,13,593,48,1],[594,9,594,10,1],[597,9,597,10,1],[598,13,598,46,1],[600,13,600,20,1],[600,22,600,29,0],[600,30,600,32,1],[600,33,600,50,1],[601,13,601,14,0],[602,17,602,41,0],[603,17,603,18,0],[604,21,604,61,0],[605,21,605,93,0],[605,94,605,103,0],[607,25,607,70,0],[609,17,609,18,0],[610,13,610,14,0],[613,13,613,107,1],[614,13,614,34,1],[616,13,616,44,1],[617,9,617,10,1],[620,9,620,10,1],[621,13,621,47,1],[623,13,623,107,1],[624,13,624,51,1],[625,17,625,48,1],[626,13,626,51,1],[627,17,627,65,1],[628,13,628,32,1],[629,9,629,10,1],[632,9,632,10,1],[633,13,633,74,1],[634,13,634,76,1],[636,13,636,20,1],[636,22,636,33,0],[636,34,636,36,1],[636,37,636,44,1],[637,13,637,14,0],[638,17,638,61,0],[639,17,639,62,0],[640,17,640,70,0],[641,17,641,56,0],[642,17,642,56,0],[643,17,643,60,0],[645,17,645,37,0],[646,13,646,14,0],[648,13,648,53,1],[649,9,649,10,1],[652,9,652,10,1],[653,13,653,46,1],[654,13,654,52,0],[655,13,655,14,0],[656,17,656,80,0],[657,17,657,83,0],[658,13,658,14,0],[659,9,659,10,0],[662,9,662,10,0],[663,13,663,54,0],[664,9,664,10,0],[669,9,669,10,1],[670,13,670,37,1],[671,13,671,34,1],[673,13,673,36,1],[674,13,674,33,1],[676,13,676,39,1],[677,13,677,36,1],[679,13,679,37,1],[680,13,680,34,1],[681,9,681,10,1],[684,9,684,10,1],[685,13,698,15,1],[699,9,699,10,1],[702,9,702,10,1],[703,13,703,46,1],[704,13,704,69,1],[705,13,705,43,1],[706,13,706,36,1],[708,9,708,10,1],[711,9,711,10,1],[712,13,712,62,1],[713,13,713,234,1],[715,13,715,190,1],[716,13,716,91,1],[717,13,717,94,1],[718,13,718,72,1],[719,13,719,69,1],[720,13,720,90,1],[721,13,721,74,1],[722,13,722,133,1],[723,13,723,84,1],[724,13,724,84,1],[725,13,725,121,1],[726,13,726,82,1],[727,13,727,183,1],[728,13,728,151,1],[729,13,729,140,1],[731,13,731,45,1],[732,13,732,94,1],[734,13,734,54,1],[735,13,735,54,1],[737,9,737,10,1],[740,9,740,10,1],[741,13,749,16,1],[750,9,750,10,1],[753,9,753,10,1],[754,13,754,45,1],[755,13,755,67,1],[757,13,757,42,1],[758,13,758,36,1],[759,9,759,10,1],[762,9,762,10,1],[763,13,763,61,1],[764,13,764,163,1],[765,13,765,93,1],[766,13,766,71,1],[767,13,767,68,1],[769,13,769,90,1],[770,13,770,91,1],[771,13,771,81,1],[772,13,772,76,1],[773,13,773,141,1],[775,13,775,44,1],[777,13,777,94,1],[778,9,778,10,1],[781,9,781,10,1],[782,13,787,16,1],[788,9,788,10,1],[791,9,791,10,1],[792,13,792,45,1],[793,13,793,70,1],[795,13,795,45,1],[796,13,796,39,1],[798,13,798,20,1],[798,22,798,36,1],[798,37,798,39,1],[798,40,798,51,1],[799,13,799,14,1],[800,17,800,117,1],[801,13,801,14,1],[803,9,803,10,1],[806,9,806,10,1],[807,13,807,65,1],[808,13,808,128,1],[809,13,809,78,1],[810,13,810,69,1],[812,13,812,214,1],[813,13,813,14,1],[814,17,814,107,1],[815,17,815,116,1],[816,17,816,94,1],[817,13,817,14,1],[819,13,819,90,1],[820,13,820,93,1],[821,13,821,88,1],[822,13,822,141,1],[824,13,824,45,1],[826,13,826,97,1],[828,13,828,81,1],[829,13,829,81,1],[830,9,830,10,1],[833,9,833,10,1],[834,13,834,46,1],[835,13,845,16,1],[847,13,847,45,1],[848,13,848,38,1],[851,13,851,20,1],[851,22,851,36,1],[851,37,851,39,1],[851,40,851,52,1],[852,13,852,14,1],[853,17,853,116,1],[854,13,854,14,1],[855,9,855,10,1],[858,9,858,10,1],[860,13,860,20,1],[860,22,860,36,1],[860,37,860,39,1],[860,40,860,87,1],[861,13,861,14,1],[862,17,862,116,1],[863,13,863,14,1],[865,13,865,63,1],[866,13,866,232,1],[867,13,867,97,1],[868,13,868,71,1],[869,13,869,133,1],[870,13,870,214,1],[871,13,871,14,1],[872,17,872,72,1],[874,17,874,59,1],[875,17,875,18,1],[877,21,877,63,1],[878,17,878,18,1],[879,13,879,14,1],[881,13,881,90,1],[882,13,882,82,1],[883,13,883,72,1],[884,13,884,68,1],[885,13,885,137,1],[886,13,886,170,1],[887,13,887,160,1],[888,13,888,226,1],[890,13,890,44,1],[892,13,892,106,1],[894,13,894,80,1],[895,13,895,80,1],[898,9,898,10,1],[901,9,901,10,1],[902,13,902,20,1],[902,22,902,32,1],[902,33,902,35,1],[902,36,902,50,1],[903,17,903,83,1],[904,21,904,61,1],[905,9,905,10,1],[908,9,908,10,1],[909,13,909,20,1],[909,22,909,32,1],[909,33,909,35,1],[909,36,909,52,1],[910,13,910,14,1],[911,17,911,52,1],[912,17,912,72,1],[913,17,913,63,1],[914,17,914,18,1],[915,21,915,131,1],[916,17,916,18,1],[917,13,917,14,1],[918,9,918,10,1],[921,9,921,10,1],[922,13,922,20,1],[922,22,922,32,1],[922,33,922,35,1],[922,36,922,52,1],[923,13,923,14,1],[924,17,924,52,1],[925,17,925,72,1],[926,17,926,63,1],[927,17,927,18,1],[928,21,928,133,1],[929,17,929,18,1],[930,13,930,14,1],[931,9,931,10,1],[934,9,934,10,1],[935,13,935,20,1],[935,22,935,32,1],[935,33,935,35,1],[935,36,935,52,1],[936,13,936,14,1],[937,17,937,52,1],[938,17,938,72,1],[939,17,939,63,1],[940,17,940,18,1],[941,21,941,129,1],[942,17,942,18,1],[943,13,943,14,1],[944,9,944,10,1],[947,9,947,10,1],[948,13,948,20,1],[948,22,948,32,1],[948,33,948,35,1],[948,36,948,52,1],[949,13,949,14,1],[950,17,950,52,1],[951,17,951,64,1],[952,17,952,18,1],[953,21,953,128,1],[954,17,954,18,1],[955,13,955,14,1],[956,9,956,10,1],[959,9,959,10,1],[960,13,960,20,1],[960,22,960,56,1],[960,57,960,59,1],[960,60,960,75,1],[961,13,961,14,1],[962,17,962,57,1],[963,17,963,18,1],[964,21,964,75,1],[965,21,965,46,1],[965,47,965,118,1],[966,17,966,18,1],[967,17,967,31,1],[968,13,968,14,1],[969,9,969,10,1],[972,9,972,10,1],[973,13,973,20,1],[973,22,973,32,1],[973,33,973,35,1],[973,36,973,46,1],[974,13,974,14,1],[975,17,975,54,1],[976,17,976,65,1],[977,17,977,18,1],[978,21,978,65,1],[979,17,979,18,1],[980,13,980,14,1],[981,9,981,10,1],[984,9,984,10,1],[985,13,985,20,1],[985,22,985,32,1],[985,33,985,35,1],[985,36,985,46,1],[986,13,986,14,1],[987,17,987,54,1],[988,17,988,65,1],[989,17,989,18,1],[990,21,990,66,1],[991,17,991,18,1],[992,13,992,14,1],[993,9,993,10,1],[995,9,995,10,1],[996,13,996,63,1],[997,13,997,78,1],[998,13,998,30,1],[999,13,999,14,1],[1000,17,1000,64,1],[1001,17,1001,44,1],[1002,17,1002,18,1],[1004,21,1004,114,1],[1005,21,1005,116,1],[1006,21,1006,116,1],[1007,17,1007,18,1],[1008,13,1008,14,1],[1009,9,1009,10,1],[1019,9,1019,10,1],[1020,13,1020,112,1],[1021,13,1021,92,1],[1022,13,1022,56,1],[1023,13,1023,115,1],[1024,13,1024,125,1],[1025,13,1025,58,1],[1026,13,1026,119,1],[1027,9,1027,10,1],[1030,9,1030,10,1],[1031,13,1031,85,1],[1032,13,1032,102,1],[1033,13,1033,90,1],[1034,13,1034,62,1],[1035,13,1035,72,1],[1036,13,1036,20,1],[1036,22,1036,32,1],[1036,33,1036,35,1],[1036,36,1036,46,1],[1037,13,1037,14,1],[1038,17,1038,54,1],[1039,17,1039,18,0],[1040,21,1040,151,0],[1041,21,1041,43,0],[1042,17,1042,18,0],[1044,17,1044,18,1],[1045,21,1045,170,1],[1046,21,1046,43,1],[1047,17,1047,18,1],[1048,13,1048,14,1],[1050,13,1050,32,1],[1051,9,1051,10,1],[1058,9,1058,10,1],[1059,13,1059,105,1],[1060,13,1060,89,1],[1061,13,1061,53,1],[1062,13,1062,32,1],[1063,13,1063,94,1],[1064,13,1064,107,1],[1065,13,1065,116,1],[1066,13,1066,93,1],[1067,13,1067,52,1],[1068,13,1068,114,1],[1069,9,1069,10,1],[1072,9,1072,10,0],[1073,13,1073,31,0],[1074,13,1074,50,0],[1075,13,1075,100,0],[1076,13,1076,97,0],[1077,13,1077,50,0],[1078,13,1078,94,0],[1079,9,1079,10,0],[1083,9,1083,10,1],[1084,13,1084,85,1],[1085,13,1086,41,1],[1087,13,1087,90,1],[1088,13,1088,53,1],[1089,13,1089,111,1],[1090,13,1090,62,1],[1091,13,1091,63,1],[1092,13,1092,65,1],[1093,13,1093,31,1],[1093,32,1093,80,0],[1094,13,1094,134,1],[1095,13,1095,31,1],[1095,32,1095,149,0],[1096,13,1096,119,1],[1098,13,1098,91,1],[1099,13,1099,94,1],[1100,13,1100,71,1],[1101,13,1101,77,1],[1102,13,1102,74,1],[1104,13,1104,20,1],[1104,22,1104,32,1],[1104,33,1104,35,1],[1104,36,1104,46,1],[1105,13,1105,14,1],[1106,17,1106,54,1],[1107,17,1107,18,1],[1108,21,1108,123,1],[1109,21,1109,43,1],[1110,17,1110,18,1],[1112,17,1112,18,1],[1113,21,1113,170,1],[1114,21,1114,50,1],[1115,21,1115,22,1],[1116,25,1116,88,1],[1117,25,1117,46,1],[1118,21,1118,22,1],[1119,26,1119,56,1],[1120,21,1120,22,1],[1121,25,1121,90,1],[1122,25,1122,46,1],[1123,25,1123,42,1],[1124,21,1124,22,1],[1125,26,1125,55,1],[1126,21,1126,22,1],[1127,25,1127,86,1],[1128,25,1128,46,1],[1129,21,1129,22,1],[1130,26,1130,56,1],[1131,21,1131,22,1],[1132,25,1132,84,1],[1133,25,1133,44,1],[1134,21,1134,22,1],[1135,26,1135,58,1],[1136,21,1136,22,1],[1137,25,1137,46,1],[1138,21,1138,22,1],[1139,21,1139,43,1],[1140,17,1140,18,1],[1141,13,1141,14,1],[1143,13,1143,32,1],[1144,9,1144,10,1],[1147,9,1147,10,1],[1148,13,1148,28,1],[1149,13,1149,40,1],[1150,13,1150,14,0],[1151,17,1151,60,0],[1155,13,1155,14,0],[1156,18,1156,47,1],[1157,13,1157,14,1],[1158,17,1158,64,1],[1159,17,1159,59,1],[1160,13,1160,14,1],[1161,9,1161,10,1],[1163,9,1163,10,0],[1164,13,1164,68,0],[1165,13,1165,51,0],[1166,13,1166,78,0],[1168,9,1168,10,0],[1171,9,1171,10,1],[1172,13,1172,28,1],[1173,13,1173,40,1],[1174,13,1174,14,1],[1175,17,1175,60,1],[1176,17,1176,35,1],[1179,13,1179,14,1],[1180,18,1180,47,1],[1181,13,1181,14,1],[1182,17,1182,64,1],[1183,17,1183,194,1],[1184,13,1184,14,1],[1185,9,1185,10,1],[1187,9,1187,10,1],[1188,13,1188,28,1],[1190,13,1190,40,1],[1191,13,1191,14,0],[1192,17,1192,60,0],[1193,17,1193,104,0],[1194,17,1194,18,0],[1195,21,1195,55,0],[1196,17,1196,18,0],[1198,17,1198,18,0],[1199,21,1199,55,0],[1200,21,1200,83,0],[1201,17,1201,18,0],[1202,13,1202,14,0],[1203,18,1203,47,1],[1204,13,1204,14,1],[1205,17,1205,64,1],[1206,17,1206,74,1],[1207,13,1207,14,1],[1208,9,1208,10,1],[1210,9,1210,10,1],[1211,13,1211,40,1],[1212,13,1212,14,0],[1213,17,1213,60,0],[1215,13,1215,14,0],[1216,13,1216,42,1],[1217,13,1217,14,1],[1218,17,1218,70,1],[1219,17,1219,70,1],[1221,13,1221,14,1],[1222,9,1222,10,1],[1224,9,1224,10,0],[1225,13,1225,30,0],[1226,13,1226,20,0],[1226,22,1226,53,0],[1226,54,1226,56,0],[1226,57,1226,67,0],[1227,13,1227,14,0],[1228,13,1228,14,0],[1229,9,1229,10,0],[1231,9,1231,10,0],[1232,13,1232,30,0],[1233,13,1233,20,0],[1233,22,1233,53,0],[1233,54,1233,56,0],[1233,57,1233,67,0],[1234,13,1234,14,0],[1235,13,1235,14,0],[1236,9,1236,10,0],[1239,9,1239,10,0],[1240,13,1240,64,0],[1241,13,1241,14,0],[1243,13,1243,14,0],[1244,9,1244,10,0],[1247,9,1247,10,0],[1249,13,1249,40,0],[1250,13,1250,14,0],[1251,17,1251,50,0],[1252,13,1252,14,0],[1253,9,1253,10,0],[1261,9,1261,10,0],[1262,13,1262,40,0],[1263,9,1263,10,0],[1265,9,1265,76,1],[1268,17,1268,18,1],[1268,19,1268,58,1],[1268,59,1268,60,1],[1274,13,1274,14,1],[1275,17,1277,95,1],[1278,17,1278,38,1],[1279,13,1279,14,1],[1285,13,1285,14,1],[1289,17,1290,135,1],[1292,13,1292,14,1],[1299,13,1299,14,1],[1300,17,1300,218,1],[1301,13,1301,14,1],[1306,17,1306,18,1],[1306,19,1306,36,1],[1306,37,1306,38,1],[1311,17,1311,18,0],[1311,19,1311,32,0],[1311,33,1311,34,0],[1316,17,1316,18,1],[1316,19,1316,65,1],[1316,66,1316,67,1],[1322,13,1322,14,1],[1323,17,1325,95,1],[1326,17,1326,27,1],[1327,13,1327,14,1],[1333,13,1333,14,1],[1334,17,1335,158,1],[1336,13,1336,14,1],[1340,9,1340,10,1],[1341,13,1341,42,1],[1342,9,1342,10,1],[1345,9,1345,10,0],[1346,13,1346,50,0],[1347,17,1347,106,0],[1348,13,1348,27,0],[1349,9,1349,10,0],[1362,9,1362,10,0],[1363,13,1363,34,0],[1364,13,1364,41,0],[1366,13,1366,64,0],[1367,13,1367,104,0],[1369,13,1369,63,0],[1370,13,1370,45,0],[1371,13,1371,44,0],[1372,13,1372,14,0],[1374,17,1374,62,0],[1375,13,1375,14,0],[1377,13,1377,14,0],[1378,17,1378,114,0],[1379,17,1379,58,0],[1380,21,1380,101,0],[1381,13,1381,14,0],[1387,13,1387,109,0],[1387,109,1387,116,0],[1387,116,1387,127,0],[1387,13,1387,127,0],[1389,13,1389,190,0],[1391,13,1391,73,0],[1394,13,1394,122,0],[1394,122,1394,129,0],[1394,129,1394,144,0],[1394,144,1394,214,0],[1394,214,1394,221,0],[1394,221,1394,223,0],[1394,144,1394,223,0],[1394,223,1394,234,0],[1394,13,1394,234,0],[1396,13,1396,20,0],[1396,22,1396,51,0],[1396,52,1396,54,0],[1396,55,1396,68,0],[1397,13,1397,14,0],[1398,17,1398,41,0],[1399,17,1399,57,0],[1400,17,1400,46,0],[1402,17,1402,78,0],[1404,17,1404,116,0],[1406,17,1406,78,0],[1408,17,1408,60,0],[1409,21,1409,75,0],[1410,13,1410,14,0],[1412,13,1412,50,0],[1413,17,1413,32,0],[1415,13,1415,14,0],[1416,17,1416,33,0],[1417,17,1417,86,0],[1418,17,1418,46,0],[1419,21,1419,214,0],[1421,21,1421,245,0],[1422,13,1422,14,0],[1425,13,1425,28,0],[1426,9,1426,10,0],[1429,9,1429,10,1],[1430,13,1430,38,1],[1431,13,1431,30,1],[1432,13,1432,26,1],[1434,13,1434,14,1],[1435,17,1435,184,1],[1436,21,1436,164,0],[1438,17,1438,98,1],[1439,17,1439,33,1],[1440,17,1440,18,1],[1441,21,1441,102,1],[1442,21,1442,22,0],[1443,25,1443,95,0],[1445,17,1445,18,1],[1448,17,1448,124,1],[1449,17,1449,109,1],[1450,17,1450,18,0],[1451,21,1451,62,0],[1452,21,1452,125,0],[1455,17,1455,97,1],[1456,17,1456,50,1],[1458,17,1458,49,1],[1459,21,1459,129,1],[1461,17,1461,51,1],[1463,17,1463,42,1],[1464,17,1464,18,0],[1467,21,1467,104,0],[1469,21,1469,87,0],[1470,25,1472,47,0],[1472,47,1475,82,0],[1475,82,1476,61,0],[1470,25,1476,61,0],[1479,25,1481,46,0],[1481,46,1484,86,0],[1484,86,1485,60,0],[1479,25,1485,60,0],[1488,21,1488,138,0],[1489,21,1489,22,0],[1490,25,1490,60,0],[1492,25,1492,139,0],[1493,29,1493,63,0],[1494,21,1494,22,0],[1496,17,1496,18,0],[1501,17,1501,65,1],[1502,17,1502,59,1],[1503,17,1503,83,1],[1504,17,1504,35,1],[1505,17,1505,35,1],[1508,17,1508,33,1],[1509,17,1509,18,1],[1510,21,1510,81,1],[1511,17,1511,18,1],[1512,17,1512,116,1],[1513,17,1513,59,1],[1514,17,1514,56,1],[1515,17,1515,60,1],[1516,17,1516,57,1],[1517,17,1517,45,1],[1518,21,1518,82,0],[1519,17,1519,38,1],[1520,17,1520,60,1],[1521,17,1521,45,1],[1522,17,1522,33,1],[1523,17,1523,18,1],[1524,21,1524,46,1],[1525,21,1525,43,1],[1526,17,1526,18,1],[1528,17,1528,18,0],[1529,21,1529,51,0],[1530,21,1530,48,0],[1531,17,1531,18,0],[1533,17,1533,112,1],[1535,17,1535,49,1],[1536,17,1536,18,1],[1540,21,1540,75,1],[1541,25,1541,131,0],[1543,21,1543,80,1],[1544,25,1544,142,0],[1546,21,1546,53,1],[1547,21,1547,22,1],[1548,25,1548,75,1],[1551,25,1551,68,1],[1553,25,1553,87,1],[1555,25,1555,32,1],[1555,34,1555,45,0],[1555,46,1555,48,1],[1555,49,1555,69,1],[1556,25,1556,26,0],[1557,29,1557,62,0],[1558,29,1558,68,0],[1559,29,1559,72,0],[1560,29,1560,66,0],[1561,29,1561,58,0],[1562,29,1562,74,0],[1563,29,1563,68,0],[1564,29,1564,91,0],[1565,29,1565,70,0],[1566,29,1566,66,0],[1567,29,1567,72,0],[1568,29,1568,68,0],[1569,29,1569,58,0],[1570,29,1570,53,0],[1571,25,1571,26,0],[1572,25,1572,76,1],[1573,25,1573,48,1],[1576,21,1576,22,1],[1578,21,1578,28,1],[1578,30,1578,37,0],[1578,38,1578,40,1],[1578,41,1578,58,1],[1579,21,1579,22,0],[1580,25,1580,49,0],[1581,25,1581,26,0],[1582,29,1582,69,0],[1583,29,1583,228,0],[1584,29,1584,30,0],[1585,33,1585,100,0],[1586,33,1586,95,0],[1587,33,1587,74,0],[1588,33,1588,99,0],[1589,33,1589,93,0],[1590,33,1590,92,0],[1591,33,1591,96,0],[1592,33,1592,86,0],[1594,33,1594,122,0],[1595,33,1595,48,0],[1596,37,1596,46,0],[1597,29,1597,30,0],[1598,25,1598,26,0],[1600,21,1600,22,0],[1604,21,1604,104,1],[1607,21,1607,28,1],[1607,30,1607,37,1],[1607,38,1607,40,1],[1607,41,1607,58,1],[1608,21,1608,22,1],[1609,25,1609,49,1],[1610,25,1610,26,1],[1611,29,1611,69,1],[1612,29,1612,92,1],[1613,29,1613,87,1],[1614,29,1614,66,1],[1615,29,1615,91,1],[1616,29,1616,78,1],[1618,29,1618,114,1],[1619,29,1619,44,1],[1620,33,1620,42,0],[1621,25,1621,26,1],[1623,21,1623,22,1],[1629,21,1629,74,1],[1630,21,1630,22,0],[1631,25,1631,78,0],[1632,25,1632,71,0],[1634,25,1634,68,0],[1635,25,1635,137,0],[1636,25,1636,72,0],[1637,25,1637,75,0],[1639,25,1639,32,0],[1639,34,1639,45,0],[1639,46,1639,48,0],[1639,49,1639,59,0],[1640,25,1640,26,0],[1641,29,1641,62,0],[1642,29,1642,52,0],[1643,29,1643,152,0],[1644,29,1644,79,0],[1645,29,1645,82,0],[1646,29,1646,53,0],[1647,25,1647,26,0],[1648,25,1648,32,0],[1648,34,1648,41,0],[1648,42,1648,44,0],[1648,45,1648,65,0],[1649,25,1649,26,0],[1650,29,1650,53,0],[1651,29,1651,30,0],[1652,33,1652,73,0],[1653,33,1653,66,0],[1654,33,1654,92,0],[1655,33,1655,81,0],[1656,33,1656,110,0],[1657,33,1657,98,0],[1658,33,1658,57,0],[1659,29,1659,30,0],[1660,25,1660,26,0],[1661,25,1661,79,0],[1662,25,1662,51,0],[1663,21,1663,22,0],[1668,21,1668,76,1],[1669,25,1669,123,0],[1676,21,1676,49,1],[1678,21,1678,89,1],[1679,25,1679,125,0],[1682,21,1682,28,1],[1682,30,1682,46,0],[1682,47,1682,49,1],[1682,50,1682,70,1],[1683,21,1683,22,0],[1684,25,1684,65,0],[1685,25,1685,82,0],[1687,25,1687,94,0],[1688,25,1688,26,0],[1689,29,1689,100,0],[1690,29,1690,64,0],[1691,29,1691,66,0],[1692,29,1692,106,0],[1693,29,1693,138,0],[1694,29,1695,66,0],[1697,29,1697,83,0],[1698,29,1698,30,0],[1699,33,1699,146,0],[1700,33,1700,40,0],[1700,42,1700,54,0],[1700,55,1700,57,0],[1700,58,1700,68,0],[1701,33,1701,34,0],[1702,37,1702,102,0],[1703,37,1703,38,0],[1705,41,1705,102,0],[1706,41,1707,73,0],[1708,37,1708,38,0],[1709,33,1709,34,0],[1710,29,1710,30,0],[1712,29,1712,117,0],[1713,29,1713,44,0],[1714,33,1714,42,0],[1715,25,1715,26,0],[1717,21,1717,22,0],[1721,21,1721,75,1],[1722,21,1722,84,1],[1723,21,1723,49,1],[1724,21,1724,22,1],[1725,25,1725,86,1],[1727,25,1727,132,1],[1728,25,1728,94,1],[1729,25,1729,32,1],[1729,34,1729,53,0],[1729,54,1729,56,1],[1729,57,1729,67,1],[1730,25,1730,26,0],[1731,29,1731,55,0],[1732,29,1732,36,0],[1732,38,1732,45,0],[1732,46,1732,48,0],[1732,49,1732,66,0],[1733,29,1733,30,0],[1734,33,1734,57,0],[1735,33,1735,34,0],[1736,37,1736,77,0],[1738,37,1738,128,0],[1739,37,1739,38,0],[1740,41,1740,61,0],[1741,41,1741,47,0],[1743,33,1743,34,0],[1745,29,1745,30,0],[1746,29,1746,74,0],[1747,33,1747,59,0],[1748,25,1748,26,0],[1749,25,1749,58,1],[1750,25,1750,32,1],[1750,34,1750,53,0],[1750,54,1750,56,1],[1750,57,1750,73,1],[1751,25,1751,26,0],[1752,29,1752,52,0],[1753,29,1753,67,0],[1754,25,1754,26,0],[1756,25,1756,63,1],[1757,25,1757,26,0],[1758,29,1758,107,0],[1759,25,1759,26,0],[1761,21,1761,22,1],[1763,21,1763,28,1],[1763,30,1763,37,0],[1763,38,1763,40,1],[1763,41,1763,60,1],[1764,21,1764,22,0],[1765,25,1765,49,0],[1766,25,1766,26,0],[1767,29,1767,60,0],[1768,29,1768,128,0],[1770,29,1770,106,0],[1771,29,1771,30,0],[1774,33,1774,110,0],[1775,33,1775,89,0],[1776,33,1776,91,0],[1777,33,1777,70,0],[1778,33,1779,82,0],[1781,33,1781,82,0],[1782,33,1782,34,0],[1783,37,1783,145,0],[1784,37,1784,44,0],[1784,46,1784,58,0],[1784,59,1784,61,0],[1784,62,1784,72,0],[1785,37,1785,38,0],[1786,41,1786,104,0],[1787,41,1787,42,0],[1788,45,1788,99,0],[1789,41,1789,42,0],[1790,37,1790,38,0],[1791,33,1791,34,0],[1793,33,1793,86,0],[1794,33,1794,34,0],[1795,37,1795,149,0],[1796,37,1796,44,0],[1796,46,1796,58,0],[1796,59,1796,61,0],[1796,62,1796,72,0],[1797,37,1797,38,0],[1798,41,1798,164,0],[1799,41,1799,42,0],[1800,45,1800,99,0],[1801,41,1801,42,0],[1802,37,1802,38,0],[1803,33,1803,34,0],[1805,33,1805,111,0],[1806,33,1806,48,0],[1807,37,1807,46,0],[1808,29,1808,30,0],[1809,34,1809,62,0],[1810,29,1810,30,0],[1813,33,1813,40,0],[1813,42,1813,61,0],[1813,62,1813,64,0],[1813,65,1813,89,0],[1813,89,1813,140,0],[1813,140,1813,141,0],[1813,65,1813,141,0],[1814,33,1814,34,0],[1815,37,1815,106,0],[1816,37,1816,59,0],[1817,37,1817,72,0],[1818,37,1818,74,0],[1819,37,1819,69,0],[1820,37,1820,78,0],[1821,37,1821,77,0],[1823,37,1823,111,0],[1824,37,1824,52,0],[1825,41,1825,50,0],[1826,33,1826,34,0],[1829,33,1829,128,0],[1830,29,1830,30,0],[1832,25,1832,26,0],[1834,21,1834,22,0],[1838,21,1838,97,1],[1839,21,1839,115,1],[1840,21,1840,59,1],[1841,21,1841,49,1],[1842,21,1842,82,1],[1843,21,1843,131,1],[1844,21,1844,119,1],[1845,21,1845,87,1],[1846,21,1846,143,1],[1847,21,1847,131,1],[1849,21,1849,116,1],[1850,21,1850,36,1],[1851,25,1851,34,0],[1853,21,1853,102,1],[1854,21,1854,130,1],[1855,21,1855,64,1],[1856,21,1856,59,1],[1857,21,1857,92,1],[1858,21,1858,146,1],[1859,21,1859,134,1],[1860,21,1860,97,1],[1861,21,1861,158,1],[1862,21,1862,146,1],[1864,21,1864,121,1],[1865,21,1865,36,1],[1866,25,1866,34,0],[1867,21,1867,71,1],[1868,21,1868,76,1],[1869,21,1869,88,1],[1870,21,1870,139,1],[1872,21,1872,65,1],[1873,21,1873,33,1],[1876,17,1876,18,0],[1877,21,1877,42,0],[1878,21,1878,48,0],[1879,21,1879,34,0],[1882,13,1882,33,0],[1883,13,1883,14,0],[1884,17,1884,38,0],[1886,17,1886,44,0],[1887,17,1887,30,0],[1889,9,1889,10,1],[1892,9,1892,10,0],[1893,13,1893,61,0],[1894,13,1894,14,0],[1895,22,1895,57,0],[1895,59,1895,72,0],[1895,74,1895,84,0],[1896,17,1896,18,0],[1897,21,1897,87,0],[1898,25,1898,66,0],[1899,17,1899,18,0],[1900,13,1900,14,0],[1901,9,1901,10,0],[1906,9,1906,10,0],[1908,9,1908,10,0],[1911,9,1911,10,0],[1913,9,1913,10,0],[1917,17,1917,18,1],[1917,19,1917,48,1],[1917,49,1917,50,1],[1923,13,1923,14,0],[1924,17,1924,47,0],[1925,13,1925,14,0],[1927,13,1927,14,0],[1929,13,1929,14,0],[1932,51,1932,55,0],[1932,56,1932,60,0],[1937,9,1937,10,1],[1938,13,1938,56,1],[1939,17,1939,101,0],[1941,17,1941,58,1],[1942,9,1942,10,1],[1945,9,1945,10,1],[1946,13,1946,88,1],[1948,13,1948,116,1],[1949,13,1949,14,0],[1950,17,1951,111,0],[1952,13,1952,14,0],[1953,9,1953,10,1],[1956,9,1956,10,1],[1957,13,1957,42,1],[1958,13,1958,77,1],[1960,13,1960,68,1],[1961,13,1961,63,1],[1962,13,1962,14,1],[1963,17,1963,113,1],[1965,17,1965,53,1],[1966,17,1966,18,1],[1967,21,1967,105,1],[1968,17,1968,18,1],[1969,13,1969,14,1],[1970,9,1970,10,1]]);
    </script>
  </body>
</html>