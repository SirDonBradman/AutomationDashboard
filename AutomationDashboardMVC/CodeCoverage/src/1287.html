<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\PROJECT\CopyProject.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.Script.Serialization;
using System.Web.UI.HtmlControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.DocumentManagementBL;
using Aurigo.AMP3.DocumentManagementDTO;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.ProjectBL;
using Aurigo.AMP3.ProjectDTO;
using Aurigo.AMP3.Resources.MessageResources;
using Aurigo.AMP3.Resources.TerminologyResources;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.Brix.Platform.BusinessLayer.XmlForm_Framework;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;

namespace Aurigo.AMP3.ProjectUI
{
    public partial class CopyProject : BrixPageBase, IXMLControl, IWorkflowEnabled
    {
        private int projectID;
        private int newProjectID;
        private UserDetail ud;
        private readonly ProjectManager blInstance = ProjectManager.Instance;
        private BrixFormModel model;
        private XMLFormManagerModel managerModel;
        private Dictionary&lt;string, string&gt; _uploadedModuleList;

        protected string _formkey = string.Empty;

        public string FormKey
        {
            get { return _formkey; }
        }

        #region IXMLControl Members

        public object[] ParentFormInstanceID
        {
            get { return new object[] { newProjectID }; }
        }

        public HtmlGenericControl XMLContainterDiv
        {
            get { return extDiv; }
            set { }
        }

        public void HandleInjectionSaveException(object model, Exception ex, string parentFormInstanceId)
        {
            try
            {
                if (managerModel != null)
                    managerModel.HandleInjectionSaveException((model as BrixFormModel), ex, parentFormInstanceId);
            }
            catch (Exception ex1)
            {
                throw ex1;
            }
        }


        public void HandleInjectionAfterSave(object model, string parentFormInstanceId)
        {
            try
            {
                if (managerModel != null)
                    managerModel.HandleInjectionAfterSave((model as BrixFormModel), parentFormInstanceId);
            }
            catch (Exception ex1)
            {
                throw ex1;
            }
        }

        public bool SkipDefaultXMLInjectionSave { get; set; }

        private void SetManagerModel()
        {
            model = BrixFormModel.GetInstance(&quot;XPRJCPY&quot;, &quot;XPRJCPY&quot;, Request, Response);
            //if (null != model &amp;&amp; null != model.form)
            //{
            //    model.form.GetHostValue += new Brix.Platform.BusinessLayer.XMLForm.GetVal(form_GetHostValue);
            //    model.form.GetHostGridValue += new Brix.Platform.BusinessLayer.XMLForm.GetValFromGrid(form_GetHostGridValue);
            //    model.form.SetHostValue += new Brix.Platform.BusinessLayer.XMLForm.SetVal(form_SetHostValue);
            //    model.form.SetHostGridValue += new Brix.Platform.BusinessLayer.XMLForm.SetValInGrid(form_SetHostGridValue);
            //}
            if (null != model &amp;&amp; null != model.form)
            {
                if (!string.IsNullOrEmpty(model.form.ManagerDLL) &amp;&amp; !string.IsNullOrEmpty(model.form.FormManagerClass))
                {
                    managerModel = AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(model.form.ManagerDLL,
                        model.form.FormManagerClass);
                    // managerModel.PageViewState = ViewState;
                }
            }
        }

        //object form_GetHostValue(string ctrlName, string fieldName, out string datatype, out string errors)
        //{
        //    datatype = null;
        //    errors = null;
        //    string strKey = ctrlName.ToLower();
        //    switch (strKey)
        //    {//case names should correspond to names used in project template/details form on which workflow is defined
        //        case &quot;projectname&quot;: return txtProjectName.Text;
        //        case &quot;projectid&quot;: return hdnProjectID.Value;
        //        case &quot;projectcode&quot;: return txtProjectCode.Text;
        //        case &quot;description&quot;: return txtDescription.Text;
        //        case &quot;templateid&quot;: return hdnTemplateID.Value;
        //        case &quot;owner&quot;: return txtProjectOwner.Text;
        //        case &quot;startdate&quot;: return wdcStartDate.Text;
        //        case &quot;enddate&quot;: return wdcEndDate.Text;
        //        case &quot;createdate&quot;: return wdcDateCreated.Text;
        //        case &quot;assetcategorydg&quot;: ControlContainer cc = xmlInjection.form.GetContainer(&quot;AssetCategoryDG&quot;);
        //            return null == cc || cc.ControlReference.Count &lt; 1 ? null : cc.ControlReference[0];
        //        default: return null;
        //    }
        //}
        //object form_GetHostGridValue(string gridName, string fieldName, string instance, string pid, string parentid, string parentmodule, out string datatype, out string errors)
        //{
        //    datatype = null;
        //    errors = null;
        //    object val = null;
        //    if (string.IsNullOrEmpty(gridName)) return null;
        //    if (gridName.ToLower() == &quot;dymgrdprojectextention&quot;)
        //    {
        //        val = xmlInjection.form.GetControl(fieldName).GetServerValue();
        //    }
        //    return val;
        //}
        //bool form_SetHostValue(string gridName, string fieldName, string datatype, object val, out string errors)
        //{
        //    errors = null;
        //    string strKey = gridName.ToLower();
        //    switch (strKey)
        //    {//case names should correspond to names used in project template/details form on which workflow is defined
        //        case &quot;projectname&quot;: txtProjectName.Text = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;projectid&quot;: hdnProjectID.Value = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;projectcode&quot;: txtProjectCode.Text = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;description&quot;: txtDescription.Text = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;templateid&quot;: hdnTemplateID.Value = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;owner&quot;: txtProjectOwner.Text = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;startdate&quot;: wdcStartDate.Value = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;enddate&quot;: wdcEndDate.Value = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;createdate&quot;: wdcDateCreated.Value = null == val ? &quot;&quot; : val.ToString(); break;
        //        case &quot;documentmetadata&quot;: if (!string.IsNullOrEmpty(val.ToString()))
        //            {
        //                ddlDocMetadata.Text = val.ToString(); ddlDocMetadata.SelectedValue = val.ToString();
        //            }
        //            break;
        //        case &quot;documenttemplate&quot;: if (!string.IsNullOrEmpty(val.ToString()))
        //            {
        //                ddlDocumentTemplate.Text = val.ToString(); ddlDocumentTemplate.SelectedValue = val.ToString();
        //            }
        //            break;
        //        case &quot;isactive&quot;: chkIsActive.Checked = null == val ? false : val.ToString().ToLower() == &quot;true&quot;; break;
        //        default: return false;
        //    }
        //    return true;
        //}
        //bool form_SetHostGridValue(string gridName, string fieldName, string instance, string pid, string parentid, string parentmodule, string datatype, object val, out string errors)
        //{
        //    errors = null;
        //    bool bIsSet = false;
        //    if (gridName.ToLower() == &quot;injection&quot; || gridName.ToLower() == &quot;dymgrdprojectextention&quot;)
        //    {
        //        xmlInjection.form.GetControl(fieldName).SetServerValue(val);
        //        bIsSet = true;
        //    }
        //    return bIsSet;
        //}

        #endregion

        protected override void OnPreInit(EventArgs e)
        {
            SetManagerModel();
            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            // set the list of permissions to be checked.
            PermissionsToCheck.AddRange(new string[] { Constants.MODFEAT_VISIBILITY, &quot;COPY&quot; });

            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.OnInit(model, args);
            base.OnInit(e);
        }

        protected override void CreateChildControls()
        {
            var menus = new MenuArray();
            menus.Add(new BrixMenu(&quot;lnkSave&quot;, &quot;Save&quot;, &quot;Icn_Save.png&quot;, 55));
            menus.Add(new BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));
            CreateToolBarMenu(menus, null);
        }

        bool IsProposedProject
        {
            get
            {
                return (HttpContext.Current.Request == null ||
                        string.IsNullOrEmpty(HttpContext.Current.Request.QueryString[&quot;PP&quot;])
                    ? false
                    : (HttpContext.Current.Request.QueryString[&quot;PP&quot;] == &quot;1&quot;) ? true : false);
            }
        }

        private Dictionary&lt;string, string&gt; UploadedModuleList
        {
            get
            {
                if (_uploadedModuleList == null)
                    _uploadedModuleList = ModuleManager.Instance.GetModuleList();
                return _uploadedModuleList;
            }
        }

        protected override void CustomizeToolBar()
        {
            if (MainToolBar.GetMenuReference(&quot;lnkSave&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).CausesValidation = true;
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).OnClientClick =
                    &quot;if(typeof Page_ClientValidate == \&quot;function\&quot;) { try { var ret=Page_ClientValidate(); if(!ret) { Page_BlockSubmit = false; return ret; } } catch(ex){} } return true;&quot;;
                MainToolBar.GetMenuReference(&quot;lnkSave&quot;).Click += btnCopyProject_Click1;
            }
            if (MainToolBar.GetMenuReference(&quot;lnkCancel&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).PostBackUrl =
                    ResolveUrl(
                        BuildURL((IsProposedProject)
                            ? &quot;~/Common/BrixListPage.aspx?Context=PROJECT&amp;PP=1&quot;
                            : &quot;~/Common/BrixListPage.aspx?Context=PROJECT&quot;));
            }

            XmlFormArgs args = new XmlFormArgs();
            if (managerModel != null)
                managerModel.AfterCustomizeToolbar(model, MainToolBar, args);
        }

        /// &lt;summary&gt;
        /// &lt;remarks&gt;
        /// Author : Kalyan Chakradhar R.
        /// This receives the projectId from the request object passed from either details/projectlist page 
        /// and stores it in a hidden variable and displays it.
        /// &lt;/remarks&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                ud = UserDetail.GetCurrentUserDetail();

                UIHelper.DisableRoleSelection(Page);

                //setting default button for the page
                var myForm = (HtmlForm)Page.Master.FindControl(&quot;form1&quot;);
                myForm.DefaultButton = btnCopyProject.UniqueID;

                var featurelist = (List&lt;string&gt;)Context.Items[Constants.MODULE_PERMISSIONS];

                if (!featurelist.Contains(&quot;Copy&quot;))
                    UIHelper.RedirectURL(
                        &quot;The current role does not have the required permissions to view this page.&quot;,
                        ResolveUrl(Constants.URL_ENTERPRISE), null, Context);

                if (String.IsNullOrEmpty(Request.QueryString[Constants.QRY_PROJECTID])
                    || !int.TryParse(Request.QueryString[Constants.QRY_PROJECTID], out projectID)
                    )
                {
                    UIHelper.RedirectURL(&quot;Error loading the requested page.&quot;,
                        (IsProposedProject)
                            ? ResolveUrl(Constants.URL_PROJECTS) + &quot;&amp;PP=1&quot;
                            : ResolveUrl(Constants.URL_PROJECTS), null, Context);
                }

                Project dtProject = ProjectManager.Instance.GetProjectDetails(projectID);
                txtSourceProjectName.Text = dtProject.ProjectName;
                txtSourceProjectCode.Text = dtProject.ProjectCode;

                if (AMP3ApplicationSettings.Instance.IsSingleProjectMode)
                {
                    lblModule.Style.Add(&quot;display&quot;, &quot;none;&quot;);
                    chkModules.Style.Add(&quot;display&quot;, &quot;none;&quot;);
                }

                List&lt;string&gt; projectComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_PROJECT);
                // For BYU hide project attributes and status
                if (!projectComponents.Contains(&quot;ShowProjectAttributes&quot;))
                {
                    txtAttributes.Style.Add(&quot;display&quot;, &quot;none;&quot;);
                    chkAttributes.Style.Add(&quot;display&quot;, &quot;none;&quot;);
                }

                ShowHideCopy();
                lblProjectName.Text = &quot; Source &quot; + LocalizationManager.GetString(&quot;Project&quot;) + &quot; Name :&quot;;
                lblProjectCode.Text = &quot; Source &quot; + LocalizationManager.GetString(&quot;Project&quot;) + &quot; Code :&quot;;
                lblNewProjectName.Text = &quot; New &quot; + LocalizationManager.GetString(&quot;Project&quot;) + &quot; Name :&quot;;
                lblNewProjectCode.Text = &quot; New &quot; + LocalizationManager.GetString(&quot;Project&quot;) + &quot; Code :&quot;;
                revProjectName.ErrorMessage = LocalizationManager.GetString(&quot;Project&quot;) +
                                              &quot; Name cannot contain the following characters: | ^&quot;;
                revProjectCode.ErrorMessage = &quot;Space is not allowed in &quot; + LocalizationManager.GetString(&quot;Project&quot;) +
                                              &quot; Code&quot;;
                rfvProjectCode.ErrorMessage = &quot;New &quot; + LocalizationManager.GetString(&quot;Project&quot;) + &quot; Code is required.&quot;;
                XmlFormArgs args = new XmlFormArgs();
                if (managerModel != null)
                    managerModel.OnPageLoad(model, args);
            }
            catch (Exception err)
            {
                lblException.Text = err.ToString2();
            }

            PageTitle = &quot;Copy &quot; + LocalizationManager.GetString(&quot;Project&quot;);
        }

        private void ShowHideCopy()
        {
            if (AMP3ApplicationSettings.Instance.IsSingleProjectMode)
            {
                List&lt;Platform&gt; platforms =
                    ProjectManager.Instance.GetProjectModules(Request.QueryString[Constants.QRY_PROJECTID].ToInt32_2());
                bool hasContract = false;
                bool hasEstimate = false;

                platforms.ForEach(
                    platform =&gt;
                    {
                        if (!hasContract &amp;&amp; platform.ModuleId == Constants.MODID_CONTMGT)
                            hasContract = true;
                        if (!hasEstimate &amp;&amp; platform.ModuleId == Constants.MODID_ESTMATE)
                            hasEstimate = true;
                    });
                trContract.Style.Add(&quot;display&quot;, hasContract ? &quot;table-row&quot; : &quot;none&quot;);
                trEstimate.Style.Add(&quot;display&quot;, hasEstimate ? &quot;table-row&quot; : &quot;none&quot;);
            }
            else
            {
                trContract.Style.Add(&quot;display&quot;, &quot;none&quot;);
                trEstimate.Style.Add(&quot;display&quot;, &quot;none&quot;);
            }
            List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_FNDMGMT);
            if (!IsPostBack &amp;&amp; ModuleComponents != null &amp;&amp;
                ((ModuleComponents.Contains(&quot;FUNDESTMATE&quot;)) || (ModuleComponents.Contains(&quot;FUNDCONTMGT&quot;)) ||
                 (ModuleComponents.Contains(&quot;FUNDBDGTEST&quot;))))
            {
                trFunds.Visible = true;
                chkFunds.Checked = true;
            }
        }

        /// &lt;summary&gt;
        /// This fires when the copy project button is clicked.
        /// This calls the BL and returns an integer based on the result of the Copy operation
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void btnCopyProject_Click1(object sender, EventArgs e)
        {
            WorkflowEnabledSaveHandler();
        }

        private string BuildURL(string url)
        {
            return UIHelper.BuildURL(url, new List&lt;string&gt; { &quot;pid&quot;, &quot;nt&quot; }, HttpContext.Current);
        }

        #region IWorkflowEnabled

        public bool IsOldWorkflow
        {
            get { return true; }
        }

        public new string FormInstanceId
        {
            get { return (!string.IsNullOrEmpty(hdnID.Value) ? hdnID.Value : &quot;-1&quot;); }
        }

        //Need to create this later
        public string FormName
        {
            get { return &quot;XPRJCPY&quot;; }
        }


        public string ClientValidationFunction
        {
            get
            {
                return
                    &quot;if(typeof Page_ClientValidate == \&quot;function\&quot;) { try { var ret=Page_ClientValidate(); if(!ret) return ret; } catch(ex){} } return true;&quot;;
            }
        }

        public int ParentModuleId
        {
            get { return 0; }
        }

        public int PID
        {
            get { return 0; }
        }

        public string PostCancelRedirectUrl
        {
            get
            {
                return
                    BuildURL((IsProposedProject)
                        ? &quot;~/Common/BrixListPage.aspx?context=PROJECT&amp;PP=1&quot;
                        : &quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;);
            }
        }

        void SimulateProjectWorkflow(string SourceProjectName, int ProjectID, string ProjectName)
        {
            try
            {
                int InstanceID = ProjectID;
                var sParams = new string[] { };
                int UserId = 1;
                UserDetail ud = UserDetail.GetCurrentUserDetail();
                UserId = ud.UID;
                string strWorkflowInstanceGuid = &quot;&quot;;

                StartWorkflowInstancesFor.SimulateWorkflowAction(true, false, &quot;XPROJCT&quot;, InstanceID.ToString(), &quot;0&quot;, &quot;0&quot;,
                    &quot;Project Created through Copy&quot;, &quot;None&quot;, UserId, &quot;&quot;, sParams);
                // Update formkey for My Tasks.
                ComponentHelper.Instance.ExecuteNonQuery(
                    string.Format(
                        &quot;UPDATE WorkflowFormMapping SET FormKey = &#39;Project Name : {0}&#39; WHERE FormID=&#39;XPROJCT&#39; AND FormInstanceID = {1}&quot;,
                        ProjectName, ProjectID));

                model = new BrixFormModel(XMLForms.GetXMLFormModuleID(&quot;XPROJCT&quot;), &quot;XPROJCT&quot; + &quot;.xml&quot;, XMLType.Form, null,
                    null);
                string sPid = ProjectID.ToString();
                string sParentMod = model.form.ParentModuleID;
                string refInfo = &quot;Created from Project: &quot; + SourceProjectName + &quot;, &quot;;
                string userInfo = &quot;Created By: &quot;;
                userInfo += ud.UserName;
                refInfo += userInfo;

                DataSet ds =
                    ComponentHelper.Instance.ExecuteDataSet(&quot;select dbo.fn_GetWorkflowInstanceGuid(&#39;XPROJCT&#39;,{0}) as &#39;WorkflowGUID&#39;&quot;, InstanceID);
                if (ds != null &amp;&amp; ds.Tables.Count &gt; 0)
                    strWorkflowInstanceGuid = ds.Tables[0].Rows[0][&quot;WorkflowGUID&quot;].ToString();

                if (!string.IsNullOrEmpty(strWorkflowInstanceGuid))
                    BrixWorkflowManager.Instance.CreateWorkflowNotes(0, refInfo, &quot;Project Created through Copy&quot;,
                        UserId, null, strWorkflowInstanceGuid, DateTime.UtcNow);
                else
                    BrixWorkflowManager.Instance.CreateFormNotes(Convert.ToInt32(InstanceID), refInfo, UserId,
                        model.form.ModuleID);
            }
            catch (Exception)
            {
            }
        }

        public bool SaveHandler(object sender, out string sSavedInstanceToken, out string sErrors,
            out string sRedirectTo)
        {
            try
            {
                sSavedInstanceToken = sErrors = sRedirectTo = string.Empty;
                XmlFormArgs args = new XmlFormArgs();
                if (managerModel != null)
                    managerModel.BeforeSave(model, args);
                if (managerModel == null || args.IsValid)
                {
                    try
                    {
                        if (!string.IsNullOrEmpty(ConnectionHelper.GetCurrentCompany()) &amp;&amp;
                            ProjectManager.Instance.GetAllProjectCount() &gt;=
                            CompanyManager.Instance.GetCurrentCompanyDetails().ProjectLimit)
                        {
                            //ClientScript.RegisterStartupScript(GetType(), &quot;Alert&quot;,
                            //                                              &quot;&lt;script&gt;alert(&#39;Please upgrade to create more projects&#39;);&lt;/script&gt;&quot;);
                            throw new Exception(&quot;Please upgrade to create more projects.&quot;);
                        }
                        else
                        {
                            if (Regex.IsMatch(txtNewProjectCode.Text.Trim(), @&quot;[\^|]&quot;))
                            {
                                //ClientScript.RegisterStartupScript(GetType(), &quot;Alert&quot;,
                                //                                           &quot;&lt;script&gt;alert(&#39;Project Code cannot contain the following characters: ^ |&#39;);&lt;/script&gt;&quot;);
                                throw new Exception(LocalizationManager.GetString(&quot;Project Code&quot;) +
                                                    &quot; cannot contain the following characters: ^ |&#39;.&quot;);
                            }
                            else
                            {
                                int rtnValue =
                                    ProjectManager.Instance.CopyProject(projectID,
                                        txtNewProjectName.Text.ToString2(),
                                        txtNewProjectCode.Text.ToString2(), txtDescription.Text, ((AMP3ApplicationSettings.Instance.IsSingleProjectMode) ? true : chkModules.Checked),
                                        chkAttributes.Checked, chkUsers.Checked, ud.UID, ud.RID);

                                if (rtnValue &gt; 0) //ProjectID
                                {
                                    sSavedInstanceToken = hdnID.Value = rtnValue.ToString();
                                    newProjectID = rtnValue;
                                    Project dtoProject = blInstance.GetProjectDetails(rtnValue);
                                    _formkey = string.Format(&quot;Project Name : {0}&quot;, dtoProject.ProjectName);
                                    dtoProject.DocumentListID =
                                        DocumentManager.Instance.CreateDocumentList(
                                            &quot;{0}-{1}&quot;.Format2(dtoProject.ProjectName, dtoProject.ProjectCode),
                                            &quot;Project Documents&quot;);
                                    // Modify newly added columns AUR_ModifiedOn,AUR_ModifiedBy
                                    dtoProject.ModifiedBy = ud.FirstName + &quot; &quot; + ud.LastName;
                                    dtoProject.ModifiedOn = DateTime.UtcNow;
                                    blInstance.UpdateProject(dtoProject, ud.UID, ud.RID);
                                    DocumentManager.Instance.AddFolder(new Folder()
                                    {
                                        ParentId = 0,
                                        FolderName = &quot;Documents&quot;,
                                        FolderDesc = &quot;Project Documents&quot;,
                                        ModuleId = &quot;PROJECT&quot;,
                                        InstanceId = dtoProject.ProjectID.ToString(),
                                        ListID = dtoProject.DocumentListID,
                                        ListPath = &quot;&quot;,
                                        CreateSharePointFolder = false
                                    });
                                    Folder ProjFolder =
                                        DocumentManager.Instance.GetInstanceRootFolder(dtoProject.ProjectID, &quot;PROJECT&quot;);
                                    DocumentManager.Instance.RenameDocumentList(ProjFolder.ListID,
                                        &quot;{0}-{1}&quot;.Format2(dtoProject.ProjectName, dtoProject.ProjectCode),
                                        &quot;Project Documents&quot;);
                                    // if the project was created successfully then instantiate the document tree for the project based
                                    // on the selected document template
                                    if (dtoProject.DocumentTemplateID.HasValue &amp;&amp; dtoProject.DocumentTemplateID &gt; 0)
                                        DocumentManager.Instance.InstantiateDocumentTemplate(ProjFolder,
                                            dtoProject.DocumentTemplateID.Value);

                                    //If the project is created and if a document metadata is selected, then copy the xml from the Form builder folder to the 
                                    // project folder under Modules/PROJECT/XMLControls/
                                    if (dtoProject.DocumentMetadataID.HasValue &amp;&amp;
                                        dtoProject.DocumentMetadataID.Value &gt; 0)
                                    {
                                        DataRow dr =
                                            DocumentManager.Instance.GetDocumentMetadataByID(
                                                dtoProject.DocumentMetadataID.Value.ToString());
                                        if (dr != null)
                                        {
                                            string selectedMetadata =
                                                dr[&quot;ValueField&quot;].ToString().Split(&quot;&amp;&amp;&quot;.ToCharArray())[0];
                                            string filePath = HttpRuntime.BinDirectory + &quot;../Modules/FRMBLDR/XMLForms/&quot; +
                                                              ConnectionHelper.GetCurrentCompany() + &quot;XF&quot; +
                                                              selectedMetadata + &quot;.xml&quot;;
                                            XMLFileIO.Instance.ConvertStreamToFile(
                                                XMLFileIO.Instance.GetXML(selectedMetadata, selectedMetadata + &quot;.xml&quot;,
                                                    XMLType.Control, false),
                                                filePath);

                                            bool fileExists = File.Exists(filePath);
                                            if (fileExists)
                                            {
                                                string projId = newProjectID.ToString(&quot;D4&quot;);
                                                XMLFileIO.Instance.StoreXML(&quot;PROJECT&quot;, filePath, &quot;PRJ&quot; + projId + &quot;.xml&quot;,
                                                    XMLType.Control, false);
                                                File.Delete(filePath);
                                            }
                                        }
                                    }

                                    List&lt;string&gt; lst = new List&lt;string&gt;() { &quot;CONTMGT&quot;, &quot;ESTMATE&quot;, &quot;LANDMGT&quot; };
                                    foreach (string lstModuleID in lst)
                                        DocumentManager.Instance.CreateFolderForModule(lstModuleID, &quot;PROJECT&quot;,
                                            dtoProject.ProjectID);

                                    Dictionary&lt;string, Type&gt; dicObj = AfterSaveRecordModel.GetModelObjects();

                                    foreach (KeyValuePair&lt;string, Type&gt; kvp in dicObj)
                                    {
                                        try
                                        {
                                            AfterSaveRecordModel asmodel = AfterSaveRecordModel.GetInstance(kvp.Key);
                                            if (asmodel != null)
                                            {
                                                Dictionary&lt;string, object&gt; data = new Dictionary&lt;string, object&gt;();
                                                data.Add(&quot;ProjectDTO&quot;, dtoProject);
                                                data.Add(&quot;SourceProjectID&quot;, projectID);
                                                data.Add(&quot;EstimateData&quot;,
                                                    chkEstimateAll.Checked + &quot;&amp;&quot; + chkEstimateItems.Checked + &quot;&amp;&quot; +
                                                    chkEstimateBids.Checked);
                                                data.Add(&quot;ContractData&quot;,
                                                    chkContractAll.Checked + &quot;&amp;&quot; + chkContractItems.Checked + &quot;&amp;&quot; +
                                                    chkContractContractors.Checked);
                                                data.Add(&quot;CopyFund&quot;, chkFunds.Checked);
                                                asmodel.SaveDetails(data, this.Page, &quot;&quot;, &quot;COPY_PROJECT&quot;);
                                            }
                                        }
                                        catch (Exception)
                                        {
                                        }
                                    }

                                    bool IsWorkflowAssociated =
                                        BrixWorkflowManager.Instance.IsWorkflowAssociated(&quot;XPROJCT&quot;,
                                            projectID.ToString(), &quot;0&quot;);
                                    //Project Simulate Workflow                                   
                                    if (IsWorkflowAssociated)
                                        SimulateProjectWorkflow(txtSourceProjectName.Text, dtoProject.ProjectID,
                                            dtoProject.ProjectName);

                                    if (newProjectID &gt; 0)
                                    {
                                        //base.BrixPageBase_SaveXMLInjectionData(sender, e);

                                        if (managerModel != null)
                                            managerModel.AfterSave(model, args);
                                    }

                                    //Response.Redirect(BuildURL(&quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;), true);
                                }
                                else
                                {
                                    switch (rtnValue)
                                    {
                                        case -1:
                                            ClientScript.RegisterStartupScript(GetType(), &quot;Alert&quot;,
                                                &quot;&lt;script&gt;ShowError(&#39;&quot; +
                                                MessageResourceManager.GetString(
                                                    &quot;W_PROJECT_NAME_ALREADY_EXISTS&quot;,
                                                    Enumerations.MessageType.WarningMessage) +
                                                &quot;&#39;);&lt;/script&gt;&quot;);
                                            //throw new Exception(MessageResourceManager.GetString(
                                            //                                       &quot;W_PROJECT_NAME_ALREADY_EXISTS&quot;,
                                            //                                       Enumerations.MessageType.WarningMessage));
                                            break;

                                        case -2:
                                            ClientScript.RegisterStartupScript(GetType(), &quot;Alert&quot;,
                                                &quot;&lt;script&gt;ShowError(&#39;&quot; +
                                                MessageResourceManager.GetString(
                                                    &quot;W_PROJECT_CODE_NAME_ALREADY_EXISTS&quot;,
                                                    Enumerations.MessageType.WarningMessage) +
                                                &quot;&#39;);&lt;/script&gt;&quot;);
                                            break;
                                        //throw new Exception(MessageResourceManager.GetString(
                                        //                                       &quot;W_PROJECT_CODE_NAME_ALREADY_EXISTS&quot;,
                                        //                                       Enumerations.MessageType.WarningMessage));
                                        case -3:
                                            ClientScript.RegisterStartupScript(GetType(), &quot;Alert&quot;,
                                                &quot;&lt;script&gt;ShowError(&#39;&quot; +
                                                MessageResourceManager.GetString(
                                                    &quot;E_PROJECT_COPYING_PROJECT&quot;,
                                                    Enumerations.MessageType.ErrorMessage) +
                                                &quot;&#39;);&lt;/script&gt;&quot;);
                                            break;
                                            //throw new Exception(MessageResourceManager.GetString(
                                            //                                       &quot;E_PROJECT_COPYING_PROJECT&quot;,
                                            //                                       Enumerations.MessageType.ErrorMessage));
                                    }
                                }
                            }
                        }
                    }
                    catch (Exception err)
                    {
                        sErrors = err.Message;
                        sSavedInstanceToken = &quot;-1&quot;;
                        sRedirectTo = string.Empty;
                        lblException.Text = err.ToString2();
                        return false;
                    }
                    return true;
                }
                else
                {
                    sErrors = args.ErrorMessage;
                    sSavedInstanceToken = &quot;-1&quot;;
                    sRedirectTo = string.Empty;
                    lblException.Text = args.ErrorMessage;
                    return false;
                }
            }
            catch (Exception ex)
            {
                JavaScriptSerializer JS = new JavaScriptSerializer();
                sErrors = ex.Message;
                sSavedInstanceToken = &quot;-1&quot;;
                sRedirectTo = string.Empty;
                ClientScript.RegisterStartupScript(GetType(), &quot;Alert&quot;,
                    &quot;&lt;script&gt;ShowError(&quot; + JS.Serialize(sErrors) +
                    &quot;);&lt;/script&gt;&quot;);
                // lblException.Text = ex.ToString2();
                return false;
            }
        }

        public void CancelHandler(object sender, bool bAfterSave, out string sRedirectTo)
        {
            sRedirectTo = &quot;&quot;;
            return;
        }

        public string PostSaveRedirectUrl(string sSavedToken = &quot;&quot;)
        {
            //check if planning module exists and redirect accordingly
            return
                   BuildURL(UploadedModuleList.ContainsKey(Constants.MODID_PLANING)
                       ? &quot;~/Common/BrixListPage.aspx?context=PROJECT&amp;PP=1&quot;
                       : &quot;~/Common/BrixListPage.aspx?context=PROJECT&quot;);
        }


        #endregion IWorkflowEnabled
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[34,9,34,78,1],[39,9,39,50,1],[43,17,43,18,1],[43,19,43,35,1],[43,36,43,37,1],[50,17,50,18,1],[50,19,50,56,1],[50,57,50,58,1],[55,17,55,18,0],[55,19,55,33,0],[55,34,55,35,0],[56,17,56,18,0],[56,19,56,20,0],[60,9,60,10,0],[62,13,62,14,0],[63,17,63,42,0],[64,21,64,115,0],[65,13,65,14,0],[66,13,66,34,0],[67,13,67,14,0],[68,17,68,27,0],[70,9,70,10,0],[74,9,74,10,0],[76,13,76,14,0],[77,17,77,42,0],[78,21,78,107,0],[79,13,79,14,0],[80,13,80,34,0],[81,13,81,14,0],[82,17,82,27,0],[84,9,84,10,0],[86,51,86,55,0],[86,56,86,60,0],[89,9,89,10,1],[90,13,90,88,1],[98,13,98,53,1],[99,13,99,14,1],[100,17,100,120,1],[101,17,101,18,0],[102,21,103,54,0],[105,17,105,18,0],[106,13,106,14,1],[107,9,107,10,1],[187,9,187,10,1],[188,13,188,31,1],[189,13,189,31,1],[190,9,190,10,1],[193,9,193,10,1],[195,13,195,96,1],[197,13,197,50,1],[198,13,198,38,1],[199,17,199,50,0],[200,13,200,28,1],[201,9,201,10,1],[204,9,204,10,1],[205,13,205,41,1],[206,13,206,76,1],[207,13,207,82,1],[208,13,208,44,1],[209,9,209,10,1],[214,13,214,14,1],[215,17,218,94,1],[219,13,219,14,1],[225,13,225,14,1],[226,17,226,49,1],[227,21,227,82,1],[228,17,228,44,1],[229,13,229,14,1],[233,9,233,10,1],[234,13,234,65,1],[235,13,235,14,1],[236,17,236,81,1],[237,17,238,189,1],[239,17,239,88,1],[240,13,240,14,1],[241,13,241,67,1],[242,13,242,14,1],[243,17,243,84,1],[244,17,248,78,1],[249,13,249,14,1],[251,13,251,50,1],[252,13,252,38,1],[253,17,253,78,0],[254,9,254,10,1],[266,9,266,10,1],[268,13,268,14,1],[269,17,269,56,1],[271,17,271,53,1],[274,17,274,73,1],[275,17,275,64,1],[277,17,277,93,1],[279,17,279,51,1],[280,21,282,78,0],[284,17,286,22,1],[287,17,287,18,0],[288,21,291,82,0],[292,17,292,18,0],[294,17,294,90,1],[295,17,295,67,1],[296,17,296,67,1],[298,17,298,74,1],[299,17,299,18,1],[300,21,300,61,1],[301,21,301,62,1],[302,17,302,18,1],[304,17,304,119,1],[306,17,306,74,1],[307,17,307,18,0],[308,21,308,65,0],[309,21,309,65,0],[310,17,310,18,0],[312,17,312,32,1],[313,17,313,105,1],[314,17,314,105,1],[315,17,315,105,1],[316,17,316,105,1],[317,17,318,100,1],[319,17,320,55,1],[321,17,321,120,1],[322,17,322,54,1],[323,17,323,42,1],[324,21,324,58,0],[325,13,325,14,1],[326,13,326,34,0],[327,13,327,14,0],[328,17,328,53,0],[329,13,329,14,0],[331,13,331,76,1],[332,9,332,10,1],[335,9,335,10,1],[336,13,336,70,1],[337,13,337,14,1],[338,17,339,121,1],[340,17,340,42,1],[341,17,341,42,1],[343,17,345,21,1],[345,21,345,22,1],[345,22,346,25,1],[346,25,346,90,1],[346,90,347,29,1],[347,29,347,48,1],[347,48,348,25,1],[348,25,348,90,1],[348,90,349,29,1],[349,29,349,48,1],[349,48,350,21,1],[350,21,350,22,1],[350,22,350,24,1],[343,17,350,24,1],[351,17,351,85,1],[352,17,352,85,1],[353,13,353,14,1],[355,13,355,14,0],[356,17,356,57,0],[357,17,357,57,0],[358,13,358,14,0],[359,13,359,114,1],[360,13,362,62,1],[363,13,363,14,1],[364,17,364,40,1],[365,17,365,41,1],[366,13,366,14,1],[367,9,367,10,1],[376,9,376,10,1],[377,13,377,42,1],[378,9,378,10,0],[381,9,381,10,1],[382,13,382,98,1],[383,9,383,10,1],[389,17,389,18,0],[389,19,389,31,0],[389,32,389,33,0],[394,17,394,18,1],[394,19,394,84,1],[394,85,394,86,1],[400,17,400,18,1],[400,19,400,36,1],[400,37,400,38,1],[407,13,407,14,0],[408,17,409,159,0],[410,13,410,14,0],[415,17,415,18,1],[415,19,415,28,1],[415,29,415,30,1],[420,17,420,18,1],[420,19,420,28,1],[420,29,420,30,1],[426,13,426,14,0],[427,17,430,73,0],[431,13,431,14,0],[435,9,435,10,1],[437,13,437,14,1],[438,17,438,44,1],[439,17,439,48,1],[440,17,440,32,1],[441,17,441,67,1],[442,17,442,33,1],[443,17,443,53,1],[445,17,446,82,1],[448,17,451,50,1],[453,17,454,27,1],[455,17,455,52,1],[456,17,456,63,1],[457,17,457,86,1],[458,17,458,50,1],[459,17,459,41,1],[460,17,460,37,1],[462,17,463,147,1],[464,17,464,55,1],[465,21,465,95,1],[467,17,467,68,1],[468,21,469,81,1],[471,21,472,46,0],[473,13,473,14,1],[474,13,474,30,0],[475,13,475,14,0],[476,13,476,14,0],[477,9,477,10,1],[481,9,481,10,1],[483,13,483,14,1],[484,17,484,76,1],[485,17,485,54,1],[486,17,486,42,1],[487,21,487,58,0],[488,17,488,58,1],[489,17,489,18,1],[491,21,491,22,1],[492,25,494,93,1],[495,25,495,26,0],[498,29,498,92,0],[501,25,501,26,1],[502,29,502,88,1],[503,29,503,30,0],[506,33,507,104,0],[510,29,510,30,1],[511,33,515,98,1],[517,33,517,50,1],[518,33,518,34,1],[519,37,519,93,1],[520,37,520,61,1],[521,37,521,97,1],[522,37,522,108,1],[523,37,526,66,1],[528,37,528,94,1],[529,37,529,77,1],[530,37,530,90,1],[531,37,541,40,1],[542,37,543,121,1],[544,37,546,62,1],[549,37,549,117,1],[550,41,551,82,1],[555,37,556,81,1],[557,37,557,38,0],[558,41,560,97,0],[561,41,561,56,0],[562,41,562,42,0],[563,45,564,106,0],[565,45,567,89,0],[568,45,571,59,0],[573,45,573,85,0],[574,45,574,60,0],[575,45,575,46,0],[576,49,576,93,0],[577,49,578,77,0],[579,49,579,71,0],[580,45,580,46,0],[581,41,581,42,0],[582,37,582,38,0],[584,37,584,111,1],[585,37,585,44,1],[585,46,585,64,1],[585,65,585,67,1],[585,68,585,71,1],[586,41,587,67,1],[589,37,589,110,1],[591,37,591,44,1],[591,46,591,76,1],[591,77,591,79,1],[591,80,591,86,1],[592,37,592,38,1],[594,41,594,42,1],[595,45,595,118,1],[596,45,596,65,1],[597,45,597,46,1],[598,49,598,116,1],[599,49,599,84,1],[600,49,600,88,1],[601,49,603,78,1],[604,49,606,85,1],[607,49,607,88,1],[608,49,608,106,1],[609,45,609,46,1],[610,41,610,42,1],[611,41,611,58,0],[612,41,612,42,0],[613,41,613,42,0],[614,37,614,38,1],[616,37,618,72,1],[620,37,620,62,1],[621,41,622,69,1],[624,37,624,58,1],[625,37,625,38,1],[628,41,628,66,1],[629,45,629,81,0],[630,37,630,38,1],[633,33,633,34,1],[635,33,635,34,0],[636,37,636,54,0],[639,45,644,65,0],[648,45,648,51,0],[651,45,656,65,0],[657,45,657,51,0],[662,45,667,65,0],[668,45,668,51,0],[673,33,673,34,0],[674,29,674,30,1],[675,25,675,26,1],[676,21,676,22,1],[677,21,677,42,0],[678,21,678,22,0],[679,25,679,47,0],[680,25,680,52,0],[681,25,681,52,0],[682,25,682,61,0],[683,25,683,38,0],[685,21,685,33,1],[688,17,688,18,0],[689,21,689,49,0],[690,21,690,48,0],[691,21,691,48,0],[692,21,692,59,0],[693,21,693,34,0],[696,13,696,33,0],[697,13,697,14,0],[698,17,698,70,0],[699,17,699,38,0],[700,17,700,44,0],[701,17,701,44,0],[702,17,704,36,0],[706,17,706,30,0],[708,9,708,10,1],[711,9,711,10,0],[712,13,712,30,0],[713,13,713,20,0],[714,9,714,10,0],[717,9,717,10,1],[719,13,722,72,1],[723,9,723,10,1]]);
    </script>
  </body>
</html>