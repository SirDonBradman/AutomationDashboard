<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Common\ChangeLog.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DTO;
using Aurigo.Brix.Platform.BusinessLayer.XmlForm_Framework;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.Brix.Platform.UI.Common
{
    [Serializable]
    public partial class ChangeLog : BrixPageBase
    {
        ChangeLogDTO info;
        List&lt;string&gt; HiddenColumns;
        List&lt;string&gt; AllColumns;
        List&lt;string&gt; SysColumns;

        BrixFormModel xmlModel = null;

        private string ModifiedBy
        {
            get { return &quot;AUR_ModifiedBy&quot;; }
        }

        private string ModifiedOn
        {
            get { return &quot;AUR_ModifiedOn&quot;; }
        }

        protected override void OnPreInit(EventArgs e)
        {
            if (!string.IsNullOrEmpty(Request.QueryString[&quot;xContext&quot;]) ||
                !string.IsNullOrEmpty(Request.QueryString[&quot;Context&quot;]))
            {
                string context = Request.QueryString[&quot;xContext&quot;] ?? Request.QueryString[&quot;Context&quot;];
                string moduleID = string.Empty;
                if (Request == null || string.IsNullOrEmpty(Request.QueryString[&quot;module&quot;]))
                {
                    moduleID = XMLForms.GetXMLFormModuleID(context);
                }
                else
                    moduleID = Request.QueryString[&quot;module&quot;];
                try
                {
                    xmlModel =
                        new BrixFormModel(moduleID, context + &quot;.xml&quot;, XMLType.Form, Request, Response);
                }
                catch (Exception)
                {
                    xmlModel = null;
                }
                if (xmlModel != null)
                {
                    ModuleId = xmlModel.form.ModuleID;
                }
                else ModuleId = moduleID;
            }


            base.OnPreInit(e);
        }

        protected override void OnInit(EventArgs e)
        {
            ModuleId = Constants.MODID_CORE;
            PermissionsToCheck.Add(&quot;AuditLog&quot;);

            var menus = new MenuArray();
            menus.Add(new BrixMenu(&quot;lnkBack&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;, 55));
            CreateToolBarMenu(menus, null);
            base.OnInit(e);
        }

        protected override void CustomizeToolBar()
        {
            if (MainToolBar.GetMenuReference(&quot;lnkBack&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).CausesValidation = false;
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).Click += new EventHandler(lnkBack_Click);
            }

            base.CustomizeToolBar();
        }

        void lnkBack_Click(object sender, EventArgs e)
        {
            if (!string.IsNullOrEmpty(Request.QueryString[&quot;module&quot;]))
            {
                if (Request.QueryString[&quot;module&quot;] == &quot;CHNGORD&quot;)
                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?context=COMAIN&amp;PID=&quot; + Request.QueryString[&quot;PID&quot;] +
                                      &quot;&amp;ContractID=&quot; + Request.QueryString[&quot;ContractID&quot;] + &quot;&amp;ParentID=&quot; +
                                      Request.QueryString[&quot;ParentID&quot;]);

                else if (Request.QueryString[&quot;module&quot;] == &quot;PRJSCHD&quot;)
                    Response.Redirect(&quot;~/Common/BrixForm.aspx?&quot; + Request.QueryString);

                else
                    Response.Redirect(&quot;~/Common/BrixListPage.aspx?&quot; + Request.QueryString);
            }
            else
                Response.Redirect(&quot;~/Common/BrixListPage.aspx?&quot; + Request.QueryString);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            info = (ChangeLogDTO)HttpContext.Current.Session[&quot;ChangeLog&quot;];
            if (info != null)
            {
                {
                    string context = Request.QueryString[&quot;xContext&quot;] ?? Request.QueryString[&quot;Context&quot;];
                    string moduleID = string.Empty;
                    if (Request == null || string.IsNullOrEmpty(Request.QueryString[&quot;module&quot;]))
                    {
                        moduleID = XMLForms.GetXMLFormModuleID(context);
                    }
                    else
                        moduleID = Request.QueryString[&quot;module&quot;];
                    try
                    {
                        xmlModel =
                            new BrixFormModel(moduleID, context + &quot;.xml&quot;, XMLType.Form, Request, Response);
                    }
                    catch (Exception)
                    {
                        xmlModel = null;
                    }
                }

                if (!IsPostBack)
                {
                    GetAllDefaultValues();
                    RenderChangeLog();
                }
            }

            PageTitle = &quot;Change Log&quot;;
        }

        private void GetAllDefaultValues()
        {
            DataSet dsDetails = ChangeLogManager.Instance.GetAllRecordDetails(info);

            ddlUsers.Items.Add(new ListItem(&quot;All&quot;, &quot;All&quot;));

            if (dsDetails.Tables.Count &gt; 0)
            {
                ddlUsers.DataSource = dsDetails.Tables[0].ToMWDateTime();
                ddlUsers.DataTextField = &quot;AUR_ModifiedBy&quot;;
                ddlUsers.DataValueField = &quot;AUR_ModifiedBy&quot;;
                ddlUsers.DataBind();
            }
            if (dsDetails.Tables.Count &gt; 1 &amp;&amp; dsDetails.Tables[1].Rows.Count &gt; 1)
            {
                wdcModifiedTo.MinDate = wdcModifiedFrom.MinDate = dsDetails.Tables[1].Rows[0][&quot;MinDate&quot;].ToMWDateTime();
                wdcModifiedTo.MaxDate = wdcModifiedFrom.MaxDate = dsDetails.Tables[1].Rows[0][&quot;MaxDate&quot;].ToMWDateTime();
            }
        }

        protected void btnGenerate_Click(object sender, EventArgs e)
        {
            RenderChangeLog();
        }

        private void RenderChangeLog()
        {
            phHistory.Controls.Clear();
            PrepareDTO();
            DataSet ds = ChangeLogManager.Instance.GetRecordHistory(info);
            int numOfRecords = 1;

            //Assuming that the first table contains the master data. Find out how mant records are there
            DataTable distictIDDT = new DataView(ds.Tables[0]).ToTable(true, info.PrimaryKeyName);
            numOfRecords = distictIDDT.Rows.Count;


            int recordCount = 0;

            while (recordCount &lt; numOfRecords)
            {
                HtmlGenericControl fieldSet = new HtmlGenericControl(&quot;fieldset&quot;);
                phHistory.Controls.Add(fieldSet);

                string divFieldSetContentsID = &quot;divFSC_&quot; + Guid.NewGuid();

                HtmlGenericControl legend = new HtmlGenericControl(&quot;legend&quot;);
                fieldSet.Controls.Add(legend);
                legend.InnerText = &quot;Record - &quot; + (recordCount + 1);
                legend.Attributes.Add(&quot;onclick&quot;, &quot;return ShowHideFieldSetContent(&#39;&quot; + divFieldSetContentsID + &quot;&#39;);&quot;);
                legend.Attributes.Add(&quot;class&quot;, &quot;link&quot;);

                HtmlGenericControl divFieldSetContents = new HtmlGenericControl(&quot;div&quot;);
                fieldSet.Controls.Add(divFieldSetContents);

                divFieldSetContents.Attributes.Add(&quot;DivFSC&quot;, divFieldSetContentsID);
                divFieldSetContents.Style.Add(&quot;display&quot;, &quot;block&quot;);

                int index = 0;
                string legendAdditionalInfo = string.Empty;
                bool isDeleted = false;
                foreach (DataTable dt1 in ds.Tables)
                {
                    BindDataForDropDowns(dt1);

                    DataTable dt = null;
                    if (index == 0)
                    {
                        DataRow[] rows =
                            dt1.Select(info.PrimaryKeyName + &quot;=&#39;&quot; +
                                       distictIDDT.Rows[recordCount][info.PrimaryKeyName].ToString() + &quot;&#39;&quot;);
                        if (rows.Length &gt; 0)
                            dt = rows.CopyToDataTable();
                    }
                    else
                    {
                        DataRow[] rows =
                            dt1.Select(info.ChildTables[dt1.TableName] + &quot;=&#39;&quot; +
                                       distictIDDT.Rows[recordCount][info.PrimaryKeyName].ToString() + &quot;&#39;&quot;);
                        if (rows.Length &gt; 0)
                            dt = rows.CopyToDataTable();
                    }

                    if (dt != null)
                    {
                        //If the record is deleted, then add that text next to the record id (legend)
                        if (index == 0)
                        {
                            DataRow[] deletedRows = dt.Select(&quot;__$operation=&#39;1&#39;&quot;);
                            if (deletedRows.Length &gt; 0)
                            {
                                //there will be only one deleted row. Take the first row
                                isDeleted = true;
                                string deletedBy = deletedRows[0][ModifiedBy].ToString();

                                DateTime? deletedOn =
                                    deletedRows[0][ModifiedOn] == DBNull.Value
                                        ? (DateTime?)null
                                        : deletedRows[0][ModifiedOn].ToDateTime_MWCulture();
                                legend.InnerText += &quot; (Deleted by &quot; + deletedBy + &quot; on &quot; + deletedOn + &quot;)&quot;;
                            }
                        }
                        string MainSectionName = string.Empty;

                        if (xmlModel != null)
                        {
                            xmlModel.form.ProcessAllContainersDeeply(
                                cc =&gt;
                                {
                                    if (cc is DataBaseContainer &amp;&amp;
                                        ((cc as DataBaseContainer).TableName == dt1.TableName)
                                        ||
                                        ((cc is Form &amp;&amp;
                                          ((cc as Form).ActualTableNameInDatabase) == dt1.TableName)))
                                    {
                                        if (cc is Form)
                                            MainSectionName = (cc as Form).Header;
                                        if (cc is DynamicGrid)
                                            MainSectionName = (cc as DynamicGrid).Caption;
                                        if (cc is StaticGrid)
                                            MainSectionName = (cc as StaticGrid).Caption;
                                        if (cc is CheckListGroup &amp;&amp; (cc as CheckListGroup).Containers[0] is Group)
                                            MainSectionName = ((cc as CheckListGroup).Containers[0] as Group).Caption;
                                    }
                                });

                            MainSectionName = xmlModel.form.ParseDynamicString(MainSectionName);
                        }


                        HiddenColumns = new List&lt;string&gt;()
                        {
                            &quot;__$start_lsn&quot;,
                            &quot;__$end_lsn&quot;,
                            &quot;__$seqval&quot;,
                            &quot;__$operation&quot;,
                            &quot;__$update_mask&quot;,
                            &quot;ColumnChanges&quot;
                        };

                        AllColumns = new List&lt;string&gt;();

                        SysColumns = new List&lt;string&gt;() { ModifiedBy, ModifiedOn };

                        string divID = &quot;div&quot; + Guid.NewGuid();

                        if (!string.IsNullOrEmpty(MainSectionName))
                        {
                            HtmlAnchor a = new HtmlAnchor();
                            divFieldSetContents.Controls.Add(a);
                            a.InnerText = MainSectionName;
                            a.HRef = &quot;#&quot;;
                            a.Attributes.Add(&quot;class&quot;, &quot;pageSubHeaders link&quot;);
                            a.Attributes.Add(&quot;onclick&quot;, &quot;return ShowHideDiv(&#39;&quot; + divID + &quot;&#39;);&quot;);
                        }

                        divFieldSetContents.Controls.Add(RenderBreak());

                        // Division for each data container
                        HtmlGenericControl divDetails = new HtmlGenericControl(&quot;div&quot;);
                        divFieldSetContents.Controls.Add(divDetails);
                        divDetails.Attributes.Add(&quot;DivID&quot;, divID);

                        //if (index != 0)
                        // divDetails.Style.Add(&quot;display&quot;, &quot;none&quot;);

                        //divDetails.Controls.Add(RenderLine());

                        Label ins = new Label();
                        ins.Text = &quot;Record Inserted&quot;;
                        ins.Font.Bold = true;
                        ins.Font.Size = new FontUnit(&quot;11px&quot;);
                        divDetails.Controls.Add(ins);

                        // table for inserted recods
                        HtmlTable tableIns = RenderTable();
                        divDetails.Controls.Add(tableIns);
                        string legendInfo = RenderInsertedRow(dt, tableIns);


                        if (!isDeleted &amp;&amp; index == 0)
                        {
                            //Update the legend to show the first inserted record details
                            legendAdditionalInfo = &quot; Inserted By &quot; + legendInfo;
                            ;
                        }

                        divDetails.Controls.Add(RenderBreak());

                        //If the update rows exists, then only render the update table otherwise only the table header wil be shown.

                        if (dt.Select(&quot;__$operation=&#39;3&#39; or __$operation=&#39;4&#39;&quot;).Length &gt; 0)
                        {
                            Label up = new Label();
                            up.Text = &quot;Updates&quot;;
                            up.Font.Bold = true;
                            up.Font.Size = new FontUnit(&quot;11px&quot;);
                            divDetails.Controls.Add(up);

                            HtmlTable tableAllUpdates = RenderTable();
                            divDetails.Controls.Add(tableAllUpdates);
                            HtmlTableRow updateDetailsRowHeader = RenderRow(tableAllUpdates, true);

                            RenderCell(updateDetailsRowHeader, &quot;Modified By&quot;, true).Width = &quot;200px&quot;;
                            RenderCell(updateDetailsRowHeader, &quot;Modified On&quot;, true).Width = &quot;200px&quot;;
                            RenderCell(updateDetailsRowHeader, &quot;Updated Columns&quot;, true).Width = &quot;200px&quot;;

                            for (int i = 0; i &lt; dt.Rows.Count - 1; i = i + 2)
                            {
                                //If its inserted row, then dont do anythin
                                if (dt.Rows[i][&quot;__$operation&quot;].ToString() == &quot;2&quot; ||
                                    dt.Rows[i][&quot;__$operation&quot;].ToString() == &quot;1&quot;)
                                {
                                    i--;
                                    continue;
                                }

                                //for every two rows, create a table. 
                                RenderRow(tableAllUpdates);

                                int nextRowID = i + 1;
                                RenderUpdatedRows(dt.Rows[i], dt.Rows[nextRowID], tableAllUpdates);

                                if (!isDeleted &amp;&amp; index == 0 &amp;&amp; i == dt.Rows.Count - 2)
                                {
                                    //If its the last record, then get the modified by and on details
                                    DateTime? mDt = dt.Rows[i + 1][ModifiedOn] == DBNull.Value
                                        ? (DateTime?)null
                                        : dt.Rows[i + 1][ModifiedOn].ToDateTime_MWCulture();
                                    legendAdditionalInfo = &quot; Last Updated by &quot; + dt.Rows[i + 1][ModifiedBy].ToString() +
                                                           &quot; on &quot; + mDt;
                                }
                            }
                            divDetails.Controls.Add(RenderBreak());
                        }
                    }
                    index++;
                }
                legend.InnerText += legendAdditionalInfo;
                divFieldSetContents.Controls.Add(RenderBreak());
                phHistory.Controls.Add(RenderBreak());
                recordCount++;
            }
        }

        private void PrepareDTO()
        {
            if (ddlUsers.SelectedValue != &quot;All&quot;)
                info.ModifiedBy = ddlUsers.SelectedValue;
            else
                info.ModifiedBy = null;

            if (wdcModifiedFrom.Value != null)
                info.ModifiedFrom = wdcModifiedFrom.Value.ToDateTime_MWCulture();
            else
                info.ModifiedFrom = null;

            if (wdcModifiedTo.Value != null)
                info.ModifiedTo = wdcModifiedTo.Value.ToDateTime_MWCulture();
            else
                info.ModifiedTo = null;

            if (ddlOperation.SelectedValue != &quot;0&quot;)
                info.Operation = ddlOperation.SelectedValue.ToInt32_2();
            else
                info.Operation = null;
        }

        private void BindDataForDropDowns(DataTable dt)
        {
            BindDataForDropDownsOrg(dt);
            //Remove all columns with _val

            for (int i = 0; i &lt; dt.Columns.Count; i++)
            {
                if (dt.Columns[i].ColumnName.EndsWith(&quot;_val&quot;))
                {
                    dt.Columns.Remove(dt.Columns[i]);

                    i++;
                }
            }
        }

        private void BindDataForDropDownsOrg(DataTable dt)
        {
            if (xmlModel != null)
            {
                for (int i = 0; i &lt; dt.Rows.Count; i++)
                {
                    for (int j = 0; j &lt; dt.Columns.Count; j++)
                    {
                        xControl xc = xmlModel.form.GetControl(dt.Columns[j].ColumnName.Replace(&quot;_val&quot;, &quot;&quot;));
                        if (xc != null &amp;&amp; xc.Type == ControlType.DropDownList)
                        {
                            DropDownList ddl = new DropDownList();
                            HtmlRenderer.BindDropDown(xc, ddl);
                            ListItem li = ddl.Items.FindByValue(dt.Rows[i][j].ToString());
                            if (li != null)
                            {
                                string actualColumnName = dt.Columns[j].ColumnName;
                                if (!actualColumnName.EndsWith(&quot;_val&quot;))
                                    dt.Columns[j].ColumnName = actualColumnName + &quot;_val&quot;;
                                else
                                    actualColumnName = actualColumnName.Replace(&quot;_val&quot;, &quot;&quot;);

                                if (!dt.Columns.Contains(actualColumnName))
                                {
                                    dt.Columns.Add(actualColumnName, typeof (string));
                                    dt.Columns[actualColumnName].SetOrdinal(
                                        dt.Columns[actualColumnName + &quot;_val&quot;].Ordinal + 1);
                                }
                                dt.Rows[i][actualColumnName] = li.Text;
                                j++;
                            }
                        }
                    }
                }
            }
        }

        private HtmlTable RenderTable()
        {
            HtmlTable table = new HtmlTable();
            table.Border = 1;
            table.CellSpacing = 0;
            table.CellPadding = 3;
            table.Style.Add(HtmlTextWriterStyle.BorderColor, &quot;#aaaaaa&quot;);
            table.Style.Add(HtmlTextWriterStyle.BorderCollapse, &quot;collapse&quot;);
            return table;
        }

        private HtmlTableRow RenderRow(HtmlTable table, bool isHeader = false)
        {
            HtmlTableRow row = new HtmlTableRow();
            table.Controls.Add(row);

            if (isHeader)
            {
                row.Style.Add(HtmlTextWriterStyle.TextAlign, &quot;center&quot;);
                row.Style.Add(HtmlTextWriterStyle.BackgroundColor, &quot;#eeeeee&quot;);
            }

            return row;
        }

        private delegate HtmlTableCell RenderCellFuntion(HtmlTableRow row, string text, bool isHeader = false);

        private HtmlTableCell RenderCell(HtmlTableRow row, string text, bool isHeader = false)
        {
            HtmlTableCell cell = new HtmlTableCell();
            row.Controls.Add(cell);
            cell.InnerText = text;
            cell.Width = &quot;200px&quot;;

            if (isHeader)
            {
                cell.Style.Add(HtmlTextWriterStyle.FontWeight, &quot;bold&quot;);
                cell.Style.Add(HtmlTextWriterStyle.FontSize, &quot;11px&quot;);
            }
            return cell;
        }

        private HtmlTableCell RenderCellAsLink(HtmlTableRow row, string text, string jsFunction)
        {
            HtmlTableCell cell = new HtmlTableCell();
            row.Controls.Add(cell);

            HtmlAnchor a = new HtmlAnchor();
            cell.Controls.Add(a);
            a.HRef = &quot;#&quot;;
            a.Attributes.Add(&quot;class&quot;, &quot;HeaderloginLinks link&quot;);
            a.Attributes.Add(&quot;onclick&quot;, jsFunction);
            a.InnerText = text;

            return cell;
        }

        private HtmlGenericControl RenderLine()
        {
            return new HtmlGenericControl(&quot;hr&quot;);
        }

        private HtmlGenericControl RenderBreak()
        {
            return new HtmlGenericControl(&quot;br&quot;);
        }

        private string RenderInsertedRow(DataTable dt, HtmlTable tableIns)
        {
            string firstInsertedInfo = string.Empty;
            DataRow[] rowsIns = dt.Select(&quot;__$operation=&#39;2&#39;&quot;);

            if (rowsIns.Length &gt; 0)
            {
                HtmlTableRow rowInsHeader = RenderRow(tableIns, true);
                RenderCell(rowInsHeader, &quot;Inserted By&quot;, true);
                RenderCell(rowInsHeader, &quot;Inserted On&quot;, true);

                for (int i = 0; i &lt; rowsIns.Length; i++)
                {
                    if (i == 0)
                    {
                        DateTime? mDt = rowsIns[i][ModifiedOn] == DBNull.Value
                            ? (DateTime?)null
                            : rowsIns[i][ModifiedOn].ToDateTime_MWCulture();
                        firstInsertedInfo = rowsIns[i][ModifiedBy].ToString() + &quot; on &quot; + mDt;
                    }
                    HtmlTableRow rowIns = RenderRow(tableIns);
                    //Add the By and on column

                    RenderCell(rowIns, rowsIns[i][ModifiedBy].ToString());
                    RenderCell(rowIns, rowsIns[i][ModifiedOn].ToString());

                    RenderCellAction(dt, rowsIns[i], rowInsHeader, rowIns, i == 0, RenderCell);
                }
            }
            return firstInsertedInfo;
        }

        private void RenderCellAction(DataTable dt, DataRow rowsIns, HtmlTableRow rowInsHeader, HtmlTableRow rowIns,
            bool IsHeader, RenderCellFuntion RenderCellFunction)
        {
            for (int j = 0; j &lt; dt.Columns.Count; j++)
            {
                string columnName = dt.Columns[j].ColumnName;
                string colCaption = columnName;
                bool isHidden = false;
                if (xmlModel != null)
                {
                    xControl xc = xmlModel.form.GetControl(colCaption);
                    if (xc != null)
                    {
                        colCaption = xc.ParseDynamicString(string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.Caption);
                        isHidden = xc.Type == ControlType.Hidden;
                    }
                    if (columnName.EndsWith(&quot;_val&quot;))
                        isHidden = true;
                }

                if (IsHeader)
                    if (!HiddenColumns.Contains(columnName))
                    {
                        AllColumns.Add(columnName);
                        if (!SysColumns.Contains(columnName) &amp;&amp; !isHidden &amp;&amp; RenderCellFunction != null)
                        {
                            RenderCellFunction(rowInsHeader, colCaption, true);
                        }
                    }

                if (!HiddenColumns.Contains(columnName) &amp;&amp; !SysColumns.Contains(columnName) &amp;&amp; !isHidden &amp;&amp;
                    RenderCellFunction != null)
                {
                    RenderCellFunction(rowIns, rowsIns[j].ToString());
                }
            }
        }

        private void RenderUpdatedRows(DataRow updateRow, DataRow nextRow, HtmlTable masterUpdateTable)
        {
            //One row for the details and the details table. 
            if (AllColumns.Count &lt; 1)
                RenderCellAction(updateRow.Table, null, null, null, true, null);

            HtmlTableRow masterRowDetails = RenderRow(masterUpdateTable);

            string rowID = &quot;rw&quot; + Guid.NewGuid();

            HtmlTableRow rowChangeDetails = RenderRow(masterUpdateTable);
            rowChangeDetails.Style.Add(&quot;display&quot;, &quot;none&quot;);
            rowChangeDetails.Attributes.Add(&quot;RowID&quot;, rowID);
            HtmlTableCell cellChangeDetails = RenderCell(rowChangeDetails, &quot;&quot;);
            cellChangeDetails.ColSpan = 3;


            //showing column wise details of the update column
            HtmlTable tableUpdate = RenderTable();
            cellChangeDetails.Controls.Add(tableUpdate);

            cellChangeDetails.Controls.Add(RenderBreak());

            string tableID = &quot;table_&quot; + Guid.NewGuid();

            HtmlGenericControl divAllColumns = new HtmlGenericControl(&quot;div&quot;);
            cellChangeDetails.Controls.Add(divAllColumns);
            divAllColumns.Style.Add(HtmlTextWriterStyle.Overflow, &quot;auto&quot;);
            divAllColumns.Style.Add(&quot;width&quot;, &quot;900px&quot;);

            HtmlTable tableUpdateAll = RenderTable();
            divAllColumns.Controls.Add(tableUpdateAll);
            tableUpdateAll.Attributes.Add(&quot;TableID&quot;, tableID);
            tableUpdateAll.Style.Add(&quot;display&quot;, &quot;none&quot;);
            tableUpdateAll.Style.Add(&quot;width&quot;, &quot;900px&quot;);
            tableUpdateAll.Style.Add(&quot;table-layout&quot;, &quot;fixed&quot;);


            HtmlTableRow rowLink = RenderRow(tableUpdate);
            HtmlTableRow rowUpdate = RenderRow(tableUpdate, true);
            HtmlTableRow rowUpdateDetails1 = RenderRow(tableUpdate);
            HtmlTableRow rowUpdateDetails2 = RenderRow(tableUpdate);

            HtmlTableRow rowUpdateAll = RenderRow(tableUpdateAll, true);
            HtmlTableRow rowUpdateDetails1All = RenderRow(tableUpdateAll);
            HtmlTableRow rowUpdateDetails2All = RenderRow(tableUpdateAll);

            HtmlTableCell linkCell = RenderCellAsLink(rowLink, &quot;Show/Hide All Columns&quot;,
                &quot;return ShowHideTable(&#39;&quot; + tableID + &quot;&#39;);&quot;);

            //The last one is for the Operation column which comes first

            string columnChange = GetColumnChangeForDropDownColumns(updateRow,
                updateRow[&quot;ColumnChanges&quot;].ToString() + &quot;1&quot;);
            char[] columns = columnChange.ToCharArray();
            Array.Reverse(columns);


            string updatedCols = string.Empty;
            int numberOfRenderedCols = 0;
            for (int k = 0; k &lt; AllColumns.Count; k++)
            {
                string colCaption = AllColumns[k];
                bool isHidden = false;
                if (xmlModel != null)
                {
                    xControl xc = xmlModel.form.GetControl(colCaption);
                    if (xc != null)
                    {
                        colCaption = xc.ParseDynamicString(string.IsNullOrEmpty(xc.Caption) ? xc.Name : xc.Caption);
                        isHidden = xc.Type == ControlType.Hidden;
                    }

                    if (AllColumns[k].EndsWith(&quot;_val&quot;))
                        isHidden = true;
                }


                if (columns[k].ToString() == &quot;1&quot;)
                {
                    if (AllColumns[k] != &quot;Operation&quot; &amp;&amp; !SysColumns.Contains(AllColumns[k]) &amp;&amp; !isHidden)
                        updatedCols += colCaption + &quot;,&quot;;

                    if (!SysColumns.Contains(AllColumns[k]) &amp;&amp; !isHidden)
                    {
                        numberOfRenderedCols++;
                        RenderCell(rowUpdate, colCaption, true);
                        RenderCell(rowUpdateDetails1, updateRow[AllColumns[k]].ToString());
                        RenderCell(rowUpdateDetails2, nextRow[AllColumns[k]].ToString());
                    }
                }

                if (!SysColumns.Contains(AllColumns[k]) &amp;&amp; !isHidden)
                {
                    //Showing All Columns if clicked on show all columns link
                    RenderCell(rowUpdateAll, colCaption, true);
                    RenderCell(rowUpdateDetails1All,
                        string.IsNullOrEmpty(updateRow[AllColumns[k]].ToString())
                            ? nextRow[AllColumns[k]].ToString()
                            : updateRow[AllColumns[k]].ToString());
                    RenderCell(rowUpdateDetails2All, nextRow[AllColumns[k]].ToString());
                }
            }
            linkCell.ColSpan = numberOfRenderedCols;

            string modifiedBy = nextRow.Table.Columns.Contains(ModifiedBy)
                ? nextRow[ModifiedBy].ToString()
                : string.Empty;
            string modifiedOn = nextRow.Table.Columns.Contains(ModifiedOn)
                ? nextRow[ModifiedOn].ToString()
                : string.Empty;

            string mDt = string.IsNullOrEmpty(modifiedOn) ? &quot;&quot; : modifiedOn;


            RenderCellAsLink(masterRowDetails, modifiedBy, &quot;return ShowHideDetails(&#39;&quot; + rowID + &quot;&#39;);&quot;);
            RenderCellAsLink(masterRowDetails, string.IsNullOrEmpty(modifiedOn) ? &quot;&quot; : mDt,
                &quot;return ShowHideDetails(&#39;&quot; + rowID + &quot;&#39;);&quot;);
            RenderCellAsLink(masterRowDetails, updatedCols.TrimEnd(&#39;,&#39;), &quot;return ShowHideDetails(&#39;&quot; + rowID + &quot;&#39;);&quot;);

            if (string.IsNullOrEmpty(updatedCols))
                masterRowDetails.Style.Add(&quot;display&quot;, &quot;none&quot;);
        }

        private string GetColumnChangeForDropDownColumns(DataRow updateRow, string columnChange)
        {
            foreach (DataColumn col in updateRow.Table.Columns)
            {
                if (col.ColumnName.EndsWith(&quot;_val&quot;))
                {
                    int thisColumnIndexInChange = col.Ordinal;
                    string thisColumnChange =
                        columnChange.ToArray().Reverse().ToArray()[thisColumnIndexInChange].ToString();
                }
            }
            return columnChange;
        }

        private void RenderCellAsLink(HtmlTableRow masterRowDetails, object p, string p_2)
        {
            throw new NotImplementedException();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,39,0],[34,17,34,18,0],[34,19,34,43,0],[34,44,34,45,0],[39,17,39,18,0],[39,19,39,43,0],[39,44,39,45,0],[43,9,43,10,0],[44,13,45,71,0],[46,13,46,14,0],[47,17,47,100,0],[48,17,48,48,0],[49,17,49,92,0],[50,17,50,18,0],[51,21,51,69,0],[52,17,52,18,0],[54,21,54,62,0],[56,17,56,18,0],[57,21,58,104,0],[59,17,59,18,0],[60,17,60,34,0],[61,17,61,18,0],[62,21,62,37,0],[63,17,63,18,0],[64,17,64,38,0],[65,17,65,18,0],[66,21,66,55,0],[67,17,67,18,0],[68,22,68,42,0],[69,13,69,14,0],[72,13,72,31,0],[73,9,73,10,0],[76,9,76,10,0],[77,13,77,45,0],[78,13,78,48,0],[80,13,80,41,0],[81,13,81,76,0],[82,13,82,44,0],[83,13,83,28,0],[84,9,84,10,0],[87,9,87,10,0],[88,13,88,65,0],[89,13,89,14,0],[90,17,90,82,0],[91,17,91,98,0],[92,13,92,14,0],[94,13,94,37,0],[95,9,95,10,0],[98,9,98,10,0],[99,13,99,70,0],[100,13,100,14,0],[101,17,101,64,0],[102,21,104,72,0],[106,22,106,69,0],[107,21,107,88,0],[110,21,110,92,0],[111,13,111,14,0],[113,17,113,88,0],[114,9,114,10,0],[117,9,117,10,0],[118,13,118,75,0],[119,13,119,30,0],[120,13,120,14,0],[121,17,121,18,0],[122,21,122,104,0],[123,21,123,52,0],[124,21,124,96,0],[125,21,125,22,0],[126,25,126,73,0],[127,21,127,22,0],[129,25,129,66,0],[131,21,131,22,0],[132,25,133,108,0],[134,21,134,22,0],[135,21,135,38,0],[136,21,136,22,0],[137,25,137,41,0],[138,21,138,22,0],[139,17,139,18,0],[141,17,141,33,0],[142,17,142,18,0],[143,21,143,43,0],[144,21,144,39,0],[145,17,145,18,0],[146,13,146,14,0],[148,13,148,38,0],[149,9,149,10,0],[152,9,152,10,0],[153,13,153,85,0],[155,13,155,60,0],[157,13,157,44,0],[158,13,158,14,0],[159,17,159,74,0],[160,17,160,59,0],[161,17,161,60,0],[162,17,162,37,0],[163,13,163,14,0],[164,13,164,82,0],[165,13,165,14,0],[166,17,166,121,0],[167,17,167,121,0],[168,13,168,14,0],[169,9,169,10,0],[172,9,172,10,0],[173,13,173,31,0],[174,9,174,10,0],[177,9,177,10,0],[178,13,178,40,0],[179,13,179,26,0],[180,13,180,75,0],[181,13,181,34,0],[184,13,184,99,0],[185,13,185,51,0],[188,13,188,33,0],[190,13,190,47,0],[191,13,191,14,0],[192,17,192,82,0],[193,17,193,50,0],[195,17,195,75,0],[197,17,197,78,0],[198,17,198,47,0],[199,17,199,68,0],[200,17,200,118,0],[201,17,201,56,0],[203,17,203,88,0],[204,17,204,60,0],[206,17,206,85,0],[207,17,207,67,0],[209,17,209,31,0],[210,17,210,60,0],[211,17,211,40,0],[212,17,212,24,0],[212,26,212,39,0],[212,40,212,42,0],[212,43,212,52,0],[213,17,213,18,0],[214,21,214,47,0],[216,21,216,41,0],[217,21,217,36,0],[218,21,218,22,0],[219,25,221,109,0],[222,25,222,45,0],[223,29,223,57,0],[224,21,224,22,0],[226,21,226,22,0],[227,25,229,109,0],[230,25,230,45,0],[231,29,231,57,0],[232,21,232,22,0],[234,21,234,36,0],[235,21,235,22,0],[237,25,237,40,0],[238,25,238,26,0],[239,29,239,83,0],[240,29,240,56,0],[241,29,241,30,0],[243,33,243,50,0],[244,33,244,90,0],[246,33,249,93,0],[250,33,250,108,0],[251,29,251,30,0],[252,25,252,26,0],[253,25,253,63,0],[255,25,255,46,0],[256,25,256,26,0],[257,29,259,33,0],[259,33,259,34,0],[259,34,260,37,0],[260,37,264,103,0],[264,103,265,37,0],[265,37,265,38,0],[265,38,266,41,0],[266,41,266,56,0],[266,56,267,45,0],[267,45,267,83,0],[267,83,268,41,0],[268,41,268,63,0],[268,63,269,45,0],[269,45,269,91,0],[269,91,270,41,0],[270,41,270,62,0],[270,62,271,45,0],[271,45,271,90,0],[271,90,272,41,0],[272,41,272,115,0],[272,115,273,45,0],[273,45,273,119,0],[273,119,274,37,0],[274,37,274,38,0],[274,38,275,33,0],[275,33,275,34,0],[275,34,275,36,0],[257,29,275,36,0],[277,29,277,97,0],[278,25,278,26,0],[281,25,289,27,0],[291,25,291,57,0],[293,25,293,84,0],[295,25,295,63,0],[297,25,297,68,0],[298,25,298,26,0],[299,29,299,61,0],[300,29,300,65,0],[301,29,301,59,0],[302,29,302,42,0],[303,29,303,78,0],[304,29,304,97,0],[305,25,305,26,0],[307,25,307,73,0],[310,25,310,87,0],[311,25,311,70,0],[312,25,312,67,0],[319,25,319,49,0],[320,25,320,54,0],[321,25,321,46,0],[322,25,322,62,0],[323,25,323,54,0],[326,25,326,60,0],[327,25,327,59,0],[328,25,328,77,0],[331,25,331,54,0],[332,25,332,26,0],[334,29,334,81,0],[335,29,335,30,0],[336,25,336,26,0],[338,25,338,64,0],[342,25,342,90,0],[343,25,343,26,0],[344,29,344,52,0],[345,29,345,49,0],[346,29,346,49,0],[347,29,347,65,0],[348,29,348,57,0],[350,29,350,71,0],[351,29,351,70,0],[352,29,352,100,0],[354,29,354,101,0],[355,29,355,101,0],[356,29,356,105,0],[358,34,358,43,0],[358,45,358,66,0],[358,68,358,77,0],[359,29,359,30,0],[361,33,362,82,0],[363,33,363,34,0],[364,37,364,41,0],[365,37,365,46,0],[369,33,369,60,0],[371,33,371,55,0],[372,33,372,100,0],[374,33,374,88,0],[375,33,375,34,0],[377,37,379,93,0],[380,37,381,73,0],[382,33,382,34,0],[383,29,383,30,0],[384,29,384,68,0],[385,25,385,26,0],[386,21,386,22,0],[387,21,387,29,0],[388,17,388,18,0],[389,17,389,58,0],[390,17,390,65,0],[391,17,391,55,0],[392,17,392,31,0],[393,13,393,14,0],[394,9,394,10,0],[397,9,397,10,0],[398,13,398,49,0],[399,17,399,58,0],[401,17,401,40,0],[403,13,403,47,0],[404,17,404,82,0],[406,17,406,42,0],[408,13,408,45,0],[409,17,409,78,0],[411,17,411,40,0],[413,13,413,51,0],[414,17,414,73,0],[416,17,416,39,0],[417,9,417,10,0],[420,9,420,10,0],[421,13,421,41,0],[424,18,424,27,0],[424,29,424,49,0],[424,51,424,54,0],[425,13,425,14,0],[426,17,426,63,0],[427,17,427,18,0],[428,21,428,54,0],[430,21,430,25,0],[431,17,431,18,0],[432,13,432,14,0],[433,9,433,10,0],[436,9,436,10,0],[437,13,437,34,0],[438,13,438,14,0],[439,22,439,31,0],[439,33,439,50,0],[439,52,439,55,0],[440,17,440,18,0],[441,26,441,35,0],[441,37,441,57,0],[441,59,441,62,0],[442,21,442,22,0],[443,25,443,110,0],[444,25,444,79,0],[445,25,445,26,0],[446,29,446,67,0],[447,29,447,64,0],[448,29,448,91,0],[449,29,449,44,0],[450,29,450,30,0],[451,33,451,84,0],[452,33,452,72,0],[453,37,453,90,0],[455,37,455,93,0],[457,33,457,76,0],[458,33,458,34,0],[459,37,459,87,0],[460,37,461,92,0],[462,33,462,34,0],[463,33,463,72,0],[464,33,464,37,0],[465,29,465,30,0],[466,25,466,26,0],[467,21,467,22,0],[468,17,468,18,0],[469,13,469,14,0],[470,9,470,10,0],[473,9,473,10,0],[474,13,474,47,0],[475,13,475,30,0],[476,13,476,35,0],[477,13,477,35,0],[478,13,478,73,0],[479,13,479,77,0],[480,13,480,26,0],[481,9,481,10,0],[484,9,484,10,0],[485,13,485,51,0],[486,13,486,37,0],[488,13,488,26,0],[489,13,489,14,0],[490,17,490,72,0],[491,17,491,79,0],[492,13,492,14,0],[494,13,494,24,0],[495,9,495,10,0],[500,9,500,10,0],[501,13,501,54,0],[502,13,502,36,0],[503,13,503,35,0],[504,13,504,34,0],[506,13,506,26,0],[507,13,507,14,0],[508,17,508,72,0],[509,17,509,70,0],[510,13,510,14,0],[511,13,511,25,0],[512,9,512,10,0],[515,9,515,10,0],[516,13,516,54,0],[517,13,517,36,0],[519,13,519,45,0],[520,13,520,34,0],[521,13,521,26,0],[522,13,522,64,0],[523,13,523,53,0],[524,13,524,32,0],[526,13,526,25,0],[527,9,527,10,0],[530,9,530,10,0],[531,13,531,49,0],[532,9,532,10,0],[535,9,535,10,0],[536,13,536,49,0],[537,9,537,10,0],[540,9,540,10,0],[541,13,541,53,0],[542,13,542,63,0],[544,13,544,36,0],[545,13,545,14,0],[546,17,546,71,0],[547,17,547,63,0],[548,17,548,63,0],[550,22,550,31,0],[550,33,550,51,0],[550,53,550,56,0],[551,17,551,18,0],[552,21,552,32,0],[553,21,553,22,0],[554,25,556,77,0],[557,25,557,94,0],[558,21,558,22,0],[559,21,559,63,0],[562,21,562,75,0],[563,21,563,75,0],[565,21,565,96,0],[566,17,566,18,0],[567,13,567,14,0],[568,13,568,38,0],[569,9,569,10,0],[573,9,573,10,0],[574,18,574,27,0],[574,29,574,49,0],[574,51,574,54,0],[575,13,575,14,0],[576,17,576,62,0],[577,17,577,48,0],[578,17,578,39,0],[579,17,579,38,0],[580,17,580,18,0],[581,21,581,72,0],[582,21,582,36,0],[583,21,583,22,0],[584,25,584,117,0],[585,25,585,66,0],[586,21,586,22,0],[587,21,587,53,0],[588,25,588,41,0],[589,17,589,18,0],[591,17,591,30,0],[592,21,592,61,0],[593,21,593,22,0],[594,25,594,52,0],[595,25,595,105,0],[596,25,596,26,0],[597,29,597,80,0],[598,25,598,26,0],[599,21,599,22,0],[601,17,602,48,0],[603,17,603,18,0],[604,21,604,71,0],[605,17,605,18,0],[606,13,606,14,0],[607,9,607,10,0],[610,9,610,10,0],[612,13,612,38,0],[613,17,613,81,0],[615,13,615,74,0],[617,13,617,50,0],[619,13,619,74,0],[620,13,620,59,0],[621,13,621,61,0],[622,13,622,80,0],[623,13,623,43,0],[627,13,627,51,0],[628,13,628,57,0],[630,13,630,59,0],[632,13,632,56,0],[634,13,634,78,0],[635,13,635,59,0],[636,13,636,75,0],[637,13,637,55,0],[639,13,639,54,0],[640,13,640,56,0],[641,13,641,63,0],[642,13,642,57,0],[643,13,643,56,0],[644,13,644,63,0],[647,13,647,59,0],[648,13,648,67,0],[649,13,649,69,0],[650,13,650,69,0],[652,13,652,73,0],[653,13,653,75,0],[654,13,654,75,0],[656,13,657,61,0],[661,13,662,62,0],[663,13,663,57,0],[664,13,664,36,0],[667,13,667,47,0],[668,13,668,42,0],[669,18,669,27,0],[669,29,669,49,0],[669,51,669,54,0],[670,13,670,14,0],[671,17,671,51,0],[672,17,672,39,0],[673,17,673,38,0],[674,17,674,18,0],[675,21,675,72,0],[676,21,676,36,0],[677,21,677,22,0],[678,25,678,117,0],[679,25,679,66,0],[680,21,680,22,0],[682,21,682,56,0],[683,25,683,41,0],[684,17,684,18,0],[687,17,687,50,0],[688,17,688,18,0],[689,21,689,106,0],[690,25,690,57,0],[692,21,692,74,0],[693,21,693,22,0],[694,25,694,48,0],[695,25,695,65,0],[696,25,696,92,0],[697,25,697,90,0],[698,21,698,22,0],[699,17,699,18,0],[701,17,701,70,0],[702,17,702,18,0],[704,21,704,64,0],[705,21,708,68,0],[709,21,709,89,0],[710,17,710,18,0],[711,13,711,14,0],[712,13,712,53,0],[714,13,716,32,0],[717,13,719,32,0],[721,13,721,77,0],[724,13,724,104,0],[725,13,726,61,0],[727,13,727,118,0],[729,13,729,51,0],[730,17,730,63,0],[731,9,731,10,0],[734,9,734,10,0],[735,13,735,20,0],[735,22,735,36,0],[735,37,735,39,0],[735,40,735,63,0],[736,13,736,14,0],[737,17,737,53,0],[738,17,738,18,0],[739,21,739,63,0],[740,21,741,104,0],[742,17,742,18,0],[743,13,743,14,0],[744,13,744,33,0],[745,9,745,10,0],[748,9,748,10,0],[749,13,749,49,0]]);
    </script>
  </body>
</html>