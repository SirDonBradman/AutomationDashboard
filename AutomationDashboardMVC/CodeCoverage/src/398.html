<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Construction Vertical\Main Modules\Estimator\BusinessLayer\ConcreateModels\Estimate\EstimateBidListModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aurigo.AMP3.Common;
using Aurigo.AMP3.Core.AbstractModels;
using Aurigo.AMP3.Core.UserControls;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.DocumentManagementBL;
using Aurigo.AMP3.EstimatorBL;
using Aurigo.AMP3.EstimatorDTO;
using Aurigo.AMP3.EstimatorUI;
using Aurigo.AMP3.LibraryBL;
using Aurigo.Brix.Platform.BusinessLayer.UserControls;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Infragistics.WebUI.UltraWebGrid;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Web;
using System.Web.Http;
using System.Web.UI;
using System.Web.UI.WebControls;
using Aurigo.AMP3.LinksBL;
using System.Collections;
using Aurigo.Common;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.Brix.Construction.Estimator;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.AMP3.ModuleManagementBL;
using Infragistics.WebUI.UltraWebGrid.ExcelExport;
using System.Drawing;
using Infragistics.Documents.Excel;
using System.Configuration;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Construction.Estimator.BusinessLayer.BL;
using Telerik.Web.UI;
using Aurigo.AMP3.Resources.TerminologyResources;

namespace Aurigo.AMP3.Estimator.UI
{
    [ListModelContext(Name = &quot;ESTMBID&quot;, Table = &quot;ESTMATEInfo&quot;)]
    [ContextElement(Name = &quot;Estmate Bid List&quot;)]
    public class EstimateBidListModel : ListModel, IWorkflowEnabledList
    {
        protected global::Aurigo.Brix.Platform.BusinessLayer.UserControls.PickerGrid contractorPickerGrid;
        protected global::Aurigo.Brix.Platform.BusinessLayer.UserControls.PickerGrid alternatePickerGrid;
        protected global::Aurigo.Brix.Construction.Estimator.EstimateBidSettings estimateSettings;
        private bool enableNew = false;
        private bool enableEdit = false;
        private Button btnDeleteBids;

        public override string QueryStringName
        {
            get { return &quot;BidId&quot;; }
        }

        public override void OnInit()
        {
            base.OnInit();
            
            Page pg = (HttpContext.Current.CurrentHandler as Page);

            contractorPickerGrid = (PickerGrid)pg.LoadControl(&quot;~/Modules/UserControls/PickerGrid.ascx&quot;);
            contractorPickerGrid.ID = &quot;contractorPickerGrid&quot;;
            InitializePicker(contractorPickerGrid, &quot;Contractor&quot;, pg);
            pg.Form.Controls.Add(contractorPickerGrid);

            alternatePickerGrid = (PickerGrid)pg.LoadControl(&quot;~/Modules/UserControls/PickerGrid.ascx&quot;);
            alternatePickerGrid.ID = &quot;alternatePickerGrid&quot;;
            InitializePicker(alternatePickerGrid, &quot;Alternate&quot;, pg);
            pg.Form.Controls.Add(alternatePickerGrid);

            estimateSettings = (EstimateBidSettings)pg.LoadControl(&quot;~/Modules/ESTMATE/UserControls/EstimateBidSettings.ascx&quot;);
            estimateSettings.ID = &quot;estimateSettings&quot;;
            pg.Form.Controls.Add(estimateSettings);

            DataTable dt = EstimateManager.Instance.GetBidLettingDetail(Request[EstimatorConstants.PROJECT_ESTIMATE_ID].ToInt32_2());

            if (dt != null &amp;&amp; dt.Rows.Count &gt; 0)
            {
                DataRow dr = dt.Select(&quot;Type=&#39;Letting&#39;&quot;).FirstOrDefault();

                string status = dr[&quot;Status&quot;].ToString();
                //DateTime issueDate, bidOpenDate;
                //int bidOpenHr = 0, bidOpenMin = 0;

                //DateTime.TryParse(dr[&quot;IssueDate&quot;].ToString(), out issueDate);
                //DateTime.TryParse(dr[&quot;LettingDate&quot;].ToString(), out bidOpenDate);

                //if (dr[&quot;BidDueTime&quot;] != null &amp;&amp; dr[&quot;BidDueTime&quot;].ToString() != &quot;&quot;)
                //{
                //    string openingTime = dr[&quot;BidDueTime&quot;].ToString();
                //    int.TryParse(openingTime.Split(&quot;:&quot;.ToCharArray())[0], out bidOpenHr);
                //    int.TryParse(openingTime.Split(&quot;:&quot;.ToCharArray())[1], out bidOpenMin);
                //}

                //bidOpenDate = bidOpenDate.AddHours(bidOpenHr).AddMinutes(bidOpenMin);

                //if (status == &quot;Issued&quot; &amp;&amp;
                //    DateTime.Today &gt;= issueDate.Date &amp;&amp;
                //    bidOpenDate &gt;= DateTime.UtcNow)
                //{
                //    enableEdit = enableNew = true;
                //}

                if (status == &quot;Issued&quot;)
                    enableEdit = enableNew = true;
            }

            btnDeleteBids = new Button() { ID = &quot;btnGhostDeleteBids&quot;, CausesValidation = false };

            btnDeleteBids.Click += DeleteBids_Click;
            btnDeleteBids.Style.Add(&quot;display&quot;, &quot;none&quot;);
            (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterClientScriptInclude(&quot;EstimatorJS&quot;, VirtualPathUtility.ToAbsolute(&quot;~/Modules/ESTMATE/Scripts/Estimator_20150127_0013.js&quot;));
            (HttpContext.Current.CurrentHandler as Page).Form.Controls.Add(btnDeleteBids);
        }

        public override void OnPreRender()
        {
            DataTable[] dtTemp = EstimateManager.Instance.GetChoosenAlternates(ProjectEstimateID.ToInt32_2());
            string selIDs = string.Empty;
            foreach (DataRow item in dtTemp[1].Rows)
                selIDs = selIDs + item[&quot;AlternateID&quot;].ToString() + &quot;,&quot;;
            if (!string.IsNullOrEmpty(selIDs))
                alternatePickerGrid.CheckedItemIDs = selIDs.Trim(&#39;,&#39;);

            base.OnPreRender();
        }

        private void InitializePicker(Aurigo.Brix.Platform.BusinessLayer.UserControls.PickerGrid grid, string key, Page pg)
        {
            grid.TriggerButton.Style.Add(&quot;display&quot;, &quot;none&quot;);
            grid.EnableMultiSelect = true;
            grid.PostBackAfterSelect = true;
            string json = &quot;{\&quot;ProjectEstimateID\&quot;:\&quot;&quot; + ProjectEstimateID + &quot;\&quot;}&quot;;
            grid.OptionalParamaters = grid.BuildOptionalParameters(json);

            if (key == &quot;Contractor&quot;)
            {
                grid.InitializePicker(&quot;/api/BidContractor&quot;, GetContractorGridColumns(), &quot;ID&quot;);
                grid.EnableFilter = true;
                grid.Title = &quot;Contractor List&quot;;
                grid.OnItemSelected += new PickerGrid.SelectedItems(contractorPickerGrid_OnItemSelected);
            }
            else
            {
                grid.InitializePicker(&quot;/api/Alternates&quot;, GetAlternatesGridColumns(), &quot;AlternateID&quot;);
                grid.Title = &quot;Choose Alternates&quot;;
                grid.EnableFilter = false;
                grid.OnItemSelected += new PickerGrid.SelectedItems(alternatePickerGrid_OnItemSelected);
            }
        }

        private void contractorPickerGrid_OnItemSelected(PickerGrid grid, List&lt;Dictionary&lt;string, object&gt;&gt; selectedRows)
        {
            if (selectedRows.Count &gt; 0)
            {
                foreach (Dictionary&lt;string, object&gt; contractor in selectedRows)
                    InviteBidders(contractor);
            }
            BindData();
        }

        private void InviteBidders(Dictionary&lt;string, object&gt; contractor)
        {
            EstimateBid dto = new EstimateBid();
            dto.ContractorID = dbVal(contractor[&quot;ID&quot;].ToString());
            dto.ContractorName = dbVal(contractor[&quot;Name&quot;].ToString());
            dto.ProjectEstimateID = ProjectEstimateID;
            dto.Address1 = dbVal(contractor[&quot;Address1&quot;].ToString());
            dto.Address2 = dbVal(contractor[&quot;Address2&quot;].ToString());
            dto.Address3 = dbVal(contractor[&quot;Address3&quot;].ToString());
            dto.City = dbVal(contractor[&quot;City&quot;].ToString());
            dto.State = dbVal(contractor[&quot;State&quot;].ToString());
            dto.Zip = dbVal(contractor[&quot;ZipCode&quot;].ToString());
            dto.Telephone = dbVal(contractor[&quot;PhoneNo&quot;].ToString());
            dto.Fax = dbVal(contractor[&quot;FaxNo&quot;].ToString());
            dto.Email = dbVal(contractor[&quot;EmailID&quot;].ToString());
            dto.TelephoneExtn = dto.FaxExtn = String.Empty;
            if (!string.IsNullOrEmpty(dto.ContractorID) &amp;&amp; !string.IsNullOrEmpty(dto.ContractorName))
            {
                int returnValue = EstimateManager.Instance.AddBidInfo(dto);
                if (returnValue == 2)
                {
                    int bidid = EstimateManager.Instance.GetBidId(dto.ContractorID, dto.ContractorName, dto.ProjectEstimateID);
                    if (!string.IsNullOrEmpty(AMP3ApplicationSettings.Instance.ContractorBidderRole))
                    {
                        //object cLoginID = ComponentHelper.Instance.ExecuteScalar(
                        //string.Format(&quot;select ContractorLoginID from LibraryContractors where ID = &#39;{0}&#39; and ContractorLoginID &gt; 0 and ContractorLoginID not in (select UserID from ESTMATEBidderInvitationInfo WHERE PID={1} AND EstimateId={2})&quot;,
                        //dto.ContractorID, PID, ProjectEstimateID));
                        object cLoginID = EstimateManager.Instance.GetEstimateContractorLoginID(dto.ContractorID, PID, ProjectEstimateID);
                        if (cLoginID != null)
                        {
                            string userID = cLoginID.ToString();

                            //ComponentHelper.Instance.ExecuteNonQuery(
                            //    string.Format(&quot;INSERT INTO ESTMATEBidderInvitationInfo (PID,EstimateId,ContractorId,ContractorName,UserID,UserName,BidId) VALUES ({0},{1},&#39;{2}&#39;,&#39;{3}&#39;,{4},&#39;{5}&#39;,{6})&quot;,
                            //        PID, dto.ProjectEstimateID, dto.ContractorID, dto.ContractorName, userID, dbVal(userID), bidid));
                            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(EstimatorStoredProcedure.usp_ESTMATEInviteBidder, null, PID, dto.ProjectEstimateID, dto.ContractorID, dto.ContractorName, userID, dbVal(userID), bidid);
                        }
                    }
                    //Sent Eamil notification for invitees if the settings is checked
                    if (EstimateManager.Instance.GetEstimateBidSettings(ProjectEstimateID, EstimateManager.SendInviteEmail))
                    {
                        SendInviteMail(ProjectEstimateID, bidid);
                    }
                    //Create  workflow
                    var sParams = new string[] { };
                    StartWorkflowInstancesFor.SimulateWorkflowAction(true, false, &quot;XBIDLST&quot;, bidid.ToString(), ProjectEstimateID.ToString(),
                            PID.ToString(), &quot;Bid created for contractor - &quot; + dto.ContractorName, &quot;None&quot;, 1, &quot;&quot;, sParams);

                    //update FormKey
                    string query = &quot;update WorkflowFormMapping set FormKey=&#39;Contractor Name : &#39;+(select ContractorName from ESTMATEBidInfo where BidId={0}) where FormId=&#39;XBIDLST&#39; and FormInstanceID={0}&quot;;
                    ComponentHelper.Instance.ExecuteNonQuery(query, bidid);
                }
            }
        }

        private void SendInviteMail(int projectEstimateId, int bidId)
        {
            //            DataSet dsDetails = ComponentHelper.Instance.ExecuteDataSet(string.Format(@&quot;SELECT TemplateName,[Subject],Body FROM APPMGMTEmailNotifications WHERE TemplateName =  &#39;{0}&#39;;
            //                                                                            SELECT pm.ProjectCode,pm.ProjectName FROM ESTMATEInfo ei
            //                                                                            INNER JOIN PROJECTProjectMain pm on ei.ProjectID = pm.ProjectId
            //                                                                            where ei.ProjectEstimateID = {1};
            //                                                                            SELECT lc.Name,ud.FirstName,ud.LastName,ud.Email FROM ESTMATEBidInfo eb
            //                                                                            INNER JOIN LIBRARYContractors lc ON eb.ContractorId = lc.ID
            //                                                                            INNER JOIN USRMGMTUserDetails ud on lc.ContractorLoginID = ud.UserId
            //                                                                            WHERE eb.BidId = {2}&quot;, EstimateManager.SendInviteEmail, projectEstimateId, bidId));
            DataSet dsDetails = ComponentHelper.Instance.ExecuteDataSet(EstimatorStoredProcedure.usp_ESTMATEGetDetailsForBidderEmail, null, EstimateManager.SendInviteEmail, projectEstimateId, bidId);
            if (dsDetails != null &amp;&amp; dsDetails.Tables.Count == 3)
            {
                if (dsDetails.Tables[0] != null &amp;&amp; dsDetails.Tables[0].Rows.Count == 1 &amp;&amp; dsDetails.Tables[1] != null &amp;&amp; dsDetails.Tables[1].Rows.Count == 1 &amp;&amp; dsDetails.Tables[2] != null &amp;&amp; dsDetails.Tables[2].Rows.Count == 1)
                {
                    string appPath = ConfigurationManager.AppSettings[&quot;SiteRoot&quot;];
                    string fname = dsDetails.Tables[2].Rows[0][&quot;FirstName&quot;].ToString2();
                    string lname = dsDetails.Tables[2].Rows[0][&quot;LastName&quot;].Equals(DBNull.Value) ? string.Empty : dsDetails.Tables[2].Rows[0][&quot;LastName&quot;].ToString2();
                    string body = dsDetails.Tables[0].Rows[0][&quot;Body&quot;].ToString2().Format2(fname, lname, dsDetails.Tables[2].Rows[0][&quot;Name&quot;].ToString2(), dsDetails.Tables[1].Rows[0][&quot;ProjectCode&quot;].ToString2(), dsDetails.Tables[1].Rows[0][&quot;ProjectName&quot;].ToString2(), appPath);
                    string subject = dsDetails.Tables[0].Rows[0][&quot;Subject&quot;].ToString2().Format2(dsDetails.Tables[1].Rows[0][&quot;ProjectName&quot;].ToString2());
                    string toEmail = dsDetails.Tables[2].Rows[0][&quot;Email&quot;].ToString2();
                    if (!string.IsNullOrEmpty(toEmail))
                    {
                        Mailer.SendEmail(to: toEmail, subject: subject, body: body);
                    }
                }
            }
        }

        private string dbVal(string val)
        {
            return string.IsNullOrEmpty(val) ? string.Empty : val.Trim().Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;);
        }

        private int flag = 0;
        private string altIDList = string.Empty;
        private void alternatePickerGrid_OnItemSelected(PickerGrid grid, List&lt;Dictionary&lt;string, object&gt;&gt; selectedRows)
        {
            if (selectedRows.Count &gt; 0)
            {
                altIDList = string.Empty;
                foreach (Dictionary&lt;string, object&gt; alternates in selectedRows)
                    altIDList += alternates[&quot;AlternateID&quot;].ToString() + &quot;,&quot;;
                altIDList = altIDList.Trim(&#39;,&#39;);
                flag = 1;
            }
            BindData();
        }

        private List&lt;PickerColumnDetails&gt; GetContractorGridColumns()
        {
            List&lt;PickerColumnDetails&gt; gridColumns = new List&lt;PickerColumnDetails&gt;();

            List&lt;string&gt; allColumns = new List&lt;string&gt;() { &quot;ID&quot;, &quot;Name&quot;, &quot;RecordID&quot;, &quot;PhoneNo&quot;, &quot;FaxNo&quot;, &quot;EmailID&quot;, &quot;Contact&quot;, &quot;Address1&quot;, &quot;Address2&quot;, &quot;Address3&quot;, &quot;City&quot;, &quot;State&quot;, &quot;ZipCode&quot;, &quot;RowNum&quot;, &quot;ContractorLogin&quot;, &quot;Type&quot; };

            Dictionary&lt;string, string&gt; visibleColumns = new Dictionary&lt;string, string&gt;();

            visibleColumns.Add(&quot;ID&quot;, &quot;Contractor ID&quot;);
            visibleColumns.Add(&quot;Name&quot;, &quot;Contractor Name&quot;);
            visibleColumns.Add(&quot;PhoneNo&quot;, &quot;Phone Number&quot;);
            visibleColumns.Add(&quot;FaxNo&quot;, &quot;Fax Number&quot;);
            visibleColumns.Add(&quot;EmailID&quot;, &quot;Email ID&quot;);
            visibleColumns.Add(&quot;Type&quot;, &quot;Contract Type&quot;);
            if (!string.IsNullOrEmpty(AMP3ApplicationSettings.Instance.ContractorBidderRole))
                visibleColumns.Add(&quot;ContractorLogin&quot;, &quot;Contractor Login&quot;);

            foreach (string col in allColumns)
            {
                PickerColumnDetails tCol = (!visibleColumns.ContainsKey(col)) ? new PickerColumnDetails { Caption = col, ColumnName = col, Hidden = true } :
                    new PickerColumnDetails { Caption = visibleColumns[col], ColumnName = col, Hidden = false, Width = 200, Type = &quot;string&quot; };
                gridColumns.Add(tCol);
            }
            return gridColumns;
        }

        private List&lt;PickerColumnDetails&gt; GetAlternatesGridColumns()
        {
            List&lt;PickerColumnDetails&gt; gridColumns = new List&lt;PickerColumnDetails&gt;();
            List&lt;string&gt; allColumns = new List&lt;string&gt;() { &quot;AlternateID&quot;, &quot;Alternate_Code&quot;, &quot;Alternate_Name&quot;, &quot;Notes&quot; };

            Dictionary&lt;string, string&gt; visibleColumns = new Dictionary&lt;string, string&gt;();

            visibleColumns.Add(&quot;Alternate_Code&quot;, &quot;Alternate Code&quot;);
            visibleColumns.Add(&quot;Alternate_Name&quot;, &quot;Alternate Name&quot;);
            visibleColumns.Add(&quot;Notes&quot;, &quot;Notes&quot;);

            foreach (string col in allColumns)
            {
                PickerColumnDetails tCol = (!visibleColumns.ContainsKey(col)) ? new PickerColumnDetails { Caption = col, ColumnName = col, Hidden = true } :
                    new PickerColumnDetails { Caption = visibleColumns[col], ColumnName = col, Hidden = false, Width = 200, Type = &quot;string&quot; };
                gridColumns.Add(tCol);
            }
            return gridColumns;
        }

        public override int GetProjectIdFromInstanceId()
        {
            return EstimateManager.Instance.GetPIDFromEstimateId(Request[&quot;ProjectEstimateID&quot;].ToInt32_2());
        }

        public override string ModuleId
        {
            get { return &quot;ESTMATE&quot;; }
        }

        public override string ParentIDKey
        {
            get { return &quot;ProjectEstimateID&quot;; }
        }

        public override void SetUIDetails()
        {
            //Hidden Columns
            //ModifyColumnProperties(&quot;Multi&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ProjectEstimateId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ProjectId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;RowNum&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;EngTotal&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;ContractorId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;BidId&quot;, true, null, null, null, false);
            ModifyColumnProperties(&quot;Status&quot;, true, null, null, null, false);
            //Format Columns
            ModifyColumnProperties(&quot;ContractorName&quot;, false, null, null, null, false, &quot;Contractor&quot;);
            ModifyColumnProperties(&quot;Total&quot;, false, null, AMP3ApplicationSettings.Instance.FORMAT_AMOUNT, null, false);
            ModifyColumnProperties(MWGrid.GetGridFriendlyExpression(&quot;% Over Low Bid&quot;), false, null, EstimatorConstants.ESTMATE_PERCENTAGE_FORMAT, null, false, LocalizationManager.GetString(&quot;% Over Low Bid&quot;));
            ModifyColumnProperties(MWGrid.GetGridFriendlyExpression(&quot;% Estimate&quot;), false, null, EstimatorConstants.ESTMATE_PERCENTAGE_FORMAT, null, false,&quot;% Estimate&quot;);

            header = LocalizationManager.GetString(&quot;Bid List&quot;);

            //Buttons displayed
            displaySettings = true;
            displayDocuments = true;
            DisplayApplyFilter = true;
            if (BidAwardStatus == EstimatorConstants.AWARDED)
                displayDelete = displayNew = false;
            else
                displayDelete = displayNew = true;

            //Enabling Grid Double Click
            EnableGridDblClick = true;


        }

        public override string DocumentUrl
        {
            get { return &quot;~/Modules/DOCMGMT/DocumentView.aspx?PID={0}&amp;parent={1}&amp;context={2}&amp;module={3}&amp;HeaderTitle={4}&quot;.Format2(Request[&quot;PID&quot;], Request[&quot;ProjectEstimateID&quot;], ModuleId, &quot;ESTMBID&quot;, &quot;Estimate Bid&quot;); }
        }

        public override List&lt;MenuGroup&gt; MenuGroups
        {
            get
            {
                List&lt;MenuGroup&gt; menuGroups = base.MenuGroups;

                MenuGroup otherGroup = menuGroups.Find(mg =&gt; mg.Title == GROUP_OTHERS);
                if (otherGroup == null)
                {
                    otherGroup = new MenuGroup(GROUP_OTHERS);
                    menuGroups.Add(otherGroup);
                }
                //
                otherGroup.AddMenu(new TextIcon(&quot;lnkAlternates&quot;, &quot;Alternates&quot;, &quot;Icn_Settings_16.png&quot;));
                //Bid Tabulation
                otherGroup.AddMenu(new TextIcon(&quot;lnkBidTab&quot;, LocalizationManager.GetString(&quot;Bid Tabulation&quot;), &quot;Icn_tables_16.png&quot;,
                    (HttpContext.Current.CurrentHandler as Page).ResolveUrl(&quot;~/Modules/ESTMATE/BidTabulationSummary.aspx&quot;) + string.Format(&quot;?PID={0}&amp;ProjectEstimateID={1}&amp;ParentID={1}&amp;Context=ESTMATE&quot;, Request.QueryString[EstimatorConstants.PID], Request.QueryString[&quot;ProjectEstimateID&quot;])));

                //otherGroup.AddMenu(new TextIcon(&quot;lnkAward&quot;, &quot;Award&quot;, &quot;Icn_Award_16.png&quot;));
                //otherGroup.AddMenu(new TextIcon(&quot;lnkReject&quot;, &quot;Reject&quot;, &quot;Icn_Reject_16.png&quot;));
                //otherGroup.AddMenu(new TextIcon(&quot;lnkRevert&quot;, &quot;Revert&quot;, &quot;Icn_Revert_16.png&quot;));

                List&lt;string&gt; components = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_ESTMATE);

                if (components.Contains(&quot;BidManagementSettings&quot;) &amp;&amp; displaySettings)
                {
                    otherGroup.AddMenu(new TextIcon(&quot;lnkEstSettings&quot;, &quot;Settings&quot;, &quot;Icn_Attributes_16.png&quot;));
                }
                otherGroup.AddMenu(new TextIcon(&quot;lnkExport&quot;, ExcelHelper.EXCEL_TEMPLATE, &quot;Icn_export_16.png&quot;));
                otherGroup.AddMenu(new TextIcon(&quot;lnkExportXlsx&quot;, ExcelHelper.EXCEL_TEMPLATE_XLSX, &quot;Icn_export_16.png&quot;));
                return menuGroups;
            }
        }

        ////AWARD BID
        //protected void lnkAwardClick(object sender, EventArgs e)
        //{
        //    int nStatus = EstimateManager.Instance.UpdateAwardedStatus(1, GetActiveItemFromGrid().ToInt32_2(), ProjectEstimateID);
        //    if (nStatus == -2)
        //    {
        //        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
        //                HttpContext.Current.CurrentHandler.GetType(), &quot;lnkAwardClickMsg1&quot;,
        //                &quot;alert(&#39;Other Bids of this project is already awarded.&#39;);&quot;, true);
        //    }
        //    else if (nStatus == -3)
        //    {
        //        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
        //                HttpContext.Current.CurrentHandler.GetType(), &quot;lnkAwardClickMsg2&quot;,
        //                &quot;alert(&#39;Selected bid is already deleted by another user.&#39;);&quot;, true);
        //    }
        //    else
        //    {
        //        Response.Redirect(Request.RawUrl);
        //    }
        //}

        ////REJECT BID
        //protected void lnkRejectClick(object sender, EventArgs e)
        //{
        //    int nStatus = EstimateManager.Instance.UpdateAwardedStatus(-1, GetActiveItemFromGrid().ToInt32_2(), ProjectEstimateID);
        //    if (nStatus != -1)
        //        BindData();

        //    if (nStatus == -3)
        //    {
        //        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
        //                HttpContext.Current.CurrentHandler.GetType(), &quot;lnkRejectClickMsg&quot;,
        //                &quot;alert(&#39;Selected bid is already deleted by another user.&#39;);&quot;, true);
        //    }
        //    else
        //    {
        //        Response.Redirect(Request.RawUrl);
        //    }
        //}


        ////REVERT ACTION
        //protected void lnkRevertClick(object sender, EventArgs e)
        //{
        //    int nStatus = EstimateManager.Instance.UpdateAwardedStatus(2, GetActiveItemFromGrid().ToInt32_2(), ProjectEstimateID);
        //    if (nStatus == -3)
        //    {
        //        (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
        //                HttpContext.Current.CurrentHandler.GetType(), &quot;lnkRevertClickMsg&quot;,
        //                &quot;alert(&#39;Selected bid is already deleted by another user.&#39;);&quot;, true);
        //    }
        //    else
        //    {
        //        Response.Redirect(Request.RawUrl);
        //    }
        //}
        public override string HandleMenuItems(string eventString,
                                           UltraWebGridExcelExporter UltraWebGridExcelExporter1, string filter = &quot;&quot;)
        {
            string error = String.Empty;
            if (eventString.ToLower().Contains(&quot;xls&quot;) || eventString.ToLower().Contains(&quot;xlsx&quot;))
            {
                Export(eventString, filter);
                isMenuClickHandled = true;
            }
            else
            {
                error = base.HandleMenuItems(eventString, UltraWebGridExcelExporter1, filter);
            }
            return error;
        }
        /// &lt;summary&gt;
        /// Method to download excel file in selected format.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;strFilenameWithExtention&quot;&gt;&lt;/param&gt;
        private void Export(string strFilenameWithExtention, string filter)
        {
            DataSet dsExcelData = new DataSet();
            DataTable dt = EstimateManager.Instance.GetBidItems(Request.QueryString[&quot;ProjectEstimateID&quot;].ToInt32_2(), Request.QueryString[&quot;ProjectEstimateID&quot;].ToInt32_2()).Select(filter).CopyToDataTable();
            dsExcelData.DataSetName = &quot;BidItemList&quot;;//Excel file name.
            dt.TableName = &quot;BidItemList&quot;;//Worksheet name
            dsExcelData.Tables.Add(dt.Copy());
            ExcelExportEntity excelExportEntity = new ExcelExportEntity(dsExcelData);
            ExcelHelper.ExportToExcel(strFilenameWithExtention, excelExportEntity);

        }
        private void FormatGrid(UltraWebGrid grid, DataTable dt)
        {

            if (dt.Rows.Count &gt; 0)
            {
                ColumnsCollection cols = grid.Bands[0].Columns;


                if (cols.Exists(&quot;Accounting Code&quot;))
                    cols.FromKey(&quot;Accounting Code&quot;).Hidden = true;
                if (cols.Exists(&quot;AlternateID&quot;))
                    cols.FromKey(&quot;AlternateID&quot;).Hidden = true;
                if (cols.Exists(&quot;Path&quot;))
                    cols.FromKey(&quot;Path&quot;).Hidden = true;
                cols.FromKey(&quot;ItemId&quot;).Hidden = true;
                cols.FromKey(&quot;MustBid&quot;).Hidden = true;
                cols.FromKey(&quot;ProjectEstimateId&quot;).Hidden = true;

                cols.FromKey(&quot;UnitPrice&quot;).Header.Caption = &quot;Unit Price&quot;;
                cols.FromKey(&quot;UnitPrice&quot;).FieldLen = 14;
                cols.FromKey(&quot;amount&quot;).Header.Caption = &quot;Amount&quot;;

                // Setting the format for the columns.
                cols.FromKey(&quot;quantity&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_QUANTITY;
                cols.FromKey(&quot;UnitPrice&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_UNIT_PRICE;
                cols.FromKey(&quot;amount&quot;).Format = AMP3ApplicationSettings.Instance.FORMAT_AMOUNT;

                // Setting the alignement for the columns.
                cols.FromKey(&quot;quantity&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;UnitPrice&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;
                cols.FromKey(&quot;amount&quot;).CellStyle.HorizontalAlign = HorizontalAlign.Right;

                cols.FromKey(&quot;Line No.&quot;).Move(0);
                cols.FromKey(&quot;Pay Item No.&quot;).Move(1);
                cols.FromKey(&quot;Description&quot;).Move(2);
                cols.FromKey(&quot;Quantity&quot;).Move(3);
                cols.FromKey(&quot;Unit&quot;).Move(4);
                cols.FromKey(&quot;UnitPrice&quot;).Move(5);
                cols.FromKey(&quot;Amount&quot;).Move(6);
                cols.FromKey(&quot;AlternateCode&quot;).Move(7);

                // Group By column
                cols.FromKey(&quot;AlternateCode&quot;).IsGroupByColumn = true;

                //First Sorted by Path
                if (cols.Exists(&quot;Path&quot;))
                {
                    grid.DisplayLayout.Bands[0].SortedColumns.Add(&quot;Path&quot;);
                    grid.Columns.FromKey(&quot;Path&quot;).SortIndicator = SortIndicator.Ascending;
                }

                grid.DisplayLayout.Bands[0].SortedColumns.Add(&quot;Line No.&quot;);
                grid.Columns.FromKey(&quot;Line No.&quot;).SortIndicator = SortIndicator.Ascending;



                grid.Columns.FromKey(&quot;UnitPrice&quot;).CellStyle.BackColor = Color.Yellow;
                foreach (UltraGridRow r in grid.Rows)
                {
                    if (r.Cells.FromKey(&quot;MustBid&quot;).Value.Equals(true))
                    {
                        r.Cells.FromKey(&quot;UnitPrice&quot;).Style.BackColor = Color.White;
                    }
                }
            }
        }
        public override void HandleGridRowInitialization&lt;T&gt;(object sender, T row)
        {
            if (row is GridDataItem)
            {
                short val = MWGrid.GetCellValue(row, &quot;Status&quot;).ToInt16_2();
                string imagePath = (val == EstimatorConstants.AWARDED)
                                                                          ? &quot;../Images/toolbar/IcnAward.gif&quot;
                                                                          : (val == EstimatorConstants.REJECTED) ? &quot;../Images/toolbar/IcnUnapprove.gif&quot;
                                                                          : (val == EstimatorConstants.CANCELLED) ? &quot;../Images/toolbar/IcnUnapprove.gif&quot;
                                                                          : null;
                if (imagePath != null)
                {
                    MWGrid.SetCellBackgroundImage(row, &quot;Status&quot;, imagePath);
                }

                MWGrid.SetCellValue(row, &quot;Status&quot;, (val == EstimatorConstants.AWARDED)
                                                          ? &quot;Awarded&quot;
                                                          : (val == EstimatorConstants.REJECTED) ? &quot;Rejected&quot;
                                                          : (val == EstimatorConstants.CANCELLED) ? &quot;Cancelled&quot; : &quot; &quot;);

                MWGrid.SetCellStyle(row, &quot;Status&quot;, &quot;padding-left&quot;, &quot;16px&quot;);
                MWGrid.SetCellStyle(row, &quot;Status&quot;, &quot;background-repeat&quot;, &quot;no-repeat&quot;);
                base.HandleGridRowInitialization(sender, row);
            }
        }

        public override string NewURL
        {
            get
            {
                return string.Format(&quot;~/Modules/ESTMATE/NewBid.aspx?{0}={1}&amp;ProjectEstimateID={2}&amp;ParentID={2}&amp;Context=ESTMATE&quot;, EstimatorConstants.PID, PID, ProjectEstimateID);
            }
        }

        public override void HandleNew()
        {
            //
        }

        public override void HandleEdit()
        {
            if (MWGrid.GetSelectedRow(mwGrid) != null &amp;&amp; MWGrid.GetCellValue(MWGrid.GetSelectedRow(mwGrid), &quot;WF_Status&quot;) == &quot;Submitted&quot;)

                Response.Redirect(string.Format(&quot;~/Modules/ESTMATE/ViewBidDetails.aspx?Mode=View&amp;BidId={0}&amp;{1}={2}&amp;ProjectEstimateID={3}&amp;ParentID={3}&amp;Context=ESTMATE&quot;,
                 GetActiveItemFromGrid(), EstimatorConstants.PID, PID, ProjectEstimateID), true);
            else if (string.IsNullOrEmpty(GetActiveItemFromGrid()))
                throw new Exception(&quot;Please select one record&quot;);
            else
                Response.Redirect(string.Format(&quot;~/Modules/ESTMATE/ViewBidDetails.aspx?Mode=Edit&amp;BidId={0}&amp;{1}={2}&amp;ProjectEstimateID={3}&amp;ParentID={3}&amp;Context=ESTMATE&quot;,
                GetActiveItemFromGrid(), EstimatorConstants.PID, PID, ProjectEstimateID), true);
        }

        public override void HandleView()
        {
            if (string.IsNullOrEmpty(GetActiveItemFromGrid()))
                throw new Exception(&quot;Please select one record&quot;);
            Response.Redirect(string.Format(&quot;~/Modules/ESTMATE/ViewBidDetails.aspx?Mode=View&amp;BidId={0}&amp;{1}={2}&amp;ProjectEstimateID={3}&amp;ParentID={3}&amp;Context=ESTMATE&quot;,
                GetActiveItemFromGrid(), EstimatorConstants.PID, PID, ProjectEstimateID), true);
        }

        public override int HandleDelete()
        {
            //int BidId = GetActiveItemFromGrid().ToInt32_2();

            string bidIDs = GetSelectedIds();

            //Check if all the bids cane be deleted
            string bidsToBeDeleted = FilterIdsToDeleteBasedOnWFDefinitions(FormName, PID.ToString2(), Request.QueryString[&quot;ProjectEstmateID&quot;], bidIDs);

            //check if value has been entered for any of the bid
            if (HasUnitPrice(bidsToBeDeleted))
            {
                btnDeleteBids.CommandArgument = bidsToBeDeleted;

                (HttpContext.Current.CurrentHandler as Page).ClientScript.RegisterStartupScript(
                        HttpContext.Current.CurrentHandler.GetType(), &quot;ConfirmBidDelete&quot;,
                        &quot;ConfirmBidDelete(&#39;&quot; + btnDeleteBids.ClientID + &quot;&#39;);&quot;, true);

                //throw new Exception(&quot;There are bids submitted by the contractor(s). Do you want to continue with deletion?&quot;);
                return 0;
            }

            DeleteBids(bidsToBeDeleted);

            return 0;
        }

        protected void DeleteBids_Click(object sender, EventArgs e)
        {
            DeleteBids(((Button)sender).CommandArgument);
        }

        private void DeleteBids(string bidIDs)
        {
            foreach (string i in bidIDs.Split(&quot;,&quot;.ToCharArray()))
            {
                int BidId;

                int.TryParse(i, out BidId);

                int nStatus = EstimateManager.Instance.DeleteBid(BidId);
                if (nStatus != 0)
                    throw new Exception((nStatus == -3) ? &quot;This bid is already deleted by another user.&quot; : &quot;Error deleting.&quot;);

                //Reached here which means no error thrown and bidLetting has successfully deleted,  Now delete related attachments
                List&lt;LinksDTO.LinkDetails&gt; linksList = LinksManager.Instance.GetLinksForModuleInstance(BidId.ToString2(), &quot;ESTMBID&quot;, string.Empty);

                //Select throws error if linksList is null
                if (linksList != null)
                {
                    List&lt;int&gt; list = linksList.Select(a =&gt; a.LinkID).ToList();
                    Hashtable Returnval = LinksManager.Instance.RemoveLinks(list);
                }
            }

            //delete all related workflows
            if (!string.IsNullOrEmpty(bidIDs))
                ForceDeleteWorkflowsForThisForm(bidIDs.TrimEnd(&#39;,&#39;), FormName);

            BindData();
        }

        private bool HasUnitPrice(string bidIDs)
        {
            return EstimateManager.Instance.HasUnitPrice(bidIDs);
        }

        public override void HandleGridDblClick&lt;T&gt;(T row)
        {
            try
            {
                if (MWGrid.GetSelectedRow(mwGrid) != null)
                    Response.Redirect(string.Format(&quot;~/Modules/ESTMATE/ViewBidDetails.aspx?Mode=View&amp;BidId={0}&amp;{1}={2}&amp;ProjectEstimateID={3}&amp;ParentID={3}&amp;Context=ESTMATE&quot;,
                             GetActiveItemFromGrid(), EstimatorConstants.PID, Request[EstimatorConstants.PID], ProjectEstimateID), true);
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        int? _BidAwardStatus = null;
        private int BidAwardStatus
        {
            get
            {
                //if (!_BidAwardStatus.HasValue)
                _BidAwardStatus = EstimateManager.Instance.GetBidAwardStatus(ProjectEstimateID);
                return _BidAwardStatus.Value;
            }
        }


        public override void CustomizeToolBarMenu(ToolBar toolBar)
        {
            base.CustomizeToolBarMenu(toolBar);
            MainToolBar = toolBar;
            if (BidAwardStatus == EstimatorConstants.AWARDED)
            {
                if (toolBar.GetMenuReference(&quot;lnkNew&quot;) != null)
                    toolBar.DisableMenu(&quot;lnkNew&quot;);
                if (toolBar.GetMenuReference(&quot;lnkDelete&quot;) != null)
                    toolBar.DisableMenu(&quot;lnkDelete&quot;);
                if (toolBar.GetMenuReference(&quot;lnkNew&quot;) != null)
                    toolBar.GetMenuReference(&quot;lnkNew&quot;).Visible = false;
                if (toolBar.GetMenuReference(&quot;lnkDelete&quot;) != null)
                    toolBar.GetMenuReference(&quot;lnkDelete&quot;).Visible = false;
                if (toolBar.GetMenuReference(&quot;lnkWorkFlowAttach&quot;) != null)
                    toolBar.GetMenuReference(&quot;lnkWorkFlowAttach&quot;).Visible = false;

            }
            else
            {
                if (toolBar.GetMenuReference(&quot;lnkNew&quot;) != null)
                    toolBar.GetMenuReference(&quot;lnkNew&quot;).Visible = true;
                if (toolBar.GetMenuReference(&quot;lnkDelete&quot;) != null)
                    toolBar.GetMenuReference(&quot;lnkDelete&quot;).Visible = true;
                if (toolBar.GetMenuReference(&quot;lnkWorkFlowAttach&quot;) != null)
                    toolBar.GetMenuReference(&quot;lnkWorkFlowAttach&quot;).Visible = true;
                if (toolBar.GetMenuReference(&quot;lnkDelete&quot;) != null)
                    toolBar.EnableMenu(&quot;lnkDelete&quot;);
                if (enableNew &amp;&amp; toolBar.GetMenuReference(&quot;lnkNew&quot;) != null)
                {
                    toolBar.EnableMenu(&quot;lnkNew&quot;);
                    toolBar.GetMenuReference(&quot;lnkNew&quot;).OnClientClick = &quot;$(&#39;#&quot; + contractorPickerGrid.TriggerButton.ClientID + &quot;&#39;).click();return false;&quot;;
                }
            }

            if (toolBar.GetMenuReference(&quot;lnkAlternates&quot;) != null)
                toolBar.GetMenuReference(&quot;lnkAlternates&quot;).OnClientClick = &quot;$(&#39;#&quot; + alternatePickerGrid.TriggerButton.ClientID + &quot;&#39;).click();return false;&quot;;

            //if (toolBar.GetMenuReference(&quot;lnkAward&quot;) != null)
            //{
            //    toolBar.GetMenuReference(&quot;lnkAward&quot;).Click += lnkAwardClick;
            //    toolBar.AddAttributeToMenu(&quot;lnkAward&quot;, &quot;onClick&quot;, &quot;return lnkValidation(&#39;&quot; + Convert.ToInt32(ValidateSelection.OneItem, CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; + brixGrid.ClientID + &quot;&#39;, &#39;BidId&#39;);&quot;);
            //}
            //if (toolBar.GetMenuReference(&quot;lnkReject&quot;) != null)
            //{
            //    toolBar.GetMenuReference(&quot;lnkReject&quot;).Click += lnkRejectClick;
            //    toolBar.AddAttributeToMenu(&quot;lnkReject&quot;, &quot;onClick&quot;, &quot;return lnkValidation(&#39;&quot; + Convert.ToInt32(ValidateSelection.OneItem, CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; + brixGrid.ClientID + &quot;&#39;, &#39;BidId&#39;);&quot;);
            //}
            //if (toolBar.GetMenuReference(&quot;lnkRevert&quot;) != null)
            //{
            //    toolBar.GetMenuReference(&quot;lnkRevert&quot;).Click += lnkRevertClick;
            //    toolBar.AddAttributeToMenu(&quot;lnkRevert&quot;, &quot;onClick&quot;, &quot;return lnkValidation(&#39;&quot; + Convert.ToInt32(ValidateSelection.OneItem, CultureInfo.CurrentCulture) + &quot;&#39;, &#39;&quot; + brixGrid.ClientID + &quot;&#39;, &#39;BidId&#39;);&quot;);
            //}

            if (toolBar.GetMenuReference(&quot;lnkEstSettings&quot;) != null)
            {
                toolBar.GetMenuReference(&quot;lnkEstSettings&quot;).OnClientClick = estimateSettings.TriggerClickFunction;
            }

            if (!enableEdit) toolBar.DisableMenu(&quot;lnkEdit&quot;);
            if (!enableNew) toolBar.DisableMenu(&quot;lnkNew&quot;);
        }

        public override string DefaultSortColumn
        {
            get
            {
                return &quot;Rank&quot;;
            }
        }

        public override Telerik.Web.UI.GridSortOrder DefaultSortIndicator
        {
            get
            {
                return Telerik.Web.UI.GridSortOrder.Ascending;
            }
        }

        private int ProjectEstimateID
        {
            get
            {
                if (Request != null &amp;&amp; !string.IsNullOrEmpty(Request.QueryString[&quot;ProjectEstimateID&quot;]))
                    return Request[&quot;ProjectEstimateID&quot;].ToInt32_2();
                else return 0;
            }
        }

        private int PID
        {
            get
            {
                return Request[&quot;PID&quot;].ToInt32_2();
            }
        }

        public override DataSet GetList(int pageSize, string sortOrder, string filter, ref int CurrentPage,
                                        out int count)
        {
            #region Override SortOrder for DefaultSortColumn
            string sortKey = DefaultSortColumn;
            sortOrder = (sortKey.Contains(&quot;[&quot;) &amp;&amp; sortKey.Contains(&quot;]&quot;)) ? &quot;{0} ASC&quot;.Format2(sortKey) : &quot;[{0}] ASC&quot;.Format2(sortKey);
            #endregion

            #region Override SortOrder for Image Cols
            sortOrder = string.IsNullOrEmpty(sortOrder) ? DefaultSortColumn : sortOrder;
            if (!string.IsNullOrEmpty(sortOrder) &amp;&amp; sortOrder.Contains(&quot;img_&quot;))
                sortOrder = sortOrder.Replace(&quot;img_&quot;, string.Empty);
            #endregion

            int startIdx = 1 + (pageSize * (CurrentPage - 1));

            DataTable dtBids = EstimateManager.Instance.GetBidList(ProjectEstimateID, flag, altIDList, startIdx, pageSize, sortOrder, filter, &quot;N&quot;);
            double cnt = EstimateManager.Instance.GetBidListCount(ProjectEstimateID);
            count = cnt &gt; pageSize ? (int)Math.Ceiling(cnt / pageSize) : 1;
            return dtBids.DataSet;
        }

        public override string GetEditPageURL(string pID, string parentID, string instanceID, string context)
        {
            return string.Format(&quot;~/Modules/ESTMATE/ViewBidDetails.aspx?Mode=Edit&amp;BidId={0}&amp;{1}={2}&amp;ProjectEstimateID={3}&amp;ParentID={3}&amp;Context=ESTMATE&quot;, instanceID, EstimatorConstants.PID, pID, parentID);
        }

        public override string GetViewPageURL(string pID, string parentID, string instanceID, string context)
        {
            return string.Format(&quot;~/Modules/ESTMATE/ViewBidDetails.aspx?Mode=View&amp;BidId={0}&amp;{1}={2}&amp;ProjectEstimateID={3}&amp;ParentID={3}&amp;Context=ESTMATE&quot;, instanceID, EstimatorConstants.PID, pID, parentID);
        }

        public override bool HasAttachments { get { return true; } }

        Dictionary&lt;int, int&gt; folderIDs = new Dictionary&lt;int, int&gt;();
        public override int FolderID(string pID, string parentID, string instanceID, string context)
        {
            if (!folderIDs.ContainsKey(instanceID.ToInt32_2()))
                folderIDs.Add(instanceID.ToInt32_2(), DocumentManager.Instance.GetInstanceRootFolder(instanceID.ToInt32_2(), &quot;ESTMATE&quot;).FolderId);
            return folderIDs[instanceID.ToInt32_2()];
        }

        public string FormName
        {
            get { return &quot;XBIDLST&quot;; }
        }

        public string ListPrimaryKey
        {
            get { return QueryStringName; }
        }

        int IWorkflowEnabledList.PID
        {
            get { return PID; }
        }

        public int ParentModuleId
        {
            get { return ProjectEstimateID; }
        }

        public override void WorkflowActionComplete()
        {
            base.WorkflowActionComplete();

            SetUIDetails();

            MainToolBar.CreateToolBar(MenuGroups);

            CustomizeToolBarMenu(MainToolBar);

            (HttpContext.Current.CurrentHandler as BrixPageBase).AddWorkflowButtons();
            (HttpContext.Current.CurrentHandler as BrixPageBase).AddAllWorkflowButtons();


            //if (BidAwardStatus == EstimatorConstants.AWARDED)
            //    displayDelete = displayNew = false;
            //else
            //    displayDelete = displayNew = true;

            //if (BidAwardStatus == EstimatorConstants.AWARDED)
            //{
            //    MainToolBar.DisableMenu(&quot;lnkNew&quot;);
            //    MainToolBar.DisableMenu(&quot;lnkDelete&quot;);
            //}
            //else
            //{

            //    MainToolBar.EnableMenu(&quot;lnkDelete&quot;);
            //    if (enableNew)
            //    {
            //        MainToolBar.EnableMenu(&quot;lnkNew&quot;);
            //        if (MainToolBar.GetMenuReference(&quot;lnkNew&quot;) != null)
            //            MainToolBar.GetMenuReference(&quot;lnkNew&quot;).OnClientClick = &quot;$(&#39;#&quot; + contractorPickerGrid.TriggerButton.ClientID + &quot;&#39;).click();return false;&quot;;
            //    }
            //}

            //if (!enableEdit) MainToolBar.DisableMenu(&quot;lnkEdit&quot;);
            //if (!enableNew) MainToolBar.DisableMenu(&quot;lnkNew&quot;);
        }
    }

    [Authorize]
    public class BidContractorController : ApiController
    {
        [HttpGet]
        public HttpResponseMessage Get(HttpRequestMessage requestMessage)
        {
            DataSourceRequest request = JsonConvert.DeserializeObject&lt;DataSourceRequest&gt;(requestMessage.RequestUri.ParseQueryString().GetKey(0));

            KendoDataSource jf = GetBidContractorDetails(request);

            JObject jObject = JObject.FromObject(jf);
            var dffd = Request.CreateResponse&lt;JObject&gt;(HttpStatusCode.Created, jObject);
            return dffd;
        }
        private KendoDataSource GetBidContractorDetails(DataSourceRequest request)
        {
            string selectedIDs = string.Empty;

            EstimateBidListData data = JsonConvert.DeserializeObject&lt;EstimateBidListData&gt;(request.additionalParameters.ToString());
            object obj = ComponentHelper.Instance.ExecuteScalar(&quot;DECLARE @listStr VARCHAR(MAX) select @listStr = COALESCE(@listStr + &#39;,&#39; ,&#39;&#39;) + ContractorId from ESTMATEBidInfo where ProjectEstimateId = {0} select @listStr&quot;, data.ProjectEstimateID);
            if (obj != null)
                selectedIDs = obj.ToString();

            if (request.additionalInfo != null &amp;&amp; !string.IsNullOrEmpty(request.additionalInfo.ToString()))
                selectedIDs += request.additionalInfo.ToString();

            int take = request.Take;
            int skip = request.Skip;
            IEnumerable&lt;KendoSort&gt; sort = request.Sort;
            KendoFilter filter = request.Filter;

            int StartIndex = skip + 1;

            string sortBy = null;
            if (sort != null &amp;&amp; sort.Count() &gt; 0)
                sortBy = sort.ToQuery();
            string filterQ = (null == filter) ? string.Empty : filter.ToQuery();
            int total = ContractorManager.BLInstance.GetContractorsCount(null, null, filterQ, selectedIDs);
            DataTable dt = ContractorManager.BLInstance.GetContractors(null, StartIndex, take, sortBy, null, filterQ, selectedIDs);

            return new KendoDataSource
            {
                Data = dt.GetKendoDataSource(),
                Total = total
            };
        }
    }

    [Authorize]
    public class AlternatesController : ApiController
    {
        [HttpGet]
        public HttpResponseMessage Get(HttpRequestMessage requestMessage)
        {
            DataSourceRequest request = JsonConvert.DeserializeObject&lt;DataSourceRequest&gt;(requestMessage.RequestUri.ParseQueryString().GetKey(0));

            KendoDataSource jf = GetAlternatesDetails(request);

            JObject jObject = JObject.FromObject(jf);
            var dffd = Request.CreateResponse&lt;JObject&gt;(HttpStatusCode.Created, jObject);
            return dffd;
        }
        private KendoDataSource GetAlternatesDetails(DataSourceRequest request)
        {
            EstimateBidListData data = JsonConvert.DeserializeObject&lt;EstimateBidListData&gt;(request.additionalParameters.ToString());
            DataTable[] dtTemp = EstimateManager.Instance.GetChoosenAlternates(data.ProjectEstimateID.ToInt32_2());
            DataTable dt = dtTemp[0];
            dt.Columns[&quot;Alternate Code&quot;].ColumnName = &quot;Alternate_Code&quot;;
            dt.Columns[&quot;Alternate Name&quot;].ColumnName = &quot;Alternate_Name&quot;;
            dt.AcceptChanges();

            return new KendoDataSource
            {
                Data = dt.GetKendoDataSource(),
                Total = dt.Rows.Count
            };
        }
    }

    public class EstimateBidListData
    {
        public string ProjectEstimateID { get; set; }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[51,9,51,40,1],[52,9,52,41,1],[57,17,57,18,1],[57,19,57,34,1],[57,35,57,36,1],[61,9,61,10,1],[62,13,62,27,1],[64,13,64,68,1],[66,13,66,105,1],[67,13,67,62,1],[68,13,68,70,1],[69,13,69,56,1],[71,13,71,104,1],[72,13,72,60,1],[73,13,73,68,1],[74,13,74,55,1],[76,13,76,127,1],[77,13,77,54,1],[78,13,78,52,1],[80,13,80,134,1],[82,13,82,49,1],[83,13,83,14,1],[84,17,84,75,1],[86,17,86,57,1],[109,17,109,40,1],[110,21,110,51,1],[111,13,111,14,1],[113,13,113,98,1],[115,13,115,53,1],[116,13,116,56,1],[117,13,117,201,1],[118,13,118,91,1],[119,9,119,10,1],[122,9,122,10,1],[123,13,123,111,1],[124,13,124,42,1],[125,13,125,20,1],[125,22,125,34,1],[125,35,125,37,1],[125,38,125,52,1],[126,17,126,72,1],[127,13,127,47,1],[128,17,128,71,1],[130,13,130,32,1],[131,9,131,10,1],[134,9,134,10,1],[135,13,135,61,1],[136,13,136,43,1],[137,13,137,45,1],[138,13,138,83,1],[139,13,139,74,1],[141,13,141,37,1],[142,13,142,14,1],[143,17,143,95,1],[144,17,144,42,1],[145,17,145,48,1],[146,17,146,106,1],[147,13,147,14,1],[149,13,149,14,1],[150,17,150,101,1],[151,17,151,50,1],[152,17,152,43,1],[153,17,153,105,1],[154,13,154,14,1],[155,9,155,10,1],[158,9,158,10,1],[159,13,159,40,1],[160,13,160,14,1],[161,17,161,24,1],[161,26,161,63,1],[161,64,161,66,1],[161,67,161,79,1],[162,21,162,47,1],[163,13,163,14,1],[164,13,164,24,1],[165,9,165,10,1],[168,9,168,10,1],[169,13,169,49,1],[170,13,170,67,1],[171,13,171,71,1],[172,13,172,55,1],[173,13,173,69,1],[174,13,174,69,1],[175,13,175,69,1],[176,13,176,61,1],[177,13,177,63,1],[178,13,178,63,1],[179,13,179,69,1],[180,13,180,61,1],[181,13,181,65,1],[182,13,182,60,1],[183,13,183,102,1],[184,13,184,14,1],[185,17,185,76,1],[186,17,186,38,1],[187,17,187,18,1],[188,21,188,128,1],[189,21,189,102,1],[190,21,190,22,1],[194,25,194,139,1],[195,25,195,46,1],[196,25,196,26,0],[197,29,197,65,0],[202,29,202,244,0],[203,25,203,26,0],[204,21,204,22,1],[206,21,206,125,1],[207,21,207,22,0],[208,25,208,66,0],[209,21,209,22,0],[211,21,211,52,1],[212,21,213,123,1],[216,21,216,204,1],[217,21,217,76,1],[218,17,218,18,1],[219,13,219,14,1],[220,9,220,10,1],[223,9,223,10,0],[232,13,232,200,0],[233,13,233,66,0],[234,13,234,14,0],[235,17,235,228,0],[236,17,236,18,0],[237,21,237,83,0],[238,21,238,89,0],[239,21,239,166,0],[240,21,240,275,0],[241,21,241,153,0],[242,21,242,87,0],[243,21,243,56,0],[244,21,244,22,0],[245,25,245,85,0],[246,21,246,22,0],[247,17,247,18,0],[248,13,248,14,0],[249,9,249,10,0],[252,9,252,10,1],[253,13,253,93,1],[254,9,254,10,1],[256,9,256,30,1],[257,9,257,49,1],[259,9,259,10,0],[260,13,260,40,0],[261,13,261,14,0],[262,17,262,42,0],[263,17,263,24,0],[263,26,263,63,0],[263,64,263,66,0],[263,67,263,79,0],[264,21,264,77,0],[265,17,265,49,0],[266,17,266,26,0],[267,13,267,14,0],[268,13,268,24,0],[269,9,269,10,0],[272,9,272,10,1],[273,13,273,85,1],[275,13,275,230,1],[277,13,277,90,1],[279,13,279,55,1],[280,13,280,59,1],[281,13,281,59,1],[282,13,282,55,1],[283,13,283,55,1],[284,13,284,57,1],[285,13,285,94,1],[286,17,286,75,1],[288,13,288,20,1],[288,22,288,32,1],[288,33,288,35,1],[288,36,288,46,1],[289,13,289,14,1],[290,17,291,143,1],[292,17,292,39,1],[293,13,293,14,1],[294,13,294,32,1],[295,9,295,10,1],[298,9,298,10,1],[299,13,299,85,1],[300,13,300,121,1],[302,13,302,90,1],[304,13,304,68,1],[305,13,305,68,1],[306,13,306,50,1],[308,13,308,20,1],[308,22,308,32,1],[308,33,308,35,1],[308,36,308,46,1],[309,13,309,14,1],[310,17,311,143,1],[312,17,312,39,1],[313,13,313,14,1],[314,13,314,32,1],[315,9,315,10,1],[318,9,318,10,1],[319,13,319,108,1],[320,9,320,10,1],[324,17,324,18,1],[324,19,324,36,1],[324,37,324,38,1],[329,17,329,18,0],[329,19,329,46,0],[329,47,329,48,0],[333,9,333,10,1],[336,13,336,88,1],[337,13,337,80,1],[338,13,338,77,1],[339,13,339,79,1],[340,13,340,83,1],[341,13,341,76,1],[342,13,342,77,1],[344,13,344,100,1],[345,13,345,119,1],[346,13,346,209,1],[347,13,347,169,1],[349,13,349,64,1],[352,13,352,36,1],[353,13,353,37,1],[354,13,354,39,1],[355,13,355,62,1],[356,17,356,52,1],[358,17,358,51,1],[361,13,361,39,1],[364,9,364,10,1],[368,17,368,18,0],[368,19,368,213,0],[368,214,368,215,0],[374,13,374,14,1],[375,17,375,62,1],[377,17,377,62,1],[377,62,377,86,1],[377,86,377,88,1],[377,17,377,88,1],[378,17,378,40,1],[379,17,379,18,0],[380,21,380,62,0],[381,21,381,48,0],[382,17,382,18,0],[384,17,384,104,1],[386,17,387,292,1],[393,17,393,112,1],[395,17,395,85,1],[396,17,396,18,0],[397,21,397,109,0],[398,17,398,18,0],[399,17,399,112,1],[400,17,400,121,1],[401,17,401,35,1],[402,13,402,14,1],[464,9,464,10,1],[465,13,465,41,1],[466,13,466,97,1],[467,13,467,14,1],[468,17,468,45,1],[469,17,469,43,1],[470,13,470,14,1],[472,13,472,14,1],[473,17,473,95,1],[474,13,474,14,1],[475,13,475,26,1],[476,9,476,10,1],[482,9,482,10,1],[483,13,483,49,1],[484,13,484,206,1],[485,13,485,53,1],[486,13,486,42,1],[487,13,487,47,1],[488,13,488,86,1],[489,13,489,84,1],[491,9,491,10,1],[493,9,493,10,0],[495,13,495,35,0],[496,13,496,14,0],[497,17,497,64,0],[500,17,500,52,0],[501,21,501,67,0],[502,17,502,48,0],[503,21,503,63,0],[504,17,504,41,0],[505,21,505,56,0],[506,17,506,54,0],[507,17,507,55,0],[508,17,508,65,0],[510,17,510,73,0],[511,17,511,57,0],[512,17,512,66,0],[515,17,515,100,0],[516,17,516,103,0],[517,17,517,96,0],[520,17,520,92,0],[521,17,521,93,0],[522,17,522,90,0],[524,17,524,50,0],[525,17,525,54,0],[526,17,526,53,0],[527,17,527,50,0],[528,17,528,46,0],[529,17,529,51,0],[530,17,530,48,0],[531,17,531,55,0],[534,17,534,70,0],[537,17,537,41,0],[538,17,538,18,0],[539,21,539,75,0],[540,21,540,90,0],[541,17,541,18,0],[543,17,543,75,0],[544,17,544,90,0],[548,17,548,86,0],[549,17,549,24,0],[549,26,549,40,0],[549,41,549,43,0],[549,44,549,53,0],[550,17,550,18,0],[551,21,551,71,0],[552,21,552,22,0],[553,25,553,84,0],[554,21,554,22,0],[555,17,555,18,0],[556,13,556,14,0],[557,9,557,10,0],[559,9,559,10,1],[560,13,560,37,1],[561,13,561,14,1],[562,17,562,76,1],[563,17,567,82,1],[568,17,568,39,1],[569,17,569,18,1],[570,21,570,77,1],[571,17,571,18,1],[573,17,576,120,1],[578,17,578,76,1],[579,17,579,86,1],[580,17,580,63,1],[581,13,581,14,1],[582,9,582,10,1],[587,13,587,14,1],[588,17,588,178,1],[589,13,589,14,1],[593,9,593,10,0],[595,9,595,10,0],[598,9,598,10,1],[599,13,599,137,1],[601,17,602,98,0],[603,18,603,68,1],[604,17,604,65,0],[606,17,607,97,1],[608,9,608,10,0],[611,9,611,10,1],[612,13,612,63,1],[613,17,613,65,0],[614,13,615,97,1],[616,9,616,10,0],[619,9,619,10,1],[622,13,622,46,1],[625,13,625,152,1],[628,13,628,47,1],[629,13,629,14,1],[630,17,630,65,1],[632,17,634,86,1],[637,17,637,26,1],[640,13,640,41,1],[642,13,642,22,1],[643,9,643,10,1],[646,9,646,10,1],[647,13,647,58,1],[648,9,648,10,1],[651,9,651,10,1],[652,13,652,20,1],[652,22,652,30,1],[652,31,652,33,1],[652,34,652,65,1],[653,13,653,14,1],[656,17,656,44,1],[658,17,658,73,1],[659,17,659,34,1],[660,21,660,127,0],[663,17,663,148,1],[666,17,666,39,1],[667,17,667,18,0],[668,21,668,60,0],[668,60,668,68,0],[668,68,668,79,0],[668,21,668,79,0],[669,21,669,83,0],[670,17,670,18,0],[671,13,671,14,1],[674,13,674,47,1],[675,17,675,80,1],[677,13,677,24,1],[678,9,678,10,1],[681,9,681,10,1],[682,13,682,66,1],[683,9,683,10,1],[686,9,686,10,0],[688,13,688,14,0],[689,17,689,59,0],[690,21,691,138,0],[692,13,692,14,0],[693,13,693,33,0],[694,13,694,14,0],[695,17,695,26,0],[697,9,697,10,0],[699,9,699,37,1],[703,13,703,14,1],[705,17,705,97,1],[706,17,706,46,1],[707,13,707,14,1],[712,9,712,10,1],[713,13,713,48,1],[714,13,714,35,1],[715,13,715,62,1],[716,13,716,14,1],[717,17,717,64,1],[718,21,718,51,0],[719,17,719,67,1],[720,21,720,54,0],[721,17,721,64,1],[722,21,722,72,0],[723,17,723,67,1],[724,21,724,75,0],[725,17,725,75,1],[726,21,726,83,0],[728,13,728,14,1],[730,13,730,14,1],[731,17,731,64,1],[732,21,732,71,1],[733,17,733,67,1],[734,21,734,74,1],[735,17,735,75,1],[736,21,736,82,0],[737,17,737,67,1],[738,21,738,53,1],[739,17,739,77,1],[740,17,740,18,1],[741,21,741,50,1],[742,21,742,154,1],[743,17,743,18,1],[744,13,744,14,1],[746,13,746,67,1],[747,17,747,156,1],[765,13,765,68,1],[766,13,766,14,0],[767,17,767,114,0],[768,13,768,14,0],[770,13,770,29,1],[770,30,770,61,0],[771,13,771,28,1],[771,29,771,59,0],[772,9,772,10,1],[777,13,777,14,1],[778,17,778,31,1],[779,13,779,14,1],[785,13,785,14,1],[786,17,786,63,1],[787,13,787,14,1],[793,13,793,14,1],[794,17,794,104,1],[795,21,795,69,1],[796,22,796,31,1],[797,13,797,14,1],[803,13,803,14,1],[804,17,804,51,1],[805,13,805,14,1],[810,9,810,10,1],[812,13,812,48,1],[813,13,813,134,1],[817,13,817,89,1],[818,13,818,80,1],[819,17,819,69,0],[822,13,822,63,1],[824,13,824,148,1],[825,13,825,86,1],[826,13,826,76,1],[827,13,827,35,1],[828,9,828,10,1],[831,9,831,10,1],[832,13,832,205,1],[833,9,833,10,1],[836,9,836,10,0],[837,13,837,205,0],[838,9,838,10,0],[840,51,840,52,1],[840,53,840,65,1],[840,66,840,67,1],[842,9,842,69,1],[844,9,844,10,0],[845,13,845,64,0],[846,17,846,147,0],[847,13,847,54,0],[848,9,848,10,0],[852,17,852,18,1],[852,19,852,36,1],[852,37,852,38,1],[857,17,857,18,1],[857,19,857,42,1],[857,43,857,44,1],[862,17,862,18,0],[862,19,862,30,0],[862,31,862,32,0],[867,17,867,18,0],[867,19,867,44,0],[867,45,867,46,0],[871,9,871,10,1],[872,13,872,43,1],[874,13,874,28,1],[876,13,876,51,1],[878,13,878,47,1],[880,13,880,87,1],[881,13,881,90,1],[908,9,908,10,1],[916,9,916,10,1],[917,13,917,146,1],[919,13,919,67,1],[921,13,921,54,1],[922,13,922,89,1],[923,13,923,25,1],[924,9,924,10,1],[926,9,926,10,1],[927,13,927,47,1],[929,13,929,132,1],[930,13,930,250,1],[931,13,931,29,1],[932,17,932,46,1],[934,13,934,108,1],[935,17,935,66,0],[937,13,937,37,1],[938,13,938,37,1],[939,13,939,56,1],[940,13,940,49,1],[942,13,942,39,1],[944,13,944,34,1],[945,13,945,50,1],[946,17,946,41,0],[947,13,947,81,1],[948,13,948,108,1],[949,13,949,132,1],[951,13,955,15,1],[956,9,956,10,1],[964,9,964,10,0],[965,13,965,146,0],[967,13,967,64,0],[969,13,969,54,0],[970,13,970,89,0],[971,13,971,25,0],[972,9,972,10,0],[974,9,974,10,0],[975,13,975,132,0],[976,13,976,116,0],[977,13,977,38,0],[978,13,978,72,0],[979,13,979,72,0],[980,13,980,32,0],[982,13,986,15,0],[987,9,987,10,0],[992,43,992,47,1],[992,48,992,52,1]]);
    </script>
  </body>
</html>