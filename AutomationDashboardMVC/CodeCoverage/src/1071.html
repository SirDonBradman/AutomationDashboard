<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\Controller\API Controllers\Framework Classes\APIModuleHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aurigo.AMP3.Common;
using Aurigo.AMP3.DocumentManagementBL;
using Aurigo.AMP3.LinksBL;
using Aurigo.AMP3.LinksDTO;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.DataResouces;
using Aurigo.Brix.Platform.BusinessLayer.DTO;
using Aurigo.Brix.Platform.BusinessLayer.Utility;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.BusinessLayer.XmlForm_Framework;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Common;
using Aurigo.Workflow;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Json;
using System.Linq;
using System.Web;
using System.Web.Script.Serialization;
using System.Xml.Serialization;

namespace Aurigo.Brix.Platform.BusinessLayer.Controller
{
    public static class APIModuleHelper
    {
        public static void GetModuleDetails(string lastSynchedAt, Dictionary&lt;string, string&gt; moduleSyncDic, EstimateDetails estimateCounts, IProvider _provider,
                  DataTable dtEstimateSummary, DataTable dtEstimateTotalRecordsSummary, object objProjectId, int projectId, int contractId,
                  string module, string annotationDetails)
        {
            BrixFormModel xmlModel = ((BrixCoreDataProvider)_provider).GetXmlFormModel(module);

            Dictionary&lt;string, object&gt; req =
                new Dictionary&lt;string, object&gt;(StringComparer.OrdinalIgnoreCase);
            req.Add(&quot;pid&quot;, projectId);
            req.Add(&quot;parentid&quot;, contractId);
            req.Add(&quot;parentmodule&quot;, xmlModel.form.ParentModuleID);
            req.Add(&quot;iswebapi&quot;, &quot;true&quot;);
            req.Add(&quot;context&quot;, xmlModel.form.Name);

            xmlModel.form.RequestParameters = new Dictionary&lt;string, object&gt;(req,
                StringComparer.OrdinalIgnoreCase);

            var viewName = APIHelper.GetViewName(xmlModel);
            var whereCondition = APIHelper.BuildWhereCondition(xmlModel, viewName, req, null);
            var moduleLastSyncTime =
                moduleSyncDic.ContainsKey(projectId + &quot;_&quot; + module.ToLower())
                    ? (moduleSyncDic[projectId + &quot;_&quot; + module.ToLower()] == &quot;&quot;) ? lastSynchedAt : moduleSyncDic[projectId + &quot;_&quot; + module.ToLower()]
                    : null;

            //TODO:ASHEESH: Fix the performance for estimate since it is calling for every form
            JObject objInstanceDetails =
                 JObject.Parse(
                     GetListPageData(xmlModel.form.Name, xmlModel.form.ModuleID,
                         xmlModel.form.AssociatedModuleID,
                         xmlModel.form.Header, xmlModel.form.PrimaryKeyName, projectId.ToString(),
                         viewName, whereCondition, req, moduleLastSyncTime, true, xmlModel, isCalledForMobile: true, annotationDetails: annotationDetails)
                         .ToString());
            JObject objAllInstanceDetails = (moduleLastSyncTime != null)
                ? null
                : objInstanceDetails;

            JArray instances = JArray.Parse(objInstanceDetails[&quot;InstanceDetails&quot;].ToString());
            if (instances.Count == 1)
            {
                JToken rowDetails = instances[0];
                JArray rows = JArray.Parse(rowDetails.ToString());
                if (rows.Count &gt; 0)
                {
                    int noOfRecords = ((rows[0][&quot;AUR_NoOfRecords&quot;] != null &amp;&amp;
                                        objProjectId != DBNull.Value)
                        ? rows[0][&quot;AUR_NoOfRecords&quot;].ToString().ToInt32_2()
                        : 0);
                    int noOfAttachments = ((rows[0][&quot;AUR_NumberOfAttachments&quot;] != null &amp;&amp;
                                            objProjectId != DBNull.Value)
                        ? rows[0][&quot;AUR_NumberOfAttachments&quot;].ToString().ToInt32_2()
                        : 0);
                    decimal attachmentSize = ((rows[0][&quot;AUR_DocumentTotalSize&quot;] != null &amp;&amp;
                                               objProjectId != DBNull.Value)
                        ? rows[0][&quot;AUR_DocumentTotalSize&quot;].ToString().ToDecimal2()
                        : 0);
                    decimal recordSize = ((rows[0][&quot;AUR_RecordTotalSize&quot;] != null &amp;&amp;
                                           objProjectId != DBNull.Value)
                        ? rows[0][&quot;AUR_RecordTotalSize&quot;].ToString().ToDecimal2()
                        : 0);

                    decimal annotationSize = ((rows[0][&quot;AUR_DocumentAnnotationTotalSize&quot;] != null &amp;&amp;
                                           objProjectId != DBNull.Value)
                        ? decimal.Round(rows[0][&quot;AUR_DocumentAnnotationTotalSize&quot;].ToString().ToDecimal2(), 2, MidpointRounding.AwayFromZero)
                        : 0);
                    int annotationCount = ((rows[0][&quot;AUR_NumberOfAttachmentsAnnotation&quot;] != null &amp;&amp;
                                              objProjectId != DBNull.Value)
                           ? rows[0][&quot;AUR_NumberOfAttachmentsAnnotation&quot;].ToString().ToInt32_2()
                           : 0);



                    estimateCounts.TotalRecordCount += noOfRecords;
                    estimateCounts.TotalAttachmentCount += noOfAttachments;
                    estimateCounts.TotalRecordSize += recordSize;
                    estimateCounts.TotalAttachmentSize += attachmentSize;
                    estimateCounts.TotalAnnotationCount += annotationCount;
                    estimateCounts.TotalAnnotationSize += annotationSize;
                    //Insert into the summary table

                    #region Insert into the summary table

                    if (noOfRecords &gt; 0)
                    {
                        objAllInstanceDetails = objInstanceDetails;
                        DataRow rowSummary = dtEstimateSummary.NewRow();
                        rowSummary[&quot;PID&quot;] = projectId;
                        rowSummary[&quot;ParentID&quot;] = contractId;
                        rowSummary[&quot;ModuleID&quot;] = module;
                        rowSummary[&quot;RecordCount&quot;] = noOfRecords;
                        rowSummary[&quot;AttachmentsCount&quot;] = noOfAttachments;
                        rowSummary[&quot;RecordSize&quot;] = recordSize;
                        rowSummary[&quot;AttachmentsSize&quot;] = attachmentSize;

                        rowSummary[&quot;AnnotationsSize&quot;] = estimateCounts.TotalAnnotationSize;
                        rowSummary[&quot;AnnotationsCount&quot;] = estimateCounts.TotalAnnotationCount;

                        dtEstimateSummary.Rows.Add(rowSummary);
                    }
                    else
                    {
                        //TODO:ASHEESH: Fix the performance for estimate since it is calling for every form
                        objAllInstanceDetails =
                             JObject.Parse(
                                 GetListPageData(xmlModel.form.Name, xmlModel.form.ModuleID,
                                     xmlModel.form.AssociatedModuleID,
                                     xmlModel.form.Header, xmlModel.form.PrimaryKeyName,
                                     projectId.ToString(), viewName, whereCondition, req, null,
                                     true, xmlModel, isCalledForMobile: true).ToString());
                    }

                    #endregion
                }
            }
            if (objAllInstanceDetails != null)
            {
                JArray allInstances =
                    JArray.Parse(objAllInstanceDetails[&quot;InstanceDetails&quot;].ToString());
                if (allInstances.Count == 1)
                {
                    JToken rowDetails = allInstances[0];
                    JArray rows = JArray.Parse(rowDetails.ToString());
                    if (rows.Count &gt; 0)
                    {
                        int noOfRecords = ((rows[0][&quot;AUR_NoOfRecords&quot;] != null &amp;&amp;
                                            objProjectId != DBNull.Value)
                            ? rows[0][&quot;AUR_NoOfRecords&quot;].ToString().ToInt32_2()
                            : 0);
                        DataRow rowTotalSummary = dtEstimateTotalRecordsSummary.NewRow();
                        rowTotalSummary[&quot;PID&quot;] = projectId;
                        rowTotalSummary[&quot;ParentID&quot;] = contractId;
                        rowTotalSummary[&quot;ModuleID&quot;] = module;
                        rowTotalSummary[&quot;Total&quot;] = noOfRecords;
                        dtEstimateTotalRecordsSummary.Rows.Add(rowTotalSummary);
                    }
                }
            }
        }

        public static JsonObject GetListPageData(string context, string moduleId, string associatedModuleID, string header,
                string primarykeyName, string pid, string viewName, string whereCondition, Dictionary&lt;string, object&gt; req,
                string lastSyncedAt, bool getCountOnly, BrixFormModel xmlModel, bool isCalledForMobile, int pageSize = int.MaxValue, string annotationDetails = &quot;&quot;, bool excludeFinalStage = true)
        {
            bool out_hasMorePages = false;
            string lastRecordSyncDateTimeAndPKeyValueConsolidate = string.Empty;

            if (isCalledForMobile &amp;&amp; string.IsNullOrEmpty(lastSyncedAt))
                lastSyncedAt = &quot;EMPTY&quot;;//this will tell the stored proc that the SP is getting called from mobile device

            UserDetail ud = CurrentUser.CurrentUserDetail;
            var features = new List&lt;string&gt;();
            features.Add(Constants.MODFEAT_VISIBILITY);

            JsonObject allInstanceDetails = new JsonObject();
            JsonArray allInstances = new JsonArray();
            JsonArray instances = new JsonArray();

            if (ModuleManager.Instance.checkPermissions(associatedModuleID, moduleId, ud, pid, features))
            {
                string inputValueForStoredProc_lastSyncedAt = string.Empty;
                string annotationForModuleLastSyncedAt = string.Empty;
                int inputValueForStoredProc_lastSyncedRecordPrimaryKeyValue = 0;
                int annotationForModule_lastRecordId = 0;

                GenericXMLListPageController.Extract_LastSyncDateTime_And_LastPKey(lastSyncedAt, out inputValueForStoredProc_lastSyncedAt, out inputValueForStoredProc_lastSyncedRecordPrimaryKeyValue);
                if (req.ContainsKey(&quot;annotationformodulelastsyncedat&quot;))
                    GenericXMLListPageController.Extract_LastSyncDateTime_And_LastPKey(req[&quot;annotationformodulelastsyncedat&quot;].ToString(), out annotationForModuleLastSyncedAt, out annotationForModule_lastRecordId);
                else
                {
                    annotationForModuleLastSyncedAt = inputValueForStoredProc_lastSyncedAt;
                }

                string downloadedAnnotations = string.Empty;
                if (annotationDetails != &quot;&quot;)
                {
                    List&lt;SyncEstimateDownloadedAttachmentAnnotationDetails&gt; downloadedAnnotationsDetials =
                            JsonConvert.DeserializeObject&lt;List&lt;SyncEstimateDownloadedAttachmentAnnotationDetails&gt;&gt;(annotationDetails);

                    var xmlSerializer = new XmlSerializer(typeof(List&lt;SyncEstimateDownloadedAttachmentAnnotationDetails&gt;), new XmlRootAttribute(&quot;XMLRoot&quot;));
                    using (var stream = new StringWriter())
                    {
                        xmlSerializer.Serialize(stream, downloadedAnnotationsDetials);
                        downloadedAnnotations = stream.ToString();
                    }
                }

                //TO GET data after lastSyncedAt sent from client
                var ds = XmlFormComponent.Instance.GetListPageRecords(primarykeyName, viewName,
                    whereCondition, 1, pageSize, context, pid.ToInt32_2(), ud.UID, ud.RID, inputValueForStoredProc_lastSyncedAt, inputValueForStoredProc_lastSyncedRecordPrimaryKeyValue,
                    out out_hasMorePages, getCountOnly, downloadedAnnotations, excludeFinalStage: excludeFinalStage);

                if (getCountOnly)
                {
                    if (ds != null &amp;&amp; ds.Tables.Count &gt; 0 &amp;&amp; ds.Tables[0].Rows.Count &gt; 0)
                    {
                        allInstances.Add(JsonConvert.SerializeObject(ds.Tables[0]));
                    }
                }
                else
                {
                    if (ds != null &amp;&amp; ds.Tables.Count &gt; 0)
                    {
                        lastRecordSyncDateTimeAndPKeyValueConsolidate = GenericXMLListPageController.GetLastRecordSyncDateTime(ds.Tables[0], primarykeyName); //this has to be done to extract the UTC date format for mobile sync

                        req.Add(&quot;moduleid&quot;, moduleId);
                        req.Add(&quot;instanceid&quot;, &quot;&quot;);
                        var dt = ds.Tables[0];
                        if (dt != null)
                        {
                            foreach (DataRow row in dt.Rows)
                            {
                                req[&quot;instanceid&quot;] = row[primarykeyName].ToString();
                                req[&quot;modulelastsyncedat&quot;] = annotationForModuleLastSyncedAt.ToString(); // we will use this timestamp to filter the list of annotations which are updated or created 
                                string instanceParams = JsonConvert.SerializeObject(req);
                                JsonObject instanceDetails = GetDetails(moduleId, row[primarykeyName].ToString(),
                                    instanceParams, xmlModel);
                                allInstances.Add(instanceDetails);
                            }
                        }
                    }

                    #region MObile Specific Code
                    if (!out_hasMorePages)
                    {
                        //This gets all the data to identify deleted items
                        var dsAllList = XmlFormComponent.Instance.GetListPageRecords(primarykeyName, viewName,
                            whereCondition, 1, int.MaxValue, context, pid.ToInt32_2(), ud.UID, ud.RID, &quot;EMPTY&quot;, 0, out out_hasMorePages, excludeFinalStage: excludeFinalStage);//first time primary key will be zero and lastmodified date is empty

                        if (dsAllList != null &amp;&amp; dsAllList.Tables.Count &gt; 0)
                        {
                            foreach (DataRow row in dsAllList.Tables[0].Rows)
                            {
                                instances.Add(row[primarykeyName].ToString());
                            }
                        }
                    }

                    #endregion MObile Specific Code
                }
            }
            allInstanceDetails[&quot;InstanceDetails&quot;] = allInstances;
            allInstanceDetails[&quot;InstanceIds&quot;] = instances;
            allInstanceDetails[&quot;FormName&quot;] = xmlModel.form.ParseDynamicString(header);

            allInstanceDetails[&quot;HasMorePage&quot;] = out_hasMorePages;
            allInstanceDetails[&quot;LastRecordSyncDateTime&quot;] = lastRecordSyncDateTimeAndPKeyValueConsolidate;

            return allInstanceDetails;
        }

        public static JsonObject GetDetails(string moduleId, string Id, string jsonParameters, BrixFormModel model)
        {
            JavaScriptSerializer js = new JavaScriptSerializer();
            Dictionary&lt;string, object&gt; jsonParams = string.IsNullOrEmpty(jsonParameters)
                ? new Dictionary&lt;string, object&gt;(StringComparer.OrdinalIgnoreCase)
                : js.Deserialize&lt;Dictionary&lt;string, object&gt;&gt;(jsonParameters);
            model.form.RequestParameters = new Dictionary&lt;string, object&gt;(jsonParams, StringComparer.OrdinalIgnoreCase);
            model.form.instanceID = Id;
            XMLRenderingEngine engine = new XMLRenderingEngine(null, model, null);
            engine.Render(RenderFormat.RenderJSON);
            var XmlFormArgs = new XmlFormArgs();
            if (!string.IsNullOrEmpty(model.form.ManagerDLL) &amp;&amp; !string.IsNullOrEmpty(model.form.FormManagerClass))
            {
                try
                {
                    XMLFormManagerModel managerModel =
                        AMP3InterfaceFactory.GetInstance&lt;XMLFormManagerModel&gt;(model.form.ManagerDLL,
                            model.form.FormManagerClass);
                    if (managerModel != null)
                    {
                        managerModel.OnPreInit(model, XmlFormArgs);
                        managerModel.OnInit(model, XmlFormArgs);
                        managerModel.OnPageLoad(model, XmlFormArgs);
                    }
                }
                catch
                {
                }
            }

            JsonObject j = (model.form.Renderer as JSONRenderer).MasterDoc;

            if (model.form.AllowAttachments)
            {
                List&lt;LinkDetails&gt; links = LinksManager.Instance.GetLinksForModuleInstance(Id, moduleId, &quot;&quot;);
                if (links != null)
                    links = links.Where(l =&gt; l.DestType.Equals(&quot;DOCMGMT&quot;)).ToList&lt;LinkDetails&gt;();
                JsonArray docs = new JsonArray();
                JsonObject doc;
                string moduleLastSyncedAt = model.form.RequestParameters.ContainsKey(&quot;modulelastsyncedat&quot;) ? model.form.RequestParameters[&quot;modulelastsyncedat&quot;].ToString2() : &quot;EMPTY&quot;;
                if (links != null)
                {
                    foreach (LinkDetails l in links)
                    {
                        int versionNo;
                        doc = new JsonObject();
                        doc.Add(&quot;DocId&quot;, l.DestID);
                        doc.Add(&quot;DocName&quot;, l.LinkName);
                        doc.Add(&quot;Desc&quot;, l.Description);
                        doc.Add(&quot;New&quot;, false);
                        doc.Add(&quot;Deleted&quot;, false);
                        doc.Add(&quot;FilePath&quot;, &quot;&quot;);
                        doc.Add(&quot;LinkId&quot;, l.LinkID);
                        doc.Add(&quot;CreatedDate&quot;, l.CreatedDate);
                        doc.Add(&quot;Version&quot;, l.VersionNumber);
                        versionNo = string.IsNullOrEmpty(l.VersionNumber) ? 0 : Convert.ToInt32(l.VersionNumber);

                        //Annotations information for sync
                        AnnotationIds annotations = DocumentManager.Instance.GetDocumentAnnoationIdsForSync(l.DestID.ToInt32_2(), l.LinkID, versionNo, moduleLastSyncedAt);

                        doc[&quot;AllAnnotationIds&quot;] = JsonConvert.SerializeObject(annotations.AllAnnotationIds); // This list will be used to delete all the local copies of the annotation if the annotation is deleted in server
                        doc[&quot;NewOrModifiedAnnotationIds&quot;] = JsonConvert.SerializeObject(annotations.NewOrModifiedAnnotationIds); // this will have list of annotation ids which needs to be downloaded in the sync
                        doc[&quot;AnnotationInstanceIdsWithServerModifiedOn&quot;] = JsonConvert.SerializeObject(annotations.AnnotationInstanceIdsWithServerModifiedOn);
                        docs.Add(doc);

                    }
                    j.Add(&quot;Attachments&quot;, docs);
                }
            }

            bool workflowAllowsEdit = true;
            bool workflowAllowsDelete = true;
            UserDetail ud = CurrentUser.CurrentUserDetail;
            string sGuid = BrixWorkflowManager.Instance.IsWorkflowAssociated(moduleId, Id);
            if (!string.IsNullOrEmpty(sGuid)) //there is a workflow associated with this record
            {
                Guid newGuid = Guid.Empty;
                DataTable dt = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(Id, moduleId);

                if (dt.Rows[0][&quot;CanDeleteInState&quot;].ToString().ToLower() == &quot;allowdelete&quot;)
                    workflowAllowsDelete = true;
                else
                    workflowAllowsDelete = false;

                if (Boolean.Parse(dt.Rows[0][&quot;IsCompleted&quot;].ToString())) // the workflow is in its end stage
                {
                    workflowAllowsEdit = false;
                }
                else
                {
                    IState state = BrixWorkflowManager.Instance.GetCurrentState(new Guid(sGuid), ref newGuid);

                    string[] stakeHolders = null == state.ActionsMustBePerformedBy
                        ? null
                        : state.ActionsMustBePerformedBy.Split(&#39;,&#39;);

                    bool bHasRoleToPlay = false;

                    UserDetail sCurrentUser = CurrentUser.CurrentUserDetail;
                    Dictionary&lt;int, string&gt; userRoles = new Dictionary&lt;int, string&gt;();
                    int pid = model.form.RequestParameters.ContainsKey(&quot;pid&quot;)
                        ? model.form.RequestParameters[&quot;pid&quot;].ToInt32_2()
                        : 0;
                    userRoles = UserManager.Instance.GetUserRolesBasedOnProjectId(sCurrentUser.UID, pid,
                        sCurrentUser.RID, sCurrentUser.RoleName);

                    foreach (string stakeHolderRole in stakeHolders)
                    {
                        int roleId = UserManager.Instance.GetUsersRoleId(stakeHolderRole);

                        bHasRoleToPlay = userRoles.ContainsKey(roleId);
                        //if current user role matches the stakeholders roles, then proceed further
                    }

                    if (!bHasRoleToPlay)
                    {
                        workflowAllowsEdit = false;
                    }
                    model.form.engine.currentState = state;
                    string stageJson = (model.form.engine.currentState as Aurigo.Workflow.StateInfo).SectionDisplayInfo;
                    if (!string.IsNullOrEmpty(stageJson))
                    {
                        JsonValue stageInfo = JsonObject.Parse(stageJson);
                        JsonArray stageSections = new JsonArray();

                        foreach (var stage in stageInfo[&quot;Secs&quot;].ToArray())
                        {
                            JsonObject JsonObjectArray = new JsonObject();
                            string SectionName = stage.Value[&quot;SectionName&quot;].ValueOrDefault().ReadAs&lt;string&gt;();
                            string Visibility = stage.Value[&quot;Visibility&quot;].ValueOrDefault().ReadAs&lt;string&gt;();
                            JsonObjectArray.Add(&quot;SectionName&quot;, SectionName);
                            JsonObjectArray.Add(&quot;Visibility&quot;, Visibility);
                            stageSections.Add(JsonObjectArray);
                        }

                        if (!j.ContainsKey(&quot;Stage&quot;))
                            j.Add(&quot;Stage&quot;, stageSections);
                        else
                            j[&quot;Stage&quot;] = stageSections;
                    }
                }


                for (var c = 0; c &lt; dt.Columns.Count; c++)
                {
                    string value = dt.Rows[0][dt.Columns[c].ColumnName].ToString();
                    string valueToAdd = &quot;&quot;;
                    if (model.form.GetControl(dt.Columns[c].ColumnName) != null &amp;&amp; model.form.GetControl(dt.Columns[c].ColumnName).IsTimezoneApplicable)
                    {
                        if (!string.IsNullOrEmpty(value))
                        {
                            DateTime dateTime;
                            if (DateTime.TryParse(value, out dateTime))
                            {
                                valueToAdd = dateTime.ToMWDateTimeString_FormatDateTime();
                            }
                        }
                    }
                    else
                    {
                        valueToAdd = value;
                    }
                    if (!j.ContainsKey(dt.Columns[c].ColumnName))
                        j.Add(dt.Columns[c].ColumnName, valueToAdd);
                    else
                        j[dt.Columns[c].ColumnName] = valueToAdd;
                }
            }

            bool bIsWorkflowAssociatedatFormLevel = model.form.RequestParameters.ContainsKey(&quot;PID&quot;)
                ? IsWorkflowAssociated(model)
                : false;
            bool AllowEdit = false;
            if (bIsWorkflowAssociatedatFormLevel)
            {
                var dicHasRoleToPlay = new Dictionary&lt;string, bool?&gt;();
                DataTable dt =
                    BrixWorkflowManager.Instance.GetWorkflowMappingDetails(
                        model.form.RequestParameters[&quot;instanceID&quot;].ToString(), model.form.ModuleID);
                List&lt;string&gt; stakeHolders = new List&lt;string&gt;();
                if (dt.Rows.Count &gt; 0)
                    for (int i = 0; i &lt; dt.Rows.Count; i++)
                    {
                        bool bIsComplete = DBNull.Value == dt.Rows[i][&quot;IsCompleted&quot;]
                            ? false
                            : dt.Rows[i][&quot;IsCompleted&quot;].ToString() == &quot;True&quot;;
                        if (bIsComplete) continue;
                        string[] roles = DBNull.Value == dt.Rows[i][&quot;CurrentRole&quot;]
                            ? null
                            : dt.Rows[i][&quot;CurrentRole&quot;].ToString().Split(&#39;,&#39;);
                        if (null == roles) continue;
                        stakeHolders.AddRange(roles);
                    }

                bool bHasRoleToPlay = false;
                UserDetail sCurrentUser = CurrentUser.CurrentUserDetail;
                Dictionary&lt;int, string&gt; userRoles = new Dictionary&lt;int, string&gt;();

                userRoles = UserManager.Instance.GetUserRolesBasedOnProjectId(sCurrentUser.UID,
                    model.form.RequestParameters.ContainsKey(&quot;PID&quot;)
                        ? model.form.RequestParameters[&quot;PID&quot;].ToInt32_2()
                        : 0,
                    sCurrentUser.RID, sCurrentUser.RoleName);

                foreach (string stakeHolderRole in stakeHolders)
                {
                    int roleId = UserManager.Instance.GetUsersRoleId(stakeHolderRole);
                    if (userRoles.ContainsKey(roleId))
                    {
                        bHasRoleToPlay = true;

                        //if current user role matches the stakeholders roles, then proceed further
                        string workflowInstanceGuid = dt.Rows[0][&quot;WorkflowInstanceGuid&quot;].ToString();

                        AllowEdit = bHasRoleToPlay =
                            !WFRuntimeHandlerDB.HasCurrentUserPerformedWorkflowAction(workflowInstanceGuid, userRoles,
                                sCurrentUser.UID);
                        break;
                    }
                }
            }
            else
            {
                AllowEdit = true;
            }


            try
            {
                if (!string.IsNullOrEmpty(sGuid))
                {
                    //Adding Workflow Actions
                    List&lt;Guid&gt; lstWfInstances = null;
                    DataRow[] drs = null;
                    Dictionary&lt;string, bool?&gt; dicRolesToPlay = null;
                    bool canSave;
                    List&lt;WorkflowActions&gt; actions = GetWorkflowButtons(model.form.RequestParameters[&quot;context&quot;].ToString(),
                         Id.ToString(),
                        model.form.RequestParameters[&quot;pid&quot;].ToString(), model.form.RequestParameters[&quot;parentid&quot;].ToString(),
                        out lstWfInstances, out drs, out dicRolesToPlay, out canSave);
                    bool bHasRoleToPlay = false;
                    foreach (string key in dicRolesToPlay.Keys)
                        if (dicRolesToPlay[key] == true)
                        {
                            bHasRoleToPlay = true;
                            break;
                        }
                    List&lt;WorkflowActions&gt; result = bHasRoleToPlay ? actions : new List&lt;WorkflowActions&gt;();

                    DataSet wfhDS = BrixWorkflowManager.Instance.GetWorkflowHistory(sGuid);

                    DataSet newData = new DataSet();
                    if (wfhDS != null &amp;&amp; wfhDS.Tables[0].Rows.Count != 0)
                    {
                        DataTable dtNew = wfhDS.Tables[0];
                        DataTable Dtnew = dtNew.Clone();
                        if (!Dtnew.Columns.Contains(&quot;Action User&quot;)) Dtnew.Columns.Add(&quot;Action User&quot;);
                        if (!Dtnew.Columns.Contains(&quot;Action Date&quot;)) Dtnew.Columns.Add(&quot;Action Date&quot;);
                        if (!Dtnew.Columns.Contains(&quot;Notes&quot;)) Dtnew.Columns.Add(&quot;Notes&quot;);
                        if (!Dtnew.Columns.Contains(&quot;Due Date Override&quot;)) Dtnew.Columns.Add(&quot;Due Date Override&quot;);
                        int stageRowIndex = 0;
                        for (int i = 0; i &lt; dtNew.Rows.Count; i++)
                        {
                            string staginit = dtNew.Rows[i][&quot;Action&quot;].ToString2();
                            if (staginit == &quot;StageInitialized&quot;)
                            {
                                stageRowIndex = i;
                            }
                            if (staginit != &quot;StageInitialized&quot; ||
                                (staginit == &quot;StageInitialized&quot; &amp;&amp; (i == dtNew.Rows.Count - 1)))
                            {
                                DataRow drnew = Dtnew.NewRow();
                                drnew[&quot;ID&quot;] = dtNew.Rows[i][&quot;ID&quot;];
                                drnew[&quot;Status&quot;] = dtNew.Rows[i][&quot;Status&quot;];
                                drnew[&quot;Pending On&quot;] = dtNew.Rows[i][&quot;Pending On&quot;];
                                drnew[&quot;Date&quot;] = dtNew.Rows[stageRowIndex][&quot;Date&quot;].ToMWDateTime();
                                drnew[&quot;User&quot;] = dtNew.Rows[stageRowIndex][&quot;User&quot;];
                                if (staginit != &quot;StageInitialized&quot;)
                                {
                                    drnew[&quot;Action&quot;] = dtNew.Rows[i][&quot;Action&quot;];
                                    drnew[&quot;Action User&quot;] = dtNew.Rows[i][&quot;Action User&quot;];
                                    //Action date must not be set if it is the last stage (ie must not be the only state also) Action also must exists
                                    if (!(dtNew.Rows.Count &gt; 1 &amp;&amp; i == dtNew.Rows.Count - 1 &amp;&amp; string.IsNullOrWhiteSpace(drnew[&quot;Action&quot;].ToString())))
                                        drnew[&quot;Action Date&quot;] = dtNew.Rows[i][&quot;Date&quot;].ToMWDateTime();

                                    drnew[&quot;Notes&quot;] = dtNew.Rows[i][&quot;Action Notes&quot;];
                                    drnew[&quot;Due Date Override&quot;] = dtNew.Rows[i][&quot;Due Date Override&quot;];
                                }
                                Dtnew.Rows.Add(drnew);
                            }
                        }
                        newData.Tables.Add(Dtnew);
                    }
                    var wfHistoryDetails = &quot;&quot;;
                    if (newData.Tables.Count != 0)
                    {
                        DataSet newDs = (newData);

                        DataTable wfhDT = newDs.Tables[0];

                        //Remove spaces from column name
                        DataTable rsDT = new DataTable();
                        rsDT.TableName = &quot;RemoveSpaceDT&quot;;

                        foreach (DataColumn wfhdc in wfhDT.Columns)
                        {
                            wfhdc.ColumnName = wfhdc.ColumnName.Replace(&quot; &quot;, String.Empty);
                            rsDT.Columns.Add(wfhdc.ColumnName);
                        }

                        foreach (DataRow wfhdr in wfhDT.Rows)
                        {
                            rsDT.Rows.Add(wfhdr.ItemArray);
                        }

                        wfHistoryDetails = JsonConvert.SerializeObject(rsDT);
                    }

                    if (!j.ContainsKey(&quot;wfHistoryDetails&quot;))
                        j.Add(&quot;wfHistoryDetails&quot;, wfHistoryDetails);
                    else
                        j[&quot;wfHistoryDetails&quot;] = wfHistoryDetails;


                    if (!j.ContainsKey(&quot;wfActions&quot;))
                        j.Add(&quot;wfActions&quot;, JsonConvert.SerializeObject(result));
                    else
                        j[&quot;wfActions&quot;] = JsonConvert.SerializeObject(result);


                    if (!j.ContainsKey(&quot;isWorkflowAssociated&quot;))
                        j.Add(&quot;isWorkflowAssociated&quot;, &quot;True&quot;);
                    else
                        j[&quot;isWorkflowAssociated&quot;] = &quot;True&quot;;

                    string WF_PendingOnUser = &quot;&quot;;


                    Guid newGuid = Guid.Empty;

                    //Adding Workflow Mapping Details
                    var dt =
                         BrixWorkflowManager.Instance.GetWorkflowMappingDetails(
                             Id.ToString(),
                             moduleId.ToString());
                    var dsViewRoles = WFRuntimeHandlerDB.GetUserStakeHolderMappingDetails(Id.ToString(),
                            moduleId.ToString());



                    for (var wfDr = 0; wfDr &lt; dt.Rows.Count; wfDr++)
                    {


                        WF_PendingOnUser = (bool)dt.Rows[wfDr][&quot;IsCompleted&quot;] ? &quot;None&quot;
              : GetWorkflowUsers(dsViewRoles, jsonParams[&quot;pid&quot;].ToInt32_2(), dt.Rows[wfDr][&quot;FormInstanceID&quot;].ToInt32_2(),
                  dt.Rows[wfDr][&quot;CurrentRole&quot;].ToString());

                    }

                    if (!j.ContainsKey(&quot;WF_PendingOnUser&quot;))
                        j.Add(&quot;WF_PendingOnUser&quot;, WF_PendingOnUser);
                    else
                        j[&quot;WF_PendingOnUser&quot;] = WF_PendingOnUser;


                }

            }
            catch (Exception ex)
            {

            }

            if (!j.ContainsKey(&quot;DisplayEdit&quot;))
                j.Add(&quot;DisplayEdit&quot;, workflowAllowsEdit);
            else
                j[&quot;DisplayEdit&quot;] = workflowAllowsEdit;

            if (!j.ContainsKey(&quot;DisplayDelete&quot;))
                j.Add(&quot;DisplayDelete&quot;, workflowAllowsDelete);
            else
                j[&quot;DisplayDelete&quot;] = workflowAllowsDelete;

            if (!AllowEdit)
            {
                if (!j.ContainsKey(&quot;DisplayEdit&quot;))
                    j.Add(&quot;DisplayEdit&quot;, &quot;false&quot;);
                else
                    j[&quot;DisplayEdit&quot;] = &quot;false&quot;;

                if (!j.ContainsKey(&quot;DisplayDelete&quot;))
                    j.Add(&quot;DisplayDelete&quot;, &quot;false&quot;);
                else
                    j[&quot;DisplayDelete&quot;] = &quot;false&quot;;
            }

            return j;
        }

        private static bool IsWorkflowAssociated(BrixFormModel model)
        {
            return BrixWorkflowManager.Instance.IsWorkflowAssociated(model.form.ModuleID,
                model.form.RequestParameters[&quot;PID&quot;].ToString(), model.form.RequestParameters[&quot;ParentId&quot;].ToString());
        }

        private static List&lt;WorkflowActions&gt; GetWorkflowButtons(string moduleid, string formInstanceId, string pid,
                string parentId, out List&lt;Guid&gt; lstWfInstances, out DataRow[] drs,
                out Dictionary&lt;string, bool?&gt; dicHasRoleToPlay, out bool canAddSaveButton)
        {
            dicHasRoleToPlay = new Dictionary&lt;string, bool?&gt;();
            drs = null;
            canAddSaveButton = false;
            lstWfInstances = new List&lt;Guid&gt;();
            List&lt;WorkflowActions&gt; dicActions = new List&lt;WorkflowActions&gt;();
            if (!BrixWorkflowManager.Instance.IsWorkflowAssociated(moduleid, pid, parentId)) return dicActions;
            DataTable mappingDetails = BrixWorkflowManager.Instance.GetWorkflowMappingDetails(formInstanceId, moduleid);
            drs = mappingDetails.Select(&quot;IsCompleted=False&quot;);
            if (null == drs || drs.Count() &lt; 1) return new List&lt;WorkflowActions&gt;();

            foreach (DataRow dr in drs)
            {
                string sCurrentUser = CurrentUser.CurrentUserDetail.UserID;
                Guid actualGuid = Guid.Empty;
                int daysToComplete = 0;
                string actionsMustBePerformedBy = null;
                string stateName = string.Empty;
                Guid gd = new Guid((string)dr[&quot;WorkflowInstanceGuid&quot;]);
                List&lt;IAction&gt; actions = BrixWorkflowManager.Instance.GetCurrentWorkflowActionButtons(gd, ref actualGuid,
                ref daysToComplete, ref actionsMustBePerformedBy, ref stateName);
                if (actualGuid == Guid.Empty) actualGuid = gd;
                if (null == actions) continue;

                //give opinion and route to are not required for mobile
                //bool bGiveOpinion = BrixWorkflowManager.Instance.IsRouted(out sRoutedTo, &quot;&quot;, &quot;&quot;, actualGuid.ToString()) &amp;&amp;
                //                    sRoutedTo.Equals(sCurrentUser, StringComparison.CurrentCultureIgnoreCase);
                //if (bGiveOpinion)
                //    dicActions.Add(new WorkflowActions { Guid = actualGuid.ToString(), ActionId = &quot;GiveOpinion&quot;, ActionName = &quot;GiveOpinion&quot; });

                bool bHasLocalRoleToPlay = false;
                string[] stakeHolders = null == actionsMustBePerformedBy
                    ? null
                    : actionsMustBePerformedBy.Split(&#39;,&#39;);
                Dictionary&lt;int, string&gt; userRoles = new Dictionary&lt;int, string&gt;();

                int iPid = string.IsNullOrEmpty(pid) ? 0 : pid.ToInt32_2();
                UserDetail objCurrentUser = CurrentUser.CurrentUserDetail;

                userRoles = UserManager.Instance.GetUserRolesBasedOnProjectId(objCurrentUser.UID, iPid,
                    objCurrentUser.RID, objCurrentUser.RoleName);

                if (null != stakeHolders)
                    foreach (string stakeHolderRole in stakeHolders)
                    {
                        if (string.IsNullOrEmpty(stakeHolderRole)) continue;
                        if (dicHasRoleToPlay.ContainsKey(stakeHolderRole.ToLower()))
                        {
                            if (dicHasRoleToPlay[stakeHolderRole.ToLower()] == true)
                            {
                                canAddSaveButton = bHasLocalRoleToPlay = true;
                            }
                            continue;
                        }
                        int stakeHolderRoleID = UserManager.Instance.GetUsersRoleId(stakeHolderRole);
                        bool bHasRoleToPlay = userRoles.ContainsKey(stakeHolderRoleID);
                        dicHasRoleToPlay.Add(stakeHolderRole.ToLower(), bHasRoleToPlay);
                        if (bHasRoleToPlay)
                        {
                            canAddSaveButton = bHasLocalRoleToPlay = true;
                        }
                    }
                if (!bHasLocalRoleToPlay) continue;

                //if (!bGiveOpinion)
                //dicActions.Add(new WorkflowActions { Guid = actualGuid.ToString(), ActionId = &quot;RouteTo&quot;, ActionName = &quot;RouteTo&quot; });

                foreach (IAction action in actions)
                {
                    dicActions.Add(new WorkflowActions
                    {
                        Guid = actualGuid.ToString(),
                        ActionId = action.InstanceId,
                        ActionName =
                            string.IsNullOrEmpty(action.ActionDisplayName)
                                ? action.ActionName
                                : action.ActionDisplayName
                    });
                }
                lstWfInstances.Add(actualGuid);
            }
            return dicActions;
        }

        private static string GetWorkflowUsers(DataSet stakeHolders, int pid, int formID, string wfRoles)
        {
            Dictionary&lt;string, List&lt;string&gt;&gt; wfUsers = new Dictionary&lt;string, List&lt;string&gt;&gt;();
            //StakeHolders Table 0 - All workflow users, Table 1 - All workflow users who has perform action
            DataRow[] wfStakeHolders = stakeHolders.Tables[0].Select(&quot;FormInstanceID = &#39;&quot; + formID + &quot;&#39;&quot;);
            if (wfStakeHolders.Length &gt; 0)
            {
                foreach (DataRow drUsers in wfStakeHolders)
                {
                    string roleName = drUsers[&quot;RoleName&quot;].ToString().ToLower();
                    if (!wfUsers.Keys.Contains(roleName)) wfUsers.Add(roleName, new List&lt;string&gt;());

                    DataRow[] userActionPerformed = stakeHolders.Tables[1].Select(&quot;FormInstanceID = &#39;&quot; + formID
                                                                                  + &quot;&#39; AND RoleId = &quot; +
                                                                                  drUsers[&quot;RoleId&quot;] + &quot; AND UserId = &quot; +
                                                                                  drUsers[&quot;UserId&quot;]);
                    if (userActionPerformed.Length == 0)
                    {
                        wfUsers[roleName].Add(drUsers[&quot;FirstName&quot;].ToString() + &quot; &quot; + drUsers[&quot;LastName&quot;].ToString());
                    }
                }
            }

            List&lt;string&gt; roles =
                wfRoles.Split(&#39;,&#39;).Where(p =&gt; !wfUsers.Keys.Any(p2 =&gt; p2.ToLower() == p.ToLower())).ToList();
            if (roles.Count &gt; 0)
            {
                //All project users for a role for which user overriding is not done
                DataTable dtUsers = UserManager.Instance.GetProjectUserDetailsByRoleNames(pid,
                    string.Join(&quot;,&quot;, roles.ToArray()));
                foreach (DataRow drUsers in dtUsers.Rows)
                {
                    string roleName = drUsers[&quot;RoleName&quot;].ToString().ToLower();
                    if (!wfUsers.Keys.Contains(roleName)) wfUsers.Add(roleName, new List&lt;string&gt;());

                    DataRow[] userActionPerformed = stakeHolders.Tables[1].Select(&quot;FormInstanceID = &#39;&quot; + formID
                                                                                  + &quot;&#39; AND RoleId = &quot; +
                                                                                  drUsers[&quot;RoleId&quot;] + &quot; AND UserId = &quot; +
                                                                                  drUsers[&quot;UserId&quot;]);
                    if (userActionPerformed.Length == 0)
                    {
                        wfUsers[roleName].Add(drUsers[&quot;FirstName&quot;].ToString() + &quot; &quot; + drUsers[&quot;LastName&quot;].ToString());
                    }
                }
            }

            return string.Join(&quot;,&quot;, wfUsers.Values.SelectMany(i =&gt; i).Distinct().ToArray());
        }

        public static void GetEstimateSummaryDetails(DataSet dsEstimate, EstimateDetails estimateCounts)
        {
            DataTable dtEstimate = dsEstimate.Tables[&quot;Estimate&quot;];

            DataRow attachmentRow = dtEstimate.NewRow();
            attachmentRow[&quot;Count&quot;] = estimateCounts.TotalAttachmentCount;
            attachmentRow[&quot;Type&quot;] = &quot;Attachments&quot;;
            dtEstimate.Rows.Add(attachmentRow);

            DataRow formTemplateRow = dtEstimate.NewRow();
            formTemplateRow[&quot;Count&quot;] = 0;
            formTemplateRow[&quot;Type&quot;] = &quot;FormTemplates&quot;;
            dtEstimate.Rows.Add(formTemplateRow);

            DataRow projectRow = dtEstimate.NewRow();
            projectRow[&quot;Count&quot;] = estimateCounts.TotalProjectCount;
            projectRow[&quot;Type&quot;] = &quot;Project&quot;;
            dtEstimate.Rows.Add(projectRow);

            DataRow instanceRow = dtEstimate.NewRow();
            instanceRow[&quot;Count&quot;] = estimateCounts.TotalRecordCount;
            instanceRow[&quot;Type&quot;] = &quot;FormInstances&quot;;
            dtEstimate.Rows.Add(instanceRow);


            DataRow annotationRow = dtEstimate.NewRow();
            attachmentRow[&quot;Count&quot;] = estimateCounts.TotalAnnotationCount;
            attachmentRow[&quot;Type&quot;] = &quot;Annotations&quot;;
            dtEstimate.Rows.Add(annotationRow);

            DataTable dtEstimateTotalSize = dsEstimate.Tables[&quot;EstimateSize&quot;];

            DataRow rowTotalSize = dtEstimateTotalSize.NewRow();
            rowTotalSize[&quot;TotalSize&quot;] = estimateCounts.TotalRecordSize + estimateCounts.TotalAttachmentSize + estimateCounts.TotalAnnotationSize;
            dtEstimateTotalSize.Rows.Add(rowTotalSize);
        }

        public static DataSet GetEstimateEmptyDataSet()
        {
            DataSet dsEstimate = new DataSet();

            DataTable dtEstimate = new DataTable(&quot;Estimate&quot;);

            dtEstimate.Columns.AddRange(new DataColumn[]
            {
                    new DataColumn(&quot;Count&quot;, typeof (int)),
                    new DataColumn(&quot;Type&quot;, typeof (string)),
            });

            DataTable dtEstimateTotalSize = new DataTable(&quot;EstimateSize&quot;);
            dtEstimateTotalSize.Columns.Add(new DataColumn(&quot;TotalSize&quot;, typeof(float)));

            DataTable dtEstimateSummary = new DataTable(&quot;Summary&quot;);
            dtEstimateSummary.Columns.AddRange(new DataColumn[]
            {
                    new DataColumn(&quot;PID&quot;, typeof (int)),
                    new DataColumn(&quot;ParentID&quot;, typeof (int)),
                    new DataColumn(&quot;ModuleID&quot;, typeof (string)),
                    new DataColumn(&quot;RecordCount&quot;, typeof (int)),
                    new DataColumn(&quot;AttachmentsCount&quot;, typeof (int)),
                    new DataColumn(&quot;AnnotationsCount&quot;, typeof (decimal)),
                    new DataColumn(&quot;RecordSize&quot;, typeof (decimal)),
                    new DataColumn(&quot;AttachmentsSize&quot;, typeof (decimal)),
                    new DataColumn(&quot;AnnotationsSize&quot;, typeof (decimal))

            });

            DataTable dtEstimateTotalRecordsSummary = new DataTable(&quot;TotalRecordsSummary&quot;);
            dtEstimateTotalRecordsSummary.Columns.AddRange(new DataColumn[]
            {
                    new DataColumn(&quot;PID&quot;, typeof (int)),
                    new DataColumn(&quot;ParentID&quot;, typeof (int)),
                    new DataColumn(&quot;ModuleID&quot;, typeof (string)),
                    new DataColumn(&quot;Total&quot;, typeof (int))
            });

            dsEstimate.Tables.Add(dtEstimate);
            dsEstimate.Tables.Add(dtEstimateTotalSize);
            dsEstimate.Tables.Add(dtEstimateSummary);
            dsEstimate.Tables.Add(dtEstimateTotalRecordsSummary);

            return dsEstimate;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[36,9,36,10,0],[37,13,37,96,0],[39,13,40,82,0],[41,13,41,39,0],[42,13,42,45,0],[43,13,43,67,0],[44,13,44,41,0],[45,13,45,52,0],[47,13,48,51,0],[50,13,50,60,0],[51,13,51,95,0],[52,13,55,28,0],[58,13,64,39,0],[65,13,67,38,0],[69,13,69,95,0],[70,13,70,38,0],[71,13,71,14,0],[72,17,72,50,0],[73,17,73,67,0],[74,17,74,36,0],[75,17,75,18,0],[76,21,79,30,0],[80,21,83,30,0],[84,21,87,30,0],[88,21,91,30,0],[93,21,96,30,0],[97,21,100,33,0],[104,21,104,68,0],[105,21,105,76,0],[106,21,106,66,0],[107,21,107,74,0],[108,21,108,76,0],[109,21,109,74,0],[114,21,114,41,0],[115,21,115,22,0],[116,25,116,68,0],[117,25,117,73,0],[118,25,118,55,0],[119,25,119,61,0],[120,25,120,57,0],[121,25,121,65,0],[122,25,122,74,0],[123,25,123,63,0],[124,25,124,72,0],[126,25,126,92,0],[127,25,127,94,0],[129,25,129,64,0],[130,21,130,22,0],[132,21,132,22,0],[134,25,140,91,0],[141,21,141,22,0],[144,17,144,18,0],[145,13,145,14,0],[146,13,146,47,0],[147,13,147,14,0],[148,17,149,87,0],[150,17,150,45,0],[151,17,151,18,0],[152,21,152,57,0],[153,21,153,71,0],[154,21,154,40,0],[155,21,155,22,0],[156,25,159,34,0],[160,25,160,90,0],[161,25,161,60,0],[162,25,162,66,0],[163,25,163,62,0],[164,25,164,64,0],[165,25,165,81,0],[166,21,166,22,0],[167,17,167,18,0],[168,13,168,14,0],[169,9,169,10,0],[174,9,174,10,1],[175,13,175,43,1],[176,13,176,81,1],[178,13,178,73,1],[179,17,179,40,0],[181,13,181,59,1],[182,13,182,47,1],[183,13,183,56,1],[185,13,185,62,1],[186,13,186,54,1],[187,13,187,51,1],[189,13,189,106,1],[190,13,190,14,1],[191,17,191,76,1],[192,17,192,71,1],[193,17,193,81,1],[194,17,194,58,1],[196,17,196,201,1],[197,17,197,72,1],[198,21,198,214,1],[200,17,200,18,0],[201,21,201,92,0],[202,17,202,18,0],[204,17,204,61,1],[205,17,205,45,1],[206,17,206,18,0],[207,21,208,135,0],[210,21,210,157,0],[211,28,211,59,0],[212,21,212,22,0],[213,25,213,87,0],[214,25,214,67,0],[215,21,215,22,0],[216,17,216,18,0],[219,17,221,118,1],[223,17,223,34,1],[224,17,224,18,0],[225,21,225,90,0],[226,21,226,22,0],[227,25,227,85,0],[228,21,228,22,0],[229,17,229,18,0],[231,17,231,18,1],[232,21,232,59,1],[233,21,233,22,1],[234,25,234,158,1],[236,25,236,55,1],[237,25,237,51,1],[238,25,238,47,1],[239,25,239,40,1],[240,25,240,26,1],[241,29,241,36,1],[241,38,241,49,1],[241,50,241,52,1],[241,53,241,60,1],[242,29,242,30,1],[243,33,243,84,1],[244,33,244,104,1],[245,33,245,90,1],[246,33,247,63,1],[248,33,248,67,1],[249,29,249,30,1],[250,25,250,26,1],[251,21,251,22,1],[254,21,254,43,1],[255,21,255,22,1],[257,25,258,176,1],[260,25,260,77,1],[261,25,261,26,1],[262,29,262,36,1],[262,38,262,49,1],[262,50,262,52,1],[262,53,262,77,1],[263,29,263,30,1],[264,33,264,79,1],[265,29,265,30,1],[266,25,266,26,1],[267,21,267,22,1],[270,17,270,18,1],[271,13,271,14,1],[272,13,272,66,1],[273,13,273,59,1],[274,13,274,87,1],[276,13,276,66,1],[277,13,277,106,1],[279,13,279,39,1],[280,9,280,10,1],[283,9,283,10,1],[284,13,284,66,1],[285,13,287,78,1],[288,13,288,121,1],[289,13,289,40,1],[290,13,290,83,1],[291,13,291,52,1],[292,13,292,49,1],[293,13,293,116,1],[294,13,294,14,1],[296,17,296,18,1],[297,21,299,58,1],[300,21,300,46,1],[301,21,301,22,1],[302,25,302,68,1],[303,25,303,65,1],[304,25,304,69,1],[305,21,305,22,1],[306,17,306,18,1],[307,17,307,22,1],[308,17,308,18,1],[309,17,309,18,1],[310,13,310,14,1],[312,13,312,76,1],[314,13,314,45,1],[315,13,315,14,1],[316,17,316,109,1],[317,17,317,35,1],[318,21,318,46,0],[318,46,318,74,0],[318,74,318,98,0],[318,21,318,98,0],[319,17,319,50,1],[321,17,321,183,1],[322,17,322,35,1],[323,17,323,18,0],[324,21,324,28,0],[324,30,324,43,0],[324,44,324,46,0],[324,47,324,52,0],[325,21,325,22,0],[327,25,327,48,0],[328,25,328,52,0],[329,25,329,56,0],[330,25,330,56,0],[331,25,331,47,0],[332,25,332,51,0],[333,25,333,49,0],[334,25,334,53,0],[335,25,335,63,0],[336,25,336,61,0],[337,25,337,114,0],[340,25,340,172,0],[342,25,342,109,0],[343,25,343,129,0],[344,25,344,159,0],[345,25,345,39,0],[347,21,347,22,0],[348,21,348,48,0],[349,17,349,18,0],[350,13,350,14,1],[352,13,352,44,1],[353,13,353,46,1],[354,13,354,59,1],[355,13,355,92,1],[356,13,356,46,1],[357,13,357,14,1],[358,17,358,43,1],[359,17,359,101,1],[361,17,361,90,1],[362,21,362,49,1],[364,21,364,50,1],[366,17,366,73,1],[367,17,367,18,0],[368,21,368,48,0],[369,17,369,18,0],[371,17,371,18,1],[372,21,372,111,1],[374,21,376,69,1],[378,21,378,49,1],[380,21,380,77,1],[381,21,381,87,1],[382,21,384,29,1],[385,21,386,66,1],[388,21,388,28,1],[388,30,388,52,1],[388,53,388,55,1],[388,56,388,68,1],[389,21,389,22,1],[390,25,390,91,1],[392,25,392,72,1],[394,21,394,22,1],[396,21,396,41,1],[397,21,397,22,1],[398,25,398,52,1],[399,21,399,22,1],[400,21,400,60,1],[401,21,401,121,1],[402,21,402,58,1],[403,21,403,22,1],[404,25,404,75,1],[405,25,405,67,1],[407,25,407,32,1],[407,34,407,43,1],[407,44,407,46,1],[407,47,407,74,1],[408,25,408,26,1],[409,29,409,75,1],[410,29,410,111,1],[411,29,411,109,1],[412,29,412,77,1],[413,29,413,75,1],[414,29,414,64,1],[415,25,415,26,1],[417,25,417,53,1],[418,29,418,59,1],[420,29,420,56,0],[421,21,421,22,1],[422,17,422,18,1],[425,22,425,31,1],[425,33,425,53,1],[425,55,425,58,1],[426,17,426,18,1],[427,21,427,84,1],[428,21,428,44,1],[429,21,429,153,1],[430,21,430,22,0],[431,25,431,58,0],[432,25,432,26,0],[434,29,434,72,0],[435,29,435,30,0],[436,33,436,91,0],[437,29,437,30,0],[438,25,438,26,0],[439,21,439,22,0],[441,21,441,22,1],[442,25,442,44,1],[443,21,443,22,1],[444,21,444,66,1],[445,25,445,69,1],[447,25,447,66,1],[448,17,448,18,1],[449,13,449,14,1],[451,13,453,25,1],[454,13,454,36,1],[455,13,455,50,1],[456,13,456,14,1],[457,17,457,72,1],[458,17,460,101,1],[461,17,461,64,1],[462,17,462,39,1],[463,26,463,35,1],[463,37,463,54,1],[463,56,463,59,1],[464,21,464,22,1],[465,25,467,78,1],[468,25,468,41,1],[468,42,468,51,0],[469,25,471,79,1],[472,25,472,43,1],[472,44,472,53,0],[473,25,473,54,1],[474,21,474,22,1],[476,17,476,45,1],[477,17,477,73,1],[478,17,478,83,1],[480,17,484,62,1],[486,17,486,24,1],[486,26,486,48,1],[486,49,486,51,1],[486,52,486,64,1],[487,17,487,18,1],[488,21,488,87,1],[489,21,489,55,1],[490,21,490,22,1],[491,25,491,47,1],[494,25,494,101,1],[496,25,498,51,1],[499,25,499,31,1],[501,17,501,18,0],[502,13,502,14,1],[504,13,504,14,1],[505,17,505,34,1],[506,13,506,14,1],[510,13,510,14,1],[511,17,511,50,1],[512,17,512,18,1],[514,21,514,54,1],[515,21,515,42,1],[516,21,516,69,1],[518,21,521,87,1],[522,21,522,49,1],[523,21,523,28,1],[523,30,523,40,1],[523,41,523,43,1],[523,44,523,63,1],[524,25,524,57,1],[525,25,525,26,1],[526,29,526,51,1],[527,29,527,35,1],[529,21,529,107,1],[531,21,531,92,1],[533,21,533,53,1],[534,21,534,74,1],[535,21,535,22,1],[536,25,536,59,1],[537,25,537,57,1],[538,25,538,68,1],[538,69,538,102,0],[539,25,539,68,1],[539,69,539,102,0],[540,25,540,62,1],[540,63,540,90,1],[541,25,541,74,1],[541,75,541,114,0],[542,25,542,47,1],[543,30,543,39,1],[543,41,543,61,1],[543,63,543,66,1],[544,25,544,26,1],[545,29,545,83,1],[546,29,546,64,1],[547,29,547,30,0],[548,33,548,51,0],[549,29,549,30,0],[550,29,551,97,1],[552,29,552,30,1],[553,33,553,64,1],[554,33,554,67,1],[555,33,555,75,1],[556,33,556,83,1],[557,33,557,98,1],[558,33,558,83,1],[559,33,559,68,1],[560,33,560,34,1],[561,37,561,79,1],[562,37,562,89,1],[564,37,564,151,1],[565,41,565,101,1],[567,37,567,84,1],[568,37,568,101,1],[569,33,569,34,1],[570,33,570,55,1],[571,29,571,30,1],[572,25,572,26,1],[573,25,573,51,1],[574,21,574,22,1],[575,21,575,47,1],[576,21,576,51,1],[577,21,577,22,1],[578,25,578,51,1],[580,25,580,59,1],[583,25,583,58,1],[584,25,584,58,1],[586,25,586,32,1],[586,34,586,50,1],[586,51,586,53,1],[586,54,586,67,1],[587,25,587,26,1],[588,29,588,92,1],[589,29,589,64,1],[590,25,590,26,1],[592,25,592,32,1],[592,34,592,47,1],[592,48,592,50,1],[592,51,592,61,1],[593,25,593,26,1],[594,29,594,60,1],[595,25,595,26,1],[597,25,597,78,1],[598,21,598,22,1],[600,21,600,60,1],[601,25,601,69,1],[603,25,603,66,0],[606,21,606,53,1],[607,25,607,81,1],[609,25,609,78,0],[612,21,612,64,1],[613,25,613,63,1],[615,25,615,60,0],[617,21,617,50,1],[620,21,620,47,1],[623,21,626,51,1],[627,21,628,50,1],[632,26,632,38,1],[632,40,632,60,1],[632,62,632,68,1],[633,21,633,22,1],[636,25,638,60,1],[640,21,640,22,1],[642,21,642,60,1],[643,25,643,69,1],[645,25,645,66,0],[648,17,648,18,1],[650,13,650,14,1],[651,13,651,33,1],[652,13,652,14,1],[654,13,654,14,1],[656,13,656,47,1],[657,17,657,58,1],[659,17,659,55,0],[661,13,661,49,1],[662,17,662,62,1],[664,17,664,59,0],[666,13,666,28,1],[667,13,667,14,0],[668,17,668,51,0],[669,21,669,51,0],[671,21,671,48,0],[673,17,673,53,0],[674,21,674,53,0],[676,21,676,50,0],[677,13,677,14,0],[679,13,679,22,1],[680,9,680,10,1],[683,9,683,10,1],[684,13,685,118,1],[686,9,686,10,1],[691,9,691,10,1],[692,13,692,64,1],[693,13,693,24,1],[694,13,694,38,1],[695,13,695,47,1],[696,13,696,76,1],[697,13,697,93,1],[697,94,697,112,0],[698,13,698,121,1],[699,13,699,62,1],[700,13,700,48,1],[700,49,700,84,0],[702,13,702,20,1],[702,22,702,32,1],[702,33,702,35,1],[702,36,702,39,1],[703,13,703,14,1],[704,17,704,76,1],[705,17,705,46,1],[706,17,706,40,1],[707,17,707,56,1],[708,17,708,49,1],[709,17,709,72,1],[710,17,711,82,1],[712,17,712,46,1],[712,47,712,63,1],[713,17,713,37,1],[713,38,713,47,0],[721,17,721,50,1],[722,17,724,59,1],[725,17,725,83,1],[727,17,727,76,1],[728,17,728,75,1],[730,17,731,66,1],[733,17,733,42,1],[734,21,734,28,1],[734,30,734,52,1],[734,53,734,55,1],[734,56,734,68,1],[735,21,735,22,1],[736,25,736,67,1],[736,68,736,77,0],[737,25,737,85,1],[738,25,738,26,0],[739,29,739,85,0],[740,29,740,30,0],[741,33,741,79,0],[742,29,742,30,0],[743,29,743,38,0],[745,25,745,102,1],[746,25,746,88,1],[747,25,747,89,1],[748,25,748,44,1],[749,25,749,26,1],[750,29,750,75,1],[751,25,751,26,1],[752,21,752,22,1],[753,17,753,42,1],[753,43,753,52,0],[758,17,758,24,1],[758,26,758,40,1],[758,41,758,43,1],[758,44,758,51,1],[759,17,759,18,1],[760,21,768,24,1],[769,17,769,18,1],[770,17,770,48,1],[771,13,771,14,1],[772,13,772,31,1],[773,9,773,10,1],[776,9,776,10,1],[777,13,777,95,1],[779,13,779,107,1],[780,13,780,43,1],[781,13,781,14,0],[782,17,782,24,0],[782,26,782,41,0],[782,42,782,44,0],[782,45,782,59,0],[783,17,783,18,0],[784,21,784,80,0],[785,21,785,58,0],[785,59,785,101,0],[787,21,790,102,0],[791,21,791,57,0],[792,21,792,22,0],[793,25,793,119,0],[794,21,794,22,0],[795,17,795,18,0],[796,13,796,14,0],[798,13,799,47,1],[799,47,799,71,1],[799,71,799,98,0],[799,98,799,99,1],[799,47,799,99,1],[799,99,799,110,1],[798,13,799,110,1],[800,13,800,33,1],[801,13,801,14,1],[803,17,804,56,1],[805,17,805,24,1],[805,26,805,41,1],[805,42,805,44,1],[805,45,805,57,1],[806,17,806,18,1],[807,21,807,80,1],[808,21,808,58,1],[808,59,808,101,1],[810,21,813,102,1],[814,21,814,57,1],[815,21,815,22,1],[816,25,816,119,1],[817,21,817,22,1],[818,17,818,18,1],[819,13,819,14,1],[821,13,821,68,1],[821,68,821,69,1],[821,69,821,93,1],[821,13,821,93,1],[822,9,822,10,1],[825,9,825,10,0],[826,13,826,66,0],[828,13,828,57,0],[829,13,829,74,0],[830,13,830,51,0],[831,13,831,48,0],[833,13,833,59,0],[834,13,834,42,0],[835,13,835,55,0],[836,13,836,50,0],[838,13,838,54,0],[839,13,839,68,0],[840,13,840,44,0],[841,13,841,45,0],[843,13,843,55,0],[844,13,844,68,0],[845,13,845,51,0],[846,13,846,46,0],[849,13,849,57,0],[850,13,850,74,0],[851,13,851,51,0],[852,13,852,48,0],[854,13,854,79,0],[856,13,856,65,0],[857,13,857,146,0],[858,13,858,56,0],[859,9,859,10,0],[862,9,862,10,0],[863,13,863,48,0],[865,13,865,62,0],[867,13,871,16,0],[873,13,873,75,0],[874,13,874,89,0],[876,13,876,68,0],[877,13,889,16,0],[891,13,891,92,0],[892,13,898,16,0],[900,13,900,47,0],[901,13,901,56,0],[902,13,902,54,0],[903,13,903,66,0],[905,13,905,31,0],[906,9,906,10,0]]);
    </script>
  </body>
</html>