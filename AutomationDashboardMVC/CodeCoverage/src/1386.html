<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Platform UI\Modules\FRMBLDR\XmlFormBuilder.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Drawing.Text;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Web;
using System.Web.Services;
using System.Web.UI.WebControls;
using System.Xml;
using System.Xml.Serialization;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.ModuleManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.Platform.BusinessLayer;
using Aurigo.Brix.Platform.BusinessLayer.AbstractModels;
using Aurigo.Brix.Platform.BusinessLayer.BL;
using Aurigo.Brix.Platform.BusinessLayer.XMLForm;
using Aurigo.Brix.Platform.BusinessLayer.XmlForm_Framework;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.Platform.UI.Modules.FRMBLDR;
using Aurigo.Common;
using Newtonsoft.Json;
using Section = Aurigo.Brix.Platform.BusinessLayer.XMLForm.Section;
using UC = Aurigo.AMP3.Core.UserControls;

namespace Aurigo.Brix.Platform.UI
{
    public partial class XmlFormBuilder : BrixPageBase
    {
        #region variables and properties

        private XMLRenderingEngine _engine;
        private BrixFormModel _model;
        private static readonly char[] equalArr = { &#39;=&#39; };
        private const string FormBuilderModeString = &quot;FormBuilderMode&quot;;
        private const string IsMetaDataString = &quot;IsMetadata&quot;;
        private const string FormInstanceIDString = &quot;FormInstanceID&quot;;
        private const string XMLTYpeString = &quot;XMLType&quot;;
        private const string ModeString = &quot;Mode&quot;;


        private readonly string[] _acceptableParentModuleValues = new string[] { &quot;CONTMGT&quot;, &quot;PROJECT&quot;, &quot;LIBRARY&quot;, &quot;ESTMATE&quot;, &quot;LANDMGT&quot; };

        private static bool IsMetadata
        {
            get
            {
                if (string.IsNullOrEmpty(HttpContext.Current.Request[IsMetaDataString]))
                    return false;

                return HttpContext.Current.Request[IsMetaDataString].Equals(&quot;true&quot;, StringComparison.CurrentCultureIgnoreCase);
            }
        }

        private int? FormInstanceID
        {
            get
            {
                if (!string.IsNullOrWhiteSpace(Request[FormInstanceIDString]))
                {
                    int formInstanceId;

                    if (int.TryParse(Request[FormInstanceIDString], out formInstanceId))
                        return formInstanceId;
                }

                return null;
            }
        }

        private static XMLType XMLType
        {
            get
            {
                XMLType formType = IsMetadata ? XMLType.Control : XMLType.Form;

                var sessionType = HttpContext.Current.Session[XMLTYpeString];
                if (sessionType is string)
                {
                    var strType = sessionType as string;

                    if (!string.IsNullOrWhiteSpace(strType))
                        Enum.TryParse(strType, out formType);

                    return formType;
                }

                return formType;
            }

            set
            {
                HttpContext.Current.Session[XMLTYpeString] = value.ToString();
            }
        }

        private static FormBuilderMode RequestMode
        {
            get
            {
                var mode = FormBuilderMode.New;
                if (HttpContext.Current.Request.QueryString[ModeString] != null)
                    Enum.TryParse(HttpContext.Current.Request.QueryString[ModeString], out mode);

                return mode;
            }
        }

        // this stores the current mode.  But sometimes we need the mode from the request always.  In that
        // case plase use RequestMode
        private static FormBuilderMode CurrentMode
        {
            get
            {
                var mode = FormBuilderMode.New;
                if (HttpContext.Current.Session[FormBuilderModeString] == null)
                {
                    if (HttpContext.Current.Request.QueryString[ModeString] != null)
                        Enum.TryParse(HttpContext.Current.Request.QueryString[ModeString], out mode);
                }
                else
                    mode = (FormBuilderMode)HttpContext.Current.Session[FormBuilderModeString];

                return mode;
            }

            set
            {
                HttpContext.Current.Session[FormBuilderModeString] = value;
            }
        }

        #endregion variables and properties

        protected override void OnInit(EventArgs e)
        {
            PermissionsToCheck.Add(Constants.MODFEAT_VISIBILITY);
            if (RequestMode == FormBuilderMode.Edit)
                PermissionsToCheck.Add(Constants.MODFEAT_EDIT);
            else if (RequestMode == FormBuilderMode.View)
                PermissionsToCheck.Add(Constants.MODFEAT_VIEW);
            else
                PermissionsToCheck.Add(Constants.MODFEAT_CREATE);

            CreateMenusForFormBuilder();

            hdnMode.Value = CurrentMode.ToString();

            PageUniqueID = IsMetadata ? &quot;LIBRARY&quot; : &quot;MODMGMT&quot;;

            base.OnInit(e);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!Page.IsPostBack)
            {
                // we must set the session stored mode to the request mode when the form is first
                // started
                CurrentMode = RequestMode;

                FormBuilderPersistance.Initialize(Session);

                SetParentModuleDropdownValues();

                if ((CurrentMode == FormBuilderMode.Edit || CurrentMode == FormBuilderMode.View) &amp;&amp; FormInstanceID != null)
                    GetFormDetails();
                else if (CurrentMode == FormBuilderMode.New)
                    CreateNewXmlForm();

                if (!string.IsNullOrEmpty(Request.QueryString[&quot;context&quot;]))
                {
                    string context = Request.QueryString[&quot;context&quot;];
                    string moduleid = string.IsNullOrEmpty(Request.QueryString[&quot;moduleid&quot;])
                        ? context
                        : Request.QueryString[&quot;moduleid&quot;];

                    MemoryStream ms = XMLFileIO.Instance.GetXML(moduleid, context + &quot;.xml&quot;, XMLType.Form, false);
                    XMLFileIO.Instance.ConvertStreamToFile(ms, FormBuilderPersistance.XmlFormFileName);
                    ms.Close();

                    LoadForm();
                }
            }

            if (!File.Exists(FormBuilderPersistance.XmlFormFileName))
                Response.Redirect(Session[&quot;ReturnURL&quot;].ToString(), true);

            InitializeModel();
            if (CurrentMode == FormBuilderMode.New &amp;&amp; !IsPostBack)
                AddDefaultControls();

            if (CurrentMode == FormBuilderMode.Modify)
            {
                if (!IsPostBack)
                {
                    txtFormID.Text = _model.form.Name;
                    txtHeader.Text = _model.form.Header;
                    if (ddlParentModuleID.Items.FindByValue(_model.form.ParentModuleID) != null)
                    {
                        ddlParentModuleID.Items.FindByValue(_model.form.ParentModuleID).Selected = true;
                        hdn_Proxy_ddlParentModuleID_SelectedValue.Value = _model.form.ParentModuleID;
                    }
                }

                txtFormID.Enabled = ddlParentModuleID.Enabled = false;
            }

            RegisterCallbackString();

            SetMenus();

            LoadDefaults();

            List&lt;string&gt; ModuleComponents = ModuleManager.Instance.GetModuleComponenets(Constants.MODID_CORE);
            if (ModuleComponents.Contains(&quot;FormBuilderDemoFeatures&quot;))
            {
                ac_Button.Visible = ac_Link.Visible = ac_LinkButton.Visible = cdc_MatrixGrid.Visible = gl_Include.Visible = false;
            }
        }

        private void InitializeModel()
        {
            _model = SetupOperation();
            _engine = new XMLRenderingEngine(this, _model, controlHolder);
        }

        public static BrixFormModel SetupOperation()
        {
            var designMode = CurrentMode == FormBuilderMode.Edit;

            var ms = XMLFileIO.Instance.ConvertFileToStream(FormBuilderPersistance.XmlFormFileName);
            var model = new BrixFormModel(ms, XMLType, HttpContext.Current.Request, HttpContext.Current.Response, designMode);
            ms.Close();
            FormBuilderSupport.RemoveControls(model.form);

            return model;
        }

        public override void InclueScriptAndStyleFiles()
        {
            base.InclueScriptAndStyleFiles();
            RegisterClientScriptInclude(&quot;~/Modules/FRMBLDR/javascripts/bundle.frmbldr.*.js&quot;);
            RegisterClientScriptInclude(&quot;~/Scripts/bundle.brixform.*.js&quot;);

            // editor styles
            RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/lib/codemirror.css&quot;);
            RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/dialog/dialog.css&quot;);
            RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/hint/show-hint.css&quot;);
            RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/theme/lesser-dark.css&quot;);
            RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/foldgutter.css&quot;);
            RegisterStyle(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/hint/show-hint.css&quot;);

            // Editor Scripts
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/lib/codemirror.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/mode/xml/xml.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/edit/matchtags.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/edit/closetag.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/edit/closebrackets.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/dialog/dialog.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/hint/show-hint.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/selection/active-line.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/search/searchcursor.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/search/search.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/foldcode.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/foldgutter.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/xml-fold.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/fold/comment-fold.js&quot;);

            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/hint/show-hint.js&quot;);
            RegisterClientScriptInclude(&quot;~/Modules/WORKFLW/scripts/lib/codemirror/addon/hint/xml-hint.js&quot;);

            RegisterStyle(&quot;Styles/Style.css&quot;);
        }

        private void CreateMenusForFormBuilder()
        {
            var menus = new UC.MenuArray();
            if (RequestMode != FormBuilderMode.View)
                AddSaveButton(menus);

            if (RequestMode == FormBuilderMode.Modify &amp;&amp; HttpContext.Current.Session[&quot;ReturnURL&quot;] != null)
                menus.Add(new UC.BrixMenu(&quot;lnkBack&quot;, &quot;Back&quot;, &quot;Icn_Back.png&quot;, 55));
            else
                menus.Add(new UC.BrixMenu(&quot;lnkCancel&quot;, &quot;Cancel&quot;, &quot;Icn_Cancel.png&quot;, 55));

            menus.Add(new UC.BrixMenu(&quot;lnkPreview&quot;, &quot;Preview&quot;, &quot;Icn_View.png&quot;, 55));
            menus.Add(new UC.BrixMenu(&quot;lnkEdit&quot;, &quot;Close&quot;, &quot;Icn_Cancel.png&quot;, 55));
            menus.Add(new UC.BrixMenu(&quot;lnkUndo&quot;, &quot;Undo&quot;, &quot;Icn_Undo.png&quot;, 55));
            menus.Add(new UC.BrixMenu(&quot;lnkRedo&quot;, &quot;Redo&quot;, &quot;Icn_Redo.png&quot;, 55));

            CreateToolBarMenu(menus, null);

            var tabDesign = new UC.Tab(&quot;Design&quot;);
            tabDesign.linkButton.Attributes.Add(&quot;onclick&quot;, &quot;return changeTab(&#39;design&#39;);&quot;);
            tabDesign.linkButton.Attributes.Add(&quot;class&quot;, &quot;designTab&quot;);
            tabDesign.linkButton.Attributes.Add(&quot;href&quot;, &quot;#&quot;);
            PageTabBar.Tabs.Add(tabDesign);

            var tabXmlEditor = new UC.Tab(&quot;Edit&quot;);
            tabXmlEditor.linkButton.Attributes.Add(&quot;onclick&quot;, &quot;return changeTab(&#39;edit&#39;);&quot;);
            tabXmlEditor.linkButton.Attributes.Add(&quot;class&quot;, &quot;editTab&quot;);
            tabXmlEditor.linkButton.Attributes.Add(&quot;href&quot;, &quot;#&quot;);
            PageTabBar.Tabs.Add(tabXmlEditor);

            var tabFormDetails = new UC.Tab(&quot;Settings&quot;);
            tabFormDetails.linkButton.Attributes.Add(&quot;onclick&quot;, &quot;return changeTab(&#39;settings&#39;);&quot;);
            tabFormDetails.linkButton.Attributes.Add(&quot;class&quot;, &quot;detailsTab&quot;);
            tabFormDetails.linkButton.Attributes.Add(&quot;href&quot;, &quot;#&quot;);
            PageTabBar.Tabs.Add(tabFormDetails);
        }

        protected override void CustomizeToolBar()
        {
            if (HasSaveButton)
            {
                UC.Menu lnkSave = GetSaveButton();
                if (null != lnkSave)
                {
                    lnkSave.CausesValidation = false;
                    lnkSave.Click += Save_Click;
                }
            }

            if (MainToolBar.GetMenuReference(&quot;lnkCancel&quot;) != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).CausesValidation = false;
                MainToolBar.GetMenuReference(&quot;lnkCancel&quot;).Click += Cancel_Click;
            }
            if (MainToolBar.GetMenuReference(&quot;lnkBack&quot;) != null &amp;&amp; HttpContext.Current.Session[&quot;ReturnURL&quot;] != null)
            {
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).CausesValidation = false;
                MainToolBar.GetMenuReference(&quot;lnkBack&quot;).Click += Back_Click;
            }

            var lnkPreview = MainToolBar.GetMenuReference(&quot;lnkPreview&quot;);
            if (lnkPreview != null)
            {
                lnkPreview.CausesValidation = false;
                lnkPreview.Click += lnkPreview_Click;
            }

            var lnkEdit = MainToolBar.GetMenuReference(&quot;lnkEdit&quot;);
            if (lnkEdit != null)
            {
                lnkEdit.CausesValidation = false;
                MainToolBar.GetMenuReference(&quot;lnkEdit&quot;).Click += lnkEdit_Click;
            }

            if (MainToolBar.GetMenuReference(&quot;lnkUndo&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkUndo&quot;).OnClientClick = &quot;return processUndoRedoMenu(&#39;lnkUndo&#39;);&quot;;

            if (MainToolBar.GetMenuReference(&quot;lnkRedo&quot;) != null)
                MainToolBar.GetMenuReference(&quot;lnkRedo&quot;).OnClientClick = &quot;return processUndoRedoMenu(&#39;lnkRedo&#39;);&quot;;
        }

        private void UndoOperation()
        {
            FormBuilderPersistance.PerformUndo();
            InitializeModel();
            UpdateFormDisplay();
        }

        private void RedoOperation()
        {
            FormBuilderPersistance.PerformRedo();
            InitializeModel();
            UpdateFormDisplay();
        }

        private void lnkPreview_Click(object sender, EventArgs e)
        {
            CurrentMode = FormBuilderMode.View;
            hdnMode.Value = CurrentMode.ToString();

            SetMenus();
            InitializeModel();
            UpdateFormDisplay();
        }

        private void lnkEdit_Click(object sender, EventArgs e)
        {
            CurrentMode = FormBuilderMode.Edit;
            hdnMode.Value = CurrentMode.ToString();

            SetMenus();
            InitializeModel();
            UpdateFormDisplay();
        }

        private void SetParentModuleDropdownValues()
        {
            if (IsMetadata)
                ddlParentModuleID.Items.Add(new ListItem(&quot;DOCMGMT&quot;, &quot;DOCMGMT&quot;));
            else
            {
                Dictionary&lt;string, string&gt; modules = ModuleManager.Instance.GetModuleList();
                
                foreach (var module_code in _acceptableParentModuleValues)
                {
                    if (modules.ContainsKey(module_code))
                        ddlParentModuleID.Items.Add(new ListItem(modules[module_code], module_code));
                }

                // add ability to create enterprise modules
                ddlParentModuleID.Items.Add(new ListItem(&quot;Enterprise&quot;, &quot;ENTPRSE&quot;));
            }

        }

        private void LoadDefaults()
        {
            topBorderColor.Items.Clear();
            rightBorderColor.Items.Clear();
            bottomBorderColor.Items.Clear();
            leftBorderColor.Items.Clear();
            backgroundColor.Items.Clear();
            color.Items.Clear();
            color.Items.Add(&quot;Default&quot;);
            PropertyInfo[] pInfo = ((typeof(Color))).GetProperties();
            foreach (PropertyInfo x in pInfo)
            {
                if (x.PropertyType == typeof(Color))
                {
                    var tm = new ListItem(x.Name, x.Name);
                    tm.Attributes.Add(&quot;style&quot;, &quot;background-color:&quot; + x.Name);
                    topBorderColor.Items.Add(tm);
                    rightBorderColor.Items.Add(tm);
                    bottomBorderColor.Items.Add(tm);
                    leftBorderColor.Items.Add(tm);
                    backgroundColor.Items.Add(tm);
                    color.Items.Add(tm);
                }
            }

            fontFamily.Items.Clear();
            fontFamily.Items.Add(&quot;Default&quot;);
            var fonts = new InstalledFontCollection();

            foreach (var t in fonts.Families)
                fontFamily.Items.Add(t.Name);
        }

        private bool GerDesignMode()
        {
            return CurrentMode != FormBuilderMode.View;
        }

        private void SetMenus()
        {
            if (CurrentMode == FormBuilderMode.View)
            {
                MainToolBar.HideMenu(&quot;lnkPreview&quot;, false);
                MainToolBar.ShowMenu(&quot;lnkEdit&quot;, false);
                MainToolBar.HideMenu(&quot;lnkUndo&quot;, false);
                MainToolBar.HideMenu(&quot;lnkRedo&quot;, false);
                if (HasSaveButton)
                {
                    var lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        MainToolBar.HideMenu(&quot;lnkSave&quot;, false);
                    }
                }
                MainToolBar.HideMenu(&quot;lnkCancel&quot;, false);
                MainToolBar.HideMenu(&quot;lnkBack&quot;, false);
            }
            else
            {
                MainToolBar.ShowMenu(&quot;lnkPreview&quot;, false);
                MainToolBar.HideMenu(&quot;lnkEdit&quot;, false);
                MainToolBar.ShowMenu(&quot;lnkUndo&quot;, false);
                MainToolBar.ShowMenu(&quot;lnkRedo&quot;, false);
                if (HasSaveButton)
                {
                    UC.Menu lnkSave = GetSaveButton();
                    if (null != lnkSave)
                    {
                        MainToolBar.ShowMenu(&quot;lnkSave&quot;, false);
                    }
                }
                MainToolBar.ShowMenu(&quot;lnkCancel&quot;, false);
                if (RequestMode == FormBuilderMode.Modify)
                    MainToolBar.ShowMenu(&quot;lnkBack&quot;, false);
            }

            //Edit menu should get hidden if its in view mode.
            //And Shown in Preview mode.
            if (RequestMode == FormBuilderMode.View)
            {
                MainToolBar.HideMenu(&quot;lnkEdit&quot;, false);
                MainToolBar.ShowMenu(&quot;lnkCancel&quot;, false);
            }
        }

        private void RegisterCallbackString()
        {
            var sb = new StringBuilder();
            sb.Append(&quot;function SendFBServerRequest(arguments,context){&quot;);
            sb.Append(&quot;try{ ShowLoadingOnRequest(); }catch(ex){ }&quot;);
            sb.Append(Page.ClientScript.GetCallbackEventReference(this, &quot;arguments&quot;, &quot;HandleFBResponse&quot;, &quot;context&quot;,
                false));
            sb.Append(&quot;}&quot;);
            RegisterStartupScript(sb.ToString2());
        }

        private void MakeControlsEnabled(bool value)
        {
            txtFormID.Enabled =
                txtHeader.Enabled =
                    ddlParentModuleID.Enabled = value;
        }

        private void GetFormDetails()
        {
            FormBuilderManager.Instance.InstanceID = FormInstanceID;
            FormBuilderManager.Instance.GetFormDetails();
            txtFormID.Text = FormBuilderManager.Instance.FormID;
            txtHeader.Text = FormBuilderManager.Instance.FormHeader;

            XMLType = FormBuilderManager.Instance.XMLType;
            FormBuilderPersistance.XmlFormFileName = Server.MapPath(&quot;~/Modules/FRMBLDR/XMLForms/&quot; + FormBuilderManager.Instance.FileName);

            XMLType = FormBuilderManager.Instance.XMLType;

            var xmlStream = XMLFileIO.Instance.GetXML(FormBuilderManager.Instance.ModuleID,
                FormBuilderManager.Instance.FormID + &quot;.xml&quot;, XMLType, true);
            XMLFileIO.Instance.ConvertStreamToFile(xmlStream, FormBuilderPersistance.XmlFormFileName);
            xmlStream.Close();

            if (ddlParentModuleID.Items.FindByValue(FormBuilderManager.Instance.ParentModuleID) != null)
            {
                ddlParentModuleID.Items.FindByValue(FormBuilderManager.Instance.ParentModuleID).Selected = true;
                hdn_Proxy_ddlParentModuleID_SelectedValue.Value = FormBuilderManager.Instance.ParentModuleID;
            }

            LoadForm();

            if (CurrentMode == FormBuilderMode.View)
            {
                MakeControlsEnabled(false);
            }
        }

        private void CreateNewXmlForm()
        {
            var fomrType = Request[&quot;XMLType&quot;] ?? &quot;Form&quot;;  // default to form no matter what
            XMLType xmlType;

            if (IsMetadata)
            {
                XMLType = XMLType.Control;
            }
            else
            {
                if (!Enum.TryParse(fomrType, out xmlType))
                    xmlType = XMLType.Form;

                XMLType = xmlType;
            }

            var f = (Form)Activator.CreateInstance(GetFormType());

            txtFormID.Text = f.Name = &quot;NewForm&quot;;
            txtHeader.Text = f.Header = &quot;New Form&quot;;
            if (!IsMetadata)
            {
                f.ModuleID = f.ParentModuleID = &quot;LIBRARY&quot;;
                ddlParentModuleID.Items.FindByValue(&quot;LIBRARY&quot;).Selected = true;
                hdn_Proxy_ddlParentModuleID_SelectedValue.Value = &quot;LIBRARY&quot;;
            }
            else
            {
                f.ModuleID = f.ParentModuleID = &quot;DOCMGMT&quot;;
                ddlParentModuleID.Items.FindByValue(&quot;DOCMGMT&quot;).Selected = true;
                hdn_Proxy_ddlParentModuleID_SelectedValue.Value = &quot;DOCMGMT&quot;;
                if (f is XMLControl) (f as XMLControl).ForeignKeyColumnName = &quot;DocId&quot;;
                if (f is XMLControl) (f as XMLControl).ParentPageURL = &quot;/Modules/DOCMGMT/Documents.aspx&quot;;
                if (f is XMLControl) (f as XMLControl).ReferenceControlID = &quot;divMetadata&quot;;
                if (f is XMLControl) (f as XMLControl).IsTemplate = true;
            }

            FormBuilderPersistance.WriteToDisk(f);
        }

        private IEnumerable&lt;AttributeInfo&gt; MakeAttribList(string operands)
        {
            var attributes = new List&lt;AttributeInfo&gt;();

            var pairs = operands.Split(&#39;~&#39;);
            foreach (var pair in pairs)
            {
                var parts = pair.Split(equalArr);
                if (parts.Length == 2)
                    attributes.Add(new AttributeInfo { name = parts[0], value = parts[1] });
            }

            return attributes;
        }

        private void AddDefaultControls()
        {
            ControlContainer section;
            var addSection = new AddSection(_model);
            addSection.Add(
                new Command
                {
                    destinationControl = &quot;controlHolder&quot;,
                    sourceControl = &quot;NewForm&quot;,
                    type = &quot;Section&quot;
                },
                out section);

            if (section == null)
                return;

            ProcessApply(_model, new Command { destinationControl = section.Name, attributes = MakeAttribList(&quot;Attributes=display:none~Caption=&quot;) });

            var cmd = new Command { command = &quot;add&quot;, type = &quot;control&quot;, destinationControl = section.Name };
            ControlContainer Id;
            var addControl = new AddControl(_model);
            addControl.Add(cmd, out Id);

            if (!IsMetadata)
            {
                ControlContainer Pid, ParentId, ModifiedBy, ModifiedOn;
                addControl.Add(cmd, out Pid); //PID column
                addControl.Add(cmd, out ParentId); //ParentID Column
                addControl.Add(cmd, out ModifiedBy); //ModifiedBy Column
                addControl.Add(cmd, out ModifiedOn); //ModifiedOn Column

                ProcessApply(_model, new Command { destinationControl = &quot;NewForm&quot;, attributes = MakeAttribList(&quot;TableName=TableName~PrimaryKeyName=ID~EnableAuditLog=true&quot;) });
                ProcessApply(_model, new Command { destinationControl = Id.Name, attributes = MakeAttribList(&quot;Caption=ID~Name=ID~Type=Hidden~PrimaryKey=true~DBType=Int Identity(1,1)~Value={_REQUEST:InstanceID}&quot;) });
                ProcessApply(_model, new Command { destinationControl = Pid.Name, attributes = MakeAttribList(&quot;Caption=PID~Name=PID~Type=Hidden~FilterKey=true~DBType=int~Value={_REQUEST:PID}&quot;) });
                ProcessApply(_model, new Command { destinationControl = ParentId.Name, attributes = MakeAttribList(&quot;Caption=ParentID~Name=ParentID~Type=Hidden~FilterKey=true~DBType=int~Value={_REQUEST:ParentID}&quot;) });
                ProcessApply(_model, new Command { destinationControl = ModifiedBy.Name, attributes = MakeAttribList(&quot;Caption=ModifiedBy~Name=AUR_ModifiedBy~Type=Hidden~DBType=nvarchar(2000)~Value={CURRENTUSERNAME}~ReEvaluate=true&quot;) });
                ProcessApply(_model, new Command { destinationControl = ModifiedOn.Name, attributes = MakeAttribList(&quot;Caption=ModifiedOn~Name=AUR_ModifiedOn~Type=Hidden~DBType=datetime~Value={CURRENTDATETIME}~ReEvaluate=true&quot;) });
            }
            else
            {
                ProcessApply(_model, new Command { destinationControl = &quot;NewForm&quot;, attributes = MakeAttribList(&quot;TableName=TableName~PrimaryKeyName=DocId&quot;) });
                ProcessApply(_model, new Command { destinationControl = Id.Name, attributes = MakeAttribList(&quot;Caption=DocId~Name=DocId~Type=Hidden~PrimaryKey=true~DBType=Int~Value={_Form:instanceID}&quot;) });
            }
            FormBuilderPersistance.WriteToDisk(_model.form);
            UpdateFormDisplay();
        }

        private void LoadForm()
        {
            //regenerate the form just to make sure everthing is from the file.
            InitializeModel();
            FormBuilderPersistance.WriteToDisk(_model.form);
            UpdateFormDisplay();
        }

        protected void Operation_Click(object sender, EventArgs e)
        {
            var err = string.Empty;

            if (_engine == null)
                return;
            if (String.IsNullOrEmpty(operation.Value))
                return;

            var cmd = JsonConvert.DeserializeObject&lt;Command&gt;(operation.Value);
            cmd.command = cmd.command.Replace(Environment.NewLine, string.Empty).Trim().ToLower();

            CopyXML(cmd.command); // this is for undoredo operations

            switch (cmd.command)
            {
                case &quot;xml&quot;:
                    err = ProcessXml(cmd);
                    break;

                case &quot;add&quot;:
                    err = ProcessAdd(cmd);
                    break;

                case &quot;listcolumns&quot;:
                    ProcessListColumns(cmd);
                    break;

                case &quot;apply&quot;:
                    err = ProcessApply(_model, cmd);
                    break;

                case &quot;delete&quot;:
                    ProcessDelete(cmd);
                    break;

                case &quot;move&quot;:
                    err = ProcessMove(cmd);
                    break;

                case &quot;undoredo&quot;:
                    ProcessUndoRedo(cmd);
                    break;
            }

            FormBuilderPersistance.WriteToDisk(_model.form);
            UpdateFormDisplay();

            logger.Text = err;
        }

        private static Type GetFormType()
        {
            Type formType;
            switch (XMLType)
            {
                default:
                    formType = typeof(Form);
                    break;

                case XMLType.Control:
                    formType = typeof(XMLControl);
                    break;

                case XMLType.SharedControl:
                    formType = typeof(SharedXMLControl);
                    break;
            }

            return formType;
        }

        private string ProcessXml(Command cmd)
        {
            string err = string.Empty;

            MemoryStream memStream;
            using (memStream = new MemoryStream())
            {
                // put the new xml to disk
                var bytes = Encoding.UTF8.GetBytes(cmd.xml);
                memStream.Write(bytes, 0, bytes.Length);
                memStream.Seek(0, SeekOrigin.Begin);
                XmlSerializer serializer = new XmlSerializer(GetFormType());
                try
                {
                    var form = ((Form)serializer.Deserialize(memStream));
                    FormBuilderSupport.RemoveControls(form);
                    FormBuilderPersistance.WriteToDisk(form);
                    InitializeModel();
                    UpdateFormDisplay();
                }
                catch (XmlException e)
                {
                    err = &quot;Invalid Form Definition Ignored:&quot; + e.Message;
                }
            }

            return err;
        }

        private string ProcessAdd(Command cmd)
        {
            ControlContainer control;

            AdderFactory.SetModel(_model);
            var err = AdderFactory.Add(cmd, out control);
            return err;
        }

        private void CopyXML(string action)
        {
            //Make a copy of the XML if its not undoredo
            if (action == &quot;undoredo&quot;) return;

            var tempSource = FormBuilderPersistance.XmlFormFileName;
            if (tempSource.IndexOf(&quot;__&quot;, StringComparison.Ordinal) &gt; 0)
                tempSource = tempSource.Remove(FormBuilderPersistance.XmlFormFileName.IndexOf(&quot;__&quot;, StringComparison.Ordinal));
            var newFileName = tempSource.Replace(&quot;.xml&quot;, &quot;&quot;) + &quot;__&quot; + DateTime.UtcNow.Ticks + &quot;.xml&quot;;

            FormBuilderPersistance.CopyFile(FormBuilderPersistance.XmlFormFileName, newFileName);
            FormBuilderPersistance.DeleteFiles(FormBuilderPersistance.FileNames.Push(newFileName));
            FormBuilderPersistance.DeleteFiles(FormBuilderPersistance.RedoFileNames.ToList());
            FormBuilderPersistance.RedoFileNames.Clear();
        }

        private void UpdateFormDisplay()
        {
            controlHolder.Controls.Clear();
            _engine.Initialize();
            _model.IsDesignMode = GerDesignMode();
            _model.form.instanceID = null;
            _engine.Render(RenderFormat.RenderHtml);
        }

        private static string ApplyStyles(ControlContainer dest, IEnumerable&lt;AttributeInfo&gt; attributes)
        {
            Type t = dest.GetType();

            foreach (var attr in attributes)
            {
                string attribute = attr.name;

                if (string.IsNullOrWhiteSpace((attribute))) continue;

                string value = Uri.UnescapeDataString(attr.value);

                //TODO: Right now we are allowing to set caption to empty string, later on we need to fix it properly
                //We can not set all the attributes to null or empty values else user will have to enter all the values before applying styles
                // like in case of width - if user leaves it empty and we set it to Width attribute it causes problem.
                if (!string.IsNullOrEmpty(value) || attribute == &quot;Caption&quot;)
                {
                    // PBI: 24707:  Formbuilder allows you to change the name of an control to a duplicate name.  This causes a
                    // duplicate column in db and also the rendering crashes as asp.net webforms does not allow duplicate names.
                    //
                    if (attribute == &quot;Name&quot;)
                    {
                        ControlContainer foundCtrl = null;
                        dest.form.ProcessAllContainersDeeply(cc =&gt;
                        {
                            if (cc.Name == value)
                                foundCtrl = cc;
                        });
                        if (foundCtrl == null)
                        {
                            dest.form.ProcessAllControlsDeeply(cc =&gt;
                            {
                                if (cc.Name == value)
                                    foundCtrl = cc;
                            });
                        }

                        // if the control is found by name and it is not the actual control being modified then retgurn error.
                        if (foundCtrl != null &amp;&amp; foundCtrl != dest)
                            return $&quot;Duplicate control names are not allowed: {value} already exists in form&quot;;
                    }

                    // PBI: 24489:  If you change the type of a control to a control that requires a derived type then
                    // formbuilder must reallocate the control and re-add it to the form
                    if (attribute == &quot;Type&quot; &amp;&amp; (value == &quot;AutoIncrement&quot; || value == &quot;AttachmentControl&quot;))
                    {
                        if (value != t.Name)
                        {
                            // if we get here we have to reallocate the object to the correct type
                            xControl newCtrl;

                            if (value == &quot;AutoIncrement&quot;)
                                newCtrl = new AutoIncrement();
                            else
                                newCtrl = new AttachmentControl();

                            // move all the attributes over using reflection
                            foreach (var a in t.GetFields())
                                try
                                {
                                    a.SetValue(newCtrl, a.GetValue(dest));
                                }
                                catch
                                {
                                    // ignored
                                }
                            foreach (var b in t.GetProperties())
                                try
                                {
                                    b.SetValue(newCtrl, b.GetValue(dest, null), null);
                                }
                                catch
                                {
                                    // ignored
                                }
                            // remove the old object from the form and add the new object to the form in the same position
                            // reset dest to the new object so the attributes continue to come over.
                            var index = dest.ParentObject.Controls.IndexOf(dest as xControl);
                            if (index &gt; 0)
                            {
                                var p = dest.ParentObject;
                                p.Controls.Remove(dest as xControl);
                                p.Controls.Insert(index, newCtrl);
                                dest = newCtrl;
                            }
                        }
                    }

                    var f = t.GetField(attribute);
                    if (f != null)
                        f.SetValue(dest, GetAttributeValue(value, f.FieldType));
                    else
                    {
                        PropertyInfo p = t.GetProperty(attribute);
                        if (p != null)
                            p.SetValue(dest, GetAttributeValue(value, p.PropertyType), null);
                    }
                }
            }

            if (dest is xControl)
                FormBuilderSupport.CorrectDBType(dest as xControl);

            return string.Empty;
        }

        private static object GetAttributeValue(string value, Type properType)
        {
            if (properType.IsSubclassOf(typeof(Enum)))
            {
                var enumvalue = (int)properType.GetField(value).GetValue(properType);
                object newEnumValue = Enum.ToObject(properType, enumvalue);

                return newEnumValue;
            }

            if (properType == typeof(Boolean))
            {
                if (value.ToLower() == &quot;true&quot;)
                    return true;

                return false;
            }

            if (properType == typeof(Int32))
            {
                return value.ToInt32_2();
            }

            return value;
        }

        private void ProcessListColumns(Command cmd)
        {
            var colArray = new StringBuilder();
            foreach (var attrib in cmd.attributes)
            {
                // look up the column
                var dest = FormBuilderSupport.GetDestination(_model, attrib.name);
                if (dest != null)
                {
                    var ctrl = dest as xControl;
                    if (ctrl != null)
                    {
                        // if this is a control and it has a datasource then we need to use the foreign key reference syntax for this column
                        if (!string.IsNullOrWhiteSpace(ctrl.DataSource))
                        {
                            var parts = ctrl.DataSource.Split(&#39;;&#39;);
                            if (parts.Length &gt;= 3)
                                colArray.Append(parts[0] + &quot;.&quot; + parts[1] + &quot; as [&quot; + ctrl.Caption + &quot;]&quot;);
                        }
                        else
                            colArray.Append(attrib.name);
                    }
                    else
                        colArray.Append(attrib.name);

                    colArray.Append(&quot;,&quot;);
                }
            }

            colArray.Remove(colArray.Length - 1, 1);
            _model.form.ListColumns.Columns = colArray.ToString();
        }

        private static string ProcessApply(BrixFormModel model, Command cmd)
        {
            var dest = FormBuilderSupport.GetDestination(model, cmd.destinationControl);
            if (dest != null)
            {
                return ApplyStyles(dest, cmd.attributes);
            }
            return string.Empty;
        }

        private string ProcessMove(Command cmd)
        {
            ControlContainer dstctrl = FormBuilderSupport.GetDestination(_model, cmd.destinationControl);
            ControlContainer srcctrl = _model.form.GetContainer(cmd.sourceControl);
            if (dstctrl == null || srcctrl == null || srcctrl == dstctrl)
                return &quot;Invalid source or destination for move&quot;;

            if (srcctrl is xControl)
            {
                if (dstctrl.GetType() == typeof(Section))
                {
                    // if we move from control to section then just move it to the bottom of dropped section
                    srcctrl.ParentObject.Controls.Remove(srcctrl as xControl);
                    dstctrl.Controls.Add(srcctrl as xControl);
                }
                else if (dstctrl is xControl)
                {
                    if ((dstctrl as xControl).Type == ControlType.Set)
                    {
                        srcctrl.ParentObject.Controls.Remove(srcctrl as xControl);
                        dstctrl.Controls.Add(srcctrl as xControl);
                    }
                    else
                    {
                        if (dstctrl.ParentObject is CheckListGroup &amp;&amp; srcctrl is xColumn)
                            return &quot;Invalid drop operation, cant drop column on check list&quot;;

                        var pos = FormBuilderSupport.FindDroppedControl(dstctrl.ParentObject, dstctrl.Name);
                        if (pos != -1)
                        {
                            // we are moving a column inside of a static grid from one pos to another
                            if (srcctrl.ParentObject is Header &amp;&amp; srcctrl.ParentObject == dstctrl.ParentObject)
                            {
                                var parent = srcctrl.ParentObject;
                                var posSrc = FormBuilderSupport.FindDroppedControl(parent, srcctrl.Name);
                                if (posSrc != -1)
                                {
                                    // if we dragged right then we need to subtract from pos
                                    if (posSrc &lt; pos) pos = pos - 1;

                                    var numHidden = parent.Controls.Count(m =&gt; m.Type == ControlType.Hidden);
                                    foreach (var r in parent.ParentObject.Containers.OfType&lt;Row&gt;())
                                    {
                                        var remCtrl = r.Controls[posSrc - numHidden];
                                        r.Controls.RemoveAt(posSrc - numHidden);
                                        r.Controls.Insert(pos - numHidden, remCtrl);
                                    }
                                }
                            }

                            if (!(dstctrl.ParentObject is Row))
                            {
                                // if destination is another xcontrol then move it below the dropped control
                                srcctrl.ParentObject.Controls.Remove(srcctrl as xControl);
                                dstctrl.ParentObject.Controls.Insert(pos, srcctrl as xControl);
                            }
                            else
                                return &quot;cant drop controls on rows&quot;;
                        }
                        else
                            return &quot;Could not find destination of move operation&quot;;
                    }
                }
                else
                    return &quot;Controls must be inside of a Section, Static Grid, or Dynamic Grid&quot;;
            }
            else // non controls can only be dropped on forms or other containers
            {
                // find the nearest controlcontainer that is not an xControl
                while (dstctrl is xControl)
                    dstctrl = dstctrl.ParentObject;

                if (dstctrl == null)
                    return string.Empty;

                // dont allow control containers to be moved into a picker or static grid.  This will probably need more work for other combinations
                if ((dstctrl is Row || dstctrl is Header || dstctrl is Picker || dstctrl is DynamicGrid || dstctrl is StaticGrid))
                    return &quot;Cant drop a Container on a Picker, Dynamic Grid or StaticGrid&quot;;

                srcctrl.ParentObject.Containers.Remove(srcctrl);
                dstctrl.Containers.Add(srcctrl);
            }

            return string.Empty;
        }

        private void ProcessDelete(Command cmd)
        {
            xControl deleted = _model.form.GetControl(cmd.sourceControl);
            if (deleted != null)
            {
                ControlContainer parent = deleted.ParentObject;

                //dont delete individual controls from Row Controls.  All Rows MUST have the same number
                // of columns.
                if (parent != null &amp;&amp; parent.GetType() != typeof(Row))
                {
                    // KK: if we delete a column of a static grid then we must delete the controls in the rows also
                    if (parent is Header)
                    {
                        var pos = FormBuilderSupport.FindDroppedControl(parent, deleted.Name);
                        if (pos != -1)
                        {
                            var numHidden = parent.Controls.Count(m =&gt; m.Type == ControlType.Hidden);
                            foreach (var r in parent.ParentObject.Containers.OfType&lt;Row&gt;())
                            {
                                if (pos - numHidden &gt; r.Controls.Count)
                                    r.Controls.RemoveAt(pos - numHidden);
                            }
                        }
                    }

                    parent.Controls.Remove(deleted);
                }
            }
            else
            {
                ControlContainer c = _model.form.GetContainer(cmd.sourceControl);
                var localParent = c?.ParentObject;
                localParent?.Containers.Remove(c);
            }
        }

        private void ProcessUndoRedo(Command cmd)
        {
            string action = cmd.sourceControl;  // holds the menu id
            if (action == &quot;lnkUndo&quot;)
            {
                if (FormBuilderPersistance.CanUndo())  // KK: added checks bacause updating menu enabled is async.  Doesnt Crash anymore
                    UndoOperation();
            }
            else if (action == &quot;lnkRedo&quot;)
            {
                if (FormBuilderPersistance.CanRedo())
                    RedoOperation();
            }
        }

        private void Cancel_Click(object sender, EventArgs e)
        {
            DeleteTempFile();
            Response.Redirect(IsMetadata
                ? &quot;/Common/BrixListPage.aspx?context=DOCMDTA&amp;Module=LIBRARY&quot;
                : &quot;/Common/BrixListPage.aspx?Context=FRMBLDR&quot;, true);
        }

        private void Back_Click(object sender, EventArgs e)
        {
            DeleteTempFile();
            Response.Redirect(HttpContext.Current.Session[&quot;ReturnURL&quot;].ToString(), true);
        }

        private void DeleteTempFile()
        {
            if (File.Exists(FormBuilderPersistance.XmlFormFileName))
                File.Delete(FormBuilderPersistance.XmlFormFileName);

            FormBuilderPersistance.DeleteFiles(FormBuilderPersistance.FileNames.ToList());
            FormBuilderPersistance.FileNames.Clear();
            FormBuilderPersistance.DeleteFiles(FormBuilderPersistance.RedoFileNames.ToList());
            FormBuilderPersistance.RedoFileNames.Clear();
        }

        private void Save_Click(object sender, EventArgs e)
        {
            if (CurrentMode == FormBuilderMode.Modify)
            {
                var sb = new StringBuilder();

                FormBuilderManager.Instance.AlterTableNames(_model);
                _model.form.ProcessAllContainersDeeply(
                    cc =&gt;
                    {
                        (cc as DataBaseContainer)?.ModifyTable(sb);
                    }
                    );

                if (!string.IsNullOrEmpty(sb.ToString()))
                    FormBuilderManager.Instance.RunDBScript(sb.ToString());

                FormBuilderManager.Instance.RunDBScript(_model.form.DropViewQuery());
                FormBuilderManager.Instance.RunDBScript(_model.form.CreateViewQuery());

                hdnMessage.Value = &quot;Form Saved Successfully&quot;;
                FormBuilderPersistance.WriteToDisk(_model.form);
                XMLFileIO.Instance.StoreXML(_model.form.ModuleID,
                    FormBuilderPersistance.XmlFormFileName, _model.form.Name + &quot;.xml&quot;, IsMetadata ? XMLType.Control : XMLType.Form, false);
                Back_Click(sender, e);
            }
            else
            {
                SaveFormDetails();
                if (FormBuilderManager.Instance.IsRecordExists != 0)
                {
                    FormBuilderPersistance.WriteToDisk(_model.form);
                    XMLFileIO.Instance.StoreXML(FormBuilderManager.Instance.ModuleID,
                        FormBuilderPersistance.XmlFormFileName, FormBuilderManager.Instance.FormID + &quot;.xml&quot;,
                        XMLType, true);
                    DeleteTempFile();
                    Cancel_Click(sender, e);
                }
                else
                {
                    hdnMessage.Value = &quot;FormID already exists&quot;;
                }
            }
        }

        private void SaveFormDetails()
        {
            UserDetail currentUser = UserDetail.GetCurrentUserDetail();
            FormBuilderManager.Instance.InstanceID = CurrentMode == FormBuilderMode.New ? null : FormInstanceID;
            FormBuilderManager.Instance.FormID = txtFormID.Text;
            FormBuilderManager.Instance.FormHeader = txtHeader.Text;
            FormBuilderManager.Instance.ParentModuleID = GetCorrectedValueFor_ddlParentModuleID();
            if (CurrentMode == FormBuilderMode.New)
            {
                FormBuilderManager.Instance.CreatedBy = currentUser.UID;
                FormBuilderManager.Instance.CreatedUser = currentUser.UserName;
                FormBuilderManager.Instance.CreatedDate = DateTime.UtcNow;
                FormBuilderManager.Instance.ModifiedBy = null;
                FormBuilderManager.Instance.ModifiedUser = string.Empty;
                FormBuilderManager.Instance.ModifiedDate = null;
                FormBuilderManager.Instance.IsMetadata = IsMetadata;
                FormBuilderManager.Instance.IsXmlControl = IsMetadata;
            }
            else
            {
                FormBuilderManager.Instance.ModifiedBy = currentUser.UID;
                FormBuilderManager.Instance.ModifiedUser = currentUser.UserName;
                FormBuilderManager.Instance.ModifiedDate = DateTime.UtcNow;
            }
            FormBuilderManager.Instance.Mode = (CurrentMode == FormBuilderMode.New ? &quot;C&quot; : &quot;U&quot;);
            string[] filename = FormBuilderPersistance.XmlFormFileName.Split(&#39;\\&#39;);
            FormBuilderManager.Instance.FileName = filename[filename.Length - 1];
            FormBuilderManager.Instance.CUDFormBuilderDetails();
            if (FormBuilderManager.Instance.InstanceID != 0)
            {
                FormBuilderManager.Instance.AlterForm(_model);
            }
        }

        private string GetCorrectedValueFor_ddlParentModuleID()
        {
            List&lt;string&gt; acceptableSelectedValues = new List&lt;string&gt;();

            if (IsMetadata)
                acceptableSelectedValues.Add(&quot;DOCMGMT&quot;);
            else
            {
                Dictionary&lt;string, string&gt; modules = ModuleManager.Instance.GetModuleList();
                
                foreach (var module_code in _acceptableParentModuleValues)
                {
                    if (modules.ContainsKey(module_code))
                        acceptableSelectedValues.Add(module_code);
                }

                // add ability to create enterprise modules
                acceptableSelectedValues.Add(&quot;ENTPRSE&quot;);
            }

            if (string.IsNullOrWhiteSpace(this.hdn_Proxy_ddlParentModuleID_SelectedValue.Value))
            {
                return ddlParentModuleID.SelectedValue;
            }
            else
            {
                string selectedVal = this.hdn_Proxy_ddlParentModuleID_SelectedValue.Value.ToUpper();

                if (acceptableSelectedValues.Contains(selectedVal))
                    return selectedVal;
                else
                {
                    //since the value has been tampered or empty
                    if (IsMetadata)
                        return acceptableSelectedValues.First();
                    else
                        return ddlParentModuleID.SelectedValue;
                }
            }
        }

        #region Asynchronous Callbacks with Web Methods

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static string GetXml()
        {
            var xmlfile = File.ReadAllText(FormBuilderPersistance.XmlFormFileName);
            return xmlfile;
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static Command GetAttributes(bool isMetadata, string control)
        {
            Command cmd = new Command();
            var model = SetupOperation();

            var dest = FormBuilderSupport.GetDestination(model, control);

            if (dest != null)
            {
                cmd.command = &quot;set&quot;;
                cmd.destinationControl = dest.Name;
                cmd.attributes = FormBuilderSupport.GetControlContainerAttributes(dest);

                return cmd;
            }

            return cmd;
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static HierarchyResponse GetControlHierarchy(bool isMetadata)
        {
            var model = SetupOperation();

            var response = new HierarchyResponse
            {
                Root = new Node
                {
                    Type = ControlType.TextBox,
                    Name = &quot;Root&quot;,
                    Caption = &quot;Root&quot;,
                    ListCapable = false,
                    ListColumn = false
                }
            };

            var listColumns = string.IsNullOrWhiteSpace(model.form.ListColumns.Columns)
                ? string.Empty
                : model.form.ListColumns.Columns;
            var colArray = listColumns.Split(&#39;,&#39;);
            var processedColumns = new List&lt;string&gt;();

            foreach (var column in colArray)
            {
                if (column.Contains(&quot;.&quot;))
                {
                    var parts = column.Split(&#39;.&#39;);
                    if (parts.Length &gt;= 2)
                    {
                        var reference = model.form.References[parts[0]];
                        processedColumns.Add(reference != null ? reference.ReferedBy.Name : string.Empty);
                    }
                }
                else
                    processedColumns.Add(column);
            }

            ProcessFormRecursively(response.Root, model.form, processedColumns);

            return response;
        }

        private static void ProcessFormRecursively(Node root, ControlContainer ctrl, IEnumerable&lt;string&gt; ListColumns)
        {
            Node child;
            var listColumns = ListColumns as string[] ?? ListColumns.ToArray();
            foreach (var xc in ctrl.Controls)
            {
                child = new Node
                {
                    Type = xc.Type,
                    Name = GetName(xc),
                    Caption = xc.Caption,
                    ListCapable =
                        xc.Type != ControlType.Hidden &amp;&amp; xc.ParentObject is Section &amp;&amp; xc.Type != ControlType.Set,
                    ListColumn = listColumns.Contains(xc.Name)
                };

                root.Children.Add(child);
                ProcessFormRecursively(child, xc, listColumns);
            }

            foreach (var c in ctrl.Containers)
            {
                child = new Node
                {
                    Name = GetName(c),
                    Caption = GetCaption(c),
                    ListCapable = false,
                    ListColumn = listColumns.Contains(c.Name)
                };

                root.Children.Add(child);
                ProcessFormRecursively(child, c, listColumns);
            }
        }

        private static string GetCaption(ControlContainer c)
        {
            var dynamicGrid = c as DynamicGrid;
            if (dynamicGrid != null) return dynamicGrid.Caption;
            var grid = c as StaticGrid;
            if (grid != null) return grid.Caption;
            var section = c as Section;
            if (section != null) return section.Caption;
            var group = c as CheckListGroup;
            if (group != null) return group.Description;
            var list = c as CheckList;
            if (list != null) return list.Description;

            return c.Name;
        }

        private static string GetName(ControlContainer c)
        {
            var column = c as xColumn;
            if (column != null)
                return column.ColumnName ?? column.Name;
            if (c is DynamicGrid || c is StaticGrid || c is xControl)
                return c.Name;
            if (c is Row)
                return c.Name;
            if (c is Header)
                return &quot;Header&quot;;

            return c.Name;
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static string GetMenus()
        {
            var result = &quot;lnkUndo:&quot; + (FormBuilderPersistance.FileNames.Count &gt; 1 ? &quot;Enabled&quot; : &quot;Disabled&quot;);
            result += &quot;;lnkRedo:&quot; + (FormBuilderPersistance.RedoFileNames.Count &gt; 0 ? &quot;Enabled&quot; : &quot;Disabled&quot;);

            return result;
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static string ChangeControlSize(bool isMetadata, string control, string width, string height)
        {
            var model = SetupOperation();

            var attributes = new[]
            {
                new AttributeInfo { name= &quot;Width&quot;, value = width + &quot;px&quot;  },
                new AttributeInfo { name= &quot;Height&quot;, value = height + &quot;px&quot;  }
            };

            ProcessApply(model, new Command { destinationControl = control, attributes = attributes });
            FormBuilderPersistance.WriteToDisk(model.form);
            return null;
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static string ChangeLabel(bool isMetadata, string control, string Caption)
        {
            var model = SetupOperation();

            var attributes = new[] { new AttributeInfo { name = &quot;Caption&quot;, value = Caption } };
            ProcessApply(model, new Command { destinationControl = control, attributes = attributes });
            FormBuilderPersistance.WriteToDisk(model.form);

            return null;
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static IEnumerable&lt;FormInfo&gt; GetFormList()
        {
            return FormBuilderSupport.GetFormList();
        }

        public class ParamInfo
        {
            public string Name { get; set; }
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static IEnumerable&lt;ParamInfo&gt; GetFormElements(FormInfo Form)
        {
            var provider = AppProviderManager.Instance.GetProvider(&quot;BRIXProvider&quot;);
            var datasource = provider?.GetDataSource(&quot;XMLGet&quot;, false);
            var resource = datasource?.GetResourceById(Form.Id);
            if (resource != null)
            {
                var Params = from o in resource.GetOutputParamNames().Contents
                             select new ParamInfo
                             {
                                 Name = o.Value.Name
                             };

                return Params;
            }

            return null;
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static IEnumerable&lt;SimpleResolver&gt; GetResolvers()
        {
            return ResolverFactory.Resolvers;
        }

        [WebMethod(BufferResponse = false, EnableSession = false)]
        public static IEnumerable&lt;PickerInfo&gt; GetPickers(string dgrid)
        {
            var model = SetupOperation();

            var pickers = new List&lt;PickerInfo&gt;();
            model.form.ProcessAllContainersDeeply(m =&gt;
            {
                var p = m as Picker;
                if (p != null)
                {
                    pickers.Add(new PickerInfo
                    {
                        PickerName = p.Name,
                        PickerCaption = p.Caption,
                        PickerFields = (from o in p.Controls select p.Name + &quot;.&quot; + (o as xColumn)?.ColumnName).ToList()
                    });
                }
            });

            return pickers;
        }

        #endregion Asynchronous Callbacks with Web Methods
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[37,9,37,59,0],[45,9,45,138,0],[50,13,50,14,0],[51,17,51,89,0],[52,21,52,34,0],[54,17,54,128,0],[55,13,55,14,0],[61,13,61,14,0],[62,17,62,79,0],[63,17,63,18,0],[66,21,66,89,0],[67,25,67,47,0],[68,17,68,18,0],[70,17,70,29,0],[71,13,71,14,0],[77,13,77,14,0],[78,17,78,80,0],[80,17,80,78,0],[81,17,81,43,0],[82,17,82,18,0],[83,21,83,57,0],[85,21,85,61,0],[86,25,86,62,0],[88,21,88,37,0],[91,17,91,33,0],[92,13,92,14,0],[95,13,95,14,0],[96,17,96,79,0],[97,13,97,14,0],[103,13,103,14,0],[104,17,104,48,0],[105,17,105,81,0],[106,21,106,98,0],[108,17,108,29,0],[109,13,109,14,0],[117,13,117,14,0],[118,17,118,48,0],[119,17,119,80,0],[120,17,120,18,0],[121,21,121,85,0],[122,25,122,102,0],[123,17,123,18,0],[125,21,125,96,0],[127,17,127,29,0],[128,13,128,14,0],[131,13,131,14,0],[132,17,132,76,0],[133,13,133,14,0],[139,9,139,10,0],[140,13,140,66,0],[141,13,141,53,0],[142,17,142,64,0],[143,18,143,58,0],[144,17,144,64,0],[146,17,146,66,0],[148,13,148,41,0],[150,13,150,52,0],[152,13,152,63,0],[154,13,154,28,0],[155,9,155,10,0],[158,9,158,10,0],[159,13,159,34,0],[160,13,160,14,0],[163,17,163,43,0],[165,17,165,60,0],[167,17,167,49,0],[169,17,169,124,0],[170,21,170,38,0],[171,22,171,61,0],[172,21,172,40,0],[174,17,174,75,0],[175,17,175,18,0],[176,21,176,69,0],[177,21,179,59,0],[181,21,181,114,0],[182,21,182,104,0],[183,21,183,32,0],[185,21,185,32,0],[186,17,186,18,0],[187,13,187,14,0],[189,13,189,70,0],[190,17,190,74,0],[192,13,192,31,0],[193,13,193,67,0],[194,17,194,38,0],[196,13,196,55,0],[197,13,197,14,0],[198,17,198,33,0],[199,17,199,18,0],[200,21,200,55,0],[201,21,201,57,0],[202,21,202,97,0],[203,21,203,22,0],[204,25,204,105,0],[205,25,205,102,0],[206,21,206,22,0],[207,17,207,18,0],[209,17,209,71,0],[210,13,210,14,0],[212,13,212,38,0],[214,13,214,24,0],[216,13,216,28,0],[218,13,218,111,0],[219,13,219,70,0],[220,13,220,14,0],[221,17,221,131,0],[222,13,222,14,0],[223,9,223,10,0],[226,9,226,10,0],[227,13,227,39,0],[228,13,228,75,0],[229,9,229,10,0],[232,9,232,10,0],[233,13,233,66,0],[235,13,235,101,0],[236,13,236,127,0],[237,13,237,24,0],[238,13,238,59,0],[240,13,240,26,0],[241,9,241,10,0],[244,9,244,10,0],[245,13,245,46,0],[246,13,246,94,0],[247,13,247,75,0],[250,13,250,90,0],[251,13,251,95,0],[252,13,252,96,0],[253,13,253,93,0],[254,13,254,97,0],[255,13,255,96,0],[258,13,258,103,0],[259,13,259,101,0],[260,13,260,109,0],[261,13,261,108,0],[262,13,262,113,0],[263,13,263,108,0],[264,13,264,109,0],[265,13,265,116,0],[266,13,266,114,0],[267,13,267,108,0],[268,13,268,108,0],[269,13,269,110,0],[270,13,270,108,0],[271,13,271,112,0],[273,13,273,109,0],[274,13,274,108,0],[276,13,276,47,0],[277,9,277,10,0],[280,9,280,10,0],[281,13,281,44,0],[282,13,282,53,0],[283,17,283,38,0],[285,13,285,107,0],[286,17,286,83,0],[288,17,288,89,0],[290,13,290,85,0],[291,13,291,82,0],[292,13,292,79,0],[293,13,293,79,0],[295,13,295,44,0],[297,13,297,50,0],[298,13,298,91,0],[299,13,299,71,0],[300,13,300,62,0],[301,13,301,44,0],[303,13,303,51,0],[304,13,304,92,0],[305,13,305,72,0],[306,13,306,65,0],[307,13,307,47,0],[309,13,309,57,0],[310,13,310,98,0],[311,13,311,77,0],[312,13,312,67,0],[313,13,313,49,0],[314,9,314,10,0],[317,9,317,10,0],[318,13,318,31,0],[319,13,319,14,0],[320,17,320,51,0],[321,17,321,37,0],[322,17,322,18,0],[323,21,323,54,0],[324,21,324,49,0],[325,17,325,18,0],[326,13,326,14,0],[328,13,328,67,0],[329,13,329,14,0],[330,17,330,84,0],[331,17,331,81,0],[332,13,332,14,0],[333,13,333,117,0],[334,13,334,14,0],[335,17,335,82,0],[336,17,336,77,0],[337,13,337,14,0],[339,13,339,73,0],[340,13,340,36,0],[341,13,341,14,0],[342,17,342,53,0],[343,17,343,54,0],[344,13,344,14,0],[346,13,346,67,0],[347,13,347,33,0],[348,13,348,14,0],[349,17,349,50,0],[350,17,350,80,0],[351,13,351,14,0],[353,13,353,65,0],[354,17,354,114,0],[356,13,356,65,0],[357,17,357,114,0],[358,9,358,10,0],[361,9,361,10,0],[362,13,362,50,0],[363,13,363,31,0],[364,13,364,33,0],[365,9,365,10,0],[368,9,368,10,0],[369,13,369,50,0],[370,13,370,31,0],[371,13,371,33,0],[372,9,372,10,0],[375,9,375,10,0],[376,13,376,48,0],[377,13,377,52,0],[379,13,379,24,0],[380,13,380,31,0],[381,13,381,33,0],[382,9,382,10,0],[385,9,385,10,0],[386,13,386,48,0],[387,13,387,52,0],[389,13,389,24,0],[390,13,390,31,0],[391,13,391,33,0],[392,9,392,10,0],[395,9,395,10,0],[396,13,396,28,0],[397,17,397,81,0],[399,13,399,14,0],[400,17,400,93,0],[402,17,402,24,0],[402,26,402,41,0],[402,42,402,44,0],[402,45,402,74,0],[403,17,403,18,0],[404,21,404,58,0],[405,25,405,102,0],[406,17,406,18,0],[409,17,409,84,0],[410,13,410,14,0],[412,9,412,10,0],[415,9,415,10,0],[416,13,416,42,0],[417,13,417,44,0],[418,13,418,45,0],[419,13,419,43,0],[420,13,420,43,0],[421,13,421,33,0],[422,13,422,40,0],[423,13,423,70,0],[424,13,424,20,0],[424,22,424,36,0],[424,37,424,39,0],[424,40,424,45,0],[425,13,425,14,0],[426,17,426,53,0],[427,17,427,18,0],[428,21,428,59,0],[429,21,429,78,0],[430,21,430,50,0],[431,21,431,52,0],[432,21,432,53,0],[433,21,433,51,0],[434,21,434,51,0],[435,21,435,41,0],[436,17,436,18,0],[437,13,437,14,0],[439,13,439,38,0],[440,13,440,45,0],[441,13,441,55,0],[443,13,443,20,0],[443,22,443,27,0],[443,28,443,30,0],[443,31,443,45,0],[444,17,444,46,0],[445,9,445,10,0],[448,9,448,10,0],[449,13,449,56,0],[450,9,450,10,0],[453,9,453,10,0],[454,13,454,53,0],[455,13,455,14,0],[456,17,456,59,0],[457,17,457,56,0],[458,17,458,56,0],[459,17,459,56,0],[460,17,460,35,0],[461,17,461,18,0],[462,21,462,51,0],[463,21,463,41,0],[464,21,464,22,0],[465,25,465,64,0],[466,21,466,22,0],[467,17,467,18,0],[468,17,468,58,0],[469,17,469,56,0],[470,13,470,14,0],[472,13,472,14,0],[473,17,473,59,0],[474,17,474,56,0],[475,17,475,56,0],[476,17,476,56,0],[477,17,477,35,0],[478,17,478,18,0],[479,21,479,55,0],[480,21,480,41,0],[481,21,481,22,0],[482,25,482,64,0],[483,21,483,22,0],[484,17,484,18,0],[485,17,485,58,0],[486,17,486,59,0],[487,21,487,60,0],[488,13,488,14,0],[492,13,492,53,0],[493,13,493,14,0],[494,17,494,56,0],[495,17,495,58,0],[496,13,496,14,0],[497,9,497,10,0],[500,9,500,10,0],[501,13,501,42,0],[502,13,502,75,0],[503,13,503,69,0],[504,13,505,25,0],[506,13,506,28,0],[507,13,507,51,0],[508,9,508,10,0],[511,9,511,10,0],[512,13,514,55,0],[515,9,515,10,0],[518,9,518,10,0],[519,13,519,69,0],[520,13,520,58,0],[521,13,521,65,0],[522,13,522,69,0],[524,13,524,59,0],[525,13,525,139,0],[527,13,527,59,0],[529,13,530,77,0],[531,13,531,103,0],[532,13,532,31,0],[534,13,534,105,0],[535,13,535,14,0],[536,17,536,113,0],[537,17,537,110,0],[538,13,538,14,0],[540,13,540,24,0],[542,13,542,53,0],[543,13,543,14,0],[544,17,544,44,0],[545,13,545,14,0],[546,9,546,10,0],[549,9,549,10,0],[550,13,550,57,0],[553,13,553,28,0],[554,13,554,14,0],[555,17,555,43,0],[556,13,556,14,0],[558,13,558,14,0],[559,17,559,59,0],[560,21,560,44,0],[562,17,562,35,0],[563,13,563,14,0],[565,13,565,67,0],[567,13,567,49,0],[568,13,568,52,0],[569,13,569,29,0],[570,13,570,14,0],[571,17,571,59,0],[572,17,572,80,0],[573,17,573,77,0],[574,13,574,14,0],[576,13,576,14,0],[577,17,577,59,0],[578,17,578,80,0],[579,17,579,77,0],[580,17,580,37,0],[580,38,580,87,0],[581,17,581,37,0],[581,38,581,106,0],[582,17,582,37,0],[582,38,582,91,0],[583,17,583,37,0],[583,38,583,74,0],[584,13,584,14,0],[586,13,586,51,0],[587,9,587,10,0],[590,9,590,10,0],[591,13,591,56,0],[593,13,593,45,0],[594,13,594,20,0],[594,22,594,30,0],[594,31,594,33,0],[594,34,594,39,0],[595,13,595,14,0],[596,17,596,50,0],[597,17,597,39,0],[598,21,598,93,0],[599,13,599,14,0],[601,13,601,31,0],[602,9,602,10,0],[605,9,605,10,0],[607,13,607,53,0],[608,13,615,30,0],[617,13,617,33,0],[618,17,618,24,0],[620,13,620,150,0],[622,13,622,108,0],[624,13,624,53,0],[625,13,625,41,0],[627,13,627,29,0],[628,13,628,14,0],[630,17,630,46,0],[631,17,631,51,0],[632,17,632,53,0],[633,17,633,53,0],[635,17,635,176,0],[636,17,636,216,0],[637,17,637,197,0],[638,17,638,217,0],[639,17,639,237,0],[640,17,640,231,0],[641,13,641,14,0],[643,13,643,14,0],[644,17,644,159,0],[645,17,645,205,0],[646,13,646,14,0],[647,13,647,61,0],[648,13,648,33,0],[649,9,649,10,0],[652,9,652,10,0],[654,13,654,31,0],[655,13,655,61,0],[656,13,656,33,0],[657,9,657,10,0],[660,9,660,10,0],[661,13,661,36,0],[663,13,663,33,0],[664,17,664,24,0],[665,13,665,55,0],[666,17,666,24,0],[668,13,668,79,0],[669,13,669,99,0],[671,13,671,34,0],[673,13,673,33,0],[676,21,676,43,0],[677,21,677,27,0],[680,21,680,43,0],[681,21,681,27,0],[684,21,684,45,0],[685,21,685,27,0],[688,21,688,53,0],[689,21,689,27,0],[692,21,692,40,0],[693,21,693,27,0],[696,21,696,44,0],[697,21,697,27,0],[700,21,700,42,0],[701,21,701,27,0],[704,13,704,61,0],[705,13,705,33,0],[707,13,707,31,0],[708,9,708,10,0],[711,9,711,10,0],[713,13,713,29,0],[716,21,716,45,0],[717,21,717,27,0],[720,21,720,51,0],[721,21,721,27,0],[724,21,724,57,0],[725,21,725,27,0],[728,13,728,29,0],[729,9,729,10,0],[732,9,732,10,0],[733,13,733,39,0],[736,13,736,51,0],[737,13,737,14,0],[739,17,739,61,0],[740,17,740,57,0],[741,17,741,53,0],[742,17,742,77,0],[744,17,744,18,0],[745,21,745,74,0],[746,21,746,61,0],[747,21,747,62,0],[748,21,748,39,0],[749,21,749,41,0],[750,17,750,18,0],[751,17,751,39,0],[752,17,752,18,0],[753,21,753,74,0],[754,17,754,18,0],[755,13,755,14,0],[757,13,757,24,0],[758,9,758,10,0],[761,9,761,10,0],[764,13,764,43,0],[765,13,765,58,0],[766,13,766,24,0],[767,9,767,10,0],[770,9,770,10,0],[772,13,772,38,0],[772,39,772,46,0],[774,13,774,69,0],[775,13,775,72,0],[776,17,776,128,0],[777,13,777,102,0],[779,13,779,98,0],[780,13,780,100,0],[781,13,781,95,0],[782,13,782,58,0],[783,9,783,10,0],[786,9,786,10,0],[787,13,787,44,0],[788,13,788,34,0],[789,13,789,51,0],[790,13,790,43,0],[791,13,791,53,0],[792,9,792,10,0],[795,9,795,10,0],[796,13,796,37,0],[798,13,798,20,0],[798,22,798,30,0],[798,31,798,33,0],[798,34,798,44,0],[799,13,799,14,0],[800,17,800,46,0],[802,17,802,60,0],[802,61,802,70,0],[804,17,804,67,0],[809,17,809,76,0],[810,17,810,18,0],[814,21,814,45,0],[815,21,815,22,0],[816,25,816,59,0],[817,25,818,25,0],[818,25,818,26,0],[818,26,819,29,0],[819,29,819,50,0],[819,50,820,33,0],[820,33,820,48,0],[820,48,821,25,0],[821,25,821,26,0],[821,26,821,28,0],[817,25,821,28,0],[822,25,822,47,0],[823,25,823,26,0],[824,29,825,29,0],[825,29,825,30,0],[825,30,826,33,0],[826,33,826,54,0],[826,54,827,37,0],[827,37,827,52,0],[827,52,828,29,0],[828,29,828,30,0],[828,30,828,32,0],[824,29,828,32,0],[829,25,829,26,0],[832,25,832,68,0],[833,29,833,111,0],[834,21,834,22,0],[838,21,838,107,0],[839,21,839,22,0],[840,25,840,45,0],[841,25,841,26,0],[845,29,845,58,0],[846,33,846,63,0],[848,33,848,67,0],[851,29,851,36,0],[851,38,851,43,0],[851,44,851,46,0],[851,47,851,60,0],[853,33,853,34,0],[854,37,854,75,0],[855,33,855,34,0],[856,33,856,38,0],[857,33,857,34,0],[859,33,859,34,0],[860,29,860,36,0],[860,38,860,43,0],[860,44,860,46,0],[860,47,860,64,0],[862,33,862,34,0],[863,37,863,87,0],[864,33,864,34,0],[865,33,865,38,0],[866,33,866,34,0],[868,33,868,34,0],[871,29,871,94,0],[872,29,872,43,0],[873,29,873,30,0],[874,33,874,59,0],[875,33,875,69,0],[876,33,876,67,0],[877,33,877,48,0],[878,29,878,30,0],[879,25,879,26,0],[880,21,880,22,0],[882,21,882,51,0],[883,21,883,35,0],[884,25,884,81,0],[886,21,886,22,0],[887,25,887,67,0],[888,25,888,39,0],[889,29,889,94,0],[890,21,890,22,0],[891,17,891,18,0],[892,13,892,14,0],[894,13,894,34,0],[895,17,895,68,0],[897,13,897,33,0],[898,9,898,10,0],[901,9,901,10,0],[902,13,902,55,0],[903,13,903,14,0],[904,17,904,86,0],[905,17,905,76,0],[907,17,907,37,0],[910,13,910,47,0],[911,13,911,14,0],[912,17,912,47,0],[913,21,913,33,0],[915,17,915,30,0],[918,13,918,45,0],[919,13,919,14,0],[920,17,920,42,0],[923,13,923,26,0],[924,9,924,10,0],[927,9,927,10,0],[928,13,928,48,0],[929,13,929,20,0],[929,22,929,32,0],[929,33,929,35,0],[929,36,929,50,0],[930,13,930,14,0],[932,17,932,83,0],[933,17,933,34,0],[934,17,934,18,0],[935,21,935,49,0],[936,21,936,38,0],[937,21,937,22,0],[939,25,939,73,0],[940,25,940,26,0],[941,29,941,68,0],[942,29,942,51,0],[943,33,943,107,0],[944,25,944,26,0],[946,29,946,58,0],[947,21,947,22,0],[949,25,949,54,0],[951,21,951,42,0],[952,17,952,18,0],[953,13,953,14,0],[955,13,955,53,0],[956,13,956,67,0],[957,9,957,10,0],[960,9,960,10,0],[961,13,961,89,0],[962,13,962,30,0],[963,13,963,14,0],[964,17,964,58,0],[966,13,966,33,0],[967,9,967,10,0],[970,9,970,10,0],[971,13,971,106,0],[972,13,972,84,0],[973,13,973,74,0],[974,17,974,65,0],[976,13,976,37,0],[977,13,977,14,0],[978,17,978,58,0],[979,17,979,18,0],[981,21,981,79,0],[982,21,982,63,0],[983,17,983,18,0],[984,22,984,46,0],[985,17,985,18,0],[986,21,986,71,0],[987,21,987,22,0],[988,25,988,83,0],[989,25,989,67,0],[990,21,990,22,0],[992,21,992,22,0],[993,25,993,90,0],[994,29,994,93,0],[996,25,996,109,0],[997,25,997,39,0],[998,25,998,26,0],[1000,29,1000,112,0],[1001,29,1001,30,0],[1002,33,1002,67,0],[1003,33,1003,106,0],[1004,33,1004,50,0],[1005,33,1005,34,0],[1007,37,1007,54,0],[1007,55,1007,69,0],[1009,37,1009,80,0],[1009,80,1009,108,0],[1009,108,1009,110,0],[1009,37,1009,110,0],[1010,37,1010,44,0],[1010,46,1010,51,0],[1010,52,1010,54,0],[1010,55,1010,99,0],[1011,37,1011,38,0],[1012,41,1012,86,0],[1013,41,1013,81,0],[1014,41,1014,85,0],[1015,37,1015,38,0],[1016,33,1016,34,0],[1017,29,1017,30,0],[1019,29,1019,64,0],[1020,29,1020,30,0],[1022,33,1022,91,0],[1023,33,1023,96,0],[1024,29,1024,30,0],[1026,33,1026,69,0],[1027,25,1027,26,0],[1029,29,1029,83,0],[1030,21,1030,22,0],[1031,17,1031,18,0],[1033,21,1033,97,0],[1034,13,1034,14,0],[1036,13,1036,14,0],[1038,17,1038,44,0],[1039,21,1039,52,0],[1041,17,1041,37,0],[1042,21,1042,41,0],[1045,17,1045,131,0],[1046,21,1046,92,0],[1048,17,1048,65,0],[1049,17,1049,49,0],[1050,13,1050,14,0],[1052,13,1052,33,0],[1053,9,1053,10,0],[1056,9,1056,10,0],[1057,13,1057,74,0],[1058,13,1058,33,0],[1059,13,1059,14,0],[1060,17,1060,64,0],[1064,17,1064,71,0],[1065,17,1065,18,0],[1067,21,1067,42,0],[1068,21,1068,22,0],[1069,25,1069,95,0],[1070,25,1070,39,0],[1071,25,1071,26,0],[1072,29,1072,72,0],[1072,72,1072,100,0],[1072,100,1072,102,0],[1072,29,1072,102,0],[1073,29,1073,36,0],[1073,38,1073,43,0],[1073,44,1073,46,0],[1073,47,1073,91,0],[1074,29,1074,30,0],[1075,33,1075,72,0],[1076,37,1076,74,0],[1077,29,1077,30,0],[1078,25,1078,26,0],[1079,21,1079,22,0],[1081,21,1081,53,0],[1082,17,1082,18,0],[1083,13,1083,14,0],[1085,13,1085,14,0],[1086,17,1086,82,0],[1087,17,1087,51,0],[1088,17,1088,51,0],[1089,13,1089,14,0],[1090,9,1090,10,0],[1093,9,1093,10,0],[1094,13,1094,47,0],[1095,13,1095,37,0],[1096,13,1096,14,0],[1097,17,1097,54,0],[1098,21,1098,37,0],[1099,13,1099,14,0],[1100,18,1100,42,0],[1101,13,1101,14,0],[1102,17,1102,54,0],[1103,21,1103,37,0],[1104,13,1104,14,0],[1105,9,1105,10,0],[1108,9,1108,10,0],[1109,13,1109,30,0],[1110,13,1112,70,0],[1113,9,1113,10,0],[1116,9,1116,10,0],[1117,13,1117,30,0],[1118,13,1118,90,0],[1119,9,1119,10,0],[1122,9,1122,10,0],[1123,13,1123,69,0],[1124,17,1124,69,0],[1126,13,1126,91,0],[1127,13,1127,54,0],[1128,13,1128,95,0],[1129,13,1129,58,0],[1130,9,1130,10,0],[1133,9,1133,10,0],[1134,13,1134,55,0],[1135,13,1135,14,0],[1136,17,1136,46,0],[1138,17,1138,69,0],[1139,17,1141,21,0],[1141,21,1141,22,0],[1141,22,1142,25,0],[1142,25,1142,68,0],[1142,68,1143,21,0],[1143,21,1143,22,0],[1143,22,1144,23,0],[1139,17,1144,23,0],[1146,17,1146,58,0],[1147,21,1147,76,0],[1149,17,1149,86,0],[1150,17,1150,88,0],[1152,17,1152,62,0],[1153,17,1153,65,0],[1154,17,1155,140,0],[1156,17,1156,39,0],[1157,13,1157,14,0],[1159,13,1159,14,0],[1160,17,1160,35,0],[1161,17,1161,69,0],[1162,17,1162,18,0],[1163,21,1163,69,0],[1164,21,1166,40,0],[1167,21,1167,38,0],[1168,21,1168,45,0],[1169,17,1169,18,0],[1171,17,1171,18,0],[1172,21,1172,64,0],[1173,17,1173,18,0],[1174,13,1174,14,0],[1175,9,1175,10,0],[1178,9,1178,10,0],[1179,13,1179,72,0],[1180,13,1180,113,0],[1181,13,1181,65,0],[1182,13,1182,69,0],[1183,13,1183,99,0],[1184,13,1184,52,0],[1185,13,1185,14,0],[1186,17,1186,73,0],[1187,17,1187,80,0],[1188,17,1188,75,0],[1189,17,1189,63,0],[1190,17,1190,73,0],[1191,17,1191,65,0],[1192,17,1192,69,0],[1193,17,1193,71,0],[1194,13,1194,14,0],[1196,13,1196,14,0],[1197,17,1197,74,0],[1198,17,1198,81,0],[1199,17,1199,76,0],[1200,13,1200,14,0],[1201,13,1201,97,0],[1202,13,1202,84,0],[1203,13,1203,82,0],[1204,13,1204,65,0],[1205,13,1205,61,0],[1206,13,1206,14,0],[1207,17,1207,63,0],[1208,13,1208,14,0],[1209,9,1209,10,0],[1212,9,1212,10,0],[1213,13,1213,72,0],[1215,13,1215,28,0],[1216,17,1216,57,0],[1218,13,1218,14,0],[1219,17,1219,93,0],[1221,17,1221,24,0],[1221,26,1221,41,0],[1221,42,1221,44,0],[1221,45,1221,74,0],[1222,17,1222,18,0],[1223,21,1223,58,0],[1224,25,1224,67,0],[1225,17,1225,18,0],[1228,17,1228,57,0],[1229,13,1229,14,0],[1231,13,1231,97,0],[1232,13,1232,14,0],[1233,17,1233,56,0],[1236,13,1236,14,0],[1237,17,1237,101,0],[1239,17,1239,68,0],[1240,21,1240,40,0],[1242,17,1242,18,0],[1244,21,1244,36,0],[1245,25,1245,65,0],[1247,25,1247,64,0],[1250,9,1250,10,0],[1256,9,1256,10,0],[1257,13,1257,84,0],[1258,13,1258,28,0],[1259,9,1259,10,0],[1263,9,1263,10,0],[1264,13,1264,41,0],[1265,13,1265,42,0],[1267,13,1267,74,0],[1269,13,1269,30,0],[1270,13,1270,14,0],[1271,17,1271,37,0],[1272,17,1272,52,0],[1273,17,1273,89,0],[1275,17,1275,28,0],[1278,13,1278,24,0],[1279,9,1279,10,0],[1283,9,1283,10,0],[1284,13,1284,42,0],[1286,13,1296,15,0],[1298,13,1300,50,0],[1301,13,1301,51,0],[1302,13,1302,55,0],[1304,13,1304,20,0],[1304,22,1304,32,0],[1304,33,1304,35,0],[1304,36,1304,44,0],[1305,13,1305,14,0],[1306,17,1306,42,0],[1307,17,1307,18,0],[1308,21,1308,51,0],[1309,21,1309,43,0],[1310,21,1310,22,0],[1311,25,1311,73,0],[1312,25,1312,107,0],[1313,21,1313,22,0],[1314,17,1314,18,0],[1316,21,1316,50,0],[1317,13,1317,14,0],[1319,13,1319,81,0],[1321,13,1321,29,0],[1322,9,1322,10,0],[1325,9,1325,10,0],[1327,13,1327,80,0],[1328,13,1328,20,0],[1328,22,1328,28,0],[1328,29,1328,31,0],[1328,32,1328,45,0],[1329,13,1329,14,0],[1330,17,1338,19,0],[1340,17,1340,42,0],[1341,17,1341,64,0],[1342,13,1342,14,0],[1344,13,1344,20,0],[1344,22,1344,27,0],[1344,28,1344,30,0],[1344,31,1344,46,0],[1345,13,1345,14,0],[1346,17,1352,19,0],[1354,17,1354,42,0],[1355,17,1355,63,0],[1356,13,1356,14,0],[1357,9,1357,10,0],[1360,9,1360,10,0],[1361,13,1361,48,0],[1362,13,1362,37,0],[1362,38,1362,65,0],[1363,13,1363,40,0],[1364,13,1364,30,0],[1364,31,1364,51,0],[1365,13,1365,40,0],[1366,13,1366,33,0],[1366,34,1366,57,0],[1367,13,1367,45,0],[1368,13,1368,31,0],[1368,32,1368,57,0],[1369,13,1369,39,0],[1370,13,1370,30,0],[1370,31,1370,55,0],[1372,13,1372,27,0],[1373,9,1373,10,0],[1376,9,1376,10,0],[1377,13,1377,39,0],[1378,13,1378,32,0],[1379,17,1379,57,0],[1380,13,1380,70,0],[1381,17,1381,31,0],[1382,13,1382,26,0],[1383,17,1383,31,0],[1384,13,1384,29,0],[1385,17,1385,33,0],[1387,13,1387,27,0],[1388,9,1388,10,0],[1392,9,1392,10,0],[1393,13,1393,109,0],[1394,13,1394,111,0],[1396,13,1396,27,0],[1397,9,1397,10,0],[1401,9,1401,10,0],[1402,13,1402,42,0],[1404,13,1408,15,0],[1410,13,1410,104,0],[1411,13,1411,60,0],[1412,13,1412,25,0],[1413,9,1413,10,0],[1417,9,1417,10,0],[1418,13,1418,42,0],[1420,13,1420,96,0],[1421,13,1421,104,0],[1422,13,1422,60,0],[1424,13,1424,25,0],[1425,9,1425,10,0],[1429,9,1429,10,0],[1430,13,1430,53,0],[1431,9,1431,10,0],[1435,34,1435,38,0],[1435,39,1435,43,0],[1440,9,1440,10,0],[1441,13,1441,84,0],[1442,13,1442,71,0],[1443,13,1443,65,0],[1444,13,1444,34,0],[1445,13,1445,14,0],[1446,17,1447,37,0],[1447,37,1450,31,0],[1450,31,1450,32,0],[1446,17,1450,32,0],[1452,17,1452,31,0],[1455,13,1455,25,0],[1456,9,1456,10,0],[1460,9,1460,10,0],[1461,13,1461,46,0],[1462,9,1462,10,0],[1466,9,1466,10,0],[1467,13,1467,42,0],[1469,13,1469,50,0],[1470,13,1471,13,0],[1471,13,1471,14,0],[1471,14,1472,17,0],[1472,17,1472,37,0],[1472,37,1473,17,0],[1473,17,1473,31,0],[1473,31,1474,17,0],[1474,17,1474,18,0],[1474,18,1475,21,0],[1475,21,1479,69,0],[1479,69,1479,110,0],[1479,110,1480,24,0],[1475,21,1480,24,0],[1480,24,1481,17,0],[1481,17,1481,18,0],[1481,18,1482,13,0],[1482,13,1482,14,0],[1482,14,1482,16,0],[1470,13,1482,16,0],[1484,13,1484,28,0],[1485,9,1485,10,0]]);
    </script>
  </body>
</html>