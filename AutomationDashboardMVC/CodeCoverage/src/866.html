<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Masterworks\MasterworksRelease\.Net\Platform\Business Layer\Workflow\WorkflowMediator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.CodeDom.Compiler;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization.Formatters.Binary;
using System.Text.RegularExpressions;
using System.Web;
using System.Xml;
using System.Xml.Serialization;
using Aurigo.AMP3.Common;
using Aurigo.AMP3.DataAccess.Core;
using Aurigo.AMP3.ProjectBL;
using Aurigo.AMP3.UserManagementBL;
using Aurigo.Brix.Core.WebUiHelper;
using Aurigo.Brix.DataAccess.Core;
using Aurigo.Brix.Platform.BusinessLayer.DataAccessHelper;
using Aurigo.Brix.Platform.CoreUtilities.Utility;
using Aurigo.Brix.WorkflowCommon;
using Infragistics.WebUI.UltraWebGrid;
using Microsoft.CSharp;
using Aurigo.Brix.Platform.BusinessLayer.Utility;

namespace Aurigo.Brix.WorkflowMediators
{
    [Serializable]
    public class WFitem : WorkflowItem
    {
        private readonly UltraWebGrid InstanceGrid;
        private readonly WorkflowFactory f;
        private DataTable InstanceTable;

        public WFitem(int instanceId, string moduleId, UltraWebGrid InstanceGrid, DataTable InstanceTable)
            : base(instanceId, moduleId)
        {
            this.InstanceGrid = InstanceGrid;
            this.InstanceTable = InstanceTable;
            f = new WorkflowFactory(InstanceGrid, InstanceTable);
            Set(GetWorkflowById(instanceId, ModuleID));
        }

        public Dictionary&lt;int, int&gt; ProjectUsers { get; set; }

        private void Set(WorkflowItem item)
        {
            if (item == null)
                return;
            base.Id = item.Id;
            base.WorkflowId = item.WorkflowId;
            base.State = item.State;
            base.ModuleID = item.ModuleID;
        }

        //approves workflow
        public string ApproveWorkflowItem(string userId, string roleName, string state, string notes)
        {
            WorkflowItem selected = GetUpdatedWorkflow();
            if (selected == null)
            {
                f.ValidateUsers(Id, ModuleID, state);
                UpdateWorkflow(WFItemAction.Create);
            }
            //if wf alreday complete then return the state.
            if (State.Equals(WFItemStatus.Completed.ToString2()))
                return State;
            Workflow updatedWorkflow;
            if (f.IsWorkflow(InstanceID, userId, roleName, Id, ModuleID, out updatedWorkflow, notes))
            {
                f.CUDWorkflowUsers(updatedWorkflow);
                EmailNotification(updatedWorkflow, ModuleID, ApprovalAction.Approve);
            }
            if (f.IsWorkflowComplete(Id, InstanceID, ModuleID, InstanceGrid))
                UpdateWorkflow(WFItemAction.Approve);
            return State;
        }

        //unapproves workflow
        public string UnapproveWorkflowItem(string userId, string roleName, string state, string notes)
        {
            WorkflowItem selected = GetUpdatedWorkflow();
            if (selected == null)
                return string.Empty;
            Workflow updatedWorkflow;
            if (f.IsWorkflowUnapprove(InstanceID, userId, roleName, Id, ModuleID, out updatedWorkflow, notes))
            {
                f.CUDWorkflowUsers(updatedWorkflow);
                EmailNotification(updatedWorkflow, ModuleID, ApprovalAction.ReOpen);
                //if unapprove when the status is completed, unapprove the record
                if (selected.State == WFItemStatus.Completed.ToString2())
                    UpdateWorkflow(WFItemAction.Reject);
            }
            return State;
        }

        //rejects workflow
        public string RejectWorkflowItem(string userId, string roleName, string state, string notes)
        {
            WorkflowItem selected = GetUpdatedWorkflow();
            if (selected == null)
                UpdateWorkflow(WFItemAction.Create);
            Workflow updatedWorkflow;
            WFApproval wfa = f.IsWorkflowReject(InstanceID, userId, roleName, Id, ModuleID, out updatedWorkflow, notes);
            if (!String.IsNullOrEmpty(wfa.UserName) || !String.IsNullOrEmpty(wfa.RoleName))
            {
                f.CUDWorkflowUsers(updatedWorkflow);
                EmailNotification(updatedWorkflow, ModuleID, ApprovalAction.Reject);
                if (f.GetCompletedCount(true, Id, state) == 0)
                    UpdateWorkflow(WFItemAction.Reject);
            }
            return State;
        }

        //updates workflow item with updated state
        private WorkflowItem GetUpdatedWorkflow()
        {
            WorkflowItem selected = GetWorkflowById(InstanceID, ModuleID);
            Set(selected);
            return selected;
        }

        private void UpdateWorkflow(WFItemAction wa)
        {
            if (wa.Equals(WFItemAction.Create))
            {
                State = WFItemStatus.Approval.ToString2();
                WorkflowId = Guid.NewGuid();
                Insert();
            }
            else if (wa.Equals(WFItemAction.Approve))
            {
                State = WFItemStatus.Completed.ToString2();
                Update();
            }
            else if (wa.Equals(WFItemAction.Reject))
            {
                State = WFItemStatus.Approval.ToString2();
                Update();
            }
        }

        /// &lt;summary&gt;
        /// Send email to the appropriate user of interest.
        /// if user is of user type, send email to the user id
        /// if user is of role type, send email to project users with that role (PENDING)
        /// send email with the exact url of the listpage(PENDING)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;wfUsers&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;ModuleId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;AppAction&quot;&gt;&lt;/param&gt;
        internal void EmailNotification(Workflow wfUsers, string ModuleId, ApprovalAction AppAction)
        {
            try
            {
                WFApproval lastApproveUser = null;
                foreach (WFApproval wfa in wfUsers.Approvals)
                {
                    if (!f.IsConditionSatisified(wfUsers, InstanceID, wfa, false) || wfa.Completed)
                    {
                        lastApproveUser = wfa;
                        continue;
                    }

                    if (!String.IsNullOrEmpty(wfa.UserName))
                    {
                        Hashtable user = UserManager.Instance.GetUserHT(wfa.UserName);
                        if (user != null &amp;&amp; user.Count &gt; 0)
                        {
                            Mailer.SendEmail(user[&quot;Email&quot;].ToString(),
                                &quot;Approval Reminder from &quot; + AMP3ApplicationSettings.Instance.AppName + &quot;!&quot;,
                                ModuleId + &quot; record is waiting for your approval. Please log on to &quot; +
                                AMP3ApplicationSettings.Instance.AppName + &quot; and approve the item.&quot;);
                            // check for additional mail, get the xml model instance and the column  in the grid.
                            if (lastApproveUser != null &amp;&amp; !string.IsNullOrEmpty(lastApproveUser.AdditionalEmailColumns))
                                SendAdditonalMails(lastApproveUser);
                        }
                    }
                    else if (!String.IsNullOrEmpty(wfa.RoleName))
                    {
                        int roleId = UserManager.Instance.GetUsersRoleId(wfa.RoleName);
                        var dtProjectUsers =
                            ProjectManager.Instance.GetProjectUsers(Convert.ToInt32(HttpContext.Current.Request[&quot;PID&quot;]));
                        foreach (DataRow row in dtProjectUsers.Rows)
                        {
                            if (row[&quot;RoleID&quot;].ToInt32_2() != roleId)
                                continue;
                            Hashtable user = UserManager.Instance.GetUserHT(row[&quot;UserID&quot;].ToInt32_2());
                            if (user != null &amp;&amp; user.Count &gt; 0)
                            {
                                Mailer.SendEmail(user[&quot;Email&quot;].ToString(),
                                    &quot;Approval Reminder from &quot; + AMP3ApplicationSettings.Instance.AppName +
                                    &quot;!&quot;,
                                    ModuleId + &quot; record is waiting for your approval. Please log on to &quot; +
                                    AMP3ApplicationSettings.Instance.AppName + &quot; and approve the item.&quot;);

                                if (lastApproveUser != null &amp;&amp;
                                    !string.IsNullOrEmpty(lastApproveUser.AdditionalEmailColumns))
                                    SendAdditonalMails(lastApproveUser);
                            }
                        }
                    }
                    break;
                }
            }
            catch
            {
            }
        }

        private void SendAdditonalMails(WFApproval lastApproveUser)
        {
            string[] mailIDs = lastApproveUser.AdditionalEmailColumns.Split(new[] { &#39;;&#39; });

            foreach (string str in mailIDs)
                try
                {
                    if (InstanceGrid.DisplayLayout.SelectedRows[0].Cells.FromKey(str).Value.ToString().Contains(&quot;@&quot;))
                        Mailer.SendEmail(
                            InstanceGrid.DisplayLayout.SelectedRows[0].Cells.FromKey(str).Value.ToString(),
                            &quot;Request for Information&quot;,
                            &quot;You have been requested to provide some information.\r\n Please log into BRIX and see RFI Module for more information.&quot;);
                }
                catch (Exception)
                {
                }
        }
    }

    [Serializable]
    public enum WFType
    {
        SequentialWorflow = 0,
        AnyOne = 1,
        All = 2
    }

    [Serializable]
    public class WorkflowFactory
    {
        private static readonly Dictionary&lt;string, Workflow&gt; workflows = new Dictionary&lt;string, Workflow&gt;();
        private readonly UltraWebGrid InstanceGrid;
        private readonly DataTable InstanceTable;
        //loads xml workflows from WORKFLW directory of the application
        static WorkflowFactory()
        {
            var dir = new DirectoryInfo(HttpContext.Current.Server.MapPath(&quot;~/Modules/WORKFLW&quot;).Replace(@&quot;/&quot;, @&quot;\&quot;));
            if (dir.Exists)
                foreach (FileInfo f in dir.GetFiles(&quot;*.xml&quot;))
                {
                    var serializer = new XmlSerializer(typeof (Workflow));
                    using (var fs = new FileStream(f.FullName, FileMode.Open, FileAccess.Read))
                    {
                        var wf = new Workflow();
                        try
                        {
                            wf = ((Workflow)serializer.Deserialize(fs));
                            workflows.Add(f.Name.Substring(0, f.Name.Length - 4), wf);
                        }
                        catch
                        {
                        }
                    }
                }
        }

        public WorkflowFactory(UltraWebGrid InstanceGrid, DataTable InstanceTable)
        {
            this.InstanceGrid = InstanceGrid;
            this.InstanceTable = InstanceTable;
        }

        //returns workflow object for a given module key
        public Workflow GetInfo(string module)
        {
            if (workflows.ContainsKey(module))
                return Workflow.CreateDeepCopy(workflows[module]);
            else
                return null;
        }

        public void ClearCompletedState(Workflow wf)
        {
            foreach (WFApproval approval in wf.Approvals)
            {
                approval.Notes = String.Empty;
                approval.Completed = false;
            }
        }

        public bool IsWorkflowDefined(string module)
        {
            return GetInfo(module) != null;
        }

        public int CUDWorkflowUsers(Workflow wfUsers)
        {
            var dic = new Dictionary&lt;string, object&gt;();
            ComponentHelper.Instance.ExecuteNonQueryWithVariableParameters(StoredProcedure.usp_WORKFLWCUDWorkflowUsers,
                dic, wfUsers.ToString2(), null);

            int ret;
            int.TryParse(dic[&quot;Output&quot;].ToString2(), out ret);
            return ret;
        }

        public int GetCompletedCount(bool completed, int wfId, string state)
        {
            var coreDb = new CoreDb();
            if (!string.IsNullOrEmpty(state))
                return
                    (coreDb.WorkflowUser.Where(
                        w =&gt; w.Completed == completed &amp;&amp; w.WorkflowID == wfId &amp;&amp; w.State.Equals(state))).Count();
            else
                return (coreDb.WorkflowUser.Where(w =&gt; w.Completed == completed &amp;&amp; w.WorkflowID == wfId)).Count();


            //Database db = DatabaseFactory.CreateDatabase();
            //using (DbCommand command = DatabaseFactory.CreateDatabase().GetSqlStringCommand(&quot;SELECT COUNT(*) FROM WorkflowUsers WHERE WorkflowID = @WorkflowID AND Completed = @Completed AND (@State IS NULL OR State = @State)&quot;))
            //{
            //    db.AddInParameter(command, &quot;Completed&quot;, DbType.Boolean, completed);
            //    db.AddInParameter(command, &quot;WorkflowID&quot;, DbType.Int32, wfId);
            //    db.AddInParameter(command, &quot;State&quot;, DbType.String, DBNull.Value);
            //    if (!string.IsNullOrEmpty(state))
            //        db.SetParameterValue(command, &quot;State&quot;, state);
            //    return Convert.ToInt32(db.ExecuteScalar(command));
            //}
        }

        //checks if the given user can approve
        public bool IsWorkflow(int instanceId, string userId, string roleName, int wfId, string module, out Workflow wf,
            string notes)
        {
            bool isWF = false;
            wf = GetWorkflowUsersInstance(wfId, module, &quot;&quot;);
            foreach (WFApproval user in wf.Approvals)
            {
                //if its a power user and if he is present in the workfow
                //and if its its not his stage.
                if ((!IsConditionSatisified(wf, instanceId, user, false) ||
                     (IsConditionSatisified(wf, instanceId, user, false) &amp;&amp; user.Completed)
                    ) &amp;&amp; roleName.ToUpper2().Equals(&quot;ADMINISTRATOR&quot;))
                    continue;

                //if not the current user and condition fails, ignore the user
                if (!IsConditionSatisified(wf, instanceId, user, false)
                    &amp;&amp; (String.IsNullOrEmpty(user.UserName) || userId.ToUpper2() != user.UserName.ToUpper2())
                    &amp;&amp; (String.IsNullOrEmpty(user.RoleName) || roleName.ToUpper2() != user.RoleName.ToUpper2()))
                    continue;

                //if its the current WORKFLOW user and not is not already approved. and valid case or if it is administrator
                if (!user.Completed
                    &amp;&amp; (((String.IsNullOrEmpty(user.UserName) || userId.ToUpper() == user.UserName.ToUpper())
                         &amp;&amp; (String.IsNullOrEmpty(user.RoleName) || roleName.ToUpper() == user.RoleName.ToUpper()))
                        || roleName.ToUpper().Equals(&quot;ADMINISTRATOR&quot;)
                        )
                    )
                {
                    //if (!roleName.ToUpper2().Equals(&quot;ADMINISTRATOR&quot;)) -- not there
                    IsConditionSatisified(wf, instanceId, user, true);
                    user.Completed = true;
                    user.Action = ApprovalAction.Approve;
                    user.Notes = notes;
                    user.AdminApproval =
                        !((string.IsNullOrEmpty(user.UserName) || userId.ToUpper() == user.UserName.ToUpper())
                          &amp;&amp; (string.IsNullOrEmpty(user.RoleName) || roleName.ToUpper() == user.RoleName.ToUpper()));
                    isWF = true;
                    break;
                }
                else if (user.Completed
                         &amp;&amp; (string.IsNullOrEmpty(user.UserName) || userId.ToUpper2() == user.UserName.ToUpper2())
                         &amp;&amp; (string.IsNullOrEmpty(user.RoleName) || roleName.ToUpper2() == user.RoleName.ToUpper2()))
                {
                    throw new Exception(&quot;User already approved the selected record.&quot;);
                }
                else if (!user.Completed
                         &amp;&amp; !((string.IsNullOrEmpty(user.UserName) || userId.ToUpper2() == user.UserName.ToUpper2())
                              &amp;&amp;
                              (string.IsNullOrEmpty(user.RoleName) || roleName.ToUpper2() == user.RoleName.ToUpper2())))
                {
                    throw new Exception(&quot;Invalid approve.&quot;);
                }
            }
            if (!isWF)
                throw new Exception(&quot;Invalid approve.&quot;);
            else
                return isWF;
        }

        //checks if the given user can ReOpen
        public bool IsWorkflowUnapprove(int instanceId, string userId, string roleName, int wfId, string module,
            out Workflow wf, string notes)
        {
            wf = GetWorkflowUsersInstance(wfId, module, &quot;&quot;);
            for (int i = wf.Approvals.Count - 1; i &gt;= 0; i--)
            {
                WFApproval user = wf.Approvals[i];
                if (!IsConditionSatisified(wf, instanceId, user, false))
                    continue;
                if (user.Completed
                    &amp;&amp; (((string.IsNullOrEmpty(user.UserName) || userId.ToUpper() == user.UserName.ToUpper())
                         &amp;&amp; (string.IsNullOrEmpty(user.RoleName) || roleName.ToUpper() == user.RoleName.ToUpper()))
                        || roleName.ToUpper().Equals(&quot;ADMINISTRATOR&quot;)))
                {
                    user.Completed = false;
                    user.Action = ApprovalAction.ReOpen;
                    user.Notes = notes;
                    user.AdminApproval =
                        !((string.IsNullOrEmpty(user.UserName) || userId.ToUpper2() == user.UserName.ToUpper2())
                          &amp;&amp; (string.IsNullOrEmpty(user.RoleName) || roleName.ToUpper2() == user.RoleName.ToUpper2()));
                    return true;
                }
                else
                    throw new Exception(&quot;Invalid ReOpen.&quot;);
            }
            throw new Exception(&quot;Invalid ReOpen.&quot;);
        }

        //checks if the given user can reject
        public WFApproval IsWorkflowReject(int instanceId, string userId, string roleName, int wfId, string module,
            out Workflow wf, string notes)
        {
            wf = GetWorkflowUsersInstance(wfId, module, &quot;&quot;);
            WFApproval retUser = null;
            for (int i = 0; i &lt; wf.Approvals.Count; i++)
            {
                WFApproval user = wf.Approvals[i];
                if (!IsConditionSatisified(wf, instanceId, user, false))
                    continue;
                if (!user.Completed
                    &amp;&amp; (((string.IsNullOrEmpty(user.UserName) || userId.ToUpper2() == user.UserName.ToUpper2())
                         &amp;&amp; (string.IsNullOrEmpty(user.RoleName) || roleName.ToUpper2() == user.RoleName.ToUpper2()))
                        || roleName.ToUpper2().Equals(&quot;ADMINISTRATOR&quot;))
                    )
                {
                    if (retUser == null || retUser.Completed)
                    {
                        user.Action = ApprovalAction.Reject;
                        user.Notes = notes;
                        user.AdminApproval =
                            !((string.IsNullOrEmpty(user.UserName) || userId.ToUpper2() == user.UserName.ToUpper2())
                              &amp;&amp;
                              (string.IsNullOrEmpty(user.RoleName) || roleName.ToUpper2() == user.RoleName.ToUpper2()));
                        if (retUser != null) retUser.Completed = false;
                        return (retUser == null) ? user : retUser;
                    }
                    else
                        throw new Exception(&quot;Invalid reject.&quot;);
                }
                else
                {
                    retUser = user;
                }
            }
            throw new Exception(&quot;Invalid reject.&quot;);
        }

        //checks if the workflow is complete
        public bool IsWorkflowComplete(int wfId, int instanceId, string module, UltraWebGrid Grid)
        {
            Workflow wf = GetWorkflowUsersInstance(wfId, module, &quot;&quot;);
            foreach (WFApproval wfa in wf.Approvals)
            {
                if (IsConditionSatisified(wf, instanceId, wfa, false) &amp;&amp; !wfa.Completed)
                    return false;
            }
            return true;
        }

        public WFLevel GetLevel(Workflow wf, string state)
        {
            return null;
        }

        public Workflow GetWorkflowUsersInstance(int workflowId, string module, string state)
        {
            Workflow wfUsers = GetInfo(module);
            wfUsers.WorkflowID = workflowId;
            if (workflowId != 0)
            {
                var wfApprovals = new List&lt;WFApproval&gt;();

                var dic = new Dictionary&lt;string, object&gt;();

                using (
                    IDataReader reader =
                        ComponentHelper.Instance.ExecuteReader(StoredProcedure.usp_WORKFLWCUDWorkflowUsers, dic, null,
                            workflowId))
                {
                    while (reader.Read())
                    {
                        var wfa = new WFApproval();
                        wfa.UserName = reader[&quot;UserID&quot;].ToString2();
                        wfa.RoleName = reader[&quot;RoleName&quot;].ToString2();
                        wfa.Completed = reader.GetBoolean(reader.GetOrdinal(&quot;Completed&quot;));
                        wfa.Expression = reader[&quot;Expression&quot;].ToString2();
                        wfApprovals.Add(wfa);
                    }
                }
                if (wfApprovals.Count &gt; 0)
                {
                    wfUsers.Approvals.Clear();
                    wfUsers.Approvals = wfApprovals;
                }
            }

            return wfUsers;
        }

        public DataTable GetWorkflowUsersHistory(int workflowId, int instanceId, string module)
        {
            DataTable dtUsers = new BrixDataTable();
            dtUsers.Columns.AddRange(new[]
            {
                new DataColumn(&quot;State&quot;),
                new DataColumn(&quot;Order&quot;, typeof (Int32)),
                new DataColumn(&quot;User&quot;),
                new DataColumn(&quot;Role&quot;),
                new DataColumn(&quot;Completed&quot;, typeof (Boolean))
            });
            try
            {
                Workflow wfUsers = GetInfo(module);
                wfUsers.WorkflowID = workflowId;

                if (workflowId != 0)
                {
                    var wfApprovals = new List&lt;WFApproval&gt;();
                    var dic = new Dictionary&lt;string, object&gt;();
                    using (
                        IDataReader reader =
                            ComponentHelper.Instance.ExecuteReader(StoredProcedure.usp_WORKFLWCUDWorkflowUsers, dic,
                                null, workflowId))
                    {
                        while (reader.Read())
                        {
                            var wfa = new WFApproval();
                            wfa.UserName = reader[&quot;UserID&quot;].ToString2();
                            wfa.RoleName = reader[&quot;RoleName&quot;].ToString2();
                            wfa.Completed = reader.GetBoolean(reader.GetOrdinal(&quot;Completed&quot;));
                            wfa.Expression = reader[&quot;Expression&quot;].ToString2();
                            wfApprovals.Add(wfa);
                        }
                    }
                    if (wfApprovals.Count &gt; 0)
                    {
                        wfUsers.Approvals.Clear();
                        wfUsers.Approvals = wfApprovals;
                    }
                }

                int order = 0;
                foreach (WFApproval user in wfUsers.Approvals)
                {
                    if (IsConditionSatisified(wfUsers, instanceId, user, false) || user.Completed)
                        dtUsers.Rows.Add(new object[]
                        { &quot;Completed&quot;, ++order, user.UserName, user.RoleName, user.Completed });
                }
                return dtUsers;
            }
            catch
            {
                return dtUsers;
            }
        }

        public DataTable GetWorkflowHistory(int workflowId)
        {
            return
                ComponentHelper.Instance.ExecuteDataSet(StoredProcedure.usp_WORKFLWGetHistory, null, workflowId).Tables[
                    0];
        }

        private string getDelimiterExpression(expressionCondition expCondition)
        {
            return &quot;[&quot; + expCondition.ToString2() + &quot;]&quot;;
        }

        //evaluates the condtion associated with the user and return the status
        public bool IsConditionSatisified(Workflow wf, int instanceId, WFApproval user, bool showMessage)
        {
            bool status = true;
            if (!String.IsNullOrEmpty(user.Expression))
            {
                //Start of multiple conditions
                string regCondition = @&quot;[\w\W]+(\[EQ\]|\[LT\]|\[GT\])[\w\W]+&quot;;
                string regExpression = regCondition + &quot;(&quot; + @&quot;(\[AND\]|\[OR\])&quot; + regCondition + &quot;)*&quot;;
                string[] conditionList;
                var rx = new Regex(regExpression, RegexOptions.IgnoreCase);
                if (!rx.IsMatch(user.Expression))
                    throw new Exception(&quot;Invalid Expression.&quot;);

                string completeExpression = user.Expression;
                conditionList =
                    user.Expression.Split(
                        new[]
                        {
                            getDelimiterExpression(expressionCondition.AND),
                            getDelimiterExpression(expressionCondition.OR)
                        }, StringSplitOptions.RemoveEmptyEntries);
                foreach (string expression in conditionList)
                {
                    status = EvaluateExpression(expression, showMessage);
                    completeExpression = completeExpression.Replace(expression, status.ToString2());
                }

                completeExpression = completeExpression.Replace(&quot;[AND]&quot;, &quot;&amp;&amp;&quot;);
                completeExpression = completeExpression.Replace(&quot;[OR]&quot;, &quot;||&quot;);

                var myCodeProvider = new CSharpCodeProvider();
                var cp = new CompilerParameters();
                cp.GenerateExecutable = false;
                cp.GenerateInMemory = true;
                string TempModuleSource = &quot;namespace ns{&quot; +
                                          &quot;using System;&quot; +
                                          &quot;class class1{&quot; +
                                          &quot;public static bool Evaluate(){return &quot; + completeExpression.ToLower2() +
                                          &quot;;}}} &quot;; //Our actual Expression evaluator
                CompilerResults cr = myCodeProvider.CompileAssemblyFromSource(cp, TempModuleSource);
                if (cr.Errors.Count &gt; 0)
                {
                    throw new ArgumentException(&quot;Invalid Expression.&quot;);
                }
                else
                {
                    MethodInfo Methinfo = cr.CompiledAssembly.GetType(&quot;ns.class1&quot;).GetMethod(&quot;Evaluate&quot;);
                    status = (Boolean)Methinfo.Invoke(null, null);
                }

                //-End of multiple conditions
            }
            return status;
        }

        //evaluate single expression
        private bool EvaluateExpression(string expression, bool showMessage)
        {
            string field, value;
            object propValue = null;
            Type propType = null;
            bool status = false;
            string[] expressions;
            expression = expression.Trim(&#39; &#39;);
            expressionCondition expCondition = expressionCondition.NONE;
            if (expression.Contains(getDelimiterExpression(expressionCondition.EQ)))
                expCondition = expressionCondition.EQ;
            else if (expression.Contains(getDelimiterExpression(expressionCondition.LT)))
                expCondition = expressionCondition.LT;
            else if (expression.Contains(getDelimiterExpression(expressionCondition.GT)))
                expCondition = expressionCondition.GT;

            if (expCondition.Equals(expressionCondition.NONE))
                throw new Exception(&quot;Invalid condition.&quot;);
            expressions = expression.Split(new[] { getDelimiterExpression(expCondition) },
                StringSplitOptions.RemoveEmptyEntries);
            if (expressions.Length != 2)
                throw new Exception(&quot;Invalid condition.&quot;);
            field = expressions.GetValue(0).ToString2();
            value = expressions.GetValue(1).ToString2();

            try
            {
                if (InstanceGrid != null &amp;&amp; InstanceGrid.DisplayLayout.SelectedRows.Count != 0)
                {
                    UltraGridRow ugr = InstanceGrid.DisplayLayout.SelectedRows[0];
                    foreach (UltraGridCell ugc in ugr.Cells)
                    {
                        if (ugc.Column.Header.Caption.Equals(field))
                        {
                            propType = Type.GetType(ugc.Column.DataType);
                            propValue = ugc.Value;
                        }
                    }
                }
                else if (InstanceTable != null)
                {
                    foreach (DataColumn dc in InstanceTable.Columns)
                    {
                        if (GlobalizationUtility.SetResource(dc.ColumnName, false).Equals(field))
                        {
                            propType = dc.DataType;
                            if (propType.Equals(typeof (Decimal)))
                                propValue = InstanceTable.Compute(&quot;SUM(&quot; + dc.ColumnName + &quot;)&quot;, &quot;&quot;);
                        }
                    }
                }

                //evaluate the expression
                if (propType == typeof (Int32) || propType == typeof (Decimal))
                {
                    if (expressionCondition.EQ.Equals(expCondition))
                        status = (propValue.ToDecimal2() == value.ToDecimal2());
                    else if (expressionCondition.GT.Equals(expCondition))
                        status = (propValue.ToDecimal2() &gt; value.ToDecimal2());
                    else if (expressionCondition.LT.Equals(expCondition))
                        status = (propValue.ToDecimal2() &lt; value.ToDecimal2());
                }
                else if (propType == typeof (DateTime))
                {
                    var re = new Regex(&quot;^([1-9]|0[1-9]|1[012])[- /.]([1-9]|0[1-9]|[12][0-9]|3[01])[- /.][0-9]{4}$&quot;);
                    if (!re.Match(value).Success)
                        throw new Exception(&quot;Invalid date format in condition. Expected format is &#39;MM/DD/YYYY&#39;.&quot;);

                    if (expressionCondition.EQ.Equals(expCondition))
                        status = (propValue.ToUtc().Date == value.ToDateTime_MWCulture().Date);
                    else if (expressionCondition.GT.Equals(expCondition))
                        status = (propValue.ToUtc().ToDateTime_MWCulture().Date &gt; value.ToDateTime_MWCulture().Date);
                    else if (expressionCondition.LT.Equals(expCondition))
                        status = (propValue.ToUtc().ToDateTime_MWCulture().Date &lt; value.ToDateTime_MWCulture().Date);
                }
                else if (propType == typeof (String))
                    status = (propValue.ToString2().Equals(value));
            }
            catch (Exception ex)
            {
                if (ex.Message.Contains(&quot;Invalid date format in condition&quot;))
                    throw ex;
                else
                    throw new Exception(&quot;Invalid field in condition.&quot;);
            }
            if (!status &amp;&amp; showMessage)
                throw new Exception(&quot;Approval condition for the current user &#39;&quot; + expression +
                                    &quot;&#39; is not valid. Request denied.&quot;);
            return status;
        }

        internal bool ValidateUsers(int workflowId, string module, string state)
        {
            Workflow wf = GetWorkflowUsersInstance(workflowId, module, state);
            foreach (WFApproval wfa in wf.Approvals)
            {
                if (String.IsNullOrEmpty(wfa.UserName) &amp;&amp; String.IsNullOrEmpty(wfa.RoleName))
                    throw new Exception(&quot;Either User or Role Name is mandatory for an approval in Workflow.&quot;);
                else if (!String.IsNullOrEmpty(wfa.UserName) &amp;&amp; UserManager.Instance.GetUID(wfa.UserName) &lt; 1)
                    throw new Exception(&quot;Invalid User &#39;&quot; + wfa.UserName + &quot;&#39; in Workflow.&quot;);
                else if (!String.IsNullOrEmpty(wfa.RoleName) &amp;&amp; UserManager.Instance.GetUsersRoleId(wfa.RoleName) &lt; 1)
                    throw new Exception(&quot;Invalid Role &#39;&quot; + wfa.RoleName + &quot;&#39; in Workflow.&quot;);
                ValidateConditionFields(wfa);
            }
            return true;
        }

        internal void ValidateConditionFields(WFApproval user)
        {
            if (!String.IsNullOrEmpty(user.Expression))
            {
                string regCondition = @&quot;[\w\W]+(\[EQ\]|\[LT\]|\[GT\])[\w\W]+&quot;;
                string regExpression = regCondition + &quot;(&quot; + @&quot;(\[AND\]|\[OR\])&quot; + regCondition + &quot;)*&quot;;
                string[] conditionList;
                var rx = new Regex(regExpression, RegexOptions.IgnoreCase);
                if (!rx.IsMatch(user.Expression))
                    throw new Exception(&quot;Invalid Expression.&quot;);

                conditionList =
                    user.Expression.Split(
                        new[]
                        {
                            getDelimiterExpression(expressionCondition.AND),
                            getDelimiterExpression(expressionCondition.OR)
                        }, StringSplitOptions.RemoveEmptyEntries);
                foreach (string expression in conditionList)
                {
                    string[] expressions;
                    string field;
                    bool hasProperty = false;
                    expressions =
                        expression.Split(
                            new[]
                            {
                                getDelimiterExpression(expressionCondition.EQ),
                                getDelimiterExpression(expressionCondition.GT),
                                getDelimiterExpression(expressionCondition.LT)
                            }, StringSplitOptions.RemoveEmptyEntries);
                    if (expressions.Length != 2)
                        throw new Exception(&quot;Invalid condition &#39;&quot; + expressions + &quot;&#39;.&quot;);
                    field = expressions.GetValue(0).ToString2();

                    if (InstanceGrid != null &amp;&amp; InstanceGrid.DisplayLayout.SelectedRows.Count != 0)
                    {
                        UltraGridRow ugr = InstanceGrid.DisplayLayout.SelectedRows[0];
                        foreach (UltraGridCell ugc in ugr.Cells)
                            if (ugc.Column.Header.Caption.Equals(field))
                            {
                                hasProperty = true;
                                break;
                            }
                    }
                    else if (InstanceTable != null)
                    {
                        foreach (DataColumn dc in InstanceTable.Columns)
                            if (GlobalizationUtility.SetResource(dc.ColumnName, false).Equals(field))
                            {
                                hasProperty = true;
                                break;
                            }
                    }
                    if (!hasProperty)
                        throw new Exception(&quot;Invalid field &#39;&quot; + field + &quot;&#39; in condition.&quot;);
                }
            }
        }

        public static bool IsWorkflowInProgress(int workflowId, string module)
        {
            return false;
        }

        #region Nested type: expressionCondition

        private enum expressionCondition
        {
            NONE,
            GT,
            LT,
            EQ,
            AND,
            OR
        };

        #endregion
    }

    [Serializable]
    public class Workflow
    {
        [XmlElement(&quot;User&quot;)] public List&lt;WFApproval&gt; Approvals = new List&lt;WFApproval&gt;();
        [XmlAttribute(&quot;ObjectType&quot;)] public string ObjectType;
        [XmlAttribute(&quot;Type&quot;)] public string Type;
        public int WorkflowID;

        public override string ToString()
        {
            using (var sWr = new StringWriter(CultureInfo.CurrentCulture))
            {
                using (var xWr = new XmlTextWriter(sWr))
                {
                    xWr.WriteStartElement(&quot;Workflow&quot;);
                    xWr.WriteElementString(&quot;WorkflowID&quot;, WorkflowID.ToString2());
                    foreach (WFApproval user in Approvals)
                    {
                        xWr.WriteStartElement(&quot;Approval&quot;);
                        xWr.WriteElementString(&quot;State&quot;, &quot;Completed&quot;);
                        if (!string.IsNullOrEmpty(user.UserName))
                            xWr.WriteElementString(&quot;UserID&quot;, user.UserName);
                        if (!string.IsNullOrEmpty(user.RoleName))
                            xWr.WriteElementString(&quot;RoleName&quot;, user.RoleName);
                        if (!string.IsNullOrEmpty(user.Action.ToString2()))
                            xWr.WriteElementString(&quot;ApprovalType&quot;, user.Action.ToString2());
                        if (!string.IsNullOrEmpty(user.Notes))
                            xWr.WriteElementString(&quot;Notes&quot;, user.Notes);
                        xWr.WriteElementString(&quot;Completed&quot;, user.Completed.ToString2());
                        xWr.WriteElementString(&quot;CurrentUserName&quot;, UserDetail.GetCurrentUserDetail().UserID);
                        xWr.WriteElementString(&quot;AdminApproval&quot;, user.AdminApproval.ToString2());
                        xWr.WriteElementString(&quot;Expression&quot;, user.Expression);
                        xWr.WriteEndElement();
                    }
                    xWr.WriteEndElement();
                    xWr.Flush();
                }
                return sWr.ToString2();
            }
        }

        public static Workflow CreateDeepCopy(Workflow inputWorkflow)
        {
            var m = new MemoryStream();
            var b = new BinaryFormatter();
            b.Serialize(m, inputWorkflow);
            m.Position = 0;
            return (Workflow)b.Deserialize(m);
        }
    }

    [Serializable]
    public class WFLevel
    {
        [XmlElement(&quot;Approval&quot;)] public List&lt;WFApproval&gt; Approvals = new List&lt;WFApproval&gt;();
        [XmlAttribute(&quot;State&quot;)] public string State;
        [XmlAttribute(&quot;WFState&quot;)] public string WFState;
    }

    [Serializable]
    public class WFApproval
    {
        public ApprovalAction Action;
        [XmlAttribute(&quot;EmailColumns&quot;)] public string AdditionalEmailColumns;
        public bool AdminApproval;
        public bool Completed;
        [XmlAttribute(&quot;Expression&quot;)] public string Expression;
        public string Notes;
        public int? RID;
        [XmlAttribute(&quot;RoleName&quot;)] public string RoleName;
        public int? UID;
        [XmlAttribute(&quot;UserName&quot;)] public string UserName;
    }

    public enum WFItemStatus
    {
        Approval,
        Completed
    };

    public enum WFItemAction
    {
        Create,
        Approve,
        Reject
    };
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[38,15,38,41,0],[39,9,39,10,0],[40,13,40,46,0],[41,13,41,48,0],[42,13,42,66,0],[43,13,43,56,0],[44,9,44,10,0],[46,52,46,56,0],[46,57,46,61,0],[49,9,49,10,0],[50,13,50,30,0],[51,17,51,24,0],[52,13,52,31,0],[53,13,53,47,0],[54,13,54,37,0],[55,13,55,43,0],[56,9,56,10,0],[60,9,60,10,0],[61,13,61,58,0],[62,13,62,34,0],[63,13,63,14,0],[64,17,64,54,0],[65,17,65,53,0],[66,13,66,14,0],[68,13,68,66,0],[69,17,69,30,0],[71,13,71,102,0],[72,13,72,14,0],[73,17,73,53,0],[74,17,74,86,0],[75,13,75,14,0],[76,13,76,78,0],[77,17,77,54,0],[78,13,78,26,0],[79,9,79,10,0],[83,9,83,10,0],[84,13,84,58,0],[85,13,85,34,0],[86,17,86,37,0],[88,13,88,111,0],[89,13,89,14,0],[90,17,90,53,0],[91,17,91,85,0],[93,17,93,74,0],[94,21,94,57,0],[95,13,95,14,0],[96,13,96,26,0],[97,9,97,10,0],[101,9,101,10,0],[102,13,102,58,0],[103,13,103,34,0],[104,17,104,53,0],[106,13,106,121,0],[107,13,107,92,0],[108,13,108,14,0],[109,17,109,53,0],[110,17,110,85,0],[111,17,111,63,0],[112,21,112,57,0],[113,13,113,14,0],[114,13,114,26,0],[115,9,115,10,0],[119,9,119,10,0],[120,13,120,75,0],[121,13,121,27,0],[122,13,122,29,0],[123,9,123,10,0],[126,9,126,10,0],[127,13,127,48,0],[128,13,128,14,0],[129,17,129,59,0],[130,17,130,45,0],[131,17,131,26,0],[132,13,132,14,0],[133,18,133,54,0],[134,13,134,14,0],[135,17,135,60,0],[136,17,136,26,0],[137,13,137,14,0],[138,18,138,53,0],[139,13,139,14,0],[140,17,140,59,0],[141,17,141,26,0],[142,13,142,14,0],[143,9,143,10,0],[155,9,155,10,0],[157,13,157,14,0],[158,17,158,51,0],[159,17,159,24,0],[159,26,159,40,0],[159,41,159,43,0],[159,44,159,61,0],[160,17,160,18,0],[161,21,161,100,0],[162,21,162,22,0],[163,25,163,47,0],[164,25,164,34,0],[167,21,167,61,0],[168,21,168,22,0],[169,25,169,87,0],[170,25,170,60,0],[171,25,171,26,0],[172,29,175,102,0],[177,29,177,122,0],[178,33,178,69,0],[179,25,179,26,0],[180,21,180,22,0],[181,26,181,66,0],[182,21,182,22,0],[183,25,183,88,0],[184,25,185,122,0],[186,25,186,32,0],[186,34,186,45,0],[186,46,186,48,0],[186,49,186,68,0],[187,25,187,26,0],[188,29,188,69,0],[189,33,189,42,0],[190,29,190,104,0],[191,29,191,64,0],[192,29,192,30,0],[193,33,197,106,0],[199,33,200,99,0],[201,37,201,73,0],[202,29,202,30,0],[203,25,203,26,0],[204,21,204,22,0],[205,21,205,27,0],[207,13,207,14,0],[208,13,208,18,0],[209,13,209,14,0],[210,13,210,14,0],[211,9,211,10,0],[214,9,214,10,0],[215,13,215,92,0],[217,13,217,20,0],[217,22,217,32,0],[217,33,217,35,0],[217,36,217,43,0],[219,17,219,18,0],[220,21,220,118,0],[221,25,224,151,0],[225,17,225,18,0],[226,17,226,34,0],[227,17,227,18,0],[228,17,228,18,0],[229,9,229,10,0],[243,9,243,109,1],[248,9,248,10,1],[249,13,249,118,1],[250,13,250,28,1],[251,17,251,24,1],[251,26,251,36,0],[251,37,251,39,1],[251,40,251,61,1],[252,17,252,18,0],[253,21,253,75,0],[254,28,254,95,0],[255,21,255,22,0],[256,25,256,49,0],[258,25,258,26,0],[259,29,259,73,0],[260,29,260,87,0],[261,25,261,26,0],[262,25,262,30,0],[263,25,263,26,0],[264,25,264,26,0],[265,21,265,22,0],[266,17,266,18,0],[267,9,267,10,1],[269,9,269,83,1],[270,9,270,10,1],[271,13,271,46,1],[272,13,272,48,1],[273,9,273,10,1],[277,9,277,10,1],[278,13,278,47,1],[279,17,279,67,0],[281,17,281,29,1],[282,9,282,10,1],[285,9,285,10,0],[286,13,286,20,0],[286,22,286,41,0],[286,42,286,44,0],[286,45,286,57,0],[287,13,287,14,0],[288,17,288,47,0],[289,17,289,44,0],[290,13,290,14,0],[291,9,291,10,0],[294,9,294,10,0],[295,13,295,44,0],[296,9,296,10,0],[299,9,299,10,0],[300,13,300,56,0],[301,13,302,49,0],[305,13,305,62,0],[306,13,306,24,0],[307,9,307,10,0],[310,9,310,10,0],[311,13,311,39,0],[312,13,312,46,0],[313,17,315,114,0],[317,17,317,115,0],[330,9,330,10,0],[335,9,335,10,0],[336,13,336,31,0],[337,13,337,61,0],[338,13,338,20,0],[338,22,338,37,0],[338,38,338,40,0],[338,41,338,53,0],[339,13,339,14,0],[342,17,344,70,0],[345,21,345,30,0],[348,17,350,113,0],[351,21,351,30,0],[354,17,359,22,0],[360,17,360,18,0],[362,21,362,71,0],[363,21,363,43,0],[364,21,364,58,0],[365,21,365,40,0],[366,21,368,118,0],[369,21,369,33,0],[370,21,370,27,0],[372,22,374,118,0],[375,17,375,18,0],[376,21,376,87,0],[378,22,381,121,0],[382,17,382,18,0],[383,21,383,61,0],[385,13,385,14,0],[386,13,386,23,0],[387,17,387,57,0],[389,17,389,29,0],[390,9,390,10,0],[395,9,395,10,0],[396,13,396,61,0],[397,18,397,48,0],[397,50,397,56,0],[397,58,397,61,0],[398,13,398,14,0],[399,17,399,51,0],[400,17,400,73,0],[401,21,401,30,0],[402,17,405,72,0],[406,17,406,18,0],[407,21,407,44,0],[408,21,408,57,0],[409,21,409,40,0],[410,21,412,120,0],[413,21,413,33,0],[416,21,416,60,0],[418,13,418,52,0],[419,9,419,10,0],[424,9,424,10,0],[425,13,425,61,0],[426,13,426,39,0],[427,18,427,27,0],[427,29,427,51,0],[427,53,427,56,0],[428,13,428,14,0],[429,17,429,51,0],[430,17,430,73,0],[431,21,431,30,0],[432,17,436,22,0],[437,17,437,18,0],[438,21,438,62,0],[439,21,439,22,0],[440,25,440,61,0],[441,25,441,44,0],[442,25,445,121,0],[446,25,446,45,0],[446,46,446,72,0],[447,25,447,67,0],[450,25,450,64,0],[453,17,453,18,0],[454,21,454,36,0],[455,17,455,18,0],[456,13,456,14,0],[457,13,457,52,0],[458,9,458,10,0],[462,9,462,10,0],[463,13,463,70,0],[464,13,464,20,0],[464,22,464,36,0],[464,37,464,39,0],[464,40,464,52,0],[465,13,465,14,0],[466,17,466,89,0],[467,21,467,34,0],[468,13,468,14,0],[469,13,469,25,0],[470,9,470,10,0],[473,9,473,10,0],[474,13,474,25,0],[475,9,475,10,0],[478,9,478,10,0],[479,13,479,48,0],[480,13,480,45,0],[481,13,481,33,0],[482,13,482,14,0],[483,17,483,58,0],[485,17,485,60,0],[488,21,490,40,0],[491,17,491,18,0],[492,21,492,42,0],[493,21,493,22,0],[494,25,494,52,0],[495,25,495,69,0],[496,25,496,71,0],[497,25,497,91,0],[498,25,498,75,0],[499,25,499,46,0],[500,21,500,22,0],[501,17,501,18,0],[502,17,502,43,0],[503,17,503,18,0],[504,21,504,47,0],[505,21,505,53,0],[506,17,506,18,0],[507,13,507,14,0],[509,13,509,28,0],[510,9,510,10,0],[513,9,513,10,0],[514,13,514,53,0],[515,13,522,16,0],[524,13,524,14,0],[525,17,525,52,0],[526,17,526,49,0],[528,17,528,37,0],[529,17,529,18,0],[530,21,530,62,0],[531,21,531,64,0],[533,25,535,50,0],[536,21,536,22,0],[537,25,537,46,0],[538,25,538,26,0],[539,29,539,56,0],[540,29,540,73,0],[541,29,541,75,0],[542,29,542,95,0],[543,29,543,79,0],[544,29,544,50,0],[545,25,545,26,0],[546,21,546,22,0],[547,21,547,47,0],[548,21,548,22,0],[549,25,549,51,0],[550,25,550,57,0],[551,21,551,22,0],[552,17,552,18,0],[554,17,554,31,0],[555,17,555,24,0],[555,26,555,41,0],[555,42,555,44,0],[555,45,555,62,0],[556,17,556,18,0],[557,21,557,99,0],[558,25,559,97,0],[560,17,560,18,0],[561,17,561,32,0],[563,13,563,18,0],[564,13,564,14,0],[565,17,565,32,0],[567,9,567,10,0],[570,9,570,10,0],[571,13,573,24,0],[574,9,574,10,0],[577,9,577,10,0],[578,13,578,57,0],[579,9,579,10,0],[583,9,583,10,0],[584,13,584,32,0],[585,13,585,56,0],[586,13,586,14,0],[588,17,588,79,0],[589,17,589,103,0],[591,17,591,76,0],[592,17,592,50,0],[593,21,593,64,0],[595,17,595,61,0],[596,17,602,67,0],[603,17,603,24,0],[603,26,603,43,0],[603,44,603,46,0],[603,47,603,60,0],[604,17,604,18,0],[605,21,605,74,0],[606,21,606,101,0],[607,17,607,18,0],[609,17,609,80,0],[610,17,610,79,0],[612,17,612,63,0],[613,17,613,51,0],[614,17,614,47,0],[615,17,615,44,0],[616,17,620,51,0],[621,17,621,101,0],[622,17,622,41,0],[623,17,623,18,0],[624,21,624,72,0],[627,17,627,18,0],[628,21,628,106,0],[629,21,629,67,0],[630,17,630,18,0],[633,13,633,14,0],[634,13,634,27,0],[635,9,635,10,0],[639,9,639,10,0],[641,13,641,37,0],[642,13,642,34,0],[643,13,643,33,0],[645,13,645,47,0],[646,13,646,73,0],[647,13,647,85,0],[648,17,648,55,0],[649,18,649,90,0],[650,17,650,55,0],[651,18,651,90,0],[652,17,652,55,0],[654,13,654,63,0],[655,17,655,59,0],[656,13,657,56,0],[658,13,658,41,0],[659,17,659,59,0],[660,13,660,57,0],[661,13,661,57,0],[664,13,664,14,0],[665,17,665,96,0],[666,17,666,18,0],[667,21,667,83,0],[668,21,668,28,0],[668,30,668,47,0],[668,48,668,50,0],[668,51,668,60,0],[669,21,669,22,0],[670,25,670,69,0],[671,25,671,26,0],[672,29,672,74,0],[673,29,673,51,0],[674,25,674,26,0],[675,21,675,22,0],[676,17,676,18,0],[677,22,677,48,0],[678,17,678,18,0],[679,21,679,28,0],[679,30,679,43,0],[679,44,679,46,0],[679,47,679,68,0],[680,21,680,22,0],[681,25,681,98,0],[682,25,682,26,0],[683,29,683,52,0],[684,29,684,67,0],[685,33,685,101,0],[686,25,686,26,0],[687,21,687,22,0],[688,17,688,18,0],[691,17,691,80,0],[692,17,692,18,0],[693,21,693,69,0],[694,25,694,81,0],[695,26,695,74,0],[696,25,696,80,0],[697,26,697,74,0],[698,25,698,80,0],[699,17,699,18,0],[700,22,700,56,0],[701,17,701,18,0],[702,21,702,117,0],[703,21,703,50,0],[704,25,704,115,0],[706,21,706,69,0],[707,25,707,96,0],[708,26,708,74,0],[709,25,709,118,0],[710,26,710,74,0],[711,25,711,118,0],[712,17,712,18,0],[713,22,713,54,0],[714,21,714,68,0],[715,13,715,14,0],[716,13,716,33,0],[717,13,717,14,0],[718,17,718,77,0],[719,21,719,30,0],[721,21,721,72,0],[723,13,723,40,0],[724,17,725,72,0],[726,13,726,27,0],[727,9,727,10,0],[730,9,730,10,0],[731,13,731,79,0],[732,13,732,20,0],[732,22,732,36,0],[732,37,732,39,0],[732,40,732,52,0],[733,13,733,14,0],[734,17,734,94,0],[735,21,735,111,0],[736,22,736,111,0],[737,21,737,93,0],[738,22,738,119,0],[739,21,739,93,0],[740,17,740,46,0],[741,13,741,14,0],[742,13,742,25,0],[743,9,743,10,0],[746,9,746,10,0],[747,13,747,56,0],[748,13,748,14,0],[749,17,749,79,0],[750,17,750,103,0],[752,17,752,76,0],[753,17,753,50,0],[754,21,754,64,0],[756,17,762,67,0],[763,17,763,24,0],[763,26,763,43,0],[763,44,763,46,0],[763,47,763,60,0],[764,17,764,18,0],[767,21,767,46,0],[768,21,775,71,0],[776,21,776,49,0],[777,25,777,89,0],[778,21,778,65,0],[780,21,780,100,0],[781,21,781,22,0],[782,25,782,87,0],[783,25,783,32,0],[783,34,783,51,0],[783,52,783,54,0],[783,55,783,64,0],[784,29,784,73,0],[785,29,785,30,0],[786,33,786,52,0],[787,33,787,39,0],[789,21,789,22,0],[790,26,790,52,0],[791,21,791,22,0],[792,25,792,32,0],[792,34,792,47,0],[792,48,792,50,0],[792,51,792,72,0],[793,29,793,102,0],[794,29,794,30,0],[795,33,795,52,0],[796,33,796,39,0],[798,21,798,22,0],[799,21,799,38,0],[800,25,800,92,0],[801,17,801,18,0],[802,13,802,14,0],[803,9,803,10,0],[806,9,806,10,0],[807,13,807,26,0],[808,9,808,10,0],[828,30,828,89,0],[834,9,834,10,0],[835,20,835,74,0],[836,13,836,14,0],[837,24,837,56,0],[838,17,838,18,0],[839,21,839,55,0],[840,21,840,82,0],[841,21,841,28,0],[841,30,841,45,0],[841,46,841,48,0],[841,49,841,58,0],[842,21,842,22,0],[843,25,843,59,0],[844,25,844,70,0],[845,25,845,66,0],[846,29,846,77,0],[847,25,847,66,0],[848,29,848,79,0],[849,25,849,76,0],[850,29,850,93,0],[851,25,851,63,0],[852,29,852,73,0],[853,25,853,89,0],[854,25,854,109,0],[855,25,855,97,0],[856,25,856,79,0],[857,25,857,47,0],[858,21,858,22,0],[859,21,859,43,0],[860,21,860,33,0],[861,17,861,18,0],[862,17,862,40,0],[864,9,864,10,0],[867,9,867,10,0],[868,13,868,40,0],[869,13,869,43,0],[870,13,870,43,0],[871,13,871,28,0],[872,13,872,47,0],[873,9,873,10,0],[879,34,879,93,0]]);
    </script>
  </body>
</html>